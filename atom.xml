<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>CloudNative 架构</title>
  <subtitle>CloudNative|云原生应用架构|云原生架构|容器化架构|微服务架构|平台架构|基础架构</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://team.jiunile.com/"/>
  <updated>2020-12-15T13:27:02.000Z</updated>
  <id>http://team.jiunile.com/</id>
  
  <author>
    <name>icyboy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>如何在 Go 中编写无 Bug 的 Goroutines？</title>
    <link href="http://team.jiunile.com//blog/2020/12/go-nobug-gorotuine.html"/>
    <id>http://team.jiunile.com//blog/2020/12/go-nobug-gorotuine.html</id>
    <published>2020-12-15T14:00:00.000Z</published>
    <updated>2020-12-15T13:27:02.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;GO-并发&quot;&gt;&lt;a href=&quot;#GO-并发&quot; class=&quot;headerlink&quot; title=&quot;GO 并发&quot;&gt;&lt;/a&gt;GO 并发&lt;/h2&gt;&lt;p&gt;Go 以其并发性著称，深受人们喜爱。go 运行时管理轻量级线程，称为 goroutines。goroutine 的编写非常快速简单。&lt;/p&gt;
&lt;p&gt;你只需在你想异步执行的函数前输入 &lt;code&gt;go&lt;/code&gt;，程序就会在另一个线程中执行。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;听起来很简单？&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;goroutines 是 Go 编写异步代码的方式。&lt;/p&gt;
&lt;p&gt;重要的是要了解 goroutine 和并发的工作原理。Go 提供了管理 goroutine 的方法，使它们在复杂的程序中更容易管理和预测。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;因为 goroutine 非常容易使用，所以它们很容易被滥用。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;1-在异步例程中不要对执行顺序进行假设。&quot;&gt;&lt;a href=&quot;#1-在异步例程中不要对执行顺序进行假设。&quot; class=&quot;headerlink&quot; title=&quot;1 在异步例程中不要对执行顺序进行假设。&quot;&gt;&lt;/a&gt;1 在异步例程中不要对执行顺序进行假设。&lt;/h2&gt;&lt;p&gt;在 Go 中调度并发任务时，要记住异步任务的不可预知性。&lt;/p&gt;
&lt;p&gt;可以将异步与同步计算融合在一起，但只要同步任务不对异步任务做任何假设即可。&lt;/p&gt;
&lt;p&gt;对于初学者来说，一个常见的错误是创建一个 goroutine，然后根据该 goroutine 的结果继续执行同步任务。例如，如果该 goroutine 要向其作用域外的变量写入，然后在同步任务中使用该变量。&lt;/p&gt;
&lt;h3 id=&quot;假设执行顺序&quot;&gt;&lt;a href=&quot;#假设执行顺序&quot; class=&quot;headerlink&quot; title=&quot;假设执行顺序&quot;&gt;&lt;/a&gt;假设执行顺序&lt;/h3&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; numbers []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// start a goroutine to initialise array&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		numbers = &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// do something synchronous&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; numbers == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    time.Sleep(time.Second)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  numbers[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// will sometimes panic here&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(numbers[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;这种模式会导致不可预知的行为&lt;/strong&gt;。它引入的代码导致了我们无法控制的因素；这些因素与 go 运行时有关，更具体地说，就是它如何管理 goroutines。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;编写这样的代码意味着假定 goroutine 将在需要结果之前完成它的任务。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;首先&lt;/strong&gt;，在没有某种管理技术（我们将讨论）的情况下，交叉异步和同步代码的成功将取决于 CPU 的可用性。&lt;/p&gt;
&lt;p&gt;这意味着如果有 CPU 密集型的进程与 goroutines 同时运行，那么执行的时间将会有所不同。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;其次&lt;/strong&gt;，不同的编译器将以不同的方式调度 goroutines。因此，安全的做法是不要认为 goroutine 会在同步任务期间完成。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;如何确保 goroutine 已经完成？&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;使用 channel&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;在异步任务完成时使用 channel 来通知&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;channel 应该用于接收来自异步任务（如 goroutines）的值。&lt;/p&gt;
&lt;p&gt;如果你想阻止进一步的执行，直到最终从 channel 读取一个值来释放它，可以使用缓冲通道。&lt;/p&gt;
&lt;p&gt;如果你想要 1 进 1 出的行为，那么使用非缓冲通道。&lt;/p&gt;
&lt;p&gt;在本例中，使用 channel，我们可以确保主任务等待直到异步任务完成。当 goroutine 完成它的工作时，它将通过 &lt;code&gt;done channel&lt;/code&gt; 发送一个值，该值将在对 &lt;code&gt;numbers&lt;/code&gt; 数组进行操作之前被读取。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; numbers []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	done := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt;&amp;#123;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// start a goroutine to initialise array&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		numbers = &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		done &amp;lt;- &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt;&amp;#123;&amp;#125;&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// do something synchronous&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;-done &lt;span class=&quot;comment&quot;&gt;// read done from channel&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  numbers[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// will not panic anymore&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(numbers[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]) &lt;span class=&quot;comment&quot;&gt;// 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;尽管这是一个人为的示例，但你可以看到它在什么地方会很有用：当主线程与 goroutine 并行处理复杂工作时。这两个任务可以同时完成，而不可能出现 &lt;code&gt;panic&lt;/code&gt;。&lt;/p&gt;
&lt;h2 id=&quot;2-避免跨并发线程访问可变数据&quot;&gt;&lt;a href=&quot;#2-避免跨并发线程访问可变数据&quot; class=&quot;headerlink&quot; title=&quot;2 避免跨并发线程访问可变数据&quot;&gt;&lt;/a&gt;2 避免跨并发线程访问可变数据&lt;/h2&gt;&lt;p&gt;跨多个 goroutine 访问可变数据是将数据竞争引入程序的“好方法”。&lt;/p&gt;
&lt;p&gt;数据竞争是指两个或多个线程（或这里的goroutine）&lt;strong&gt;并发访问同一内存位置&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;这意味着跨线程访问相同的变量可能会产生不可预测的值。如果两个进程同时访问同一个变量，有两种可能性:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;两个线程的值是相同的（&lt;strong&gt;不正确&lt;/strong&gt;）。&lt;/li&gt;
&lt;li&gt;对于较慢/较晚的线程，该值是不同的。（&lt;strong&gt;正确&lt;/strong&gt;）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果较慢/较晚的线程读取了一个已被较快/较早的线程修改过的更新值，那么它将对更新后的值进行操作。&lt;strong&gt;这是预期的行为&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;否则，就像在数据竞争中看到的那样，两个线程将产生相同的值，因为它们都将对未更改的值进行操作。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt; 1000 种可能的数据竞争&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在这个例子中，我们使用 &lt;code&gt;sync.WaitGroup&lt;/code&gt; 来保持程序运行，直到所有的 goroutine 完成，但我们并没有控制对每个 goroutine 内变量的访问。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;&quot;sync&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	a := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// data race&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; wg sync.WaitGroup&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	wg.Add(&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; wg.Done()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			a += &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	wg.Wait()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  	fmt.Println(a) &lt;span class=&quot;comment&quot;&gt;// could theoretical be any number 0-1000 (most likely above 900)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这段代码可以打印 0-1000 之间的任何数字，具体取决于发生的数据竞争数量。&lt;/p&gt;
&lt;p&gt;这段代码的工作原理是，两个线程将对同一个变量各执行 2 次操作，总共有 2 次读 + 2 次写。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在两个线程都会产生相同的值的情况下，在对变量进行任何写入之前，两个（2）读都必须发生。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;使用互斥锁在 goroutines 之间共享内存&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;为了防止 goroutines 中的数据竞争，我们需要同步对共享内存的访问。我们可以使用互斥来实现这一点。互斥锁将确保我们不会在同一时间读取或写入相同的值。&lt;/p&gt;
&lt;p&gt;它本质上是&lt;strong&gt;暂时锁定对一个变量的访问&lt;/strong&gt;。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;&quot;sync&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	a := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; wg sync.WaitGroup&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; mu sync.Mutex &lt;span class=&quot;comment&quot;&gt;// guards access&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	wg.Add(&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			mu.Lock()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; mu.Unlock()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; wg.Done()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			a += &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	wg.Wait()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(a) &lt;span class=&quot;comment&quot;&gt;// will always be 1000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;就这么简单。&lt;/p&gt;
&lt;p&gt;这段代码总是打印 1000，因为对同一个变量的每个后续操作都会对更新后的值进行操作。&lt;/p&gt;
&lt;h2 id=&quot;3-不要写应该同步的异步任务&quot;&gt;&lt;a href=&quot;#3-不要写应该同步的异步任务&quot; class=&quot;headerlink&quot; title=&quot;3 不要写应该同步的异步任务&quot;&gt;&lt;/a&gt;3 不要写应该同步的异步任务&lt;/h2&gt;&lt;p&gt;Goroutines 通常被认为是后台任务。它们被视为可以与主程序同时运行的小任务，通过 goroutine 将其委托给另一个线程。&lt;/p&gt;
&lt;p&gt;当学习 Go 时，你往往会想到使用 goroutine 来尽量减少阻塞操作，或者让我们的程序性能更强。&lt;/p&gt;
&lt;p&gt;但由于对 goroutine 的看法如此简单，很容易养成 “以防万一” 的习惯，把所有东西都做成 goroutine。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;如果某些任务本质上是同步的，但你却异步地使用了它们，这就会造成问题&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;并非所有的任务都应该是一个 goroutine&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;有些任务需要秩序。在许多进程中，下一个任务取决于前一个任务的结果。这些顺序性的任务会让你的程序出错，势必需要让这些区域更加同步。&lt;/p&gt;
&lt;p&gt;所以有些情况下，你还不如直接忘掉goroutine，一开始就保持同步。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;用无限循环浪费 CPU&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在这个精心设计的示例中，我们有一个程序，它将所有内容委托给 goroutines，并使用 for 循环来保持程序运行。&lt;/p&gt;
&lt;p&gt;这是一个如何不控制 Go 程序流程的例子。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; doSomething()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; doSomethingElse()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// execute everything as a goroutine&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &amp;#123; &lt;span class=&quot;comment&quot;&gt;// this keeps the program running&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;最好保持简单。你可以通过把你的程序看作是主线程加上附加线程的方式来防止这种类型的不良做法。你可以让主线程以同步的方式运行，但如果需要，可以通过 goroutines 将任务委托给另一个线程。&lt;/p&gt;
&lt;p&gt;有更好的方法可以控制程序的流程，&lt;strong&gt;比如通过 &lt;a href=&quot;https://gobyexample.com/waitgroups&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;WaitGroups&lt;/a&gt; 或 &lt;a href=&quot;https://gobyexample.com/channels&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Channels&lt;/a&gt;&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;使用 WaitGroup 的控制流程&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;与其浪费宝贵的 CPU 资源，不如使用 WaitGroup 向运行时表明，在程序退出之前，你正在等待 n 个任务的完成。这样就不会让 CPU 一直在无限循环中旋转。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;doSomething&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(wg *sync.WaitGroup)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// do something here&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;Done&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; wg.Done()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; wg sync.WaitGroup&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  wg.Add(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; wg.Wait()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; doSomething(&amp;amp;wg)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; doSomethingElseSync()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// program will wait until doSomething &amp;amp; doSomethingElseSync is complete&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;首先，您需要将等待完成的任务数量作为参数提供给 &lt;code&gt;wg.Add()&lt;/code&gt; 函数。&lt;/p&gt;
&lt;p&gt;放置 &lt;code&gt;wg.Wait()&lt;/code&gt; 很重要。这是程序中执行将暂停的地方，等待所有任务完成。&lt;/p&gt;
&lt;p&gt;一旦任务完成，您可以使用 &lt;code&gt;wg.Done()&lt;/code&gt; 让程序知道。&lt;/p&gt;
&lt;h2 id=&quot;4-不要让-goroutines-挂起&quot;&gt;&lt;a href=&quot;#4-不要让-goroutines-挂起&quot; class=&quot;headerlink&quot; title=&quot;4 不要让 goroutines 挂起&quot;&gt;&lt;/a&gt;4 不要让 goroutines 挂起&lt;/h2&gt;&lt;p&gt;确保处理不再使用的 goroutines。持续运行的 Goroutines 将会阻塞并浪费宝贵的 CPU 资源。&lt;/p&gt;
&lt;p&gt;如果 goroutine 试图将值发送到没有任何读取并等待接收值的 channel，就会发生这种情况。这就意味着这条 channel 将永远卡在那里。&lt;/p&gt;
&lt;p&gt;9 个挂起的 goroutine&lt;/p&gt;
&lt;p&gt;在这个例子中，channel 只被读取一次。这意味着 9 个 goroutines 在等待通过 channel 发送一个值。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;sendToChan&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;int&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	channel := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		i := i&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			channel &amp;lt;- i &lt;span class=&quot;comment&quot;&gt;// 9 hanging goroutines&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &amp;lt;-channel&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;为了避免这种情况，请处理不再需要的 goroutines 来释放 CPU。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;使通道缓冲&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;使用缓冲通道意味着您正在为通道提供空间来存储附加值。&lt;/p&gt;
&lt;p&gt;对于当前的示例，这意味着所有的 goroutines 都将成功执行，不会阻塞。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;sendToChan&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;int&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	channel := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;9&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		i := i&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			channel &amp;lt;- i &lt;span class=&quot;comment&quot;&gt;// all goroutines executed successfully&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &amp;lt;-channel&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;不要在不知道什么时候停止的情况下开始一个 goroutine。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在不知道何时停止的情况下启动一个 goroutine 会导致以下行为，即 goroutine 被阻塞或浪费 CPU 资源。&lt;/p&gt;
&lt;p&gt;您应该总是知道什么时候 goroutine 将停止，什么时候不再需要它。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;您可以通过 &lt;code&gt;select&lt;/code&gt; 语句和 &lt;code&gt;channel&lt;/code&gt; 来实现这一点&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;done := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;select&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &amp;lt;-done:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;done &amp;lt;- &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这本质上是一个带有退出条件的异步 for-loop。&lt;/p&gt;
&lt;p&gt;重要的逻辑将在默认条件下编写。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;当值被发送到 &lt;code&gt;done&lt;/code&gt; 通道时，循环将停止，正如 &lt;code&gt;done &amp;lt;- true&lt;/code&gt; 所示。这意味着 channel 读取 &lt;code&gt;&amp;lt;-done&lt;/code&gt; 成功并返回。&lt;/p&gt;
&lt;p&gt;译自：&lt;a href=&quot;https://itnext.io/how-to-write-bug-free-goroutines-in-go-golang-59042b1b63fb&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://itnext.io/how-to-write-bug-free-goroutines-in-go-golang-59042b1b63fb&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;GO-并发&quot;&gt;&lt;a href=&quot;#GO-并发&quot; class=&quot;headerlink&quot; title=&quot;GO 并发&quot;&gt;&lt;/a&gt;GO 并发&lt;/h2&gt;&lt;p&gt;Go 以其并发性著称，深受人们喜爱。go 运行时管理轻量级线程，称为 goroutines。goroutine 的编写非常快速简单。&lt;/p&gt;
&lt;p&gt;你只需在你想异步执行的函数前输入 &lt;code&gt;go&lt;/code&gt;，程序就会在另一个线程中执行。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;听起来很简单？&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;goroutines 是 Go 编写异步代码的方式。&lt;/p&gt;
&lt;p&gt;重要的是要了解 goroutine 和并发的工作原理。Go 提供了管理 goroutine 的方法，使它们在复杂的程序中更容易管理和预测。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;因为 goroutine 非常容易使用，所以它们很容易被滥用。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="goroutines" scheme="http://team.jiunile.com/categories/golang/goroutines/"/>
    
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="goroutines" scheme="http://team.jiunile.com/tags/goroutines/"/>
    
  </entry>
  
  <entry>
    <title>利用 eBPF 支撑大规模 K8s Service</title>
    <link href="http://team.jiunile.com//blog/2020/12/k8s-cilium-service-2019.html"/>
    <id>http://team.jiunile.com//blog/2020/12/k8s-cilium-service-2019.html</id>
    <published>2020-12-02T14:00:00.000Z</published>
    <updated>2020-12-03T02:31:35.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;本文翻译自 2019 年 Daniel Borkmann 和 Martynas Pumputis 在 Linux Plumbers Conference 的一篇分享: &lt;a href=&quot;https://linuxplumbersconf.org/event/4/contributions/458/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Making the Kubernetes Service Abstraction Scale using eBPF&lt;/a&gt; 。 翻译时对大家耳熟能详或已显陈旧的内容（K8s 介绍、Cilium 1.6 之前的版本对 Service 实现等）略有删减，如有需要请查阅原 PDF。&lt;/p&gt;
&lt;p&gt;实际上，一年之后 Daniel 和 Martynas 又在 LPC 做了一次分享，内容是本文的延续：&lt;a href=&quot;http://team.jiunile.com/blog/2020/11/k8s-cilium-service.html&quot;&gt;Cilium：基于 BPF/XDP 实现 K8s Service 负载均衡&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;K8s 当前重度依赖 iptables 来实现 Service 的抽象&lt;/strong&gt;。对于每个 Service 及其 backend pods，在 K8s 里会生成很多 iptables 规则。&lt;strong&gt;例如 5K 个 Service 时，iptables 规则将达到 25K 条&lt;/strong&gt;，导致的后果：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;较高、并且不可预测的转发延迟&lt;/strong&gt;（packet latency），因为每个包都要遍历这些规则 ，直到匹配到某条规则；&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;更新规则的操作非常慢&lt;/strong&gt;：无法单独更新某条 iptables 规则，只能将全部规则读出来 ，更新整个集合，再将新的规则集合下发到宿主机。在动态环境中这一问题尤其明显，因为每 小时可能都有几千次的 backend pods 创建和销毁。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;可靠性问题&lt;/strong&gt;：iptables 依赖 Netfilter 和系统的连接跟踪模块（conntrack），在 大流量场景下会出现一些竞争问题（race conditions）；&lt;strong&gt;UDP 场景尤其明显&lt;/strong&gt;，会导 致丢包、应用的负载升高等问题。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;本文将介绍如何基于 Cilium/BPF 来解决这些问题，实现 K8s Service 的大规模扩展。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;1-K8s-Service-类型及默认基于-kube-proxy-的实现&quot;&gt;&lt;a href=&quot;#1-K8s-Service-类型及默认基于-kube-proxy-的实现&quot; class=&quot;headerlink&quot; title=&quot;1 K8s Service 类型及默认基于 kube-proxy 的实现&quot;&gt;&lt;/a&gt;1 K8s Service 类型及默认基于 kube-proxy 的实现&lt;/h2&gt;&lt;p&gt;K8s 提供了 Service 抽象，可以将多个 backend pods 组织为一个&lt;strong&gt;逻辑单元&lt;/strong&gt;（logical unit）。K8s 会为这个逻辑单元分配 &lt;strong&gt;虚拟 IP 地址&lt;/strong&gt;（VIP），客户端通过该 VIP 就 能访问到这些 pods 提供的服务。&lt;/p&gt;
&lt;p&gt;下图是一个具体的例子，&lt;br&gt;&lt;img src=&quot;/images/k8s/cim_k8s-service.png&quot; alt=&quot;k8s-service&quot;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;右边的 yaml 定义了一个名为 &lt;code&gt;nginx&lt;/code&gt; 的 Service，它在 TCP 80 端口提供服务；&lt;ul&gt;
&lt;li&gt;创建：&lt;code&gt;kubectl -f nginx-svc.yaml&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;K8s 会给每个 Service 分配一个虚拟 IP，这里给 &lt;code&gt;nginx&lt;/code&gt; 分的是 &lt;code&gt;3.3.3.3&lt;/code&gt;；&lt;ul&gt;
&lt;li&gt;查看：&lt;code&gt;kubectl get service nginx&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;左边是 &lt;code&gt;nginx&lt;/code&gt; Service 的两个 backend pods（在 K8s 对应两个 endpoint），这里 位于同一台节点，每个 Pod 有独立的 IP 地址；&lt;ul&gt;
&lt;li&gt;查看：&lt;code&gt;kubectl get endpoints nginx&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;上面看到的是所谓的 &lt;code&gt;ClusterIP&lt;/code&gt; 类型的 Service。实际上，&lt;strong&gt;在 K8s 里有几种不同类型 的 Service&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ClusterIP&lt;/li&gt;
&lt;li&gt;NodePort&lt;/li&gt;
&lt;li&gt;LoadBalancer&lt;/li&gt;
&lt;li&gt;ExternalName&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;本文将主要关注前两种类型。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;K8s 里实现 Service 的组件是 kube-proxy&lt;/strong&gt;，实现的主要功能就是&lt;strong&gt;将访问 VIP 的请 求转发（及负载均衡）到相应的后端 pods&lt;/strong&gt;。前面提到的那些 iptables 规则就是它创建 和管理的。&lt;/p&gt;
&lt;p&gt;另外，kube-proxy 是 K8s 的可选组件，如果不需要 Service 功能，可以不启用它。&lt;/p&gt;
&lt;h3 id=&quot;ClusterIP-Service&quot;&gt;&lt;a href=&quot;#ClusterIP-Service&quot; class=&quot;headerlink&quot; title=&quot;ClusterIP Service&quot;&gt;&lt;/a&gt;ClusterIP Service&lt;/h3&gt;&lt;p&gt;这是 &lt;strong&gt;K8s 的默认 Service 类型，使得宿主机或 pod 可以通过 VIP 访问一个 Service&lt;/strong&gt;。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Virtual IP to any endpoint (pod)&lt;/li&gt;
&lt;li&gt;Only in-cluster access&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;kube-proxy 是通过如下的 iptables 规则来实现这个功能的：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-t nat -A &amp;#123;PREROUTING, OUTPUT&amp;#125; -m conntrack --ctstate NEW -j KUBE-SERVICES&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 宿主机访问 nginx Service 的流量，同时满足 4 个条件：&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 1. src_ip 不是 Pod 网段&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 2. dst_ip=3.3.3.3/32 (ClusterIP)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 3. proto=TCP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 4. dport=80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 如果匹配成功，直接跳转到 KUBE-MARK-MASQ；否则，继续匹配下面一条（iptables 是链式规则，高优先级在前）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 跳转到 KUBE-MARK-MASQ 是为了保证这些包出宿主机时，src_ip 用的是宿主机 IP。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-SERVICES ! &lt;span class=&quot;_&quot;&gt;-s&lt;/span&gt; 1.1.0.0/16 &lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt; 3.3.3.3/32 -p tcp -m tcp --dport 80 -j KUBE-MARK-MASQ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Pod 访问 nginx Service 的流量：同时满足 4 个条件：&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 1. 没有匹配到前一条的，（说明 src_ip 是 Pod 网段）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 2. dst_ip=3.3.3.3/32 (ClusterIP)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 3. proto=TCP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 4. dport=80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-SERVICES &lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt; 3.3.3.3/32 -p tcp -m tcp --dport 80 -j KUBE-SVC-NGINX&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 以 50% 的概率跳转到 KUBE-SEP-NGINX1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-SVC-NGINX -m statistic --mode random --probability 0.50 -j KUBE-SEP-NGINX1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 如果没有命中上面一条，则以 100% 的概率跳转到 KUBE-SEP-NGINX2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-SVC-NGINX -j KUBE-SEP-NGINX2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 如果 src_ip=1.1.1.1/32，说明是 Service-&amp;gt;client 流量，则&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 需要做 SNAT（MASQ 是动态版的 SNAT），替换 src_ip -&amp;gt; svc_ip，这样客户端收到包时，&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 看到就是从 svc_ip 回的包，跟它期望的是一致的。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-SEP-NGINX1 &lt;span class=&quot;_&quot;&gt;-s&lt;/span&gt; 1.1.1.1/32 -j KUBE-MARK-MASQ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 如果没有命令上面一条，说明 src_ip != 1.1.1.1/32，则说明是 client-&amp;gt; Service 流量，&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 需要做 DNAT，将 svc_ip -&amp;gt; pod1_ip，&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-SEP-NGINX1 -p tcp -m tcp -j DNAT --to-destination 1.1.1.1:80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 同理，见上面两条的注释&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-SEP-NGINX2 &lt;span class=&quot;_&quot;&gt;-s&lt;/span&gt; 1.1.1.2/32 -j KUBE-MARK-MASQ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-SEP-NGINX2 -p tcp -m tcp -j DNAT --to-destination 1.1.1.2:80&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Service 既要能被宿主机访问，又要能被 pod 访问（&lt;strong&gt;二者位于不同的 netns&lt;/strong&gt;）， 因此需要在 &lt;code&gt;PREROUTING&lt;/code&gt; 和 &lt;code&gt;OUTPUT&lt;/code&gt; 两个 hook 点拦截请求，然后跳转到自定义的 &lt;code&gt;KUBE-SERVICES&lt;/code&gt; chain；&lt;/li&gt;
&lt;li&gt;&lt;code&gt;KUBE-SERVICES&lt;/code&gt; chain &lt;strong&gt;执行真正的 Service 匹配&lt;/strong&gt;，依据协议类型、目的 IP 和目的端口号。当匹配到某个 Service 后，就会跳转到专门针对这个 Service 创 建的 chain，命名格式为 &lt;code&gt;KUBE-SVC-&amp;lt;Service&amp;gt;&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;KUBE-SVC-&amp;lt;Service&amp;gt;&lt;/code&gt; chain &lt;strong&gt;根据概率选择某个后端 pod&lt;/strong&gt; 然后将请求转发过去。这其实是一种&lt;strong&gt;穷人的负载均衡器&lt;/strong&gt; —— 基于 iptables。选中某个 pod 后，会跳转到这个 pod 相关的一条 iptables chain &lt;code&gt;KUBE-SEP-&amp;lt;POD&amp;gt;&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;KUBE-SEP-&amp;lt;POD&amp;gt;&lt;/code&gt; chain 会&lt;strong&gt;执行 DNAT&lt;/strong&gt;，将 VIP 换成 PodIP。&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;译注：以上解释并不是非常详细和直观，因为这不是本文重点。想更深入地理解基于 iptables 的实现，可参考网上其他一些文章，例如下面这张图所出自的博客 &lt;a href=&quot;https://www.stackrox.com/post/2020/01/kubernetes-networking-demystified/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kubernetes Networking Demystified: A Brief Guide&lt;/a&gt;，&lt;br&gt;&lt;img src=&quot;/images/k8s/cim_k8s-net-demystified-svc-lb.png&quot; alt=&quot;k8s-net-demystified-svc-lb&quot;&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;1-2-NodePort-Service&quot;&gt;&lt;a href=&quot;#1-2-NodePort-Service&quot; class=&quot;headerlink&quot; title=&quot;1.2 NodePort Service&quot;&gt;&lt;/a&gt;1.2 NodePort Service&lt;/h3&gt;&lt;p&gt;这种类型的 Service 也能被宿主机和 pod 访问，但与 ClusterIP 不同的是，&lt;strong&gt;它还能被集群外的服务访问&lt;/strong&gt;。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;External node IP + port in NodePort range to any endpoint (pod), e.g. 10.0.0.1:31000&lt;/li&gt;
&lt;li&gt;Enables access from outside&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;实现上，kube-apiserver 会&lt;strong&gt;从预留的端口范围内分配一个端口给 Service&lt;/strong&gt;，然后&lt;strong&gt;每个宿主机上的 kube-proxy 都会创建以下规则&lt;/strong&gt;：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-t nat -A &amp;#123;PREROUTING, OUTPUT&amp;#125; -m conntrack --ctstate NEW -j KUBE-SERVICES&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-SERVICES ! &lt;span class=&quot;_&quot;&gt;-s&lt;/span&gt; 1.1.0.0/16 &lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt; 3.3.3.3/32 -p tcp -m tcp --dport 80 -j KUBE-MARK-MASQ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-SERVICES &lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt; 3.3.3.3/32 -p tcp -m tcp --dport 80 -j KUBE-SVC-NGINX&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 如果前面两条都没匹配到（说明不是 ClusterIP service 流量），并且 dst 是 LOCAL，跳转到 KUBE-NODEPORTS&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-SERVICES -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-NODEPORTS -p tcp -m tcp --dport 31000 -j KUBE-MARK-MASQ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-NODEPORTS -p tcp -m tcp --dport 31000 -j KUBE-SVC-NGINX&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-SVC-NGINX -m statistic --mode random --probability 0.50 -j KUBE-SEP-NGINX1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-SVC-NGINX -j KUBE-SEP-NGINX2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;前面几步和 ClusterIP Service 一样；如果没匹配到 ClusterIP 规则，则跳转到 &lt;code&gt;KUBE-NODEPORTS&lt;/code&gt; chain。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;KUBE-NODEPORTS&lt;/code&gt; chain 里做 Service 匹配，但&lt;strong&gt;这次只匹配协议类型和目的端口号&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;匹配成功后，转到对应的 &lt;code&gt;KUBE-SVC-&amp;lt;Service&amp;gt;&lt;/code&gt; chain，后面的过程跟 ClusterIP 是一样的。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;1-3-小结&quot;&gt;&lt;a href=&quot;#1-3-小结&quot; class=&quot;headerlink&quot; title=&quot;1.3 小结&quot;&gt;&lt;/a&gt;1.3 小结&lt;/h3&gt;&lt;p&gt;以上可以看到，每个 Service 会对应多条 iptables 规则。&lt;/p&gt;
&lt;p&gt;Service 数量不断增长时，&lt;strong&gt;iptables 规则的数量增长会更快&lt;/strong&gt;。而且，&lt;strong&gt;每个包都需要遍历这些规则&lt;/strong&gt;，直到最终匹配到一条相应的规则。如果不幸匹配到最后一条规则才命中， 那相比其他流量，这些包就会有&lt;strong&gt;很高的延迟&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;有了这些背景知识，我们来看如何用 BPF/Cilium 来替换掉 kube-proxy，也可以说是 重新实现 kube-proxy 的逻辑。&lt;/p&gt;
&lt;h2 id=&quot;2-用-Cilium-BPF-替换-kube-proxy&quot;&gt;&lt;a href=&quot;#2-用-Cilium-BPF-替换-kube-proxy&quot; class=&quot;headerlink&quot; title=&quot;2 用 Cilium/BPF 替换 kube-proxy&quot;&gt;&lt;/a&gt;2 用 Cilium/BPF 替换 kube-proxy&lt;/h2&gt;&lt;p&gt;我们从 Cilium 早起版本开始，已经逐步用 BPF 实现 Service 功能，但其中仍然有些 地方需要用到 iptables。在这一时期，每台 node 上会同时运行 cilium-agent 和 kube-proxy。&lt;/p&gt;
&lt;p&gt;到了 Cilium 1.6，我们已经能&lt;strong&gt;完全基于 BPF 实现，不再依赖 iptables，也不再需要 kube-proxy&lt;/strong&gt;。&lt;br&gt;&lt;img src=&quot;/images/k8s/cim_cilium-cluster-ip.png&quot; alt=&quot;cim_cilium-cluster-ip&quot;&gt;&lt;/p&gt;
&lt;p&gt;这里有一些实现上的考虑：相比于在 TC ingress 层做 Service 转换，我们优先利用 cgroupv2 hooks，&lt;strong&gt;在 socket BPF 层直接做这种转换&lt;/strong&gt;（需要高版本内核支持，如果不支 持则 fallback 回 TC ingress 方式）。&lt;/p&gt;
&lt;h3 id=&quot;2-1-ClusterIP-Service&quot;&gt;&lt;a href=&quot;#2-1-ClusterIP-Service&quot; class=&quot;headerlink&quot; title=&quot;2.1 ClusterIP Service&quot;&gt;&lt;/a&gt;2.1 ClusterIP Service&lt;/h3&gt;&lt;p&gt;对于 ClusterIP，我们在 BPF 里&lt;strong&gt;拦截 socket 的 &lt;code&gt;connect&lt;/code&gt; 和 &lt;code&gt;send&lt;/code&gt; 系统调用&lt;/strong&gt;； 这些 BPF 执行时，&lt;strong&gt;协议层还没开始执行&lt;/strong&gt;（这些系统调用 handlers）。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Attach on the cgroupv2 root mount &lt;code&gt;BPF_PROG_TYPE_CGROUP_SOCK_ADDR&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;BPF_CGROUP_INET{4,6}_CONNECT&lt;/code&gt; - TCP, connected UDP&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;TCP-amp-connected-UDP&quot;&gt;&lt;a href=&quot;#TCP-amp-connected-UDP&quot; class=&quot;headerlink&quot; title=&quot;TCP &amp;amp; connected UDP&quot;&gt;&lt;/a&gt;TCP &amp;amp; connected UDP&lt;/h4&gt;&lt;p&gt;对于 TCP 和 connected UDP 场景，执行的是下面一段逻辑，&lt;br&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;sock4_xlate&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; bpf_sock_addr *ctx)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; lb4_svc_key key = &amp;#123; .dip = ctx-&amp;gt;user_ip4, .dport = ctx-&amp;gt;user_port &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	svc = lb4_lookup_svc(&amp;amp;key)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (svc) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			ctx-&amp;gt;user_ip4 = svc-&amp;gt;endpoint_addr;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			ctx-&amp;gt;user_port = svc-&amp;gt;endpoint_port;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;所做的事情：在 BPF map 中查找 Service，然后做地址转换。但这里的重点是（相比于 TC ingress BPF 实现）：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;不经过连接跟踪（conntrack）模块，也不需要修改包头&lt;/strong&gt;（实际上这时候还没有包 ），也不再 mangle 包。这也意味着，&lt;strong&gt;不需要重新计算包的 checksum&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;对于 TCP 和 connected UDP，&lt;strong&gt;负载均衡的开销是一次性的&lt;/strong&gt;，只需要在 socket 建立时做一次转换，后面都不需要了，&lt;strong&gt;不存在包级别的转换&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;这种方式是对宿主机 netns 上的 socket 和 pod netns 内的 socket 都是适用的。&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&quot;某些-UDP-应用：存在的问题及解决方式&quot;&gt;&lt;a href=&quot;#某些-UDP-应用：存在的问题及解决方式&quot; class=&quot;headerlink&quot; title=&quot;某些 UDP 应用：存在的问题及解决方式&quot;&gt;&lt;/a&gt;某些 UDP 应用：存在的问题及解决方式&lt;/h4&gt;&lt;p&gt;但这种方式&lt;strong&gt;对某些 UDP 应用是不适用的&lt;/strong&gt;，因为这些 UDP 应用会检查包的源地址，以及 会调用 &lt;code&gt;recvmsg&lt;/code&gt; 系统调用。&lt;/p&gt;
&lt;p&gt;针对这个问题，我们引入了新的 BPF attach 类型：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;BPF_CGROUP_UDP4_RECVMSG&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;BPF_CGROUP_UDP6_RECVMSG&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;另外还引入了用于 NAT 的 UDP map、rev-NAT map：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;              BPF rev NAT map&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Cookie   EndpointIP  Port =&amp;gt; ServiceID  IP       Port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-----------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42       1.1.1.1     80   =&amp;gt; 1          3.3.3.30 80&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;通过 &lt;code&gt;bpf_get_socket_cookie()&lt;/code&gt; 创建 socket cookie。&lt;/li&gt;
&lt;li&gt;除了 Service 访问方式，还会有一些&lt;strong&gt;客户端通过 PodIP 直连的方式建立 UDP 连接， cookie 就是为了防止对这些类型的流量做 rev-NAT&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;在 &lt;code&gt;connect(2)&lt;/code&gt; 和 &lt;code&gt;sendmsg(2)&lt;/code&gt; 时更新 map。&lt;/li&gt;
&lt;li&gt;在 &lt;code&gt;recvmsg(2)&lt;/code&gt; 时做 rev-NAT。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;2-2-NodePort-Service&quot;&gt;&lt;a href=&quot;#2-2-NodePort-Service&quot; class=&quot;headerlink&quot; title=&quot;2.2 NodePort Service&quot;&gt;&lt;/a&gt;2.2 NodePort Service&lt;/h3&gt;&lt;p&gt;NodePort 会更复杂一些，我们先从最简单的场景看起。&lt;/p&gt;
&lt;h4 id=&quot;2-2-1-后端-pod-在本节点&quot;&gt;&lt;a href=&quot;#2-2-1-后端-pod-在本节点&quot; class=&quot;headerlink&quot; title=&quot;2.2.1 后端 pod 在本节点&quot;&gt;&lt;/a&gt;2.2.1 后端 pod 在本节点&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;/images/k8s/cim_cilium-node-port.png&quot; alt=&quot;cilium-node-port&quot;&gt;&lt;/p&gt;
&lt;p&gt;后端 pod 在本节点时，只需要&lt;strong&gt;在宿主机的网络设备上 attach 一段 tc ingress bpf 程序&lt;/strong&gt;，这段程序做的事情：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Service 查找&lt;/li&gt;
&lt;li&gt;DNAT&lt;/li&gt;
&lt;li&gt;redirect 到容器的 lxc0。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;对于应答包，lxc0 负责 rev-NAT，FIB 查找（因为我们需要设置 L2 地址，否则会被 drop）， 然后将其 redirect 回客户端。&lt;/p&gt;
&lt;h3 id=&quot;2-2-2-后端-pod-在其他节点&quot;&gt;&lt;a href=&quot;#2-2-2-后端-pod-在其他节点&quot; class=&quot;headerlink&quot; title=&quot;2.2.2 后端 pod 在其他节点&quot;&gt;&lt;/a&gt;2.2.2 后端 pod 在其他节点&lt;/h3&gt;&lt;p&gt;后端 pod 在其他节点时，会复杂一些，因为要转发到其他节点。这种情况下，&lt;strong&gt;需要在 BPF 做 SNAT&lt;/strong&gt;，否则 pod 会直接回包给客户端，而由于不同 node 之间没有做连接跟踪（ conntrack）同步，因此直接回给客户端的包出 pod 后就会被 drop 掉。&lt;/p&gt;
&lt;p&gt;所以需要&lt;strong&gt;在当前节点做一次 SNAT&lt;/strong&gt;（&lt;code&gt;src_ip&lt;/code&gt; 从原来的 ClientIP 替换为 NodeIP），让回包也经过 当前节点，然后在这里再做 rev-SNAT（&lt;code&gt;dst_ip&lt;/code&gt; 从原来的 NodeIP 替换为 ClientIP）。&lt;/p&gt;
&lt;p&gt;具体来说，在 &lt;strong&gt;TC ingress&lt;/strong&gt; 插入一段 BPF 代码，然后依次执行：Service 查找、DNAT、 选择合适的 egress interface、SNAT、FIB lookup，最后发送给相应的 node，&lt;br&gt;&lt;img src=&quot;/images/k8s/cim_cilium-node-port-2.png&quot; alt=&quot;cilium-node-port-2&quot;&gt;&lt;/p&gt;
&lt;p&gt;反向路径是类似的，也是回到这个 node，TC ingress BPF 先执行 rev-SNAT，然后 rev-DNAT，FIB lookup，最后再发送回客户端，&lt;br&gt;&lt;img src=&quot;/images/k8s/cim_cilium-node-port-3.png&quot; alt=&quot;cilium-node-port-3&quot;&gt;&lt;/p&gt;
&lt;p&gt;现在跨宿主机转发是 SNAT 模式，但将来我们打算支持 &lt;strong&gt;DSR 模式&lt;/strong&gt;（译注，Cilium 1.8+ 已经支持了）。DSR 的好处是 &lt;strong&gt;backend pods 直接将包回给客户端&lt;/strong&gt;，回包不再经过当前 节点转发。&lt;/p&gt;
&lt;p&gt;另外，现在 Service 的处理是在 TC ingress 做的，&lt;strong&gt;这些逻辑其实也能够在 XDP 层实现&lt;/strong&gt;， 那将会是另一件激动人心的事情（译注，Cilium 1.8+ 已经支持了，性能大幅提升）。&lt;/p&gt;
&lt;h4 id=&quot;SNAT&quot;&gt;&lt;a href=&quot;#SNAT&quot; class=&quot;headerlink&quot; title=&quot;SNAT&quot;&gt;&lt;/a&gt;SNAT&lt;/h4&gt;&lt;p&gt;当前基于 BPF 的 SNAT 实现中，用一个 LRU BPF map 存放 Service 和 backend pods 的映 射信息。&lt;/p&gt;
&lt;p&gt;需要说明的是，&lt;strong&gt;SNAT 除了替换 &lt;code&gt;src_ip&lt;/code&gt;，还可能会替换 &lt;code&gt;src_port&lt;/code&gt;&lt;/strong&gt;：不同客户端的 &lt;code&gt;src_port&lt;/code&gt; 可能是相同的，如果只替换 &lt;code&gt;src_ip&lt;/code&gt;，不同客户端的应答包在反向转换时就会失 败。因此这种情况下需要做 &lt;code&gt;src_port&lt;/code&gt; 转换。现在的做法是，先进行哈希，如果哈希失败， 就调用 &lt;code&gt;prandom()&lt;/code&gt; 随机选择一个端口。&lt;/p&gt;
&lt;p&gt;此外，我们还需要跟踪宿主机上的流（local flows）信息，因此在 Cilium 里&lt;strong&gt;基于 BPF 实现了一个连接跟踪器&lt;/strong&gt;（connection tracker），它会监听宿主机的主物理网络设备（ main physical device）；我们也会对宿主机上的应用执行 NAT，pod 流量 NAT 之后使用的 是宿主机的 src_port，而宿主机上的应用使用的也是同一个 src_port 空间，它们可能会 有冲突，因此需要在这里处理。&lt;/p&gt;
&lt;p&gt;这就是 NodePort Service 类型的流量到达一台节点后，我们在 BPF 所做的事情。&lt;/p&gt;
&lt;h3 id=&quot;2-2-3-Client-pods-和-backend-pods-在同一节点&quot;&gt;&lt;a href=&quot;#2-2-3-Client-pods-和-backend-pods-在同一节点&quot; class=&quot;headerlink&quot; title=&quot;2.2.3 Client pods 和 backend pods 在同一节点&quot;&gt;&lt;/a&gt;2.2.3 Client pods 和 backend pods 在同一节点&lt;/h3&gt;&lt;p&gt;另外一种情况是：本机上的 pod 访问某个 NodePort Service，而且 backend pods 也在本机。&lt;/p&gt;
&lt;p&gt;这种情况下，流量会从 loopback 口转发到 backend pods，中间会经历路由和转发过程， 整个过程对应用是透明的 —— 我们可以在&lt;strong&gt;应用无感知的情况下，修改二者之间的通信方式&lt;/strong&gt;， 只要流量能被双方正确地接受就行。因此，我们在这里&lt;strong&gt;使用了 ClusterIP，并对其进行了一点扩展&lt;/strong&gt;，只要连接的 Service 是 loopback 地址或者其他 local 地址，它都能正 确地转发到本机 pods。&lt;/p&gt;
&lt;p&gt;另外，比较好的一点是，这种实现方式是基于 cgroups 的，因此独立于 netns。这意味着 我们不需要进入到每个 pod 的 netns 来做这种转换。&lt;br&gt;&lt;img src=&quot;/images/k8s/cim_cilium-snat.png&quot; alt=&quot;cilium-snat&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;2-3-Service-规则的规模及请求延迟对比&quot;&gt;&lt;a href=&quot;#2-3-Service-规则的规模及请求延迟对比&quot; class=&quot;headerlink&quot; title=&quot;2.3 Service 规则的规模及请求延迟对比&quot;&gt;&lt;/a&gt;2.3 Service 规则的规模及请求延迟对比&lt;/h2&gt;&lt;p&gt;有了以上功能，基本上就可以避免 kube-proxy 那样 per-service 的 iptables 规则了， 每个节点上只留下了少数几条由 Kubernetes 自己创建的 iptables 规则：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ iptables-save | grep ‘\-A KUBE’ | wc &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;With kube-proxy: 25401&lt;/li&gt;
&lt;li&gt;With BPF: 4&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在将来，我们有希望连这几条规则也不需要，完全绕开 Netfilter 框架（译注：新版本已经做到了）。&lt;/p&gt;
&lt;p&gt;此外，我们做了一些初步的基准测试，如下图所示，&lt;br&gt;&lt;img src=&quot;/images/k8s/cim_performance.png&quot; alt=&quot;performance&quot;&gt;&lt;/p&gt;
&lt;p&gt;可以看到，随着 Service 数量从 1 增加到 2000+，&lt;strong&gt;kube-proxy/iptables 的请求延 迟增加了将近一倍&lt;/strong&gt;，而 Cilium/eBPF 的延迟几乎没有任何增加。&lt;/p&gt;
&lt;h2 id=&quot;3-相关的-Cilium-BPF-优化&quot;&gt;&lt;a href=&quot;#3-相关的-Cilium-BPF-优化&quot; class=&quot;headerlink&quot; title=&quot;3 相关的 Cilium/BPF 优化&quot;&gt;&lt;/a&gt;3 相关的 Cilium/BPF 优化&lt;/h2&gt;&lt;p&gt;接下来介绍一些我们在实现 Service 过程中的优化工作，以及一些未来可能会做的事情。&lt;/p&gt;
&lt;h3 id=&quot;3-1-BPF-UDP-recvmsg-hook&quot;&gt;&lt;a href=&quot;#3-1-BPF-UDP-recvmsg-hook&quot; class=&quot;headerlink&quot; title=&quot;3.1 BPF UDP recvmsg() hook&quot;&gt;&lt;/a&gt;3.1 BPF UDP &lt;code&gt;recvmsg()&lt;/code&gt; hook&lt;/h3&gt;&lt;p&gt;实现 socket 层 UDP Service 转换时，我们发现如果只对 UDP &lt;code&gt;sendmsg&lt;/code&gt; 做 hook ，会导致 &lt;strong&gt;DNS 等应用无法正常工作&lt;/strong&gt;，会出现下面这种错误：&lt;br&gt;&lt;img src=&quot;/images/k8s/cim_udp-recvmsg-before.png&quot; alt=&quot;udp-recvmsg-before&quot;&gt;&lt;/p&gt;
&lt;p&gt;深入分析发现，&lt;code&gt;nslookup&lt;/code&gt; 及其他一些工具会检查 &lt;strong&gt;&lt;code&gt;connect()&lt;/code&gt; 时用的 IP 地址和 &lt;code&gt;recvmsg()&lt;/code&gt; 读到的 reply message 里的 IP 地址&lt;/strong&gt;是否一致。如果不一致，就会 报上面的错误。&lt;/p&gt;
&lt;p&gt;原因清楚之后，解决就比较简单了：我们引入了一个做反向映射的 BPF hook，对 &lt;code&gt;recvmsg()&lt;/code&gt; 做额外处理，这个问题就解决了：&lt;br&gt;&lt;img src=&quot;/images/k8s/cim_udp-recvmsg-after.png&quot; alt=&quot;udp-recvmsg-after&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/torvalds/linux/commit/983695fa6765&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;983695fa6765&lt;/a&gt; bpf: fix unconnected udp hooks。&lt;br&gt;这个 patch 能在不重写包（without packet rewrite）的前提下，会对 BPF ClusterIP 做反向映射（reverse mapping）。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;3-2-全局唯一-socket-cookie&quot;&gt;&lt;a href=&quot;#3-2-全局唯一-socket-cookie&quot; class=&quot;headerlink&quot; title=&quot;3.2 全局唯一 socket cookie&quot;&gt;&lt;/a&gt;3.2 全局唯一 socket cookie&lt;/h3&gt;&lt;p&gt;BPF ClusterIP Service 为 UDP 维护了一个 LRU 反向映射表（reverse mapping table）。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Socket cookie 是这个映射表的 key 的一部分，但这个 cookie 只在每个 netns 内唯一&lt;/strong&gt;，其背后的实现比较简单：每次调用 BPF cookie helper，它都会增加计数器，然后将 cookie 存储到 socket。因此不同 netns 内分配出来的 cookie 值可能会一样，导致冲突。&lt;/p&gt;
&lt;p&gt;为解决这个问题，我们将 cookie generator 改成了全局的，见下面的 commit。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/torvalds/linux/commit/cd48bdda4fb8&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;cd48bdda4fb8&lt;/a&gt; sock: make cookie generation global instead of per netns。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;3-3-维护邻居表&quot;&gt;&lt;a href=&quot;#3-3-维护邻居表&quot; class=&quot;headerlink&quot; title=&quot;3.3 维护邻居表&quot;&gt;&lt;/a&gt;3.3 维护邻居表&lt;/h3&gt;&lt;p&gt;Cilium agent 从 K8s apiserver 收到 Service 事件时， 会将 backend entry 更新到 datapath 中的 Service backend 列表。&lt;/p&gt;
&lt;p&gt;前面已经看到，当 Service 是 NodePort 类型并且 backend 是 remote 时，需要转发到其 他节点（TC ingress BPF &lt;code&gt;redirect()&lt;/code&gt;）。&lt;/p&gt;
&lt;p&gt;我们发现&lt;strong&gt;在某些直接路由（direct routing）的场景下，会出现 fib 查找失败的问题&lt;/strong&gt; （&lt;code&gt;fib_lookup()&lt;/code&gt;），原因是系统中没有对应 backend 的 neighbor entry（IP-&amp;gt;MAC 映射 信息），并且接下来&lt;strong&gt;不会主动做 ARP 探测&lt;/strong&gt;（ARP probe）。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Tunneling 模式下这个问题可以忽略，因为本来发送端的 BPF 程 序就会将 src/dst mac 清零，另一台节点对收到的包做处理时， VxLAN 设备上的另一段 BPF 程序会能够正确的转发这个包，因此这种方式更像是 L3 方式。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;我们目前 workaround 了这个问题，解决方式有点丑陋：Cilium 解析 backend，然后直接 将 neighbor entry 永久性地（&lt;code&gt;NUD_PERMANENT&lt;/code&gt;）插入邻居表中。&lt;/p&gt;
&lt;p&gt;目前这样做是没问题的，因为邻居的数量是固定或者可控的（fixed/controlled number of entries）。但后面我们想尝试的是让内核来做这些事情，因为它能以最好的方式处理这个 问题。实现方式就是引入一些新的 &lt;code&gt;NUD_*&lt;/code&gt; 类型，只需要传 L3 地址，然后内核自己将解 析 L2 地址，并负责这个地址的维护。这样 Cilium 就不需要再处理 L2 地址的事情了。 但到今天为止，我并没有看到这种方式的可能性。&lt;/p&gt;
&lt;p&gt;对于从集群外来的访问 NodePort Service 的请求，也存在类似的问题， 因为最后将响应流量回给客户端也需要邻居表。由于这些流量都是在 pre-routing，因此我 们现在的处理方式是：自己维护了一个小的 BPF LRU map（L3-&amp;gt;L2 mapping in BPF LRU map）；由于这是主处理逻辑（转发路径），流量可能很高，因此将这种映射放到 BPF LRU 是更合适的，不会导致邻居表的 overflow。&lt;/p&gt;
&lt;h3 id=&quot;3-4-LRU-BPF-callback-on-entry-eviction&quot;&gt;&lt;a href=&quot;#3-4-LRU-BPF-callback-on-entry-eviction&quot; class=&quot;headerlink&quot; title=&quot;3.4 LRU BPF callback on entry eviction&quot;&gt;&lt;/a&gt;3.4 LRU BPF callback on entry eviction&lt;/h3&gt;&lt;p&gt;我们想讨论的另一件事情是：在每个 LRU entry 被 eviction（驱逐）时，能有一个 callback 将会更好。为什么呢？&lt;/p&gt;
&lt;p&gt;Cilium 中现在有一个 BPF conntrack table，我们支持到了一些非常老的内核版本 ，例如 4.9。Cilium 在启动时会检查内核版本，优先选择使用 LRU，没有 LRU 再 fallback 到普通的哈希表（Hash Table）。&lt;strong&gt;对于哈希表，就需要一个不断 GC 的过程&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;我们&lt;strong&gt;有意将 NAT map 与 CT map 独立开来&lt;/strong&gt;，这是因 为我们要求在 &lt;strong&gt;cilium-agent 升级或降级过程中，现有的连接/流量不能受影响&lt;/strong&gt;。 如果二者是耦合在一起的，假如 CT 相关的东西有很大改动，那升级时那要么 是将当前的连接状态全部删掉重新开始；要么就是服务中断，临时不可用，升级完成后再将 老状态迁移到新状态表，但我认为，要轻松、正确地实现这件事情非常困难。 这就是为什么将它们分开的原因。但实际上，GC 在回收 CT entry 的同时， 也会顺便回收 NAT entry。&lt;/p&gt;
&lt;p&gt;另外一个问题：&lt;strong&gt;每次从 userspace 操作 conntrack entry 都会破坏 LRU 的正常工作流程&lt;/strong&gt;（因为不恰当地更新了所有 entry 的时间戳）。我们通过下面的 commit 解决了这个问题，但要彻底避免这个问题，&lt;strong&gt;最好有一个 GC 以 callback 的方式在第一时 间清理掉这些被 evicted entry&lt;/strong&gt;，例如在 CT entry 被 evict 之后，顺便也清理掉 NAT 映射。这是我们正在做的事情（译注，Cilium 1.9+ 已经实现了）。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/torvalds/linux/commit/50b045a8c0cc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;50b045a8c0cc&lt;/a&gt; (“bpf, lru: avoid messing with eviction heuristics upon syscall lookup”) fixed map walking from user space&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;3-5-LRU-BPF-eviction-zones&quot;&gt;&lt;a href=&quot;#3-5-LRU-BPF-eviction-zones&quot; class=&quot;headerlink&quot; title=&quot;3.5 LRU BPF eviction zones&quot;&gt;&lt;/a&gt;3.5 LRU BPF eviction zones&lt;/h3&gt;&lt;p&gt;另一件跟 CT map 相关的比较有意思的探讨：&lt;strong&gt;未来是否能根据流量类型，将 LRU eviction 分割为不同的 zone&lt;/strong&gt;？例如，&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;东西向流量分到 zone1：处理 ClusterIP service 流量，都是 pod-{pod,host} 流量， 比较大；&lt;/li&gt;
&lt;li&gt;南北向流量分到 zone2：处理 NodePort 和 ExternalName service 流量，相对比较小。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这样的好处是：当&lt;strong&gt;对南北向流量 CT 进行操作时，占大头的东西向流量不会受影响&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;理想的情况是这种隔离是有保障的，例如：可以安全地假设，如果正在清理 zone1 内的 entries， 那预期不会对 zone2 内的 entry 有任何影响。不过，虽然分为了多个 zones，但在全局， 只有一个 map。&lt;/p&gt;
&lt;h3 id=&quot;3-6-BPF-原子操作&quot;&gt;&lt;a href=&quot;#3-6-BPF-原子操作&quot; class=&quot;headerlink&quot; title=&quot;3.6 BPF 原子操作&quot;&gt;&lt;/a&gt;3.6 BPF 原子操作&lt;/h3&gt;&lt;p&gt;另一个要讨论的内容是原子操作。&lt;/p&gt;
&lt;p&gt;使用场景之一是&lt;strong&gt;过期 NAT entry 的快速重复利用&lt;/strong&gt;（fast recycling）。 例如，结合前面的 GC 过程，如果一个连接断开时， 不是直接删除对应的 entry，而是更 新一个标记，表明这条 entry 过期了；接下来如果有新的连接刚好命中了这个 entry，就 直接将其标记为正常（非过期），重复利用（循环）这个 entry，而不是像之前一样从新创 建。&lt;/p&gt;
&lt;p&gt;现在基于 BPF spinlock 可以实现做这个功能，但并不是最优的方式，因为如果有合适的原 子操作，我们就能节省两次辅助函数调用，然后将 spinlock 移到 map 里。将 spinlock 放到 map 结构体的额外好处是，每个结构体都有自己独立的结构（互相解耦），因此更能 够避免升级/降低导致的问题。&lt;/p&gt;
&lt;p&gt;当前内核只有 &lt;code&gt;BPF_XADD&lt;/code&gt; 指令，我认为它主要适用于计数（counting），因为它并不像原 子递增（inc）函数一样返回一个值。此外内核中还有的就是针对 maps 的 spinlock。&lt;/p&gt;
&lt;p&gt;我觉得如果有 &lt;code&gt;READ_ONCE/WRITE_ONCE&lt;/code&gt; 语义将会带来很大便利，现在的 BPF 代码中其实已 经有了一些这样功能的、自己实现的代码。此外，我们还需要 &lt;code&gt;BPF_XCHG&lt;/code&gt;, &lt;code&gt;BPF_CMPXCHG&lt;/code&gt; 指令，这也将带来很大帮助。&lt;/p&gt;
&lt;h3 id=&quot;3-7-BPF-getpeername-hook&quot;&gt;&lt;a href=&quot;#3-7-BPF-getpeername-hook&quot; class=&quot;headerlink&quot; title=&quot;3.7 BPF getpeername hook&quot;&gt;&lt;/a&gt;3.7 BPF &lt;code&gt;getpeername&lt;/code&gt; hook&lt;/h3&gt;&lt;p&gt;还有一个 hook —— &lt;code&gt;getpeername()&lt;/code&gt; —— 没有讨论到，它&lt;strong&gt;用在 TCP 和 connected UDP 场景&lt;/strong&gt;，对应用是透明的。&lt;/p&gt;
&lt;p&gt;这里的想法是：永远返回 Service IP 而不是 backend pod IP，这样对应用来说，它看到 就是和 Service IP 建立的连接，而不是和某个具体的 backend pod。&lt;/p&gt;
&lt;p&gt;现在返回的是 backend IP 而不是 service IP。从应用的角度看，它连接到的对端并不是 它期望的。&lt;/p&gt;
&lt;h3 id=&quot;3-8-绕过内核最大-BPF-指令数的限制&quot;&gt;&lt;a href=&quot;#3-8-绕过内核最大-BPF-指令数的限制&quot; class=&quot;headerlink&quot; title=&quot;3.8 绕过内核最大 BPF 指令数的限制&quot;&gt;&lt;/a&gt;3.8 绕过内核最大 BPF 指令数的限制&lt;/h3&gt;&lt;p&gt;最后再讨论几个非内核的改动（non-kernel changes）。&lt;/p&gt;
&lt;p&gt;内核对 &lt;strong&gt;BPF 最大指令数有 4K 条&lt;/strong&gt;的限制，现在这个限制已经放大到 &lt;strong&gt;1M&lt;/strong&gt;（一百万） 条（但需要 5.1+ 内核，或者稍低版本的内核 + 相应 patch）。&lt;/p&gt;
&lt;p&gt;我们的 BPF 程序中包含了 NAT 引擎，因此肯定是超过这个限制的。 但 Cilium 这边，我们目前还并未用到这个新的最大限制，而是通过“外包”的方式将 BPF 切分成了子 BPF 程序，然后通过尾调用（tail call）跳转过去，以此来绕过这个 4K 的限 制。&lt;/p&gt;
&lt;p&gt;另外，我们当前使用的是 BPF tail call，而不是 BPF-to-BPF call，因为&lt;strong&gt;二者不能同时使用&lt;/strong&gt;。更好的方式是，Cilium agent 在启动时进行检查，如果内核支持 1M BPF insns/complexity limit + bounded loops（我们用于 NAT mappings 查询优化），就用这 些新特性；否则回退到尾调用的方式。&lt;/p&gt;
&lt;h2 id=&quot;4-Cilium-上手：用-kubeadm-搭建体验环境&quot;&gt;&lt;a href=&quot;#4-Cilium-上手：用-kubeadm-搭建体验环境&quot; class=&quot;headerlink&quot; title=&quot;4 Cilium 上手：用 kubeadm 搭建体验环境&quot;&gt;&lt;/a&gt;4 Cilium 上手：用 kubeadm 搭建体验环境&lt;/h2&gt;&lt;p&gt;有兴趣尝试 Cilium，可以参考下面的快速安装命令：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubeadm init --pod-network-cidr=10.217.0.0/16 --skip-phases=addon/kube-proxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubeadm join [...]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ helm template cilium \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		 --namespace kube-system --set global.nodePort.enabled=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		 --set global.k8sServiceHost=&lt;span class=&quot;variable&quot;&gt;$API_SERVER_IP&lt;/span&gt; \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		 --set global.k8sServicePort=&lt;span class=&quot;variable&quot;&gt;$API_SERVER_PORT&lt;/span&gt; \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		 --set global.tag=v1.6.1 &amp;gt; cilium.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		 kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; cilium.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;附录: &lt;a href=&quot;/images/k8s/Making_the_Kubernetes_Service_Abstraction_Scale_using_BPF.pdf&quot;&gt;Making_the_Kubernetes_Service_Abstraction_Scale_using_BPF.pdf&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;译自：ArthurChiao 原文：&lt;a href=&quot;https://linuxplumbersconf.org/event/4/contributions/458/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://linuxplumbersconf.org/event/4/contributions/458/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;本文翻译自 2019 年 Daniel Borkmann 和 Martynas Pumputis 在 Linux Plumbers Conference 的一篇分享: &lt;a href=&quot;https://linuxplumbersconf.org/event/4/contributions/458/&quot;&gt;Making the Kubernetes Service Abstraction Scale using eBPF&lt;/a&gt; 。 翻译时对大家耳熟能详或已显陈旧的内容（K8s 介绍、Cilium 1.6 之前的版本对 Service 实现等）略有删减，如有需要请查阅原 PDF。&lt;/p&gt;
&lt;p&gt;实际上，一年之后 Daniel 和 Martynas 又在 LPC 做了一次分享，内容是本文的延续：&lt;a href=&quot;http://team.jiunile.com/blog/2020/11/k8s-cilium-service.html&quot;&gt;Cilium：基于 BPF/XDP 实现 K8s Service 负载均衡&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;K8s 当前重度依赖 iptables 来实现 Service 的抽象&lt;/strong&gt;。对于每个 Service 及其 backend pods，在 K8s 里会生成很多 iptables 规则。&lt;strong&gt;例如 5K 个 Service 时，iptables 规则将达到 25K 条&lt;/strong&gt;，导致的后果：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;较高、并且不可预测的转发延迟&lt;/strong&gt;（packet latency），因为每个包都要遍历这些规则 ，直到匹配到某条规则；&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;更新规则的操作非常慢&lt;/strong&gt;：无法单独更新某条 iptables 规则，只能将全部规则读出来 ，更新整个集合，再将新的规则集合下发到宿主机。在动态环境中这一问题尤其明显，因为每 小时可能都有几千次的 backend pods 创建和销毁。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;可靠性问题&lt;/strong&gt;：iptables 依赖 Netfilter 和系统的连接跟踪模块（conntrack），在 大流量场景下会出现一些竞争问题（race conditions）；&lt;strong&gt;UDP 场景尤其明显&lt;/strong&gt;，会导 致丢包、应用的负载升高等问题。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;本文将介绍如何基于 Cilium/BPF 来解决这些问题，实现 K8s Service 的大规模扩展。&lt;br&gt;
    
    </summary>
    
      <category term="Kubernetes" scheme="http://team.jiunile.com/categories/Kubernetes/"/>
    
      <category term="Cilium" scheme="http://team.jiunile.com/categories/Kubernetes/Cilium/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="ebpf" scheme="http://team.jiunile.com/tags/ebpf/"/>
    
      <category term="service" scheme="http://team.jiunile.com/tags/service/"/>
    
      <category term="bpf" scheme="http://team.jiunile.com/tags/bpf/"/>
    
  </entry>
  
  <entry>
    <title>使用 Go 实现 Async/Await 模式</title>
    <link href="http://team.jiunile.com//blog/2020/12/go-async-await.html"/>
    <id>http://team.jiunile.com//blog/2020/12/go-async-await.html</id>
    <published>2020-12-01T12:00:00.000Z</published>
    <updated>2020-11-30T15:41:49.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;Golang 是一种并发编程语言。它具有强大的特性，如 &lt;code&gt;Goroutines&lt;/code&gt; 和 &lt;code&gt;Channels&lt;/code&gt;，可以很好地处理异步任务。另外，&lt;code&gt;goroutines&lt;/code&gt; 不是 OS 线程，这就是为什么您可以在不增加开销的情况下根据需要启动任意数量的 &lt;code&gt;goroutine&lt;/code&gt; 的原因，它的堆栈大小初始化时仅 &lt;strong&gt;2KB&lt;/strong&gt;。那么为什么要 &lt;code&gt;async/await&lt;/code&gt; 呢？ &lt;code&gt;Async/Await&lt;/code&gt; 是一种很好的语言特点，它为异步编程提供了更简单的接口。&lt;/p&gt;
&lt;p&gt;项目链接：&lt;a href=&quot;https://github.com/icyxp/AsyncGoDemo&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/icyxp/AsyncGoDemo&lt;/a&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;它是如何工作的？&quot;&gt;&lt;a href=&quot;#它是如何工作的？&quot; class=&quot;headerlink&quot; title=&quot;它是如何工作的？&quot;&gt;&lt;/a&gt;它是如何工作的？&lt;/h2&gt;&lt;p&gt;从 F# 开始，然后是 C#，到现在 Python 和 Javascript 中，&lt;code&gt;async/await&lt;/code&gt; 是一种非常流行的语言特点。它简化了异步方法的执行结构并且读起来像同步代码。对于开发人员来说更容易理解。让我们看看 c# 中的一个简单示例 &lt;code&gt;async/await&lt;/code&gt; 是如何工作的。&lt;br&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; async Task &lt;span class=&quot;title&quot;&gt;Main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;built_in&quot;&gt;string&lt;/span&gt;[] args)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Console.WriteLine(&lt;span class=&quot;string&quot;&gt;&quot;Let&#39;s start ...&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    var done = DoneAsync();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Console.WriteLine(&lt;span class=&quot;string&quot;&gt;&quot;Done is running ...&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Console.WriteLine(await done);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; async Task&amp;lt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;gt; DoneAsync()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Console.WriteLine(&lt;span class=&quot;string&quot;&gt;&quot;Warming up ...&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    await Task.Delay(&lt;span class=&quot;number&quot;&gt;3000&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Console.WriteLine(&lt;span class=&quot;string&quot;&gt;&quot;Done ...&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;当程序运行时，我们的 &lt;code&gt;Main&lt;/code&gt; 函数将被执行。我们有异步函数 &lt;code&gt;DoneAsync&lt;/code&gt;。我们使用 &lt;code&gt;Delay&lt;/code&gt; 方法停止执行代码 3 秒钟。Delay 本身是一个异步函数，所以我们用 &lt;code&gt;await&lt;/code&gt; 来调用它。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;await&lt;/code&gt; 只阻塞异步函数内的代码执行&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在 &lt;code&gt;Main&lt;/code&gt; 函数中，我们不使用 &lt;code&gt;await&lt;/code&gt; 来调用 &lt;code&gt;DoneAsync&lt;/code&gt;。但 &lt;code&gt;DoneAsync&lt;/code&gt; 开始执行后，只有当我们 &lt;code&gt;await&lt;/code&gt; 它的时候，我们才会得到结果。执行流程如下所示：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Let&lt;span class=&quot;string&quot;&gt;&#39;s start ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Warming up ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Done is running ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Done ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;对于异步执行，这看起来非常简单。让我们看看如何使用 Golang 的 &lt;code&gt;Goroutines&lt;/code&gt; 和 &lt;code&gt;Channels&lt;/code&gt; 来做到这一点。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;DoneAsync&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;int&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	r := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;Warming up ...&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		time.Sleep(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; * time.Second)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		r &amp;lt;- &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;Done ...&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; r&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;Let&#39;s start ...&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	val := DoneAsync()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;Done is running ...&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(&amp;lt;- val)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;``&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;` &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;在这里，`&lt;/span&gt;DoneAsync&lt;span class=&quot;string&quot;&gt;` 异步运行并返回一个 `&lt;/span&gt;channel&lt;span class=&quot;string&quot;&gt;`。执行完异步任务后，它会将值写入 `&lt;/span&gt;channel&lt;span class=&quot;string&quot;&gt;`。在 `&lt;/span&gt;main&lt;span class=&quot;string&quot;&gt;` 函数中，我们调用 `&lt;/span&gt;DoneAsync&lt;span class=&quot;string&quot;&gt;` 并继续执行后续操作，然后从返回的 `&lt;/span&gt;channel&lt;span class=&quot;string&quot;&gt;` 读取值。它是一个阻塞调用，等待直到将值写入 `&lt;/span&gt;channel&lt;span class=&quot;string&quot;&gt;`，并在获得值后将其输出到终端。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;``&lt;/span&gt;&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Let&lt;span class=&quot;string&quot;&gt;&#39;s start ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Warming up ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Done is running ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Done ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们看到，我们实现了与 C# 程序相同的结果，但它看起来不像 &lt;code&gt;async/await&lt;/code&gt; 那样优雅。尽管这确实不错，但是我们可以使用这种方法轻松地完成很多细粒度的事情，我们还可以用一个简单的结构和接口在 Golang 中实现 &lt;code&gt;async/await&lt;/code&gt; 关键字。让我们试试。&lt;/p&gt;
&lt;h2 id=&quot;实现-Async-Await&quot;&gt;&lt;a href=&quot;#实现-Async-Await&quot; class=&quot;headerlink&quot; title=&quot;实现 Async/Await&quot;&gt;&lt;/a&gt;实现 Async/Await&lt;/h2&gt;&lt;p&gt;完整代码可在项目链接中找到（在文章开始的地方）。要在 Golang 中实现 &lt;code&gt;async/await&lt;/code&gt;，我们将从一个名为 &lt;code&gt;async&lt;/code&gt; 的包目录开始。项目结构看起来是这样的。&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── async&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│   └── async.go&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── main.go&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;└── README.md&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在 &lt;code&gt;async&lt;/code&gt; 文件中，我们编写了可以处理异步任务最简单的 &lt;code&gt;Future&lt;/code&gt; 接口。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; async&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;context&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Future interface has the method signature for await&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; Future &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Await() &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt;&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; future &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	await &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(ctx context.Context)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;interface&lt;/span&gt;&lt;/span&gt;&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(f future)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Await&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;interface&lt;/span&gt;&lt;/span&gt;&amp;#123;&amp;#125; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; f.await(context.Background())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Exec executes the async function&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Exec&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(f &lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;interface&lt;/span&gt;&lt;/span&gt;&amp;#123;&amp;#125;) Future &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; result &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt;&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	c := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt;&amp;#123;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;close&lt;/span&gt;(c)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		result = f()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; future&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		await: &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(ctx context.Context)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;interface&lt;/span&gt;&lt;/span&gt;&amp;#123;&amp;#125; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;select&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &amp;lt;-ctx.Done():&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; ctx.Err()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &amp;lt;-c:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; result&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这里发生的事情并不多，我们添加了一个具有 &lt;code&gt;Await&lt;/code&gt; 方法标识的 &lt;code&gt;Future&lt;/code&gt; 接口。接下来，我们添加一个 &lt;code&gt;future&lt;/code&gt; 结构，它包含一个值，即 &lt;code&gt;await&lt;/code&gt; 函数的函数标识。现在 &lt;code&gt;futute struct&lt;/code&gt; 通过调用自己的 &lt;code&gt;await&lt;/code&gt; 函数来实现 &lt;code&gt;Future&lt;/code&gt; 接口的 &lt;code&gt;Await&lt;/code&gt; 方法。&lt;/p&gt;
&lt;p&gt;接下来在 &lt;code&gt;Exec&lt;/code&gt; 函数中，我们在 &lt;code&gt;goroutine&lt;/code&gt; 中异步执行传递的函数。然后返回 &lt;code&gt;await&lt;/code&gt; 函数。它等待 &lt;code&gt;channel&lt;/code&gt; 关闭或 &lt;code&gt;context&lt;/code&gt; 读取。基于最先发生的情况，它要么返回错误，要么返回作为接口的结果。&lt;/p&gt;
&lt;p&gt;现在，有了这个新的 &lt;code&gt;async&lt;/code&gt; 包，让我们看看如何更改当前的 go 代码：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;DoneAsync&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;int&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;Warming up ...&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	time.Sleep(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; * time.Second)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;Done ...&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;Let&#39;s start ...&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	future := async.Exec(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;interface&lt;/span&gt;&lt;/span&gt;&amp;#123;&amp;#125; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; DoneAsync()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;Done is running ...&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	val := future.Await()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Println(val)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;乍一看，它看起来干净得多，这里我们没有显式地使用 &lt;code&gt;goroutine&lt;/code&gt; 或 &lt;code&gt;channels&lt;/code&gt;。我们的 &lt;code&gt;DoneAsync&lt;/code&gt; 函数已更改为完全同步的性质。在 &lt;code&gt;main&lt;/code&gt; 函数中，我们使用 &lt;code&gt;async&lt;/code&gt; 包的&lt;code&gt;Exec&lt;/code&gt; 方法来处理 &lt;code&gt;DoneAsync&lt;/code&gt;。在开始执行 &lt;code&gt;DoneAsync&lt;/code&gt;。控制流返回到可以执行其他代码的 &lt;code&gt;main&lt;/code&gt; 函数中。最后，我们对 &lt;code&gt;Await&lt;/code&gt; 进行阻塞调用并回读数据。&lt;/p&gt;
&lt;p&gt;现在，代码看起来更加简单易读。我们可以修改我们的 async 包从而能在 Golang 中合并许多其他类型的异步任务，但在本教程中，我们现在只坚持简单的实现。&lt;/p&gt;
&lt;h2 id=&quot;结论&quot;&gt;&lt;a href=&quot;#结论&quot; class=&quot;headerlink&quot; title=&quot;结论&quot;&gt;&lt;/a&gt;结论&lt;/h2&gt;&lt;p&gt;我们经历了 &lt;code&gt;async/await&lt;/code&gt; 的过程，并在 Golang 中实现了一个简单的版本。我鼓励您进一步研究 &lt;code&gt;async/await&lt;/code&gt;，看看它如何更好的让代码库便于易读。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;译自：&lt;a href=&quot;https://hackernoon.com/asyncawait-in-golang-an-introductory-guide-ol1e34sg&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://hackernoon.com/asyncawait-in-golang-an-introductory-guide-ol1e34sg&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;Golang 是一种并发编程语言。它具有强大的特性，如 &lt;code&gt;Goroutines&lt;/code&gt; 和 &lt;code&gt;Channels&lt;/code&gt;，可以很好地处理异步任务。另外，&lt;code&gt;goroutines&lt;/code&gt; 不是 OS 线程，这就是为什么您可以在不增加开销的情况下根据需要启动任意数量的 &lt;code&gt;goroutine&lt;/code&gt; 的原因，它的堆栈大小初始化时仅 &lt;strong&gt;2KB&lt;/strong&gt;。那么为什么要 &lt;code&gt;async/await&lt;/code&gt; 呢？ &lt;code&gt;Async/Await&lt;/code&gt; 是一种很好的语言特点，它为异步编程提供了更简单的接口。&lt;/p&gt;
&lt;p&gt;项目链接：&lt;a href=&quot;https://github.com/icyxp/AsyncGoDemo&quot;&gt;https://github.com/icyxp/AsyncGoDemo&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="async" scheme="http://team.jiunile.com/categories/golang/async/"/>
    
      <category term="await" scheme="http://team.jiunile.com/categories/golang/async/await/"/>
    
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="async" scheme="http://team.jiunile.com/tags/async/"/>
    
      <category term="await" scheme="http://team.jiunile.com/tags/await/"/>
    
      <category term="goroutine" scheme="http://team.jiunile.com/tags/goroutine/"/>
    
      <category term="channel" scheme="http://team.jiunile.com/tags/channel/"/>
    
  </entry>
  
  <entry>
    <title>从 Go 分析 Struct 对齐如何影响内存使用量</title>
    <link href="http://team.jiunile.com//blog/2020/11/go-struct.html"/>
    <id>http://team.jiunile.com//blog/2020/11/go-struct.html</id>
    <published>2020-11-30T14:00:00.000Z</published>
    <updated>2020-11-30T02:34:25.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;不知道大家在写 Go 时有没有注意过，&lt;strong&gt;一个 struct 所占的空间不见得等于各个 field 加起来的空间&lt;/strong&gt;，甚至有时把 field 申明的顺序调换一下，又会得到不同的结果。&lt;/p&gt;
&lt;p&gt;今天的文章就是要从 CPU 抓资料的原理开始介绍，然后再讲到 &lt;strong&gt;Data Structure Alignment&lt;/strong&gt;（数据结构对齐），希望大家在看完之后能对 CPU 跟记忆体有更多认识～&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;直接上例子&quot;&gt;&lt;a href=&quot;#直接上例子&quot; class=&quot;headerlink&quot; title=&quot;直接上例子&quot;&gt;&lt;/a&gt;直接上例子&lt;/h2&gt;&lt;p&gt;以 T1 为例，整个 &lt;code&gt;struct&lt;/code&gt; 共有三个栏位，类型分别是 &lt;code&gt;int8&lt;/code&gt;、&lt;code&gt;int64&lt;/code&gt; 跟 &lt;code&gt;int32&lt;/code&gt;，所以变数 &lt;code&gt;t1&lt;/code&gt; 应该需要 &lt;code&gt;1+8+4=13 bytes&lt;/code&gt; 的空间。但实际在 &lt;a href=&quot;https://goplay.tools/snippet/6kzzmHddQgc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Go Playground&lt;/a&gt; 上跑，会发现 &lt;code&gt;t1&lt;/code&gt; 竟然需要 &lt;code&gt;24 bytes&lt;/code&gt;，真奇怪是吧？&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; T1 &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    f1 &lt;span class=&quot;keyword&quot;&gt;int8&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;// 1 byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    f2 &lt;span class=&quot;keyword&quot;&gt;int64&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 8 bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    f3 &lt;span class=&quot;keyword&quot;&gt;int32&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 4 bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    t1 := T1&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fmt.Println(unsafe.Sizeof(t1)) &lt;span class=&quot;comment&quot;&gt;// 24 bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果尝试把栏位的顺序调整一下，改成 &lt;code&gt;int8&lt;/code&gt;、&lt;code&gt;int32&lt;/code&gt;、&lt;code&gt;int64&lt;/code&gt; 再跑一次，就只需要 16 bytes，但跟原本预期的 13 bytes 还是有差，那究竟为什么会这样的差异呢？&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; T2 &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    f1 &lt;span class=&quot;keyword&quot;&gt;int8&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;// 1 byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    f3 &lt;span class=&quot;keyword&quot;&gt;int32&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 4 bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    f2 &lt;span class=&quot;keyword&quot;&gt;int64&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 8 bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    t2 := T2&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fmt.Println(unsafe.Sizeof(t2)) &lt;span class=&quot;comment&quot;&gt;// 16 bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;从-CPU-如何抓资料开始讲起&quot;&gt;&lt;a href=&quot;#从-CPU-如何抓资料开始讲起&quot; class=&quot;headerlink&quot; title=&quot;从 CPU 如何抓资料开始讲起&quot;&gt;&lt;/a&gt;从 CPU 如何抓资料开始讲起&lt;/h2&gt;&lt;p&gt;如果买电脑时有在留意 CPU 规格的话（身为工程师一定要的吧XD），应该会发现近几年的 CPU 几乎都是 &lt;code&gt;64 bit&lt;/code&gt; 的。而这边的 &lt;code&gt;64 bit&lt;/code&gt;，指的就是 CPU 一次可以从记忆体里面抓 &lt;code&gt;64 bits&lt;/code&gt; 的资料，换算一下也就是 &lt;code&gt;8 bytes&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;虽说是一次抓 &lt;code&gt;8 bytes&lt;/code&gt;，但也不是想抓哪就抓哪，因为记忆体也会以 &lt;strong&gt;&lt;code&gt;8 bytes&lt;/code&gt; 分成一个一个 word&lt;/strong&gt;（如下图），而 CPU 只能一次拿某一个 word。所以如果所需的资料刚好横跨两个 word，那就得花两个 &lt;code&gt;CPU cycle&lt;/code&gt; 的时间去拿。&lt;br&gt;&lt;img src=&quot;/images/go/struct_1.png&quot; alt=&quot;struct&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;注：在 &lt;code&gt;64 bit&lt;/code&gt; 的系统中一个 word 是 &lt;code&gt;8 bytes&lt;/code&gt;，&lt;code&gt;32 bit&lt;/code&gt; 中则是 &lt;code&gt;4 bytes&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;所以为什么-struct-会变肥&quot;&gt;&lt;a href=&quot;#所以为什么-struct-会变肥&quot; class=&quot;headerlink&quot; title=&quot;所以为什么 struct 会变肥&quot;&gt;&lt;/a&gt;所以为什么 struct 会变肥&lt;/h2&gt;&lt;p&gt;了解 CPU 后我们再看一次 T1，他的栏位顺序是 &lt;code&gt;int8&lt;/code&gt;、&lt;code&gt;int64&lt;/code&gt;、&lt;code&gt;int32&lt;/code&gt;，所以把 t1 的资料连续放在记忆体里面就长得像下图：因为第二个栏位 f2(&lt;code&gt;int64&lt;/code&gt;) 需要 8 个 bytes，所以&lt;strong&gt;会有一个 byte 会被挤到第二个 word&lt;/strong&gt;（第二排）&lt;br&gt;&lt;img src=&quot;/images/go/struct_2.png&quot; alt=&quot;struct&quot;&gt;&lt;/p&gt;
&lt;p&gt;那这样有什么坏处呢？如果我的程式需要用到 &lt;code&gt;t1.f2&lt;/code&gt;，譬如说把他 print 出来，那 CPU 就得花两个 cycle 的时间把 f2 从记忆体抓出来，&lt;strong&gt;因为 f2 分散在两个 word 里面&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;所以为了让 CPU 可以更快存取到各个栏位，Go 编译器会帮你的 struct 做 &lt;code&gt;Data Structure Align&lt;/code&gt;，也就是在 T1 的栏位间加上一些 padding，&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; T1 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    f1 i8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _ [&lt;span class=&quot;number&quot;&gt;7&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 7 bytes padding&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    f2 i64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    f3 i32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _ [&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 4 bytes padding&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;画成图就长下面这样，有 13 bytes 用来储存 struct 的资料，而深色的 11 个 bytes 则是用来当 padding，&lt;strong&gt;确保每个 field 的所有内容都落在同一个 word 里面&lt;/strong&gt;，所以 struct 才会从 13 bytes 肥到 24 bytes&lt;br&gt;&lt;img src=&quot;/images/go/struct_3.png&quot; alt=&quot;struct&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Padding-可以不要那么肥吗？&quot;&gt;&lt;a href=&quot;#Padding-可以不要那么肥吗？&quot; class=&quot;headerlink&quot; title=&quot;Padding 可以不要那么肥吗？&quot;&gt;&lt;/a&gt;Padding 可以不要那么肥吗？&lt;/h2&gt;&lt;p&gt;虽说 padding 是为了把每个 field 放到更好的位置，但 padding 的空间实际上就是浪费掉了。以 T1 来说，24 bytes 里面就浪费了将近一半，那有什么方法可以兼顾 Alignment 但又不浪费太多空间吗？&lt;/p&gt;
&lt;p&gt;再看一次 T1 的记忆体分佈，就会发现最下面 4 bytes 的 f3 其实可以挪到上面的 padding，反正第一排的 padding 空间超大的，不用白不用，&lt;strong&gt;而且挪上去之后每个栏位都还是在同一个 word 里面&lt;/strong&gt;。&lt;br&gt;&lt;img src=&quot;/images/go/struct_4.png&quot; alt=&quot;struct&quot;&gt;&lt;/p&gt;
&lt;p&gt;一旦把 f3 移上去，就可以省掉最下面一整个 word(8 bytes) 的空间，所以 T2 整个 struct 就只需要 16 bytes，是原本 T1 24 bytes 的三分之二&lt;br&gt;&lt;img src=&quot;/images/go/struct_5.png&quot; alt=&quot;struct&quot;&gt;&lt;/p&gt;
&lt;p&gt;写成程式码的话，因为 Go 会按照栏位的顺序来安排记忆体中的位置，所以要把 f2 跟 f3 的顺序交换，宣告的顺序变成 &lt;code&gt;int8&lt;/code&gt;、&lt;code&gt;int32&lt;/code&gt;、&lt;code&gt;int64&lt;/code&gt;，这样才会顺利排成上面那个图哦～&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; T2 &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    f1 &lt;span class=&quot;keyword&quot;&gt;int8&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;// 1 byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    f3 &lt;span class=&quot;keyword&quot;&gt;int32&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 4 bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    f2 &lt;span class=&quot;keyword&quot;&gt;int64&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 8 bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    t2 := T2&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fmt.Println(unsafe.Sizeof(t2)) &lt;span class=&quot;comment&quot;&gt;// 16 bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;编译器没办法自动最佳化吗？&quot;&gt;&lt;a href=&quot;#编译器没办法自动最佳化吗？&quot; class=&quot;headerlink&quot; title=&quot;编译器没办法自动最佳化吗？&quot;&gt;&lt;/a&gt;编译器没办法自动最佳化吗？&lt;/h2&gt;&lt;p&gt;看到这你一定觉得很麻烦，难不成每次用 Struct 都要自己拼拼凑凑、算算看怎么样的顺序最省空间？这种底层的鸟事应该&lt;a href=&quot;https://medium.com/starbugs/see-what-compiler-optimization-do-from-llvm-ir-dfd3774292cb&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;由编译器来最佳化&lt;/a&gt;才对啊！&lt;/p&gt;
&lt;p&gt;遗憾的是，目前 Go 编译器不会自动做这些最佳化（但 &lt;a href=&quot;https://camlorn.net/posts/April%202017/rust-struct-field-reordering/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Rust 三年前就支援了&lt;/a&gt;，希望 Go 也能赶快跟进XD），所以如果很在意 struct 有没有充分利用记忆体空间，可以自己画图排排看，或是用 &lt;a href=&quot;https://github.com/orijtech/structslop&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;structslop&lt;/a&gt; 进行分析。&lt;/p&gt;
&lt;h3 id=&quot;structslop&quot;&gt;&lt;a href=&quot;#structslop&quot; class=&quot;headerlink&quot; title=&quot;structslop&quot;&gt;&lt;/a&gt;structslop&lt;/h3&gt;&lt;p&gt;&lt;code&gt;structslop&lt;/code&gt; 是一个用 Go 写成的开源工具，他的功能就是帮你调整 struct 的栏位顺序，&lt;strong&gt;以达到最好的空间利用率&lt;/strong&gt;。像下面的例子 Student 里面包含了学号、姓名、班级、成绩等等资讯。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; Student &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    id       &lt;span class=&quot;keyword&quot;&gt;int8&lt;/span&gt;     &lt;span class=&quot;comment&quot;&gt;// 1 byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    name     &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;   &lt;span class=&quot;comment&quot;&gt;// 16 bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    classID  &lt;span class=&quot;keyword&quot;&gt;int8&lt;/span&gt;     &lt;span class=&quot;comment&quot;&gt;// 1 byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    phone    [&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 10 bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    address  &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;   &lt;span class=&quot;comment&quot;&gt;// 16 bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    grade    &lt;span class=&quot;keyword&quot;&gt;int32&lt;/span&gt;    &lt;span class=&quot;comment&quot;&gt;// 4 bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果画成图就长这样，可以看到里面还有很多深色的 padding，算一算总共浪费了 16 bytes，感觉不是那么优。&lt;br&gt;&lt;img src=&quot;/images/go/struct_6.png&quot; alt=&quot;struct&quot;&gt;&lt;/p&gt;
&lt;p&gt;这时就可以用 &lt;code&gt;structslop&lt;/code&gt; 帮你分析并且算出一个最佳解，只要把栏位顺序改成他建议的，Student 占用的空间就可以从 64 bytes 最佳化到 48 bytes，共&lt;strong&gt;省下 25% 的空间&lt;/strong&gt;。&lt;br&gt;&lt;img src=&quot;/images/go/struct_7.png&quot; alt=&quot;struct&quot;&gt;&lt;/p&gt;
&lt;p&gt;如果把 &lt;code&gt;structslop&lt;/code&gt; 推荐的 field 顺序画成图就长这样，全部排得满满的，没有任何一点 padding，看了心情都好了起来XD&lt;br&gt;&lt;img src=&quot;/images/go/struct_8.png&quot; alt=&quot;struct&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;有必要省空间省成这样吗&quot;&gt;&lt;a href=&quot;#有必要省空间省成这样吗&quot; class=&quot;headerlink&quot; title=&quot;有必要省空间省成这样吗&quot;&gt;&lt;/a&gt;有必要省空间省成这样吗&lt;/h2&gt;&lt;p&gt;讲完怎么省空间后，接著我们来想想，虽然重新排列栏位可以让 struct 更省空间，但真的有必要这样吗？&lt;/p&gt;
&lt;p&gt;以 Student 的例子来说，经过重新排列后，一个 struct 可以省下 16 bytes。&lt;/p&gt;
&lt;p&gt;如果你要写个程式来排序全校同学的成绩，需要宣告长度十万的 &lt;code&gt;Student array&lt;/code&gt;，那省下的记忆体也不过 16 MB，跟现在个人电脑配备的 4GB 到 8GB 比起来根本是零头。&lt;/p&gt;
&lt;p&gt;而且笔者我觉得栏位在经过重新排序之后，可读性可能会稍微降低，像 Student 原本的栏位依序是学号、姓名、班级…，满符合直觉的。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; Student &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    id       &lt;span class=&quot;keyword&quot;&gt;int8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    name     &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    classID  &lt;span class=&quot;keyword&quot;&gt;int8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    phone    [&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    address  &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    grade    &lt;span class=&quot;keyword&quot;&gt;int32&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但重新排序后顺序就变成姓名、地址、成绩…一直到最后才是学号跟班级，总觉得越重要的栏位应该要放在越前面才是（我自己觉得啦XD）。&lt;/p&gt;
&lt;p&gt;所以我的观点是不需要太早进行最佳化，除非你一开始就知道你的程式瓶颈会卡在这（也许程式要跑在嵌入式装置），否则就照平常的方式写 Go 就好，也不用去算这些有的没的，也许 Go 在哪一次更新之后就像 Rust 默默支援 &lt;code&gt;struct field reordering&lt;/code&gt; 了&lt;/p&gt;
&lt;h2 id=&quot;总结&quot;&gt;&lt;a href=&quot;#总结&quot; class=&quot;headerlink&quot; title=&quot;总结&quot;&gt;&lt;/a&gt;总结&lt;/h2&gt;&lt;p&gt;最后，我想跟大家分享一个忘记在哪看到的句子：&lt;strong&gt;「Understanding the Hardware Makes You a Better Developer」&lt;/strong&gt;，这边的 &lt;strong&gt;Hardware&lt;/strong&gt; 我认为不一定是指硬体，而是泛指你所依赖的底层工具。&lt;/p&gt;
&lt;p&gt;譬如说我完全不懂浏览器的 Reflow 跟 Repaint 还是可以写前端，但要做动画可能就会遇到效能瓶颈；不懂 Go 的 GC 机制还是可以把 Go 写得不错，但流量大起来时可能就会花太多时间在 GC。&lt;/p&gt;
&lt;p&gt;所以虽然这篇文的结论是不需要特别去注意 &lt;code&gt;Data Structure Alignment&lt;/code&gt; ，只要知道程式内部是这样运作的，并且顺其自然即可，但如果有一天真的因为这样记忆体不够了，那记得要想到调整一下栏位顺序哦～。&lt;/p&gt;
&lt;h2 id=&quot;延伸阅读&quot;&gt;&lt;a href=&quot;#延伸阅读&quot; class=&quot;headerlink&quot; title=&quot;延伸阅读&quot;&gt;&lt;/a&gt;延伸阅读&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://stackoverflow.com/questions/6730664/why-doesnt-c-make-the-structure-tighter&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Why doesn’t C++ make the structure tighter? — Stack Overflow&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://camlorn.net/posts/April%202017/rust-struct-field-reordering/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Optimizing Rust Struct Size: A 6-month Compiler Development Project&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://techterms.com/help/difference_between_32-bit_and_64-bit_systems&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;What is the difference between a 32-bit and 64-bit system?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;来源：&lt;a href=&quot;https://medium.com/starbugs/illustrate-how-data-alignment-affects-memory-usage-d29bf9d5bf08&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://medium.com/starbugs/illustrate-how-data-alignment-affects-memory-usage-d29bf9d5bf08&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;不知道大家在写 Go 时有没有注意过，&lt;strong&gt;一个 struct 所占的空间不见得等于各个 field 加起来的空间&lt;/strong&gt;，甚至有时把 field 申明的顺序调换一下，又会得到不同的结果。&lt;/p&gt;
&lt;p&gt;今天的文章就是要从 CPU 抓资料的原理开始介绍，然后再讲到 &lt;strong&gt;Data Structure Alignment&lt;/strong&gt;（数据结构对齐），希望大家在看完之后能对 CPU 跟记忆体有更多认识～&lt;br&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="struct" scheme="http://team.jiunile.com/categories/golang/struct/"/>
    
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="golang" scheme="http://team.jiunile.com/tags/golang/"/>
    
      <category term="struct" scheme="http://team.jiunile.com/tags/struct/"/>
    
  </entry>
  
  <entry>
    <title>Golang 切片综合指南</title>
    <link href="http://team.jiunile.com//blog/2020/11/go-slices.html"/>
    <id>http://team.jiunile.com//blog/2020/11/go-slices.html</id>
    <published>2020-11-26T14:00:00.000Z</published>
    <updated>2020-11-27T07:10:03.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;在本文中，我们将讨论 “切片” 的概念，它是 Golang 中使用的一种重要数据结构。这一数据结构为你提供了处理与管理数据集合的方法。切片是围绕动态数组的概念构建的，它与动态数组相似，可以根据你的需要而伸缩。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;切片在增长方面是动态的，因为它们有自己的内置函数 &lt;code&gt;append&lt;/code&gt;，可以快速高效地增长切片。&lt;/li&gt;
&lt;li&gt;您还可以通过切割底层内存来减小切片的大小。&lt;/li&gt;
&lt;li&gt;在底层内存中切片是在连续的块上分配的，因此切片为你提供的便利之处包括：索引、迭代与垃圾回收优化。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;切片表示&quot;&gt;&lt;a href=&quot;#切片表示&quot; class=&quot;headerlink&quot; title=&quot;切片表示&quot;&gt;&lt;/a&gt;切片表示&lt;/h2&gt;&lt;/li&gt;
&lt;li&gt;切片不存储任何数据；它只描述底层数组的一部分。&lt;/li&gt;
&lt;li&gt;切片使用一个包含三个字段的结构表示：指向底层数组的指针（pointer）、长度（length）与容量（capacity）。&lt;/li&gt;
&lt;li&gt;这个数据结构类似于切片的描述符。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/images/go/slice_1.png&quot; alt=&quot;Slice representation&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Pointer&lt;/strong&gt;：指针用于指向数组的第一个元素，这个元素可以通过切片进行访问。在这里，指向的元素不必是数组的第一个元素。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Length&lt;/strong&gt;：长度代表数组中所有元素的总数。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Capacity&lt;/strong&gt;：容量表示切片可扩展的最大大小。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;使用长度申明切片&quot;&gt;&lt;a href=&quot;#使用长度申明切片&quot; class=&quot;headerlink&quot; title=&quot;使用长度申明切片&quot;&gt;&lt;/a&gt;使用长度申明切片&lt;/h2&gt;&lt;p&gt;在声明切片过程中，当你仅指定长度（Length）时，容量（Capacity）值与长度（Length）值相同。&lt;br&gt;&lt;img src=&quot;/images/go/slice_2.png&quot; alt=&quot;Declare a slice using the length&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Declaring a slice by length. Create a slice of int. &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Contains a length and capacity of 5 elements. &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(slice)) &lt;span class=&quot;comment&quot;&gt;// Print 5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(slice)) &lt;span class=&quot;comment&quot;&gt;// Print 5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;使用长度和容量申明切片&quot;&gt;&lt;a href=&quot;#使用长度和容量申明切片&quot; class=&quot;headerlink&quot; title=&quot;使用长度和容量申明切片&quot;&gt;&lt;/a&gt;使用长度和容量申明切片&lt;/h2&gt;&lt;p&gt;在声明切片过程中，当你分别指定长度（Length）和容量（Capacity）时，这将初始化一段无法访问的底层数组来创建一个具有可用容量的切片。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/* &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Declaring a slice by length and capacity&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Create a slice of integers. &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Contains a length of 3 and has a capacity of 5 elements.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(slice)) &lt;span class=&quot;comment&quot;&gt;// Print 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(slice)) &lt;span class=&quot;comment&quot;&gt;// Print 5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/go/slice_3.png&quot; alt=&quot;Declare a slice with length and capacity&quot;&gt;&lt;/p&gt;
&lt;p&gt;但是请注意，尝试创建容量小于长度的切片是不允许的。&lt;/p&gt;
&lt;h2 id=&quot;使用切片字面量创建切片&quot;&gt;&lt;a href=&quot;#使用切片字面量创建切片&quot; class=&quot;headerlink&quot; title=&quot;使用切片字面量创建切片&quot;&gt;&lt;/a&gt;使用切片字面量创建切片&lt;/h2&gt;&lt;p&gt;创建切片的惯用方法是使用切片字面量。它与创建数组相似，只是它不需要在 [ ] 操作符中指定值。你初始化切片时所用元素的数量将决定切片的初始长度与容量。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create a slice of strings. &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Contains a length and capacity of 5 elements. &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := []&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;&amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;Red&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;Blue&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;Green&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;Yellow&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;Pink&quot;&lt;/span&gt;&amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(slice)) &lt;span class=&quot;comment&quot;&gt;//Print 5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(slice)) &lt;span class=&quot;comment&quot;&gt;//Print 5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create a slice of integers. &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Contains a length and capacity of 3 elements. &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;intSlice:= []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(intSlice)) &lt;span class=&quot;comment&quot;&gt;//Print 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(intSlice)) &lt;span class=&quot;comment&quot;&gt;//Print 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;声明一个带有索引位置的切片&quot;&gt;&lt;a href=&quot;#声明一个带有索引位置的切片&quot; class=&quot;headerlink&quot; title=&quot;声明一个带有索引位置的切片&quot;&gt;&lt;/a&gt;声明一个带有索引位置的切片&lt;/h2&gt;&lt;p&gt;当使用切片字面量时，你可以初始化切片的长度与容量。你所需要做的就是初始化表示所需长度和容量的索引。下面的语法将创建一个长度和容量均为 100 的切片。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create a slice of strings.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Initialize the 100th element with an empty string.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;99&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;88&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(slice)) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Print 100&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(slice)) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Print 100&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/go/slice_4.png&quot; alt=&quot;Declare a slice with index positions&quot;&gt;&lt;/p&gt;
&lt;p&gt;声明数组与切片的区别：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果你使用[]操作符中指定一个值，那么你在创建一个数组。&lt;/li&gt;
&lt;li&gt;如果你不在[]中指定值，则创建一个切片。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create an array of three integers. &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;array := [&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;&amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Create a slice of integers with a length and capacity of three.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;声明一个-nil-切片&quot;&gt;&lt;a href=&quot;#声明一个-nil-切片&quot; class=&quot;headerlink&quot; title=&quot;声明一个 nil 切片&quot;&gt;&lt;/a&gt;声明一个 nil 切片&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;切片用 &lt;code&gt;nil&lt;/code&gt; 代表零值。&lt;/li&gt;
&lt;li&gt;一个 nil 切片的长度和容量等于 0，且没有底层数组。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create a nil slice of integers. &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; slice []&lt;span class=&quot;keyword&quot;&gt;int32&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(slice == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//This line will print true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(slice))   &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// This line will print 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(slice))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// This line will print 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;/images/go/slice_5.png&quot; alt=&quot;Declare a nil slice&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;声明一个空切片&quot;&gt;&lt;a href=&quot;#声明一个空切片&quot; class=&quot;headerlink&quot; title=&quot;声明一个空切片&quot;&gt;&lt;/a&gt;声明一个空切片&lt;/h2&gt;&lt;p&gt;还可以通过初始化声明切片创建一个空切片。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Use make to create an empty slice of integers.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sliceOne := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Use a slice literal to create an empty slice of integers.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sliceTwo := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(sliceOne == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;) &lt;span class=&quot;comment&quot;&gt;// This will print false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(sliceOne))   &lt;span class=&quot;comment&quot;&gt;// This will print 0 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(sliceOne))   &lt;span class=&quot;comment&quot;&gt;// This will print 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(sliceTwo == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;) &lt;span class=&quot;comment&quot;&gt;// This will print false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(sliceTwo))   &lt;span class=&quot;comment&quot;&gt;// This will print 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(sliceTwo))   &lt;span class=&quot;comment&quot;&gt;// This will print 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/go/slice_6.png&quot; alt=&quot;Declare an empty slice&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;为任何特定索引赋值&quot;&gt;&lt;a href=&quot;#为任何特定索引赋值&quot; class=&quot;headerlink&quot; title=&quot;为任何特定索引赋值&quot;&gt;&lt;/a&gt;为任何特定索引赋值&lt;/h2&gt;&lt;p&gt;要修改单个元素的值，请使用[]操作符。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create a slice of integers.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Contains a length and capacity of 4 elements.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;40&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(slice) &lt;span class=&quot;comment&quot;&gt;//This will print [10 20 30 40]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] = &lt;span class=&quot;number&quot;&gt;25&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// Change the value of index 1.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(slice) &lt;span class=&quot;comment&quot;&gt;// This will print [10 25 30 40]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/go/slice_7.png&quot; alt=&quot;Assign a value to any specific index&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;对切片进行切片&quot;&gt;&lt;a href=&quot;#对切片进行切片&quot; class=&quot;headerlink&quot; title=&quot;对切片进行切片&quot;&gt;&lt;/a&gt;对切片进行切片&lt;/h2&gt;&lt;p&gt;我们之所以称呼切片为切片，是因为你可以通过对底层数组的一部分进行切片来创建一个新的切片。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/* Create a slice of integers. Contains a &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;length and capacity of 5 elements.*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;40&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;50&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(slice)  &lt;span class=&quot;comment&quot;&gt;// Print [10 20 30 40 50]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(slice)) &lt;span class=&quot;comment&quot;&gt;// Print  5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(slice)) &lt;span class=&quot;comment&quot;&gt;// Print  5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/* Create a new slice.Contains a length &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;of 2 and capacity of 4 elements.*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;newSlice := slice[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(slice)  &lt;span class=&quot;comment&quot;&gt;//Print [10 20 30 40 50]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(newSlice))  &lt;span class=&quot;comment&quot;&gt;//Print 2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(newSlice))  &lt;span class=&quot;comment&quot;&gt;//Print 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/go/slice_9.png&quot; alt=&quot;Take a slice of a slice&quot;&gt;&lt;/p&gt;
&lt;p&gt;在执行切片操作之后，我们拥有两个共享同一底层数组的切片。然而，这两个切片以不同的方式查看底层数组。原始切片认为底层数组的容量为 5，但 newSlice 与之不同，对 newSlice 而言，底层数组的容量为 4。newSlice 无法访问位于其指针之前的底层数组元素。就 newSlice 而言，这些元素甚至并不存在。使用下面的方式可以为任意切片后的 newSlice 计算长度和容量。&lt;/p&gt;
&lt;h3 id=&quot;切片的长度与容量如何计算？&quot;&gt;&lt;a href=&quot;#切片的长度与容量如何计算？&quot; class=&quot;headerlink&quot; title=&quot;切片的长度与容量如何计算？&quot;&gt;&lt;/a&gt;切片的长度与容量如何计算？&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;切片 slice[i:j] 的底层数组容量为 k 长度（Length）：j - i 容量（Capacity）：k - i&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;计算新的长度和容量&quot;&gt;&lt;a href=&quot;#计算新的长度和容量&quot; class=&quot;headerlink&quot; title=&quot;计算新的长度和容量&quot;&gt;&lt;/a&gt;计算新的长度和容量&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;切片 slice[1:3] 的底层数组容量为 5 长度（Length）：3 - 1 = 2 容量（Capacity）：5 - 1 = 4&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;对一个切片进行更改的结果&quot;&gt;&lt;a href=&quot;#对一个切片进行更改的结果&quot; class=&quot;headerlink&quot; title=&quot;对一个切片进行更改的结果&quot;&gt;&lt;/a&gt;对一个切片进行更改的结果&lt;/h3&gt;&lt;p&gt;一个切片对底层数组的共享部分所做的更改可以被另一个切片看到。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create a slice of integers.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Contains a length and capacity of 5 elements.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;40&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;50&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create a new slice.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Contains a length of 2 and capacity of 4 elements.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;newSlice := slice[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Change index 1 of newSlice.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Change index 2 of the original slice.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;newSlice[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] = &lt;span class=&quot;number&quot;&gt;35&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;将数值 35 分配给 newSlice 的第二个元素后，该更改也可以在原始切片的元素中被看到。&lt;/p&gt;
&lt;h2 id=&quot;运行时错误显示索引超出范围&quot;&gt;&lt;a href=&quot;#运行时错误显示索引超出范围&quot; class=&quot;headerlink&quot; title=&quot;运行时错误显示索引超出范围&quot;&gt;&lt;/a&gt;运行时错误显示索引超出范围&lt;/h2&gt;&lt;p&gt;一个切片只能访问它长度以内的索引位。尝试访问超出长度的索引位元素将引发一个运行时错误。与切片容量相关联的元素只能用于切片增长。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create a slice of integers.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Contains a length and capacity of 5 elements.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;40&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;50&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create a new slice.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Contains a length of 2 and capacity of 4 elements.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;newSlice := slice[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Change index 3 of newSlice.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// This element does not exist for newSlice.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;newSlice[&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;] = &lt;span class=&quot;number&quot;&gt;45&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/*&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Runtime Exception:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;panic: runtime error: index out of range&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;切片增长&quot;&gt;&lt;a href=&quot;#切片增长&quot; class=&quot;headerlink&quot; title=&quot;切片增长&quot;&gt;&lt;/a&gt;切片增长&lt;/h2&gt;&lt;p&gt;与使用数组相比，使用切片的优势之一是：你可以根据需要增加切片的容量。当你使用内置函数 「append」 时，Golang 会负责处理所有操作细节。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用 append 前，你需要一个源切片和一个要追加的值。&lt;/li&gt;
&lt;li&gt;当你的 append 调用并返回时，它将为你提供一个更改后的新切片。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;append&lt;/strong&gt; 函数总会增加新切片的长度。&lt;/li&gt;
&lt;li&gt;另一方面，容量可能会受到影响，也可能不会受到影响，这取决于源切片的可用容量。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;使用-append-向切片追加元素&quot;&gt;&lt;a href=&quot;#使用-append-向切片追加元素&quot; class=&quot;headerlink&quot; title=&quot;使用 append 向切片追加元素&quot;&gt;&lt;/a&gt;使用 append 向切片追加元素&lt;/h2&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/*  Create a slice of integers.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Contains a length and capacity of 5 elements.*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;40&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;50&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/* Create a new slice.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Contains a length of 2 and capacity of 4 elements.*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;newSlice := slice[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(newSlice)) &lt;span class=&quot;comment&quot;&gt;// Print 2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(newSlice)) &lt;span class=&quot;comment&quot;&gt;// Print 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/* Allocate a new element from capacity.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Assign the value of 60 to the new element.*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;newSlice = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(newSlice, &lt;span class=&quot;number&quot;&gt;60&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(newSlice)) &lt;span class=&quot;comment&quot;&gt;// Print 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(newSlice)) &lt;span class=&quot;comment&quot;&gt;// Print 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;当切片的底层数组没有可用容量时，append 函数将创建一个新的底层数组，拷贝正在引用的现有值，然后再分配新值。&lt;/p&gt;
&lt;h2 id=&quot;使用-append-增加切片的长度和容量&quot;&gt;&lt;a href=&quot;#使用-append-增加切片的长度和容量&quot; class=&quot;headerlink&quot; title=&quot;使用 append 增加切片的长度和容量&quot;&gt;&lt;/a&gt;使用 append 增加切片的长度和容量&lt;/h2&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create a slice of integers.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Contains a length and capacity of 4 elements.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;40&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(slice)) &lt;span class=&quot;comment&quot;&gt;// Print 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(slice)) &lt;span class=&quot;comment&quot;&gt;// Print 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Append a new value to the slice.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Assign the value of 50 to the new element.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;newSlice= &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(slice, &lt;span class=&quot;number&quot;&gt;50&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(newSlice)) &lt;span class=&quot;comment&quot;&gt;//Print 5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;(newSlice)) &lt;span class=&quot;comment&quot;&gt;//Print 8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;/images/go/slice_9.png&quot; alt=&quot;Increase the length and capacity of a slice&quot;&gt;&lt;/p&gt;
&lt;p&gt;在 append 操作后，newSlice 被给予一个自有的底层数组，该底层数组的容量是原底层数组容量的两倍。在增加底层数组容量时，append 操作十分聪明。举个例子，当切片的容量低于 1,000 个元素时，容量增长总是翻倍的。一旦元素的数量超过 1,000 个，容量就会增长 1.25 倍，即 25%。随着时间的推移，这种增长算法可能会在 Golang 中发生变化。&lt;/p&gt;
&lt;p&gt;更改新切片不会对旧切片产生任何影响，因为新切片现在有一个不同的底层数组，它的指针指向一个新分配的数组。&lt;/p&gt;
&lt;h2 id=&quot;将一个切片追加到另一个切片中&quot;&gt;&lt;a href=&quot;#将一个切片追加到另一个切片中&quot; class=&quot;headerlink&quot; title=&quot;将一个切片追加到另一个切片中&quot;&gt;&lt;/a&gt;将一个切片追加到另一个切片中&lt;/h2&gt;&lt;p&gt;内置函数 &lt;strong&gt;append&lt;/strong&gt; 还是一个&lt;strong&gt;可变参数&lt;/strong&gt;函数。这意味着你可以传递多个值来追加到单个切片中。如果你使用 … 运算符，可以将一个切片的所有元素追加到另一个切片中。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create two slices each initialized with two integers.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice1:= []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice2 := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Append the two slices together and display the results.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(slice1, slice2...))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Output: [1 2 3 4]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;对切片执行索引&quot;&gt;&lt;a href=&quot;#对切片执行索引&quot; class=&quot;headerlink&quot; title=&quot;对切片执行索引&quot;&gt;&lt;/a&gt;对切片执行索引&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;通过指定一个下限和一个上限来形成切片，例如：&lt;code&gt;a[low:high]&lt;/code&gt;。这将选择一个半开范围，其中包含切片的第一个元素，但不包含切片的最后一个元素。&lt;/li&gt;
&lt;li&gt;你可以省略上限或下限，这将使用它们的默认值。下限的默认值是 0，上限的默认值是切片的长度。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;a := [...]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// an array&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;s := a[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;]               &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// s == []int&amp;#123;1, 2&amp;#125;        &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// cap(s) == 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;s = a[:&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;]                 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// s == []int&amp;#123;0, 1&amp;#125;        &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// cap(s) == 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;s = a[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;:]                 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// s == []int&amp;#123;2, 3&amp;#125;        &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// cap(s) == 2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;s = a[:]                  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// s == []int&amp;#123;0, 1, 2, 3&amp;#125;  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// cap(s) == 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;遍历切片&quot;&gt;&lt;a href=&quot;#遍历切片&quot; class=&quot;headerlink&quot; title=&quot;遍历切片&quot;&gt;&lt;/a&gt;遍历切片&lt;/h2&gt;&lt;p&gt;Go 有一个特殊的关键字 &lt;code&gt;range&lt;/code&gt;，你可以使用该关键字对切片进行遍历。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create a slice of integers.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Contains a length and capacity of 4 elements.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;40&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Iterate over each element and display each value.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; index, value := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; slice &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   fmt.Printf(&lt;span class=&quot;string&quot;&gt;&quot;Index: %d Value: %d\n&quot;&lt;/span&gt;, index, value)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/*&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Output:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Index: 0 Value: 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Index: 1 Value: 20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Index: 2 Value: 30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Index: 3 Value: 40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在遍历切片时，关键字 range 将返回两个值。&lt;/li&gt;
&lt;li&gt;第一个值是索引下标，第二个值是索引位中值的副本。&lt;/li&gt;
&lt;li&gt;一定要知道 range 是在复制值，而不是返回值的引用。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/*&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Create a slice of integers.Contains &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; a length and capacity of 4 elements.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;40&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/*&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Iterate over each element and display &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; the value and addresses.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; index, value := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; slice &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   fmt.Printf(&lt;span class=&quot;string&quot;&gt;&quot;Value: %d Value-Addr: %X ElemAddr: %X\n&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   value, &amp;amp;value, &amp;amp;slice[index])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/*&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Output:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Value: 10 Value-Addr: 10500168 ElemAddr: 1052E100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Value: 20 Value-Addr: 10500168 ElemAddr: 1052E104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Value: 30 Value-Addr: 10500168 ElemAddr: 1052E108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Value: 40 Value-Addr: 10500168 ElemAddr: 1052E10C&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;range&lt;/strong&gt; 关键字提供元素的拷贝。&lt;/p&gt;
&lt;p&gt;如果你不需要下标值，你可以使用下划线字符丢弃该值。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create a slice of integers.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Contains a length and capacity of 4 elements.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;40&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Iterate over each element and display each value.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; _, value := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; slice &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   fmt.Printf(&lt;span class=&quot;string&quot;&gt;&quot;Value: %d\n&quot;&lt;/span&gt;, value)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/*&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Output:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Value: 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Value: 20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Value: 30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Value: 40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;关键字 &lt;strong&gt;range&lt;/strong&gt; 总是从开始处遍历一个切片。如果你需要对切片的迭代进行更多的控制，你可以使用传统的 &lt;strong&gt;for&lt;/strong&gt; 循环。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Create a slice of integers.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Contains a length and capacity of 4 elements.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;slice := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;40&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Iterate over each element starting at element 3.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; index := &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;; index &amp;lt; &lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(slice); index++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   fmt.Printf(&lt;span class=&quot;string&quot;&gt;&quot;Index: %d Value: %d\n&quot;&lt;/span&gt;, index, slice[index])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/* &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Output:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Index: 2 Value: 30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Index: 3 Value: 40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;##总结&lt;br&gt;在本文中，我们深入探讨了切片的概念。我们了解到，切片并不存储任何数据，而是描述了底层数组的一部分。我们还看到，切片可以在底层数组的范围内增长和收缩，并配合索引可作为数组使用；切片的零值是 nil；函数 &lt;strong&gt;len&lt;/strong&gt;、&lt;strong&gt;cap&lt;/strong&gt; 和 &lt;strong&gt;append&lt;/strong&gt; 都将 nil 看作一个长度和容量都为 0 的&lt;strong&gt;空切片&lt;/strong&gt;；你可以通过&lt;strong&gt;切片字面量&lt;/strong&gt;或调用 &lt;strong&gt;make&lt;/strong&gt; 函数（将长度和容量作为参数）来创建切片。希望这些对你有所帮助！&lt;/p&gt;
&lt;h2 id=&quot;免责声明&quot;&gt;&lt;a href=&quot;#免责声明&quot; class=&quot;headerlink&quot; title=&quot;免责声明&quot;&gt;&lt;/a&gt;免责声明&lt;/h2&gt;&lt;p&gt;我参考了各种博客、书籍和媒体故事来撰写这篇文章。如有任何疑问，请在评论中与我联系。&lt;/p&gt;
&lt;p&gt;到此为止……开心编码……快乐学习😃&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;译自：掘金翻译计划 原文：&lt;a href=&quot;https://codeburst.io/a-comprehensive-guide-to-slices-in-golang-bacebfe46669&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://codeburst.io/a-comprehensive-guide-to-slices-in-golang-bacebfe46669&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;在本文中，我们将讨论 “切片” 的概念，它是 Golang 中使用的一种重要数据结构。这一数据结构为你提供了处理与管理数据集合的方法。切片是围绕动态数组的概念构建的，它与动态数组相似，可以根据你的需要而伸缩。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;切片在增长方面是动态的，因为它们有自己的内置函数 &lt;code&gt;append&lt;/code&gt;，可以快速高效地增长切片。&lt;/li&gt;
&lt;li&gt;您还可以通过切割底层内存来减小切片的大小。&lt;/li&gt;
&lt;li&gt;在底层内存中切片是在连续的块上分配的，因此切片为你提供的便利之处包括：索引、迭代与垃圾回收优化。
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="slice" scheme="http://team.jiunile.com/categories/golang/slice/"/>
    
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="slice" scheme="http://team.jiunile.com/tags/slice/"/>
    
  </entry>
  
  <entry>
    <title>Cilium：基于 BPF/XDP 实现 K8s Service 负载均衡</title>
    <link href="http://team.jiunile.com//blog/2020/11/k8s-cilium-service.html"/>
    <id>http://team.jiunile.com//blog/2020/11/k8s-cilium-service.html</id>
    <published>2020-11-25T14:00:00.000Z</published>
    <updated>2020-11-25T06:00:19.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;文章介绍了 K8s 的一些核心网络模型和设计、&lt;code&gt;Cilium&lt;/code&gt; 对 &lt;code&gt;K8s Service&lt;/code&gt; 的实现、&lt;code&gt;BPF/XDP&lt;/code&gt; 性能优化，以及他们从中得到的一些实践经验，全是干货。&lt;/p&gt;
&lt;p&gt;去年我们也参加了这个大会（LPC），并做了题为 &lt;a href=&quot;https://linuxplumbersconf.org/event/4/contributions/458/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Making the Kubernetes Service Abstraction Scale using eBPF&lt;/a&gt; 的分享。 今天的内容是去年内容的延续，具体分为三个部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Kubernetes 网络模型&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Cilium&lt;/code&gt; 对 &lt;code&gt;K8s Service&lt;/code&gt; 负载均衡的实现，以及我们的一些实践经验&lt;/li&gt;
&lt;li&gt;一些新的 &lt;code&gt;BPF&lt;/code&gt; 内核扩展&lt;/li&gt;
&lt;/ul&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;1-K8s-网络基础：访问集群内服务的几种方式&quot;&gt;&lt;a href=&quot;#1-K8s-网络基础：访问集群内服务的几种方式&quot; class=&quot;headerlink&quot; title=&quot;1 K8s 网络基础：访问集群内服务的几种方式&quot;&gt;&lt;/a&gt;1 K8s 网络基础：访问集群内服务的几种方式&lt;/h2&gt;&lt;p&gt;Kubernetes 是一个分布式容器调度器，最小调度单位是 Pod。从网络的角度来说，可以认为 一个 pod 就是&lt;strong&gt;网络命名空间的一个实例&lt;/strong&gt;（an instance of network namespace）。 一个 pod 内可能会有多个容器，因此，&lt;strong&gt;多个容器可以共存于同一个网络命名空间&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;需要注意的是：&lt;strong&gt;K8s 只定义了网络模型，具体实现则是交给所谓的 CNI 插件&lt;/strong&gt;，后者完成 pod 网络的创建和销毁。本文接下来将以 &lt;code&gt;Cilium CNI&lt;/code&gt; 插件作为例子。&lt;/p&gt;
&lt;p&gt;K8s 规定了&lt;strong&gt;每个 pod 的 IP 在集群内要能访问&lt;/strong&gt;，这是通过 CNI 来完成的：CNI 插件负责为 pod 分配 IP 地址，然后为其创建和打通网络。 &lt;strong&gt;除此之外，K8s 没有对 CNI 插件做任何限制&lt;/strong&gt;。尤其是，K8s 没有对&lt;strong&gt;从集群外访问 pod 的行为做任何规定&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;接下来我们就来看看如何访问 K8s 集群里的一个&lt;strong&gt;服务&lt;/strong&gt;（通常会对应多个 backend pods）。&lt;/p&gt;
&lt;h3 id=&quot;1-1-PodIP（直连容器-IP）&quot;&gt;&lt;a href=&quot;#1-1-PodIP（直连容器-IP）&quot; class=&quot;headerlink&quot; title=&quot;1.1 PodIP（直连容器 IP）&quot;&gt;&lt;/a&gt;1.1 PodIP（直连容器 IP）&lt;/h3&gt;&lt;p&gt;第一种方式是&lt;strong&gt;通过 PodIP 直接访问&lt;/strong&gt;，这是最简单的方式。&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_pod-ip.png&quot; alt=&quot;pod-ip&quot;&gt;&lt;/p&gt;
&lt;p&gt;如上图所示，这个服务的 3 个 backend pods 分别位于两个 node 上。当集群外的客户端 访问这个服务时，它会&lt;strong&gt;直接通过某个具体的 PodIP 来访问&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;假设客户端和 Pod 之间的网络是可达的，那这种访问是没问题的。&lt;/p&gt;
&lt;p&gt;但这种方式有几个&lt;strong&gt;缺点&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;pod 会因为某些原因重建，而 K8s &lt;strong&gt;无法保证它每次都会分到同一个 IP 地址&lt;/strong&gt;。例如，如果 node 重启了，pod 很可能就会分到不同的 IP 地址，这对客户端来说个 大麻烦。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;没有内置的负载均衡&lt;/strong&gt;。即，客户端选择一个 PodIP 后，所有的请求都会发送到这个 pod，而不是分散到不同的后端 pod。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;1-2-HostPort（宿主机端口映射）&quot;&gt;&lt;a href=&quot;#1-2-HostPort（宿主机端口映射）&quot; class=&quot;headerlink&quot; title=&quot;1.2 HostPort（宿主机端口映射）&quot;&gt;&lt;/a&gt;1.2 HostPort（宿主机端口映射）&lt;/h3&gt;&lt;p&gt;第二种方式是使用所谓的 HostPort。&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_host-port.png&quot; alt=&quot;host-port&quot;&gt;&lt;/p&gt;
&lt;p&gt;如上图所示，&lt;strong&gt;在宿主机的 netns 分配一个端口&lt;/strong&gt;，并将这个端口的所有流量转发到 后端 pod。&lt;/p&gt;
&lt;p&gt;这种情况下，&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;客户端通过 Pod 所在的宿主机的 &lt;code&gt;HostIP:HostPort&lt;/code&gt; 访问服务，例如上图中访问 &lt;code&gt;10.0.0.1:10000&lt;/code&gt;；&lt;/li&gt;
&lt;li&gt;宿主机先对&lt;strong&gt;流量进行 DNAT&lt;/strong&gt;，然后转发给 Pod。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这种方式的&lt;strong&gt;缺点&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;宿主机的端口资源是所有 Pod 共享的，任何一个端口只能被一个 pod 使用 ，因此&lt;strong&gt;在每台 node 上，任何一个服务最多只能有一个 pod&lt;/strong&gt;（每个 backend 都是一 致的，因此需要使用相同的 HostPort）。对用户非常不友好。&lt;/li&gt;
&lt;li&gt;和 PodIP 方式一样，没有内置的负载均衡。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;1-3-NodePort-Service&quot;&gt;&lt;a href=&quot;#1-3-NodePort-Service&quot; class=&quot;headerlink&quot; title=&quot;1.3 NodePort Service&quot;&gt;&lt;/a&gt;1.3 NodePort Service&lt;/h3&gt;&lt;p&gt;NodePort 和上面的 HostPort 有点像（可以认为是 HostPort 的增强版），也是将 Pod 暴 露到宿主机 netns 的某个端口，但此时，&lt;strong&gt;集群内的每个 Node 上都会为这个服务的 pods 预留这个端口，并且将流量负载均衡到这些 pods&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;如下图所示，假设这里的 NodePort 是 &lt;code&gt;30001&lt;/code&gt;。当客户端请求到达任意一台 node 的 &lt;code&gt;30001&lt;/code&gt; 端口时，它可以对请求做 DNAT 然后转发给本节点内的 Pod，如下图所示：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_node-port.png&quot; alt=&quot;node-port&quot;&gt;&lt;/p&gt;
&lt;p&gt;也可以 DNAT 之后将请求转发给其他节点上的 pod，如下图所示：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_node-port-2.png&quot; alt=&quot;node-port&quot;&gt;&lt;/p&gt;
&lt;p&gt;注意在后面跨宿主机转发的情况下，&lt;strong&gt;除了做 DNAT 还需要做 SNAT&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;优点：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;已经有了服务（service）的概念&lt;/strong&gt;，多个 pod 属于同一个 service，挂掉一个时其 他 pod 还能继续提供服务。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;客户端不用关心 pod 在哪个 node 上&lt;/strong&gt;，因为集群内的所有 node 上都开了这个端 口并监听在那里，它们对全局的 backend 有一致的视图。&lt;/li&gt;
&lt;li&gt;已经&lt;strong&gt;有了负载均衡，每个 node 都是 LB&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;在宿主机 netns 内访问这些服务时，通过 &lt;code&gt;localhost:NodePort&lt;/code&gt; 就行了，无需 DNS 解析。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;缺点：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;大部分实现都是基于 SNAT&lt;/strong&gt;，当 pod 不在本节点时，导致 packet 中的&lt;strong&gt;真实客户端 IP 地址&lt;/strong&gt;信息丢失，监控、排障等不方便。&lt;/li&gt;
&lt;li&gt;Node 做转发使得&lt;strong&gt;转发路径多了一跳，延时变大&lt;/strong&gt;。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;1-4-ExternalIPs-Service&quot;&gt;&lt;a href=&quot;#1-4-ExternalIPs-Service&quot; class=&quot;headerlink&quot; title=&quot;1.4 ExternalIPs Service&quot;&gt;&lt;/a&gt;1.4 ExternalIPs Service&lt;/h3&gt;&lt;p&gt;第四种从集群外访问 service 的方式是 &lt;code&gt;external IP&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;如果有外部可达的 IP ，即&lt;strong&gt;集群外能通过这个 IP 访问到集群内特定的 nodes&lt;/strong&gt;，那我 们就可以通过这些 nodes 将流量转发到 service 的后端 pods，并提供负载均衡。&lt;/p&gt;
&lt;p&gt;如下图所示，&lt;code&gt;1.1.1.1&lt;/code&gt; 是一个 &lt;code&gt;external IP&lt;/code&gt;，所有目的 IP 地址是 &lt;code&gt;1.1.1.1&lt;/code&gt; 的流量会被底层的网络（K8s 控制之外）转发到 node1。&lt;code&gt;1.1.1.1:8080&lt;/code&gt; 在 K8s 里定义了一个 Service，如果它将流量转发到本机内的 backend pod，需要做一次 DNAT：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_external-ip.png&quot; alt=&quot;external-ip&quot;&gt;&lt;/p&gt;
&lt;p&gt;同样，这里的后端 Pod 也可以在其他 node 上，这时除了做 DNAT 还需要做一次 SNAT， 如下图所示：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_external-ip-2.png&quot; alt=&quot;external-ip&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;优点：可以使用任何外部可达的 IP 地址来定义 Service 入口&lt;/strong&gt;，只要用这个 IP 地址能访问集群内的至少一台机器即可。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;缺点：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;External IP 在 k8s 的控制范围之外&lt;/strong&gt;，是由底层的网络平台提供的。例如，底层网 络通过 BGP 宣告，使得 IP 能到达某些 nodes。&lt;/li&gt;
&lt;li&gt;由于这个 IP 是在 k8s 的控制之外，对 k8s 来说就是黑盒，因此&lt;strong&gt;从集群内访问 external IP 是存在安全隐患的&lt;/strong&gt;，例如 &lt;code&gt;external IP&lt;/code&gt; 上可能运行了 恶意服务，能够进行中间人攻击。因此，&lt;code&gt;Cilium&lt;/code&gt; 目前不支持在集群内通过 &lt;code&gt;external IP&lt;/code&gt; 访问 Service。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;1-5-LoadBalancer-Service&quot;&gt;&lt;a href=&quot;#1-5-LoadBalancer-Service&quot; class=&quot;headerlink&quot; title=&quot;1.5 LoadBalancer Service&quot;&gt;&lt;/a&gt;1.5 LoadBalancer Service&lt;/h3&gt;&lt;p&gt;第五种访问方式是所谓的 LoadBalancer 模式。针对公有云还是私有云，LoadBalancer 又分为两种。&lt;/p&gt;
&lt;h4 id=&quot;1-5-1-私有云&quot;&gt;&lt;a href=&quot;#1-5-1-私有云&quot; class=&quot;headerlink&quot; title=&quot;1.5.1 私有云&quot;&gt;&lt;/a&gt;1.5.1 私有云&lt;/h4&gt;&lt;p&gt;如果是私有云，可以考虑实现一个自己的 &lt;code&gt;cloud provider&lt;/code&gt;，或者直接使用 &lt;a href=&quot;https://github.com/metallb/metallb&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;MetalLB&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;如下图所示，&lt;strong&gt;这种模式和 externalIPs 模式非常相似&lt;/strong&gt;，local 转发：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_load-balancer.png&quot; alt=&quot;load-balancer&quot;&gt;&lt;/p&gt;
&lt;p&gt;remote 转发：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_load-balancer-2.png&quot; alt=&quot;load-balancer&quot;&gt;&lt;/p&gt;
&lt;p&gt;但是，二者有重要区别：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;externalIPs 在 K8s 的控制之外&lt;/strong&gt;，使用方式是从某个地方申请一个 external IP， 然后填到 Service 的 Spec 里；这个 &lt;code&gt;external IP&lt;/code&gt; 是存在安全隐患的，因为并不是 K8s 分配和控制的；&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;LoadBalancer 在 K8s 的控制之内&lt;/strong&gt;，只需要声明 这是一个 LoadBalancer 类型的 Service，K8s 的 &lt;code&gt;cloud-provider&lt;/code&gt; 组件就会自动给这个 Service 分配一个外部可达的 IP，本质上 &lt;code&gt;cloud-provider&lt;/code&gt; 做的事情就是从某个 LB 分配一个受信任的 VIP 然后填到 Service 的 Spec 里。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;优点&lt;/strong&gt;：LoadBalancer 分配的 IP 是归 K8s 管的，&lt;strong&gt;用户无法直接配置这些 IP&lt;/strong&gt;，因 此也就避免了前面 &lt;code&gt;external IP&lt;/code&gt; 的流量欺骗（traffic spoofing）风险。&lt;/p&gt;
&lt;p&gt;但&lt;strong&gt;注意这些 IP 不是由 CNI 分配的，而是由 LoadBalancer 实现分配&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/metallb/metallb&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;MetalLB&lt;/a&gt; 能完成 LoadBalancer IP 的分配，然后&lt;strong&gt;基于 ARP/NDP 或 BGP 宣告 IP 的可达性&lt;/strong&gt;。 此外，&lt;strong&gt;MetalLB 本身并不在 critical fast path&lt;/strong&gt; 上（可以认为它只是控制平面，完成 LoadBalancer IP 的生效，接下来的请求和响应流量，即数据平面，都不经过它），因此不 影响 XDP 的使用。&lt;/p&gt;
&lt;h4 id=&quot;1-5-2-公有云&quot;&gt;&lt;a href=&quot;#1-5-2-公有云&quot; class=&quot;headerlink&quot; title=&quot;1.5.2 公有云&quot;&gt;&lt;/a&gt;1.5.2 公有云&lt;/h4&gt;&lt;p&gt;主流的云厂商都实现了 LoadBalancer，在它们提供的托管 K8s 内可以直接使用。&lt;/p&gt;
&lt;p&gt;特点：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;有专门的 LB 节点作为统一入口。&lt;/li&gt;
&lt;li&gt;LB 节点再将流量转发到 NodePort。&lt;/li&gt;
&lt;li&gt;NodePort 再将流量转发到 backend pods。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;如下图所示，local 转发：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_load-balancer-cloud.png&quot; alt=&quot;load-balancer-cloud&quot;&gt;&lt;/p&gt;
&lt;p&gt;remote 转发：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_load-balancer-cloud-2.png&quot; alt=&quot;load-balancer-cloud&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;优点：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;LoadBalancer 由云厂商实现，无需用户安装 BGP 软件、配置 BGP 协议等来宣告 VIP 可达性。&lt;/li&gt;
&lt;li&gt;开箱即用，主流云厂商都针对它们的托管 K8s 集群实现了这样的功能。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在这种情况下，&lt;strong&gt;Cloud LB 负责检测后端 node（注意不是后端 pod）的健康状态。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;缺点：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;存在两层 LB：LB 节点转发和 node 转发。&lt;/li&gt;
&lt;li&gt;使用方式因厂商而已，例如各厂商的 annotations 并没有标准化到 K8s 中，跨云使用会有一些麻烦。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Cloud API 非常慢&lt;/strong&gt;，调用厂商的 API 来做拉入拉出非常受影响。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;1-6-ClusterIP-Service&quot;&gt;&lt;a href=&quot;#1-6-ClusterIP-Service&quot; class=&quot;headerlink&quot; title=&quot;1.6 ClusterIP Service&quot;&gt;&lt;/a&gt;1.6 ClusterIP Service&lt;/h3&gt;&lt;p&gt;最后一种是&lt;strong&gt;集群内访问 Service 的方式&lt;/strong&gt;：ClusterIP 方式。&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_cluster-ip.png&quot; alt=&quot;cluster-ip&quot;&gt;&lt;/p&gt;
&lt;p&gt;ClusterIP 也是 Service 的一种 VIP，但这种方式只适用于从集群内访问 Service，例如 从一个 Pod 访问相同集群内的一个 Service。&lt;/p&gt;
&lt;p&gt;ClusterIP 的特点：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ClusterIP 使用的 IP 地址段是&lt;strong&gt;在创建 K8s 集群之前就预留好的&lt;/strong&gt;；&lt;/li&gt;
&lt;li&gt;ClusterIP &lt;strong&gt;不可路由&lt;/strong&gt;（会在出宿主机之前被拦截，然后 DNAT 成具体的 PodIP）；&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;只能在集群内访问&lt;/strong&gt;（For in-cluster access only）。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;实际上，&lt;strong&gt;当创建一个 LoadBalancer 类型的 Service 时，K8s 会为我们自动创建三种类 型的 Service&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;LoadBalancer&lt;/li&gt;
&lt;li&gt;NodePort&lt;/li&gt;
&lt;li&gt;ClusterIP&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这三种类型的 Service 对应着同一组 backend pods。&lt;/p&gt;
&lt;p&gt;我们此次分享的第一部分，K8s 网络基础至此就要结束了，实际上还有很多与 Service 相 关的 K8s 特性，例如 &lt;code&gt;sessionAffinity&lt;/code&gt; 和 &lt;code&gt;externalTrafficPolicy&lt;/code&gt;，但这里就不展开了，有兴趣可以参考附录。&lt;/p&gt;
&lt;h2 id=&quot;2-K8s-Service-负载均衡：Cilium-基于-BPF-XDP-的实现&quot;&gt;&lt;a href=&quot;#2-K8s-Service-负载均衡：Cilium-基于-BPF-XDP-的实现&quot; class=&quot;headerlink&quot; title=&quot;2 K8s Service 负载均衡：Cilium 基于 BPF/XDP 的实现&quot;&gt;&lt;/a&gt;2 K8s Service 负载均衡：Cilium 基于 BPF/XDP 的实现&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;Cilium 基于 eBPF/XDP 实现了前面提到的所有类型的 K8s Service&lt;/strong&gt;。实现方式是：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;在每个 node 上运行一个 &lt;code&gt;cilium-agent&lt;/code&gt;；&lt;/li&gt;
&lt;li&gt;&lt;code&gt;cilium-agent&lt;/code&gt; 监听 &lt;code&gt;K8s apiserver&lt;/code&gt;，因此能够感知到 K8s 里 Service 的变化；&lt;/li&gt;
&lt;li&gt;根据 Service 的变化动态更新 BPF 配置。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;/images/k8s/cilium_bpf-lb-layers.png&quot; alt=&quot;bpf-lb-layers&quot;&gt;&lt;/p&gt;
&lt;p&gt;如上图所示，Service 的实现由两个主要部分组成：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;运行在 socket 层的 BPF 程序&lt;/li&gt;
&lt;li&gt;运行在 tc/XDP 层的 BPF 程序&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;以上两者共享 &lt;code&gt;service map&lt;/code&gt; 等资源，其中存储了 service 及其 backend pods 的映射关系。&lt;/p&gt;
&lt;h3 id=&quot;2-1-Socket-层负载均衡（东西向流量）&quot;&gt;&lt;a href=&quot;#2-1-Socket-层负载均衡（东西向流量）&quot; class=&quot;headerlink&quot; title=&quot;2.1 Socket 层负载均衡（东西向流量）&quot;&gt;&lt;/a&gt;2.1 Socket 层负载均衡（东西向流量）&lt;/h3&gt;&lt;p&gt;Socket 层 BPF 负载均衡负责处理&lt;strong&gt;集群内的东西向流量&lt;/strong&gt;。&lt;/p&gt;
&lt;h4 id=&quot;实现&quot;&gt;&lt;a href=&quot;#实现&quot; class=&quot;headerlink&quot; title=&quot;实现&quot;&gt;&lt;/a&gt;实现&lt;/h4&gt;&lt;p&gt;实现方式是：&lt;strong&gt;将 BPF 程序 attach 到 socket 的系统调用 hooks，使客户端直接和后端 pod 建连和通信&lt;/strong&gt;，如下图所示，这里能 hook 的系统调用包括 &lt;code&gt;connect()&lt;/code&gt;、&lt;code&gt;sendmsg()&lt;/code&gt;、 &lt;code&gt;recvmsg()&lt;/code&gt;、&lt;code&gt;getpeername()&lt;/code&gt;、&lt;code&gt;bind()&lt;/code&gt; 等，&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_e-w-lb.png&quot; alt=&quot;e-w-lb&quot;&gt;&lt;/p&gt;
&lt;p&gt;这里的一个问题是，&lt;strong&gt;K8s 使用的还是 cgroup v1，但这个功能需要使用 v2&lt;/strong&gt;，而由于 兼容性问题，v2 完全替换 v1 还需要很长时间。所以我们目前所能做的就是 支持 v1 和 v2 的混合模式。这也是为什么 &lt;code&gt;Cilium&lt;/code&gt; 会 mount 自己的 &lt;code&gt;cgroup v2 instance&lt;/code&gt; 的原因。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Cilium mounts cgroup v2, attaches BPF to root cgroup. Hybrid use works well for root v2.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;具体到实现上，&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;connect + sendmsg&lt;/code&gt; 做&lt;strong&gt;正向&lt;/strong&gt;变换（translation）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;recvmsg + getpeername&lt;/code&gt; 做&lt;strong&gt;反向&lt;/strong&gt;变换，&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这个变换或转换是&lt;strong&gt;基于 socket structure 的，此时还没有创建 packet&lt;/strong&gt;，因此&lt;strong&gt;不存在 packet 级别的 NAT！&lt;/strong&gt;目前已经支持 TCP/UDP v4/v6, v4-in-v6。&lt;strong&gt;应用对此是无感知的，它以为自己连接到的还是 Service IP，但其实是 PodIP&lt;/strong&gt;。&lt;/p&gt;
&lt;h4 id=&quot;查找后端-pods&quot;&gt;&lt;a href=&quot;#查找后端-pods&quot; class=&quot;headerlink&quot; title=&quot;查找后端 pods&quot;&gt;&lt;/a&gt;查找后端 pods&lt;/h4&gt;&lt;p&gt;Service lookup &lt;strong&gt;不一定能选到所有的 backend pods&lt;/strong&gt;（scoped lookup），我们将 backend pods 拆成不同的集合。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;这样设计的好处&lt;/strong&gt;：可以根据&lt;strong&gt;流量类型&lt;/strong&gt;，例如是来自集群内还是集群外（ internal/external），&lt;strong&gt;来选择不同的 backends&lt;/strong&gt;。例如，如果是到达 node 的 external traffic，我们可以限制它只能选择本机上的 backend pods，这样相比于转发到其他 node 上的 backend 就少了一跳。&lt;/p&gt;
&lt;p&gt;另外，还支持通配符（wildcard）匹配，这样就能将 Service 暴露到 localhost 或者 loopback 地址，能在宿主机 netns 访问 Service。但这种方式不会将 Service 暴露到宿 主机外面。&lt;/p&gt;
&lt;h4 id=&quot;好处&quot;&gt;&lt;a href=&quot;#好处&quot; class=&quot;headerlink&quot; title=&quot;好处&quot;&gt;&lt;/a&gt;好处&lt;/h4&gt;&lt;p&gt;显然，这种 &lt;strong&gt;socket 级别的转换是非常高效和实用的&lt;/strong&gt;，它可以直接将客户端 pod 连 接到某个 backend pod，与 kube-proxy 这样的实现相比，转发路径少了好几跳。&lt;/p&gt;
&lt;p&gt;此外，&lt;code&gt;bind&lt;/code&gt; BPF 程序在 NodePort 冲突时会&lt;strong&gt;直接拒绝应用的请求&lt;/strong&gt;，因此相比产生流 量（packet）然后在后面的协议栈中被拒绝，bind 这里要更加高效，&lt;strong&gt;因为此时 流量（packet）都还没有产生&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;对这一功能至关重要的两个函数：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;bpf_get_socket_cookie()&lt;/code&gt;&lt;br&gt;主要用于 UDP sockets，我们希望每个 UDP flow 都能选中相同的 backend pods。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;bpf_get_netns_cookie()&lt;/code&gt;&lt;br&gt;用在两个地方：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;用于区分 &lt;code&gt;host netns&lt;/code&gt; 和 &lt;code&gt;pod netns&lt;/code&gt;，例如检测到在 &lt;code&gt;host netns&lt;/code&gt; 执行 bind 时，直接拒绝（reject）；&lt;/li&gt;
&lt;li&gt;用于 &lt;code&gt;serviceSessionAffinity&lt;/code&gt;，实现在某段时间内永远选择相同的 backend pods。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;由于 &lt;code&gt;cgroup v2 不感知 netns&lt;/code&gt;，因此在这个 context 中我们没用 Pod 源 IP 信 息，通过这个 helper 能让它感知到源 IP，并以此作为它的 &lt;code&gt;source identifier&lt;/code&gt;。&lt;/p&gt;
&lt;h3 id=&quot;2-2-TC-amp-XDP-层负载均衡（南北向流量）&quot;&gt;&lt;a href=&quot;#2-2-TC-amp-XDP-层负载均衡（南北向流量）&quot; class=&quot;headerlink&quot; title=&quot;2.2 TC &amp;amp; XDP 层负载均衡（南北向流量）&quot;&gt;&lt;/a&gt;2.2 TC &amp;amp; XDP 层负载均衡（南北向流量）&lt;/h3&gt;&lt;p&gt;第二种是进出集群的流量，称为南北向流量，在宿主机 tc 或 XDP hook 里处理。&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_n-s-lb.png&quot; alt=&quot;n-s-lb&quot;&gt;&lt;/p&gt;
&lt;p&gt;BPF 做的事情，将入向流量转发到后端 Pod，&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;如果 Pod 在本节点，做 DNAT；&lt;/li&gt;
&lt;li&gt;如果在其他节点，还需要做 SNAT 或者 DSR。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;这些都是 packet 级别的操作&lt;/strong&gt;。&lt;/p&gt;
&lt;h3 id=&quot;2-3-XDP-相关优化&quot;&gt;&lt;a href=&quot;#2-3-XDP-相关优化&quot; class=&quot;headerlink&quot; title=&quot;2.3 XDP 相关优化&quot;&gt;&lt;/a&gt;2.3 XDP 相关优化&lt;/h3&gt;&lt;p&gt;在引入 XDP 支持时，为了使 context 的抽象更加通用，我们做了很多事情。下面就其中的 一些展开讨论。&lt;/p&gt;
&lt;h4 id=&quot;BPF-XDP-context-通用化&quot;&gt;&lt;a href=&quot;#BPF-XDP-context-通用化&quot; class=&quot;headerlink&quot; title=&quot;BPF/XDP context 通用化&quot;&gt;&lt;/a&gt;BPF/XDP context 通用化&lt;/h4&gt;&lt;p&gt;DNAT/SNAT engine, DSR, conntrack 等等都是在 tc BPF 里实现的。 BPF 代码中用 context 结构体传递数据包信息。&lt;/p&gt;
&lt;p&gt;支持 XDP 时遇到的一个问题是：到底是将 context 抽象地更通用一些，还是直接实现一个 支持 XDP 的最小子集。我们最后是花大力气重构了以前几乎所有的 BPF 代码，来使得它更 加通用。好处是共用一套代码，这样对代码的优化同时适用于 TC 和 XDP 逻辑。&lt;/p&gt;
&lt;p&gt;下面是一个具体例子：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ctx&lt;/code&gt; 是一个通用抽象，具体是什么类型和 include 的头文件有关，基于 cxt 可以同时处 理 tc BPF 和 XDP BPF 逻辑，&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_generic-code.png&quot; alt=&quot;generic-code&quot;&gt;&lt;/p&gt;
&lt;p&gt;例如对于 XDP 场景，编译时这些宏会被相应的 XDP 实现替换掉：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_context-specific-code.png&quot; alt=&quot;context-specific-code&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;内联汇编：绕过编译器自动优化&quot;&gt;&lt;a href=&quot;#内联汇编：绕过编译器自动优化&quot; class=&quot;headerlink&quot; title=&quot;内联汇编：绕过编译器自动优化&quot;&gt;&lt;/a&gt;内联汇编：绕过编译器自动优化&lt;/h4&gt;&lt;p&gt;我们遇到的另一个问题是：tc BPF 中已经为 skb 实现了很多的 helper 函数，由于共用一 套抽象，因此现在需要为 XDP 实现对应的一套函数集。这些 helpers 都是 inline 函数， 而 LLVM 会对 inline 函数的自动优化会导致接下来校验器（BPF verifier）失败。&lt;/p&gt;
&lt;p&gt;我们的解决方式是用 &lt;strong&gt;inline asm（内联汇编）来绕过这个问题&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;下面是一个具体例子：&lt;code&gt;xdp_load_bytes()&lt;/code&gt;，使用下面这段等价的汇编代码，才能让 verifier 认出来：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_inline-asm.png&quot; alt=&quot;inline-asm&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;避免在用户侧使用-generic-XDP&quot;&gt;&lt;a href=&quot;#避免在用户侧使用-generic-XDP&quot; class=&quot;headerlink&quot; title=&quot;避免在用户侧使用 generic XDP&quot;&gt;&lt;/a&gt;避免在用户侧使用 generic XDP&lt;/h4&gt;&lt;p&gt;5.6 内核对 XDP 来说是一个里程碑式的版本（但可能不会是一个 LTS 版本），这个版本使得 &lt;strong&gt;XDP 在公有云上大规模可用了&lt;/strong&gt;，例如 AWS ENA 和 Azure &lt;code&gt;hv_netvsc&lt;/code&gt; 驱动。 但如果想跨平台使用 XDP，那你只应该使用最基本的一些 API，例如 XDP_PASS/DROP/TX 等等。&lt;/p&gt;
&lt;p&gt;Cilium 在用户侧只使用 native XDP（only supports native XDP on user side）， 我们也用 Generic XDP，但目前只限于 CI 等场景。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;为什么我们避免在用户侧使用 generic XDP 呢&lt;/strong&gt;？因为这套 LB 逻辑会运行在集群内的 每个 node 上，目前 linearize skb 以及 bypass GRO 会增加太大的 overhead。&lt;/p&gt;
&lt;h4 id=&quot;自定义内存操作函数&quot;&gt;&lt;a href=&quot;#自定义内存操作函数&quot; class=&quot;headerlink&quot; title=&quot;自定义内存操作函数&quot;&gt;&lt;/a&gt;自定义内存操作函数&lt;/h4&gt;&lt;p&gt;现在回到加载和存储字节相关的辅助函数（load and store bytes helpers）。&lt;/p&gt;
&lt;p&gt;查看 BPF 反汇编代码时，发现内置函数会执行字节级别（byte-wise）的一些操作，因此我们实现了&lt;strong&gt;自己优化过的 &lt;code&gt;mem{cpy,zero,cmp,move}()&lt;/code&gt; 函数&lt;/strong&gt;。这一点做起来还是比较容 易的，因为 &lt;strong&gt;LLVM 对栈外数据（non-stack data）没有上下文信息&lt;/strong&gt;，例如 packet data 、map data，因而它无法准确地知道底层的架构是否支持高效的非对齐访问（unaligned access）。&lt;/p&gt;
&lt;p&gt;另外，在基准测试中我们发现，&lt;strong&gt;大流量的场景下，&lt;code&gt;bpf_ktime_get_ns()&lt;/code&gt; 在 XDP 中的开 销非常大&lt;/strong&gt;，因此我们将 clock source 变成可选的，Cilium 启动时会执行检查，如果内 核支持，就&lt;strong&gt;自动切换到 &lt;code&gt;bpf_jiffies64()&lt;/code&gt;&lt;/strong&gt;（精度更低，但 conntrack 不需要那么高的 精度），这使得转发性能增加了大约 &lt;code&gt;1.1Mpps&lt;/code&gt;。&lt;/p&gt;
&lt;h4 id=&quot;cb-control-buffer&quot;&gt;&lt;a href=&quot;#cb-control-buffer&quot; class=&quot;headerlink&quot; title=&quot;cb (control buffer)&quot;&gt;&lt;/a&gt;cb (control buffer)&lt;/h4&gt;&lt;p&gt;tc BPF 中大量使用 &lt;code&gt;skb-&amp;gt;cb[]&lt;/code&gt; 来传递数据，显然，XDP 中也是没有这个东西的。&lt;/p&gt;
&lt;p&gt;为了在 XDP 中传递数据，我们最开始使用的是 &lt;code&gt;xdp_adjust_meta()&lt;/code&gt;，但有两个缺点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;missing driver support&lt;/li&gt;
&lt;li&gt;high rate of cache-misses&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;后来换成 per-CPU scratch map&lt;/strong&gt;（每个 CPU 独立的、内容可随意修改的 map）, 增加了大约 &lt;code&gt;1.2Mpps&lt;/code&gt;。&lt;/p&gt;
&lt;h4 id=&quot;bpf-map-update-elem&quot;&gt;&lt;a href=&quot;#bpf-map-update-elem&quot; class=&quot;headerlink&quot; title=&quot;bpf_map_update_elem()&quot;&gt;&lt;/a&gt;bpf_map_update_elem()&lt;/h4&gt;&lt;p&gt;在 fast path 中有很多 &lt;code&gt;bpf_map_update_elem()&lt;/code&gt; 调用，触发了 bucket spinlock。&lt;/p&gt;
&lt;p&gt;如果流量来自多个 CPU，这里可以优化的是：先检查一下是否需要更新（这一步不需要加锁 ），如果原来已经存在，并且需要更新的值并没有变，那就直接返回，&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_bpf_map_update_ele.png&quot; alt=&quot;bpf_map_update_ele&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;bpf-fib-lookup&quot;&gt;&lt;a href=&quot;#bpf-fib-lookup&quot; class=&quot;headerlink&quot; title=&quot;bpf_fib_lookup()&quot;&gt;&lt;/a&gt;bpf_fib_lookup()&lt;/h4&gt;&lt;p&gt;&lt;code&gt;bpf_fib_lookup()&lt;/code&gt; 开销非常大，但在 XDP 中，例如 hairpin LB 场景，是不需要这个 函数的，可以在编译时去掉。我们在测试环境的结果显示可以提高 &lt;code&gt;1.5Mpps&lt;/code&gt;。&lt;/p&gt;
&lt;h4 id=&quot;静态-key&quot;&gt;&lt;a href=&quot;#静态-key&quot; class=&quot;headerlink&quot; title=&quot;静态 key&quot;&gt;&lt;/a&gt;静态 key&lt;/h4&gt;&lt;p&gt;作为这次分享的最后一个例子，不要对不确定的 LLVM 行为做任何假设。&lt;/p&gt;
&lt;p&gt;我们在 BPF map 的基础上有大量的尾调用，它们有静态的 keys，能够在编译期间确 定 key 的大小。我们还实现了一个内联汇编来做静态的尾递归调用，保证 LLVM 不会出现 尾调用相关的问题。&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_tail_call_static.png&quot; alt=&quot;tail_call_static&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;2-4-XDP-转发性能&quot;&gt;&lt;a href=&quot;#2-4-XDP-转发性能&quot; class=&quot;headerlink&quot; title=&quot;2.4 XDP 转发性能&quot;&gt;&lt;/a&gt;2.4 XDP 转发性能&lt;/h3&gt;&lt;p&gt;我们在 K8s 集群测试了 &lt;strong&gt;XDP 对 K8s Service 的转发&lt;/strong&gt;。用 pktgen 生成 &lt;code&gt;10Mpps&lt;/code&gt; 的入向处理流量，然后让 node 转发到位于其他节点的 backend pods。来看下几种不同的 负载均衡实现分别能处理多少。&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_fwd-performance.png&quot; alt=&quot;fwd-performance&quot;&gt;&lt;/p&gt;
&lt;p&gt;由上图可以看出，&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Cilium XDP 模式&lt;/strong&gt;：能够处理全部的 &lt;code&gt;10Mpps&lt;/code&gt; 入向流量，将它们转发到其他节点上的 backend pods。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Cilium TC 模式&lt;/strong&gt;：可以处理大约 &lt;code&gt;2.8Mpps&lt;/code&gt;，虽然它的处理逻辑和 Cilium XDP 是类似的（除了 BPF helpers）。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;kube-proxy iptables 模式&lt;/strong&gt;：能处理 &lt;code&gt;2.4Mpps&lt;/code&gt;，这是 K8s 的默认 Service 负载均衡实现。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;kube-proxy IPVS 模式&lt;/strong&gt;：性能更差一些，因为它的 &lt;strong&gt;per-packet overhead 更大一些&lt;/strong&gt;，这里测试的 Service 只对应一个 backend pod。当 Service 数量更多时， &lt;strong&gt;IPVS 的可扩展性更好&lt;/strong&gt;，相比 &lt;code&gt;iptables&lt;/code&gt; 模式的 &lt;code&gt;kube-proxy&lt;/code&gt; 性能会更好，但仍然没 法跟我们基于 TC BPF 和 XDP 的实现相比（no comparison at all）。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;softirq 开销&lt;/strong&gt;也是类似的，如下图所示，流量从 1Mpps 到 2Mpps 再到 4Mpps 时， XDP 模式下的 softirq 开销都远小于其他几种模式。&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_fwd-performance-cpu.png&quot; alt=&quot;fwd-performance-cpu&quot;&gt;&lt;/p&gt;
&lt;p&gt;特别是 pps 到达某个临界点时，TC 和 Netfilter 实现中 &lt;strong&gt;softirq 开销会大到饱和&lt;/strong&gt; —— 占用几乎全部 CPU。&lt;/p&gt;
&lt;h2 id=&quot;3-新的-BPF-内核扩展&quot;&gt;&lt;a href=&quot;#3-新的-BPF-内核扩展&quot; class=&quot;headerlink&quot; title=&quot;3 新的 BPF 内核扩展&quot;&gt;&lt;/a&gt;3 新的 BPF 内核扩展&lt;/h2&gt;&lt;p&gt;下面介绍几个新的 BPF 内核扩展，主要是 Cilium 相关的场景。&lt;/p&gt;
&lt;h3 id=&quot;3-1-避免穿越内核协议栈&quot;&gt;&lt;a href=&quot;#3-1-避免穿越内核协议栈&quot; class=&quot;headerlink&quot; title=&quot;3.1 避免穿越内核协议栈&quot;&gt;&lt;/a&gt;3.1 避免穿越内核协议栈&lt;/h3&gt;&lt;p&gt;主机收到的包，当其 backend 是本机上的 pod 时，或者包是本机产生的，目的端是一个本 机端口，这个包需要跨越不同的 netns，例如从宿主机的 netns 进入到容 器的 netns，&lt;strong&gt;现在 Cilium 的做法是，将包送到内核协议栈&lt;/strong&gt;，如下图所示：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_new-bpf-ext.png&quot; alt=&quot;new-bpf-ext&quot;&gt;&lt;/p&gt;
&lt;p&gt;将包送到内核协议栈有两个原因（需要）：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;TPROXY 需要由内核协议栈完成：我们目前的 L7 proxy 功能会用到这个功能，&lt;/li&gt;
&lt;li&gt;K8s 默认安装了一些 iptables rule，用来检测&lt;strong&gt;从连接跟踪的角度看是非法的连接&lt;/strong&gt;（‘invalid’ connections on asymmetric paths），然后 netfilter 会 drop 这些连接 的包。我们最开始时曾尝试将包从宿主机 tc 层直接 redirect 到 veth，但应答包却要 经过协议栈，因此形成了&lt;strong&gt;非对称路径&lt;/strong&gt;，流量被 drop。因此目前进和出都都要经过协议栈。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;但这样带来两个问题，如下图所示：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_new-bpf-ext-3.png&quot; alt=&quot;new-bpf-ext-3&quot;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Pod 的出向流量在进入协议栈后，在 socket buffer 层会丢掉 socket 信息（&lt;code&gt;skb-&amp;gt;sk&lt;/code&gt; gets orphaned at &lt;code&gt;ip_rcv_core()&lt;/code&gt;），这导致包从主机设备发出去时， 我们无法在 FQ leaf 获得 TCP 反压（TCP back-pressure）。&lt;/li&gt;
&lt;li&gt;转发和处理都是 packet 级别的，因此有 per-packet overhead。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;不久之前，&lt;strong&gt;BPF TPROXY 已经合并到内核，因此最后一个真正依赖 Netfilter 的东西已经 解决了。因此我们现在可以在 TC 层做全部逻辑处理了，无需进入内核协议栈&lt;/strong&gt;，如下图所示：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_new-bpf-ext-2.png&quot; alt=&quot;new-bpf-ext&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;3-2-Redirection-helpers&quot;&gt;&lt;a href=&quot;#3-2-Redirection-helpers&quot; class=&quot;headerlink&quot; title=&quot;3.2 Redirection helpers&quot;&gt;&lt;/a&gt;3.2 Redirection helpers&lt;/h3&gt;&lt;p&gt;两个用于 redirection 的 TC BPF helpers：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;bpf_redirect_neigh()&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;bpf_redirect_peer()&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;从 IPVLAN driver 中借鉴了一些理念，实现到了 veth 驱动中&lt;/strong&gt;。&lt;/p&gt;
&lt;h4 id=&quot;3-2-1-Pod-egress：bpf-redirect-neigh&quot;&gt;&lt;a href=&quot;#3-2-1-Pod-egress：bpf-redirect-neigh&quot; class=&quot;headerlink&quot; title=&quot;3.2.1 Pod egress：bpf_redirect_neigh()&quot;&gt;&lt;/a&gt;3.2.1 Pod egress：&lt;code&gt;bpf_redirect_neigh()&lt;/code&gt;&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;/images/k8s/cilium_tc-redir-helper.png&quot; alt=&quot;tc-redir-helper&quot;&gt;&lt;/p&gt;
&lt;p&gt;对于 pod egress 流量，我们会填充 src 和 dst mac 地址，这和原来 neighbor subsystem 做的事情相同；此外，我们还可以保留 skb 的 socket。这些都是由 &lt;code&gt;bpf_redirect_neigh()&lt;/code&gt; 来完成的：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_tc-redir-helper-2.png&quot; alt=&quot;tc-redir-helper&quot;&gt;&lt;/p&gt;
&lt;p&gt;整个过程大致实现如下，在 veth 主机端的 ingress（对应 pod 的 egress）调用这 个方法的时候：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;首先会查找路由，&lt;code&gt;ip_route_output_flow()&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;将 skb 和匹配的路由条目（dst entry）关联起来，&lt;code&gt;skb_dst_set()&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;然后调用到 neighbor 子系统，&lt;code&gt;ip_finish_output2()&lt;/code&gt;&lt;ol&gt;
&lt;li&gt;填充 neighbor 信息，即 src/dst MAC 地址&lt;/li&gt;
&lt;li&gt;保留 &lt;code&gt;skb-&amp;gt;sk&lt;/code&gt; 信息，因此物理网卡上的 qdisc 都能访问到这个字段&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这就是 pod 出向的处理过程。&lt;/p&gt;
&lt;h4 id=&quot;3-2-2-Pod-ingress：bpf-redirect-peer&quot;&gt;&lt;a href=&quot;#3-2-2-Pod-ingress：bpf-redirect-peer&quot; class=&quot;headerlink&quot; title=&quot;3.2.2 Pod ingress：bpf_redirect_peer()&quot;&gt;&lt;/a&gt;3.2.2 Pod ingress：&lt;code&gt;bpf_redirect_peer()&lt;/code&gt;&lt;/h4&gt;&lt;p&gt;入向流量，&lt;strong&gt;会有快速 netns 切换&lt;/strong&gt;，从宿主机 netns 直接进入容器的 netns。&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_tc-redir-helper-3.png&quot; alt=&quot;tc-redir-helper&quot;&gt;&lt;/p&gt;
&lt;p&gt;这是由 &lt;code&gt;bpf_redirect_peer()&lt;/code&gt; 完成的。&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_tc-redir-helper-4.png&quot; alt=&quot;tc-redir-helper&quot;&gt;&lt;/p&gt;
&lt;p&gt;在主机设备的 ingress 执行这个 helper 的时候，&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;首先会获取对应的 veth pair，&lt;code&gt;dev = ops-&amp;gt;ndo_get_peer_dev(dev)&lt;/code&gt;，然后获取 veth 的对端（在另一个 netns）&lt;/li&gt;
&lt;li&gt;然后，&lt;code&gt;skb_scrub_packet()&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;设置包的 dev 为容器内的 dev，&lt;code&gt;skb-&amp;gt;dev = dev&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;重新调度一次，&lt;code&gt;sch_handle_ingress()&lt;/code&gt;，这不会进入 CPU 的 backlog queue:&lt;ol&gt;
&lt;li&gt;goto another_round&lt;/li&gt;
&lt;li&gt;no CPU backlog queue&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&quot;3-2-3-veth-to-veth&quot;&gt;&lt;a href=&quot;#3-2-3-veth-to-veth&quot; class=&quot;headerlink&quot; title=&quot;3.2.3 veth to veth&quot;&gt;&lt;/a&gt;3.2.3 veth to veth&lt;/h4&gt;&lt;p&gt;同宿主机上的两个 Pod 之间通信时，这两个 helper 也非常有用。 因为我们已经在主机 netns 的 TC ingress 层了，因此能直接将其 redirect 到另一个容 器的 ingress 路径。&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_tc-redir-helper-5.png&quot; alt=&quot;tc-redir-helper&quot;&gt;&lt;/p&gt;
&lt;p&gt;这里比较好的一点是，需要针对老版本内核所做的兼容性非常少；因此，我们只需要在启动的 时候检测内核是否有相应的 helper，&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果有，就用 redirection 功能；&lt;/li&gt;
&lt;li&gt;如果没有，就直接返回 TC_OK，走传统的内核协议栈方式，经过内核邻居子系统。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;支持这些功能无需对原有的 BPF datapath 进行大规模重构。&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_tc-redir-helper-6.png&quot; alt=&quot;tc-redir-helper&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;3-2-4-BPF-redirection-性能&quot;&gt;&lt;a href=&quot;#3-2-4-BPF-redirection-性能&quot; class=&quot;headerlink&quot; title=&quot;3.2.4 BPF redirection 性能&quot;&gt;&lt;/a&gt;3.2.4 BPF redirection 性能&lt;/h4&gt;&lt;p&gt;下面看下性能。&lt;/p&gt;
&lt;p&gt;TCP stream 场景，相比 Cilium baseline，转发带宽增加了 &lt;code&gt;1.3Gbps&lt;/code&gt;，接近线速：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_new-ext-perf.png&quot; alt=&quot;new-ext-perf&quot;&gt;&lt;/p&gt;
&lt;p&gt;更有趣的是 TCP_RR 的场景，以 transactions/second 衡量，提升了 &lt;code&gt;2.9&lt;/code&gt; 倍，接近最 大性能：&lt;br&gt;&lt;img src=&quot;/images/k8s/cilium_new-ext-perf-2.png&quot; alt=&quot;new-ext-perf&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;4-结束语&quot;&gt;&lt;a href=&quot;#4-结束语&quot; class=&quot;headerlink&quot; title=&quot;4 结束语&quot;&gt;&lt;/a&gt;4 结束语&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/images/k8s/cilium_try-out.png&quot; alt=&quot;try-out&quot;&gt;&lt;/p&gt;
&lt;p&gt;附录: &lt;a href=&quot;/images/k8s/plumbers_2020_cilium_load_balancer.pdf&quot;&gt;plumbers_2020_cilium_load_balancer.pdf&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;译者：ArthurChiao 原文：&lt;a href=&quot;https://linuxplumbersconf.org/event/7/contributions/674/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://linuxplumbersconf.org/event/7/contributions/674/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;文章介绍了 K8s 的一些核心网络模型和设计、&lt;code&gt;Cilium&lt;/code&gt; 对 &lt;code&gt;K8s Service&lt;/code&gt; 的实现、&lt;code&gt;BPF/XDP&lt;/code&gt; 性能优化，以及他们从中得到的一些实践经验，全是干货。&lt;/p&gt;
&lt;p&gt;去年我们也参加了这个大会（LPC），并做了题为 &lt;a href=&quot;https://linuxplumbersconf.org/event/4/contributions/458/&quot;&gt;Making the Kubernetes Service Abstraction Scale using eBPF&lt;/a&gt; 的分享。 今天的内容是去年内容的延续，具体分为三个部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Kubernetes 网络模型&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Cilium&lt;/code&gt; 对 &lt;code&gt;K8s Service&lt;/code&gt; 负载均衡的实现，以及我们的一些实践经验&lt;/li&gt;
&lt;li&gt;一些新的 &lt;code&gt;BPF&lt;/code&gt; 内核扩展&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="Kubernetes" scheme="http://team.jiunile.com/categories/Kubernetes/"/>
    
      <category term="Cilium" scheme="http://team.jiunile.com/categories/Kubernetes/Cilium/"/>
    
      <category term="负载均衡" scheme="http://team.jiunile.com/categories/Kubernetes/Cilium/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="cilium" scheme="http://team.jiunile.com/tags/cilium/"/>
    
      <category term="service" scheme="http://team.jiunile.com/tags/service/"/>
    
      <category term="bpf" scheme="http://team.jiunile.com/tags/bpf/"/>
    
      <category term="xdp" scheme="http://team.jiunile.com/tags/xdp/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes 策略引擎工具 - Kyverno</title>
    <link href="http://team.jiunile.com//blog/2020/11/k8s-kyverno.html"/>
    <id>http://team.jiunile.com//blog/2020/11/k8s-kyverno.html</id>
    <published>2020-11-23T14:00:00.000Z</published>
    <updated>2020-11-23T09:10:50.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;Kubernetes 已经能够允许人们大规模地运行分布式应用程序来彻底改变云原生生态系统。虽然 Kubernetes 是一个功能丰富、健壮的容器编排平台，但它也有自己的一套复杂性。与多个团队一起大规模管理 Kubernetes 并不容易，而且要确保人们做正确的事情并且不越界是很难管理的。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kyverno/kyverno&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kyverno&lt;/a&gt; 正是解决这个问题的合适工具。它是一个开源的 Kubernetes 原生策略引擎，可以帮助您使用简单的 Kubernetes manifests 定义策略。它可以验证、修改和生成 Kubernetes 资源。因此，它允许组织定义和执行策略，以便开发人员和管理员保持一定的标准。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;Kyverno-是如何工作的？&quot;&gt;&lt;a href=&quot;#Kyverno-是如何工作的？&quot; class=&quot;headerlink&quot; title=&quot;Kyverno 是如何工作的？&quot;&gt;&lt;/a&gt;Kyverno 是如何工作的？&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Kyverno&lt;/code&gt; 通过使用动态准入控制器来工作，该控制器检查您通过 &lt;code&gt;Kubectl&lt;/code&gt; 发送到 &lt;code&gt;Kube API&lt;/code&gt; 服务端的每个请求。如果请求与策略匹配，&lt;code&gt;Kyverno&lt;/code&gt; 就应用它。否则，它将使用已定义的消息拒绝请求。&lt;/p&gt;
&lt;p&gt;所以这使得 &lt;code&gt;Kyverno&lt;/code&gt; 能够提供如下特性：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;检查 CPU 和内存限制。&lt;/li&gt;
&lt;li&gt;确保用户不更改默认的网络策略。&lt;/li&gt;
&lt;li&gt;检查资源名称是否与特定模式匹配。&lt;/li&gt;
&lt;li&gt;确保特定的资源总是包含特定的标签。&lt;/li&gt;
&lt;li&gt;拒绝对特定资源的删除和更改。&lt;/li&gt;
&lt;li&gt;如果镜像标签是 &lt;code&gt;latest&lt;/code&gt; 将自动更改 &lt;code&gt;imagePullPolicy&lt;/code&gt; 为 &lt;code&gt;Always&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;为每个新的命名空间生成一个默认的网络策略。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;Kyverno&lt;/code&gt; 使用自定义资源定义来定义策略，编写策略就像使用 kubectl 应用它们一样简单。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Kyverno&lt;/code&gt; 提供了三个主要功能：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;验证（Validation）&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;变更（Mutation）&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;生成（Generation）&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;让我们看一下它们各自的示例清单。&lt;/p&gt;
&lt;h2 id=&quot;Validation&quot;&gt;&lt;a href=&quot;#Validation&quot; class=&quot;headerlink&quot; title=&quot;Validation&quot;&gt;&lt;/a&gt;Validation&lt;/h2&gt;&lt;p&gt;一个很好的用例是确保所有的 pods 都设置了资源请求和限制。&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; kyverno.io/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ClusterPolicy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; check-resources&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  validationFailureAction:&lt;/span&gt; enforce&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  rules:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; check-pod-resources&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      match:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          kinds:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;            -&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      validate:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        message:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;CPU and memory resource requests and limits are required&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        pattern:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;              - name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;*&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                  limits:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                    memory:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;?*&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                    cpu:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;?*&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                  requests:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                    memory:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;?*&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                    cpu:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;?*&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;大多数配置都是比较清楚明白的，&lt;code&gt;validationFailureAction&lt;/code&gt; 申明是强制执行（通过使用 &lt;code&gt;enforcement&lt;/code&gt; ）还是只审计它(通过 &lt;code&gt;audit&lt;/code&gt; )并报告违规情况。&lt;/p&gt;
&lt;h2 id=&quot;Mutation&quot;&gt;&lt;a href=&quot;#Mutation&quot; class=&quot;headerlink&quot; title=&quot;Mutation&quot;&gt;&lt;/a&gt;Mutation&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;Mutation&lt;/strong&gt; 意味着如果匹配到满足特定的场景就变更资源属性。一个很好的例子是，如果镜像标签是最新的，那么将 &lt;code&gt;imagePullPolicy&lt;/code&gt; 更改为 &lt;code&gt;Always&lt;/code&gt;。&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; kyverno.io/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ClusterPolicy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; image-pull-policy-always&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  rules:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; image-pull-policy-latest&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      match:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          kinds:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;            -&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      mutate:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        overlay:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;              -&lt;/span&gt; (image): &lt;span class=&quot;string&quot;&gt;&quot;*:latest&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                imagePullPolicy:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Always&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;Generate&quot;&gt;&lt;a href=&quot;#Generate&quot; class=&quot;headerlink&quot; title=&quot;Generate&quot;&gt;&lt;/a&gt;Generate&lt;/h2&gt;&lt;p&gt;顾名思义，针对特定事件生成资源。例如，如果有人创建了一个新的名称空间，我们可能希望执行默认的网络策略。&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; kyverno.io/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ClusterPolicy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;default&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  rules:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;default-deny&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    match:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      resources:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        kinds:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;        -&lt;/span&gt; Namespace&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;*&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    exclude:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      namespaces:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;        -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;kube-system&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;        -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;default&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;        -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;kube-public&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;        -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;kyverno&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    generate:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      kind:&lt;/span&gt; NetworkPolicy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      name:&lt;/span&gt; default-deny-all-traffic&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      namespace:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&lt;span class=&quot;template-variable&quot;&gt;&amp;#123;&amp;#123;request.object.metadata.namespace&amp;#125;&amp;#125;&lt;/span&gt;&quot;&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      data:&lt;/span&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          podSelector:&lt;/span&gt; &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          policyTypes:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;          -&lt;/span&gt; Ingress&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;          -&lt;/span&gt; Egress&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;体验一把&quot;&gt;&lt;a href=&quot;#体验一把&quot; class=&quot;headerlink&quot; title=&quot;体验一把&quot;&gt;&lt;/a&gt;体验一把&lt;/h2&gt;&lt;p&gt;现在让我们亲自动手，看看 &lt;code&gt;Kyverno&lt;/code&gt; 的行为。我们将安装 &lt;code&gt;Kyverno&lt;/code&gt;，然后应用验证策略来检查特定的标签。如果标签不存在，&lt;code&gt;Kyverno&lt;/code&gt; 将拒绝请求。否则，它将应用它。&lt;/p&gt;
&lt;h3 id=&quot;安装-Kyverno&quot;&gt;&lt;a href=&quot;#安装-Kyverno&quot; class=&quot;headerlink&quot; title=&quot;安装 Kyverno&quot;&gt;&lt;/a&gt;安装 Kyverno&lt;/h3&gt;&lt;p&gt;安装 &lt;code&gt;Kyverno&lt;/code&gt; 很简单。你可以应用 GitHub 上的 &lt;code&gt;Kyverno Kubernetes manifest&lt;/code&gt;，或者安装最新的 &lt;code&gt;helm chart&lt;/code&gt;。&lt;/p&gt;
&lt;h4 id=&quot;使用-manifest&quot;&gt;&lt;a href=&quot;#使用-manifest&quot; class=&quot;headerlink&quot; title=&quot;使用 manifest&quot;&gt;&lt;/a&gt;使用 manifest&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl create &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; https://raw.githubusercontent.com/kyverno/kyverno/master/definitions/release/install.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;使用-helm-chart&quot;&gt;&lt;a href=&quot;#使用-helm-chart&quot; class=&quot;headerlink&quot; title=&quot;使用 helm chart&quot;&gt;&lt;/a&gt;使用 helm chart&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;helm repo add kyverno https://kyverno.github.io/kyverno/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl create ns kyverno&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;helm install kyverno --namespace kyverno kyverno/kyverno&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;检查我们是否成功安装了 &lt;code&gt;Kyverno&lt;/code&gt;，列出 &lt;code&gt;Kyverno&lt;/code&gt; 命名空间中的所有资源：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# kubectl get all -n kyverno&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pod/kyverno-5f7769d697-x8lkj   0/1     Running   0          21s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                  TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;service/kyverno-svc   ClusterIP   10.96.167.8   &amp;lt;none&amp;gt;        443/TCP   21s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                      READY   UP-TO-DATE   AVAILABLE   AGE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deployment.apps/kyverno   0/1     1            0           21s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                                 DESIRED   CURRENT   READY   AGE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;replicaset.apps/kyverno-5f7769d697   1         1         0       21s&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;应用策略&quot;&gt;&lt;a href=&quot;#应用策略&quot; class=&quot;headerlink&quot; title=&quot;应用策略&quot;&gt;&lt;/a&gt;应用策略&lt;/h3&gt;&lt;p&gt;让我们应用一个策略来确保所有 &lt;code&gt;pods&lt;/code&gt; 都应该包含一个名为 &lt;code&gt;app&lt;/code&gt; 的标签。创建名为&lt;code&gt;require-app-label.yaml&lt;/code&gt; 的文件，其内容如下：&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; kyverno.io/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ClusterPolicy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; require-app-label&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  validationFailureAction:&lt;/span&gt; enforce&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  rules:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; check-for-app-label&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    match:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        kinds:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;        -&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    validate:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      message:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;label `app` is required&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      pattern:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            app:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;?*&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果您查看 YAML，会看到有一个匹配部分，其中包含我们应该匹配的资源类型。在这个场景中，我们看到一个 pod。&lt;code&gt;validate&lt;/code&gt; 部分定义了验证失败时应该输出的消息，以及定义需要匹配什么内容的模式。&lt;/p&gt;
&lt;p&gt;由于这是一个 CRD，我们可以直接应用它，得到想要的结果：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; require-app-label.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;测试&quot;&gt;&lt;a href=&quot;#测试&quot; class=&quot;headerlink&quot; title=&quot;测试&quot;&gt;&lt;/a&gt;测试&lt;/h3&gt;&lt;p&gt;让我们创建一个没有标签的 pod，看看我们会得到什么：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl run nginx --image=nginx&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/k8s/kyverno_1.gif&quot; alt=&quot;kyverno&quot;&gt;&lt;/p&gt;
&lt;p&gt;所以正如我们所看到的，验证失败的原因如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Error from server: admission webhook &lt;span class=&quot;string&quot;&gt;&quot;nirmata.kyverno.resource.validating-webhook&quot;&lt;/span&gt; denied the request:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;resource Deployment/default/nginx was blocked due to the following policies&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;require-app-label:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  autogen-check-for-app-label: &lt;span class=&quot;string&quot;&gt;&#39;Validation error: label `app` is required; Validation rule autogen-check-for-app-label failed at path /spec/template/metadata/labels/app/&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这和预期的一样，因为我们还没有提供标签。现在让我们尝试使用标签 &lt;code&gt;name=nginx&lt;/code&gt;：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl run nginx --image=nginx --labels=&lt;span class=&quot;string&quot;&gt;&quot;name=nginx&quot;&lt;/span&gt; --generator=run-pod/v1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/k8s/kyverno_2.gif&quot; alt=&quot;kyverno&quot;&gt;&lt;/p&gt;
&lt;p&gt;这个也失败了，因为 app 标签仍然缺失。让我们用 &lt;code&gt;app=NGINX&lt;/code&gt; 标签创建一个 NGINX pod：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl run nginx --image=nginx --labels=&lt;span class=&quot;string&quot;&gt;&quot;app=nginx&quot;&lt;/span&gt; --generator=run-pod/v1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/k8s/kyverno_3.gif&quot; alt=&quot;kyverno&quot;&gt;&lt;/p&gt;
&lt;p&gt;正如我们所看到的，pod 已经成功创建。现在，让我们使用 kubectl 来获取 pod 和标签:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl get pod nginx --show-labels&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/k8s/kyverno_4.gif&quot; alt=&quot;kyverno&quot;&gt;&lt;/p&gt;
&lt;p&gt;pod 正在运行，并包含 &lt;code&gt;app=nginx&lt;/code&gt; 标签。&lt;/p&gt;
&lt;h2 id=&quot;总结&quot;&gt;&lt;a href=&quot;#总结&quot; class=&quot;headerlink&quot; title=&quot;总结&quot;&gt;&lt;/a&gt;总结&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Kyverno&lt;/code&gt; 是一款优秀的 “policy-as-code” 工具，它在组织层执行最佳实践方面非常强大。由于它是 kubernets 原生的，所以编写和操作都很简单，不需要专门的开发人员进行维护。&lt;/p&gt;
&lt;p&gt;感谢你的阅读！希望你喜欢这篇文章。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;译自：&lt;a href=&quot;https://medium.com/better-programming/policy-as-code-on-kubernetes-with-kyverno-b144749f144&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://medium.com/better-programming/policy-as-code-on-kubernetes-with-kyverno-b144749f144&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;Kubernetes 已经能够允许人们大规模地运行分布式应用程序来彻底改变云原生生态系统。虽然 Kubernetes 是一个功能丰富、健壮的容器编排平台，但它也有自己的一套复杂性。与多个团队一起大规模管理 Kubernetes 并不容易，而且要确保人们做正确的事情并且不越界是很难管理的。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kyverno/kyverno&quot;&gt;Kyverno&lt;/a&gt; 正是解决这个问题的合适工具。它是一个开源的 Kubernetes 原生策略引擎，可以帮助您使用简单的 Kubernetes manifests 定义策略。它可以验证、修改和生成 Kubernetes 资源。因此，它允许组织定义和执行策略，以便开发人员和管理员保持一定的标准。&lt;/p&gt;
    
    </summary>
    
      <category term="Kubernetes" scheme="http://team.jiunile.com/categories/Kubernetes/"/>
    
      <category term="策略" scheme="http://team.jiunile.com/categories/Kubernetes/%E7%AD%96%E7%95%A5/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="policy" scheme="http://team.jiunile.com/tags/policy/"/>
    
      <category term="kyverno" scheme="http://team.jiunile.com/tags/kyverno/"/>
    
  </entry>
  
  <entry>
    <title>探索 Go Trace 包</title>
    <link href="http://team.jiunile.com//blog/2020/11/go-trace.html"/>
    <id>http://team.jiunile.com//blog/2020/11/go-trace.html</id>
    <published>2020-11-22T12:00:00.000Z</published>
    <updated>2020-11-21T16:34:46.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;本文基于 Go 1.13&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Go 为我们提供了一个工具，可以在运行时进行跟踪，并获得程序执行的详细视图。这个工具可以通过在测试中使用标记 &lt;code&gt;-trace&lt;/code&gt; 来启用，可以通过 &lt;code&gt;pprof&lt;/code&gt; 来进行实时跟踪，也可以通过&lt;code&gt;trace&lt;/code&gt; &lt;a href=&quot;https://golang.org/pkg/runtime/trace/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;包&lt;/a&gt;在代码中的任何位置启用。这个工具可以更加强大，因为您可以自定义 traces 来增强它。让我们回顾一下它是如何工作的。&lt;/p&gt;
&lt;h2 id=&quot;流程&quot;&gt;&lt;a href=&quot;#流程&quot; class=&quot;headerlink&quot; title=&quot;流程&quot;&gt;&lt;/a&gt;流程&lt;/h2&gt;&lt;p&gt;该工具的流程非常简单。每个事件，如内存分配；垃圾回收器的所有阶段；goroutines 在运行、暂停等情况下会被 Go 标准库静态记录，并格式化后显示。然而，在录制开始之前，Go 首先“stops the world”，并对当前的 goroutines 及其状态进行快照。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这将在之后能让 Go 正确地构建每个 goroutine 的生命周期。流程如下:&lt;br&gt;&lt;img src=&quot;/images/go/trace_1.png&quot; alt=&quot;Initialization phase before tracing&quot;&gt;&lt;/p&gt;
&lt;p&gt;然后，将收集的事件推送到缓冲区，当达到最大容量时，该缓冲区随后将刷新到完整缓冲区列表。这是此流程的图:&lt;br&gt;&lt;img src=&quot;/images/go/trace_2.png&quot; alt=&quot;Tracing collect events per P&quot;&gt;&lt;/p&gt;
&lt;p&gt;跟踪器现在需要一种将这些跟踪转储到输出的方法。为此，当追踪开始时，Go 会产生一个专用于此的 goroutine。如果可用，该 goroutine 将转储数据，并将把 goroutine 停放到下一个。这是它的一个表示：&lt;br&gt;&lt;img src=&quot;/images/go/trace_3.png&quot; alt=&quot;A dedicated goroutine reads and dump the traces&quot;&gt;&lt;/p&gt;
&lt;p&gt;现在流程非常清晰，所以让我们回顾一下记录的跟踪事件。&lt;/p&gt;
&lt;h2 id=&quot;追踪&quot;&gt;&lt;a href=&quot;#追踪&quot; class=&quot;headerlink&quot; title=&quot;追踪&quot;&gt;&lt;/a&gt;追踪&lt;/h2&gt;&lt;p&gt;生成跟踪后，就可以通过运行命令 &lt;code&gt;go tool trace my-output.out&lt;/code&gt; 来实现可视化。让我们以一些跟踪事件为例：&lt;br&gt;&lt;img src=&quot;/images/go/trace_4.png&quot; alt=&quot;Tracing from go tool&quot;&gt;&lt;/p&gt;
&lt;p&gt;大多数都很简单。与垃圾回收器相关的跟踪位于蓝色跟踪 &lt;code&gt;GC&lt;/code&gt; 下:&lt;br&gt;&lt;img src=&quot;/images/go/trace_5.png&quot; alt=&quot;Traces of the garbage collector&quot;&gt;&lt;/p&gt;
&lt;p&gt;快速回顾：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;STW&lt;/code&gt; 是垃圾回收器中的两个 “Stop the World” 阶段。在这两个阶段，goroutines 被停止。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;GC (空闲)&lt;/code&gt; 是在没有工作要做时标记内存的 goroutine。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;MARK ASSIST&lt;/code&gt; 是在分配期间帮助标记内存的 goroutines。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;GXX runtime.bgsweep&lt;/code&gt; 是垃圾回收器完成后的内存扫描阶段。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;GXX runtime.gcBgMarkWorker&lt;/code&gt; 是帮助标记内存的专用后台 goroutines。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;然而，有些追踪事件并不容易理解。让我们回顾一下，以便更好地理解：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;当处理器与线程关联时，将调用 &lt;code&gt;proc start&lt;/code&gt;。当启动新线程或从 syscall 恢复时，就会发生这种情况。&lt;br&gt;&lt;img src=&quot;/images/go/trace_6.png&quot; alt=&quot;trace&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;当线程与当前处理器解除关联时，将调用 &lt;code&gt;proc stop&lt;/code&gt;。当线程在 syscall 中被阻塞或线程退出时，就会发生这种情况。&lt;br&gt;&lt;img src=&quot;/images/go/trace_7.png&quot; alt=&quot;trace&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;当 goroutine 进行系统调用时，将调用 &lt;code&gt;syscall&lt;/code&gt;:&lt;br&gt;&lt;img src=&quot;/images/go/trace_8.png&quot; alt=&quot;trace&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;当 goroutine 从 syscall 解除阻止时，将调用 &lt;code&gt;unblock&lt;/code&gt; – 在这种情况下，标签 (&lt;code&gt;sysexit&lt;/code&gt;) 将从被阻塞的通道显示:&lt;br&gt;&lt;img src=&quot;/images/go/trace_9.png&quot; alt=&quot;trace&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;跟踪可以增强，因为 Go 允许您定义和可视化自己的跟踪以及标准库中的跟踪。&lt;/p&gt;
&lt;h2 id=&quot;用户自定义追踪&quot;&gt;&lt;a href=&quot;#用户自定义追踪&quot; class=&quot;headerlink&quot; title=&quot;用户自定义追踪&quot;&gt;&lt;/a&gt;用户自定义追踪&lt;/h2&gt;&lt;p&gt;我们可以定义的跟踪有两个级别：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在任务的顶层，有开始和结束。&lt;/li&gt;
&lt;li&gt;在区域的子级别上。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;下面是一个简单的例子：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	ctx, task := trace.NewTask(context.Background(), &lt;span class=&quot;string&quot;&gt;&quot;main start&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; wg sync.WaitGroup&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	wg.Add(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; wg.Done()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		r := trace.StartRegion(ctx, &lt;span class=&quot;string&quot;&gt;&quot;reading file&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; r.End()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		ioutil.ReadFile(&lt;span class=&quot;string&quot;&gt;`n1.txt`&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; wg.Done()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		r := trace.StartRegion(ctx, &lt;span class=&quot;string&quot;&gt;&quot;writing file&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; r.End()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		ioutil.WriteFile(&lt;span class=&quot;string&quot;&gt;`n2.txt`&lt;/span&gt;, []&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;`42`&lt;/span&gt;), &lt;span class=&quot;number&quot;&gt;0644&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	wg.Wait()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; task.End()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这些新的跟踪可以通过菜单用户自定义直接从工具中可视化：&lt;br&gt;&lt;img src=&quot;/images/go/trace_10.png&quot; alt=&quot;Custom task and regions&quot;&gt;&lt;/p&gt;
&lt;p&gt;还可以任意将一些日志记录到任务中:&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ctx, task := trace.NewTask(context.Background(), &lt;span class=&quot;string&quot;&gt;&quot;main start&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;trace.Log(ctx, &lt;span class=&quot;string&quot;&gt;&quot;category&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;I/O file&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;trace.Log(ctx, &lt;span class=&quot;string&quot;&gt;&quot;goroutine&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;2&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这些日志将在设置任务的 goroutine 下找到：&lt;br&gt;&lt;img src=&quot;/images/go/trace_11.png&quot; alt=&quot;Custom logs in the tracing&quot;&gt;&lt;/p&gt;
&lt;p&gt;还可以通过派生父任务的上下文等将任务嵌入到其他任务中。&lt;/p&gt;
&lt;p&gt;但是，由于 &lt;code&gt;pprof&lt;/code&gt; 的存在，在生产中实时跟踪所有这些事件可能会在收集它们时略微降低性能。&lt;/p&gt;
&lt;h2 id=&quot;性能影响&quot;&gt;&lt;a href=&quot;#性能影响&quot; class=&quot;headerlink&quot; title=&quot;性能影响&quot;&gt;&lt;/a&gt;性能影响&lt;/h2&gt;&lt;p&gt;一个简单的基准测试可以帮助理解跟踪的影响。其中一个将带标志 &lt;code&gt;-trace&lt;/code&gt; 运行，另一个则不带。下面是 &lt;code&gt;ioutil.ReadFile()&lt;/code&gt; 函数的基准测试结果，该函数生成了很多事件:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;name         time/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ReadFiles-8  48.1µs ± 0%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name         time/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ReadFiles-8  63.5µs ± 0%  // with tracing&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在这种情况下，影响约为 ~35%，并且可能因应用程序而异。但是有一些工具（如 StackDriver ），允许在生产环境中进行连续的分析，同时又对应用程序保持较小的开销。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;译自：&lt;a href=&quot;https://medium.com/a-journey-with-go/go-discovery-of-the-trace-package-e5a821743c3c&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://medium.com/a-journey-with-go/go-discovery-of-the-trace-package-e5a821743c3c&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;本文基于 Go 1.13&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Go 为我们提供了一个工具，可以在运行时进行跟踪，并获得程序执行的详细视图。这个工具可以通过在测试中使用标记 &lt;code&gt;-trace&lt;/code&gt; 来启用，可以通过 &lt;code&gt;pprof&lt;/code&gt; 来进行实时跟踪，也可以通过&lt;code&gt;trace&lt;/code&gt; &lt;a href=&quot;https://golang.org/pkg/runtime/trace/&quot;&gt;包&lt;/a&gt;在代码中的任何位置启用。这个工具可以更加强大，因为您可以自定义 traces 来增强它。让我们回顾一下它是如何工作的。&lt;/p&gt;
&lt;h2 id=&quot;流程&quot;&gt;&lt;a href=&quot;#流程&quot; class=&quot;headerlink&quot; title=&quot;流程&quot;&gt;&lt;/a&gt;流程&lt;/h2&gt;&lt;p&gt;该工具的流程非常简单。每个事件，如内存分配；垃圾回收器的所有阶段；goroutines 在运行、暂停等情况下会被 Go 标准库静态记录，并格式化后显示。然而，在录制开始之前，Go 首先“stops the world”，并对当前的 goroutines 及其状态进行快照。&lt;br&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="追踪" scheme="http://team.jiunile.com/categories/golang/%E8%BF%BD%E8%B8%AA/"/>
    
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="trace" scheme="http://team.jiunile.com/tags/trace/"/>
    
  </entry>
  
  <entry>
    <title>在 Go 中我应该使用指针还是拷贝结构体？</title>
    <link href="http://team.jiunile.com//blog/2020/11/go-copy-struct-or-pointer.html"/>
    <id>http://team.jiunile.com//blog/2020/11/go-copy-struct-or-pointer.html</id>
    <published>2020-11-20T14:00:00.000Z</published>
    <updated>2020-11-19T14:49:22.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;对于许多 Go 开发人员来说，系统地使用指针来共享结构体而不是拷贝本身似乎是性能方面的最佳选择。&lt;/p&gt;
&lt;p&gt;为了理解使用指针而不是拷贝结构体的影响，我们将回顾两个用例。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;用例1：数据密集分配&quot;&gt;&lt;a href=&quot;#用例1：数据密集分配&quot; class=&quot;headerlink&quot; title=&quot;用例1：数据密集分配&quot;&gt;&lt;/a&gt;用例1：数据密集分配&lt;/h2&gt;&lt;p&gt;让我们举一个简单的例子，当你想共享一个结构体的值：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; S &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   a, b, c &lt;span class=&quot;keyword&quot;&gt;int64&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   d, e, f &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   g, h, i &lt;span class=&quot;keyword&quot;&gt;float64&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这是一个基本的结构体，可以通过拷贝或指针共享：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;byCopy&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;S&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; S&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      a: &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, b: &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, c: &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      e: &lt;span class=&quot;string&quot;&gt;&quot;foo&quot;&lt;/span&gt;, f: &lt;span class=&quot;string&quot;&gt;&quot;foo&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      g: &lt;span class=&quot;number&quot;&gt;1.0&lt;/span&gt;, h: &lt;span class=&quot;number&quot;&gt;1.0&lt;/span&gt;, i: &lt;span class=&quot;number&quot;&gt;1.0&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;byPointer&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;S&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &amp;amp;S&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      a: &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, b: &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, c: &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      e: &lt;span class=&quot;string&quot;&gt;&quot;foo&quot;&lt;/span&gt;, f: &lt;span class=&quot;string&quot;&gt;&quot;foo&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      g: &lt;span class=&quot;number&quot;&gt;1.0&lt;/span&gt;, h: &lt;span class=&quot;number&quot;&gt;1.0&lt;/span&gt;, i: &lt;span class=&quot;number&quot;&gt;1.0&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;基于这两种方法，我们现在可以编写两个基准测试，其中一个是通过拷贝结构体传递的：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BenchmarkMemoryStack&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(b *testing.B)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; s S&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   f, err := os.Create(&lt;span class=&quot;string&quot;&gt;&quot;stack.out&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;built_in&quot;&gt;panic&lt;/span&gt;(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; f.Close()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   err = trace.Start(f)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;built_in&quot;&gt;panic&lt;/span&gt;(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; b.N; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      s = byCopy()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   trace.Stop()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   b.StopTimer()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   _ = fmt.Sprintf(&lt;span class=&quot;string&quot;&gt;&quot;%v&quot;&lt;/span&gt;, s.a)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;另一个，非常相似，通过指针传递：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BenchmarkMemoryHeap&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(b *testing.B)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; s *S&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   f, err := os.Create(&lt;span class=&quot;string&quot;&gt;&quot;heap.out&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;built_in&quot;&gt;panic&lt;/span&gt;(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; f.Close()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   err = trace.Start(f)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;built_in&quot;&gt;panic&lt;/span&gt;(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; b.N; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      s = byPointer()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   trace.Stop()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   b.StopTimer()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   _ = fmt.Sprintf(&lt;span class=&quot;string&quot;&gt;&quot;%v&quot;&lt;/span&gt;, s.a)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;让我们运行一下基准测试：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt; ./... -bench=BenchmarkMemoryHeap -benchmem -run=^$ -count=10 &amp;gt; head.txt &amp;amp;&amp;amp; benchstat head.txt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt; ./... -bench=BenchmarkMemoryStack -benchmem -run=^$ -count=10 &amp;gt; stack.txt &amp;amp;&amp;amp; benchstat stack.txt&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;以下是统计数据：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;name          time/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryHeap-4  75.0ns ± 5%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name          alloc/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryHeap-4   96.0B ± 0%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name          allocs/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryHeap-4    1.00 ± 0%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name           time/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryStack-4  8.93ns ± 4%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name           alloc/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryStack-4   0.00B&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name           allocs/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryStack-4    0.00&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在这里使用结构的拷贝而不是指针要快 &lt;strong&gt;8 倍&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;为了理解其中的原因，让我们来看一下 trace 生成的图表：&lt;br&gt;&lt;img src=&quot;/images/go/struct_1.png&quot; alt=&quot;graph for the struct passed by copy&quot;&gt;&lt;br&gt;&lt;img src=&quot;/images/go/struct_2.png&quot; alt=&quot;graph for the struct passed by pointer&quot;&gt;&lt;/p&gt;
&lt;p&gt;第一个图很简单。由于没有使用堆，因此没有垃圾回收器和额外的 &lt;code&gt;goroutine&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;对于第二个图，指针的使用迫使 go 编译器将&lt;a href=&quot;https://golang.org/doc/faq#stack_or_heap&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;变量转义到堆中&lt;/a&gt;，并对垃圾回收器施加压力。如果我们放大这个图，我们可以看到垃圾回收器在这个过程中扮演了重要的角色:&lt;br&gt;&lt;img src=&quot;/images/go/struct_3.png&quot; alt=&quot;trace struct&quot;&gt;&lt;/p&gt;
&lt;p&gt;从这个图中我们可以看到，垃圾回收器必须每 4ms 工作一次。&lt;/p&gt;
&lt;p&gt;如果我们再次放大，我们可以得到正在发生的事情的详细信息:&lt;br&gt;&lt;img src=&quot;/images/go/struct_4.png&quot; alt=&quot;trace struct&quot;&gt;&lt;/p&gt;
&lt;p&gt;蓝色、粉色和红色的是垃圾回收器的阶段，而棕色的阶段与堆上的分配有关(在图表上标记为 “&lt;code&gt;runtime.bgsweep&lt;/code&gt;”):&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;扫描是指回收与堆内存中未标记为正在使用的值相关联的内存。当应用程序 &lt;code&gt;Goroutines&lt;/code&gt; 试图在堆内存中分配新值时，就会发生此活动。扫描的延迟会增加在堆内存中执行分配的成本，并且不会与垃圾回收相关的任何延迟相关联。&lt;br&gt;&lt;a href=&quot;https://www.ardanlabs.com/blog/2018/12/garbage-collection-in-go-part1-semantics.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.ardanlabs.com/blog/2018/12/garbage-collection-in-go-part1-semantics.html&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;即使这个示例有点极端，我们也可以看到在堆上分配变量而不是在栈上分配变量的代价有多大。在我们的示例中，代码在栈上分配结构体并拷贝它比在堆上分配结构体并共享其地址要快得多。&lt;/p&gt;
&lt;p&gt;如果您不熟悉栈/堆，如果您想了解更多关于每个堆的内部细节，您可以在网上找到许多资源，比如 Paul Gribble 的这篇&lt;a href=&quot;https://www.gribblelab.org/CBootCamp/7_Memory_Stack_vs_Heap.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;文章&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;如果我们将 &lt;code&gt;GOMAXPROCS=1&lt;/code&gt; 的处理器限制为 1，情况会更糟：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;name        time/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryHeap  114ns ± 4%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name        alloc/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryHeap  96.0B ± 0%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name        allocs/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryHeap   1.00 ± 0%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name         time/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryStack  8.77ns ± 5%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name         alloc/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryStack   0.00B&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name         allocs/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryStack    0.00&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果在栈上有分配的基准没有改变，那么在堆上的基准已经从 75ns/op 降低到 114ns/op。&lt;/p&gt;
&lt;h2 id=&quot;用例2：密集的函数调用&quot;&gt;&lt;a href=&quot;#用例2：密集的函数调用&quot; class=&quot;headerlink&quot; title=&quot;用例2：密集的函数调用&quot;&gt;&lt;/a&gt;用例2：密集的函数调用&lt;/h2&gt;&lt;p&gt;对于第二个用例，我们将在结构体中添加两个空方法，稍微调整一下我们的基准用例:&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(s S)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;stack&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(s1 S)&lt;/span&gt;&lt;/span&gt; &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(s *S)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;heap&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(s1 *S)&lt;/span&gt;&lt;/span&gt; &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在栈上分配的基准测试将创建一个结构并通过拷贝传递它:&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BenchmarkMemoryStack&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(b *testing.B)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; s S&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; s1 S&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   s = byCopy()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   s1 = byCopy()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; b.N; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;1000000&lt;/span&gt;; i++  &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         s.stack(s1)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;而堆的基准测试将通过指针传递结构体：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BenchmarkMemoryHeap&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(b *testing.B)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; s *S&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; s1 *S&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   s = byPointer()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   s1 = byPointer()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; b.N; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;1000000&lt;/span&gt;; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         s.heap(s1)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;不出所料，结果现在大不相同：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;name          time/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryHeap-4  301µs ± 4%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name          alloc/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryHeap-4  0.00B&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name          allocs/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryHeap-4   0.00&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name           time/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryStack-4  595µs ± 2%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name           alloc/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryStack-4  0.00B&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name           allocs/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MemoryStack-4   0.00&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;结论&quot;&gt;&lt;a href=&quot;#结论&quot; class=&quot;headerlink&quot; title=&quot;结论&quot;&gt;&lt;/a&gt;结论&lt;/h2&gt;&lt;p&gt;在 go 中，使用指针而不是拷贝结构体并不总是一件好事。&lt;/p&gt;
&lt;p&gt;为了你的数据选择好的语义，我强烈建议阅读 &lt;a href=&quot;https://twitter.com/goinggodotnet&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Bill Kennedy&lt;/a&gt; 写的&lt;a href=&quot;https://www.ardanlabs.com/blog/2017/06/design-philosophy-on-data-and-semantics.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;关于值/指针语义&lt;/a&gt;的文章。它将让您更好地了解结构和内置类型可以使用的策略。&lt;/p&gt;
&lt;p&gt;此外，对内存使用情况的分析肯定会帮助您了解在分配和堆上发生了什么。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;来源：&lt;a href=&quot;https://medium.com/a-journey-with-go/go-should-i-use-a-pointer-instead-of-a-copy-of-my-struct-44b43b104963&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://medium.com/a-journey-with-go/go-should-i-use-a-pointer-instead-of-a-copy-of-my-struct-44b43b104963&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;对于许多 Go 开发人员来说，系统地使用指针来共享结构体而不是拷贝本身似乎是性能方面的最佳选择。&lt;/p&gt;
&lt;p&gt;为了理解使用指针而不是拷贝结构体的影响，我们将回顾两个用例。&lt;br&gt;
    
    </summary>
    
      <category term="go" scheme="http://team.jiunile.com/categories/go/"/>
    
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="golang" scheme="http://team.jiunile.com/tags/golang/"/>
    
      <category term="指针" scheme="http://team.jiunile.com/tags/%E6%8C%87%E9%92%88/"/>
    
      <category term="结构体" scheme="http://team.jiunile.com/tags/%E7%BB%93%E6%9E%84%E4%BD%93/"/>
    
  </entry>
  
  <entry>
    <title>Golang 六种错误处理技术，可帮助您编写优雅的代码</title>
    <link href="http://team.jiunile.com//blog/2020/11/go-handle-error.html"/>
    <id>http://team.jiunile.com//blog/2020/11/go-handle-error.html</id>
    <published>2020-11-20T12:00:00.000Z</published>
    <updated>2020-11-19T14:47:25.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;当在 GO 中遇到错误时你会怎么做？&lt;/p&gt;
&lt;p&gt;处理错误并不简单。在讨论功能性需求时，很少考虑错误处理需求，但是错误处理是软件开发的一个重要部分。&lt;/p&gt;
&lt;p&gt;在 GO 中，错误条件以方法返回值的形式返回。在我看来，将错误条件作为主流程的一部分是很有用的 – 它让开发人员在编写功能代码时承担处理错误的责任。这种范例与其他编程语言(如 Java )所提供的非常不同 – 其中异常是完全不同的流程。虽然这种不同的风格使代码更具可读性，但也带来了新的挑战。&lt;/p&gt;
&lt;p&gt;本文讨论了六种处理错误、重试和可服务性的技术。虽然很少有想法是琐碎的，但其他想法并不那么受欢迎。&lt;/p&gt;
&lt;p&gt;因此，让我们从列表开始！&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;1-向左对齐&quot;&gt;&lt;a href=&quot;#1-向左对齐&quot; class=&quot;headerlink&quot; title=&quot;1 向左对齐&quot;&gt;&lt;/a&gt;1 向左对齐&lt;/h2&gt;&lt;p&gt;处理错误的最佳策略是检查错误并立即从函数返回。在一个函数中有多个错误返回语句是可以的 – 事实上，这是明智的选择。[1]&lt;/p&gt;
&lt;p&gt;例如，下面的代码片段展示了如何使用 &lt;code&gt;if err == nil&lt;/code&gt; 来处理一个愉快的场景，从而导致嵌套 if 检查。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Handling Happy case first - leading to nested if checks...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;example&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     err := somethingThatReturnsError()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//Happy processing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        err = somethingElseThatReturnsError()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &lt;span class=&quot;comment&quot;&gt;//More Happy processing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;上述逻辑可以通过向左对齐逻辑来处理：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;ABetterExample&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     err := somethingThatReturnsError()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;comment&quot;&gt;// Happy processing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     err = somethingElseThatReturnsError()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;comment&quot;&gt;// More Happy processing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;2-重试可恢复错误&quot;&gt;&lt;a href=&quot;#2-重试可恢复错误&quot; class=&quot;headerlink&quot; title=&quot;2 重试可恢复错误&quot;&gt;&lt;/a&gt;2 重试可恢复错误&lt;/h2&gt;&lt;p&gt;很少有可恢复的错误值得重试 – 网络故障、IO 操作等都可以通过简单的重试恢复。&lt;/p&gt;
&lt;p&gt;下面的包可以帮助解决重试带来的麻烦。&lt;br&gt;&lt;a href=&quot;https://godoc.org/github.com/cenkalti/backoff#example-Retry&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;package backoff&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// An operation that may fail.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;operation := &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// or an error&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;err := Retry(operation, NewExponentialBackOff())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Handle error.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;指数回退意味着重试间隔呈指数增长 – 对于大多数网络 /IO 故障来说，这是一个明智的选择。&lt;/p&gt;
&lt;h2 id=&quot;3-包装错误&quot;&gt;&lt;a href=&quot;#3-包装错误&quot; class=&quot;headerlink&quot; title=&quot;3 包装错误&quot;&gt;&lt;/a&gt;3 包装错误&lt;/h2&gt;&lt;p&gt;默认的错误包是有限的 – 错误上下文的详细信息经常会丢失。例如：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;testingError2&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; errors.New(&lt;span class=&quot;string&quot;&gt;&quot;New Error&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;testingError&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(accountNumber &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   err := testingError2()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   err := testingError(&lt;span class=&quot;string&quot;&gt;&quot;Acct1&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   logrus.Error(&lt;span class=&quot;string&quot;&gt;&quot;Error occurred&quot;&lt;/span&gt;, fmt.Sprintf(&lt;span class=&quot;string&quot;&gt;&quot;%+v&quot;&lt;/span&gt;, err))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在这种情况下，主函数收到的错误实例没有发生在帐户 &lt;code&gt;Acct1&lt;/code&gt; 上的信息。可以在函数 &lt;code&gt;testingErrror&lt;/code&gt; 中记录 &lt;code&gt;accountNumber&lt;/code&gt;，但是由于当前包错误，无法将该信息传递给主函数。&lt;/p&gt;
&lt;p&gt;这就是 &lt;code&gt;github.Com/pkg/errors&lt;/code&gt; 的来源。该库与 &lt;code&gt;errors&lt;/code&gt; 兼容并带来了一些很酷的功能。&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;testingError2&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; errors.New(&lt;span class=&quot;string&quot;&gt;&quot;New Error&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;testingError&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(accountNumber &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   err := testingError2()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; errors.Wrap(err, &lt;span class=&quot;string&quot;&gt;&quot;Error occurred while processing Card Number &quot;&lt;/span&gt;+accoutNumber)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   err := testingError(&lt;span class=&quot;string&quot;&gt;&quot;Acct1&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   logrus.Error(&lt;span class=&quot;string&quot;&gt;&quot;Error occurred&quot;&lt;/span&gt;, fmt.Sprintf(&lt;span class=&quot;string&quot;&gt;&quot;%+v&quot;&lt;/span&gt;, err))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在 &lt;code&gt;github.com/pkg/errors&lt;/code&gt; 中，您还可以使用一些额外的有用功能 – &lt;code&gt;errors.Unwrap&lt;/code&gt; 和 &lt;code&gt;errors.Is&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;4-日志策略&quot;&gt;&lt;a href=&quot;#4-日志策略&quot; class=&quot;headerlink&quot; title=&quot;4 日志策略&quot;&gt;&lt;/a&gt;4 日志策略&lt;/h2&gt;&lt;p&gt;Golang 的默认包日志不提供使用日志记录级别进行日志记录功能。这里有一些其他的选择：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Glog&lt;/code&gt;: &lt;a href=&quot;https://github.com/golang/glog&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/golang/glog&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Logrus&lt;/code&gt;: &lt;a href=&quot;https://github.com/sirupsen/logrus&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/sirupsen/logrus&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Zap&lt;/code&gt;: &lt;a href=&quot;https://github.com/uber-go/zap&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/uber-go/zap&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;Logrus&lt;/code&gt; 和 &lt;code&gt;Zap&lt;/code&gt; 还提供了&lt;strong&gt;结构化日志输出&lt;/strong&gt;的功能 – 这是一个非常方便的功能，因为它为开发人员提供了向错误日志消息添加上下文的能力。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;example&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(accountNumber &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; logrus.SetFormatter(&amp;amp;logrus.JSONFormatter&amp;#123;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ctxFields := logrus.Fields&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;&quot;accountNumber&quot;&lt;/span&gt;: accountNumber,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;&quot;appname&quot;&lt;/span&gt;:       &lt;span class=&quot;string&quot;&gt;&quot;my-app&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Happy processing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; err := errors.New(&lt;span class=&quot;string&quot;&gt;&quot;Some test error while doing happy processing&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  logrus.WithFields(ctxFields).WithError(err).Error(&lt;span class=&quot;string&quot;&gt;&quot;ErrMsg&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;结构化日志输出如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;accountNumber&quot;&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&quot;ABC&quot;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&quot;appname&quot;&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&quot;my-app&quot;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&quot;error&quot;&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&quot;Some test error while doing happy processing&quot;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&quot;level&quot;&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&quot;error&quot;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&quot;msg&quot;&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&quot;ErrMsg&quot;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&quot;time&quot;&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&quot;2009-11-10T23:00:00Z&quot;&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;日志的另一个关键方面是获得日志堆栈跟踪的能力。如果你使用 &lt;code&gt;github.com/pkg/errors&lt;/code&gt;，你就可以&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;logrus.Error(&lt;span class=&quot;string&quot;&gt;&quot;Error occurred&quot;&lt;/span&gt;, fmt.Sprintf(&lt;span class=&quot;string&quot;&gt;&quot;%+v&quot;&lt;/span&gt;, err))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;你会得到一个错误堆栈跟踪如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;main.testingError2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        /home/nayars/go/src/github.com/nayarsn/temp.go:12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;main.testingError&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        /home/nayars/go/src/github.com/nayarsn/temp.go:25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;main.main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        /home/nayars/go/src/github.com/nayarsn/temp.go:39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;runtime.main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        /usr/lib/go-1.15/src/runtime/proc.go:204&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;runtime.goexit&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        /usr/lib/go-1.15/src/runtime/asm_amd64.s:1374&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Zap&lt;/code&gt; 为性能进行了缓冲和优化。[2]&lt;/p&gt;
&lt;h2 id=&quot;5-错误检查&quot;&gt;&lt;a href=&quot;#5-错误检查&quot; class=&quot;headerlink&quot; title=&quot;5 错误检查&quot;&gt;&lt;/a&gt;5 错误检查&lt;/h2&gt;&lt;p&gt;将错误视为值是好的 – 它是明确的，而明确的有很多意义。但它也可以为开发人员提供跳过的机会。例如：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;testingError&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(accoutNumber &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; err error&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _ = errors.New(&lt;span class=&quot;string&quot;&gt;&quot;errors.New with _&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    errors.New(&lt;span class=&quot;string&quot;&gt;&quot;errors.New not capturing return&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;上面的示例显示应用程序程序员是由 &lt;code&gt;errors.New&lt;/code&gt; 语句返回的两个错误。这可能是有意或无意发生的。&lt;/p&gt;
&lt;p&gt;幸运的是，有一个 linter 实用程序可以帮助您。&lt;br&gt;&lt;a href=&quot;https://github.com/kisielk/errcheck&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;kisielk/errcheck&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;一旦你安装了 linter，你可以简单地做以下事情：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;errcheck -blank ./...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;你会得到这样的输出：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;temp.go:16:2:   _ = errors.New(&lt;span class=&quot;string&quot;&gt;&quot;Error capturing return using _&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;temp.go:18:12:  errors.New(&lt;span class=&quot;string&quot;&gt;&quot;Error not capturing return&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这可以作为 CI/CD 流程的一部分，以确保应用程序开发人员不会错过这一部分。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;errchec&lt;/code&gt; 是 Go linters 聚合器实用程序的一部分 – &lt;a href=&quot;https://golangci-lint.run/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://golangci-lint.run/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;6-多个错误&quot;&gt;&lt;a href=&quot;#6-多个错误&quot; class=&quot;headerlink&quot; title=&quot;6 多个错误&quot;&gt;&lt;/a&gt;6 多个错误&lt;/h2&gt;&lt;p&gt;你有多个错误的场景 – 它们是同一个 &lt;code&gt;go routine&lt;/code&gt; 的一部分，你不想停止处理 – 而是继续处理并记录所有错误。这里有一个专门的库：&lt;br&gt;&lt;a href=&quot;https://github.com/hashicorp/go-multierror&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;hashicorp/go-multierror&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这里有一个简单的例子：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;step1&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; errors.New(&lt;span class=&quot;string&quot;&gt;&quot;Step1&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;step2&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; errors.New(&lt;span class=&quot;string&quot;&gt;&quot;Step2&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; result error&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := step1(); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        result = multierror.Append(result, err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := step2(); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        result = multierror.Append(result, err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fmt.Println(multierror.Flatten(result))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;同样，对于多个 &lt;code&gt;go routines&lt;/code&gt;，可以使用以下库：&lt;br&gt;&lt;a href=&quot;https://pkg.go.dev/golang.org/x/sync/errgroup&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;errgroup&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;总结&quot;&gt;&lt;a href=&quot;#总结&quot; class=&quot;headerlink&quot; title=&quot;总结&quot;&gt;&lt;/a&gt;总结&lt;/h2&gt;&lt;p&gt;我知道上述列表并非全部。对于你们中的一些人来说，这可能是微不足道的 – 但希望对你们中的一些人来说，这有助于你们掌握错误处理技术。&lt;/p&gt;
&lt;h2 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;[1] &lt;a href=&quot;https://medium.com/@matryer/line-of-sight-in-code-186dd7cdea88&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://medium.com/@matryer/line-of-sight-in-code-186dd7cdea88&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;[2] &lt;a href=&quot;https://medium.com/a-journey-with-go/go-how-zap-package-is-optimized-dbf72ef48f2d&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://medium.com/a-journey-with-go/go-how-zap-package-is-optimized-dbf72ef48f2d&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;译自：&lt;a href=&quot;https://medium.com/higher-order-functions/golang-six-error-handling-techniques-to-help-you-write-elegant-code-8e6363e6d2b&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://medium.com/higher-order-functions/golang-six-error-handling-techniques-to-help-you-write-elegant-code-8e6363e6d2b&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;当在 GO 中遇到错误时你会怎么做？&lt;/p&gt;
&lt;p&gt;处理错误并不简单。在讨论功能性需求时，很少考虑错误处理需求，但是错误处理是软件开发的一个重要部分。&lt;/p&gt;
&lt;p&gt;在 GO 中，错误条件以方法返回值的形式返回。在我看来，将错误条件作为主流程的一部分是很有用的 – 它让开发人员在编写功能代码时承担处理错误的责任。这种范例与其他编程语言(如 Java )所提供的非常不同 – 其中异常是完全不同的流程。虽然这种不同的风格使代码更具可读性，但也带来了新的挑战。&lt;/p&gt;
&lt;p&gt;本文讨论了六种处理错误、重试和可服务性的技术。虽然很少有想法是琐碎的，但其他想法并不那么受欢迎。&lt;/p&gt;
&lt;p&gt;因此，让我们从列表开始！&lt;br&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="error" scheme="http://team.jiunile.com/categories/golang/error/"/>
    
    
      <category term="error" scheme="http://team.jiunile.com/tags/error/"/>
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="golang" scheme="http://team.jiunile.com/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>深入理解 kubernetes iptables proxy 模式</title>
    <link href="http://team.jiunile.com//blog/2020/11/k8s-proxy-iptables.html"/>
    <id>http://team.jiunile.com//blog/2020/11/k8s-proxy-iptables.html</id>
    <published>2020-11-19T15:00:00.000Z</published>
    <updated>2020-11-18T13:56:14.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;最近在面试的时候问了不少 &lt;code&gt;network request&lt;/code&gt; 如何到 &lt;code&gt;k8s service backend&lt;/code&gt; 的问题，觉得可以整合一下网络上的资料，这篇主要讨论 &lt;code&gt;iptables proxy mode&lt;/code&gt;。大部分的情况没有在使用 &lt;code&gt;userspace proxy modes&lt;/code&gt;， &lt;code&gt;ipvs proxy mode&lt;/code&gt; 可能要等到下一次讨论。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;事先准备&quot;&gt;&lt;a href=&quot;#事先准备&quot; class=&quot;headerlink&quot; title=&quot;事先准备&quot;&gt;&lt;/a&gt;事先准备&lt;/h2&gt;&lt;p&gt;要先了解 &lt;code&gt;iptable&lt;/code&gt; 工作机制，建议可以看这一篇：&lt;a href=&quot;https://phoenixnap.com/kb/iptables-tutorial-linux-firewall&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://phoenixnap.com/kb/iptables-tutorial-linux-firewall&lt;/a&gt;，当然 wikipedia 也是写的不错，我下面的文字也大多数引用：&lt;a href=&quot;https://zh.wikipedia.org/wiki/Iptables&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://zh.wikipedia.org/wiki/Iptables&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;快速带过-iptable&quot;&gt;&lt;a href=&quot;#快速带过-iptable&quot; class=&quot;headerlink&quot; title=&quot;快速带过 iptable&quot;&gt;&lt;/a&gt;快速带过 &lt;code&gt;iptable&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;说到 &lt;code&gt;iptable&lt;/code&gt; 要先了解 &lt;strong&gt;&lt;code&gt;Tables&lt;/code&gt;&lt;/strong&gt;, &lt;strong&gt;&lt;code&gt;Chains&lt;/code&gt;&lt;/strong&gt; 和 &lt;strong&gt;&lt;code&gt;Rueles&lt;/code&gt;&lt;/strong&gt;。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;&lt;code&gt;Table&lt;/code&gt;&lt;/strong&gt; 指不同类型的封包处理流程，总共有五种，不同的 &lt;strong&gt;&lt;code&gt;Tables&lt;/code&gt;&lt;/strong&gt; 处理不同的行为&lt;ul&gt;
&lt;li&gt;&lt;code&gt;raw&lt;/code&gt;：处理异常，追踪状态 -&amp;gt; &lt;code&gt;/proc/net/nf_conntrack&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;mangle&lt;/code&gt;：处理封包，修改 headler 之类的&lt;/li&gt;
&lt;li&gt;&lt;code&gt;nat&lt;/code&gt;：进行位址转换操作&lt;/li&gt;
&lt;li&gt;&lt;code&gt;filter&lt;/code&gt;：进行封包过滤&lt;/li&gt;
&lt;li&gt;&lt;code&gt;security&lt;/code&gt;：SElinux 相关&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;code&gt;Chains&lt;/code&gt;&lt;/strong&gt; 来对应进行不同的行为。像是 “filter” &lt;strong&gt;&lt;code&gt;Tables&lt;/code&gt;&lt;/strong&gt; 进行封包过滤的流程，而 “nat” 针对连接进行位址转换操作。&lt;strong&gt;&lt;code&gt;Chains&lt;/code&gt;&lt;/strong&gt; 里面包含许多规则，主要有五种类型的 &lt;strong&gt;&lt;code&gt;Chains&lt;/code&gt;&lt;/strong&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;PREROUTING&lt;/code&gt;：处理路由规则前通过此 &lt;code&gt;Chains&lt;/code&gt;，通常用于目的位址转换（DNAT）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;INPUT&lt;/code&gt;：发往本机的封包通过此 &lt;strong&gt;&lt;code&gt;Chains&lt;/code&gt;&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;FORWARD&lt;/code&gt;：本机转发的封包通过此 &lt;strong&gt;&lt;code&gt;Chains&lt;/code&gt;&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;OUTPUT&lt;/code&gt;：处理本机发出的封包。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;POSTROUTING&lt;/code&gt;：完成路由规则后通过此 &lt;strong&gt;&lt;code&gt;Chains&lt;/code&gt;&lt;/strong&gt;，通常用于源位址转换（SNAT）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;code&gt;Rules&lt;/code&gt;&lt;/strong&gt; 规则会被逐一进行匹配，如果匹配，可以执行相应的动作  &lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;大致的工作流向情况分两种：&quot;&gt;&lt;a href=&quot;#大致的工作流向情况分两种：&quot; class=&quot;headerlink&quot; title=&quot;大致的工作流向情况分两种：&quot;&gt;&lt;/a&gt;大致的工作流向情况分两种：&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;backend 为本机&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;NIC → PREROUTING → INPUT → Local process &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Local process → OUTPUT → POSTROUTING → NIC&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;backend 目的地非本机&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;NIC→PREROUTING → FORWARD → POSTROUTING→NIC&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_1.png&quot; alt=&quot;Iptables Basics&quot;&gt;&lt;/p&gt;
&lt;p&gt;下面是比较详细的流程，有包含 &lt;code&gt;EBTABLES&lt;/code&gt;，但这个看久头会昏，我这次会主要讨论 Network Layer 这一部分，然后用上面这张比较精简的图&lt;br&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_2.png&quot; alt=&quot;Netfilter pic of wikipedia&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Kube-proxy&lt;/code&gt; 修改了 filter，nat 两个表，自定义了&lt;br&gt;&lt;code&gt;KUBE-SERVICES&lt;/code&gt;，&lt;code&gt;KUBE-NODEPORTS&lt;/code&gt;，&lt;code&gt;KUBE-POSTROUTING&lt;/code&gt;，&lt;code&gt;KUBE-FORWARD&lt;/code&gt;，&lt;code&gt;KUBE-MARK-MASQ&lt;/code&gt; 和 &lt;code&gt;KUBE-MARK-DROP&lt;/code&gt;，所以我这次会 focus on filter ，nat 两个 Table&lt;/p&gt;
&lt;h3 id=&quot;1-filter-table-有三个-Chain-“INPUT”-“OUTPUT”-“FORWARD”&quot;&gt;&lt;a href=&quot;#1-filter-table-有三个-Chain-“INPUT”-“OUTPUT”-“FORWARD”&quot; class=&quot;headerlink&quot; title=&quot;1. filter table 有三个 Chain “INPUT” “OUTPUT” “FORWARD”&quot;&gt;&lt;/a&gt;1. filter table 有三个 Chain “&lt;strong&gt;INPUT&lt;/strong&gt;” “&lt;strong&gt;OUTPUT&lt;/strong&gt;” “&lt;strong&gt;FORWARD&lt;/strong&gt;”&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_3.png&quot; alt=&quot;iptables-routing&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;kube-proxy&lt;/code&gt; 在 filter table 的 “&lt;strong&gt;INPUT&lt;/strong&gt;” “&lt;strong&gt;OUTPUT&lt;/strong&gt;” chain 增加了 &lt;code&gt;KUBE-FIREWALL&lt;/code&gt; 在 “&lt;strong&gt;INPUT&lt;/strong&gt;” “&lt;strong&gt;OUTPUT&lt;/strong&gt;” “&lt;strong&gt;FORWARD&lt;/strong&gt;” chain 增加了 &lt;code&gt;KUBE-SERVICES&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;KUBE_FIREWALL&lt;/code&gt; 会丢弃所有被 &lt;code&gt;KUBE-MARK-DROP&lt;/code&gt; 标记 0x8000 的封包，而标记的动作可以在其他的 table 中(像是第二部分提到的 NAT table 中)&lt;br&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_4.png&quot; alt=&quot;proxy iptable&quot;&gt;&lt;br&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_5.png&quot; alt=&quot;proxy iptable&quot;&gt;&lt;/p&gt;
&lt;p&gt;而 filter table 的 &lt;code&gt;KUBE-SERVICES&lt;/code&gt; 可以过滤封包，假如一个 service 没有对应的 endpoint，就会被 reject，这里我先要建立一个 service 和没有正确设定 endpoint。&lt;/p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Service &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; test-error-endpoint &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; default &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  ports:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - protocol:&lt;/span&gt; TCP &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;7777&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      targetPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;7777&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt;-- &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Endpoints &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; test-error-endpoint &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; default&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;service cluster ip 为 10.95.58.92&lt;/p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Service &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; test-error-endpoint &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; default &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  selfLink:&lt;/span&gt; /api/v1/namespaces/default/services/test-error-endpoint &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  uid:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;d415d63&lt;span class=&quot;bullet&quot;&gt;-6&lt;/span&gt;fc3&lt;span class=&quot;bullet&quot;&gt;-444e-8&lt;/span&gt;b5a&lt;span class=&quot;bullet&quot;&gt;-29015&lt;/span&gt;b436a83 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  resourceVersion:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39; 73026369&#39;&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  creationTimestamp:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;2020-11-17T05:48:52Z&#39;&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  ports:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - protocol:&lt;/span&gt; TCP &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;7777&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      targetPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;7777&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  clusterIP:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10.95&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.58&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.92&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  type:&lt;/span&gt; ClusterIP &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  sessionAffinity:&lt;/span&gt; None &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;status:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  loadBalancer:&lt;/span&gt; &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再次检查 iptable，就可以看到 &lt;code&gt;default/test-error-endpoint: has no endpoints -&amp;gt; tcp dpt:7777 reject-with icmp-port-unreachable&lt;/code&gt;&lt;br&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_6.png&quot; alt=&quot;proxy iptable&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;2-nat-table-有三个-Chain-“PREROUTING”-“OUTPUT”-“POSTROUTING”&quot;&gt;&lt;a href=&quot;#2-nat-table-有三个-Chain-“PREROUTING”-“OUTPUT”-“POSTROUTING”&quot; class=&quot;headerlink&quot; title=&quot;2. nat table 有三个 Chain “PREROUTING” “OUTPUT” “POSTROUTING”&quot;&gt;&lt;/a&gt;2. nat table 有三个 Chain “&lt;strong&gt;PREROUTING&lt;/strong&gt;” “&lt;strong&gt;OUTPUT&lt;/strong&gt;” “&lt;strong&gt;POSTROUTING&lt;/strong&gt;”&lt;/h3&gt;&lt;p&gt;在前两个封包处理流程是比较相似和复杂的，大体来说是藉由客制化的规则，来处理符合条件封包，帮它们找到正确的 k8s endpoint (后面会细讲)，在 &lt;code&gt;POSTROUTING&lt;/code&gt; 主要是针对 k8s 处理的封包(标记 0x4000 的封包)，在离开 node 的时候做 SNAT&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(inbound) 在 “&lt;strong&gt;PREROUTING&lt;/strong&gt;” 将所有封包转发到 &lt;code&gt;KUBE-SERVICES&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;(outbound) 在 “&lt;strong&gt;OUTPUT&lt;/strong&gt;” 将所有封包转发到 &lt;code&gt;KUBE-SERVICES&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;(outbound) 在 “&lt;strong&gt;POSTROUTING&lt;/strong&gt;” 将所有封包转发到 &lt;code&gt;KUBE-POSTROUTING&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_7.png&quot; alt=&quot;iptables-routing&quot;&gt;&lt;br&gt;当封包进入 “&lt;strong&gt;PREROUTING&lt;/strong&gt;” 和 “&lt;strong&gt;OUTPUT&lt;/strong&gt;”，会整个被 &lt;code&gt;KUBE-SERVICES&lt;/code&gt; Chain 整个绑架走，开始逐一匹配 &lt;code&gt;KUBE-SERVICES&lt;/code&gt; 中的 rule 和打上标签。&lt;br&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_8.png&quot; alt=&quot;nat tables&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;kube-proxy&lt;/code&gt; 的用法是一种 O(n) 算法，其中的 n 随 k8s cluster 的规模同步增加，更简单的说就是 service 和 endpoint 的数量。&lt;br&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_9.png&quot; alt=&quot;kube-services&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;我这里会准备三个最常见的 service type 的 &lt;code&gt;kube-proxy&lt;/code&gt; 路由流程&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;cluster IP&lt;/li&gt;
&lt;li&gt;nodePort&lt;/li&gt;
&lt;li&gt;load balancer&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;clusterIP-流程&quot;&gt;&lt;a href=&quot;#clusterIP-流程&quot; class=&quot;headerlink&quot; title=&quot;clusterIP 流程&quot;&gt;&lt;/a&gt;clusterIP 流程&lt;/h4&gt;&lt;p&gt;这里我使用 &lt;code&gt;default/jeff-api(clusterIP: 10.95.57.19)&lt;/code&gt; 举例，我下面图过滤掉不必要的资讯&lt;br&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_10.png&quot; alt=&quot;kube-services&quot;&gt;&lt;/p&gt;
&lt;p&gt;最后会到实际 pod 的位置，&lt;code&gt;podIP: 10.95.35.31，hostIP: 10.20.0.128&lt;/code&gt; 是该 pod 所在 node 的 ip&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; jeff-api&lt;span class=&quot;bullet&quot;&gt;-746&lt;/span&gt;f4c9985&lt;span class=&quot;bullet&quot;&gt;-5&lt;/span&gt;qmw6 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  generateName:&lt;/span&gt; jeff-api&lt;span class=&quot;bullet&quot;&gt;-746&lt;/span&gt;f4c9985- &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; default &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; promotion-api &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      image:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;gcr.io/jeff-project/jeff /jeff-api:202011161901&#39;&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      ports:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - name:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;tcp02 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          containerPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          protocol:&lt;/span&gt; TCP &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  nodeName:&lt;/span&gt; gke-sit-jeff-k8s-tw&lt;span class=&quot;bullet&quot;&gt;-01&lt;/span&gt;-default-pool&lt;span class=&quot;bullet&quot;&gt;-7983&lt;/span&gt;af35-ug91 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;status:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  phase:&lt;/span&gt; Running &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  hostIP:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10.20&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.128&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  podIP:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10.95&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.35&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.31&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;nodePort-流程&quot;&gt;&lt;a href=&quot;#nodePort-流程&quot; class=&quot;headerlink&quot; title=&quot;nodePort 流程&quot;&gt;&lt;/a&gt;nodePort 流程&lt;/h4&gt;&lt;p&gt;这里有一个关键就是 &lt;code&gt;KUBE-NODEPORTS&lt;/code&gt; 一定是在 &lt;code&gt;KUBE-SERVICES&lt;/code&gt; 最后一项，iptables 在处理 packet 会先处理 ip 为 cluster ip 的 service，当全部的 &lt;code&gt;KUBE-SVC-XXXXXX&lt;/code&gt; 都对应不到的时候就会使用 nodePort 去匹配。&lt;br&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_11.png&quot; alt=&quot;kube-services&quot;&gt;&lt;/p&gt;
&lt;p&gt;我们看实际 pod 的资讯，&lt;code&gt;podIP: 10.95.32.17，hostIP: 10.20.0.124&lt;/code&gt; 是其中一台 node 的 ip&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Service &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; jeff-frontend &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; jeff-frontend &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  ports:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - protocol:&lt;/span&gt; TCP &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      targetPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      nodePort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;31929&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  selector:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    app:&lt;/span&gt; jeff-frontend &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  clusterIP:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10.95&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.58&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.51&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  type:&lt;/span&gt; NodePort &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  externalTrafficPolicy:&lt;/span&gt; Cluster &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt;-- &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; jeff-frontend-c94bf68d9-bbmp8 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  generateName:&lt;/span&gt; jeff-frontend-c94bf68d9- &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; jeff-frontend &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; jeff-frontend&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      image:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;gcr.io/jeff-project/jeff/jeff-image:jeff-1.0.6.5&#39;&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      ports:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - name:&lt;/span&gt; http &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          containerPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          protocol:&lt;/span&gt; TCP &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  nodeName:&lt;/span&gt; gke-sit-jeff-k8s-tw&lt;span class=&quot;bullet&quot;&gt;-01&lt;/span&gt;-default -pool-b5692f8d-enk7 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;status:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  phase:&lt;/span&gt; Running &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  hostIP:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10.20&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.124&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  podIP:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10.95&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.32&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.17&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;load-balancer流程&quot;&gt;&lt;a href=&quot;#load-balancer流程&quot; class=&quot;headerlink&quot; title=&quot;load balancer流程&quot;&gt;&lt;/a&gt;load balancer流程&lt;/h4&gt;&lt;p&gt;假如目的地 IP 是 load balancer 就会使用 &lt;code&gt;KUBE-FW-XXXXXX&lt;/code&gt;，我建立一个 internal load balancer service 和 endpoint 指到 google postgresql DB(10.28.193.9)&lt;br&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_12.png&quot; alt=&quot;kube-services&quot;&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Service &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  annotations:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cloud.google.com/load-balancer-type: Internal &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    networking.gke.io/internal-load-balancer-allow-global-access: &lt;span class=&quot;string&quot;&gt;&#39;true&#39;&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; external-postgresql &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spec : &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  ports:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - protocol:&lt;/span&gt; TCP &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5432&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      targetPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5432&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  type:&lt;/span&gt; LoadBalancer &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt;-- &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Endpoints &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; external-postgresql &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;subsets:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- addresses:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - ip:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10.28&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.193&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.9&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  ports:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5432&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    protocol : TCP&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_13.png&quot; alt=&quot;kube-services&quot;&gt;&lt;br&gt;在 NAT table 看到 &lt;code&gt;KUBE-MARK-MASQ&lt;/code&gt; 和 &lt;code&gt;KUBE-MARK-DROP&lt;/code&gt; 这两个规则主要是经过的封包打上标签，打上标签的封包会做相应的处理。&lt;code&gt;KUBE-MARK-DROP&lt;/code&gt; 和 &lt;code&gt;KUBE-MARK-MASQ&lt;/code&gt; 本质上就是使用 iptables 的 &lt;a href=&quot;https://serverfault.com/questions/514116/how-to-set-mark-on-packet-when-forwarding-it-in-nat-prerouting-table&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;MARK 指令&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-MARK-DROP -j MARK --set-xmark 0x8000/0x8000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果打上了 &lt;code&gt;0x8000&lt;/code&gt; 到后面 filter table (上面提到 &lt;code&gt;KUBE_FIREWALL&lt;/code&gt; )就会丢弃。&lt;/p&gt;
&lt;p&gt;如果打上了 &lt;code&gt;0x4000&lt;/code&gt; k8s 将会在 &lt;code&gt;PREROUTING&lt;/code&gt; table 的 &lt;code&gt;KUBE-POSTROUTING&lt;/code&gt; chain 对它进行 SNAT 转换。&lt;br&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_14.png&quot; alt=&quot;kube-services&quot;&gt;&lt;br&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_15.png&quot; alt=&quot;POSTROUTING table&quot;&gt;&lt;br&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_16.png&quot; alt=&quot;KUBE-POSTROUTING Chain&quot;&gt;&lt;br&gt;&lt;img src=&quot;/images/k8s/proxy_iptable_17.png&quot; alt=&quot;KUBE-SERVICES&quot;&gt;&lt;/p&gt;
&lt;p&gt;参考:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Netfilter&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://en.wikipedia.org/wiki/Netfilter&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://zh.wikipedia.org/wiki/Iptables&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://zh.wikipedia.org/wiki/Iptables&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://phoenixnap.com/kb/iptables-tutorial-linux-firewall&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://phoenixnap.com/kb/iptables-tutorial-linux-firewall&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www&lt;/a&gt; .cnblogs.com/charlieroro/p/9588019.html&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/iptables/proxier.go&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/iptables/proxier.go&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.lijiaocn.com/%E9%&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.lijiaocn.com/%E9%&lt;/a&gt; A1%B9%E7%9B%AE/2017/03/27/Kubernetes-kube-proxy.html&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://juejin.im/post/6844904098605563912&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://juejin.im/post/6844904098605563912&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://tizeen.github.io/2019/03/19/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://tizeen.github.io/2019/03/19/&lt;/a&gt; kubernetes-service-iptables%E5%88%86%E6%9E%90/&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.hwchiu.com/kubernetes-service-ii.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.hwchiu.com/kubernetes-service-ii.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.hwchiu.com/kubernetes-service-iii&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.hwchiu.com/kubernetes-service-iii&lt;/a&gt; .html&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.itread01.com/content/1542712570.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.itread01.com/content/1542712570.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;来源：&lt;a href=&quot;https://jeff-yen.medium.com/iptables-proxy-mode-in-kube-proxy-6862bb4b329&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://jeff-yen.medium.com/iptables-proxy-mode-in-kube-proxy-6862bb4b329&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;最近在面试的时候问了不少 &lt;code&gt;network request&lt;/code&gt; 如何到 &lt;code&gt;k8s service backend&lt;/code&gt; 的问题，觉得可以整合一下网络上的资料，这篇主要讨论 &lt;code&gt;iptables proxy mode&lt;/code&gt;。大部分的情况没有在使用 &lt;code&gt;userspace proxy modes&lt;/code&gt;， &lt;code&gt;ipvs proxy mode&lt;/code&gt; 可能要等到下一次讨论。&lt;/p&gt;
    
    </summary>
    
      <category term="kuberntes" scheme="http://team.jiunile.com/categories/kuberntes/"/>
    
      <category term="kube-proxy" scheme="http://team.jiunile.com/categories/kuberntes/kube-proxy/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="iptables" scheme="http://team.jiunile.com/tags/iptables/"/>
    
      <category term="kube-proxy" scheme="http://team.jiunile.com/tags/kube-proxy/"/>
    
  </entry>
  
  <entry>
    <title>Go 多重错误管理</title>
    <link href="http://team.jiunile.com//blog/2020/11/go-multi-errors.html"/>
    <id>http://team.jiunile.com//blog/2020/11/go-multi-errors.html</id>
    <published>2020-11-19T14:00:00.000Z</published>
    <updated>2020-11-18T03:55:12.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;在&lt;a href=&quot;https://blog.golang.org/survey2019-results&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;年度调查&lt;/a&gt;中，关于开发人员在使用 Go 时面临的最大挑战，Go 中的错误管理总是容易引起争论，并且是一个反复出现的话题。然而，当涉及到在并发环境中处理错误或为同一个 &lt;code&gt;goroutine&lt;/code&gt; 合并多个错误时，Go 提供了很棒的包，使管理多个错误变得容易。让我们看看如何合并由单个 &lt;code&gt;goroutine&lt;/code&gt; 生成的多个错误。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;单个-goroutine-多个错误&quot;&gt;&lt;a href=&quot;#单个-goroutine-多个错误&quot; class=&quot;headerlink&quot; title=&quot;单个 goroutine, 多个错误&quot;&gt;&lt;/a&gt;单个 goroutine, 多个错误&lt;/h2&gt;&lt;p&gt;例如，当您处理具有重试策略的代码时，将多个错误合并为一个错误会非常有用。这是我们需要收集生成的错误的基本示例：&lt;br&gt;&lt;img src=&quot;/images/go/manage_muti_error_1.png&quot; alt=&quot;multiple errors&quot;&gt;&lt;/p&gt;
&lt;p&gt;这个程序读取和解析一个 CSV 文本，并显示发现的错误。将错误分组以获得完整的报告可能更方便。要将错误合并为一个，我们可以在两个很棒的包中进行选择：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用 &lt;a href=&quot;https://github.com/hashicorp&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;HashiCorp&lt;/a&gt; 的 &lt;a href=&quot;https://github.com/hashicorp/go-multierror&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;go-multierror&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/images/go/manage_muti_error_2.png&quot; alt=&quot;multiple errors&quot;&gt;&lt;/p&gt;
&lt;p&gt;输出结果如下：&lt;br&gt;&lt;img src=&quot;/images/go/manage_muti_error_3.png&quot; alt=&quot;multiple errors&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用 &lt;a href=&quot;https://github.com/uber-go&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Uber&lt;/a&gt; 的 &lt;a href=&quot;https://github.com/uber-go/multierr&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;multierr&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这里的实现类似，下面是输出:&lt;br&gt;&lt;img src=&quot;/images/go/manage_muti_error_4.png&quot; alt=&quot;multiple errors&quot;&gt;&lt;/p&gt;
&lt;p&gt;错误通过分号连接起来，没有任何其他格式。&lt;/p&gt;
&lt;p&gt;对于每个包的性能，下面是一个基准测试结论：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;name                    time/op         alloc/op        allocs/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;HashiCorpMultiErrors-4  6.01µs ± 1%     6.78kB ± 0%     77.0 ± 0%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;UberMultiErrors-4       9.26µs ± 1%     10.3kB ± 0%      126 ± 0%&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Uber 的实现稍微慢一些，消耗更多的内存。但是，这个包的设计目的是将收集到的错误分组在一起，而不是每次都附加它们。当对错误进行分组时，结果很接近，但是代码不够优雅，因为它需要额外的步骤。以下是最新的测试结果：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;name                    time/op         alloc/op        allocs/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;HashiCorpMultiErrors-4  6.01µs ± 1%     6.78kB ± 0%     77.0 ± 0%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;UberMultiErrors-4       6.02µs ± 1%     7.06kB ± 0%     77.0 ± 0%&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这两个包都利用了 Go &lt;code&gt;error&lt;/code&gt; 接口，并在其自定义实现中实现了 &lt;code&gt;Error() string&lt;/code&gt; 函数。&lt;/p&gt;
&lt;h2 id=&quot;单个错误-多个-goroutines&quot;&gt;&lt;a href=&quot;#单个错误-多个-goroutines&quot; class=&quot;headerlink&quot; title=&quot;单个错误, 多个 goroutines&quot;&gt;&lt;/a&gt;单个错误, 多个 goroutines&lt;/h2&gt;&lt;p&gt;当处理多个 &lt;code&gt;goroutines&lt;/code&gt; 来执行一个任务时，有必要正确管理结果和将错误聚合，以确保程序的正确性。&lt;/p&gt;
&lt;p&gt;让我们从一个使用多个 &lt;code&gt;goroutines&lt;/code&gt; 执行一系列操作的程序开始; 每个操作持续一秒钟:&lt;br&gt;&lt;img src=&quot;/images/go/manage_muti_error_5.png&quot; alt=&quot;multiple errors&quot;&gt;&lt;/p&gt;
&lt;p&gt;为了说明错误传播，第三个 &lt;code&gt;goroutine&lt;/code&gt; 的第一个操作将失败。事情是这样的:&lt;br&gt;&lt;img src=&quot;/images/go/manage_muti_error_6.png&quot; alt=&quot;multiple errors&quot;&gt;&lt;/p&gt;
&lt;p&gt;正如预期的那样，这个程序大约需要 3 秒，因为大多数 &lt;code&gt;goroutines&lt;/code&gt; 需要经历三个动作，每个动作需要 1 秒:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go run .  0.30s user 0.19s system 14% cpu 3.274 total&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是，我们可能希望使 &lt;code&gt;goroutines&lt;/code&gt; 相互依赖，并在其中一个失败时取消它们。避免不必要工作的解决方案是添加上下文，一旦 &lt;code&gt;goroutine&lt;/code&gt; 失败，它就会取消它:&lt;br&gt;&lt;img src=&quot;/images/go/manage_muti_error_7.png&quot; alt=&quot;multiple errors&quot;&gt;&lt;/p&gt;
&lt;p&gt;这正是 &lt;a href=&quot;https://pkg.go.dev/golang.org/x/sync/errgroup?tab=doc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;errgroup&lt;/a&gt; 所提供的;处理一组 &lt;code&gt;goroutines&lt;/code&gt; 时的错误和上下文传播。下面是使用包 &lt;a href=&quot;https://pkg.go.dev/golang.org/x/sync/errgroup?tab=doc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;errgroup&lt;/a&gt; 的新代码：&lt;br&gt;&lt;img src=&quot;/images/go/manage_muti_error_8.png&quot; alt=&quot;multiple errors&quot;&gt;&lt;/p&gt;
&lt;p&gt;程序现在运行得更快，因为它通过错误传播取消的上下文：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go run .  0.30s user 0.19s system 38% cpu 1.269 total&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;该包提供的另一个好处是，我们不需要再担心等待组添加和标记 &lt;code&gt;goroutines&lt;/code&gt; 完成。包为我们管理这些，我们只需要说我们准备好等待过程的结束。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
&lt;p&gt;译自：&lt;a href=&quot;https://medium.com/a-journey-with-go/go-multiple-errors-management-a67477628cf1&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://medium.com/a-journey-with-go/go-multiple-errors-management-a67477628cf1&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;在&lt;a href=&quot;https://blog.golang.org/survey2019-results&quot;&gt;年度调查&lt;/a&gt;中，关于开发人员在使用 Go 时面临的最大挑战，Go 中的错误管理总是容易引起争论，并且是一个反复出现的话题。然而，当涉及到在并发环境中处理错误或为同一个 &lt;code&gt;goroutine&lt;/code&gt; 合并多个错误时，Go 提供了很棒的包，使管理多个错误变得容易。让我们看看如何合并由单个 &lt;code&gt;goroutine&lt;/code&gt; 生成的多个错误。&lt;br&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="error" scheme="http://team.jiunile.com/categories/golang/error/"/>
    
    
      <category term="error" scheme="http://team.jiunile.com/tags/error/"/>
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="golang" scheme="http://team.jiunile.com/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Go chan 为啥没有判断 close 的接口</title>
    <link href="http://team.jiunile.com//blog/2020/11/go-chan-close.html"/>
    <id>http://team.jiunile.com//blog/2020/11/go-chan-close.html</id>
    <published>2020-11-16T14:00:00.000Z</published>
    <updated>2020-11-16T02:19:55.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;大纲&quot;&gt;&lt;a href=&quot;#大纲&quot; class=&quot;headerlink&quot; title=&quot;大纲&quot;&gt;&lt;/a&gt;大纲&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;Go 为什么没有判断 close 的接口？&lt;/li&gt;
&lt;li&gt;Go 关闭 channel 究竟做了什么？&lt;br&gt;  -&lt;code&gt;closechan&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;一个判断 chan 是否 close 的函数&lt;ul&gt;
&lt;li&gt;思考方法一：通过“写”chan 实现&lt;/li&gt;
&lt;li&gt;思考方法二：通过“读”chan 实现&lt;/li&gt;
&lt;li&gt;chan close 原则&lt;/li&gt;
&lt;li&gt;其实并不需要 &lt;code&gt;isChanClose&lt;/code&gt; 函数 !!!&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;怎么优雅关闭 chan ？&lt;ul&gt;
&lt;li&gt;方法一：panic-recover&lt;/li&gt;
&lt;li&gt;方法二：sync.Once&lt;/li&gt;
&lt;li&gt;方法三：事件同步来解决&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;总结&lt;/li&gt;
&lt;/ul&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;Go-为什么没有判断-close-的接口？&quot;&gt;&lt;a href=&quot;#Go-为什么没有判断-close-的接口？&quot; class=&quot;headerlink&quot; title=&quot;Go 为什么没有判断 close 的接口？&quot;&gt;&lt;/a&gt;Go 为什么没有判断 close 的接口？&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/images/go/chan_close_1.png&quot; alt=&quot;go channel close&quot;&gt;&lt;/p&gt;
&lt;p&gt;相信大家初学 golang chan 的时候应该都遇到过 “&lt;strong&gt;send on closed channel&lt;/strong&gt;“ 的 panic 。这个 panic 是当你意图往一个已经 close 的 channel 里面投递元素的时候触发。那么你当你第一次遇到这个问题是否想过 channel 是否能提供一个接口方法来判断是否已经 close 了？我想过这个问题，但是把 chan 的源代码翻了个遍没有找到。为什么？&lt;/p&gt;
&lt;p&gt;我先 hold 这个问题，我们捋一下跟 channel close 相关的事情，主要思考到 3 个问题：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;关闭 channel 究竟做了什么 ？&lt;/li&gt;
&lt;li&gt;怎么避免 close channel 导致的 panic 问题 ？&lt;/li&gt;
&lt;li&gt;怎么优雅的关闭 channel ？&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;Go-关闭-channel-究竟做了什么？&quot;&gt;&lt;a href=&quot;#Go-关闭-channel-究竟做了什么？&quot; class=&quot;headerlink&quot; title=&quot;Go 关闭 channel 究竟做了什么？&quot;&gt;&lt;/a&gt;Go 关闭 channel 究竟做了什么？&lt;/h2&gt;&lt;p&gt;首先，用户可以 close channel，如下：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;c := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;close&lt;/span&gt;(c)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;用 gdb 或者 delve 调试下就能发现 close 一个 channel，编译器会转换成 &lt;code&gt;closechan&lt;/code&gt; 函数，在这个函数里是关闭 channel 的全部实现了，我们可以分析下。&lt;/p&gt;
&lt;h3 id=&quot;closechan&quot;&gt;&lt;a href=&quot;#closechan&quot; class=&quot;headerlink&quot; title=&quot;closechan&quot;&gt;&lt;/a&gt;closechan&lt;/h3&gt;&lt;p&gt;对应编译函数为 &lt;code&gt;closechan&lt;/code&gt; ，该函数很简单，大概做 3 个事情：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;标志位置 1 ，也就是 &lt;code&gt;c.closed = 1&lt;/code&gt;；&lt;/li&gt;
&lt;li&gt;释放资源，唤醒所有等待取元素的协程；&lt;/li&gt;
&lt;li&gt;释放资源，唤醒所有等待写元素的协程；&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;closechan&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(c *hchan)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// 以下为锁内操作&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; lock(&amp;amp;c.lock)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// 不能重复 close 一个 channel，否则 panic&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; c.closed != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  unlock(&amp;amp;c.lock)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;panic&lt;/span&gt;(plainError(&lt;span class=&quot;string&quot;&gt;&quot;close of closed channel&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// closed 标志位置 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; c.closed = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; glist gList&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// 释放所有等待取元素的 waiter 资源&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 等待读的 waiter 出队&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  sg := c.recvq.dequeue()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 资源一个个销毁&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; sg.elem != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   typedmemclr(c.elemtype, sg.elem)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   sg.elem = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  gp := sg.g&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  gp.param = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//  相应 goroutine 加到统一队列，下面会统一唤醒&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  glist.push(gp)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// 释放所有等待写元素的 waiter 资源（他们之后将会 panic）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 等待写的 waiter 出队&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  sg := c.sendq.dequeue()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 资源一个个销毁&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  sg.elem = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  gp := sg.g&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  gp.param = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 对应 goroutine 加到统一队列，下面会统一唤醒&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  glist.push(gp)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; unlock(&amp;amp;c.lock)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// 唤醒所有的 waiter 对应的 goroutine （这个协程列表是上面 push 进来的）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; !glist.empty() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  gp := glist.pop()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  gp.schedlink = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  goready(gp, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过上面的代码逻辑，我们窥视到两个重要的信息：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;close chan 是有标识位的；&lt;/li&gt;
&lt;li&gt;close chan 是会唤醒哪些等待的人们的；&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;但是很奇怪的是，我们 golang 官方没有提供一个接口用于判断 chan 是否关闭？那我们能不能实现一个判断 chan 是否 close 的方法呢？&lt;/p&gt;
&lt;h2 id=&quot;一个判断-chan-是否-close-的函数&quot;&gt;&lt;a href=&quot;#一个判断-chan-是否-close-的函数&quot; class=&quot;headerlink&quot; title=&quot;一个判断 chan 是否 close 的函数&quot;&gt;&lt;/a&gt;一个判断 chan 是否 close 的函数&lt;/h2&gt;&lt;p&gt;怎么实现？首先 &lt;code&gt;isChanClose&lt;/code&gt; 函数有几点要求：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;能够指明确实是 close 的；&lt;/li&gt;
&lt;li&gt;任何时候能够正常运行，且有返回的（非阻塞）；&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;想想 &lt;code&gt;send&lt;/code&gt;, &lt;code&gt;recv&lt;/code&gt; 相关的函数，我们可以知道，当前 channel 给到用户的使用姿势本质上只有两种：读和写，我们实现的 &lt;code&gt;isChanClose&lt;/code&gt; 也只能在这个基础上做。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;写：&lt;code&gt;c &amp;lt;- x&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;读：&lt;code&gt;&amp;lt;-c&lt;/code&gt; 或 &lt;code&gt;v := &amp;lt;-c&lt;/code&gt; 或 &lt;code&gt;v, ok := &amp;lt;-c&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;思考方法一：通过“写”chan-实现&quot;&gt;&lt;a href=&quot;#思考方法一：通过“写”chan-实现&quot; class=&quot;headerlink&quot; title=&quot;思考方法一：通过“写”chan 实现&quot;&gt;&lt;/a&gt;思考方法一：通过“写”chan 实现&lt;/h3&gt;&lt;p&gt;“写”肯定不能作为判断，总不能为了判断 chan 是否 close，我尝试往里面写数据吧？这个会导致 &lt;code&gt;chansend&lt;/code&gt; 里面直接 panic 的，如下：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;chansend&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(c *hchan, ep unsafe.Pointer, block &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;, callerpc &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;bool&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//  ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 当 channel close 之后的处理逻辑&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; c.closed != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            unlock(&amp;amp;c.lock)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;panic&lt;/span&gt;(plainError(&lt;span class=&quot;string&quot;&gt;&quot;send on closed channel&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//  ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;当然了，你路子要是野一点，这样做技术上也能实现，因为 panic 是可以捕捉的，只不过这也太野了吧，不推荐。&lt;/p&gt;
&lt;h3 id=&quot;思考方法二：通过“读”chan-实现&quot;&gt;&lt;a href=&quot;#思考方法二：通过“读”chan-实现&quot; class=&quot;headerlink&quot; title=&quot;思考方法二：通过“读”chan 实现&quot;&gt;&lt;/a&gt;思考方法二：通过“读”chan 实现&lt;/h3&gt;&lt;p&gt;“读”来判断。分析函数 &lt;code&gt;chanrecv&lt;/code&gt; 可以知道，当尝试从一个已经 close 的 chan 读数据的时候，返回 （selected=true, received=false），我们通过 received = false 即可知道 channel 是否 close 。&lt;code&gt;chanrecv&lt;/code&gt; 有如下代码：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;chanrecv&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(c *hchan, ep unsafe.Pointer, block &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(selected, received &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 当 channel close 之后的处理逻辑&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; c.closed != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; c.qcount == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  unlock(&amp;amp;c.lock)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ep != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   typedmemclr(c.elemtype, ep)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;所以，我们现在知道了，可以通过 “读”的效果来判断，但是我们不能直接写成这样：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 错误示例&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;isChanClose&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(ch &lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;bool&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _, ok := &amp;lt;- c&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;上面是个&lt;strong&gt;错误示例&lt;/strong&gt;，因为 &lt;code&gt;_, ok := &amp;lt;-c&lt;/code&gt; 编译出来的是 &lt;code&gt;chanrecv2&lt;/code&gt; ，这个函数 block 赋值 true 传入的，所以当 c 是正常的时候，这里是阻塞的，所以这个不能用来作为一个正常的函数调用，因为会卡死协程，怎么解决这个问题？用 &lt;code&gt;select&lt;/code&gt;  和 &lt;code&gt;&amp;lt;-chan&lt;/code&gt;  来结合可以解决这个问题，&lt;code&gt;select&lt;/code&gt; 和 &lt;code&gt;&amp;lt;-chan&lt;/code&gt; 结合起来是对应 &lt;code&gt;selectnbrecv&lt;/code&gt;  和 &lt;code&gt;selectnbrecv2&lt;/code&gt; 这两个函数，这两个函数是非阻塞的（ &lt;code&gt;block = false&lt;/code&gt; ）。&lt;/p&gt;
&lt;p&gt;正确示例：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;isChanClose&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(ch &lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;bool&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;select&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; _, received := &amp;lt;- ch:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; !received&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;网上很多人举了一个 &lt;code&gt;isChanClose&lt;/code&gt; 错误的例子，错误示例：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;isChanClose&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(ch &lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;bool&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;select&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt;  &amp;lt;- ch:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;思考下：为什么第一个例子是对的，第二个例子是错的？&lt;/p&gt;
&lt;p&gt;因为，第一个例子编译出来对应的函数是 &lt;code&gt;selectnbrecv2&lt;/code&gt; ，第二个例子编译出来对应的是 &lt;code&gt;selectnbrecv1&lt;/code&gt; ，这两个函数的区别在于 &lt;code&gt;selectnbrecv2&lt;/code&gt; 多了一个返回参数 &lt;code&gt;received&lt;/code&gt;，只有这个函数才能指明是否元素出队成功，而 &lt;code&gt;selected&lt;/code&gt; 只是判断是否要进到 select case 分支。我们通过 &lt;code&gt;received&lt;/code&gt; 这个返回值（其实是一个入参，只不过是指针类型，函数内可修改）来反向推断 chan 是否 close 了。&lt;/p&gt;
&lt;h4 id=&quot;小结：&quot;&gt;&lt;a href=&quot;#小结：&quot; class=&quot;headerlink&quot; title=&quot;小结：&quot;&gt;&lt;/a&gt;小结：&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;case 的代码必须是 &lt;code&gt;_, received := &amp;lt;- ch&lt;/code&gt; 的形式，如果仅仅是 &lt;code&gt;&amp;lt;- ch&lt;/code&gt; 来判断，是错的逻辑，因为我们关注的是 &lt;code&gt;received&lt;/code&gt; 的值；&lt;/li&gt;
&lt;li&gt;select 必须要有 default 分支，否则会阻塞函数，我们这个函数要保证一定能正常返回；&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;chan-close-原则&quot;&gt;&lt;a href=&quot;#chan-close-原则&quot; class=&quot;headerlink&quot; title=&quot;chan close 原则&quot;&gt;&lt;/a&gt;chan close 原则&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;永远不要尝试在读取端关闭 channel ，写入端无法知道 channel 是否已经关闭，往已关闭的 channel 写数据会 panic ；&lt;/li&gt;
&lt;li&gt;一个写入端，在这个写入端可以放心关闭 channel；&lt;/li&gt;
&lt;li&gt;多个写入端时，不要在写入端关闭 channel ，其他写入端无法知道 channel 是否已经关闭，关闭已经关闭的 channel 会发生 panic （你要想个办法保证只有一个人调用 close）；&lt;/li&gt;
&lt;li&gt;channel 作为函数参数的时候，最好带方向；&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;其实这些原则只有一点：一定要是安全的是否才能去 close channel 。&lt;/p&gt;
&lt;h3 id=&quot;其实并不需要-isChanClose-函数&quot;&gt;&lt;a href=&quot;#其实并不需要-isChanClose-函数&quot; class=&quot;headerlink&quot; title=&quot;其实并不需要 isChanClose 函数 !!!&quot;&gt;&lt;/a&gt;其实并不需要 isChanClose 函数 !!!&lt;/h3&gt;&lt;p&gt;上面实现的 &lt;code&gt;isChanClose&lt;/code&gt; 是可以判断出 channel 是否 close，但是适用场景优先，因为可能等你 &lt;code&gt;isChanClose&lt;/code&gt; 判断的时候返回值 false，你以为 channel 还是正常的，但是下一刻 channel 被关闭了，这个时候往里面“写”数据就又会 panic ，如下：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; isChanClose( c ) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 关闭的场景，exit  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 未关闭的场景，继续执行（可能还是会 panic）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;c &amp;lt;- x&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;因为判断之后还是有时间窗，所以 &lt;code&gt;isChanClose&lt;/code&gt; 的适用还是有限，那么是否有更好的办法？&lt;/p&gt;
&lt;p&gt;我们换一个思路，你其实并不是一定要判断 channel 是否 close，真正的目的是：&lt;strong&gt;安全的使用 channel，避免使用到已经关闭的 closed channel，从而导致 panic&lt;/strong&gt; 。&lt;/p&gt;
&lt;p&gt;这个问题的本质上是保证一个事件的时序，官方推荐通过 &lt;code&gt;context&lt;/code&gt; 来配合使用，我们可以通过一个 ctx 变量来指明 close 事件，而不是直接去判断 channel 的一个状态。举个栗子：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;select&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &amp;lt;-ctx.Done():&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ... exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; v, ok := &amp;lt;-c:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// do something....&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// do default ....&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ctx.Done()&lt;/code&gt; 事件发生之后，我们就明确不去读 channel 的数据。&lt;/p&gt;
&lt;p&gt;或者&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;select&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &amp;lt;-ctx.Done():&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ... exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// push &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    c &amp;lt;- x&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ctx.Done()&lt;/code&gt; 事件发生之后，我们就明确不写数据到 channel ，或者不从 channel 里读数据，那么保证这个时序即可。就一定不会有问题。&lt;/p&gt;
&lt;p&gt;我们只需要确保一点：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;触发时序保证：一定要先触发 ctx.Done() 事件，再去做 close channel 的操作，保证这个时序的才能保证 select 判断的时候没有问题；&lt;br&gt; a. 只有这个时序，才能保证在获悉到 Done 事件的时候，一切还是安全的；&lt;/li&gt;
&lt;li&gt;条件判断顺序：select 的 case 先判断 ctx.Done() 事件，这个很重要哦，否则很有可能先执行了 chan 的操作从而导致 panic 问题；&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;怎么优雅关闭-chan-？&quot;&gt;&lt;a href=&quot;#怎么优雅关闭-chan-？&quot; class=&quot;headerlink&quot; title=&quot;怎么优雅关闭 chan ？&quot;&gt;&lt;/a&gt;怎么优雅关闭 chan ？&lt;/h2&gt;&lt;h3 id=&quot;方法一：panic-recover&quot;&gt;&lt;a href=&quot;#方法一：panic-recover&quot; class=&quot;headerlink&quot; title=&quot;方法一：panic-recover&quot;&gt;&lt;/a&gt;方法一：panic-recover&lt;/h3&gt;&lt;p&gt;关闭一个 channel 直接调用 close 即可，但是关闭一个已经关闭的 channel 会导致 panic，怎么办？panic-recover 配合使用即可。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;SafeClose&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(ch &lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(closed &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;recover&lt;/span&gt;() != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   closed = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// 如果 ch 是一个已经关闭的，会 panic 的，然后被 recover 捕捉到；&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;built_in&quot;&gt;close&lt;/span&gt;(ch)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这并不优雅。&lt;/p&gt;
&lt;h3 id=&quot;方法二：sync-Once&quot;&gt;&lt;a href=&quot;#方法二：sync-Once&quot; class=&quot;headerlink&quot; title=&quot;方法二：sync.Once&quot;&gt;&lt;/a&gt;方法二：sync.Once&lt;/h3&gt;&lt;p&gt;可以使用 &lt;code&gt;sync.Once&lt;/code&gt; 来确保 &lt;code&gt;close&lt;/code&gt; 只执行一次。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; ChanMgr &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; C    &lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; once sync.Once&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;NewChanMgr&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;ChanMgr&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &amp;amp;ChanMgr&amp;#123;C: &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(cm *ChanMgr)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;SafeClose&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; cm.once.Do(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123; &lt;span class=&quot;built_in&quot;&gt;close&lt;/span&gt;(cm.C) &amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这看着还可以。&lt;/p&gt;
&lt;h3 id=&quot;方法三：事件同步来解决&quot;&gt;&lt;a href=&quot;#方法三：事件同步来解决&quot; class=&quot;headerlink&quot; title=&quot;方法三：事件同步来解决&quot;&gt;&lt;/a&gt;方法三：事件同步来解决&lt;/h3&gt;&lt;p&gt;对于关闭 channel 这个我们有两个简要的原则：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;永远不要尝试在读端关闭 channel ；&lt;/li&gt;
&lt;li&gt;永远只允许一个 goroutine（比如，只用来执行关闭操作的一个 goroutine ）执行关闭操作；&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;可以使用 &lt;code&gt;sync.WaitGroup&lt;/code&gt; 来同步这个关闭事件，遵守以上的原则，举几个例子：&lt;/p&gt;
&lt;h4 id=&quot;第一个例子：一个-sender&quot;&gt;&lt;a href=&quot;#第一个例子：一个-sender&quot; class=&quot;headerlink&quot; title=&quot;第一个例子：一个 sender&quot;&gt;&lt;/a&gt;第一个例子：一个 sender&lt;/h4&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;sync&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// channel 初始化&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; c := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// 用来 recevivers 同步事件的&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; wg := sync.WaitGroup&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// sender（写端）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 入队&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  c &amp;lt;- &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 满足某些情况，则 close channel&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;close&lt;/span&gt;(c)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// receivers （读端）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  wg.Add(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; wg.Done()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;// ... 处理 channel 里的数据&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; v := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; c &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _ = v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// 等待所有的 receivers 完成；&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; wg.Wait()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里例子里面，我们在 sender 的 goroutine 关闭 channel，因为只有一个 sender，所以关闭自然是安全的。receiver 使用 &lt;code&gt;WaitGroup&lt;/code&gt; 来同步事件，receiver 的 for 循环只有在 channel close 之后才会退出，主协程的 &lt;code&gt;wg.Wait()&lt;/code&gt; 语句只有所有的 receivers 都完成才会返回。所以，事件的顺序是：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;写端入队一个整形元素&lt;/li&gt;
&lt;li&gt;关闭 channel&lt;/li&gt;
&lt;li&gt;所有的读端安全退出&lt;/li&gt;
&lt;li&gt;主协程返回&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;一切都是安全的&lt;/p&gt;
&lt;h4 id=&quot;第二个例子：多个-sender&quot;&gt;&lt;a href=&quot;#第二个例子：多个-sender&quot; class=&quot;headerlink&quot; title=&quot;第二个例子：多个 sender&quot;&gt;&lt;/a&gt;第二个例子：多个 sender&lt;/h4&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;string&quot;&gt;&quot;context&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;string&quot;&gt;&quot;sync&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;string&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// channel 初始化&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; c := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// 用来 recevivers 同步事件的&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; wg := sync.WaitGroup&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// 上下文&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; ctx, cancel := context.WithCancel(context.TODO())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// 专门关闭的协程&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  time.Sleep(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; * time.Second)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  cancel()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// ... 某种条件下，关闭 channel&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;close&lt;/span&gt;(c)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// senders（写端）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(ctx context.Context, id &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;select&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &amp;lt;-ctx.Done():&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; c &amp;lt;- id: &lt;span class=&quot;comment&quot;&gt;// 入队&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;(ctx, i)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// receivers（读端）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  wg.Add(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; wg.Done()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;// ... 处理 channel 里的数据&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; v := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; c &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _ = v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// 等待所有的 receivers 完成；&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; wg.Wait()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个例子我们看到有多个 sender 和 receiver ，这种情况我们还是要保证一点：close(ch) 操作的只能有一个人，我们单独抽出来一个 goroutine 来做这个事情，并且使用 context 来做事件同步，事件发生顺序是：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;10 个写端协程（sender）运行，投递元素；&lt;/li&gt;
&lt;li&gt;10 个读端协程（receiver）运行，读取元素；&lt;/li&gt;
&lt;li&gt;2 分钟超时之后，单独协程执行 &lt;code&gt;close(channel)&lt;/code&gt; 操作；&lt;/li&gt;
&lt;li&gt;主协程返回；&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;一切都是安全的。&lt;/p&gt;
&lt;h2 id=&quot;总结&quot;&gt;&lt;a href=&quot;#总结&quot; class=&quot;headerlink&quot; title=&quot;总结&quot;&gt;&lt;/a&gt;总结&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;channel 并没有直接提供判断是否 close 的接口，官方推荐使用 context 和 select 语法配合使用，事件通知的方式，达到优雅判断 channel 关闭的效果；&lt;/li&gt;
&lt;li&gt;channel 关闭姿势也有讲究，永远不要尝试在读端关闭，永远保持一个关闭入口处，使用 sync.WaitGroup 和 context 实现事件同步，达到优雅关闭效果；&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;作者：奇伢   来源：奇伢云存储&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;大纲&quot;&gt;&lt;a href=&quot;#大纲&quot; class=&quot;headerlink&quot; title=&quot;大纲&quot;&gt;&lt;/a&gt;大纲&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;Go 为什么没有判断 close 的接口？&lt;/li&gt;
&lt;li&gt;Go 关闭 channel 究竟做了什么？&lt;br&gt;  -&lt;code&gt;closechan&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;一个判断 chan 是否 close 的函数&lt;ul&gt;
&lt;li&gt;思考方法一：通过“写”chan 实现&lt;/li&gt;
&lt;li&gt;思考方法二：通过“读”chan 实现&lt;/li&gt;
&lt;li&gt;chan close 原则&lt;/li&gt;
&lt;li&gt;其实并不需要 &lt;code&gt;isChanClose&lt;/code&gt; 函数 !!!&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;怎么优雅关闭 chan ？&lt;ul&gt;
&lt;li&gt;方法一：panic-recover&lt;/li&gt;
&lt;li&gt;方法二：sync.Once&lt;/li&gt;
&lt;li&gt;方法三：事件同步来解决&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;总结&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="channel" scheme="http://team.jiunile.com/categories/golang/channel/"/>
    
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="closechan" scheme="http://team.jiunile.com/tags/closechan/"/>
    
  </entry>
  
  <entry>
    <title>Go Sync.Pool 背后的想法</title>
    <link href="http://team.jiunile.com//blog/2020/11/go-sync-pool.html"/>
    <id>http://team.jiunile.com//blog/2020/11/go-sync-pool.html</id>
    <published>2020-11-14T14:00:00.000Z</published>
    <updated>2020-11-13T09:45:15.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;我最近在我的一个项目中遇到了垃圾回收问题。大量对象被重复分配，并导致 GC 的巨大工作量。使用 &lt;code&gt;sync.Pool&lt;/code&gt;，我能够减少分配和 GC 工作负载。&lt;/p&gt;
&lt;h2 id=&quot;什么是-sync-Pool？&quot;&gt;&lt;a href=&quot;#什么是-sync-Pool？&quot; class=&quot;headerlink&quot; title=&quot;什么是 sync.Pool？&quot;&gt;&lt;/a&gt;什么是 sync.Pool？&lt;/h2&gt;&lt;p&gt;Go 1.3 版本的亮点之一是同步池。它是 &lt;code&gt;sync&lt;/code&gt; 包下的一个组件，用于创建自我管理的临时检索对象池。&lt;/p&gt;
&lt;h2 id=&quot;为什么要使用-sync-Pool？&quot;&gt;&lt;a href=&quot;#为什么要使用-sync-Pool？&quot; class=&quot;headerlink&quot; title=&quot;为什么要使用 sync.Pool？&quot;&gt;&lt;/a&gt;为什么要使用 sync.Pool？&lt;/h2&gt;&lt;p&gt;我们希望尽可能减少 GC 开销。频繁的内存分配和回收会给 GC 带来沉重的负担。&lt;code&gt;sync.Poll&lt;/code&gt; 可以缓存暂时不使用的对象，并在下次需要时直接使用它们（无需重新分配）。这可能会减少 GC 工作负载并提高性能。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;怎么使用-sync-Pool？&quot;&gt;&lt;a href=&quot;#怎么使用-sync-Pool？&quot; class=&quot;headerlink&quot; title=&quot;怎么使用 sync.Pool？&quot;&gt;&lt;/a&gt;怎么使用 sync.Pool？&lt;/h2&gt;&lt;p&gt;首先，您需要设置新函数。当池中没有缓存对象时将使用此函数。之后，您只需要使用 &lt;code&gt;Get&lt;/code&gt; 和 &lt;code&gt;Put&lt;/code&gt; 方法来检索和返回对象。另外，池在第一次使用后绝对不能复制。&lt;/p&gt;
&lt;p&gt;由于 &lt;code&gt;New&lt;/code&gt; 函数类型是 &lt;code&gt;func() interface{}&lt;/code&gt;，&lt;code&gt;Get&lt;/code&gt; 方法返回一个 &lt;code&gt;interface{}&lt;/code&gt;。为了得到具体对象，你需要做一个类型断言。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// A dummy struct&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; Person &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Name &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Initializing pool&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; personPool = sync.Pool&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// New optionally specifies a function to generate&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// a value when Get would otherwise return nil.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	New: &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;interface&lt;/span&gt;&lt;/span&gt;&amp;#123;&amp;#125; &amp;#123; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;new&lt;/span&gt;(Person) &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Main function&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// Get hold of an instance&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	newPerson := personPool.Get().(*Person)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// Defer release function&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// After that the same instance is &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// reusable by another routine&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; personPool.Put(newPerson)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// Using the instance&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	newPerson.Name = &lt;span class=&quot;string&quot;&gt;&quot;Jack&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;基准测试&quot;&gt;&lt;a href=&quot;#基准测试&quot; class=&quot;headerlink&quot; title=&quot;基准测试&quot;&gt;&lt;/a&gt;基准测试&lt;/h2&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; Person &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Age &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; personPool = sync.Pool&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	New: &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;interface&lt;/span&gt;&lt;/span&gt;&amp;#123;&amp;#125; &amp;#123; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;new&lt;/span&gt;(Person) &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BenchmarkWithoutPool&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(b *testing.B)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; p *Person&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	b.ReportAllocs()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	b.ResetTimer()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; b.N; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; j := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; j &amp;lt; &lt;span class=&quot;number&quot;&gt;10000&lt;/span&gt;; j++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			p = &lt;span class=&quot;built_in&quot;&gt;new&lt;/span&gt;(Person)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			p.Age = &lt;span class=&quot;number&quot;&gt;23&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BenchmarkWithPool&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(b *testing.B)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; p *Person&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	b.ReportAllocs()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	b.ResetTimer()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; b.N; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; j := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; j &amp;lt; &lt;span class=&quot;number&quot;&gt;10000&lt;/span&gt;; j++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			p = personPool.Get().(*Person)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			p.Age = &lt;span class=&quot;number&quot;&gt;23&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			personPool.Put(p)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;测试结果：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;BenchmarkWithoutPool&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BenchmarkWithoutPool-8   160698 ns/op   80001 B/op   10000 allocs/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BenchmarkWithPool&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BenchmarkWithPool-8      191163 ns/op       0 B/op       0 allocs/op&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;权衡&quot;&gt;&lt;a href=&quot;#权衡&quot; class=&quot;headerlink&quot; title=&quot;权衡&quot;&gt;&lt;/a&gt;权衡&lt;/h2&gt;&lt;p&gt;生活中的一切都是一种权衡。池也有它的性能成本。使用 &lt;code&gt;sync.Pool&lt;/code&gt; 比简单的初始化要慢得多。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BenchmarkPool&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(b *testing.B)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; p sync.Pool&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	b.RunParallel(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(pb *testing.PB)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; pb.Next() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			p.Put(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			p.Get()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BenchmarkAllocation&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(b *testing.B)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	b.RunParallel(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(pb *testing.PB)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; pb.Next() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			i = i&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;压测结果：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;BenchmarkPool&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BenchmarkPool-8           283395016          4.40 ns/op&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BenchmarkAllocation&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BenchmarkAllocation-8    1000000000         0.344 ns/op&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;sync-Pool-是如何工作的？&quot;&gt;&lt;a href=&quot;#sync-Pool-是如何工作的？&quot; class=&quot;headerlink&quot; title=&quot;sync.Pool 是如何工作的？&quot;&gt;&lt;/a&gt;sync.Pool 是如何工作的？&lt;/h2&gt;&lt;p&gt;&lt;code&gt;sync.Pool&lt;/code&gt; 有两个对象容器: 本地池 (活动) 和受害者缓存 (存档)。&lt;/p&gt;
&lt;p&gt;根据 &lt;code&gt;sync/pool.go&lt;/code&gt; ，包 &lt;code&gt;init&lt;/code&gt; 函数作为清理池的方法&lt;a href=&quot;https://golang.org/src/sync/pool.go?s=8003:8060#L271&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;注册到运行时&lt;/a&gt;。此方法将由 GC 触发。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   runtime_registerPoolCleanup(poolCleanup)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;当 GC 被触发时，受害者缓存中的对象将被收集，然后本地池中的对象将被移动到受害者缓存中。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;poolCleanup&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;// Drop victim caches from all pools.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; _, p := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; oldPools &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      p.victim = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      p.victimSize = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;// Move primary cache to victim cache.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; _, p := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; allPools &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      p.victim = p.local&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      p.victimSize = p.localSize&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      p.local = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      p.localSize = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   oldPools, allPools = allPools, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;新对象被放入本地池中。调用 &lt;code&gt;Put&lt;/code&gt; 方法也会将对象放入本地池中。调用 &lt;code&gt;Get&lt;/code&gt; 方法将首先从受害者缓存中获取对象，如果受害者缓存为空，则对象将从本地池中获取。&lt;br&gt;&lt;img src=&quot;/images/go/syncpool_1.gif&quot; alt=&quot;sync.Pool localPool and victimCache&quot;&gt;&lt;/p&gt;
&lt;p&gt;供你参考，Go 1.12 sync.pool 实现使用基于 &lt;code&gt;mutex&lt;/code&gt; 的锁，用于来自多个 Goroutines 的线程安全操作。Go 1.13 &lt;a href=&quot;https://github.com/golang/go/commit/d5fd2dd6a17a816b7dfd99d4df70a85f1bf0de31#diff-491b0013c82345bf6cfa937bd78b690d&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;引入了一个双链表&lt;/a&gt;作为共享池，它删除了 &lt;code&gt;mutex&lt;/code&gt; 并改善了共享访问。&lt;/p&gt;
&lt;h2 id=&quot;结论&quot;&gt;&lt;a href=&quot;#结论&quot; class=&quot;headerlink&quot; title=&quot;结论&quot;&gt;&lt;/a&gt;结论&lt;/h2&gt;&lt;p&gt;当有一个昂贵的对象需要频繁创建时，使用 &lt;code&gt;sync.Pool&lt;/code&gt; 是非常有益的。&lt;/p&gt;
&lt;p&gt;译自：&lt;a href=&quot;https://medium.com/swlh/go-the-idea-behind-sync-pool-32da5089df72&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://medium.com/swlh/go-the-idea-behind-sync-pool-32da5089df72&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;我最近在我的一个项目中遇到了垃圾回收问题。大量对象被重复分配，并导致 GC 的巨大工作量。使用 &lt;code&gt;sync.Pool&lt;/code&gt;，我能够减少分配和 GC 工作负载。&lt;/p&gt;
&lt;h2 id=&quot;什么是-sync-Pool？&quot;&gt;&lt;a href=&quot;#什么是-sync-Pool？&quot; class=&quot;headerlink&quot; title=&quot;什么是 sync.Pool？&quot;&gt;&lt;/a&gt;什么是 sync.Pool？&lt;/h2&gt;&lt;p&gt;Go 1.3 版本的亮点之一是同步池。它是 &lt;code&gt;sync&lt;/code&gt; 包下的一个组件，用于创建自我管理的临时检索对象池。&lt;/p&gt;
&lt;h2 id=&quot;为什么要使用-sync-Pool？&quot;&gt;&lt;a href=&quot;#为什么要使用-sync-Pool？&quot; class=&quot;headerlink&quot; title=&quot;为什么要使用 sync.Pool？&quot;&gt;&lt;/a&gt;为什么要使用 sync.Pool？&lt;/h2&gt;&lt;p&gt;我们希望尽可能减少 GC 开销。频繁的内存分配和回收会给 GC 带来沉重的负担。&lt;code&gt;sync.Poll&lt;/code&gt; 可以缓存暂时不使用的对象，并在下次需要时直接使用它们（无需重新分配）。这可能会减少 GC 工作负载并提高性能。&lt;br&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="sync" scheme="http://team.jiunile.com/categories/golang/sync/"/>
    
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="sync.poll" scheme="http://team.jiunile.com/tags/sync-poll/"/>
    
      <category term="连接池" scheme="http://team.jiunile.com/tags/%E8%BF%9E%E6%8E%A5%E6%B1%A0/"/>
    
  </entry>
  
  <entry>
    <title>我在 Go 中犯了 5 个错误</title>
    <link href="http://team.jiunile.com//blog/2020/11/go-5-mistakes.html"/>
    <id>http://team.jiunile.com//blog/2020/11/go-5-mistakes.html</id>
    <published>2020-11-13T14:00:00.000Z</published>
    <updated>2020-11-13T04:58:39.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;人皆犯错，宽恕是德   — Alexander Pope&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这些都是我在写 Go 中犯的错误。尽管这些可能不会导致任何类型的错误，但它们可能会潜在地影响软件。&lt;/p&gt;
&lt;h2 id=&quot;1-内循环&quot;&gt;&lt;a href=&quot;#1-内循环&quot; class=&quot;headerlink&quot; title=&quot;1 内循环&quot;&gt;&lt;/a&gt;1 内循环&lt;/h2&gt;&lt;p&gt;有几种方法可以造成循环内部的混乱，你需要注意。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;1-1-使用引用循环迭代变量&quot;&gt;&lt;a href=&quot;#1-1-使用引用循环迭代变量&quot; class=&quot;headerlink&quot; title=&quot;1.1 使用引用循环迭代变量&quot;&gt;&lt;/a&gt;1.1 使用引用循环迭代变量&lt;/h3&gt;&lt;p&gt;由于效率的原因，循环迭代变量是单个变量，在每次循环迭代中采用不同的值。这可能会导致不知情的行为。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;in := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; out []*&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;  _, v := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; in &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	out = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(out, &amp;amp;v)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;Values:&quot;&lt;/span&gt;, *out[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;], *out[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;], *out[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;Addresses:&quot;&lt;/span&gt;, out[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;], out[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;], out[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;结果将是：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Values: 3 3 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Addresses: 0xc000014188 0xc000014188 0xc000014188&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;正如你所看到的，&lt;code&gt;out&lt;/code&gt; 切片中的所有元素都是 3。实际上，实际上很容易解释为什么会发生这种情况：在每次迭代中，我们都会将 &lt;code&gt;v&lt;/code&gt; 的地址附加到 &lt;code&gt;out&lt;/code&gt; 切片中。如前所述，&lt;code&gt;v&lt;/code&gt; 是在每次迭代中接受新值的单个变量。因此，正如您在输出的第二行中看到的，地址是相同的，并且所有地址都指向相同的值。&lt;/p&gt;
&lt;p&gt;简单的解决方法是将循环迭代器变量复制到新变量中：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;in := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; out []*&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;  _, v := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; in &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	v := v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	out = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(out, &amp;amp;v)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;Values:&quot;&lt;/span&gt;, *out[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;], *out[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;], *out[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;Addresses:&quot;&lt;/span&gt;, out[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;], out[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;], out[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;新的输出：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Values: 1 2 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Addresses: 0xc0000b6010 0xc0000b6018 0xc0000b6020&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;同样的问题可以找到正在 Goroutine 中使用的循环迭代变量。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;list := []&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&amp;#123;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; _, v := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; list &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		fmt.Printf(&lt;span class=&quot;string&quot;&gt;&quot;%d &quot;&lt;/span&gt;, v)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;结果将是：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;3 3 3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;它可以使用上面提到的相同的解决方案来修复。注意，如果不使用 Goroutine 运行该函数，代码将按照预期运行。&lt;/p&gt;
&lt;h3 id=&quot;1-2-在循环中调用-WaitGroup-Wait&quot;&gt;&lt;a href=&quot;#1-2-在循环中调用-WaitGroup-Wait&quot; class=&quot;headerlink&quot; title=&quot;1.2 在循环中调用 WaitGroup.Wait&quot;&gt;&lt;/a&gt;1.2 在循环中调用 WaitGroup.Wait&lt;/h3&gt;&lt;p&gt;使用 &lt;code&gt;WaitGroup&lt;/code&gt; 类型的共享变量会犯此错误，如下面的代码所示，当第 5 行的 &lt;code&gt;Done()&lt;/code&gt; 被调用 &lt;code&gt;len(tasks)&lt;/code&gt; 次数时，第 7 行的 &lt;code&gt;Wait()&lt;/code&gt; 只能被解除阻塞，因为它被用作参数在第 2 行调用 &lt;code&gt;Add()&lt;/code&gt;。但是，&lt;code&gt;Wait()&lt;/code&gt; 在循环中被调用，因此在下一个迭代中，它会阻止在第 4 行创建 Goroutine。简单的解决方案是将 &lt;code&gt;Wait()&lt;/code&gt; 的调用移出循环。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; wg sync.WaitGroup&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;wg.Add(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(tasks))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; _, t := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; tasks &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(t *task)&lt;/span&gt;&lt;/span&gt; &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; group.Done()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;(t)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// group.Wait()&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;group.Wait()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;1-3-在循环中使用-defer&quot;&gt;&lt;a href=&quot;#1-3-在循环中使用-defer&quot; class=&quot;headerlink&quot; title=&quot;1.3 在循环中使用 defer&quot;&gt;&lt;/a&gt;1.3 在循环中使用 defer&lt;/h3&gt;&lt;p&gt;&lt;code&gt;defer&lt;/code&gt; 直到函数返回才执行。除非你确定你在做什么，否则你不应该在循环中使用 &lt;code&gt;defer&lt;/code&gt;。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; mutex sync.Mutex&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; Person &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Age &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;persons := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]Person, &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; _, p := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; persons &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	mutex.Lock()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// defer mutex.Unlock()&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	p.Age = &lt;span class=&quot;number&quot;&gt;13&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	mutex.Unlock()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在上面的例子中，如果你使用第 8 行而不是第 10 行，下一次迭代就不能持有互斥锁，因为锁已经在使用中，并且循环永远阻塞。&lt;/p&gt;
&lt;p&gt;如果你真的需要使用 defer 内循环，你可能想委托另一个函数来做这项工作。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; mutex sync.Mutex&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; Person &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Age &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;persons := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]Person, &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; _, p := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; persons &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		mutex.Lock()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; mutex.Unlock()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		p.Age = &lt;span class=&quot;number&quot;&gt;13&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是，有时使用 &lt;code&gt;defer&lt;/code&gt; 在循环可能会变得很方便。所以你真的需要知道你在做什么。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Go 不能容忍愚蠢者&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;2-发送到一个无保证的-channel&quot;&gt;&lt;a href=&quot;#2-发送到一个无保证的-channel&quot; class=&quot;headerlink&quot; title=&quot;2 发送到一个无保证的 channel&quot;&gt;&lt;/a&gt;2 发送到一个无保证的 channel&lt;/h2&gt;&lt;p&gt;您可以将值从一个 Goroutine 发送到 channels，并将这些值接收到另一个 Goroutine。默认情况下，发送和接收，直到另一方准备好。这允许 Goroutines 在没有显式锁或条件变量的情况下进行同步。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;doReq&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(timeout time.Duration)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;obj&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// ch :=make(chan obj)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	ch := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; obj, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		obj := do()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		ch &amp;lt;- result&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125; ()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;select&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; result = &amp;lt;- ch :&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; result&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt;&amp;lt;- time.After(timeout):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;让我们检查一下上面的代码。&lt;code&gt;doReq&lt;/code&gt; 函数在第 4 行创建一个子 Goroutine 来处理请求，这在Go服务程序中是一种常见的做法。子 Goroutine 执行 &lt;code&gt;do&lt;/code&gt; 函数并通过第 6 行通道 &lt;code&gt;ch&lt;/code&gt; 将结果发送回父节点。子进程会在第 6 行阻塞，直到父进程在第 9 行接收到 &lt;code&gt;ch&lt;/code&gt; 的结果。同时，父进程将阻塞 &lt;code&gt;select&lt;/code&gt;，直到子进程将结果发送给 &lt;code&gt;ch&lt;/code&gt;（第9行）或发生超时（第11行）。如果超时发生在更早的时候，父函数将从第 12 行 &lt;code&gt;doReq&lt;/code&gt; 方法返回，并且没有人可以再接收 &lt;code&gt;ch&lt;/code&gt; 的结果，这将导致子函数永远被阻塞。解决方案是将 &lt;code&gt;ch&lt;/code&gt; 从无缓冲通道更改为缓冲通道，这样即使父及退出，子 Goroutine 也始终可以发送结果。另一个修复方法是在第 6 行使用默认为空的 &lt;code&gt;select&lt;/code&gt; 语句，这样如果没有 Goroutine 接收 &lt;code&gt;ch&lt;/code&gt;，就会发生默认情况。尽管这种解决方案可能并不总是有效。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;select&lt;/span&gt; &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; ch &amp;lt;- result: &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;3-不使用接口&quot;&gt;&lt;a href=&quot;#3-不使用接口&quot; class=&quot;headerlink&quot; title=&quot;3 不使用接口&quot;&gt;&lt;/a&gt;3 不使用接口&lt;/h2&gt;&lt;p&gt;接口可以使代码更加灵活。这是在代码中引入多态的一种方法。接口允许您请求一组行为，而不是特定类型。不使用接口可能不会导致任何错误，但它会导致代码不简单、不灵活和不具有可扩展性。&lt;/p&gt;
&lt;p&gt;在众多接口中，&lt;code&gt;io.Reader&lt;/code&gt; 和 &lt;code&gt;io.Writer&lt;/code&gt; 可能是最受欢迎的。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; Reader &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Read(p []&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;) (n &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, err error)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; Writer &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Write(p []&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;) (n &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, err error)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这些接口可以非常强大。假设您要将对象写入文件中，因此您定义了一个 Save 方法：&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(o *obj)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Save&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(file os.File)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果您第二天需要写入 &lt;code&gt;http.ResponseWriter&lt;/code&gt; 该怎么办？您不想定义新方法。是吧？所以使用 &lt;code&gt;io.Writer&lt;/code&gt;。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(o *obj)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Save&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(w io.Writer)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;还有一个重要的注意事项，你应该知道，总是要求你要使用的行为。在上面的例子中，请求一个&lt;code&gt;io.ReadWriteCloser&lt;/code&gt; 也可以工作得很好，但当你要使用的唯一方法是 &lt;code&gt;Write&lt;/code&gt; 时，这不是一个最佳实践。接口越大，抽象就越弱。&lt;/p&gt;
&lt;p&gt;所以大多数时候你最好专注于行为而不是具体的类型。&lt;/p&gt;
&lt;h2 id=&quot;4-不好的顺序结构&quot;&gt;&lt;a href=&quot;#4-不好的顺序结构&quot; class=&quot;headerlink&quot; title=&quot;4 不好的顺序结构&quot;&gt;&lt;/a&gt;4 不好的顺序结构&lt;/h2&gt;&lt;p&gt;这个错误也不会导致任何错误，但是它会导致更多的内存使用。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; BadOrderedPerson &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Veteran &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;   &lt;span class=&quot;comment&quot;&gt;// 1 byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Name    &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 16 byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Age     &lt;span class=&quot;keyword&quot;&gt;int32&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;// 4 byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; OrderedPerson &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Name    &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Age     &lt;span class=&quot;keyword&quot;&gt;int32&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Veteran &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;似乎两种类型的大小都相同，为 21 个字节，但结果显示出完全不同。使用 &lt;code&gt;GOARCH=amd64&lt;/code&gt; 编译代码，&lt;code&gt;BadOrderedPerson&lt;/code&gt; 类型分配 32 字节，而 &lt;code&gt;OrderedPerson&lt;/code&gt; 类型分配 24 字节。为什么？原因是&lt;a href=&quot;https://en.wikipedia.org/wiki/Data_structure_alignment&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;数据结构对齐&lt;/a&gt;。在 64 位体系结构中，内存分配 8 字节的连续数据包。需要添加的填充可以通过以下方式计算：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;padding = (align - (offset mod align)) mod align&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;aligned = offset + padding&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        = offset + ((align - (offset mod align)) mod align)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; BadOrderedPerson &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Veteran &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;     &lt;span class=&quot;comment&quot;&gt;// 1 byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	_       [&lt;span class=&quot;number&quot;&gt;7&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;// 7 byte: padding for alignment&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Name    &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;   &lt;span class=&quot;comment&quot;&gt;// 16 byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Age     &lt;span class=&quot;keyword&quot;&gt;int32&lt;/span&gt;    &lt;span class=&quot;comment&quot;&gt;// 4 byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	_       &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt;&amp;#123;&amp;#125; &lt;span class=&quot;comment&quot;&gt;// to prevent unkeyed literals&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// zero sized values, like struct&amp;#123;&amp;#125; and [0]byte occurring at &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// the end of a structure are assumed to have a size of one byte.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// so padding also will be addedd here as well.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; OrderedPerson &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Name    &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Age     &lt;span class=&quot;keyword&quot;&gt;int32&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Veteran &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	_       &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt;&amp;#123;&amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;当您有一个大的常用类型时，它可能会导致性能问题。但是不要担心，您不必手动处理所有的结构。使用 &lt;a href=&quot;https://github.com/mdempsky/maligned&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;maligned&lt;/a&gt; 你可以轻松检查代码以解决此问题。&lt;/p&gt;
&lt;h2 id=&quot;5-在测试中没有使用-race-detector&quot;&gt;&lt;a href=&quot;#5-在测试中没有使用-race-detector&quot; class=&quot;headerlink&quot; title=&quot;5 在测试中没有使用 race detector&quot;&gt;&lt;/a&gt;5 在测试中没有使用 race detector&lt;/h2&gt;&lt;p&gt;数据竞争会导致神秘的故障，通常是在代码部署到生产环境很久之后。正因为如此，它们是并发系统中最常见也是最难调试的 bug 类型。为了帮助区分这些 bug, Go 1.1 引入了一个内置的数据竞争检测器。它可以简单地添加 &lt;code&gt;-race&lt;/code&gt; 标志。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ go &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt; -race pkg    // to &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt; the package&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ go run -race pkg.go  // to run the &lt;span class=&quot;built_in&quot;&gt;source&lt;/span&gt; file&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ go build -race       // to build the package&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ go install -race pkg // to install the package&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;启用 race 检测器后，编译器将记录在代码中访问内存的时间和方式，而 &lt;code&gt;runtime&lt;/code&gt; 监视对共享变量的不同步访问。&lt;/p&gt;
&lt;p&gt;当发现数据竞争时，竞争检测器将打印一份报告，其中包含冲突访问的堆栈跟踪。下面是一个例子：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;WARNING: DATA RACE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Read by goroutine 185:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  net.(*pollServer).AddFD()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      src/net/fd_unix.go:89 +0x398&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  net.(*pollServer).WaitWrite()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      src/net/fd_unix.go:247 +0x45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  net.(*netFD).Write()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      src/net/fd_unix.go:540 +0x4d4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  net.(*conn).Write()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      src/net/net.go:129 +0x101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  net.func·060()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      src/net/timeout_test.go:603 +0xaf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Previous write by goroutine 184:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  net.setWriteDeadline()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      src/net/sockopt_posix.go:135 +0xdf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  net.setDeadline()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      src/net/sockopt_posix.go:144 +0x9c&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  net.(*conn).SetDeadline()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      src/net/net.go:161 +0xe3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  net.func·061()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      src/net/timeout_test.go:616 +0x3ed&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Goroutine 185 (running) created at:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  net.func·061()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      src/net/timeout_test.go:609 +0x288&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Goroutine 184 (running) created at:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  net.TestProlongTimeout()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      src/net/timeout_test.go:618 +0x298&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  testing.tRunner()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      src/testing/testing.go:301 +0xe8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;6-最后一句&quot;&gt;&lt;a href=&quot;#6-最后一句&quot; class=&quot;headerlink&quot; title=&quot;6 最后一句&quot;&gt;&lt;/a&gt;6 最后一句&lt;/h2&gt;&lt;p&gt;唯一真正的错误是我们什么也没学到。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;译自：&lt;a href=&quot;https://medium.com/swlh/5-mistakes-ive-made-in-go-75fb64b943b8&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://medium.com/swlh/5-mistakes-ive-made-in-go-75fb64b943b8&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;人皆犯错，宽恕是德   — Alexander Pope&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这些都是我在写 Go 中犯的错误。尽管这些可能不会导致任何类型的错误，但它们可能会潜在地影响软件。&lt;/p&gt;
&lt;h2 id=&quot;1-内循环&quot;&gt;&lt;a href=&quot;#1-内循环&quot; class=&quot;headerlink&quot; title=&quot;1 内循环&quot;&gt;&lt;/a&gt;1 内循环&lt;/h2&gt;&lt;p&gt;有几种方法可以造成循环内部的混乱，你需要注意。&lt;br&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="犯错" scheme="http://team.jiunile.com/categories/golang/%E7%8A%AF%E9%94%99/"/>
    
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="错误" scheme="http://team.jiunile.com/tags/%E9%94%99%E8%AF%AF/"/>
    
  </entry>
  
  <entry>
    <title>用 Go 从头开始构建容器（第1部分：命名空间）</title>
    <link href="http://team.jiunile.com//blog/2020/11/go-build-container-ns.html"/>
    <id>http://team.jiunile.com//blog/2020/11/go-build-container-ns.html</id>
    <published>2020-11-12T14:00:00.000Z</published>
    <updated>2020-11-13T01:53:02.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;在过去几年中，容器的使用显著增加。容器的概念已经出现好几年了，但是 Docker 易于使用的命令行才从 2013 年开始在开发人员中普及容器。&lt;/p&gt;
&lt;p&gt;在这个系列中，我试图演示容器是如何在下面工作的，以及我是如何开发容器的。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;什么是-vessel？&quot;&gt;&lt;a href=&quot;#什么是-vessel？&quot; class=&quot;headerlink&quot; title=&quot;什么是 vessel？&quot;&gt;&lt;/a&gt;什么是 vessel？&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/0xc0d/vessel&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;vessel&lt;/a&gt; 是我的一个教学目的的项目，它实现了一个小版本的 Docker 来管理容器。它既不使用 &lt;a href=&quot;https://containerd.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;containerd&lt;/a&gt; 也不使用 &lt;a href=&quot;https://github.com/opencontainers/runc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;runc&lt;/a&gt;，而是使用一组 Linux 特性来创建容器。&lt;/p&gt;
&lt;p&gt;vessel 既不是生产就绪的，也没有经过良好测试的软件。这只是一个简单的项目来了解更多关于容器的知识。&lt;/p&gt;
&lt;h2 id=&quot;让我们开始：阅读-Docker！&quot;&gt;&lt;a href=&quot;#让我们开始：阅读-Docker！&quot; class=&quot;headerlink&quot; title=&quot;让我们开始：阅读 Docker！&quot;&gt;&lt;/a&gt;让我们开始：阅读 Docker！&lt;/h2&gt;&lt;p&gt;我发现，在开始编写代码之前，先看一下 &lt;a href=&quot;https://docs.docker.com/get-started/overview/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Docker 文档&lt;/a&gt;，了解一下容器是很有用的。&lt;/p&gt;
&lt;p&gt;Docker 就其&lt;a href=&quot;https://docs.docker.com/get-started/overview/#the-underlying-technology&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;文档&lt;/a&gt;而言，利用了 linux 内核的几个特性，并将它们组合成一个称为容器格式的包装器。这些特性是:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Namespaces&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Control groups&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Union file systems&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;现在让我们浏览一下上面的列表，并简要地了解一下它们是什么。&lt;/p&gt;
&lt;h2 id=&quot;什么是命名空间（Namespace-）&quot;&gt;&lt;a href=&quot;#什么是命名空间（Namespace-）&quot; class=&quot;headerlink&quot; title=&quot;什么是命名空间（Namespace!）?&quot;&gt;&lt;/a&gt;什么是命名空间（Namespace!）?&lt;/h2&gt;&lt;p&gt;Linux 命名空间是最现代容器实现背后的基础技术。名称空间是进程对周围运行的其他事物的感知。命名空间允许隔离一组进程中的全局系统资源。例如，网络命名空间隔离网络堆栈，这意味着该网络命名空间中的进程可以拥有自己的独立路由、防火墙规则和网络设备。&lt;/p&gt;
&lt;p&gt;因此，如果没有命名空间，容器中的进程可能（例如）卸载文件系统，或在另一个容器中设置网络接口。&lt;/p&gt;
&lt;h3 id=&quot;哪些资源可以使用命名空间进行隔离？&quot;&gt;&lt;a href=&quot;#哪些资源可以使用命名空间进行隔离？&quot; class=&quot;headerlink&quot; title=&quot;哪些资源可以使用命名空间进行隔离？&quot;&gt;&lt;/a&gt;哪些资源可以使用命名空间进行隔离？&lt;/h3&gt;&lt;p&gt;在当前的 linux 内核 (5.9) 中，有 8 种类型的不同命名空间。每个命名空间可以隔离某个全局系统资源。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Cgroup&lt;/strong&gt;: 此命名空间隔离控制组根目录。我将在第 2 部分中解释什么是 cgroups。但简而言之，cgroup 允许系统为一组进程定义资源限制。但要注意的是，“cgroup namespce” 仅控制在命名空间中哪些 cgroup 可见。命名空间无法分配资源限制。我们稍后将对此进行深入解释。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;IPC&lt;/strong&gt;: 此命名空间隔离进程间通信机制，如 System V 和 POSIX 消息队列。理解IPC 并不难，但这篇文章不会讨论这个主题。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Network&lt;/strong&gt;: 此名称空间隔离路由、防火墙规则和名称空间内的一组进程可以看到的网络设备。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Mount&lt;/strong&gt;：此名称空间隔离每个名称空间中的挂载点列表。在单独的挂载名称空间中运行的进程可以挂载和卸载，而不会影响其他名称空间。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;PID&lt;/strong&gt;：这个命名空间隔离进程 ID 号空间。它支持在名称空间内挂起/恢复进程之类的函数。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Time&lt;/strong&gt;：这个命名空间隔离了 &lt;code&gt;CLOCK_MONOTONIC&lt;/code&gt; 和 &lt;code&gt;CLOCK_BOOTTIME&lt;/code&gt; 系统时钟，它们影响了针对这些时钟（如系统正常运行时间）测量的 API。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;User&lt;/strong&gt;：此名称空间隔离用户 id、组 id、根目录、密钥和功能。这允许进程在名称空间内是根，但不在命名空间外（如在主机中）。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;UTS&lt;/strong&gt;：这个命名空间隔离主机名和域名&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;关于命名空间的重要注意事项&quot;&gt;&lt;a href=&quot;#关于命名空间的重要注意事项&quot; class=&quot;headerlink&quot; title=&quot;关于命名空间的重要注意事项&quot;&gt;&lt;/a&gt;关于命名空间的重要注意事项&lt;/h3&gt;&lt;p&gt;命名空间除了隔离之外什么也没做，这意味着，例如，加入一个新的网络名称空间不会给您提供一组隔离的网络设备，您必须自己创建它们。UTS 命名空间也是如此，它不会改变您的主机名。它所做的唯一事情就是隔离与主机名相关的系统调用。我们将在这个系列中一起做这些事情。&lt;/p&gt;
&lt;h3 id=&quot;命名空间生命周期&quot;&gt;&lt;a href=&quot;#命名空间生命周期&quot; class=&quot;headerlink&quot; title=&quot;命名空间生命周期&quot;&gt;&lt;/a&gt;命名空间生命周期&lt;/h3&gt;&lt;p&gt;当命名空间中的最后一个进程离开命名空间时，命名空间将自动删除。然而，有许多例外情况使名称空间在没有任何成员进程的情况下保持活动。我们将在为 vessel 创建网络名称空间时解释其中一个例外。&lt;/p&gt;
&lt;h3 id=&quot;命名空间的系统调用&quot;&gt;&lt;a href=&quot;#命名空间的系统调用&quot; class=&quot;headerlink&quot; title=&quot;命名空间的系统调用&quot;&gt;&lt;/a&gt;命名空间的系统调用&lt;/h3&gt;&lt;p&gt;现在我们已经简要了解了命名空间是什么，接下来看看如何与命名空间交互。在 Linux 中，有一组允许创建、加入和发现命名空间的系统调用。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;&lt;code&gt;clone&lt;/code&gt;&lt;/strong&gt;：此系统调用实际上创建了一个新进程。但是借助 flags 参数，新进程将创建自己的新命名空间。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;code&gt;setns&lt;/code&gt;&lt;/strong&gt;：此系统调用允许正在运行的进程加入现有命名空间。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;code&gt;unshare&lt;/code&gt;&lt;/strong&gt;：此系统调用实际上与克隆相同，但不同之处在于此系统调用将创建当前进程并将其移动到新的命名空间，而 &lt;code&gt;clone&lt;/code&gt; 将创建具有新的命名空间的新进程。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;额外提示：&lt;code&gt;fork&lt;/code&gt; 和 &lt;code&gt;vfork&lt;/code&gt; 内部系统调用只是使用不同的参数调用 &lt;code&gt;clone()&lt;/code&gt;。&lt;/p&gt;
&lt;h3 id=&quot;命名空间-Flags&quot;&gt;&lt;a href=&quot;#命名空间-Flags&quot; class=&quot;headerlink&quot; title=&quot;命名空间 Flags&quot;&gt;&lt;/a&gt;命名空间 Flags&lt;/h3&gt;&lt;p&gt;上面提到的系统调用需要一个能够指定所需命名空间的 flag。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;CLONE_NEWCGROUP Cgroup namespaces&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CLONE_NEWIPC    IPC namespaces&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CLONE_NEWNET    Network namespaces&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CLONE_NEWNS     Mount namespaces$$ &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CLONE_NEWPID    PID namespaces&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CLONE_NEWTIME   Time namespaces&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CLONE_NEWUSER   User namespaces&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CLONE_NEWUTS    UTS namespaces&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;例如，如果你想为当前进程创建一个新的网络命名空间，你应该用 &lt;code&gt;CLONE_NEWNET&lt;/code&gt; 标记调用&lt;code&gt;unshare&lt;/code&gt;，如果您想使用新用户和 UTS 命名空间创建新进程，你应该用&lt;code&gt;CLONE_NEWUSER|CLONE_NEWUTS&lt;/code&gt; 调用 clone。竖线表示或按位组合两个标记。&lt;/p&gt;
&lt;h3 id=&quot;命名空间文件&quot;&gt;&lt;a href=&quot;#命名空间文件&quot; class=&quot;headerlink&quot; title=&quot;命名空间文件&quot;&gt;&lt;/a&gt;命名空间文件&lt;/h3&gt;&lt;p&gt;在上面我提到过 &lt;code&gt;setns&lt;/code&gt; 系统调用将在名称空间之间移动一个正在运行的进程。但是，如何指定要移动到哪个名称空间呢？好的，在创建名称空间之后，成员进程将具有指向命名空间文件的符号链接。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在 Unix 中，所有内容都是文件。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;例如，在您的 shell 中，通过列出 /proc/[pid]/ns 目录下的文件，您可以看到进程命名空间。在这里你可以看到正在运行的 shell 的当前命名空间（&lt;code&gt;self&lt;/code&gt; 代表当前 shell pid）:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ ls &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt; /proc/self/ns | cut &lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39; &#39;&lt;/span&gt; &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; 10-12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cgroup            -&amp;gt; cgroup:[4026531835]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ipc               -&amp;gt; ipc:[4026531839]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mnt               -&amp;gt; mnt:[4026531840]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net               -&amp;gt; net:[4026532008]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pid               -&amp;gt; pid:[4026531836]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pid_&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;_children  -&amp;gt; pid:[4026531836]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;time              -&amp;gt; time:[4026531834]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;time_&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;_children -&amp;gt; time:[4026531834]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;user              -&amp;gt; user:[4026531837]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;uts               -&amp;gt; uts:[4026531838]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;同样使用 &lt;code&gt;lsns&lt;/code&gt; 命令，您也可以看到进程命名空间列表:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# lsns&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        NS TYPE   NPROCS   PID USER    COMMAND&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4026531834 time      244     1 root    /sbin/init&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4026531835 cgroup    244     1 root    /sbin/init&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4026531836 pid       199     1 root    /sbin/init&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4026531837 user      198     1 root    /sbin/init&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4026531838 uts       241     1 root    /sbin/init&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4026531839 ipc       244     1 root    /sbin/init&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4026531840 mnt       234     1 root    /sbin/init&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;实际上 &lt;code&gt;setns&lt;/code&gt; syscall 所做的是更改 &lt;code&gt;/proc/[pid]/ns&lt;/code&gt; 目录下文件的链接。&lt;/p&gt;
&lt;h2 id=&quot;废话少说，让我们编码吧！&quot;&gt;&lt;a href=&quot;#废话少说，让我们编码吧！&quot; class=&quot;headerlink&quot; title=&quot;废话少说，让我们编码吧！&quot;&gt;&lt;/a&gt;废话少说，让我们编码吧！&lt;/h2&gt;&lt;p&gt;现在我们知道我们想要的一切。是时候编写第一个在单独命名空间上运行的代码了。首先让我们看看 &lt;code&gt;unshare&lt;/code&gt; 是如何工作的。下面的代码，在第 1 行使用 &lt;code&gt;syscall&lt;/code&gt; 包和 &lt;code&gt;Unshare&lt;/code&gt; 方法为当前运行的 Go 程序创建一个新的名称空间，然后在第 5 行将主机名设置为“container”，然后在第 9 行，它创建一个新命令并运行它。&lt;code&gt;Run&lt;/code&gt; 启动命令并等待其完成。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;除用户命名空间外，创建命名空间需要 &lt;code&gt;CAP_SYS_ADMIN&lt;/code&gt; 功能。因此，您需要以 root 用户来运行该程序。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;err := syscall.Unshare(syscall.CLONE_NEWPID|syscall.CLONE_NEWUTS)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Fprintln(os.Stderr, err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;err = syscall.Sethostname([]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;container&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fmt.Fprintln(os.Stderr, err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cmd := exec.Command(&lt;span class=&quot;string&quot;&gt;&quot;/bin/sh&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cmd.Stdin = os.Stdin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cmd.Stdout = os.Stdout&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cmd.Stderr = os.Stderr&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cmd.Run()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;让我们构建程序并进行测试。对于 host 中的第一个命令，我运行 ps 来监视正在运行的进程，然后获取主机名和当前 shell PID（例如 self，$$ 代表当前进程 PID）。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ ps&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    PID TTY          TIME CMD&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  27973 pts/2    00:00:00 sh&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  27984 pts/2    00:00:00 ps&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ hostname&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;host&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; $$&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27973&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;现在让我们看看运行程序后会发生什么。获取主机名它返回“container”。似乎有用！&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ hostname&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;container&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;让我们看看进程 ID 是什么。是的！它是 1，可行。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; $$&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;让我们运行 ps 来查看在容器内运行的进程。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ ps&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    PID TTY          TIME CMD&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  27973 pts/2    00:00:00 sh&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  27998 pts/2    00:00:00 unshare&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  28003 pts/2    00:00:00 sh&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  28011 pts/2    00:00:00 ps&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;发生什么事了!？我们可以看到带有大型 pid 的容器内的主机进程没有意义。&lt;/p&gt;
&lt;p&gt;我将终止其中一个进程，看看会发生什么:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;kill&lt;/span&gt; 27998&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sh: &lt;span class=&quot;built_in&quot;&gt;kill&lt;/span&gt;: (27998) - No such process&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;没有这样的进程，它说。精彩吗？让我解释一下。代码实际上是有效的，我们在一个新的 PID 命名空间中，我们可以看到我们的进程 ID 是 1。问题是 ps 命令。下面的 ps 使用 proc 伪文件系统列出所有正在运行的进程。为了能够拥有我们自己的 proc 文件系统，我们需要一个新的挂载名称空间，以及一个新的根路径来将 proc 挂载到其中。我们将在下一部分深入讨论。&lt;/p&gt;
&lt;h3 id=&quot;Clone-in-Go&quot;&gt;&lt;a href=&quot;#Clone-in-Go&quot; class=&quot;headerlink&quot; title=&quot;Clone in Go&quot;&gt;&lt;/a&gt;Clone in Go&lt;/h3&gt;&lt;p&gt;在我看来，Go 没有 clone 功能。但是，有一个名为 &lt;a href=&quot;https://github.com/liquidgecka/goclone&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;goclone&lt;/a&gt; 的包，它包装了 Go 的 clone 系统调用。但是我们将要使用的解决方案是不同的。在 vessel 中，我们使用一个叫做 &lt;code&gt;reexec&lt;/code&gt; 的包，它是 Docker 团队开发的。&lt;/p&gt;
&lt;h3 id=&quot;reexec-是什么？&quot;&gt;&lt;a href=&quot;#reexec-是什么？&quot; class=&quot;headerlink&quot; title=&quot;reexec 是什么？&quot;&gt;&lt;/a&gt;reexec 是什么？&lt;/h3&gt;&lt;p&gt;Go 允许您使用一组新的名称空间运行命令。&lt;code&gt;reexec&lt;/code&gt; 背后的思想是用新的名称空间重新执行正在运行的程序本身。&lt;code&gt;reexec&lt;/code&gt; 包，后台的 &lt;code&gt;reexec&lt;/code&gt; 包将从调用 &lt;code&gt;/proc/self/exe&lt;/code&gt; 的 Go 标准库返回 &lt;code&gt;*exec.Cmd&lt;/code&gt;。该文件基本上是指向正在运行的程序可执行文件的链接。&lt;/p&gt;
&lt;p&gt;现在您已经了解了 &lt;code&gt;reexec&lt;/code&gt; 是如何工作的，让我们从容器中深入研究一些代码。下面的代码，是在 vessel 的早期阶段。它实际上是使用一组新名称空间运行新进程的代码。这个过程就是我们的容器。在第 1 行到第 4 行，函数创建参数和新的 reexec 命令，然后为其设置标准的输入、输出和错误。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;注意: 容器的 &lt;code&gt;fork&lt;/code&gt; 子命令（第一行）是容器模式。虽然它被隐藏在使用中。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;args := []&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;&amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;fork&quot;&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cmd := reexec.Command(args...)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cmd.Stdin, cmd.Stdout, cmd.Stderr = os.Stdin, os.Stdout, os.Stderr&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cmd.SysProcAttr = &amp;amp;syscall.SysProcAttr&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Cloneflags: syscall.CLONE_NEWUTS |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		syscall.CLONE_NEWIPC |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		syscall.CLONE_NEWPID |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		syscall.CLONE_NEWNS,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Go 中的  &lt;code&gt;SysProcAttr&lt;/code&gt; 命令包含操作系统特定的属性。这些属性之一是 &lt;code&gt;Cloneflags&lt;/code&gt;，通过将 flags 传递到这个值，该命令将使用新的特定名称空间运行。这样，我们的新进程就有了新的 IPC、UTS、PID 和 Mount (NS) 命名空间。但是网络命名空间呢？!&lt;/p&gt;
&lt;h3 id=&quot;深入研究网络命名空间&quot;&gt;&lt;a href=&quot;#深入研究网络命名空间&quot; class=&quot;headerlink&quot; title=&quot;深入研究网络命名空间&quot;&gt;&lt;/a&gt;深入研究网络命名空间&lt;/h3&gt;&lt;p&gt;正如我已经提到的，命名空间只能隔离资源和容器感知的边界。因此，使用新的网络命名空间运行容器不会有太大帮助。我们也应该做一些连接容器到外部网络的事情。但这怎么可能？!&lt;/p&gt;
&lt;h3 id=&quot;什么是虚拟以太网设备？&quot;&gt;&lt;a href=&quot;#什么是虚拟以太网设备？&quot; class=&quot;headerlink&quot; title=&quot;什么是虚拟以太网设备？&quot;&gt;&lt;/a&gt;什么是虚拟以太网设备？&lt;/h3&gt;&lt;p&gt;&lt;code&gt;veth&lt;/code&gt; 可以充当网络命名空间之间的隧道。这意味着它可以在另一个命名空间中创建与网络设备的连接。&lt;br&gt;&lt;img src=&quot;/images/go/docker_ns_1.png&quot; alt=&quot;figure 1: Virtual Ethernet Devices&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;虚拟以太网设备总是成对地创建，并相互连接。在一对中的一个设备上传输的所有数据将立即在另一个设备上接收。当任一设备关闭时，这对设备的链路状态也关闭。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;例如，在图 1 中，有两个 veth 对。在每对设备中，一个对等设备位于主机网络命名空间内，另一个位于容器内。主机命名空间中的设备连接到网桥，该网桥被路由到名为 &lt;code&gt;eth0&lt;/code&gt; 的物理互联网连接设备。&lt;/p&gt;
&lt;p&gt;现在让我们来看看 vessel 是如何创建这样一个网络的。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(c *Container)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;SetupNetwork&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(bridge &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(filesystem.Unmounter, error)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	nsMountTarget := filepath.Join(netnsPath, c.Digest)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	vethName := fmt.Sprintf(&lt;span class=&quot;string&quot;&gt;&quot;veth%.7s&quot;&lt;/span&gt;, c.Digest)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	peerName := fmt.Sprintf(&lt;span class=&quot;string&quot;&gt;&quot;P%s&quot;&lt;/span&gt;, vethName)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := network.SetupVirtualEthernet(vethName, peerName); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;, err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := network.LinkSetMaster(vethName, bridge); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;, err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	unmount, err := network.MountNewNetworkNamespace(nsMountTarget)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; unmount, err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := network.LinkSetNsByFile(nsMountTarget, peerName); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; unmount, err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// Change current network namespace to setup the veth&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	unset, err := network.SetNetNSByFile(nsMountTarget)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; unmount, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; unset()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	ctrEthName := &lt;span class=&quot;string&quot;&gt;&quot;eth0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	ctrEthIPAddr := c.GetIP()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := network.LinkRename(peerName, ctrEthName); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; unmount, err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := network.LinkAddAddr(ctrEthName, ctrEthIPAddr); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; unmount, err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := network.LinkSetup(ctrEthName); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; unmount, err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := network.LinkAddGateway(ctrEthName, &lt;span class=&quot;string&quot;&gt;&quot;172.30.0.1&quot;&lt;/span&gt;); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; unmount, err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := network.LinkSetup(&lt;span class=&quot;string&quot;&gt;&quot;lo&quot;&lt;/span&gt;); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; unmount, err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; unmount, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;上面的代码涵盖了容器包的 &lt;code&gt;SetupNetwork&lt;/code&gt; 方法。这个方法的职责是创建一个如图 1 所示的网络。&lt;/p&gt;
&lt;p&gt;在调用此方法之前，vessel 将创建其名为 &lt;code&gt;vessel0&lt;/code&gt; 的桥梁。这是实际传递给 &lt;code&gt;SetupNetwork&lt;/code&gt; 网桥值的名称。&lt;/p&gt;
&lt;p&gt;从现在开始，事情可能会有点混乱，但别担心。请务必多阅读几次，并遵循代码。&lt;/p&gt;
&lt;p&gt;在第 3-4 行，定义了 veth 设备对名称。然后在第 6 行，将使用关联的名称创建 veth。在第 9 行，veth 将指定 &lt;code&gt;vessel0&lt;/code&gt; 作为其主服务器，以便进一步通信。&lt;br&gt;&lt;img src=&quot;/images/go/docker_ns_2.png&quot; alt=&quot;docker_ns_2&quot;&gt;&lt;/p&gt;
&lt;p&gt;现在是时候创建一个新的网络名称空间，并将其中一个 veth 对移动到其中。我们的容器终究会加入这个网络命名空间。然而，问题是命名空间的生命周期！如前所述，当最后一个进程成员离开名称空间时，名称空间将被删除。我也提到了一些例外。其中一个例外是绑定挂载命名空间时。这就是为什么有一个名为 &lt;code&gt;MountNewNetworkNamespace&lt;/code&gt; 的函数。这个函数创建一个新的名称空间，并将其绑定到一个文件以保持其活动。下面的代码涵盖了此功能。&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MountNewNetworkNamespace&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(nsTarget &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(filesystem.Unmounter, error)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	_, err := os.OpenFile(nsTarget, syscall.O_RDONLY|syscall.O_CREAT|syscall.O_EXCL, &lt;span class=&quot;number&quot;&gt;0644&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;, errors.Wrap(err, &lt;span class=&quot;string&quot;&gt;&quot;unable to create target file&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// store current network namespace&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	file, err = os.OpenFile(&lt;span class=&quot;string&quot;&gt;&quot;/proc/self/ns/net&quot;&lt;/span&gt;, os.O_RDONLY, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;, err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; file.Close()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := syscall.Unshare(syscall.CLONE_NEWNET); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;, errors.Wrap(err, &lt;span class=&quot;string&quot;&gt;&quot;unshare syscall failed&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	mountPoint := filesystem.MountOption&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		Source: &lt;span class=&quot;string&quot;&gt;&quot;/proc/self/ns/net&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		Target: nsTarget,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		Type:   &lt;span class=&quot;string&quot;&gt;&quot;bind&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		Flag:   syscall.MS_BIND,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	unmount, err := filesystem.Mount(mountPoint)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; unmount, err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// reset previous network namespace&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := unix.Setns(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;(file.Fd()), syscall.CLONE_NEWNET); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; unmount, errors.Wrap(err, &lt;span class=&quot;string&quot;&gt;&quot;setns syscall failed: &quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; unmount, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在第 2 行，函数创建一个文件。此文件将用于绑定新的网络命名空间。然后在第 9 行，函数存储了当前的命名空间链接，以便能够返回到它。现在是时候创建一个新的网络命名空间，并在第 15 行使用 &lt;code&gt;unshare&lt;/code&gt; 系统调用连接它。该函数现在将 &lt;code&gt;/proc/self/ns/net&lt;/code&gt; 绑定到第 2 行创建的文件。记住，&lt;code&gt;/proc/self/ns/net&lt;/code&gt; 将在 &lt;code&gt;unshare&lt;/code&gt; 系统调用后改变。&lt;/p&gt;
&lt;p&gt;这一切都很好，我们只需要离开当前的网络命名空间，然后使用第 29 行的 &lt;code&gt;setns&lt;/code&gt; 系统调用返回到我们以前的命名空间。这就是为什么函数首先存储了进程网络名称空间（第 9 行）。&lt;/p&gt;
&lt;p&gt;回到 &lt;code&gt;SetupNetwork&lt;/code&gt; 函数，现在让我们将对等设备移动到我们刚刚在 &lt;code&gt;MountNewNetworkNamespace&lt;/code&gt; 函数中创建的命名空间。由于 &lt;code&gt;nsMountTarget&lt;/code&gt; 值绑定到网络名称空间，因此它表示命名空间本身。因此，我们可以使用该文件的描述符来指定命名空间。&lt;/p&gt;
&lt;p&gt;好吧，毕竟我们有一个虚拟以太网设备对，其中一个设备在主机网络命名空间内，另一个在新的命名空间内。&lt;/p&gt;
&lt;p&gt;现在剩下的唯一任务是在新命名空间内配置设备。问题是设备在主机网络命名空间中不再可见，因此，我们需要使用 &lt;code&gt;SetNetNsByFile&lt;/code&gt; 函数（第21行）再次加入网络命名空间。此函数仅使用给定文件的描述符调用 &lt;code&gt;setns&lt;/code&gt; 系统调用。注意，我们需要 &lt;code&gt;defer&lt;/code&gt; &lt;code&gt;unset&lt;/code&gt; 函数（第 25 行），以将容器网络命名空间保留在函数的末尾。&lt;/p&gt;
&lt;p&gt;现在，代码的其余部分（第 22-43 行）在容器网络命名空间内运行。首先要做的是将容器设备重命名为 eth0（第 29行），然后关联一个新的 IP 地址（第 32 行），设置设备（第 35 行），添加设备的网关（第 38 行），最后设置回环（127.0.0.1）网络接口。现在我们完成了这里的工作，我们的网络命名空间已经完全准备好了。&lt;/p&gt;
&lt;p&gt;还要提到 172.30.0.1 是 &lt;code&gt;vessel0&lt;/code&gt; 网桥的默认 IP 地址，这并不是最好的方法，因为这个 IP 地址可能已经在使用了。我这样做是为了简单。现在你的任务是让它变得更好，并发送一个 Pull 请求。&lt;/p&gt;
&lt;h2 id=&quot;结论&quot;&gt;&lt;a href=&quot;#结论&quot; class=&quot;headerlink&quot; title=&quot;结论&quot;&gt;&lt;/a&gt;结论&lt;/h2&gt;&lt;p&gt;我们了解到命名空间是 Linux 特性之一，它为一组进程隔离全局系统资源，因此它是大多数容器中的基本技术。我们还学习了如何在 Go 中使用 &lt;code&gt;unshare&lt;/code&gt;、&lt;code&gt;clone&lt;/code&gt; 和 &lt;code&gt;setns&lt;/code&gt; 系统调用与命名空间进行交互。&lt;/p&gt;
&lt;p&gt;它还没有完成。我们将在下一部分中讨论 union 文件系统，但是现在让我们试着阅读容器代码来理解它。&lt;/p&gt;
&lt;p&gt;另外，别忘了用谷歌搜索 “Liz Rice”，看她谈论容器。&lt;/p&gt;
&lt;p&gt;感谢阅读！&lt;/p&gt;
&lt;p&gt;作者：Ali Josie 来源：medium.com&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;在过去几年中，容器的使用显著增加。容器的概念已经出现好几年了，但是 Docker 易于使用的命令行才从 2013 年开始在开发人员中普及容器。&lt;/p&gt;
&lt;p&gt;在这个系列中，我试图演示容器是如何在下面工作的，以及我是如何开发容器的。&lt;/p&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="容器" scheme="http://team.jiunile.com/categories/golang/%E5%AE%B9%E5%99%A8/"/>
    
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="container" scheme="http://team.jiunile.com/tags/container/"/>
    
      <category term="namespace" scheme="http://team.jiunile.com/tags/namespace/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes 网络模型来龙去脉</title>
    <link href="http://team.jiunile.com//blog/2020/11/k8s-network-source.html"/>
    <id>http://team.jiunile.com//blog/2020/11/k8s-network-source.html</id>
    <published>2020-11-11T14:00:00.000Z</published>
    <updated>2020-11-11T03:09:30.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/images/k8s/network_1.jpg&quot; alt=&quot;network&quot;&gt;&lt;br&gt;容器网络发端于 &lt;code&gt;Docker&lt;/code&gt; 的网络。&lt;code&gt;Docker&lt;/code&gt; 使用了一个比较简单的网络模型，即内部的网桥加内部的保留 IP。这种设计的好处在于容器的网络和外部世界是解耦的，无需占用宿主机的 IP 或者宿主机的资源，完全是虚拟的。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;它的设计初衷是：当需要访问外部世界时，会采用 &lt;code&gt;SNAT&lt;/code&gt; 这种方法来借用 Node 的 IP 去访问外面的服务。比如容器需要对外提供服务的时候，所用的是 &lt;code&gt;DNAT&lt;/code&gt; 技术，也就是在 Node 上开一个端口，然后通过 &lt;code&gt;iptable&lt;/code&gt; 或者别的某些机制，把流导入到容器的进程上以达到目的。&lt;/p&gt;
&lt;p&gt;该模型的问题在于，外部网络无法区分哪些是容器的网络与流量、哪些是宿主机的网络与流量。比如，如果要做一个高可用的时候，172.16.1.1 和 172.16.1.2 是拥有同样功能的两个容器，此时我们需要将两者绑成一个 Group 对外提供服务，而这个时候我们发现从外部看来两者没有相同之处，它们的 IP 都是借用宿主机的端口，因此很难将两者归拢到一起。&lt;br&gt;&lt;img src=&quot;/images/k8s/network_2.jpg&quot; alt=&quot;network&quot;&gt;&lt;/p&gt;
&lt;p&gt;在此基础上，&lt;code&gt;Kubernetes&lt;/code&gt; 提出了这样一种机制：即每一个 Pod，也就是一个功能聚集小团伙应有自己的“身份证”，或者说 ID。在 TCP 协议栈上，这个 ID 就是 IP。&lt;/p&gt;
&lt;p&gt;这个 IP 是真正属于该 Pod 的，外部世界不管通过什么方法一定要给它。对这个 Pod IP 的访问就是真正对它的服务的访问，中间拒绝任何的变化。比如以 10.1.1.1 的 IP 去访问 10.1.2.1 的 Pod，结果到了 10.1.2.1 上发现，它实际上借用的是宿主机的 IP，而不是源 IP，这样是不被允许的。Pod 内部会要求共享这个 IP，从而解决了一些功能内聚的容器如何变成一个部署的原子的问题。&lt;/p&gt;
&lt;p&gt;剩下的问题是我们的部署手段。&lt;code&gt;Kubernetes&lt;/code&gt; 对怎么实现这个模型其实是没有什么限制的，用 &lt;code&gt;underlay&lt;/code&gt; 网络来控制外部路由器进行导流是可以的；如果希望解耦，用 &lt;code&gt;overlay&lt;/code&gt; 网络在底层网络之上再加一层叠加网，这样也是可以的。总之，只要达到模型所要求的目的即可。&lt;/p&gt;
&lt;h2 id=&quot;Pod-究竟如何上网&quot;&gt;&lt;a href=&quot;#Pod-究竟如何上网&quot; class=&quot;headerlink&quot; title=&quot;Pod 究竟如何上网&quot;&gt;&lt;/a&gt;Pod 究竟如何上网&lt;/h2&gt;&lt;p&gt;容器网络的网络包究竟是怎么传送的？&lt;br&gt;&lt;img src=&quot;/images/k8s/network_3.jpg&quot; alt=&quot;network&quot;&gt;&lt;/p&gt;
&lt;p&gt;我们可以从以下两个维度来看：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;协议层次&lt;/li&gt;
&lt;li&gt;网络拓扑&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;2-1-协议层次&quot;&gt;&lt;a href=&quot;#2-1-协议层次&quot; class=&quot;headerlink&quot; title=&quot;2.1 协议层次&quot;&gt;&lt;/a&gt;2.1 协议层次&lt;/h3&gt;&lt;p&gt;它和 TCP 协议栈的概念是相同的，需要从两层、三层、四层一层层地摞上去，发包的时候从右往左，即先有应用数据，然后发到了 TCP 或者 UDP 的四层协议，继续向下传送，加上 IP 头，再加上 MAC 头就可以送出去了。收包的时候则按照相反的顺序，首先剥离 MAC 的头，再剥离 IP 的头，最后通过协议号在端口找到需要接收的进程。&lt;/p&gt;
&lt;h3 id=&quot;2-2-网络拓扑&quot;&gt;&lt;a href=&quot;#2-2-网络拓扑&quot; class=&quot;headerlink&quot; title=&quot;2.2 网络拓扑&quot;&gt;&lt;/a&gt;2.2 网络拓扑&lt;/h3&gt;&lt;p&gt;一个容器的包所要解决的问题分为两步：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;第一步，如何从容器的空间 (c1) 跳到宿主机的空间 (infra)；&lt;/li&gt;
&lt;li&gt;第二步，如何从宿主机空间到达远端。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我个人的理解是，容器网络的方案可以通过接入、流控、通道这三个层面来考虑。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;第一个是接入，就是说我们的容器和宿主机之间是使用哪一种机制做连接，比如 &lt;code&gt;Veth + bridge&lt;/code&gt;、&lt;code&gt;Veth + pair&lt;/code&gt; 这样的经典方式，也有利用高版本内核的新机制等其他方式（如 mac/IPvlan 等），来把包送入到宿主机空间；&lt;/li&gt;
&lt;li&gt;第二个是流控，就是说我的这个方案要不要支持 &lt;code&gt;Network Policy&lt;/code&gt;，如果支持的话又要用何种方式去实现。这里需要注意的是，我们的实现方式一定需要在数据路径必经的一个关节点上。如果数据路径不通过该 Hook 点，那就不会起作用；&lt;/li&gt;
&lt;li&gt;第三个是通道，即两个主机之间通过什么方式完成包的传输。我们有很多种方式，比如以路由的方式，具体又可分为 BGP 路由或者直接路由。还有各种各样的隧道技术等等。最终我们实现的目的就是一个容器内的包通过容器，经过接入层传到宿主机，再穿越宿主机的流控模块（如果有）到达通道送到对端。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;2-3-一个最简单的路由方案：Flannel-host-gw&quot;&gt;&lt;a href=&quot;#2-3-一个最简单的路由方案：Flannel-host-gw&quot; class=&quot;headerlink&quot; title=&quot;2.3 一个最简单的路由方案：Flannel-host-gw&quot;&gt;&lt;/a&gt;2.3 一个最简单的路由方案：Flannel-host-gw&lt;/h3&gt;&lt;p&gt;这个方案采用的是每个 Node 独占网段，每个 Subnet 会绑定在一个 Node 上，网关也设置在本地，或者说直接设在 cni0 这个网桥的内部端口上。该方案的好处是管理简单，坏处就是无法跨 Node 迁移 Pod。就是说这个 IP、网段已经是属于这个 Node 之后就无法迁移到别的 Node 上。&lt;br&gt;&lt;img src=&quot;/images/k8s/network_4.jpg&quot; alt=&quot;network&quot;&gt;&lt;/p&gt;
&lt;p&gt;这个方案的精髓在于 route 表的设置，如上图所示。接下来为大家一一解读一下。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;第一条很简单，我们在设置网卡的时候都会加上这一行。就是指定我的默认路由是通过哪个 IP 走掉，默认设备又是什么；&lt;/li&gt;
&lt;li&gt;第二条是对 Subnet 的一个规则反馈。就是说我的这个网段是 10.244.0.0，掩码是 24 位，它的网关地址就在网桥上，也就是 10.244.0.1。这就是说这个网段的每一个包都发到这个网桥的 IP 上；&lt;/li&gt;
&lt;li&gt;第三条是对对端的一个反馈。如果你的网段是 10.244.1.0（上图右边的 Subnet），我们就把它的 Host 的网卡上的 IP (10.168.0.3) 作为网关。也就是说，如果数据包是往 10.244.1.0 这个网段发的，就请以 10.168.0.3 作为网关。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;再来看一下这个数据包到底是如何跑起来的？&lt;/p&gt;
&lt;p&gt;假设容器 (10.244.0.2) 想要发一个包给 10.244.1.3，那么它在本地产生了 TCP 或者 UDP 包之后，再依次填好对端 IP 地址、本地以太网的 MAC 地址作为源 MAC 以及对端 MAC。一般来说本地会设定一条默认路由，默认路由会把 cni0 上的 IP 作为它的默认网关，对端的 MAC 就是这个网关的 MAC 地址。然后这个包就可以发到桥上去了。如果网段在本桥上，那么通过 MAC 层的交换即可解决。&lt;/p&gt;
&lt;p&gt;这个例子中我们的 IP 并不属于本网段，因此网桥会将其上送到主机的协议栈去处理。主机协议栈恰好找到了对端的 MAC 地址。使用 10.168.0.3 作为它的网关，通过本地 ARP 探查后，我们得到了 10.168.0.3 的 MAC 地址。即通过协议栈层层组装，我们达到了目的，将 Dst-MAC 填为右图主机网卡的 MAC 地址，从而将包从主机的 eth0 发到对端的 eth0 上去。&lt;/p&gt;
&lt;p&gt;所以大家可以发现，这里有一个隐含的限制，上图中的 MAC 地址填好之后一定是能到达对端的，但如果这两个宿主机之间不是二层连接的，中间经过了一些网关、一些复杂的路由，那么这个 MAC 就不能直达，这种方案就是不能用的。当包到达了对端的 MAC 地址之后，发现这个包确实是给它的，但是 IP 又不是它自己的，就开始 Forward 流程，包上送到协议栈，之后再走一遍路由，刚好会发现 10.244.1.0/24 需要发到 10.244.1.1 这个网关上，从而到达了 cni0 网桥，它会找到 10.244.1.3 对应的 MAC 地址，再通过桥接机制，这个包就到达了对端容器。&lt;/p&gt;
&lt;p&gt;大家可以看到，整个过程总是二层、三层，发的时候又变成二层，再做路由，就是一个大环套小环。这是一个比较简单的方案，如果中间要走隧道，则可能会有一条 &lt;code&gt;vxlan tunnel&lt;/code&gt; 的设备，此时就不填直接的路由，而填成对端的隧道号。&lt;/p&gt;
&lt;h2 id=&quot;Service-究竟如何工作&quot;&gt;&lt;a href=&quot;#Service-究竟如何工作&quot; class=&quot;headerlink&quot; title=&quot;Service 究竟如何工作&quot;&gt;&lt;/a&gt;Service 究竟如何工作&lt;/h2&gt;&lt;p&gt;Service 其实是一种负载均衡 (Load Balance) 的机制。&lt;/p&gt;
&lt;p&gt;我们认为它是一种用户侧(Client Side) 的负载均衡，也就是说 VIP 到 RIP 的转换在用户侧就已经完成了，并不需要集中式地到达某一个 NGINX 或者是一个 ELB 这样的组件来进行决策。&lt;br&gt;&lt;img src=&quot;/images/k8s/network_5.jpg&quot; alt=&quot;network&quot;&gt;&lt;/p&gt;
&lt;p&gt;它的实现是这样的：首先是由一群 Pod 组成一组功能后端，再在前端上定义一个虚 IP 作为访问入口。一般来说，由于 IP 不太好记，我们还会附赠一个 DNS 的域名，Client 先访问域名得到虚 IP 之后再转成实 IP。&lt;code&gt;Kube-proxy&lt;/code&gt;则是整个机制的实现核心，它隐藏了大量的复杂性。它的工作机制是通过 &lt;code&gt;apiserver&lt;/code&gt; 监控 Pod/Service 的变化（比如是不是新增了 Service、Pod）并将其反馈到本地的规则或者是用户态进程。&lt;/p&gt;
&lt;h2 id=&quot;一个-LVS-版的-Service&quot;&gt;&lt;a href=&quot;#一个-LVS-版的-Service&quot; class=&quot;headerlink&quot; title=&quot;一个 LVS 版的 Service&quot;&gt;&lt;/a&gt;一个 LVS 版的 Service&lt;/h2&gt;&lt;p&gt;我们来实际做一个 LVS 版的 Service。LVS 是一个专门用于负载均衡的内核机制。它工作在第四层，性能会比用 &lt;code&gt;iptable&lt;/code&gt; 实现好一些。&lt;/p&gt;
&lt;p&gt;假设我们是一个 &lt;code&gt;Kube-proxy&lt;/code&gt;，拿到了一个 Service 的配置，如下图所示：它有一个 &lt;code&gt;Cluster IP&lt;/code&gt;，在该 IP 上的端口是 9376，需要反馈到容器上的是 80 端口，还有三个可工作的 Pod，它们的 IP 分别是 10.1.2.3, 10.1.14.5, 10.1.3.8。&lt;br&gt;&lt;img src=&quot;/images/k8s/network_6.jpg&quot; alt=&quot;network&quot;&gt;&lt;/p&gt;
&lt;p&gt;它要做的事情就是：&lt;br&gt;&lt;img src=&quot;/images/k8s/network_7.png&quot; alt=&quot;network&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;第 1 步，绑定 VIP 到本地（欺骗内核）；&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;首先需要让内核相信它拥有这样的一个虚 IP，这是 LVS 的工作机制所决定的，因为它工作在第四层，并不关心 IP 转发，只有它认为这个 IP 是自己的才会拆到 TCP 或 UDP 这一层。在第一步中，我们将该 IP 设到内核中，告诉内核它确实有这么一个 IP。实现的方法有很多，我们这里用的是 ip route 直接加 local 的方式，用 Dummy 设备上加 IP 的方式也是可以的。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;第 2 步，为这个虚 IP 创建一个 IPVS 的 &lt;code&gt;virtual server&lt;/code&gt;；&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;告诉它我需要为这个 IP 进行负载均衡分发，后面的参数就是一些分发策略等等。&lt;code&gt;virtual server&lt;/code&gt; 的 IP 其实就是我们的 &lt;code&gt;Cluster IP&lt;/code&gt;。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;第 3 步，为这个 &lt;code&gt;IPVS service&lt;/code&gt; 创建相应的 &lt;code&gt;real server&lt;/code&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们需要为 &lt;code&gt;virtual server&lt;/code&gt; 配置相应的 &lt;code&gt;real server&lt;/code&gt;，就是真正提供服务的后端是什么。比如说我们刚才看到有三个 Pod，于是就把这三个的 IP 配到 &lt;code&gt;virtual server&lt;/code&gt; 上，完全一一对应过来就可以了。&lt;code&gt;Kube-proxy&lt;/code&gt; 工作跟这个也是类似的。只是它还需要去监控一些 Pod 的变化，比如 Pod 的数量变成 5 个了，那么规则就应变成 5 条。如果这里面某一个 Pod 死掉了或者被杀死了，那么就要相应地减掉一条。又或者整个 Service 被撤销了，那么这些规则就要全部删掉。所以它其实做的是一些管理层面的工作。&lt;/p&gt;
&lt;h2 id=&quot;啥？负载均衡还分内部外部&quot;&gt;&lt;a href=&quot;#啥？负载均衡还分内部外部&quot; class=&quot;headerlink&quot; title=&quot;啥？负载均衡还分内部外部&quot;&gt;&lt;/a&gt;啥？负载均衡还分内部外部&lt;/h2&gt;&lt;p&gt;最后我们介绍一下 Service 的类型，可以分为以下 4 类。&lt;/p&gt;
&lt;h3 id=&quot;5-1-ClusterIP&quot;&gt;&lt;a href=&quot;#5-1-ClusterIP&quot; class=&quot;headerlink&quot; title=&quot;5.1 ClusterIP&quot;&gt;&lt;/a&gt;5.1 ClusterIP&lt;/h3&gt;&lt;p&gt;集群内部的一个虚拟 IP，这个 IP 会绑定到一堆服务的 Group Pod 上面，这也是默认的服务方式。它的缺点是这种方式只能在 Node 内部也就是集群内部使用。&lt;/p&gt;
&lt;h3 id=&quot;5-2-NodePort&quot;&gt;&lt;a href=&quot;#5-2-NodePort&quot; class=&quot;headerlink&quot; title=&quot;5.2 NodePort&quot;&gt;&lt;/a&gt;5.2 NodePort&lt;/h3&gt;&lt;p&gt;供集群外部调用。将 Service 承载在 Node 的静态端口上，端口号和 Service 一一对应，那么集群外的用户就可以通过 &lt;code&gt;&amp;lt;NodeIP&amp;gt;:&amp;lt;NodePort&amp;gt;&lt;/code&gt; 的方式调用到 Service。&lt;/p&gt;
&lt;h3 id=&quot;5-3-LoadBalancer&quot;&gt;&lt;a href=&quot;#5-3-LoadBalancer&quot; class=&quot;headerlink&quot; title=&quot;5.3 LoadBalancer&quot;&gt;&lt;/a&gt;5.3 LoadBalancer&lt;/h3&gt;&lt;p&gt;给云厂商的扩展接口。像阿里云、亚马逊这样的云厂商都是有成熟的 LB 机制的，这些机制可能是由一个很大的集群实现的，为了不浪费这种能力，云厂商可通过这个接口进行扩展。它首先会自动创建 NodePort 和 ClusterIP 这两种机制，云厂商可以选择直接将 LB 挂到这两种机制上，或者两种都不用，直接把 Pod 的 RIP 挂到云厂商的 ELB 的后端也是可以的。&lt;/p&gt;
&lt;h3 id=&quot;5-4-ExternalName&quot;&gt;&lt;a href=&quot;#5-4-ExternalName&quot; class=&quot;headerlink&quot; title=&quot;5.4 ExternalName&quot;&gt;&lt;/a&gt;5.4 ExternalName&lt;/h3&gt;&lt;p&gt;摈弃内部机制，依赖外部设施，比如某个用户特别强，他觉得我们提供的都没什么用，就是要自己实现，此时一个 Service 会和一个域名一一对应起来，整个负载均衡的工作都是外部实现的。&lt;/p&gt;
&lt;p&gt;下图是一个实例。它灵活地应用了 ClusterIP、NodePort 等多种服务方式，又结合了云厂商的 ELB，变成了一个很灵活、极度伸缩、生产上真正可用的一套系统。&lt;br&gt;&lt;img src=&quot;/images/k8s/network_8.png&quot; alt=&quot;network&quot;&gt;&lt;/p&gt;
&lt;p&gt;首先我们用 ClusterIP 来做功能 Pod 的服务入口。大家可以看到，如果有三种 Pod 的话，就有三个 &lt;code&gt;Service Cluster IP&lt;/code&gt; 作为它们的服务入口。这些方式都是 Client 端的，如何在 Server 端做一些控制呢？&lt;/p&gt;
&lt;p&gt;首先会起一些 Ingress 的 Pod（Ingress 是 K8s 后来新增的一种服务，本质上还是一堆同质的 Pod），然后将这些 Pod 组织起来，暴露到一个 NodePort 的 IP，K8s 的工作到此就结束了。&lt;/p&gt;
&lt;p&gt;任何一个用户访问 23456 端口的 Pod 就会访问到 Ingress 的服务，它的后面有一个 Controller，会把 Service IP 和 Ingress 的后端进行管理，最后会调到 ClusterIP，再调到我们的功能 Pod。前面提到我们去对接云厂商的 ELB，我们可以让 ELB 去监听所有集群节点上的 23456 端口，只要在 23456 端口上有服务的，就认为有一个 Ingress 的实例在跑。&lt;/p&gt;
&lt;p&gt;整个的流量经过外部域名的一个解析跟分流到达了云厂商的 ELB，ELB 经过负载均衡并通过 NodePort 的方式到达 Ingress，Ingress 再通过 ClusterIP 调用到后台真正的 Pod。这种系统看起来比较丰富，健壮性也比较好。任何一个环节都不存在单点的问题，任何一个环节也都有管理与反馈。&lt;/p&gt;
&lt;h2 id=&quot;总结&quot;&gt;&lt;a href=&quot;#总结&quot; class=&quot;headerlink&quot; title=&quot;总结&quot;&gt;&lt;/a&gt;总结&lt;/h2&gt;&lt;p&gt;本文的主要内容就到此为止了，这里为大家简单总结一下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;大家要从根本上理解 Kubernetes 网络模型的演化来历，理解 PerPodPerIP 的用心在哪里；&lt;/li&gt;
&lt;li&gt;网络的事情万变不离其宗，按照模型从 4 层向下就是发包过程，反正层层剥离就是收包过程，容器网络也是如此；&lt;/li&gt;
&lt;li&gt;Ingress 等机制是在更高的层次上（服务&amp;lt;-&amp;gt;端口）方便大家部署集群对外服务，通过一个真正可用的部署实例，希望大家把 &lt;code&gt;Ingress + Cluster IP + PodIP&lt;/code&gt; 等概念联合来看，理解社区出台新机制、新资源对象的思考。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;作者：叶磊 来源：阿里巴巴云原生&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/images/k8s/network_1.jpg&quot; alt=&quot;network&quot;&gt;&lt;br&gt;容器网络发端于 &lt;code&gt;Docker&lt;/code&gt; 的网络。&lt;code&gt;Docker&lt;/code&gt; 使用了一个比较简单的网络模型，即内部的网桥加内部的保留 IP。这种设计的好处在于容器的网络和外部世界是解耦的，无需占用宿主机的 IP 或者宿主机的资源，完全是虚拟的。&lt;br&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/categories/kubernetes/"/>
    
      <category term="网络" scheme="http://team.jiunile.com/categories/kubernetes/%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="网络" scheme="http://team.jiunile.com/tags/%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes 网络插件在超过 10Gbit/s 下的基准测试结果</title>
    <link href="http://team.jiunile.com//blog/2020/11/k8s-cni-benchmark.html"/>
    <id>http://team.jiunile.com//blog/2020/11/k8s-cni-benchmark.html</id>
    <published>2020-11-11T12:00:00.000Z</published>
    <updated>2020-11-10T06:26:33.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;概览&quot;&gt;&lt;a href=&quot;#概览&quot; class=&quot;headerlink&quot; title=&quot;概览&quot;&gt;&lt;/a&gt;概览&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;在运行 Kubernetes 1.19 和 Ubuntu 18.04 上进行基准测试&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;在我们深入讨论度量之前&lt;/li&gt;
&lt;li&gt;CNI 经过 MTU 调优&lt;/li&gt;
&lt;li&gt;CNI 基准:原始数据&lt;/li&gt;
&lt;li&gt;CNI 加密&lt;/li&gt;
&lt;li&gt;总结&lt;/li&gt;
&lt;li&gt;结论-我的结论&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;1-在我们深入讨论度量标准之前…&quot;&gt;&lt;a href=&quot;#1-在我们深入讨论度量标准之前…&quot; class=&quot;headerlink&quot; title=&quot;1 在我们深入讨论度量标准之前…&quot;&gt;&lt;/a&gt;1 在我们深入讨论度量标准之前…&lt;/h2&gt;&lt;h3 id=&quot;1-1-自2019年4月以来有什么新鲜事吗&quot;&gt;&lt;a href=&quot;#1-1-自2019年4月以来有什么新鲜事吗&quot; class=&quot;headerlink&quot; title=&quot;1.1 自2019年4月以来有什么新鲜事吗?&quot;&gt;&lt;/a&gt;1.1 自2019年4月以来有什么新鲜事吗?&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;测试您自己的群集&lt;/strong&gt;：现在您可以使用我们发布的“Kubernetes网络基准测试”工具：knb (&lt;a href=&quot;https://github.com/InfraBuilder/k8s-bench-suite&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/InfraBuilder/k8s-bench-suite&lt;/a&gt;)在自己的集群上运行基准测试。&lt;/li&gt;
&lt;li&gt;在CNI 竞争中欢迎新的挑战者:&lt;ul&gt;
&lt;li&gt;来自 VMware Tanzu 的 “&lt;a href=&quot;https://antrea.io/docs/master/getting-started/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Antrea&lt;/a&gt;”&lt;/li&gt;
&lt;li&gt;来自 alauda.io 的 “&lt;a href=&quot;https://github.com/alauda/kube-ovn&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kube-OVN&lt;/a&gt;”&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;新场景&lt;/strong&gt;：这个基准测试涵盖了 “Pod-to-Pod” 的网络性能，还包括一个新的 “Pod-to-Service” 场景，该方案涉及真实的测试案例。实际上，您的 API 容器将通过服务而不是容器 IP 消耗服务中的数据库（当然，我们对这两种场景也会测试 TCP 和 UDP）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;资源消耗&lt;/strong&gt;：现在每个测试都有自己的资源比较。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;删除应用程序测试&lt;/strong&gt;：我们不再运行 HTTP、FTP 和 SCP 测试。我们与社区和 CNI 维护者卓有成效的合作突显了 iperf TCP 结果和 curl 结果之间的差距，这是由于 CNI 启动的延迟(Pod 启动时的最初几秒钟，与实际用例无关)。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;开源&lt;/strong&gt;：所有基准测试的源代码（脚本、cni yml 和原始结果）都可以在 github 上获得：&lt;a href=&quot;https://github.com/icyxp/benchmark-k8s-cni-2020-08&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/icyxp/benchmark-k8s-cni-2020-08&lt;/a&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;1-2-基准协议&quot;&gt;&lt;a href=&quot;#1-2-基准协议&quot; class=&quot;headerlink&quot; title=&quot;1.2 基准协议&quot;&gt;&lt;/a&gt;1.2 基准协议&lt;/h3&gt;&lt;p&gt;整个协议详见：&lt;a href=&quot;https://github.com/icyxp/benchmark-k8s-cni-2020-08/blob/master/PROTOCOL.md&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/icyxp/benchmark-k8s-cni-2020-08/blob/master/PROTOCOL.md&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;请注意，当前的文章只关注 Ubuntu 18.04 的默认内核。&lt;/p&gt;
&lt;h3 id=&quot;1-3-选择-CNIs-做基准测试&quot;&gt;&lt;a href=&quot;#1-3-选择-CNIs-做基准测试&quot; class=&quot;headerlink&quot; title=&quot;1.3 选择 CNIs 做基准测试&quot;&gt;&lt;/a&gt;1.3 选择 CNIs 做基准测试&lt;/h3&gt;&lt;p&gt;这个基准测试旨在比较可以用单个 yaml 文件设置的 CNIs（因此排除所有基于脚本的安装，如基于 VPP 的 CNIs 等）。&lt;/p&gt;
&lt;p&gt;我们将比较的 CNIs 列表如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Antrea&lt;/code&gt; v.0.9.1&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Calico&lt;/code&gt; v3.16&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Canal&lt;/code&gt; v3.16 (Flannel network + Calico Network Policies)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Cilium&lt;/code&gt; 1.8.2&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Flannel&lt;/code&gt; 0.12.0&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Kube-router&lt;/code&gt; latest (2020–08–25)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;WeaveNet&lt;/code&gt; 2.7.0&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;2-CNI-MTU-调优&quot;&gt;&lt;a href=&quot;#2-CNI-MTU-调优&quot; class=&quot;headerlink&quot; title=&quot;2 CNI MTU 调优&quot;&gt;&lt;/a&gt;2 CNI MTU 调优&lt;/h2&gt;&lt;p&gt;首先，我们将检查 &lt;code&gt;MTU detection&lt;/code&gt; 对 TCP 性能的影响：&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_1.png&quot; alt=&quot;MTU impact on TCP performance&quot;&gt;&lt;/p&gt;
&lt;p&gt;UDP 的缺点更加明显：&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_2.png&quot; alt=&quot;MTU Impact on UDP performance&quot;&gt;&lt;/p&gt;
&lt;p&gt;考虑到这里所揭示的对性能的巨大影响，我们希望向所有 CNI 维护者传达一个希望的消息：请在CNIs 中实现 &lt;code&gt;MTU auto-detection&lt;/code&gt;。你将会拯救小猫，独角兽，甚至是最可爱的一个:  devops 小家伙！&lt;/p&gt;
&lt;p&gt;然而，如果您确实必须选择一个没有实现 &lt;code&gt;auto-MTU&lt;/code&gt; 的 CNI，那么您需要自己对它进行调优以保持性能。请注意，这适用于 &lt;code&gt;Calico&lt;/code&gt;，&lt;code&gt;Canal&lt;/code&gt; 和 &lt;code&gt;Weavenet&lt;/code&gt;。&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_3.png&quot; alt=&quot;My little message to CNI maintainers ….&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;3-CNI基准：原始数据&quot;&gt;&lt;a href=&quot;#3-CNI基准：原始数据&quot; class=&quot;headerlink&quot; title=&quot;3 CNI基准：原始数据&quot;&gt;&lt;/a&gt;3 CNI基准：原始数据&lt;/h2&gt;&lt;p&gt;在本节中，我们将比较 CNI 和正确的 MTU（&lt;code&gt;auto-detected&lt;/code&gt; 或手动调优）。这里的主要目标是在图表中显示原始数据。&lt;/p&gt;
&lt;p&gt;颜色代码：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;灰色 : 参考 (裸机)&lt;/li&gt;
&lt;li&gt;绿色 : 带宽 &amp;gt; 9500 Mbit/s&lt;/li&gt;
&lt;li&gt;黄色 : 带宽 &amp;gt; 9000 Mbit/s&lt;/li&gt;
&lt;li&gt;橙色 : 带宽 &amp;gt; 8000 Mbit/s&lt;/li&gt;
&lt;li&gt;红色 : 带宽 &amp;lt; 8000 Mbit/s&lt;/li&gt;
&lt;li&gt;蓝色 : 中性 (与带宽无关)&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;3-1-Idle&quot;&gt;&lt;a href=&quot;#3-1-Idle&quot; class=&quot;headerlink&quot; title=&quot;3.1 Idle&quot;&gt;&lt;/a&gt;3.1 Idle&lt;/h3&gt;&lt;p&gt;首先要建立 CNI 消耗，当整个集群….像是在休眠？&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_4.png&quot; alt=&quot;Idle resource consumption&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;3-2-Pod-to-Pod&quot;&gt;&lt;a href=&quot;#3-2-Pod-to-Pod&quot; class=&quot;headerlink&quot; title=&quot;3.2 Pod-to-Pod&quot;&gt;&lt;/a&gt;3.2 Pod-to-Pod&lt;/h3&gt;&lt;p&gt;在这个场景中，客户端 Pod 直接连接到服务器 Pod 的 IP 地址。&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_5.png&quot; alt=&quot;Pod-to-Pod scenario&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;3-2-1-TCP&quot;&gt;&lt;a href=&quot;#3-2-1-TCP&quot; class=&quot;headerlink&quot; title=&quot;3.2.1 TCP&quot;&gt;&lt;/a&gt;3.2.1 TCP&lt;/h4&gt;&lt;p&gt;“&lt;strong&gt;Pod-to-Pod&lt;/strong&gt;” &lt;strong&gt;TCP&lt;/strong&gt; 相关资源消耗结果如下:&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_6.png&quot; alt=&quot;pod-to-pod tcp&quot;&gt;&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_7.png&quot; alt=&quot;pod-to-pod tcp&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;3-2-2-UDP&quot;&gt;&lt;a href=&quot;#3-2-2-UDP&quot; class=&quot;headerlink&quot; title=&quot;3.2.2 UDP&quot;&gt;&lt;/a&gt;3.2.2 UDP&lt;/h4&gt;&lt;p&gt;“&lt;strong&gt;Pod-to-Pod&lt;/strong&gt;” &lt;strong&gt;UDP&lt;/strong&gt; 相关资源消耗结果如下:&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_8.png&quot; alt=&quot;pod-to-pod udp&quot;&gt;&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_9.png&quot; alt=&quot;pod-to-pod udp&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;3-3-Pod-to-Service&quot;&gt;&lt;a href=&quot;#3-3-Pod-to-Service&quot; class=&quot;headerlink&quot; title=&quot;3.3 Pod-to-Service&quot;&gt;&lt;/a&gt;3.3 Pod-to-Service&lt;/h3&gt;&lt;p&gt;在本节中，客户端 Pod 通过 &lt;code&gt;ClusterIP Service&lt;/code&gt; 连接到服务端 Pod。这与实际的用例更相关。&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_10.png&quot; alt=&quot;Pod-to-Service scenario&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;3-3-1-TCP&quot;&gt;&lt;a href=&quot;#3-3-1-TCP&quot; class=&quot;headerlink&quot; title=&quot;3.3.1 TCP&quot;&gt;&lt;/a&gt;3.3.1 TCP&lt;/h4&gt;&lt;p&gt;“&lt;strong&gt;Pod-to-Service&lt;/strong&gt;” &lt;strong&gt;TCP&lt;/strong&gt; 相关资源消耗结果如下:&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_11.png&quot; alt=&quot;pod-to-service tcp&quot;&gt;&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_12.png&quot; alt=&quot;pod-to-service tcp&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;3-3-2-UDP&quot;&gt;&lt;a href=&quot;#3-3-2-UDP&quot; class=&quot;headerlink&quot; title=&quot;3.3.2 UDP&quot;&gt;&lt;/a&gt;3.3.2 UDP&lt;/h4&gt;&lt;p&gt;“&lt;strong&gt;Pod-to-Service&lt;/strong&gt;” &lt;strong&gt;UDP&lt;/strong&gt; 相关资源消耗结果如下:&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_13.png&quot; alt=&quot;pod-to-service udp&quot;&gt;&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_14.png&quot; alt=&quot;pod-to-service udp&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;3-4-网络策略&quot;&gt;&lt;a href=&quot;#3-4-网络策略&quot; class=&quot;headerlink&quot; title=&quot;3.4 网络策略&quot;&gt;&lt;/a&gt;3.4 网络策略&lt;/h3&gt;&lt;p&gt;在此基准测试中所列出的所有 CNIs 中，唯一不完全支持网络策略的是 Flannel。所有其他的都正确地实现了网络策略，包括入口和出口。做得好!&lt;/p&gt;
&lt;h2 id=&quot;4-CNI-加密&quot;&gt;&lt;a href=&quot;#4-CNI-加密&quot; class=&quot;headerlink&quot; title=&quot;4 CNI 加密&quot;&gt;&lt;/a&gt;4 CNI 加密&lt;/h2&gt;&lt;p&gt;在我们测试的所有 CNIs 中，以下是能够加密 pod 间通信：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Antrea&lt;/code&gt; with IPsec&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Calico&lt;/code&gt; with wireguard&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Cilium&lt;/code&gt; with IPsec&lt;/li&gt;
&lt;li&gt;&lt;code&gt;WeaveNet&lt;/code&gt; with IPsec&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;4-1-带宽&quot;&gt;&lt;a href=&quot;#4-1-带宽&quot; class=&quot;headerlink&quot; title=&quot;4.1 带宽&quot;&gt;&lt;/a&gt;4.1 带宽&lt;/h3&gt;&lt;p&gt;由于在这场对比中 CNIs 较少，因此让我们在一张图中概况所有场景：&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_15.png&quot; alt=&quot;encryption&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;4-2-资源消耗&quot;&gt;&lt;a href=&quot;#4-2-资源消耗&quot; class=&quot;headerlink&quot; title=&quot;4.2 资源消耗&quot;&gt;&lt;/a&gt;4.2 资源消耗&lt;/h3&gt;&lt;p&gt;在本节中，我们将研究 Pod-to-Pod 通信所使用的资源，包括 TCP 和 UDP。在这里显示 Pod-to-Service 的图没有意义，因为它没有提供更多信息。&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_16.png&quot; alt=&quot;encryption-tcp&quot;&gt;&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_17.png&quot; alt=&quot;encryption-udp&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;5-总结&quot;&gt;&lt;a href=&quot;#5-总结&quot; class=&quot;headerlink&quot; title=&quot;5 总结&quot;&gt;&lt;/a&gt;5 总结&lt;/h2&gt;&lt;p&gt;让我们尝试回顾一下这些图表。我们在这里引入了一点主观性，用修饰符替换了实际值，如“非常快”、“低”等。&lt;br&gt;&lt;img src=&quot;/images/k8s/cni_18.png&quot; alt=&quot;Benchmark result summary (August 2020)&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;6-结论-我的结论&quot;&gt;&lt;a href=&quot;#6-结论-我的结论&quot; class=&quot;headerlink&quot; title=&quot;6 结论 - 我的结论&quot;&gt;&lt;/a&gt;6 结论 - 我的结论&lt;/h2&gt;&lt;p&gt;最后一部分是主观的，表达了我自己对结果的理解。&lt;/p&gt;
&lt;p&gt;我很高兴看到 CNI 的新成员加入进来。&lt;code&gt;Antrea&lt;/code&gt; 在游戏中表现得很好，它提供了许多特性，甚至在早期版本中也有：&lt;code&gt;auto-mtu&lt;/code&gt;、加密选项和直接安装。&lt;/p&gt;
&lt;p&gt;考虑到性能，除了 &lt;code&gt;Kube-OVN&lt;/code&gt; 和 &lt;code&gt;Kube-Router&lt;/code&gt; 之外，所有 CNIs 都表现的很好。关于 &lt;code&gt;Kube-Router&lt;/code&gt;，它无法检测到 MTU，而且我在文档中找不到调优它的方法（&lt;a href=&quot;https://github.com/cloudnativelabs/kube-router/issues/165&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这里&lt;/a&gt;有一个关于 MTU 配置的 open issue）。&lt;/p&gt;
&lt;p&gt;在资源消耗方面，&lt;code&gt;Cilium&lt;/code&gt; 仍然比竞争对手使用更多的 RAM，但该公司公开目标是大规模集群，这与在这个 3 节点基准的情况不完全一样。&lt;code&gt;Kube-OVN&lt;/code&gt; 也是 RAM 和 cpu 密集型的，它仍然是一个相当年轻的 CNI，它依赖于 &lt;code&gt;Open vSwitch&lt;/code&gt; (&lt;code&gt;Antrea&lt;/code&gt; 也是，但 &lt;code&gt;Antrea&lt;/code&gt; 更轻，性能更好)。&lt;/p&gt;
&lt;p&gt;网络策略由所有测试的 CNIs 实现，&lt;code&gt;Flannel&lt;/code&gt; 除外。&lt;code&gt;Flannel&lt;/code&gt; 很可能永远不会（永远）实现它，因为他们的目的很明确：越轻越好。&lt;/p&gt;
&lt;p&gt;此外，加密性能在这里是真正的 “哇效果”。&lt;code&gt;Calico&lt;/code&gt; 是最古老的 CNIs 之一，但他们直到几周前才提供加密服务。他们更喜欢 &lt;code&gt;wireguard&lt;/code&gt; 而不是 &lt;code&gt;IPsec&lt;/code&gt;，而且至少可以说，它在这一领域的表现是伟大的，惊人的，完全优秀的对于其他 CNIs。当然，由于加密负载，它会消耗大量 CPU，但它们所实现的带宽是完全值得的（记住，&lt;code&gt;Calico encrypted perf&lt;/code&gt; 大约比&lt;code&gt;Cilium&lt;/code&gt; 好 6 倍，后者排名第二）。此外，在集群上部署 &lt;code&gt;Calico&lt;/code&gt; 之后，您还可以随时激活 &lt;code&gt;wireguard&lt;/code&gt; 加密，您也可以暂时禁用它，或者永远禁用它。这是难以置信的对于用户友好度。但是！我们提醒您，&lt;code&gt;Calico&lt;/code&gt; 目前还不能 &lt;code&gt;auto-detect MTU&lt;/code&gt;（该特性计划很快发布），因此，如果您的网络支持巨型帧（MTU 9000），请不要忘记调整 MTU。&lt;/p&gt;
&lt;p&gt;此外，请注意，&lt;code&gt;Cilium&lt;/code&gt; 能够加密整个节点到节点的通信（不仅仅是 pod 通信），这对于面向公共的集群节点来说可能是一个非常有吸引力的特性。&lt;/p&gt;
&lt;p&gt;总结一下，这是我对以下用例的建议：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;我需要一个 CNI 来容纳额外的小型节点集群，或者我不关心安全性&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;选用 &lt;code&gt;Flannel&lt;/code&gt;，这是最轻最稳定的 CNI。&lt;br&gt;(它也是最古老的之一。根据传说，它是由 Homo-Kubernautus 或 Homo-Containorus 发明的。您可能会对精彩的 &lt;a href=&quot;https://k3s.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;k3s&lt;/a&gt; 项目感兴趣！点击这里查看详情！&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;我的标准群集需要一个 CNI&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;好的，&lt;code&gt;Calico&lt;/code&gt; 是你的选择，如果有必要的话，不要忘记调整 MTU。您可以使用网络策略，轻松启用/禁用加密，等等。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;我的（非常）大型集群需要一个 CNI&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;好吧，该基准测试无法反映大型集群的行为。我很乐意为此工作，但是我们没有数百台具有 10Gbit/s 连接性的服务器。因此，最好的选择是至少使用 &lt;code&gt;Calico&lt;/code&gt; 和 &lt;code&gt;Cilium&lt;/code&gt; 在您的节点上运行自定义的基准测试。&lt;/p&gt;
&lt;p&gt;感谢阅读！&lt;/p&gt;
&lt;p&gt;作者：Alexis Ducastel 来源：medium.com&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概览&quot;&gt;&lt;a href=&quot;#概览&quot; class=&quot;headerlink&quot; title=&quot;概览&quot;&gt;&lt;/a&gt;概览&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;在运行 Kubernetes 1.19 和 Ubuntu 18.04 上进行基准测试&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;在我们深入讨论度量之前&lt;/li&gt;
&lt;li&gt;CNI 经过 MTU 调优&lt;/li&gt;
&lt;li&gt;CNI 基准:原始数据&lt;/li&gt;
&lt;li&gt;CNI 加密&lt;/li&gt;
&lt;li&gt;总结&lt;/li&gt;
&lt;li&gt;结论-我的结论&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;1-在我们深入讨论度量标准之前…&quot;&gt;&lt;a href=&quot;#1-在我们深入讨论度量标准之前…&quot; class=&quot;headerlink&quot; title=&quot;1 在我们深入讨论度量标准之前…&quot;&gt;&lt;/a&gt;1 在我们深入讨论度量标准之前…&lt;/h2&gt;&lt;h3 id=&quot;1-1-自2019年4月以来有什么新鲜事吗&quot;&gt;&lt;a href=&quot;#1-1-自2019年4月以来有什么新鲜事吗&quot; class=&quot;headerlink&quot; title=&quot;1.1 自2019年4月以来有什么新鲜事吗?&quot;&gt;&lt;/a&gt;1.1 自2019年4月以来有什么新鲜事吗?&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;测试您自己的群集&lt;/strong&gt;：现在您可以使用我们发布的“Kubernetes网络基准测试”工具：knb (&lt;a href=&quot;https://github.com/InfraBuilder/k8s-bench-suite&quot;&gt;https://github.com/InfraBuilder/k8s-bench-suite&lt;/a&gt;)在自己的集群上运行基准测试。&lt;/li&gt;
&lt;li&gt;在CNI 竞争中欢迎新的挑战者:&lt;ul&gt;
&lt;li&gt;来自 VMware Tanzu 的 “&lt;a href=&quot;https://antrea.io/docs/master/getting-started/&quot;&gt;Antrea&lt;/a&gt;”&lt;/li&gt;
&lt;li&gt;来自 alauda.io 的 “&lt;a href=&quot;https://github.com/alauda/kube-ovn&quot;&gt;Kube-OVN&lt;/a&gt;”&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;新场景&lt;/strong&gt;：这个基准测试涵盖了 “Pod-to-Pod” 的网络性能，还包括一个新的 “Pod-to-Service” 场景，该方案涉及真实的测试案例。实际上，您的 API 容器将通过服务而不是容器 IP 消耗服务中的数据库（当然，我们对这两种场景也会测试 TCP 和 UDP）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;资源消耗&lt;/strong&gt;：现在每个测试都有自己的资源比较。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;删除应用程序测试&lt;/strong&gt;：我们不再运行 HTTP、FTP 和 SCP 测试。我们与社区和 CNI 维护者卓有成效的合作突显了 iperf TCP 结果和 curl 结果之间的差距，这是由于 CNI 启动的延迟(Pod 启动时的最初几秒钟，与实际用例无关)。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;开源&lt;/strong&gt;：所有基准测试的源代码（脚本、cni yml 和原始结果）都可以在 github 上获得：&lt;a href=&quot;https://github.com/icyxp/benchmark-k8s-cni-2020-08&quot;&gt;https://github.com/icyxp/benchmark-k8s-cni-2020-08&lt;/a&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/categories/kubernetes/"/>
    
      <category term="基准测试" scheme="http://team.jiunile.com/categories/kubernetes/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/"/>
    
      <category term="网络" scheme="http://team.jiunile.com/categories/kubernetes/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="cni" scheme="http://team.jiunile.com/tags/cni/"/>
    
      <category term="测试" scheme="http://team.jiunile.com/tags/%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>Nginx proxy_pass 配置域名引发的故障</title>
    <link href="http://team.jiunile.com//blog/2020/11/nginx-proxy-pass-domain.html"/>
    <id>http://team.jiunile.com//blog/2020/11/nginx-proxy-pass-domain.html</id>
    <published>2020-11-10T12:00:00.000Z</published>
    <updated>2020-11-09T08:10:10.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;背景描述&quot;&gt;&lt;a href=&quot;#背景描述&quot; class=&quot;headerlink&quot; title=&quot;背景描述&quot;&gt;&lt;/a&gt;背景描述&lt;/h2&gt;&lt;p&gt;业务场景：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;用户 ----&amp;gt; waf ----&amp;gt; 后端服务&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;waf&lt;/code&gt; 是采用 Nginx 做的二次开发，做了一些安全验证后将请求转发到后端服务，通过 nginx &lt;code&gt;proxy_pass&lt;/code&gt; 转发。 &lt;code&gt;proxy_pass&lt;/code&gt; 后面直接配置的是域名（如：xxxxx-1760550967.cn-northwest-1.elb.amazonaws.com.cn ）&lt;/p&gt;
&lt;h2 id=&quot;故障现象&quot;&gt;&lt;a href=&quot;#故障现象&quot; class=&quot;headerlink&quot; title=&quot;故障现象&quot;&gt;&lt;/a&gt;故障现象&lt;/h2&gt;&lt;p&gt;有部分用户开始反馈访问站点出错 &lt;code&gt;504 Gateway Time-out&lt;/code&gt;, 通过监控查到有部分请求打了一个下线的 IP 上。这里简单简述下故障场景：使用nginx做反向代理，将请求发送到一个域名(例如: &lt;code&gt;proxy_pass http://www.test.com&lt;/code&gt; 该域名对应的 IP 是 A) ，刚开始运行一切正常，但是当运行了一段时间以后，域名对应的 IP 变了(例如 &lt;a href=&quot;http://www.test.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.test.com&lt;/a&gt; 对应的 IP 由 A 变为 B)，nginx 的转发仍然还在向原先的 IP 发送请求，导致业务中断，此时&lt;code&gt;reload nginx&lt;/code&gt; 后才会重新恢复正常，且日志显示数据转发到新的 IP B。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;故障分析&quot;&gt;&lt;a href=&quot;#故障分析&quot; class=&quot;headerlink&quot; title=&quot;故障分析&quot;&gt;&lt;/a&gt;故障分析&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;此处只针对 nginx 向后端做代理，且后端代理为域名形式的这种情况做分析&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;1、正常情况下启动 nginx 后(或者 -t / reload nginx 时)，nginx 会通过操作系统配置的 DNS 服务器去解析域名对应的 IP&lt;/li&gt;
&lt;li&gt;2、当 nginx 配置文件中的所有涉及到的域名都可以被正常解析到以后，才能启动(或者检查/重新加载)通过&lt;/li&gt;
&lt;li&gt;3、&lt;strong&gt;这里需要提醒一点，在 &lt;code&gt;nginx -t&lt;/code&gt; 或者 &lt;code&gt;nginx -s reload&lt;/code&gt; 只是检查域名是否可以解析通过，并不会在此时缓存域名对应 IP，只有在通过 nginx 第一次向 &lt;code&gt;proxy_pass&lt;/code&gt; 后端对应的域名做代理数据转发时，这里 nginx 会通过操作系统配置的 DNS 服务器解析域名，此时才会缓存域名对应的 IP，且会缓存很长时间，甚至一个月(整个过程均有生产实例证明，且抓包验证)&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;如何解决？&quot;&gt;&lt;a href=&quot;#如何解决？&quot; class=&quot;headerlink&quot; title=&quot;如何解决？&quot;&gt;&lt;/a&gt;如何解决？&lt;/h2&gt;&lt;p&gt;1、既然是因为 nginx 缓存域名对应 IP 的 DNS 记录造成的，那么怎么才能解决呢，方法有两种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(1)、手动 reload nginx，让 nginx 重新解析域名，这个时候解析到域名对应的 IP 是最新的，不会包含已经被废弃的 IP&lt;/li&gt;
&lt;li&gt;(2)、设置 nginx 的 DNS 缓存时间，比如 600s 失效，然后重新去解析&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;2、方法(2)当然是最好的，但是 nginx 的 DNS 缓存时间在哪里设置呢，我没有找到！&lt;/p&gt;
&lt;p&gt;3、但是我找到另外一种方法 – nginx 的 &lt;code&gt;resolver&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&quot;nginx-的-resolver-解决方案&quot;&gt;&lt;a href=&quot;#nginx-的-resolver-解决方案&quot; class=&quot;headerlink&quot; title=&quot;nginx 的 resolver 解决方案&quot;&gt;&lt;/a&gt;nginx 的 resolver 解决方案&lt;/h3&gt;&lt;p&gt;1、默认 nginx 会通过操作系统设置的 DNS 服务器（/etc/resolv.conf）去解析域名&lt;/p&gt;
&lt;p&gt;2、其实 nginx 还可以通过自身设置 DNS 服务器，而不用去找操作系统的 DNS&lt;/p&gt;
&lt;p&gt;3、下面来讲一个这个 &lt;code&gt;resolver&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;示例配置如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;server &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       listen      8080;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       server_name localhost;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       resolver 114.114.114.114 223.5.5.5 valid=3600s;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       resolver_timeout 3s;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       set $qq &amp;quot;www.qq.com&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       location / &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          proxy_pass http://$qq;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;参数说明：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;resolver&lt;/code&gt; 可以在 http 全局设定，也可在 server 里面设定&lt;/li&gt;
&lt;li&gt;&lt;code&gt;resolver&lt;/code&gt; 后面指定 DNS 服务器，可以指定多个，空格隔开&lt;/li&gt;
&lt;li&gt;&lt;code&gt;valid&lt;/code&gt; 设置 DNS 缓存失效时间，自己根据情况判断，建议 600 以上&lt;/li&gt;
&lt;li&gt;&lt;code&gt;resolver_timeout&lt;/code&gt; 指定解析域名时，DNS 服务器的超时时间，建议 3 秒左右&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;注意：&lt;/strong&gt;当 &lt;code&gt;resolver&lt;/code&gt; 后面跟多个 DNS 服务器时，一定要保证这些 DNS 服务器都是有效的，因为这种是负载均衡模式的，当 DNS 记录失效了（超过 valid 时间），首先由第一个  DNS 服务器（114.114.114.114）去解析，下一次继续失效时由第二个 DNS 服务器（223.5.5.5）去解析，亲自测试的，如有任何一个 DNS 服务器是坏的，那么这一次的解析会一直持续到 &lt;code&gt;resolver_timeout&lt;/code&gt; ，然后解析失败，且日志报错解析不了域名，通过页面抛出502错误。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;重点：&lt;/strong&gt;如上例，在代理到后端域名 &lt;a href=&quot;http://www.qq.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.qq.com&lt;/a&gt; 时，千万不要直接写在 &lt;code&gt;proxy_pass&lt;/code&gt; 中，因为 server 中使用了 &lt;code&gt;resolver&lt;/code&gt;，所以必须先把域名定义到一个变量里面，然后在 &lt;code&gt;proxy_pass http://$变量名&lt;/code&gt;，否则 nginx 语法检测一直会报错，提示解析不了域名。&lt;/p&gt;
&lt;h2 id=&quot;延展阅读&quot;&gt;&lt;a href=&quot;#延展阅读&quot; class=&quot;headerlink&quot; title=&quot;延展阅读&quot;&gt;&lt;/a&gt;延展阅读&lt;/h2&gt;&lt;h3 id=&quot;这里列举几个-proxy-pass、upstream-与-reslover-的应用场景&quot;&gt;&lt;a href=&quot;#这里列举几个-proxy-pass、upstream-与-reslover-的应用场景&quot; class=&quot;headerlink&quot; title=&quot;这里列举几个 proxy_pass、upstream 与 reslover 的应用场景&quot;&gt;&lt;/a&gt;这里列举几个 &lt;code&gt;proxy_pass&lt;/code&gt;、&lt;code&gt;upstream&lt;/code&gt; 与 &lt;code&gt;reslover&lt;/code&gt; 的应用场景&lt;/h3&gt;&lt;h4 id=&quot;1-proxy-pass-upstream&quot;&gt;&lt;a href=&quot;#1-proxy-pass-upstream&quot; class=&quot;headerlink&quot; title=&quot;1. proxy_pass + upstream&quot;&gt;&lt;/a&gt;1. proxy_pass + upstream&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;upstream foo.example.com &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server 127.0.0.1:8001;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;server &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    listen       80;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server_name  localhost;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    location /foo &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        proxy_pass http://foo.example.com;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;访问 &lt;a href=&quot;http://localhost/foo，proxy&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://localhost/foo，proxy&lt;/a&gt; 模块会将请求转发到 127.0.0.1 的 8001 端口上。&lt;/p&gt;
&lt;h4 id=&quot;2-只有-proxy-pass，没有-upstream-与-resolver&quot;&gt;&lt;a href=&quot;#2-只有-proxy-pass，没有-upstream-与-resolver&quot; class=&quot;headerlink&quot; title=&quot;2. 只有 proxy_pass，没有 upstream 与 resolver&quot;&gt;&lt;/a&gt;2. 只有 proxy_pass，没有 upstream 与 resolver&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;server &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    listen       80;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server_name  localhost;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    location /foo &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        proxy_pass http://foo.example.com;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;实际上是隐式创建了 &lt;code&gt;upstream&lt;/code&gt;，&lt;code&gt;upstream&lt;/code&gt; 名字就是 foo.example.com。&lt;code&gt;upstream&lt;/code&gt; 模块利用本机设置的 DNS 服务器（或/etc/hosts），将 foo.example.com 解析成 IP，访问 &lt;a href=&quot;http://localhost/foo，`proxy`&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://localhost/foo，`proxy`&lt;/a&gt; 模块会将请求转发到解析后的 IP 上。&lt;/p&gt;
&lt;p&gt;如果本机未设置 DNS 服务器，或者 DNS 服务器无法解析域名，则 nginx 启动时会报类似如下错误：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;nginx: [emerg] host not found &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; upstream &lt;span class=&quot;string&quot;&gt;&quot;foo.example.com&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; /path/nginx/conf/nginx.conf:110&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;3-proxy-pass-resolver（变量设置域名）&quot;&gt;&lt;a href=&quot;#3-proxy-pass-resolver（变量设置域名）&quot; class=&quot;headerlink&quot; title=&quot;3. proxy_pass + resolver（变量设置域名）&quot;&gt;&lt;/a&gt;3. proxy_pass + resolver（变量设置域名）&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;server &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    listen       80;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server_name  localhost;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    resolver 114.114.114.114;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    location /foo &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        set $foo foo.example.com;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        proxy_pass http://$foo;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;访问 &lt;a href=&quot;http://localhost/foo，nginx&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://localhost/foo，nginx&lt;/a&gt; 会动态利用 &lt;code&gt;resolver&lt;/code&gt; 设置的 DNS 服务器（本机设置的 DNS 服务器或 /etc/hosts 无效），将域名解析成 IP，&lt;code&gt;proxy&lt;/code&gt; 模块会将请求转发到解析后的 IP 上。&lt;/p&gt;
&lt;h4 id=&quot;4-proxy-pass-upstream（显式）-resolver（变量设置域名）&quot;&gt;&lt;a href=&quot;#4-proxy-pass-upstream（显式）-resolver（变量设置域名）&quot; class=&quot;headerlink&quot; title=&quot;4. proxy_pass + upstream（显式） + resolver（变量设置域名）&quot;&gt;&lt;/a&gt;4. proxy_pass + upstream（显式） + resolver（变量设置域名）&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;upstream foo.example.com &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server 127.0.0.1:8001;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;server &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    listen       80;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server_name  localhost;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    resolver 114.114.114.114;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    location /foo &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        set $foo foo.example.com;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        proxy_pass http://$foo;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;访问 &lt;a href=&quot;http://localhost/foo&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://localhost/foo&lt;/a&gt; 时，&lt;code&gt;upstream&lt;/code&gt; 模块会优先查找是否有定义 &lt;code&gt;upstream&lt;/code&gt; 后端服务器，如果有定义则直接利用，不再走 DNS 解析。所以 &lt;code&gt;proxy&lt;/code&gt; 模块会将请求转发到127.0.0.1 的 8001 端口上。&lt;/p&gt;
&lt;h4 id=&quot;5-proxy-pass-upstream（隐式）-resolver（变量设置域名）&quot;&gt;&lt;a href=&quot;#5-proxy-pass-upstream（隐式）-resolver（变量设置域名）&quot; class=&quot;headerlink&quot; title=&quot;5. proxy_pass + upstream（隐式） + resolver（变量设置域名）&quot;&gt;&lt;/a&gt;5. proxy_pass + upstream（隐式） + resolver（变量设置域名）&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;server &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    listen       80;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server_name  localhost;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    resolver 114.114.114.114;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    location /foo &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        set $foo foo.example.com;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        proxy_pass http://$foo;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    location /foo2 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        proxy_pass http://foo.example.com;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;location /foo2 实际上是隐式定义了 &lt;code&gt;upstream foo.example.com&lt;/code&gt;，并由本地 DNS 服务器进行了域名解析，访问 &lt;a href=&quot;http://localhost/foo&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://localhost/foo&lt;/a&gt; 时，&lt;code&gt;upstream&lt;/code&gt; 模块会优先查找 &lt;code&gt;upstream&lt;/code&gt;，即隐式定义的 foo.example.com，&lt;code&gt;proxy&lt;/code&gt; 模块会将请求转发到解析后的 IP 上。&lt;/p&gt;
&lt;h4 id=&quot;6-proxy-pass-resolver（不用变量设置域名）&quot;&gt;&lt;a href=&quot;#6-proxy-pass-resolver（不用变量设置域名）&quot; class=&quot;headerlink&quot; title=&quot;6. proxy_pass + resolver（不用变量设置域名）&quot;&gt;&lt;/a&gt;6. proxy_pass + resolver（不用变量设置域名）&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;server &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    listen       80;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server_name  localhost;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    resolver 114.114.114.114;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    location /foo &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        proxy_pass http://foo.example.com;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;不使用变量设置域名，则 &lt;code&gt;resolver&lt;/code&gt; 的设置不起作用，此时相当于场景 2，只有 &lt;code&gt;proxy_pass&lt;/code&gt; 的场景。&lt;/p&gt;
&lt;h4 id=&quot;7-proxy-pass-upstream-resolver（不用变量设置域名）&quot;&gt;&lt;a href=&quot;#7-proxy-pass-upstream-resolver（不用变量设置域名）&quot; class=&quot;headerlink&quot; title=&quot;7. proxy_pass + upstream + resolver（不用变量设置域名）&quot;&gt;&lt;/a&gt;7. proxy_pass + upstream + resolver（不用变量设置域名）&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;upstream foo.example.com &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server 127.0.0.1:8001;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;server &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    listen       80;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server_name  localhost;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    resolver 114.114.114.114;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    location /foo &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        proxy_pass http://foo.example.com;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;不使用变量设置域名，则 &lt;code&gt;resolver&lt;/code&gt; 的设置不起作用，此时相当于场景 1 &lt;code&gt;proxy_pass + upstream&lt;/code&gt;。&lt;/p&gt;
&lt;h4 id=&quot;8-proxy-pass-直接指定-IP-加端口号&quot;&gt;&lt;a href=&quot;#8-proxy-pass-直接指定-IP-加端口号&quot; class=&quot;headerlink&quot; title=&quot;8. proxy_pass 直接指定 IP 加端口号&quot;&gt;&lt;/a&gt;8. proxy_pass 直接指定 IP 加端口号&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;server &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    listen       80;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server_name  localhost;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    location /foo &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        proxy_pass http://127.0.0.1:8001/;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;实际上是隐式创建了 &lt;code&gt;upstream&lt;/code&gt;，&lt;code&gt;proxy_pass&lt;/code&gt; 会将请求转发到 127.0.0.1 的 8001 端口上。&lt;/p&gt;
&lt;h3 id=&quot;主要代码&quot;&gt;&lt;a href=&quot;#主要代码&quot; class=&quot;headerlink&quot; title=&quot;主要代码&quot;&gt;&lt;/a&gt;主要代码&lt;/h3&gt;&lt;p&gt;解析 proxy_pass 指令的代码：&lt;br&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; *&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title&quot;&gt;ngx_http_proxy_pass&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;ngx_conf_t&lt;/span&gt; *cf, &lt;span class=&quot;keyword&quot;&gt;ngx_command_t&lt;/span&gt; *cmd, &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *conf)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_http_proxy_loc_conf_t&lt;/span&gt; *plcf = conf;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;size_t&lt;/span&gt;                      add;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    u_short                     port;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_str_t&lt;/span&gt;                  *value, *url;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_url_t&lt;/span&gt;                   u;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_uint_t&lt;/span&gt;                  n;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_http_core_loc_conf_t&lt;/span&gt;   *clcf;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_http_script_compile_t&lt;/span&gt;   sc;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (plcf-&amp;gt;upstream.upstream || plcf-&amp;gt;proxy_lengths) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;is duplicate&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    clcf = ngx_http_conf_get_module_loc_conf(cf, ngx_http_core_module);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    clcf-&amp;gt;handler = ngx_http_proxy_handler;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (clcf-&amp;gt;name.data[clcf-&amp;gt;name.len - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] == &lt;span class=&quot;string&quot;&gt;&#39;/&#39;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        clcf-&amp;gt;auto_redirect = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    value = cf-&amp;gt;args-&amp;gt;elts;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    url = &amp;amp;value[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/* 查找指令中$符号的位置，判断是否使用了变量 */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    n = ngx_http_script_variables_count(url);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (n) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;/* 使用变量设置域名 */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ngx_memzero(&amp;amp;sc, &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;ngx_http_script_compile_t&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sc.cf = cf;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sc.source = url;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sc.lengths = &amp;amp;plcf-&amp;gt;proxy_lengths;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sc.values = &amp;amp;plcf-&amp;gt;proxy_values;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sc.variables = n;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sc.complete_lengths = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        sc.complete_values = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (ngx_http_script_compile(&amp;amp;sc) != NGX_OK) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; NGX_CONF_ERROR;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;if&lt;/span&gt; (NGX_HTTP_SSL)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        plcf-&amp;gt;ssl = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; NGX_CONF_OK;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (ngx_strncasecmp(url-&amp;gt;data, (u_char *) &lt;span class=&quot;string&quot;&gt;&quot;http://&quot;&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;7&lt;/span&gt;) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        add = &lt;span class=&quot;number&quot;&gt;7&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        port = &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (ngx_strncasecmp(url-&amp;gt;data, (u_char *) &lt;span class=&quot;string&quot;&gt;&quot;https://&quot;&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (NGX_HTTP_SSL)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        plcf-&amp;gt;ssl = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        add = &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        port = &lt;span class=&quot;number&quot;&gt;443&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ngx_conf_log_error(NGX_LOG_EMERG, cf, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                           &lt;span class=&quot;string&quot;&gt;&quot;https protocol requires SSL support&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; NGX_CONF_ERROR;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ngx_conf_log_error(NGX_LOG_EMERG, cf, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;invalid URL prefix&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; NGX_CONF_ERROR;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ngx_memzero(&amp;amp;u, &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;ngx_url_t&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    u.url.len = url-&amp;gt;len - add;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    u.url.data = url-&amp;gt;data + add;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    u.default_port = port;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    u.uri_part = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    u.no_resolve = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    plcf-&amp;gt;upstream.upstream = ngx_http_upstream_add(cf, &amp;amp;u, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (plcf-&amp;gt;upstream.upstream == &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; NGX_CONF_ERROR;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    plcf-&amp;gt;vars.schema.len = add;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    plcf-&amp;gt;vars.schema.data = url-&amp;gt;data;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    plcf-&amp;gt;vars.key_start = plcf-&amp;gt;vars.schema;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ngx_http_proxy_set_vars(&amp;amp;u, &amp;amp;plcf-&amp;gt;vars);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    plcf-&amp;gt;location = clcf-&amp;gt;name;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (clcf-&amp;gt;named&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (NGX_PCRE)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        || clcf-&amp;gt;regex&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#endif&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        || clcf-&amp;gt;noname)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (plcf-&amp;gt;vars.uri.len) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ngx_conf_log_error(NGX_LOG_EMERG, cf, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                               &lt;span class=&quot;string&quot;&gt;&quot;\&quot;proxy_pass\&quot; cannot have URI part in &quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                               &lt;span class=&quot;string&quot;&gt;&quot;location given by regular expression, &quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                               &lt;span class=&quot;string&quot;&gt;&quot;or inside named location, &quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                               &lt;span class=&quot;string&quot;&gt;&quot;or inside \&quot;if\&quot; statement, &quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                               &lt;span class=&quot;string&quot;&gt;&quot;or inside \&quot;limit_except\&quot; block&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; NGX_CONF_ERROR;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        plcf-&amp;gt;location.len = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    plcf-&amp;gt;url = *url;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; NGX_CONF_OK;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;upstream 模块初始化请求时的逻辑：&lt;br&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;133&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;134&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;135&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;136&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;137&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;138&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;139&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;140&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;142&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;143&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;144&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;145&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;146&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;147&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;148&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;149&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;150&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;151&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title&quot;&gt;ngx_http_upstream_init_request&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;ngx_http_request_t&lt;/span&gt; *r)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_str_t&lt;/span&gt;                      *host;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_uint_t&lt;/span&gt;                      i;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_resolver_ctx_t&lt;/span&gt;             *ctx, temp;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_http_cleanup_t&lt;/span&gt;             *cln;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_http_upstream_t&lt;/span&gt;            *u;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_http_core_loc_conf_t&lt;/span&gt;       *clcf;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_http_upstream_srv_conf_t&lt;/span&gt;   *uscf, **uscfp;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;ngx_http_upstream_main_conf_t&lt;/span&gt;  *umcf;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (r-&amp;gt;aio) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    u = r-&amp;gt;upstream;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/* NGX_HTTP_CACHE 等其他处理 */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cln-&amp;gt;handler = ngx_http_upstream_cleanup;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cln-&amp;gt;data = r;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    u-&amp;gt;cleanup = &amp;amp;cln-&amp;gt;handler;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (u-&amp;gt;resolved == &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;/* 如果没有使用resolver设置DNS，直接取upstream的设置 */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        uscf = u-&amp;gt;conf-&amp;gt;upstream;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (NGX_HTTP_SSL)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        u-&amp;gt;ssl_name = u-&amp;gt;resolved-&amp;gt;host;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        host = &amp;amp;u-&amp;gt;resolved-&amp;gt;host;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (u-&amp;gt;resolved-&amp;gt;sockaddr) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (u-&amp;gt;resolved-&amp;gt;port == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;amp;&amp;amp; u-&amp;gt;resolved-&amp;gt;sockaddr-&amp;gt;sa_family != AF_UNIX)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                ngx_log_error(NGX_LOG_ERR, r-&amp;gt;connection-&amp;gt;&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              &lt;span class=&quot;string&quot;&gt;&quot;no port in upstream \&quot;%V\&quot;&quot;&lt;/span&gt;, host);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                ngx_http_upstream_finalize_request(r, u,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                               NGX_HTTP_INTERNAL_SERVER_ERROR);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (ngx_http_upstream_create_round_robin_peer(r, u-&amp;gt;resolved)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                != NGX_OK)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                ngx_http_upstream_finalize_request(r, u,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                               NGX_HTTP_INTERNAL_SERVER_ERROR);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ngx_http_upstream_connect(r, u);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        umcf = ngx_http_get_module_main_conf(r, ngx_http_upstream_module);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        uscfp = umcf-&amp;gt;upstreams.elts;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;/* 在显式/隐式定义的upstream中查找 */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; umcf-&amp;gt;upstreams.nelts; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            uscf = uscfp[i];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (uscf-&amp;gt;host.len == host-&amp;gt;len&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;amp;&amp;amp; ((uscf-&amp;gt;port == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; u-&amp;gt;resolved-&amp;gt;no_port)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                     || uscf-&amp;gt;port == u-&amp;gt;resolved-&amp;gt;port)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;amp;&amp;amp; ngx_strncasecmp(uscf-&amp;gt;host.data, host-&amp;gt;data, host-&amp;gt;len) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;goto&lt;/span&gt; found;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (u-&amp;gt;resolved-&amp;gt;port == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ngx_log_error(NGX_LOG_ERR, r-&amp;gt;connection-&amp;gt;&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &lt;span class=&quot;string&quot;&gt;&quot;no port in upstream \&quot;%V\&quot;&quot;&lt;/span&gt;, host);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ngx_http_upstream_finalize_request(r, u,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                               NGX_HTTP_INTERNAL_SERVER_ERROR);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        temp.name = *host;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ctx = ngx_resolve_start(clcf-&amp;gt;resolver, &amp;amp;temp);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (ctx == &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ngx_http_upstream_finalize_request(r, u,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                               NGX_HTTP_INTERNAL_SERVER_ERROR);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (ctx == NGX_NO_RESOLVER) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ngx_log_error(NGX_LOG_ERR, r-&amp;gt;connection-&amp;gt;&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &lt;span class=&quot;string&quot;&gt;&quot;no resolver defined to resolve %V&quot;&lt;/span&gt;, host);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ngx_http_upstream_finalize_request(r, u, NGX_HTTP_BAD_GATEWAY);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ctx-&amp;gt;name = *host;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ctx-&amp;gt;handler = ngx_http_upstream_resolve_handler;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ctx-&amp;gt;data = r;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ctx-&amp;gt;timeout = clcf-&amp;gt;resolver_timeout;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        u-&amp;gt;resolved-&amp;gt;ctx = ctx;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (ngx_resolve_name(ctx) != NGX_OK) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            u-&amp;gt;resolved-&amp;gt;ctx = &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ngx_http_upstream_finalize_request(r, u,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                               NGX_HTTP_INTERNAL_SERVER_ERROR);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;found:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (uscf == &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ngx_log_error(NGX_LOG_ALERT, r-&amp;gt;connection-&amp;gt;&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &lt;span class=&quot;string&quot;&gt;&quot;no upstream configuration&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ngx_http_upstream_finalize_request(r, u,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                           NGX_HTTP_INTERNAL_SERVER_ERROR);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;if&lt;/span&gt; (NGX_HTTP_SSL)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    u-&amp;gt;ssl_name = uscf-&amp;gt;host;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (uscf-&amp;gt;peer.init(r, uscf) != NGX_OK) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ngx_http_upstream_finalize_request(r, u,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                           NGX_HTTP_INTERNAL_SERVER_ERROR);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    u-&amp;gt;peer.start_time = ngx_current_msec;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (u-&amp;gt;conf-&amp;gt;next_upstream_tries&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;amp;&amp;amp; u-&amp;gt;peer.tries &amp;gt; u-&amp;gt;conf-&amp;gt;next_upstream_tries)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        u-&amp;gt;peer.tries = u-&amp;gt;conf-&amp;gt;next_upstream_tries;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ngx_http_upstream_connect(r, u);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;详细分析&quot;&gt;&lt;a href=&quot;#详细分析&quot; class=&quot;headerlink&quot; title=&quot;详细分析&quot;&gt;&lt;/a&gt;详细分析&lt;/h3&gt;&lt;h4 id=&quot;场景1&quot;&gt;&lt;a href=&quot;#场景1&quot; class=&quot;headerlink&quot; title=&quot;场景1&quot;&gt;&lt;/a&gt;场景1&lt;/h4&gt;&lt;p&gt;解析 &lt;code&gt;proxy_pass&lt;/code&gt; 的函数 &lt;code&gt;ngx_http_proxy_pass&lt;/code&gt; 中，没有找到 $ 符号（即，变量设置域名），走 &lt;code&gt;ngx_http_proxy_pass&lt;/code&gt; 后半部分的处理逻辑。&lt;code&gt;ngx_http_upstream_init_round_robin&lt;/code&gt; 初始化 &lt;code&gt;upstream&lt;/code&gt; 时，走显式定义 &lt;code&gt;upstream&lt;/code&gt; 的逻辑。&lt;code&gt;proxy_pass&lt;/code&gt; 转发请求初始化时，&lt;code&gt;ngx_http_upstream_init_request&lt;/code&gt; 中直接使用 &lt;code&gt;upstream&lt;/code&gt; 中的后端 server 建立连接。&lt;/p&gt;
&lt;h4 id=&quot;场景2&quot;&gt;&lt;a href=&quot;#场景2&quot; class=&quot;headerlink&quot; title=&quot;场景2&quot;&gt;&lt;/a&gt;场景2&lt;/h4&gt;&lt;p&gt;&lt;code&gt;ngx_http_upstream_init_round_robin&lt;/code&gt; 初始化 &lt;code&gt;upstream&lt;/code&gt; 时，走隐式定义 upstream 的逻辑，会调用 &lt;code&gt;ngx_inet_resolve_host&lt;/code&gt; 对 &lt;code&gt;proxy_pass&lt;/code&gt; 中的域名进行解析，设置 &lt;code&gt;upstream&lt;/code&gt;。&lt;code&gt;proxy_pass&lt;/code&gt; 转发请求初始化时，&lt;code&gt;ngx_http_upstream_init_request&lt;/code&gt; 中直接使用 &lt;code&gt;upstream&lt;/code&gt; 中的设置，也就是利用本地设置的 DNS 服务器解析出的 IP，建立连接。&lt;/p&gt;
&lt;h4 id=&quot;场景3&quot;&gt;&lt;a href=&quot;#场景3&quot; class=&quot;headerlink&quot; title=&quot;场景3&quot;&gt;&lt;/a&gt;场景3&lt;/h4&gt;&lt;p&gt;解析 &lt;code&gt;proxy_pass&lt;/code&gt; 指令时，找到了 $ 符号，设置 &lt;code&gt;ngx_http_script_compile_t&lt;/code&gt;，并利用 &lt;code&gt;ngx_http_script_compile&lt;/code&gt; 进行编译，不走后半部分逻辑。配置文件没有显式/隐式定义 &lt;code&gt;upstream&lt;/code&gt;，所以不会调用 &lt;code&gt;ngx_http_upstream_init_round_robin&lt;/code&gt; 方法。&lt;code&gt;proxy_pass&lt;/code&gt; 转发请求初始化时，&lt;code&gt;ngx_http_upstream_init_request&lt;/code&gt; 中发现没有显式也没有隐式定义的 &lt;code&gt;upstream&lt;/code&gt;，随后调用 &lt;code&gt;ngx_resolve_start&lt;/code&gt;，对域名进行解析，之后将请求转发过去。&lt;/p&gt;
&lt;h4 id=&quot;场景4&quot;&gt;&lt;a href=&quot;#场景4&quot; class=&quot;headerlink&quot; title=&quot;场景4&quot;&gt;&lt;/a&gt;场景4&lt;/h4&gt;&lt;p&gt;解析 &lt;code&gt;proxy_pass&lt;/code&gt; 指令时，找到了 $ 符号，设置 &lt;code&gt;ngx_http_script_compile_t&lt;/code&gt;，并利用 &lt;code&gt;ngx_http_script_compile&lt;/code&gt; 进行编译，不走后半部分逻辑。显式调用了 &lt;code&gt;upstream&lt;/code&gt;，所以调用 &lt;code&gt;ngx_http_upstream_init_round_robin&lt;/code&gt; 方法中的显式 &lt;code&gt;upstream&lt;/code&gt; 的处理逻辑。&lt;code&gt;proxy_pass&lt;/code&gt; 转发请求初始化时，&lt;code&gt;ngx_http_upstream_init_request&lt;/code&gt; 中优先查找 &lt;code&gt;upstream&lt;/code&gt;，如果找到了，直接将请求转发到 &lt;code&gt;upstream&lt;/code&gt; 中的后端 server 上。如果 &lt;code&gt;upstream&lt;/code&gt; 中没有找到，则对域名进行解析，然后将请求转发到解析后的 IP 上。&lt;/p&gt;
&lt;h4 id=&quot;场景5&quot;&gt;&lt;a href=&quot;#场景5&quot; class=&quot;headerlink&quot; title=&quot;场景5&quot;&gt;&lt;/a&gt;场景5&lt;/h4&gt;&lt;p&gt;基本与场景 4 相同，不同之处在于调用 &lt;code&gt;ngx_http_upstream_init_round_robin&lt;/code&gt; 方法时，走隐式 &lt;code&gt;upstream&lt;/code&gt; 部分的处理逻辑。&lt;/p&gt;
&lt;h4 id=&quot;场景6&quot;&gt;&lt;a href=&quot;#场景6&quot; class=&quot;headerlink&quot; title=&quot;场景6&quot;&gt;&lt;/a&gt;场景6&lt;/h4&gt;&lt;p&gt;与场景 2 相同。&lt;/p&gt;
&lt;h4 id=&quot;场景7&quot;&gt;&lt;a href=&quot;#场景7&quot; class=&quot;headerlink&quot; title=&quot;场景7&quot;&gt;&lt;/a&gt;场景7&lt;/h4&gt;&lt;p&gt;与场景 1 相同。&lt;/p&gt;
&lt;h4 id=&quot;场景8&quot;&gt;&lt;a href=&quot;#场景8&quot; class=&quot;headerlink&quot; title=&quot;场景8&quot;&gt;&lt;/a&gt;场景8&lt;/h4&gt;&lt;p&gt;实际上是隐式创建了 &lt;code&gt;upstream&lt;/code&gt;，但是因为 &lt;code&gt;proxy_pass&lt;/code&gt; 中指定了 IP 和端口号，所以&lt;code&gt;ngx_http_upstream_init_round_robin&lt;/code&gt; 初始化 &lt;code&gt;upstream&lt;/code&gt; 时，&lt;code&gt;us-&amp;gt;servers&lt;/code&gt; 不为空，所以走该函数的上半部分逻辑。与场景 1 有些类似。&lt;/p&gt;
&lt;p&gt;参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.jianshu.com/p/5caa48664da5&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.jianshu.com/p/5caa48664da5&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.zhihu.com/question/61786355&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.zhihu.com/question/61786355&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;背景描述&quot;&gt;&lt;a href=&quot;#背景描述&quot; class=&quot;headerlink&quot; title=&quot;背景描述&quot;&gt;&lt;/a&gt;背景描述&lt;/h2&gt;&lt;p&gt;业务场景：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;用户 ----&amp;gt; waf ----&amp;gt; 后端服务&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;waf&lt;/code&gt; 是采用 Nginx 做的二次开发，做了一些安全验证后将请求转发到后端服务，通过 nginx &lt;code&gt;proxy_pass&lt;/code&gt; 转发。 &lt;code&gt;proxy_pass&lt;/code&gt; 后面直接配置的是域名（如：xxxxx-1760550967.cn-northwest-1.elb.amazonaws.com.cn ）&lt;/p&gt;
&lt;h2 id=&quot;故障现象&quot;&gt;&lt;a href=&quot;#故障现象&quot; class=&quot;headerlink&quot; title=&quot;故障现象&quot;&gt;&lt;/a&gt;故障现象&lt;/h2&gt;&lt;p&gt;有部分用户开始反馈访问站点出错 &lt;code&gt;504 Gateway Time-out&lt;/code&gt;, 通过监控查到有部分请求打了一个下线的 IP 上。这里简单简述下故障场景：使用nginx做反向代理，将请求发送到一个域名(例如: &lt;code&gt;proxy_pass http://www.test.com&lt;/code&gt; 该域名对应的 IP 是 A) ，刚开始运行一切正常，但是当运行了一段时间以后，域名对应的 IP 变了(例如 &lt;a href=&quot;http://www.test.com&quot;&gt;http://www.test.com&lt;/a&gt; 对应的 IP 由 A 变为 B)，nginx 的转发仍然还在向原先的 IP 发送请求，导致业务中断，此时&lt;code&gt;reload nginx&lt;/code&gt; 后才会重新恢复正常，且日志显示数据转发到新的 IP B。&lt;br&gt;
    
    </summary>
    
      <category term="nginx" scheme="http://team.jiunile.com/categories/nginx/"/>
    
      <category term="反向代理" scheme="http://team.jiunile.com/categories/nginx/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/"/>
    
    
      <category term="nginx" scheme="http://team.jiunile.com/tags/nginx/"/>
    
      <category term="proxy_pass" scheme="http://team.jiunile.com/tags/proxy-pass/"/>
    
  </entry>
  
  <entry>
    <title>简单直观的阐述 Kubernetes Istio</title>
    <link href="http://team.jiunile.com//blog/2020/11/k8s-istio-intro.html"/>
    <id>http://team.jiunile.com//blog/2020/11/k8s-istio-intro.html</id>
    <published>2020-11-09T12:00:00.000Z</published>
    <updated>2020-11-09T04:59:03.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;什么是-Istio？&quot;&gt;&lt;a href=&quot;#什么是-Istio？&quot; class=&quot;headerlink&quot; title=&quot;什么是 Istio？&quot;&gt;&lt;/a&gt;什么是 Istio？&lt;/h2&gt;&lt;p&gt;Istio 是一个服务网格，它允许在集群中的 pods 和服务之间进行更详细、复杂和可观察的通信。&lt;/p&gt;
&lt;p&gt;它通过使用 CRD 扩展 Kubernetes API 来进行管理。它将代理容器注入到所有 pods 中，然后由这些 pods 控制集群中的流量。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;Kubernetes-Services&quot;&gt;&lt;a href=&quot;#Kubernetes-Services&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes Services&quot;&gt;&lt;/a&gt;Kubernetes Services&lt;/h2&gt;&lt;p&gt;从这里开始，您应该已经了解了 Kubernetes Services，可以阅读&lt;a href=&quot;https://medium.com/swlh/kubernetes-services-simply-visually-explained-2d84e58d70e5&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;本系列的第 1 部分&lt;/a&gt;。我们现在将简短地探讨如何实现 Kubernetes Services。我认为这有助于理解 Istio 如何做相同和不同的事情。&lt;br&gt;&lt;img src=&quot;/images/k8s/istio_1.png&quot; alt=&quot;Kubernetes native service request&quot;&gt;&lt;/p&gt;
&lt;p&gt;图 1 显示了一个 Kubernetes 集群，该集群有两个节点和 4 个 pod，每个 pod 都有一个容器。服务 &lt;code&gt;service-nginx&lt;/code&gt; 指向 nginx pods，服务 &lt;code&gt;service-python&lt;/code&gt; 指向python pods。红线显示了从 &lt;code&gt;pod1-nginx&lt;/code&gt; 中的 nginx 容器向 &lt;code&gt;service-python&lt;/code&gt; 服务发出的请求，该服务将请求重定向到 &lt;code&gt;pod2-python&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;默认情况下，ClusterIP 服务执行简单的随机或循环分发。Kubernetes 中的 Services 并不存在于特定的节点上，而是存在于整个集群中。我们可以在图 2 中看到更多细节:&lt;br&gt;&lt;img src=&quot;/images/k8s/istio_2.png&quot; alt=&quot;Kubernetes native service request with kube-proxy&quot;&gt;&lt;/p&gt;
&lt;p&gt;图 2 显示了与图 1 相同的示例，只是更详细一些。Kubernetes 中的服务是由运行在每个节点上的 &lt;code&gt;kube-proxy&lt;/code&gt; 组件实现的。该组件创建 iptables 规则，并将请求重定向到 Pod。因此，服务就是 iptables 规则。(还有其他不使用 iptables 的代理模式，但过程是相同的。)&lt;/p&gt;
&lt;p&gt;在图 2 中，我们看到 Kubernetes API 对每个 &lt;code&gt;kube-proxy&lt;/code&gt; 进行编程。每当服务配置或服务的pods 发生更改时，就会发生这种情况。通过这种方式，Kubernetes API (以及整个主节点或控制平面)可以下降，但服务仍然可以工作。&lt;/p&gt;
&lt;h2 id=&quot;Kubernetes-Istio&quot;&gt;&lt;a href=&quot;#Kubernetes-Istio&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes Istio&quot;&gt;&lt;/a&gt;Kubernetes Istio&lt;/h2&gt;&lt;p&gt;现在我们来看一个配置了 Istio 的相同示例:&lt;br&gt;&lt;img src=&quot;/images/k8s/istio_3.png&quot; alt=&quot;Istio Control Plane programs istio-proxy&quot;&gt;&lt;/p&gt;
&lt;p&gt;图 3 显示安装了 Istio，它随 Istio 控制平面一起提供。还常见的是，每个 pod 都有第二个称为 &lt;code&gt;istio-proxy&lt;/code&gt; 的容器，该容器在创建期间自动将其注入到 pods 中。&lt;/p&gt;
&lt;p&gt;Istio 最常见的代理是具有惊人能力的 &lt;a href=&quot;https://www.envoyproxy.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Envoy&lt;/a&gt;。虽然可以使用其他代理（&lt;a href=&quot;https://www.nginx.com/blog/nginmesh-nginx-as-a-proxy-in-an-istio-service-mesh/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;如 Nginx&lt;/a&gt;），这就是为什么我们从现在开始只将代理称为&lt;code&gt;istio-proxy&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;我们可以看到不再显示 &lt;code&gt;kube-proxy&lt;/code&gt; 组件，这样做是为了保持图像的整洁。这些组件仍然存在，但是拥有 &lt;code&gt;istio-proxy&lt;/code&gt; 的 pods 将不再使用 &lt;code&gt;kube-proxy&lt;/code&gt; 组件。&lt;/p&gt;
&lt;p&gt;每当配置或服务发生变化时，Istio 控制平面就会对所有 &lt;code&gt;istio-proxy&lt;/code&gt; sidecars 进行编程。类似于图 2 中 Kubernetes API 程序所有 &lt;code&gt;kube-proxy&lt;/code&gt; 组件的方式。Istio 控制平面使用现有的 Kubernetes 服务来接收每个服务点所指向的所有 pods 。通过使用 pod IP 地址，Istio 实现了自己的路由。&lt;/p&gt;
&lt;p&gt;在 Istio 控制平面对所有 &lt;code&gt;istio-proxy&lt;/code&gt; sidecars 编程之后，它看起来是这样的:&lt;br&gt;&lt;img src=&quot;/images/k8s/istio_4.png&quot; alt=&quot;Istio Control Plane programmed all istio-proxys&quot;&gt;&lt;/p&gt;
&lt;p&gt;在图 4 中，我们看到 Istio 控制平面如何将当前配置应用到集群中的所有 &lt;code&gt;istio-proxy&lt;/code&gt; 容器。为了简单起见，还包括 “ClusterIP” 声明。虽然 ClusterIP 是 Kubernetes 的内部服务类型。Istio 将把 Kubernetes 服务声明转换成它自己的路由声明。但是想象一下图像中显示的情况会很有帮助。&lt;/p&gt;
&lt;p&gt;让我们看看如何使用 Istio 发出请求:&lt;br&gt;&lt;img src=&quot;/images/k8s/istio_5.png&quot; alt=&quot;Request made with Istio&quot;&gt;&lt;/p&gt;
&lt;p&gt;在图 5 中，所有的 &lt;code&gt;istio-proxy&lt;/code&gt; 容器已经被 Istio 控制平面编程，并包含所有必要的路由信息，如图 3/4 所示。来自 &lt;code&gt;pod1-nginx&lt;/code&gt; 的 nginx 容器向 &lt;code&gt;service-python&lt;/code&gt; 发出请求。&lt;/p&gt;
&lt;p&gt;请求被 &lt;code&gt;pod1-nginx&lt;/code&gt; 的 &lt;code&gt;istio-proxy&lt;/code&gt; 容器拦截，并被重定向到一个 python pod 的 &lt;code&gt;istio-proxy&lt;/code&gt; 容器，该容器随后将请求重定向到 python 容器。&lt;/p&gt;
&lt;h2 id=&quot;这里发生了什么&quot;&gt;&lt;a href=&quot;#这里发生了什么&quot; class=&quot;headerlink&quot; title=&quot;这里发生了什么?&quot;&gt;&lt;/a&gt;这里发生了什么?&lt;/h2&gt;&lt;p&gt;图 1-5 显示了使用 nginx 和 python pod 的 Kubernetes 应用程序的相同示例。我们已经看到了使用默认的 Kubernetes 服务和使用 Istio 是如何发生请求的。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;重要的是&lt;/strong&gt;：无论使用什么方法，结果都是相同的，并且不需要更改应用程序本身，只需要更改基础结构代码。&lt;/p&gt;
&lt;h2 id=&quot;为什么要这样，为什么要使用-Istio？&quot;&gt;&lt;a href=&quot;#为什么要这样，为什么要使用-Istio？&quot; class=&quot;headerlink&quot; title=&quot;为什么要这样，为什么要使用 Istio？&quot;&gt;&lt;/a&gt;为什么要这样，为什么要使用 Istio？&lt;/h2&gt;&lt;p&gt;如果在使用 Istio 的时候没有什么变化(nginx pod 仍然可以像以前一样连接到 python pod)，为什么要首先使用 Istio 呢？&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;其惊人的优势是&lt;/strong&gt;，现在所有流量都通过每个 Pod 中的 &lt;code&gt;istio-proxy&lt;/code&gt; 容器进行路由。每当 &lt;code&gt;istio-proxy&lt;/code&gt; 接收并重定向一个请求时，它还会将有关该请求的信息提交给 Istio 控制平面。&lt;/p&gt;
&lt;p&gt;因此 Istio 控制平面可以准确地知道该请求来自哪个 pod、存在哪些 HTTP 头、从一个&lt;code&gt;istio-proxy&lt;/code&gt; 到另一个 &lt;code&gt;istio-proxy&lt;/code&gt; 的请求需要多长时间等等。在具有许多彼此通信的服务的群集中，这可以提高可观察性并更好地控制所有流量。&lt;/p&gt;
&lt;h3 id=&quot;先进的路由&quot;&gt;&lt;a href=&quot;#先进的路由&quot; class=&quot;headerlink&quot; title=&quot;先进的路由&quot;&gt;&lt;/a&gt;先进的路由&lt;/h3&gt;&lt;p&gt;Kubernetes 内部 Services 只能对 pods 执行轮询或随机分发请求。使用 Istio 可以实现更复杂的方式。比如，如果发生错误，根据请求头进行重定向，或者重定向到最少使用的服务。&lt;/p&gt;
&lt;h3 id=&quot;部署&quot;&gt;&lt;a href=&quot;#部署&quot; class=&quot;headerlink&quot; title=&quot;部署&quot;&gt;&lt;/a&gt;部署&lt;/h3&gt;&lt;p&gt;它允许将一定比例的流量路由到特定的服务版本，因此允许绿色/蓝色和金丝雀部署。&lt;/p&gt;
&lt;h3 id=&quot;加密&quot;&gt;&lt;a href=&quot;#加密&quot; class=&quot;headerlink&quot; title=&quot;加密&quot;&gt;&lt;/a&gt;加密&lt;/h3&gt;&lt;p&gt;可以对 pods 之间从 &lt;code&gt;istio-proxy&lt;/code&gt; 到 &lt;code&gt;istio-proxy&lt;/code&gt; 的集群内部通信进行加密。&lt;/p&gt;
&lt;h3 id=&quot;监控-图形生成&quot;&gt;&lt;a href=&quot;#监控-图形生成&quot; class=&quot;headerlink&quot; title=&quot;监控/图形生成&quot;&gt;&lt;/a&gt;监控/图形生成&lt;/h3&gt;&lt;p&gt;Istio 连接到 Prometheus 等监控工具。它也可以与 Kiali 一起很好的显示所有的服务和他们的流量。&lt;br&gt;&lt;img src=&quot;/images/k8s/istio_6.png&quot; alt=&quot;kiali&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;追踪&quot;&gt;&lt;a href=&quot;#追踪&quot; class=&quot;headerlink&quot; title=&quot;追踪&quot;&gt;&lt;/a&gt;追踪&lt;/h3&gt;&lt;p&gt;因为 Istio 控制平面拥有大量关于请求的数据，所以可以使用 Jaeger 等工具跟踪和检查这些数据。&lt;br&gt;&lt;img src=&quot;/images/k8s/istio_7.png&quot; alt=&quot;jaeger&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;多集群-mesh&quot;&gt;&lt;a href=&quot;#多集群-mesh&quot; class=&quot;headerlink&quot; title=&quot;多集群 mesh&quot;&gt;&lt;/a&gt;多集群 mesh&lt;/h3&gt;&lt;p&gt;Istio 有一个内部服务注册中心，它可以使用现有的 Kubernetes i服务。但是也可以从集群外部添加资源，甚至将不同的集群连接到一个网格中。&lt;br&gt;&lt;img src=&quot;/images/k8s/istio_8.png&quot; alt=&quot;multiple-clusters&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Sidecar-注入&quot;&gt;&lt;a href=&quot;#Sidecar-注入&quot; class=&quot;headerlink&quot; title=&quot;Sidecar 注入&quot;&gt;&lt;/a&gt;Sidecar 注入&lt;/h2&gt;&lt;p&gt;为了使 Istio 工作，每一个作为网状结构一部分的 pod 都需要注入 &lt;code&gt;istio-proxy&lt;/code&gt; sidecar。这可以在 pod 创建期间为整个名称空间自动完成(通过 &lt;a href=&quot;https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Admission Controller 钩子&lt;/a&gt;，也可以手动完成。&lt;/p&gt;
&lt;h2 id=&quot;Istio-会取代-Kubernetes-的服务吗&quot;&gt;&lt;a href=&quot;#Istio-会取代-Kubernetes-的服务吗&quot; class=&quot;headerlink&quot; title=&quot;Istio 会取代 Kubernetes 的服务吗?&quot;&gt;&lt;/a&gt;Istio 会取代 Kubernetes 的服务吗?&lt;/h2&gt;&lt;p&gt;不。当我开始使用 Istio 时，我问自己的一个问题是它是否会取代现有的 Kubernetes 服务。答案是否定的。Istio 使用现有的 Kubernetes 服务获取它们的所有 endpoints/pod IP 地址。&lt;/p&gt;
&lt;h2 id=&quot;Istio-取代了-Kubernetes-的-Ingress-吗&quot;&gt;&lt;a href=&quot;#Istio-取代了-Kubernetes-的-Ingress-吗&quot; class=&quot;headerlink&quot; title=&quot;Istio 取代了 Kubernetes 的 Ingress 吗?&quot;&gt;&lt;/a&gt;Istio 取代了 Kubernetes 的 Ingress 吗?&lt;/h2&gt;&lt;p&gt;是的。Istio 提供了新的资源，比如网关和虚拟服务，甚至还附带了 ingress 转换器&lt;code&gt;istioctl convert-ingress&lt;/code&gt;。一个很好的来源是 &lt;a href=&quot;https://istio.io/docs/concepts/traffic-management&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://istio.io/docs/concepts/traffic-management&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;图 6 显示了 Istio 网关如何处理进入流量。网关本身也是一个 &lt;code&gt;istio-proxy&lt;/code&gt; 组件。&lt;br&gt;&lt;img src=&quot;/images/k8s/istio_9.png&quot; alt=&quot;Istio Gateway&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;控制平面组件&quot;&gt;&lt;a href=&quot;#控制平面组件&quot; class=&quot;headerlink&quot; title=&quot;控制平面组件&quot;&gt;&lt;/a&gt;控制平面组件&lt;/h2&gt;&lt;p&gt;Istio 控制平面由几个较小的部件组成，如 &lt;code&gt;Pilot&lt;/code&gt;、&lt;code&gt;Mixer&lt;/code&gt;、&lt;code&gt;Citadel&lt;/code&gt; 和 &lt;code&gt;Galley&lt;/code&gt;。如果您想深入研究，我建议您访问 &lt;a href=&quot;https://istio.io/docs/ops/deployment/architecture&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://istio.io/docs/ops/deployment/architecture&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;如果-Istio-控制平面关闭会发生什么？&quot;&gt;&lt;a href=&quot;#如果-Istio-控制平面关闭会发生什么？&quot; class=&quot;headerlink&quot; title=&quot;如果 Istio 控制平面关闭会发生什么？&quot;&gt;&lt;/a&gt;如果 Istio 控制平面关闭会发生什么？&lt;/h2&gt;&lt;p&gt;因为所有的 &lt;code&gt;istio-proxy&lt;/code&gt;  sidecar 都已经编程好了，所以 istio 的控制平面可以关闭，流量也会像以前一样工作。但是配置更新或新创建的 pods 不会被应用。&lt;/p&gt;
&lt;p&gt;但对于高级路由，如将流量发送到使用最少的 pod 或策略(&lt;a href=&quot;https://istio.io/docs/tasks/policy-enforcement&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://istio.io/docs/tasks/policy-enforcement&lt;/a&gt;)，所有 &lt;code&gt;istio-proxys&lt;/code&gt; 之间需要通过 istio 控制平面进行通信。然后，在允许请求之前，每个 &lt;code&gt;istio-proxy&lt;/code&gt; 都需要检查 istio 控制平面。&lt;/p&gt;
&lt;p&gt;为了使这些配置正常工作，我认为控制平面必须始终可用。如果您有与此相关的链接，请随时添加评论。&lt;/p&gt;
&lt;h2 id=&quot;下一步你能做什么？&quot;&gt;&lt;a href=&quot;#下一步你能做什么？&quot; class=&quot;headerlink&quot; title=&quot;下一步你能做什么？&quot;&gt;&lt;/a&gt;下一步你能做什么？&lt;/h2&gt;&lt;p&gt;我写了一篇关于 &lt;a href=&quot;https://medium.com/@wuestkamp/kubernetes-istio-canary-deployment-5ecfd7920e1c?source=friends_link&amp;amp;sk=2be48393ac175a2199bf5d486cb91acf&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Istio Canray&lt;/a&gt; 部署的示例文章。&lt;/p&gt;
&lt;p&gt;Istio 提供了一个很好的示例应用程序和一些微服务。如果你喜欢进入 Istio，这是一个很好的开始方法：&lt;a href=&quot;https://istio.io/docs/setup/getting-started/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://istio.io/docs/setup/getting-started&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;如果你想更深入地研究，&lt;a href=&quot;https://www.youtube.com/watch?v=cB611FtjHcQ&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这段视频&lt;/a&gt;也是很棒的。&lt;/p&gt;
&lt;h2 id=&quot;回顾&quot;&gt;&lt;a href=&quot;#回顾&quot; class=&quot;headerlink&quot; title=&quot;回顾&quot;&gt;&lt;/a&gt;回顾&lt;/h2&gt;&lt;p&gt;这是一个简单的介绍和广泛的概述，我希望对人们有所帮助。Istio 无疑在 Kubernetes 之上又增加了另一层次的复杂性。尽管对于现代微服务架构来说，它实际上提供了一种比必须在应用程序代码本身中实现跟踪或可观察性更简单的方法。&lt;/p&gt;
&lt;p&gt;作者：Kim Wuestkamp 来源：medium.com&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;微信订阅号&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;什么是-Istio？&quot;&gt;&lt;a href=&quot;#什么是-Istio？&quot; class=&quot;headerlink&quot; title=&quot;什么是 Istio？&quot;&gt;&lt;/a&gt;什么是 Istio？&lt;/h2&gt;&lt;p&gt;Istio 是一个服务网格，它允许在集群中的 pods 和服务之间进行更详细、复杂和可观察的通信。&lt;/p&gt;
&lt;p&gt;它通过使用 CRD 扩展 Kubernetes API 来进行管理。它将代理容器注入到所有 pods 中，然后由这些 pods 控制集群中的流量。&lt;br&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/categories/kubernetes/"/>
    
      <category term="istio" scheme="http://team.jiunile.com/categories/kubernetes/istio/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="istio" scheme="http://team.jiunile.com/tags/istio/"/>
    
  </entry>
  
</feed>

<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>CloudNative 架构</title>
  <subtitle>CloudNative|云原生应用架构|云原生架构|容器化架构|微服务架构|平台架构|基础架构</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://icyxp.github.io/"/>
  <updated>2019-03-15T09:36:34.000Z</updated>
  <id>http://icyxp.github.io/</id>
  
  <author>
    <name>icyboy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>kuberenetes 云应用实践</title>
    <link href="http://icyxp.github.io//blog/2019/03/k8s-cloud.html"/>
    <id>http://icyxp.github.io//blog/2019/03/k8s-cloud.html</id>
    <published>2019-03-15T04:00:00.000Z</published>
    <updated>2019-03-15T09:36:34.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;如何使用云盘&quot;&gt;&lt;a href=&quot;#如何使用云盘&quot; class=&quot;headerlink&quot; title=&quot;如何使用云盘&quot;&gt;&lt;/a&gt;如何使用云盘&lt;/h2&gt;&lt;h3 id=&quot;aws-ebs&quot;&gt;&lt;a href=&quot;#aws-ebs&quot; class=&quot;headerlink&quot; title=&quot;aws ebs&quot;&gt;&lt;/a&gt;aws ebs&lt;/h3&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;####设置IAM角色并分配到机器上&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;具有controlplane(控制面板)角色的节点的IAM策略：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight json&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;&quot;Version&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;2012-10-17&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;&quot;Statement&quot;&lt;/span&gt;: [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;&quot;Effect&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;Allow&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;&quot;Action&quot;&lt;/span&gt;: [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;autoscaling:DescribeAutoScalingGroups&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;autoscaling:DescribeLaunchConfigurations&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;autoscaling:DescribeTags&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:DescribeInstances&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:DescribeRegions&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:DescribeRouteTables&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:DescribeSecurityGroups&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:DescribeSubnets&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:DescribeVolumes&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:CreateSecurityGroup&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:CreateTags&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:CreateVolume&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:ModifyInstanceAttribute&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:ModifyVolume&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:AttachVolume&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:AuthorizeSecurityGroupIngress&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:CreateRoute&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:DeleteRoute&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:DeleteSecurityGroup&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:DeleteVolume&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:DetachVolume&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:RevokeSecurityGroupIngress&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ec2:DescribeVpcs&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:AddTags&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:AttachLoadBalancerToSubnets&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:ApplySecurityGroupsToLoadBalancer&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:CreateLoadBalancer&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:CreateLoadBalancerPolicy&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:CreateLoadBalancerListeners&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:ConfigureHealthCheck&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:DeleteLoadBalancer&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:DeleteLoadBalancerListeners&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:DescribeLoadBalancers&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:DescribeLoadBalancerAttributes&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:DetachLoadBalancerFromSubnets&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:DeregisterInstancesFromLoadBalancer&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:ModifyLoadBalancerAttributes&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:RegisterInstancesWithLoadBalancer&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:SetLoadBalancerPoliciesForBackendServer&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:AddTags&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:CreateListener&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:CreateTargetGroup&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:DeleteListener&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:DeleteTargetGroup&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:DescribeListeners&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:DescribeLoadBalancerPolicies&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:DescribeTargetGroups&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:DescribeTargetHealth&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:ModifyListener&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:ModifyTargetGroup&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:RegisterTargets&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;elasticloadbalancing:SetLoadBalancerPoliciesOfListener&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;iam:CreateServiceLinkedRole&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;kms:DescribeKey&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ],&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;&quot;Resource&quot;&lt;/span&gt;: [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;*&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;worker角色的节点的IAM策略&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight json&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;&quot;Version&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;2012-10-17&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;&quot;Statement&quot;&lt;/span&gt;: [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;Effect&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;Allow&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;Action&quot;&lt;/span&gt;: [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;ec2:DescribeInstances&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;ec2:DescribeRegions&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;ecr:GetAuthorizationToken&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;ecr:BatchCheckLayerAvailability&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;ecr:GetDownloadUrlForLayer&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;ecr:GetRepositoryPolicy&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;ecr:DescribeRepositories&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;ecr:ListImages&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;ecr:BatchGetImage&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ],&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;Resource&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;*&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;配置ClusterID&quot;&gt;&lt;a href=&quot;#配置ClusterID&quot; class=&quot;headerlink&quot; title=&quot;配置ClusterID&quot;&gt;&lt;/a&gt;配置ClusterID&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;需要在机器上打上标签，如果不配置会产生以下错误&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;failed to run Kubelet: could not init cloud provider &lt;span class=&quot;string&quot;&gt;&quot;aws&quot;&lt;/span&gt;: AWS cloud failed to find ClusterID&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;标 签 Key ： &lt;code&gt;kubernetes.io/cluster/CLUSTERID&lt;/code&gt;&lt;br&gt;标签Value：  &lt;code&gt;owned&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;CLUSTERID&lt;/code&gt; 可以为任何值&lt;/p&gt;
&lt;h4 id=&quot;kubernetes配置&quot;&gt;&lt;a href=&quot;#kubernetes配置&quot; class=&quot;headerlink&quot; title=&quot;kubernetes配置&quot;&gt;&lt;/a&gt;kubernetes配置&lt;/h4&gt;&lt;p&gt;需要kube-apiserver, kube-controller-manager以及kubelet 启动加上 &lt;code&gt;--cloud-provider=aws&lt;/code&gt;参数 , &lt;code&gt;注意&lt;/code&gt;需要在&lt;strong&gt;所有node&lt;/strong&gt;上的kubelet 开启&lt;code&gt;--cloud-provider=aws&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;使用kubeadm 初始化kubernetes设置&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiServerExtraArgs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  cloud-provider:&lt;/span&gt; aws&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;controllerManagerExtraArgs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  cloud-provider:&lt;/span&gt; aws&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;nodeRegistration:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;#建议将Kubelet的名称设置为EC2中节点的私有DNS条目（这可确保它与主机名匹配，如本文前面所述）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; ip&lt;span class=&quot;bullet&quot;&gt;-10&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-15&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-30&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-45.&lt;/span&gt;cn-northwest&lt;span class=&quot;bullet&quot;&gt;-1.&lt;/span&gt;compute.internal&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  kubeletExtraArgs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    cloud-provider:&lt;/span&gt; aws&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;使用kubeadm 命令安装后的情况下&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;kube-apiserver&lt;/code&gt; 修改 &lt;code&gt;/etc/kubernetes/manifests/kube-apiserver.yaml&lt;/code&gt;下的启动参数&lt;/li&gt;
&lt;li&gt;&lt;code&gt;kube-controller-manager&lt;/code&gt; 修改 &lt;code&gt;/etc/kubernetes/manifests/kube-controller-manager.yaml&lt;/code&gt;下的启动参数&lt;/li&gt;
&lt;li&gt;&lt;code&gt;kubelet&lt;/code&gt; 修改 &lt;code&gt;/etc/systemd/system/kubelet.service.d/10-kubeadm.conf&lt;/code&gt; 下的启动参数&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;开始使用EBS&quot;&gt;&lt;a href=&quot;#开始使用EBS&quot; class=&quot;headerlink&quot; title=&quot;开始使用EBS&quot;&gt;&lt;/a&gt;开始使用EBS&lt;/h4&gt;&lt;h5 id=&quot;创建StorageClass&quot;&gt;&lt;a href=&quot;#创建StorageClass&quot; class=&quot;headerlink&quot; title=&quot;创建StorageClass&quot;&gt;&lt;/a&gt;创建StorageClass&lt;/h5&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# cat standard-storageclass.yaml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; StorageClass&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; storage.k8s.io/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; standard&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;provisioner:&lt;/span&gt; kubernetes.io/aws-ebs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;parameters:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  type:&lt;/span&gt; gp2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  zone:&lt;/span&gt; ap-northeast&lt;span class=&quot;bullet&quot;&gt;-1&lt;/span&gt;b&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;reclaimPolicy:&lt;/span&gt; Delete       &lt;span class=&quot;comment&quot;&gt;# 在删除 Pod 的同时，也删除 EBS 磁盘&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# kubectl apply -f standard-storageclass.yaml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h5 id=&quot;创建PVC&quot;&gt;&lt;a href=&quot;#创建PVC&quot; class=&quot;headerlink&quot; title=&quot;创建PVC&quot;&gt;&lt;/a&gt;创建PVC&lt;/h5&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# cat nginx-pv-claim.yaml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; PersistentVolumeClaim&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; nginx-pv-claim&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  accessModes:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; ReadWriteOnce&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    requests:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      storage:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;Gi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  storageClassName:&lt;/span&gt; standard&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# kubectl apply -f nginx-pv-claim.yaml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h5 id=&quot;Pod&quot;&gt;&lt;a href=&quot;#Pod&quot; class=&quot;headerlink&quot; title=&quot;Pod&quot;&gt;&lt;/a&gt;Pod&lt;/h5&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# cat nginx-pv-pod.yaml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; nginx-pv&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    image:&lt;/span&gt; nginx:&lt;span class=&quot;number&quot;&gt;1.7&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.9&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - containerPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    volumeMounts:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; nginx-pv-claim&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      mountPath:&lt;/span&gt; /data&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  volumes:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; nginx-pv-claim&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    persistentVolumeClaim:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      claimName:&lt;/span&gt; nginx-pv-claim&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# kubectl apply -f nginx-pv-pod.yaml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;参考链接&quot;&gt;&lt;a href=&quot;#参考链接&quot; class=&quot;headerlink&quot; title=&quot;参考链接&quot;&gt;&lt;/a&gt;参考链接&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.kubernetes.org.cn/4078.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.kubernetes.org.cn/4078.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.io/docs/concepts/storage/storage-classes/#aws&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/concepts/storage/storage-classes/#aws&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://blog.scottlowe.org/2018/09/28/setting-up-the-kubernetes-aws-cloud-provider/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://blog.scottlowe.org/2018/09/28/setting-up-the-kubernetes-aws-cloud-provider/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;阿里云云盘&quot;&gt;&lt;a href=&quot;#阿里云云盘&quot; class=&quot;headerlink&quot; title=&quot;阿里云云盘&quot;&gt;&lt;/a&gt;阿里云云盘&lt;/h3&gt;&lt;h4 id=&quot;参考链接-1&quot;&gt;&lt;a href=&quot;#参考链接-1&quot; class=&quot;headerlink&quot; title=&quot;参考链接&quot;&gt;&lt;/a&gt;参考链接&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://yq.aliyun.com/articles/629001&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://yq.aliyun.com/articles/629001&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/AliyunContainerService/alicloud-storage-provisioner&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/AliyunContainerService/alicloud-storage-provisioner&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;云应用疑难杂症&quot;&gt;&lt;a href=&quot;#云应用疑难杂症&quot; class=&quot;headerlink&quot; title=&quot;云应用疑难杂症&quot;&gt;&lt;/a&gt;云应用疑难杂症&lt;/h2&gt;&lt;h3 id=&quot;使用云负载均衡器代理APIServer问题&quot;&gt;&lt;a href=&quot;#使用云负载均衡器代理APIServer问题&quot; class=&quot;headerlink&quot; title=&quot;使用云负载均衡器代理APIServer问题&quot;&gt;&lt;/a&gt;使用云负载均衡器代理APIServer问题&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;阿里云/AWS的负载均衡是四层TCP负责，&lt;strong&gt;不支持后端ECS实例既作为Real Server又作为客户端向所在的负载均衡实例发送请求&lt;/strong&gt;。因为返回的数据包只在云服务器内部转发，不经过负载均衡，所以在后端ECS实例上去访问负载均衡的服务地址是不通的。什么意思？就是如果你要使用阿里云的SLB的话，那么你不能在apiserver节点上使用SLB（比如在apiserver 上安装kubectl，然后将apiserver的地址设置为SLB的负载地址使用），因为这样的话就可能造成回环了，所以简单的做法是另外用两个新的节点做HA实例，然后将这两个实例添加到SLB 机器组中。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;aws 使用nlb，指定ip&lt;/li&gt;
&lt;li&gt;aliyun 在apiserver上搭建keepalived&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;如何使用云盘&quot;&gt;&lt;a href=&quot;#如何使用云盘&quot; class=&quot;headerlink&quot; title=&quot;如何使用云盘&quot;&gt;&lt;/a&gt;如何使用云盘&lt;/h2&gt;&lt;h3 id=&quot;aws-ebs&quot;&gt;&lt;a href=&quot;#aws-ebs&quot; class=&quot;headerlink&quot; title=&quot;aws ebs&quot;&gt;&lt;/a&gt;aws ebs&lt;/h3&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="cloud" scheme="http://icyxp.github.io/categories/kubernetes/cloud/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="aws" scheme="http://icyxp.github.io/tags/aws/"/>
    
      <category term="ali" scheme="http://icyxp.github.io/tags/ali/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes内部DNS剖析</title>
    <link href="http://icyxp.github.io//blog/2019/03/k8s-dns.html"/>
    <id>http://icyxp.github.io//blog/2019/03/k8s-dns.html</id>
    <published>2019-03-08T10:00:00.000Z</published>
    <updated>2019-03-08T09:19:41.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;我们可以通过 Service 生成的&lt;code&gt;ClusterIP(VIP)&lt;/code&gt;来访问 Pod 提供的服务，但是在使用的时候还有一个问题：我们怎么知道某个应用的 VIP 呢？比如我们有两个应用，一个是 api 应用，一个是 db 应用，两个应用都是通过&lt;code&gt;Deployment&lt;/code&gt;进行管理的，并且都通过 Service 暴露出了端口提供服务。api 需要连接到 db 这个应用，我们只知道 db 应用的名称和 db 对应的 Service 的名称，但是并不知道它的 VIP 地址，我们前面的 Service 课程中是不是学习到我们通过&lt;code&gt;ClusterIP&lt;/code&gt;就可以访问到后面的&lt;code&gt;Pod&lt;/code&gt;服务，如果我们知道了 VIP 的地址是不是就行了？&lt;/p&gt;
&lt;h2 id=&quot;apiserver&quot;&gt;&lt;a href=&quot;#apiserver&quot; class=&quot;headerlink&quot; title=&quot;apiserver&quot;&gt;&lt;/a&gt;apiserver&lt;/h2&gt;&lt;p&gt;我们知道可以从 apiserver 中直接查询获取到对应 service 的后端 Endpoints信息，所以最简单的办法是从 apiserver 中直接查询，如果偶尔一个特殊的应用，我们通过&lt;code&gt;apiserver&lt;/code&gt;去查询到&lt;code&gt;Service&lt;/code&gt;后面的 &lt;code&gt;Endpoints&lt;/code&gt;直接使用是没问题的，但是如果每个应用都在启动的时候去查询依赖的服务，这不但增加了应用的复杂度，这也导致了我们的应用需要依赖&lt;code&gt;Kubernetes&lt;/code&gt;了，耦合度太高了，不具有通用性。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;环境变量&quot;&gt;&lt;a href=&quot;#环境变量&quot; class=&quot;headerlink&quot; title=&quot;环境变量&quot;&gt;&lt;/a&gt;环境变量&lt;/h2&gt;&lt;p&gt;为了解决上面的问题，在之前的版本中，Kubernetes 采用了环境变量的方法，每个 Pod 启动的时候，会通过环境变量设置所有服务的 IP 和 port 信息，这样 Pod 中的应用可以通过读取环境变量来获取依赖服务的地址信息，这种方法使用起来相对简单，但是有一个很大的问题就是依赖的服务必须在 Pod 启动之前就存在，不然是不会被注入到环境变量中的。比如我们首先创建一个 Nginx 服务：(test-nginx.yaml)&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; apps/v1beta1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; nginx-deploy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    k8s-app:&lt;/span&gt; nginx-demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  replicas:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  template:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        app:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - name:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        image:&lt;/span&gt; nginx:&lt;span class=&quot;number&quot;&gt;1.7&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.9&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - containerPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; nginx-service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    name:&lt;/span&gt; nginx-service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    targetPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  selector:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    app:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;创建上面的服务：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl create &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-nginx.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deployment.apps &lt;span class=&quot;string&quot;&gt;&quot;nginx-deploy&quot;&lt;/span&gt; created&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;service &lt;span class=&quot;string&quot;&gt;&quot;nginx-service&quot;&lt;/span&gt; created&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                                      READY     STATUS    RESTARTS   AGE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nginx-deploy-75675f5897-47h4t             1/1       Running   0          53s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nginx-deploy-75675f5897-mmm8w             1/1       Running   0          53s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get svc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nginx-service   ClusterIP   10.107.225.42    &amp;lt;none&amp;gt;        5000/TCP         1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们可以看到两个 Pod 和一个名为 nginx-service 的服务创建成功了，该 Service 监听的端口是 5000，同时它会把流量转发给它代理的所有 Pod（我们这里就是拥有 app: nginx 标签的两个 Pod）。&lt;/p&gt;
&lt;p&gt;现在我们再来创建一个普通的 Pod，观察下该 Pod 中的环境变量是否包含上面的 nginx-service 的服务信息：（test-pod.yaml）&lt;br&gt;&lt;figure class=&quot;highlight yml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; test-pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; test-service-pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    image:&lt;/span&gt; busybox&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    command:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;/bin/sh&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;-c&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;env&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后创建该测试的 Pod：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl create &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-pod.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pod &lt;span class=&quot;string&quot;&gt;&quot;test-pod&quot;&lt;/span&gt; created&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;等 Pod 创建完成后，我们查看日志信息：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl logs &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;KUBERNETES_PORT=tcp://10.96.0.1:443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;KUBERNETES_SERVICE_PORT=443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;HOSTNAME=&lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;HOME=/root&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NGINX_SERVICE_PORT_5000_TCP_ADDR=10.107.225.42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NGINX_SERVICE_PORT_5000_TCP_PORT=5000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NGINX_SERVICE_PORT_5000_TCP_PROTO=tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;PATH=/usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/sbin:/usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/bin:/usr/sbin:/usr/bin:/sbin:/bin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NGINX_SERVICE_SERVICE_HOST=10.107.225.42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NGINX_SERVICE_PORT_5000_TCP=tcp://10.107.225.42:5000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;KUBERNETES_PORT_443_TCP_PORT=443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;KUBERNETES_PORT_443_TCP_PROTO=tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NGINX_SERVICE_SERVICE_PORT=5000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NGINX_SERVICE_PORT=tcp://10.107.225.42:5000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;KUBERNETES_SERVICE_PORT_HTTPS=443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;KUBERNETES_SERVICE_HOST=10.96.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;PWD=/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们可以看到打印了很多环境变量处理，其中就包括我们刚刚创建的 nginx-service 这个服务，有 HOST、PORT、PROTO、ADDR 等，也包括其他已经存在的 Service 的环境变量，现在如果我们需要在这个 Pod 里面访问 nginx-service 的服务，我们是不是可以直接通过 NGINX_SERVICE_SERVICE_HOST 和 NGINX_SERVICE_SERVICE_PORT 就可以了，但是我们也知道如果这个 Pod 启动起来的时候如果 nginx-service 服务还没启动起来，在环境变量中我们是无法获取到这些信息的，当然我们可以通过 &lt;code&gt;initContainer&lt;/code&gt;之类的方法来确保 nginx-service 启动后再启动 Pod，但是这种方法毕竟增加了 Pod 启动的复杂性，所以这不是最优的方法。&lt;/p&gt;
&lt;h2 id=&quot;KubeDNS&quot;&gt;&lt;a href=&quot;#KubeDNS&quot; class=&quot;headerlink&quot; title=&quot;KubeDNS&quot;&gt;&lt;/a&gt;KubeDNS&lt;/h2&gt;&lt;p&gt;由于上面环境变量这种方式的局限性，我们需要一种更加智能的方案，其实我们可以自己想学一种比较理想的方案：那就是可以直接使用 Service 的名称，因为 Service 的名称不会变化，我们不需要去关心分配的&lt;code&gt;ClusterIP&lt;/code&gt;的地址，因为这个地址并不是固定不变的，所以如果我们直接使用 Service 的名字，然后对应的&lt;code&gt;ClusterIP&lt;/code&gt;地址的转换能够自动完成就很好了。我们知道名字和 IP 直接的转换是不是和我们平时访问的网站非常类似啊？他们之间的转换功能通过&lt;code&gt;DNS&lt;/code&gt;就可以解决了，同样的，&lt;code&gt;Kubernetes&lt;/code&gt;也提供了&lt;code&gt;DNS&lt;/code&gt;&lt;br&gt;的方案来解决上面的服务发现的问题。&lt;/p&gt;
&lt;h3 id=&quot;kubedns-介绍&quot;&gt;&lt;a href=&quot;#kubedns-介绍&quot; class=&quot;headerlink&quot; title=&quot;kubedns 介绍&quot;&gt;&lt;/a&gt;kubedns 介绍&lt;/h3&gt;&lt;p&gt;DNS 服务不是一个独立的系统服务，而是作为一种 addon 插件而存在，也就是说不是 Kubernetes 集群必须安装的，当然我们强烈推荐安装，可以将这个插件看成是一种运行在 Kubernetes 集群上的一直比较特殊的应用，现在比较推荐的两个插件：&lt;code&gt;kube-dns&lt;/code&gt; 和 &lt;code&gt;CoreDNS&lt;/code&gt;。我们在前面使用&lt;code&gt;kubeadm&lt;/code&gt;搭建集群的时候直接安装的 kube-dns 插件，如果不记得了可以回头去看一看。当然如果我们想使用&lt;code&gt;CoreDNS&lt;/code&gt; 的话也很方便，只需要执行下面的命令即可：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubeadm init --feature-gates=CoreDNS=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Kubernetes DNS pod 中包括 3 个容器，可以通过 kubectl 工具查看：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                                    READY     STATUS    RESTARTS   AGE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kube-dns-5868f69869-zp5kz               3/3       Running   0          19d&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;READY 一栏可以看到是 3/3，用如下命令可以很清楚的看到 kube-dns 包含的3个容器：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl describe pod kube-dns-5868f69869-zp5kz -n kube-system&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;kube-dns、dnsmasq-nanny、sidecar 这3个容器分别实现了什么功能?&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;kubedns: kubedns 基于 SkyDNS 库，通过 apiserver 监听 Service 和 Endpoints 的变更事件同时也同步到本地 Cache，实现了一个实时的 Kubernetes 集群内 Service 和 Pod 的 DNS服务发现&lt;/li&gt;
&lt;li&gt;dnsmasq: dsnmasq 容器则实现了 DNS 的缓存功能(在内存中预留一块默认大小为 1G 的地方，保存当前最常用的 DNS 查询记录，如果缓存中没有要查找的记录，它会到 kubedns 中查询，并把结果缓存起来)，通过监听 ConfigMap 来动态生成配置&lt;/li&gt;
&lt;li&gt;sider: sidecar 容器实现了可配置的 DNS 探测，并采集对应的监控指标暴露出来供 prometheus 使用&lt;br&gt;&lt;img src=&quot;/images/k8s/kubedns.jpg&quot; alt=&quot;kubedns&quot;&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;对-Pod-的影响&quot;&gt;&lt;a href=&quot;#对-Pod-的影响&quot; class=&quot;headerlink&quot; title=&quot;对 Pod 的影响&quot;&gt;&lt;/a&gt;对 Pod 的影响&lt;/h3&gt;&lt;p&gt;DNS Pod 具有静态 IP 并作为 Kubernetes 服务暴露出来。该静态 IP 被分配后，kubelet 会将使用 &lt;code&gt;--cluster-dns = &amp;lt;dns-service-ip&amp;gt;&lt;/code&gt;参数配置的 DNS 传递给每个容器。DNS 名称也需要域名，本地域可以使用参数&lt;code&gt;--cluster-domain = &amp;lt;default-local-domain&amp;gt;&lt;/code&gt;在&lt;code&gt;kubelet&lt;/code&gt;中配置。&lt;/p&gt;
&lt;p&gt;我们说&lt;code&gt;dnsmasq&lt;/code&gt;容器通过监听&lt;code&gt;ConfigMap&lt;/code&gt;来动态生成配置，可以自定义存根域和上下游域名服务器。&lt;/p&gt;
&lt;p&gt;例如，下面的&lt;code&gt;ConfigMap&lt;/code&gt;建立了一个 DNS 配置，它具有一个单独的存根域和两个上游域名服务器：&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ConfigMap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; kube-dns&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;data:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  stubDomains:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;|&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&quot;jiunile.local&quot;: [&quot;192.168.3.108&quot;]&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;span class=&quot;attr&quot;&gt;  upstreamNameservers:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;|&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [&quot;8.8.8.8&quot;, &quot;8.8.4.4&quot;]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如何已使用coredns，则通过修改coredns配置信息来调整，如下：&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;data:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  Corefile:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;|&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .:53 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        errors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        health&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        kubernetes cluster.local in-addr.arpa ip6.arpa &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           pods insecure&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           # 用于解析外部主机主机（外部服务）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           upstream 114.114.114.114 223.5.5.5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           fallthrough in-addr.arpa ip6.arpa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        prometheus :9153&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        # 任何不在集群域内的查询将转发到预定义的解析器，默认：/etc/resolv.conf；&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        # 在coredns &quot;Deployment&quot;资源中&quot;dnsPolicy&quot;设置为&quot;Default&quot;，即提供dns服务的pod从所在节点继承/etc/resolv.conf，如果节点的上游解析地址与&quot;upstream&quot;一致，则设置任意一个参数即可&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        proxy . /etc/resolv.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        #proxy . 114.114.114.114 223.5.5.5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        cache 30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        reload&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # 自定义dns记录，对应kube-dns中的stubdomains；&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # 每条记录，单独设置1各zone&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    jiunile.local:53 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        errors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        cache 30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        proxy . 192.168.3.108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ConfigMap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  creationTimestamp:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2019&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-01&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-25&lt;/span&gt;T10:&lt;span class=&quot;number&quot;&gt;19&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;17&lt;/span&gt;Z&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; coredns&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  resourceVersion:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;2637234&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  selfLink:&lt;/span&gt; /api/v1/namespaces/kube-system/configmaps/coredns&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  uid:&lt;/span&gt; ac30bd36&lt;span class=&quot;bullet&quot;&gt;-208&lt;/span&gt;a&lt;span class=&quot;bullet&quot;&gt;-11e9&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-999&lt;/span&gt;a&lt;span class=&quot;bullet&quot;&gt;-02390&lt;/span&gt;c37278e&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;按如上说明，具有.jiunile.local后缀的 DNS 请求被转发到 DNS 192.168.3.108。Google 公共 DNS 服务器 为上游查询提供服务。下表描述了具有特定域名的查询如何映射到它们的目标 DNS 服务器：&lt;br&gt;| 域名      | 响应查询的服务器  |&lt;br&gt;| :——– | :——– |&lt;br&gt;| kubernetes.default.svc.cluster.local  | kube-dns |&lt;br&gt;| jiunile.local | 自定义 DNS (192.168.3.108) |&lt;br&gt;| widget.com | 上游 DNS (114.114.114.114, 223.5.5.5其中之一) |&lt;/p&gt;
&lt;p&gt;另外我们还可以为每个 Pod 设置 DNS 策略。 当前 Kubernetes 支持两种 Pod 特定的 DNS 策略：“Default” 和 “ClusterFirst”。 可以通过&lt;code&gt;dnsPolicy&lt;/code&gt;标志来指定这些策略。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;注意&lt;/code&gt;&lt;/strong&gt;：Default 不是默认的 DNS 策略。如果没有显式地指定dnsPolicy，将会使用 ClusterFirst&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;如果&lt;code&gt;dnsPolicy&lt;/code&gt;被设置为 “Default”，则名字解析配置会继承自 Pod 运行所在的节点。自定义上游域名服务器和存根域不能够与这个策略一起使用&lt;/li&gt;
&lt;li&gt;如果&lt;code&gt;dnsPolicy&lt;/code&gt;被设置为 “ClusterFirst”，这就要依赖于是否配置了存根域和上游 DNS 服务器&lt;ul&gt;
&lt;li&gt;未进行自定义配置：没有匹配上配置的集群域名后缀的任何请求，例如 “www.kubernetes.io”，将会被转发到继承自节点的上游域名服务器。&lt;ul&gt;
&lt;li&gt;进行自定义配置：如果配置了存根域和上游 DNS 服务器（类似于 前面示例 配置的内容），DNS 查询将基于下面的流程对请求进行路由：&lt;ul&gt;
&lt;li&gt;查询首先被发送到&lt;code&gt;kube-dns&lt;/code&gt;中的 DNS 缓存层。&lt;/li&gt;
&lt;li&gt;从缓存层，检查请求的后缀，并根据下面的情况转发到对应的 DNS 上：&lt;ul&gt;
&lt;li&gt;具有集群后缀的名字（例如 “.cluster.local”）：请求被发送到 kubedns。&lt;/li&gt;
&lt;li&gt;具有存根域后缀的名字（例如 “.jiunile.local”）：请求被发送到配置的自定义 DNS 解析器（例如：监听在 192.168.3.108）。&lt;/li&gt;
&lt;li&gt;未能匹配上后缀的名字（例如 “widget.com”）：请求被转发到上游 DNS（例如：Google 公共 DNS 服务器，114.114.114.114 和 223.5.5.5）。&lt;br&gt;&lt;img src=&quot;/images/k8s/dns.png&quot; alt=&quot;dns&quot;&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;域名格式&quot;&gt;&lt;a href=&quot;#域名格式&quot; class=&quot;headerlink&quot; title=&quot;域名格式&quot;&gt;&lt;/a&gt;域名格式&lt;/h3&gt;&lt;p&gt;我们前面说了如果我们建立的 Service 如果支持域名形式进行解析，就可以解决我们的服务发现的功能，那么利用 kubedns 可以将 Service 生成怎样的 DNS 记录呢？&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;普通的 Service：会生成&lt;code&gt;servicename.namespace.svc.cluster.local&lt;/code&gt;的域名，会解析到 Service 对应的 ClusterIP 上，在 Pod 之间的调用可以简写成 &lt;code&gt;servicename.namespace&lt;/code&gt;，如果处于同一个命名空间下面，甚至可以只写成 servicename 即可访问&lt;/li&gt;
&lt;li&gt;Headless Service：无头服务，就是把 clusterIP 设置为 None 的，会被解析为指定 Pod 的 IP 列表，同样还可以通过&lt;code&gt;podname.servicename.namespace.svc.cluster.local&lt;/code&gt;访问到具体的某一个 Pod。&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;CoreDNS 实现的功能和 KubeDNS 是一致的，不过&lt;code&gt;CoreDNS&lt;/code&gt;的所有功能都集成在了同一个容器中，在最新版的1.11.0版本中官方已经推荐使用 &lt;code&gt;CoreDNS&lt;/code&gt;了，大家也可以安装CoreDNS来代替 KubeDNS，其他使用方法都是一致的：&lt;a href=&quot;https://coredns.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://coredns.io/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;测试&quot;&gt;&lt;a href=&quot;#测试&quot; class=&quot;headerlink&quot; title=&quot;测试&quot;&gt;&lt;/a&gt;测试&lt;/h2&gt;&lt;p&gt;现在我们来使用一个简单 Pod 来测试下 Service 的域名访问：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl run --rm -i --tty &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-dns --image=busybox /bin/sh&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;If you don&lt;span class=&quot;string&quot;&gt;&#39;t see a command prompt, try pressing enter.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/ # cat /etc/resolv.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nameserver 10.96.0.10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;search default.svc.cluster.local svc.cluster.local cluster.local&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;options ndots:5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/ #&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们进入到 Pod 中，查看/etc/resolv.conf中的内容，可以看到 nameserver 的地址10.96.0.10，该 IP 地址即是在安装 kubedns 插件的时候集群分配的一个固定的静态 IP 地址，我们可以通过下面的命令进行查看：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get svc kube-dns -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kube-dns   ClusterIP   10.96.0.10   &amp;lt;none&amp;gt;        53/UDP,53/TCP   62d&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;也就是说我们这个 Pod 现在默认的 nameserver 就是 kubedns 的地址，现在我们来访问下前面我们创建的 nginx-service 服务：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;/ &lt;span class=&quot;comment&quot;&gt;# wget -q -O- nginx-service.default.svc.cluster.local&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;可以看到上面我们使用 wget 命令去访问 nginx-service 服务的域名的时候被 hang 住了，没有得到期望的结果，这是因为上面我们建立 Service 的时候暴露的端口是 5000：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;/ &lt;span class=&quot;comment&quot;&gt;# wget -q -O- nginx-service.default.svc.cluster.local:5000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;title&amp;gt;Welcome to nginx!&amp;lt;/title&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;style&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    body &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        width: 35em;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        margin: 0 auto;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        font-family: Tahoma, Verdana, Arial, sans-serif;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;/style&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;/head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;h1&amp;gt;Welcome to nginx!&amp;lt;/h1&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;If you see this page, the nginx web server is successfully installed and&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;working. Further configuration is required.&amp;lt;/p&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;For online documentation and support please refer to&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;a href=&lt;span class=&quot;string&quot;&gt;&quot;http://nginx.org/&quot;&lt;/span&gt;&amp;gt;nginx.org&amp;lt;/a&amp;gt;.&amp;lt;br/&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Commercial support is available at&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;a href=&lt;span class=&quot;string&quot;&gt;&quot;http://nginx.com/&quot;&lt;/span&gt;&amp;gt;nginx.com&amp;lt;/a&amp;gt;.&amp;lt;/p&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;&amp;lt;em&amp;gt;Thank you &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; using nginx.&amp;lt;/em&amp;gt;&amp;lt;/p&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;加上 5000 端口，就正常访问到服务，再试一试访问：nginx-service.default.svc、nginx-service.default、nginx-service，不出意外这些域名都可以正常访问到期望的结果。&lt;/p&gt;
&lt;p&gt;到这里我们是不是就实现了在集群内部通过 Service 的域名形式进行互相通信了，大家下去试着看看访问不同 namespace 下面的服务呢？&lt;/p&gt;
&lt;p&gt;来源：阳明的博客&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;我们可以通过 Service 生成的&lt;code&gt;ClusterIP(VIP)&lt;/code&gt;来访问 Pod 提供的服务，但是在使用的时候还有一个问题：我们怎么知道某个应用的 VIP 呢？比如我们有两个应用，一个是 api 应用，一个是 db 应用，两个应用都是通过&lt;code&gt;Deployment&lt;/code&gt;进行管理的，并且都通过 Service 暴露出了端口提供服务。api 需要连接到 db 这个应用，我们只知道 db 应用的名称和 db 对应的 Service 的名称，但是并不知道它的 VIP 地址，我们前面的 Service 课程中是不是学习到我们通过&lt;code&gt;ClusterIP&lt;/code&gt;就可以访问到后面的&lt;code&gt;Pod&lt;/code&gt;服务，如果我们知道了 VIP 的地址是不是就行了？&lt;/p&gt;
&lt;h2 id=&quot;apiserver&quot;&gt;&lt;a href=&quot;#apiserver&quot; class=&quot;headerlink&quot; title=&quot;apiserver&quot;&gt;&lt;/a&gt;apiserver&lt;/h2&gt;&lt;p&gt;我们知道可以从 apiserver 中直接查询获取到对应 service 的后端 Endpoints信息，所以最简单的办法是从 apiserver 中直接查询，如果偶尔一个特殊的应用，我们通过&lt;code&gt;apiserver&lt;/code&gt;去查询到&lt;code&gt;Service&lt;/code&gt;后面的 &lt;code&gt;Endpoints&lt;/code&gt;直接使用是没问题的，但是如果每个应用都在启动的时候去查询依赖的服务，这不但增加了应用的复杂度，这也导致了我们的应用需要依赖&lt;code&gt;Kubernetes&lt;/code&gt;了，耦合度太高了，不具有通用性。&lt;br&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="dns" scheme="http://icyxp.github.io/categories/kubernetes/dns/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubedns" scheme="http://icyxp.github.io/tags/kubedns/"/>
    
      <category term="coredns" scheme="http://icyxp.github.io/tags/coredns/"/>
    
  </entry>
  
  <entry>
    <title>kuberenetes 操作实践</title>
    <link href="http://icyxp.github.io//blog/2019/03/k8s-best-practices.html"/>
    <id>http://icyxp.github.io//blog/2019/03/k8s-best-practices.html</id>
    <published>2019-03-08T04:00:00.000Z</published>
    <updated>2019-03-08T03:02:01.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;常用操作命令&quot;&gt;&lt;a href=&quot;#常用操作命令&quot; class=&quot;headerlink&quot; title=&quot;常用操作命令&quot;&gt;&lt;/a&gt;常用操作命令&lt;/h2&gt;&lt;h3 id=&quot;常规命令&quot;&gt;&lt;a href=&quot;#常规命令&quot; class=&quot;headerlink&quot; title=&quot;常规命令&quot;&gt;&lt;/a&gt;常规命令&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置主机名&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;hostnamectl --static &lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt;-hostname  xxxx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 获取集群加入信息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm token create --print-join-command&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置docker仓库口令&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl create secret docker-registry registry-secret --docker-server=registry.cn-shanghai.aliyuncs.com --docker-username=xupeng@patsnap --docker-password=patsnap2019! --docker-email=xupeng@patsnap -n ningbo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# etcd key 查看&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCDCTL_API=3 etcdctl \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--endpoints=https://127.0.0.1:2379 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--cacert /etc/kubernetes/pki/etcd/ca.crt \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--cert /etc/kubernetes/pki/etcd/peer.crt \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--key /etc/kubernetes/pki/etcd/peer.key \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;get /registry/minions/ningbo-db --prefix&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;kubernetes-node-常用操作命令&quot;&gt;&lt;a href=&quot;#kubernetes-node-常用操作命令&quot; class=&quot;headerlink&quot; title=&quot;kubernetes node 常用操作命令&quot;&gt;&lt;/a&gt;kubernetes node 常用操作命令&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#设置node 不可调度&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl cordon k8s-node-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#驱逐node 上的pod &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl drain k8s-node-1 --delete-local-data --force --ignore-daemonsets&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#node 重新加入&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl uncordon k8s-node-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#删除node&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl delete node k8s-node-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#设置master不进行调度&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl taint nodes k8s-master node-role.kubernetes.io/master=:NoSchedule&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置label&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl label node k8s-master project=ipms-app&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#设置role标签&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl label node k8s-node-01 node-role.kubernetes.io/node=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#删除标签&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl label nodes k8s-master mtype-&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;如何调整网络插件&quot;&gt;&lt;a href=&quot;#如何调整网络插件&quot; class=&quot;headerlink&quot; title=&quot;如何调整网络插件&quot;&gt;&lt;/a&gt;如何调整网络插件&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;calico网络插件调整，原本没使用IPIP模式，现在需要使用CrossSubnet&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#先删除原本的calico插件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl delete &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; calico.yml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#修改calico.yaml，将CALICO_IPV4POOL_IPIP调整为CrossSubnet&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#启用calico插件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; calico.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;如何将kubeProxy的iptables修改为ipvs&quot;&gt;&lt;a href=&quot;#如何将kubeProxy的iptables修改为ipvs&quot; class=&quot;headerlink&quot; title=&quot;如何将kubeProxy的iptables修改为ipvs&quot;&gt;&lt;/a&gt;如何将kubeProxy的iptables修改为ipvs&lt;/h2&gt;&lt;h3 id=&quot;1-加载内核模块&quot;&gt;&lt;a href=&quot;#1-加载内核模块&quot; class=&quot;headerlink&quot; title=&quot;1. 加载内核模块&quot;&gt;&lt;/a&gt;1. 加载内核模块&lt;/h3&gt;&lt;p&gt;查看内核模块是否加载&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;lsmod|grep ip_vs&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果没有加载，使用如下命令加载ipvs相关模块&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;modprobe -- ip_vs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;modprobe -- ip_vs_rr&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;modprobe -- ip_vs_wrr&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;modprobe -- ip_vs_sh&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;modprobe -- nf_conntrack_ipv4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;2-更改kube-proxy配置&quot;&gt;&lt;a href=&quot;#2-更改kube-proxy配置&quot; class=&quot;headerlink&quot; title=&quot;2. 更改kube-proxy配置&quot;&gt;&lt;/a&gt;2. 更改kube-proxy配置&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl edit configmap kube-proxy -n kube-system&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;找到并修改如下部分的内容&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;enableProfiling:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;healthzBindAddress:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;10256&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;hostnameOverride:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;iptables:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  masqueradeAll:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  masqueradeBit:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;14&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  minSyncPeriod:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  syncPeriod:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;ipvs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  excludeCIDRs:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  minSyncPeriod:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  scheduler:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;#=========================&amp;gt; 为空表示默认的负载均衡算法为轮询， rr, wrr, lc, wlc, sh, dh, lblc...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  syncPeriod:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; KubeProxyConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metricsBindAddress:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;127.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.1&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;10249&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;mode:&lt;/span&gt; iptables   &lt;span class=&quot;comment&quot;&gt;#=========================&amp;gt; 修改此处为ipvs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;nodePortAddresses:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;oomScoreAdj:&lt;/span&gt; &lt;span class=&quot;bullet&quot;&gt;-999&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;portRange:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;resourceContainer:&lt;/span&gt; /kube-proxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;udpIdleTimeout:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;250&lt;/span&gt;ms&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;编辑完，保存退出&lt;/p&gt;
&lt;h3 id=&quot;3-删除所有kube-proxy的pod&quot;&gt;&lt;a href=&quot;#3-删除所有kube-proxy的pod&quot; class=&quot;headerlink&quot; title=&quot;3. 删除所有kube-proxy的pod&quot;&gt;&lt;/a&gt;3. 删除所有kube-proxy的pod&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl delete pod $(kubectl get pod -n kube-system | grep kube-proxy | awk -F &lt;span class=&quot;string&quot;&gt;&#39; &#39;&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;print $1&amp;#125;&#39;&lt;/span&gt;) -n kube-system&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;4-查看kube-proxy的pod日志&quot;&gt;&lt;a href=&quot;#4-查看kube-proxy的pod日志&quot; class=&quot;headerlink&quot; title=&quot;4. 查看kube-proxy的pod日志&quot;&gt;&lt;/a&gt;4. 查看kube-proxy的pod日志&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl logs kube-proxy-xxx -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#I0308 02:16:02.980965       1 server_others.go:183] Using ipvs Proxier.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#W0308 02:16:02.991188       1 proxier.go:356] IPVS scheduler not specified, use rr by default&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#I0308 02:16:02.991338       1 server_others.go:210] Tearing down inactive rules.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#I0308 02:16:03.022123       1 server.go:448] Version: v1.11.6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#I0308 02:16:03.028801       1 conntrack.go:98] Set sysctl &#39;net/netfilter/nf_conntrack_max&#39; to 131072&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#I0308 02:16:03.029030       1 conntrack.go:52] Setting nf_conntrack_max to 131072&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#I0308 02:16:03.029208       1 conntrack.go:98] Set sysctl &#39;net/netfilter/nf_conntrack_tcp_timeout_established&#39; to 86400&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#I0308 02:16:03.029296       1 conntrack.go:98] Set sysctl &#39;net/netfilter/nf_conntrack_tcp_timeout_close_wait&#39; to 3600&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#I0308 02:16:03.029639       1 config.go:102] Starting endpoints config controller&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#I0308 02:16:03.029682       1 controller_utils.go:1025] Waiting for caches to sync for endpoints config controller&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#I0308 02:16:03.029723       1 config.go:202] Starting service config controller&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#I0308 02:16:03.029777       1 controller_utils.go:1025] Waiting for caches to sync for service config controller&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#I0308 02:16:03.129930       1 controller_utils.go:1032] Caches are synced for endpoints config controller&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#I0308 02:16:03.129931       1 controller_utils.go:1032] Caches are synced for service config controller&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;看到有 Using ipvs Proxier 即表明切换成功.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;5-安装ipvsadm&quot;&gt;&lt;a href=&quot;#5-安装ipvsadm&quot; class=&quot;headerlink&quot; title=&quot;5. 安装ipvsadm&quot;&gt;&lt;/a&gt;5. 安装ipvsadm&lt;/h3&gt;&lt;p&gt;使用ipvsadm查看ipvs相关规则，如果没有这个命令可以直接yum安装&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install ipvsadm&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;常用操作命令&quot;&gt;&lt;a href=&quot;#常用操作命令&quot; class=&quot;headerlink&quot; title=&quot;常用操作命令&quot;&gt;&lt;/a&gt;常用操作命令&lt;/h2&gt;&lt;h3 id=&quot;常规命令&quot;&gt;&lt;a href=&quot;#常规命令&quot; class=&quot;headerlink&quot; title=&quot;常规命令&quot;&gt;&lt;/a&gt;常规命令&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置主机名&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;hostnamectl --static &lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt;-hostname  xxxx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 获取集群加入信息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm token create --print-join-command&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置docker仓库口令&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl create secret docker-registry registry-secret --docker-server=registry.cn-shanghai.aliyuncs.com --docker-username=xupeng@patsnap --docker-password=patsnap2019! --docker-email=xupeng@patsnap -n ningbo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# etcd key 查看&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCDCTL_API=3 etcdctl \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--endpoints=https://127.0.0.1:2379 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--cacert /etc/kubernetes/pki/etcd/ca.crt \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--cert /etc/kubernetes/pki/etcd/peer.crt \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--key /etc/kubernetes/pki/etcd/peer.key \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;get /registry/minions/ningbo-db --prefix&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="实践" scheme="http://icyxp.github.io/categories/kubernetes/%E5%AE%9E%E8%B7%B5/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes 服务质量 Qos 解析</title>
    <link href="http://icyxp.github.io//blog/2019/03/k8s-pod-qos.html"/>
    <id>http://icyxp.github.io//blog/2019/03/k8s-pod-qos.html</id>
    <published>2019-03-06T12:00:00.000Z</published>
    <updated>2019-03-06T09:53:10.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;&lt;code&gt;QoS&lt;/code&gt;是 Quality of Service 的缩写，即服务质量。为了实现资源被有效调度和分配的同时提高资源利用率，&lt;code&gt;kubernetes&lt;/code&gt;针对不同服务质量的预期，通过 QoS（Quality of Service）来对 pod 进行服务质量管理。对于一个 pod 来说，服务质量体现在两个具体的指标：&lt;code&gt;CPU 和内存&lt;/code&gt;。当节点上内存资源紧张时，kubernetes 会根据预先设置的不同 QoS 类别进行相应处理。&lt;/p&gt;
&lt;p&gt;QoS 主要分为&lt;code&gt;Guaranteed&lt;/code&gt;、&lt;code&gt;Burstable&lt;/code&gt; 和 &lt;code&gt;Best-Effort&lt;/code&gt;三类，优先级从高到低。&lt;/p&gt;
&lt;h2 id=&quot;Guaranteed-有保证的&quot;&gt;&lt;a href=&quot;#Guaranteed-有保证的&quot; class=&quot;headerlink&quot; title=&quot;Guaranteed(有保证的)&quot;&gt;&lt;/a&gt;Guaranteed(有保证的)&lt;/h2&gt;&lt;p&gt;对于绑定 CPU 和具有相对可预测性的工作负载（例如，用来处理请求的 Web 服务）来说，这是一个很好的 QoS 等级。属于该级别的pod有以下两种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Pod中的所有容器都且仅设置了 CPU 和内存的 limits&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;pod中的所有容器都设置了 CPU 和内存的 requests 和 limits ，且单个容器内的requests==limits（requests不等于0）&lt;/strong&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;strong&gt;示例1：pod中的所有容器都且仅设置了limits&lt;/strong&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; foo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      limits:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        cpu:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        memory:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;Gi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; bar&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      limits:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        cpu:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        memory:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;Mi&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;示例2： pod 中的所有容器都设置了 requests 和 limits，且单个容器内的&lt;code&gt;requests==limits&lt;/code&gt;&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; foo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      limits:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        cpu:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        memory:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;Gi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      requests:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        cpu:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        memory:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;Gi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; bar&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      limits:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        cpu:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        memory:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;Mi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      requests:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        cpu:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        memory:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;Mi&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;容器foo和bar内resources的requests和limits均相等，该pod的QoS级别属于&lt;code&gt;Guaranteed&lt;/code&gt;。&lt;/p&gt;
&lt;h2 id=&quot;Burstable-不稳定的&quot;&gt;&lt;a href=&quot;#Burstable-不稳定的&quot; class=&quot;headerlink&quot; title=&quot;Burstable(不稳定的)&quot;&gt;&lt;/a&gt;Burstable(不稳定的)&lt;/h2&gt;&lt;p&gt;这对短时间内需要消耗大量资源或者初始化过程很密集的工作负载非常有用，例如：用来构建 Docker 容器的 Worker 和运行未优化的 JVM 进程的容器都可以使用该 QoS 等级。&lt;strong&gt;pod中只要有一个容器的requests和limits的设置不相同&lt;/strong&gt;，该pod的QoS即为&lt;code&gt;Burstable&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;示例1：容器foo指定了resource，而容器bar未指定&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; foo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      limits:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        cpu:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        memory:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;Gi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      requests:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        cpu:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        memory:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;Gi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; bar&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;示例2：容器foo设置了内存limits，而容器bar设置了CPU limits&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; foo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      limits:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        memory:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;Gi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; bar&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      limits:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        cpu:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;m&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;注意：若容器指定了requests而未指定limits，则limits的值等于节点resource的最大值；若容器指定了limits而未指定requests，则requests的值等于limits。&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Best-Effort-尽最大努力&quot;&gt;&lt;a href=&quot;#Best-Effort-尽最大努力&quot; class=&quot;headerlink&quot; title=&quot;Best-Effort(尽最大努力)&quot;&gt;&lt;/a&gt;Best-Effort(尽最大努力)&lt;/h2&gt;&lt;p&gt;这对于可中断和低优先级的工作负载非常有用，例如：迭代运行的幂等优化过程。&lt;strong&gt;如果Pod中所有容器的resources均未设置requests与limits&lt;/strong&gt;，该pod的QoS即为&lt;code&gt;Best-Effort&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;示例1：容器foo和容器bar均未设置requests和limits&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; foo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; bar&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;根据QoS进行资源回收策略&quot;&gt;&lt;a href=&quot;#根据QoS进行资源回收策略&quot; class=&quot;headerlink&quot; title=&quot;根据QoS进行资源回收策略&quot;&gt;&lt;/a&gt;根据QoS进行资源回收策略&lt;/h2&gt;&lt;p&gt;Kubernetes 通过&lt;code&gt;cgroup&lt;/code&gt;给pod设置QoS级别，当资源不足时先&lt;code&gt;kill&lt;/code&gt;优先级低的 pod，在实际使用过程中，通过&lt;code&gt;OOM&lt;/code&gt;分数值来实现，&lt;code&gt;OOM&lt;/code&gt;分数值范围为0-1000。OOM 分数值根据&lt;code&gt;OOM_ADJ&lt;/code&gt;参数计算得出。&lt;/p&gt;
&lt;p&gt;对于&lt;code&gt;Guaranteed&lt;/code&gt;级别的 Pod，OOM_ADJ参数设置成了-998，对于&lt;code&gt;Best-Effort&lt;/code&gt;级别的 Pod，OOM_ADJ参数设置成了1000，对于&lt;code&gt;Burstable&lt;/code&gt;级别的 Pod，OOM_ADJ参数取值从2到999。&lt;/p&gt;
&lt;p&gt;对于 kuberntes 保留资源，比如kubelet，docker，OOM_ADJ参数设置成了-999，表示不会被OOM kill掉。&lt;strong&gt;OOM_ADJ参数设置的越大，计算出来的OOM分数越高，表明该pod优先级就越低，当出现资源竞争时会越早被kill掉&lt;/strong&gt;，对于OOM_ADJ参数是-999的表示kubernetes永远不会因为OOM将其kill掉。&lt;/p&gt;
&lt;h2 id=&quot;QoS-pods被kill掉场景与顺序&quot;&gt;&lt;a href=&quot;#QoS-pods被kill掉场景与顺序&quot; class=&quot;headerlink&quot; title=&quot;QoS pods被kill掉场景与顺序&quot;&gt;&lt;/a&gt;QoS pods被kill掉场景与顺序&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Best-Effort pods&lt;/code&gt;：系统用完了全部内存时，该类型 pods 会最先被kill掉。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Burstable pods&lt;/code&gt;：系统用完了全部内存，且没有 Best-Effort 类型的容器可以被 kill 时，该类型的 pods 会被 kill 掉。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Guaranteed pods&lt;/code&gt;：系统用完了全部内存，且没有 Burstable 与 Best-Effort 类型的容器可以被 kill 时，该类型的 pods 会被 kill 掉。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;QoS使用建议&quot;&gt;&lt;a href=&quot;#QoS使用建议&quot; class=&quot;headerlink&quot; title=&quot;QoS使用建议&quot;&gt;&lt;/a&gt;QoS使用建议&lt;/h2&gt;&lt;p&gt;如果资源充足，可将 QoS pods 类型均设置为&lt;code&gt;Guaranteed&lt;/code&gt;。用计算资源换业务性能和稳定性，减少排查问题时间和成本。如果想更好的提高资源利用率，&lt;strong&gt;业务服务&lt;/strong&gt;可以设置为&lt;code&gt;Guaranteed&lt;/code&gt;，而其他服务根据重要程度可分别设置为&lt;code&gt;Burstable&lt;/code&gt;或&lt;code&gt;Best-Effort&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;在搞清楚服务什么时候会出现故障以及为什么会出现故障之前，都不应该将其部署到生产环境中。可通过一些技术手段（&lt;strong&gt;负载压测等&lt;/strong&gt;）来设置应用的资源 limits 和 requests。这将会为你的系统增加弹性能力和可预测性。&lt;/p&gt;
&lt;p&gt;在测试过程中，记录服务失败时做了哪些操作是至关重要的。可以将发现的故障模式添加到相关的书籍和文档中，这对分类生产环境中出现的问题很有用。下面是我们在测试过程中发现的一些故障模式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;内存缓慢增加&lt;/li&gt;
&lt;li&gt;CPU 使用率达到 100%&lt;/li&gt;
&lt;li&gt;响应时间太长&lt;/li&gt;
&lt;li&gt;请求被丢弃&lt;/li&gt;
&lt;li&gt;不同请求的响应时间差异很大&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;你最好将这些发现都收集起来，以备不时之需，因为有一天它们可能会为你或团队节省一整天的时间。&lt;/p&gt;
&lt;h2 id=&quot;一些有用的工具&quot;&gt;&lt;a href=&quot;#一些有用的工具&quot; class=&quot;headerlink&quot; title=&quot;一些有用的工具&quot;&gt;&lt;/a&gt;一些有用的工具&lt;/h2&gt;&lt;h3 id=&quot;Loader-io&quot;&gt;&lt;a href=&quot;#Loader-io&quot; class=&quot;headerlink&quot; title=&quot;Loader.io&quot;&gt;&lt;/a&gt;Loader.io&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;http://loader.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Loader.io&lt;/a&gt; 是一个在线负载测试工具，它允许你配置负载增加测试和负载不变测试，在测试过程中可视化应用程序的性能和负载，并能快速启动和停止测试。它也会保存测试结果的历史记录，因此在资源限制发生变化时很容易对结果进行比较。&lt;br&gt;&lt;img src=&quot;/images/k8s/loader.jpg&quot; alt=&quot;Loader&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;Kubescope-cli&quot;&gt;&lt;a href=&quot;#Kubescope-cli&quot; class=&quot;headerlink&quot; title=&quot;Kubescope cli&quot;&gt;&lt;/a&gt;Kubescope cli&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/hharnisc/kubescope-cli&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kubescope cli&lt;/a&gt; 是一个可以运行在本地或 Kubernetes 中的工具，可直接从 Docker Daemon 中收集容器指标并可视化。和 &lt;code&gt;cAdvisor&lt;/code&gt; 等其他集群指标收集服务一样， &lt;code&gt;kubescope cli&lt;/code&gt; 收集指标的周期是 1 秒（而不是 10-15 秒）。如果周期是 10-15 秒，你可能会在测试期间错过一些引发性能瓶颈的问题。如果你使用 cAdvisor 进行测试，每次都要使用新的 Pod 作为测试对象，因为 Kubernetes 在超过资源限制时就会将 Pod 杀死，然后重新启动一个全新的 Pod。而 &lt;code&gt;kubescope cli&lt;/code&gt; 就没有这方面的忧虑，它直接从 Docker Daemon 中收集容器指标（你可以自定义收集指标的时间间隔），并使用正则表达式来选择和过滤你想要显示的容器。&lt;br&gt;&lt;img src=&quot;/images/k8s/kubescope-cli.gif&quot; alt=&quot;kubescope-cli&quot;&gt;&lt;/p&gt;
&lt;p&gt;来源：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;阳明的博客&lt;/li&gt;
&lt;li&gt;Ryan Yang&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;&lt;code&gt;QoS&lt;/code&gt;是 Quality of Service 的缩写，即服务质量。为了实现资源被有效调度和分配的同时提高资源利用率，&lt;code&gt;kubernetes&lt;/code&gt;针对不同服务质量的预期，通过 QoS（Quality of Service）来对 pod 进行服务质量管理。对于一个 pod 来说，服务质量体现在两个具体的指标：&lt;code&gt;CPU 和内存&lt;/code&gt;。当节点上内存资源紧张时，kubernetes 会根据预先设置的不同 QoS 类别进行相应处理。&lt;/p&gt;
&lt;p&gt;QoS 主要分为&lt;code&gt;Guaranteed&lt;/code&gt;、&lt;code&gt;Burstable&lt;/code&gt; 和 &lt;code&gt;Best-Effort&lt;/code&gt;三类，优先级从高到低。&lt;/p&gt;
&lt;h2 id=&quot;Guaranteed-有保证的&quot;&gt;&lt;a href=&quot;#Guaranteed-有保证的&quot; class=&quot;headerlink&quot; title=&quot;Guaranteed(有保证的)&quot;&gt;&lt;/a&gt;Guaranteed(有保证的)&lt;/h2&gt;&lt;p&gt;对于绑定 CPU 和具有相对可预测性的工作负载（例如，用来处理请求的 Web 服务）来说，这是一个很好的 QoS 等级。属于该级别的pod有以下两种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Pod中的所有容器都且仅设置了 CPU 和内存的 limits&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;pod中的所有容器都设置了 CPU 和内存的 requests 和 limits ，且单个容器内的requests==limits（requests不等于0）&lt;/strong&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="Qos" scheme="http://icyxp.github.io/categories/kubernetes/Qos/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="Qos" scheme="http://icyxp.github.io/tags/Qos/"/>
    
      <category term="limits" scheme="http://icyxp.github.io/tags/limits/"/>
    
      <category term="requests" scheme="http://icyxp.github.io/tags/requests/"/>
    
  </entry>
  
  <entry>
    <title>理解 kubernetes 亲和性调度</title>
    <link href="http://icyxp.github.io//blog/2019/03/k8s-affinity.html"/>
    <id>http://icyxp.github.io//blog/2019/03/k8s-affinity.html</id>
    <published>2019-03-05T12:00:00.000Z</published>
    <updated>2019-03-05T09:32:32.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;一般情况下我们部署的 Pod 是通过集群的自动调度策略来选择节点的，默认情况下调度器考虑的是资源足够，并且负载尽量平均，但是有的时候我们需要能够更加细粒度的去控制 Pod 的调度，比如我们内部的一些服务 gitlab 之类的也是跑在&lt;code&gt;Kubernetes&lt;/code&gt;集群上的，我们就不希望对外的一些服务和内部的服务跑在同一个节点上了，害怕内部服务对外部的服务产生影响；但是有的时候我们的服务之间交流比较频繁，又希望能够将这两个服务的 Pod 调度到同一个的节点上。这就需要用到 Kubernetes 里面的一个概念：亲和性和反亲和性。&lt;/p&gt;
&lt;p&gt;亲和性有分成节点亲和性(&lt;code&gt;nodeAffinity&lt;/code&gt;)和 Pod 亲和性(&lt;code&gt;podAffinity&lt;/code&gt;)。&lt;/p&gt;
&lt;h2 id=&quot;nodeSelector&quot;&gt;&lt;a href=&quot;#nodeSelector&quot; class=&quot;headerlink&quot; title=&quot;nodeSelector&quot;&gt;&lt;/a&gt;nodeSelector&lt;/h2&gt;&lt;p&gt;在了解亲和性之前，我们先来了解一个非常常用的调度方式：nodeSelector。我们知道label是kubernetes中一个非常重要的概念，用户可以非常灵活的利用 label 来管理集群中的资源，比如最常见的一个就是 service 通过匹配 label 去匹配 Pod 资源，而 Pod 的调度也可以根据节点的 label 来进行调度。&lt;/p&gt;
&lt;p&gt;我们可以通过下面的命令查看我们的 node 的 label：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get nodes --show-labels&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME      STATUS    ROLES     AGE       VERSION   LABELS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;master    Ready     master    147d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=master,node-role.kubernetes.io/master=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node02    Ready     &amp;lt;none&amp;gt;    67d       v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,course=k8s,kubernetes.io/hostname=node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node03    Ready     &amp;lt;none&amp;gt;    127d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,jnlp=haimaxy,kubernetes.io/hostname=node03&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;现在我们先给节点node02增加一个com=youdianzhishi的标签，命令如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl label nodes node02 com=youdianzhishi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node &lt;span class=&quot;string&quot;&gt;&quot;node02&quot;&lt;/span&gt; labeled&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;我们可以通过上面的&lt;code&gt;--show-labels&lt;/code&gt;参数可以查看上述标签是否生效。当 node 被打上了相关标签后，在调度的时候就可以使用这些标签了，只需要在 Pod 的&lt;code&gt;spec&lt;/code&gt;字段中添加nodeSelector字段，里面是我们需要被调度的节点的 label 即可。比如，下面的 Pod 我们要强制调度到 node02 这个节点上去，我们就可以使用 nodeSelector 来表示了：(node-selector-demo.yaml)&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    app:&lt;/span&gt; busybox-pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; test-busybox&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - command:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; sleep&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;3600&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    image:&lt;/span&gt; busybox&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    imagePullPolicy:&lt;/span&gt; Always&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    name:&lt;/span&gt; test-busybox&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  nodeSelector:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    com:&lt;/span&gt; youdianzhishi&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后我们可以通过 describe 命令查看调度结果：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl create &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; node-selector-demo.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pod &lt;span class=&quot;string&quot;&gt;&quot;test-busybox&quot;&lt;/span&gt; created&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl describe pod &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-busybox&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Name:         &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-busybox&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Namespace:    default&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Node:         node02/10.151.30.63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;......&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;QoS Class:       BestEffort&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Node-Selectors:  com=youdianzhishi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Tolerations:     node.kubernetes.io/not-ready:NoExecute &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 300s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 node.kubernetes.io/unreachable:NoExecute &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 300s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Events:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Type    Reason                 Age   From               Message&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ----    ------                 ----  ----               -------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Normal  SuccessfulMountVolume  55s   kubelet, node02    MountVolume.SetUp succeeded &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; volume &lt;span class=&quot;string&quot;&gt;&quot;default-token-n9w2d&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Normal  Scheduled              54s   default-scheduler  Successfully assigned &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-busybox to node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Normal  Pulling                54s   kubelet, node02    pulling image &lt;span class=&quot;string&quot;&gt;&quot;busybox&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Normal  Pulled                 40s   kubelet, node02    Successfully pulled image &lt;span class=&quot;string&quot;&gt;&quot;busybox&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Normal  Created                40s   kubelet, node02    Created container&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Normal  Started                40s   kubelet, node02    Started container&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们可以看到 Events 下面的信息，我们的 Pod 通过默认的 default-scheduler 调度器被绑定到了node02节点。不过需要注意的是&lt;code&gt;nodeSelector&lt;/code&gt;属于强制性的，如果我们的目标节点没有可用的资源，我们的 Pod 就会一直处于 Pending 状态，这就是&lt;code&gt;nodeSelector&lt;/code&gt;的用法。&lt;/p&gt;
&lt;p&gt;通过上面的例子我们可以感受到&lt;code&gt;nodeSelector&lt;/code&gt;的方式比较直观，但是还够灵活，控制粒度偏大，接下来我们再和大家了解下更加灵活的方式：节点亲和性(&lt;code&gt;nodeAffinity&lt;/code&gt;)。&lt;/p&gt;
&lt;h2 id=&quot;亲和性和反亲和性调度&quot;&gt;&lt;a href=&quot;#亲和性和反亲和性调度&quot; class=&quot;headerlink&quot; title=&quot;亲和性和反亲和性调度&quot;&gt;&lt;/a&gt;亲和性和反亲和性调度&lt;/h2&gt;&lt;p&gt;我们了解了 kubernetes 调度器的一个调度流程，我们知道默认的调度器在使用的时候，经过了 predicates 和 priorities 两个阶段，但是在实际的生产环境中，往往我们需要根据自己的一些实际需求来控制 pod 的调度，这就需要用到 nodeAffinity(节点亲和性)、podAffinity(pod 亲和性) 以及 podAntiAffinity(pod 反亲和性)。&lt;/p&gt;
&lt;p&gt;亲和性调度可以分成软策略和硬策略两种方式:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;软策略&lt;/code&gt;就是如果你没有满足调度要求的节点的话，pod 就会忽略这条规则，继续完成调度过程，说白了就是满足条件最好了，没有的话也无所谓了的策略&lt;/li&gt;
&lt;li&gt;&lt;code&gt;硬策略&lt;/code&gt;就比较强硬了，如果没有满足条件的节点的话，就不断重试直到满足条件为止，简单说就是你必须满足我的要求，不然我就不干的策略。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;对于亲和性和反亲和性都有这两种规则可以设置： &lt;code&gt;preferredDuringSchedulingIgnoredDuringExecution&lt;/code&gt;和&lt;code&gt;requiredDuringSchedulingIgnoredDuringExecution&lt;/code&gt;，前面的就是软策略，后面的就是硬策略。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;这命名不觉得有点反人类吗？有点无语……&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;nodeAffinity&quot;&gt;&lt;a href=&quot;#nodeAffinity&quot; class=&quot;headerlink&quot; title=&quot;nodeAffinity&quot;&gt;&lt;/a&gt;nodeAffinity&lt;/h2&gt;&lt;p&gt;节点亲和性主要是用来控制 pod 要部署在哪些主机上，以及不能部署在哪些主机上的。它可以进行一些简单的逻辑组合了，不只是简单的相等匹配。&lt;/p&gt;
&lt;p&gt;比如现在我们用一个 Deployment 来管理3个 pod 副本，现在我们来控制下这些 pod 的调度，如下例子：（node-affinity-demo.yaml）&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; apps/v1beta1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; affinity&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    app:&lt;/span&gt; affinity&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  replicas:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  revisionHistoryLimit:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;15&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  template:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        app:&lt;/span&gt; affinity&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        role:&lt;/span&gt; test&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - name:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        image:&lt;/span&gt; nginx:&lt;span class=&quot;number&quot;&gt;1.7&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.9&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - containerPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          name:&lt;/span&gt; nginxweb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      affinity:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        nodeAffinity:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          requiredDuringSchedulingIgnoredDuringExecution:&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;# 硬策略&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            nodeSelectorTerms:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            - matchExpressions:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;              - key:&lt;/span&gt; kubernetes.io/hostname&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                operator:&lt;/span&gt; NotIn&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                values:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;                -&lt;/span&gt; node03&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          preferredDuringSchedulingIgnoredDuringExecution:&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;# 软策略&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          - weight:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            preference:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;              matchExpressions:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;              - key:&lt;/span&gt; com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                operator:&lt;/span&gt; In&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                values:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;                -&lt;/span&gt; youdianzhishi&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;上面这个 pod 首先是要求不能运行在 node03 这个节点上，如果有个节点满足&lt;code&gt;com=youdianzhishi&lt;/code&gt;的话就优先调度到这个节点上。&lt;/p&gt;
&lt;p&gt;下面是我们测试的节点列表信息：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get nodes --show-labels&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME      STATUS    ROLES     AGE       VERSION   LABELS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;master    Ready     master    154d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=master,node-role.kubernetes.io/master=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node02    Ready     &amp;lt;none&amp;gt;    74d       v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,com=youdianzhishi,course=k8s,kubernetes.io/hostname=node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node03    Ready     &amp;lt;none&amp;gt;    134d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,jnlp=haimaxy,kubernetes.io/hostname=node03&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;可以看到 node02 节点有&lt;code&gt;com=youdianzhishi&lt;/code&gt;这样的 label，按要求会优先调度到这个节点来的，现在我们来创建这个 pod，然后使用descirbe命令查看具体的调度情况是否满足我们的要求。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl create &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; node-affinity-demo.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deployment.apps &lt;span class=&quot;string&quot;&gt;&quot;affinity&quot;&lt;/span&gt; created&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt; app=affinity -o wide&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                        READY     STATUS    RESTARTS   AGE       IP             NODE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-7b4c946854-5gfln   1/1       Running   0          47s       10.244.4.214   node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-7b4c946854&lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt;8b47   1/1       Running   0          47s       10.244.4.215   node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-7b4c946854-r86p5   1/1       Running   0          47s       10.244.4.213   node02&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;从结果可以看出 pod 都被部署到了 node02，其他节点上没有部署 pod，这里的匹配逻辑是 label 的值在某个列表中，现在&lt;code&gt;Kubernetes&lt;/code&gt;提供的操作符有下面的几种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;In：label 的值在某个列表中&lt;/li&gt;
&lt;li&gt;NotIn：label 的值不在某个列表中&lt;/li&gt;
&lt;li&gt;Gt：label 的值大于某个值&lt;/li&gt;
&lt;li&gt;Lt：label 的值小于某个值&lt;/li&gt;
&lt;li&gt;Exists：某个 label 存在&lt;/li&gt;
&lt;li&gt;DoesNotExist：某个 label 不存在&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;如果&lt;code&gt;nodeSelectorTerms&lt;/code&gt;下面有多个选项的话，满足任何一个条件就可以了；如果&lt;code&gt;matchExpressions&lt;/code&gt;有多个选项的话，则必须同时满足这些条件才能正常调度 POD。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;podAffinity&quot;&gt;&lt;a href=&quot;#podAffinity&quot; class=&quot;headerlink&quot; title=&quot;podAffinity&quot;&gt;&lt;/a&gt;podAffinity&lt;/h2&gt;&lt;p&gt;pod 亲和性主要解决 pod 可以和哪些 pod 部署在同一个拓扑域中的问题（其中拓扑域用主机标签实现，可以是单个主机，也可以是多个主机组成的 cluster、zone 等等），而 pod 反亲和性主要是解决 pod 不能和哪些 pod 部署在同一个拓扑域中的问题，它们都是处理的 pod 与 pod 之间的关系，比如一个 pod 在一个节点上了，那么我这个也得在这个节点，或者你这个 pod 在节点上了，那么我就不想和你待在同一个节点上。&lt;/p&gt;
&lt;p&gt;由于我们这里只有一个集群，并没有区域或者机房的概念，所以我们这里直接使用主机名来作为拓扑域，把 pod 创建在同一个主机上面。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get nodes --show-labels&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME      STATUS    ROLES     AGE       VERSION   LABELS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;master    Ready     master    154d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=master,node-role.kubernetes.io/master=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node02    Ready     &amp;lt;none&amp;gt;    74d       v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,com=youdianzhishi,course=k8s,kubernetes.io/hostname=node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node03    Ready     &amp;lt;none&amp;gt;    134d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,jnlp=haimaxy,kubernetes.io/hostname=node03&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;同样，还是针对上面的资源对象，我们来测试下 pod 的亲和性：（pod-affinity-demo.yaml）&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; apps/v1beta1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; affinity&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    app:&lt;/span&gt; affinity&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  replicas:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  revisionHistoryLimit:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;15&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  template:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        app:&lt;/span&gt; affinity&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        role:&lt;/span&gt; test&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - name:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        image:&lt;/span&gt; nginx:&lt;span class=&quot;number&quot;&gt;1.7&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.9&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - containerPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          name:&lt;/span&gt; nginxweb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      affinity:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        podAffinity:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          requiredDuringSchedulingIgnoredDuringExecution:&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;# 硬策略&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          - labelSelector:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;              matchExpressions:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;              - key:&lt;/span&gt; app&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                operator:&lt;/span&gt; In&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                values:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;                -&lt;/span&gt; busybox-pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            topologyKey:&lt;/span&gt; kubernetes.io/hostname&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;上面这个例子中的 pod 需要调度到某个指定的主机上，至少有一个节点上运行了这样的 pod：这个 pod 有一个&lt;code&gt;app=busybox-pod&lt;/code&gt;的 label。&lt;/p&gt;
&lt;p&gt;我们查看有标签&lt;code&gt;app=busybox-pod&lt;/code&gt;的 pod 列表：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods -o wide &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt; app=busybox-pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME           READY     STATUS    RESTARTS   AGE       IP             NODE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-busybox   1/1       Running   164        7d        10.244.4.205   node02&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们看到这个 pod 运行在了 node02 的节点上面，所以按照上面的亲和性来说，上面我们部署的3个 pod 副本也应该运行在 node02 节点上：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods -o wide &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt; app=affinity&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                        READY     STATUS    RESTARTS   AGE       IP             NODE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-564f9d7db9-lzzvq   1/1       Running   0          3m        10.244.4.216   node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-564f9d7db9-p79cq   1/1       Running   0          3m        10.244.4.217   node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-564f9d7db9-spfzs   1/1       Running   0          3m        10.244.4.218   node02&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果我们把上面的 test-busybox 和 affinity 这个 Deployment 都删除，然后重新创建 affinity 这个资源，看看能不能正常调度呢：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl delete &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; node-selector-demo.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pod &lt;span class=&quot;string&quot;&gt;&quot;test-busybox&quot;&lt;/span&gt; deleted&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl delete &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; pod-affinity-demo.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deployment.apps &lt;span class=&quot;string&quot;&gt;&quot;affinity&quot;&lt;/span&gt; deleted&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl create &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; pod-affinity-demo.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deployment.apps &lt;span class=&quot;string&quot;&gt;&quot;affinity&quot;&lt;/span&gt; created&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods -o wide &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt; app=affinity&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                        READY     STATUS    RESTARTS   AGE       IP        NODE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-564f9d7db9-fbc8w   0/1       Pending   0          2m        &amp;lt;none&amp;gt;    &amp;lt;none&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-564f9d7db9-n8gcf   0/1       Pending   0          2m        &amp;lt;none&amp;gt;    &amp;lt;none&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-564f9d7db9-qc7x6   0/1       Pending   0          2m        &amp;lt;none&amp;gt;    &amp;lt;none&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们可以看到处于&lt;code&gt;Pending&lt;/code&gt;状态了，这是因为现在没有一个节点上面拥有&lt;code&gt;busybox-pod&lt;/code&gt;这个 label 的 pod，而上面我们的调度使用的是硬策略，所以就没办法进行调度了，大家可以去尝试下重新将 test-busybox 这个 pod 调度到 node03 这个节点上，看看上面的 affinity 的3个副本会不会也被调度到 node03 这个节点上去？&lt;/p&gt;
&lt;p&gt;我们这个地方使用的是&lt;code&gt;kubernetes.io/hostname&lt;/code&gt;这个拓扑域，意思就是我们当前调度的 pod 要和目标的 pod 处于同一个主机上面，因为要处于同一个拓扑域下面，为了说明这个问题，我们把拓扑域改成&lt;code&gt;beta.kubernetes.io/os&lt;/code&gt;，同样的我们当前调度的 pod 要和目标的 pod 处于同一个拓扑域中，目标的 pod 是不是拥有&lt;code&gt;beta.kubernetes.io/os=linux&lt;/code&gt;的标签，而我们这里3个节点都有这样的标签，这也就意味着我们3个节点都在同一个拓扑域中，所以我们这里的 pod 可能会被调度到任何一个节点：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods -o wide&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                                      READY     STATUS      RESTARTS   AGE       IP             NODE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-7d86749984-glkhz                 1/1       Running     0          3m        10.244.2.16    node03&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-7d86749984-h4fb9                 1/1       Running     0          3m        10.244.4.219   node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-7d86749984-tj7k2                 1/1       Running     0          3m        10.244.2.14    node03&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;podAntiAffinity&quot;&gt;&lt;a href=&quot;#podAntiAffinity&quot; class=&quot;headerlink&quot; title=&quot;podAntiAffinity&quot;&gt;&lt;/a&gt;podAntiAffinity&lt;/h2&gt;&lt;p&gt;这就是 pod 亲和性的用法，而 pod 反亲和性则是反着来的，比如一个节点上运行了某个 pod，那么我们的 pod 则希望被调度到其他节点上去，同样我们把上面的 podAffinity 直接改成 podAntiAffinity，(pod-antiaffinity-demo.yaml)&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; apps/v1beta1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; affinity&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    app:&lt;/span&gt; affinity&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  replicas:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  revisionHistoryLimit:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;15&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  template:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        app:&lt;/span&gt; affinity&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        role:&lt;/span&gt; test&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - name:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        image:&lt;/span&gt; nginx:&lt;span class=&quot;number&quot;&gt;1.7&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.9&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - containerPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          name:&lt;/span&gt; nginxweb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      affinity:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        podAntiAffinity:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          requiredDuringSchedulingIgnoredDuringExecution:&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;# 硬策略&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          - labelSelector:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;              matchExpressions:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;              - key:&lt;/span&gt; app&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                operator:&lt;/span&gt; In&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;                values:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;                -&lt;/span&gt; busybox-pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            topologyKey:&lt;/span&gt; kubernetes.io/hostname&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这里的意思就是如果一个节点上面有一个&lt;code&gt;app=busybox-pod&lt;/code&gt;这样的 pod 的话，那么我们的 pod 就别调度到这个节点上面来，上面我们把&lt;code&gt;app=busybox-pod&lt;/code&gt;这个 pod 固定到了 node03 这个节点上面来，所以正常来说我们这里的 pod 不会出现在 node03 节点上：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl create &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; pod-antiaffinity-demo.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deployment.apps &lt;span class=&quot;string&quot;&gt;&quot;affinity&quot;&lt;/span&gt; created&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods -o wide&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                                      READY     STATUS      RESTARTS   AGE       IP             NODE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-bcbd8854f-br8z8                  1/1       Running     0          5s        10.244.4.222   node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-bcbd8854f-cdffh                  1/1       Running     0          5s        10.244.4.223   node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;affinity-bcbd8854f-htb52                  1/1       Running     0          5s        10.244.4.224   node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-busybox                              1/1       Running     0          23m       10.244.2.10    node03&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这就是 pod 反亲和性的用法。&lt;/p&gt;
&lt;h2 id=&quot;污点（taints）与容忍（tolerations）&quot;&gt;&lt;a href=&quot;#污点（taints）与容忍（tolerations）&quot; class=&quot;headerlink&quot; title=&quot;污点（taints）与容忍（tolerations）&quot;&gt;&lt;/a&gt;污点（taints）与容忍（tolerations）&lt;/h2&gt;&lt;p&gt;对于&lt;code&gt;nodeAffinity&lt;/code&gt;无论是硬策略还是软策略方式，都是调度 pod 到预期节点上，而&lt;code&gt;Taints&lt;/code&gt;恰好与之相反，如果一个节点标记为 Taints ，除非 pod 也被标识为可以容忍污点节点，否则该 Taints 节点不会被调度 pod。&lt;/p&gt;
&lt;p&gt;比如用户希望把 Master 节点保留给 Kubernetes 系统组件使用，或者把一组具有特殊资源预留给某些 pod，则污点就很有用了，pod 不会再被调度到 taint 标记过的节点。我们使用&lt;code&gt;kubeadm&lt;/code&gt;搭建的集群默认就给 master 节点添加了一个污点标记，所以我们看到我们平时的 pod 都没有被调度到 master 上去：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl describe node master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Name:               master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Roles:              master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Labels:             beta.kubernetes.io/arch=amd64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    beta.kubernetes.io/os=linux&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    kubernetes.io/hostname=master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    node-role.kubernetes.io/master=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;......&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Taints:             node-role.kubernetes.io/master:NoSchedule&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Unschedulable:      &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;......&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们可以使用上面的命令查看 master 节点的信息，其中有一条关于 Taints 的信息：node-role.kubernetes.io/master:NoSchedule，就表示给 master 节点打了一个污点的标记，其中影响的参数是&lt;code&gt;NoSchedule&lt;/code&gt;，表示 pod 不会被调度到标记为 taints 的节点，除了 NoSchedule 外，还有另外两个选项：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;PreferNoSchedule&lt;/code&gt;：NoSchedule 的软策略版本，表示尽量不调度到污点节点上去&lt;/li&gt;
&lt;li&gt;&lt;code&gt;NoExecute&lt;/code&gt;：该选项意味着一旦 Taint 生效，如该节点内正在运行的 pod 没有对应 Tolerate 设置，会直接被逐出&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;污点 taint 标记节点的命令如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl taint nodes node02 &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;=node02:NoSchedule&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node &lt;span class=&quot;string&quot;&gt;&quot;node02&quot;&lt;/span&gt; tainted&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;上面的命名将 node02 节点标记为了污点，影响策略是 NoSchedule，只会影响新的 pod 调度，如果仍然希望某个 pod 调度到 taint 节点上，则必须在 Spec 中做出&lt;code&gt;Toleration&lt;/code&gt;定义，才能调度到该节点，比如现在我们想要将一个 pod 调度到 master 节点：(taint-demo.yaml)&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; apps/v1beta1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; taint&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    app:&lt;/span&gt; taint&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  replicas:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  revisionHistoryLimit:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  template:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        app:&lt;/span&gt; taint&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - name:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        image:&lt;/span&gt; nginx:&lt;span class=&quot;number&quot;&gt;1.7&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.9&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - name:&lt;/span&gt; http&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          containerPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      tolerations:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - key:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;node-role.kubernetes.io/master&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        operator:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Exists&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        effect:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;NoSchedule&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;由于 master 节点被标记为了污点节点，所以我们这里要想 pod 能够调度到 master 节点去，就需要增加容忍的声明：&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;tolerations:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- key:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;node-role.kubernetes.io/master&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  operator:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Exists&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  effect:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;NoSchedule&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后创建上面的资源，查看结果：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl create &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; taint-demo.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deployment.apps &lt;span class=&quot;string&quot;&gt;&quot;taint&quot;&lt;/span&gt; created&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods -o wide&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                                      READY     STATUS             RESTARTS   AGE       IP             NODE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;......&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;taint-845d8bb4fb-57mhm                    1/1       Running            0          1m        10.244.4.247   node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;taint-845d8bb4fb-bbvmp                    1/1       Running            0          1m        10.244.0.33    master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;taint-845d8bb4fb-zb78x                    1/1       Running            0          1m        10.244.4.246   node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;......&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们可以看到有一个 pod 副本被调度到了 master 节点，这就是容忍的使用方法。&lt;/p&gt;
&lt;p&gt;对于 tolerations 属性的写法，其中的 key、value、effect 与 Node 的 Taint 设置需保持一致， 还有以下几点说明：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1.如果 operator 的值是 Exists，则 value 属性可省略&lt;/li&gt;
&lt;li&gt;2.如果 operator 的值是 Equal，则表示其 key 与 value 之间的关系是 equal(等于)&lt;/li&gt;
&lt;li&gt;3.如果不指定 operator 属性，则默认值为 Equal&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;另外，还有两个特殊值：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1.空的 key 如果再配合 Exists 就能匹配所有的 key 与 value，也是是能容忍所有 node 的所有 Taints&lt;/li&gt;
&lt;li&gt;2.空的 effect 匹配所有的 effect&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;最后，如果我们要取消节点的污点标记，可以使用下面的命令：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl taint nodes node02 &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node &lt;span class=&quot;string&quot;&gt;&quot;node02&quot;&lt;/span&gt; untainted&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这就是污点和容忍的使用方法。                                                                                             &lt;/p&gt;
&lt;p&gt;来源：www.qikqiak.com&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;一般情况下我们部署的 Pod 是通过集群的自动调度策略来选择节点的，默认情况下调度器考虑的是资源足够，并且负载尽量平均，但是有的时候我们需要能够更加细粒度的去控制 Pod 的调度，比如我们内部的一些服务 gitlab 之类的也是跑在&lt;code&gt;Kubernetes&lt;/code&gt;集群上的，我们就不希望对外的一些服务和内部的服务跑在同一个节点上了，害怕内部服务对外部的服务产生影响；但是有的时候我们的服务之间交流比较频繁，又希望能够将这两个服务的 Pod 调度到同一个的节点上。这就需要用到 Kubernetes 里面的一个概念：亲和性和反亲和性。&lt;/p&gt;
&lt;p&gt;亲和性有分成节点亲和性(&lt;code&gt;nodeAffinity&lt;/code&gt;)和 Pod 亲和性(&lt;code&gt;podAffinity&lt;/code&gt;)。&lt;/p&gt;
&lt;h2 id=&quot;nodeSelector&quot;&gt;&lt;a href=&quot;#nodeSelector&quot; class=&quot;headerlink&quot; title=&quot;nodeSelector&quot;&gt;&lt;/a&gt;nodeSelector&lt;/h2&gt;&lt;p&gt;在了解亲和性之前，我们先来了解一个非常常用的调度方式：nodeSelector。我们知道label是kubernetes中一个非常重要的概念，用户可以非常灵活的利用 label 来管理集群中的资源，比如最常见的一个就是 service 通过匹配 label 去匹配 Pod 资源，而 Pod 的调度也可以根据节点的 label 来进行调度。&lt;/p&gt;
&lt;p&gt;我们可以通过下面的命令查看我们的 node 的 label：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get nodes --show-labels&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME      STATUS    ROLES     AGE       VERSION   LABELS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;master    Ready     master    147d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=master,node-role.kubernetes.io/master=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node02    Ready     &amp;lt;none&amp;gt;    67d       v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,course=k8s,kubernetes.io/hostname=node02&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node03    Ready     &amp;lt;none&amp;gt;    127d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,jnlp=haimaxy,kubernetes.io/hostname=node03&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;现在我们先给节点node02增加一个com=youdianzhishi的标签，命令如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl label nodes node02 com=youdianzhishi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node &lt;span class=&quot;string&quot;&gt;&quot;node02&quot;&lt;/span&gt; labeled&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="调度器" scheme="http://icyxp.github.io/categories/kubernetes/%E8%B0%83%E5%BA%A6%E5%99%A8/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="调度" scheme="http://icyxp.github.io/tags/%E8%B0%83%E5%BA%A6/"/>
    
      <category term="亲和性" scheme="http://icyxp.github.io/tags/%E4%BA%B2%E5%92%8C%E6%80%A7/"/>
    
      <category term="affinity" scheme="http://icyxp.github.io/tags/affinity/"/>
    
      <category term="nodeSelector" scheme="http://icyxp.github.io/tags/nodeSelector/"/>
    
      <category term="污点" scheme="http://icyxp.github.io/tags/%E6%B1%A1%E7%82%B9/"/>
    
      <category term="容忍" scheme="http://icyxp.github.io/tags/%E5%AE%B9%E5%BF%8D/"/>
    
  </entry>
  
  <entry>
    <title>在阿里云使用Kubeadm 1.13.x 部署多Master集群</title>
    <link href="http://icyxp.github.io//blog/2019/02/k8s-kubeadm-ha-1-13-x.html"/>
    <id>http://icyxp.github.io//blog/2019/02/k8s-kubeadm-ha-1-13-x.html</id>
    <published>2019-02-15T13:00:00.000Z</published>
    <updated>2019-02-15T09:51:43.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;前言（坑）&quot;&gt;&lt;a href=&quot;#前言（坑）&quot; class=&quot;headerlink&quot; title=&quot;前言（坑）&quot;&gt;&lt;/a&gt;前言（坑）&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;负载均衡问题&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;阿里不支持LVS，没有vip可用，必须通过申请SLB来固定VIP&lt;/li&gt;
&lt;li&gt;因Kubernetes apiserver为https协议，阿里SLB中能负载均衡HTTPS的只有TCP方式，但TCP协议不能转发到发起主机（&lt;code&gt;apiserver 需要有回环路访问，简单说就是自己给自己发请求&lt;/code&gt;）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;为了解决kubernets apiserver高可用问题，故用以下方式来解决：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;申请一个内网的SLB（获取VIP），8443为监听端口，6443为apiserver的后端端口&lt;/li&gt;
&lt;li&gt;在每台master机器上搭建keepalived+haproxy，VIP 用SLB的VIP&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;环境介绍&quot;&gt;&lt;a href=&quot;#环境介绍&quot; class=&quot;headerlink&quot; title=&quot;环境介绍&quot;&gt;&lt;/a&gt;环境介绍&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left&quot;&gt;IP&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;Hostname&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;备注&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.183&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.184&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.185&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-3&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.186&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.187&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.100&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;vip&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;申请阿里云的SLB获取到&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;环境初始化&quot;&gt;&lt;a href=&quot;#环境初始化&quot; class=&quot;headerlink&quot; title=&quot;环境初始化&quot;&gt;&lt;/a&gt;环境初始化&lt;/h2&gt;&lt;h3 id=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;a href=&quot;#修改hosts信息，在所有master机器上运行&quot; class=&quot;headerlink&quot; title=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;/a&gt;修改hosts信息，在所有master机器上运行&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/hosts&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.183 master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.184 master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.185 master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-1-机器上执行以下命令：&quot;&gt;&lt;a href=&quot;#在master-1-机器上执行以下命令：&quot; class=&quot;headerlink&quot; title=&quot;在master-1 机器上执行以下命令：&quot;&gt;&lt;/a&gt;在master-1 机器上执行以下命令：&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ssh-keygen -t rsa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;优化所有master-amp-node-节点的机器环境&quot;&gt;&lt;a href=&quot;#优化所有master-amp-node-节点的机器环境&quot; class=&quot;headerlink&quot; title=&quot;优化所有master &amp;amp; node 节点的机器环境&quot;&gt;&lt;/a&gt;优化所有master &amp;amp; node 节点的机器环境&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;在所有master &amp;amp; node 机器上都要执行以下命令&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#################################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装4.18版本内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 由于最新稳定版4.19内核将nf_conntrack_ipv4更名为nf_conntrack，目前的kube-proxy不支持在4.19版本内核下开启ipvs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 详情可以查看：https://github.com/kubernetes/kubernetes/issues/70304&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 对于该问题的修复10月30日刚刚合并到代码主干，所以目前还没有包含此修复的kubernetes版本发出&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 可以选择安装4.18版本内核，或者不开启IPVS&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#################################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# start #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 升级内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm ;yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml -y&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 检查默认内核版本是否大于4.14，否则请调整默认启动参数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;grub2-editenv list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#重启以更换内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;reboot&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 开启ip_vs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; /etc/sysconfig/modules/ipvs.modules &amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ipvs_modules_dir=&lt;span class=&quot;string&quot;&gt;&quot;/usr/lib/modules/\`uname -r\`/kernel/net/netfilter/ipvs&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; \`ls \&lt;span class=&quot;variable&quot;&gt;$ipvs_modules_dir&lt;/span&gt; | sed  -r &lt;span class=&quot;string&quot;&gt;&#39;s#(.*).ko.*#\1#&#39;&lt;/span&gt;\`; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    /sbin/modinfo -F filename \&lt;span class=&quot;variable&quot;&gt;$i&lt;/span&gt;  &amp;amp;&amp;gt; /dev/null&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; [ \$? &lt;span class=&quot;_&quot;&gt;-eq&lt;/span&gt; 0 ]; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        /sbin/modprobe \&lt;span class=&quot;variable&quot;&gt;$i&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;fi&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#检查是否开启了ip_vs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; bash /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; lsmod | grep ip_vs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# end #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 优化内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt;  /etc/sysctl.d/k8s.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.ip_forward = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.bridge.bridge-nf-call-ip6tables = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.bridge.bridge-nf-call-iptables = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.netfilter.nf_conntrack_max=2310720&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.may_detach_mounts = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.inotify.max_user_watches=1048576&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.inotify.max_user_instances = 8192&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.file-max=52706963&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.nr_open=52706963&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vm.swappiness = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vm.panic_on_oom=0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vm.overcommit_memory=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sysctl --system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 执行sysctl报错请参考centos7添加bridge-nf-call-ip6tables出现No such file or directory: https://blog.csdn.net/airuozhaoyang/article/details/40534953&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 优化文件打开数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* soft nofile 65536&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* hard nofile 65536&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* soft nproc 65536&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* hard nproc 65536&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* soft  memlock  unlimited&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* hard memlock  unlimited&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 关闭Selinux/firewalld&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl stop firewalld&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;disable&lt;/span&gt; firewalld&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;setenforce 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot;&lt;/span&gt; /etc/selinux/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 关闭交换分区&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;swapoff &lt;span class=&quot;_&quot;&gt;-a&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yes | cp /etc/fstab /etc/fstab_bak&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat /etc/fstab_bak |grep -v swap &amp;gt; /etc/fstab&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 同步时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install -y ntpdate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ntpdate -u ntp.api.bz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置kubernet yum源&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; /etc/yum.repos.d/kubernetes.repo &amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[kubernetes]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name=Kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;enabled=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgcheck=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;repo_gpgcheck=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装kubernet&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install kubeadm-1.13.3-0 kubelet-1.13.3-0 kubectl-1.13.3-0 --disableexcludes=kubernetes -y&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置docker源&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; /etc/yum.repos.d/docker.repo &amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[docker]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name=Docker Repository&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;baseurl=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/repo/centos7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;enabled=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgcheck=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgkey=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/gpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装docker-engine&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum -y install docker-engine-1.13.1 --disableexcludes=docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置kubelet启动配置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cgroupDriver=$(docker info|grep Cg)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;driver=&lt;span class=&quot;variable&quot;&gt;$&amp;#123;cgroupDriver##*: &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;driver is &lt;span class=&quot;variable&quot;&gt;$&amp;#123;driver&amp;#125;&lt;/span&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[Service]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_NETWORK_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_DNS_ARGS=--cluster-dns=10.96.0.10 --cluster-domain=cluster.local&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_AUTHZ_ARGS=--authorization-mode=Webhook --client-ca-file=/etc/kubernetes/pki/ca.crt&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_CGROUP_ARGS=--cgroup-driver=&lt;span class=&quot;variable&quot;&gt;$&amp;#123;driver&amp;#125;&lt;/span&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_CERTIFICATE_ARGS=--rotate-certificates=true --cert-dir=/var/lib/kubelet/pki&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_EXTRA_ARGS=--system-reserved=cpu=200m,memory=250Mi --kube-reserved=cpu=200m,memory=250Mi --eviction-soft=memory.available&amp;lt;500Mi,nodefs.available&amp;lt;2Gi --eviction-soft-grace-period=memory.available=1m30s,nodefs.available=1m30s --eviction-max-pod-grace-period=120 --eviction-hard=memory.available&amp;lt;500Mi,nodefs.available&amp;lt;1Gi --eviction-minimum-reclaim=memory.available=0Mi,nodefs.available=500Mi,imagefs.available=2Gi --node-status-update-frequency=10s --eviction-pressure-transition-period=30s&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ExecStart=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ExecStart=/usr/bin/kubelet \&lt;span class=&quot;variable&quot;&gt;$KUBELET_KUBECONFIG_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_SYSTEM_PODS_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_NETWORK_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_DNS_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_AUTHZ_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_CGROUP_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_CERTIFICATE_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_EXTRA_ARGS&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;搭建keepalived-haproxy&quot;&gt;&lt;a href=&quot;#搭建keepalived-haproxy&quot; class=&quot;headerlink&quot; title=&quot;搭建keepalived + haproxy&quot;&gt;&lt;/a&gt;搭建keepalived + haproxy&lt;/h2&gt;&lt;h3 id=&quot;在master-1上配置&quot;&gt;&lt;a href=&quot;#在master-1上配置&quot; class=&quot;headerlink&quot; title=&quot;在master-1上配置&quot;&gt;&lt;/a&gt;在master-1上配置&lt;/h3&gt;&lt;h4 id=&quot;keepalived-安装配置&quot;&gt;&lt;a href=&quot;#keepalived-安装配置&quot; class=&quot;headerlink&quot; title=&quot;keepalived 安装配置&quot;&gt;&lt;/a&gt;keepalived 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker run --net=host --cap-add=NET_ADMIN \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; KEEPALIVED_INTERFACE=eth0 \  &lt;span class=&quot;comment&quot;&gt;#网卡名称&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; KEEPALIVED_VIRTUAL_IPS=&lt;span class=&quot;string&quot;&gt;&quot;#PYTHON2BASH:[&#39;172.19.170.100&#39;]&quot;&lt;/span&gt; \  &lt;span class=&quot;comment&quot;&gt;#VIP地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; KEEPALIVED_UNICAST_PEERS=&lt;span class=&quot;string&quot;&gt;&quot;#PYTHON2BASH:[&#39;172.19.170.183&#39;]&quot;&lt;/span&gt; \ &lt;span class=&quot;comment&quot;&gt;#master-1地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; KEEPALIVED_PASSWORD=k8s \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--name k8s-keepalived \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--restart always \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt; osixia/keepalived:2.0.12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;haproxy-安装配置&quot;&gt;&lt;a href=&quot;#haproxy-安装配置&quot; class=&quot;headerlink&quot; title=&quot;haproxy 安装配置&quot;&gt;&lt;/a&gt;haproxy 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;mkdir /etc/haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt;/etc/haproxy/haproxy.cfg&amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt; 127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;0 err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  maxconn 50000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  uid 99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  gid 99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;#daemon&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  nbproc 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  pidfile haproxy.pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;defaults&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  mode http&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt; 127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;0 err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  maxconn 50000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  retries 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  timeout connect 5s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  timeout client 30s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  timeout server 30s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  timeout check 2s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;listen admin_stats&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  mode http&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; 0.0.0.0:1080&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt; 127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;0 err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats refresh 30s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats uri     /haproxy-status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats realm   Haproxy\ Statistics&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats auth    admin:k8s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats hide-version&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats admin &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; TRUE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;frontend k8s-https&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; 0.0.0.0:8443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;#maxconn 50000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  default_backend k8s-https&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;backend k8s-https&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  balance roundrobin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  server master-1 172.19.170.183:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  server master-2 172.19.170.184:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  server master-3 172.19.170.185:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker run &lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt; --name k8s-haproxy \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-v /etc/haproxy:/usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/etc/haproxy:ro \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-p 8443:8443 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-p 1080:1080 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--restart always \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;haproxy:1.7.8-alpine&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-2上配置&quot;&gt;&lt;a href=&quot;#在master-2上配置&quot; class=&quot;headerlink&quot; title=&quot;在master-2上配置&quot;&gt;&lt;/a&gt;在master-2上配置&lt;/h3&gt;&lt;h4 id=&quot;keepalived-安装配置-1&quot;&gt;&lt;a href=&quot;#keepalived-安装配置-1&quot; class=&quot;headerlink&quot; title=&quot;keepalived 安装配置&quot;&gt;&lt;/a&gt;keepalived 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker run --net=host --cap-add=NET_ADMIN \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; KEEPALIVED_INTERFACE=eth0 \  &lt;span class=&quot;comment&quot;&gt;#网卡名称&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; KEEPALIVED_VIRTUAL_IPS=&lt;span class=&quot;string&quot;&gt;&quot;#PYTHON2BASH:[&#39;172.19.170.100&#39;]&quot;&lt;/span&gt; \  &lt;span class=&quot;comment&quot;&gt;#VIP地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; KEEPALIVED_UNICAST_PEERS=&lt;span class=&quot;string&quot;&gt;&quot;#PYTHON2BASH:[&#39;172.19.170.184&#39;]&quot;&lt;/span&gt; \ &lt;span class=&quot;comment&quot;&gt;#master-2地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; KEEPALIVED_PASSWORD=k8s \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--name k8s-keepalived \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--restart always \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt; osixia/keepalived:2.0.12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;haproxy-安装配置-1&quot;&gt;&lt;a href=&quot;#haproxy-安装配置-1&quot; class=&quot;headerlink&quot; title=&quot;haproxy 安装配置&quot;&gt;&lt;/a&gt;haproxy 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;mkdir /etc/haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt;/etc/haproxy/haproxy.cfg&amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt; 127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;0 err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  maxconn 50000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  uid 99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  gid 99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;#daemon&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  nbproc 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  pidfile haproxy.pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;defaults&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  mode http&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt; 127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;0 err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  maxconn 50000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  retries 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  timeout connect 5s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  timeout client 30s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  timeout server 30s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  timeout check 2s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;listen admin_stats&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  mode http&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; 0.0.0.0:1080&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt; 127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;0 err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats refresh 30s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats uri     /haproxy-status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats realm   Haproxy\ Statistics&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats auth    admin:k8s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats hide-version&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats admin &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; TRUE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;frontend k8s-https&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; 0.0.0.0:8443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;#maxconn 50000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  default_backend k8s-https&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;backend k8s-https&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  balance roundrobin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  server master-1 172.19.170.183:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  server master-2 172.19.170.184:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  server master-3 172.19.170.185:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker run &lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt; --name k8s-haproxy \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-v /etc/haproxy:/usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/etc/haproxy:ro \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-p 8443:8443 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-p 1080:1080 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--restart always \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;haproxy:1.7.8-alpine&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-3上配置&quot;&gt;&lt;a href=&quot;#在master-3上配置&quot; class=&quot;headerlink&quot; title=&quot;在master-3上配置&quot;&gt;&lt;/a&gt;在master-3上配置&lt;/h3&gt;&lt;h4 id=&quot;keepalived-安装配置-2&quot;&gt;&lt;a href=&quot;#keepalived-安装配置-2&quot; class=&quot;headerlink&quot; title=&quot;keepalived 安装配置&quot;&gt;&lt;/a&gt;keepalived 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker run --net=host --cap-add=NET_ADMIN \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; KEEPALIVED_INTERFACE=eth0 \  &lt;span class=&quot;comment&quot;&gt;#网卡名称&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; KEEPALIVED_VIRTUAL_IPS=&lt;span class=&quot;string&quot;&gt;&quot;#PYTHON2BASH:[&#39;172.19.170.100&#39;]&quot;&lt;/span&gt; \  &lt;span class=&quot;comment&quot;&gt;#VIP地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; KEEPALIVED_UNICAST_PEERS=&lt;span class=&quot;string&quot;&gt;&quot;#PYTHON2BASH:[&#39;172.19.170.185&#39;]&quot;&lt;/span&gt; \ &lt;span class=&quot;comment&quot;&gt;#master-3地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; KEEPALIVED_PASSWORD=k8s \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--name k8s-keepalived \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--restart always \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt; osixia/keepalived:2.0.12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;haproxy-安装配置-2&quot;&gt;&lt;a href=&quot;#haproxy-安装配置-2&quot; class=&quot;headerlink&quot; title=&quot;haproxy 安装配置&quot;&gt;&lt;/a&gt;haproxy 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;mkdir /etc/haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt;/etc/haproxy/haproxy.cfg&amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt; 127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;0 err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  maxconn 50000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  uid 99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  gid 99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;#daemon&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  nbproc 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  pidfile haproxy.pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;defaults&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  mode http&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt; 127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;0 err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  maxconn 50000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  retries 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  timeout connect 5s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  timeout client 30s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  timeout server 30s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  timeout check 2s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;listen admin_stats&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  mode http&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; 0.0.0.0:1080&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt; 127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;0 err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats refresh 30s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats uri     /haproxy-status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats realm   Haproxy\ Statistics&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats auth    admin:k8s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats hide-version&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  stats admin &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; TRUE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;frontend k8s-https&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; 0.0.0.0:8443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;#maxconn 50000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  default_backend k8s-https&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;backend k8s-https&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  balance roundrobin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  server master-1 172.19.170.183:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  server master-2 172.19.170.184:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  server master-3 172.19.170.185:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker run &lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt; --name k8s-haproxy \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-v /etc/haproxy:/usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/etc/haproxy:ro \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-p 8443:8443 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-p 1080:1080 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--restart always \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;haproxy:1.7.8-alpine&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;搭建kubernetes-master-集群&quot;&gt;&lt;a href=&quot;#搭建kubernetes-master-集群&quot; class=&quot;headerlink&quot; title=&quot;搭建kubernetes master 集群&quot;&gt;&lt;/a&gt;搭建kubernetes master 集群&lt;/h2&gt;&lt;h3 id=&quot;配置阿里云-SLB&quot;&gt;&lt;a href=&quot;#配置阿里云-SLB&quot; class=&quot;headerlink&quot; title=&quot;配置阿里云 SLB&quot;&gt;&lt;/a&gt;配置阿里云 SLB&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;在阿里云SLB 管理界面添加8443监听端口，使用&lt;code&gt;TCP&lt;/code&gt;协议，后端服务器选择一台你即将初始化的master机器，后端服务器端口为6443，健康检查默认配置即可，保存配置。此时你的SLB是不进行工作的，因为后端服务器的6443端口还未监听。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;初始化master-1&quot;&gt;&lt;a href=&quot;#初始化master-1&quot; class=&quot;headerlink&quot; title=&quot;初始化master-1&quot;&gt;&lt;/a&gt;初始化master-1&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt; &lt;code&gt;在master-1 上执行&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; $HOME/kubeadm&lt;span class=&quot;bullet&quot;&gt;-1.&lt;/span&gt;yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; kubeadm.k8s.io/v1beta1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ClusterConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kubernetesVersion:&lt;/span&gt; v1&lt;span class=&quot;number&quot;&gt;.13&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;controlPlaneEndpoint:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;172.19&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.170&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.100&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;8443&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiServer:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  certSANs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;172.19&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.170&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.183&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;172.19&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.170&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.184&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;172.19&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.170&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.185&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;172.19&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.170&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.100&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;networking:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# This CIDR is a Calico default. Substitute or remove for your CNI provider.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  podSubnet:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;192.168&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;/&lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;imageRepository:&lt;/span&gt; registry.cn-hangzhou.aliyuncs.com/google_containers  &lt;span class=&quot;comment&quot;&gt;# image的仓库源&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; kubeproxy.config.k8s.io/v1alpha1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; KubeProxyConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;mode:&lt;/span&gt; iptables&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm config images pull --config $HOME/kubeadm&lt;span class=&quot;bullet&quot;&gt;-1.&lt;/span&gt;yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:&lt;span class=&quot;number&quot;&gt;3.1&lt;/span&gt;  k8s.gcr.io/pause:&lt;span class=&quot;number&quot;&gt;3.1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm init --config $HOME/kubeadm&lt;span class=&quot;bullet&quot;&gt;-1.&lt;/span&gt;yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mkdir -p $HOME/.kube&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cp -f /etc/kubernetes/admin.conf $&amp;#123;HOME&amp;#125;/.kube/config&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;安装calico-网络插件&quot;&gt;&lt;a href=&quot;#安装calico-网络插件&quot; class=&quot;headerlink&quot; title=&quot;安装calico 网络插件&quot;&gt;&lt;/a&gt;安装calico 网络插件&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt; &lt;code&gt;在master-1 上执行&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;确保 &lt;code&gt;Kubernetes controller manager (/etc/kubernetes/manifests/kube-controller-manager.yaml)&lt;/code&gt; 设置了以下标志：&lt;code&gt;--cluster-cidr=192.168.0.0/16和--allocate-node-cidrs=true&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;提示：在kubeadm上，您可以传递&lt;code&gt;--pod-network-cidr=192.168.0.0/16&lt;/code&gt; 给kubeadm以设置两个Kubernetes控制器标志。&lt;/p&gt;
&lt;p&gt;在ConfigMap命名中&lt;code&gt;calico-config&lt;/code&gt;，找到&lt;code&gt;typha_service_name&lt;/code&gt;，删除&lt;code&gt;none&lt;/code&gt;值，并替换为&lt;code&gt;calico-typha&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;我们建议每&lt;code&gt;200&lt;/code&gt;个节点至少&lt;code&gt;复制一个副本&lt;/code&gt;，不超过20个副本。在生产中，我们建议至少使用&lt;code&gt;三个副本&lt;/code&gt;来减少滚动升级和故障的影响。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;警告：如果您设置typha_service_name而不增加其默认值为0 Felix的副本计数将尝试连接到Typha，找不到要连接的Typha实例，并且无法启动。&lt;/code&gt;&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; www.jiunile.com/k8s/plugin/1.12.3/calico.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;初始化其它master节点&quot;&gt;&lt;a href=&quot;#初始化其它master节点&quot; class=&quot;headerlink&quot; title=&quot;初始化其它master节点&quot;&gt;&lt;/a&gt;初始化其它master节点&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt; &lt;code&gt;在master-1 上执行&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#初始化master-2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh master-2 &lt;span class=&quot;string&quot;&gt;&quot;kubeadm reset -f &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rm -rf /etc/kubernetes/pki/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#初始化master-3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh master-3 &lt;span class=&quot;string&quot;&gt;&quot;kubeadm reset -f &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rm -rf /etc/kubernetes/pki/ &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#拷贝文件到master-2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.crt master-2:/etc/kubernetes/pki/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.key master-2:/etc/kubernetes/pki/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.key master-2:/etc/kubernetes/pki/sa.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.pub master-2:/etc/kubernetes/pki/sa.pub&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.crt master-2:/etc/kubernetes/pki/front-proxy-ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.key master-2:/etc/kubernetes/pki/front-proxy-ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/etcd/ca.crt master-2:/etc/kubernetes/pki/etcd/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/etcd/ca.key master-2:/etc/kubernetes/pki/etcd/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-2:/etc/kubernetes/admin.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-2:~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#拷贝文件到master-3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.crt master-3:/etc/kubernetes/pki/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.key master-3:/etc/kubernetes/pki/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.key master-3:/etc/kubernetes/pki/sa.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.pub master-3:/etc/kubernetes/pki/sa.pub&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.crt master-3:/etc/kubernetes/pki/front-proxy-ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.key master-3:/etc/kubernetes/pki/front-proxy-ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/etcd/ca.crt master-3:/etc/kubernetes/pki/etcd/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/etcd/ca.key master-3:/etc/kubernetes/pki/etcd/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-3:/etc/kubernetes/admin.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-3:~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#获取加入口令&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JOIN_CMD=`kubeadm token create --print-join-command`&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#将master-2 加入&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh master-2 &lt;span class=&quot;string&quot;&gt;&quot;&lt;span class=&quot;variable&quot;&gt;$&amp;#123;JOIN_CMD&amp;#125;&lt;/span&gt; --experimental-control-plane&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#将master-3 加入&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh master-3 &lt;span class=&quot;string&quot;&gt;&quot;&lt;span class=&quot;variable&quot;&gt;$&amp;#123;JOIN_CMD&amp;#125;&lt;/span&gt; --experimental-control-plane&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;再次配置阿里云-SLB&quot;&gt;&lt;a href=&quot;#再次配置阿里云-SLB&quot; class=&quot;headerlink&quot; title=&quot;再次配置阿里云 SLB&quot;&gt;&lt;/a&gt;再次配置阿里云 SLB&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;同样进入阿里云SLB管理界面，将其余的两台master机器加入到后端服务器中。这样你的apiserver 就高可用了&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;开启kubernetes-插件&quot;&gt;&lt;a href=&quot;#开启kubernetes-插件&quot; class=&quot;headerlink&quot; title=&quot;开启kubernetes 插件&quot;&gt;&lt;/a&gt;开启kubernetes 插件&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;在随意一台master执行&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;安装heapster-监控插件&quot;&gt;&lt;a href=&quot;#安装heapster-监控插件&quot; class=&quot;headerlink&quot; title=&quot;安装heapster 监控插件&quot;&gt;&lt;/a&gt;安装heapster 监控插件&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; www.jiunile.com/k8s/plugin/1.12.3/heapster.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;安装dashboard-插件&quot;&gt;&lt;a href=&quot;#安装dashboard-插件&quot; class=&quot;headerlink&quot; title=&quot;安装dashboard 插件&quot;&gt;&lt;/a&gt;安装dashboard 插件&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; www.jiunile.com/k8s/plugin/1.12.3/dashboard.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;获取加入master集群命令&quot;&gt;&lt;a href=&quot;#获取加入master集群命令&quot; class=&quot;headerlink&quot; title=&quot;获取加入master集群命令&quot;&gt;&lt;/a&gt;获取加入master集群命令&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubeadm token create --print-join-command&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;初始化所有kubernetes-node&quot;&gt;&lt;a href=&quot;#初始化所有kubernetes-node&quot; class=&quot;headerlink&quot; title=&quot;初始化所有kubernetes node&quot;&gt;&lt;/a&gt;初始化所有kubernetes node&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 拉取calico网络对应需要的镜像，拉取比教缓慢&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull quay.io/calico/typha:v3.3.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull quay.io/calico/node:v3.3.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull quay.io/calico/cni:v3.3.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 加入集群&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm join 172.19.170.100:8443 --token mrvxeb.mfr1wx6upq5bbwqt --discovery-token-ca-cert-hash sha256:8ee893d8bf69f1f622f55a983f1401a9f2a236ffa9248894cb614c972de47f48&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;可以在master机器上查看对应的node状态&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl get node&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl get pod -n kube-system&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;测试&quot;&gt;&lt;a href=&quot;#测试&quot; class=&quot;headerlink&quot; title=&quot;测试&quot;&gt;&lt;/a&gt;测试&lt;/h2&gt;&lt;h3 id=&quot;测试应用和dns是否正常&quot;&gt;&lt;a href=&quot;#测试应用和dns是否正常&quot; class=&quot;headerlink&quot; title=&quot;测试应用和dns是否正常&quot;&gt;&lt;/a&gt;测试应用和dns是否正常&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;在随意一台master机器上运行&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 部署一个服务&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /root &amp;amp;&amp;amp; mkdir nginx &amp;amp;&amp;amp; &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; nginx.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: Service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  selector:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    app: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt;: NodePort&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ports:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - port: 80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    nodePort: 31000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    name: nginx-port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    targetPort: 80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    protocol: TCP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: apps/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  replicas: 2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  selector:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    matchLabels:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      app: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  template:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      labels:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        app: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      containers:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        image: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ports:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        - containerPort: 80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; nginx.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 创建一个POD来测试DNS解析&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl run curl --image=radial/busyboxplus:curl -i --tty&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nslookup kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Server:    10.96.0.10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Name:      kubernetes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;curl nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 有返回结果表明ok&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl delete deployment curl&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;测试master-amp-Haproxy高可用&quot;&gt;&lt;a href=&quot;#测试master-amp-Haproxy高可用&quot; class=&quot;headerlink&quot; title=&quot;测试master &amp;amp; Haproxy高可用&quot;&gt;&lt;/a&gt;测试master &amp;amp; Haproxy高可用&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#随机关掉一台master机器&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;init 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在别的master机器上执行命令&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl get node&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#NAME      STATUS     ROLES     AGE       VERSION&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#master-1   NotReady   master    1h        v1.13.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#master-2   Ready      master    59m       v1.13.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#master-3   Ready      master    59m       v1.13.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#node-1     Ready      &amp;lt;none&amp;gt;    58m       v1.13.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#node-2     Ready      &amp;lt;none&amp;gt;    58m       v1.13.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#重新创建一个pod，看看是否能创建成功&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl run curl --image=radial/busyboxplus:curl -i --tty&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl delete deployment curl&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言（坑）&quot;&gt;&lt;a href=&quot;#前言（坑）&quot; class=&quot;headerlink&quot; title=&quot;前言（坑）&quot;&gt;&lt;/a&gt;前言（坑）&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;负载均衡问题&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;阿里不支持LVS，没有vip可用，必须通过申请SLB来固定VIP&lt;/li&gt;
&lt;li&gt;因Kubernetes apiserver为https协议，阿里SLB中能负载均衡HTTPS的只有TCP方式，但TCP协议不能转发到发起主机（&lt;code&gt;apiserver 需要有回环路访问，简单说就是自己给自己发请求&lt;/code&gt;）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;为了解决kubernets apiserver高可用问题，故用以下方式来解决：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;申请一个内网的SLB（获取VIP），8443为监听端口，6443为apiserver的后端端口&lt;/li&gt;
&lt;li&gt;在每台master机器上搭建keepalived+haproxy，VIP 用SLB的VIP&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;环境介绍&quot;&gt;&lt;a href=&quot;#环境介绍&quot; class=&quot;headerlink&quot; title=&quot;环境介绍&quot;&gt;&lt;/a&gt;环境介绍&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left&quot;&gt;IP&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;Hostname&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;备注&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.183&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.184&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.185&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-3&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.186&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.187&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.100&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;vip&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;申请阿里云的SLB获取到&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;环境初始化&quot;&gt;&lt;a href=&quot;#环境初始化&quot; class=&quot;headerlink&quot; title=&quot;环境初始化&quot;&gt;&lt;/a&gt;环境初始化&lt;/h2&gt;&lt;h3 id=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;a href=&quot;#修改hosts信息，在所有master机器上运行&quot; class=&quot;headerlink&quot; title=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;/a&gt;修改hosts信息，在所有master机器上运行&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/hosts&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.183 master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.184 master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.185 master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-1-机器上执行以下命令：&quot;&gt;&lt;a href=&quot;#在master-1-机器上执行以下命令：&quot; class=&quot;headerlink&quot; title=&quot;在master-1 机器上执行以下命令：&quot;&gt;&lt;/a&gt;在master-1 机器上执行以下命令：&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ssh-keygen -t rsa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="容器云" scheme="http://icyxp.github.io/categories/kubernetes/%E5%AE%B9%E5%99%A8%E4%BA%91/"/>
    
      <category term="kubadm" scheme="http://icyxp.github.io/categories/kubernetes/%E5%AE%B9%E5%99%A8%E4%BA%91/kubadm/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="kubeadm" scheme="http://icyxp.github.io/tags/kubeadm/"/>
    
      <category term="集群" scheme="http://icyxp.github.io/tags/%E9%9B%86%E7%BE%A4/"/>
    
      <category term="ha" scheme="http://icyxp.github.io/tags/ha/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes 调度器介绍</title>
    <link href="http://icyxp.github.io//blog/2019/02/k8s-scheduler.html"/>
    <id>http://icyxp.github.io//blog/2019/02/k8s-scheduler.html</id>
    <published>2019-02-14T12:00:00.000Z</published>
    <updated>2019-02-14T10:28:24.000Z</updated>
    
    <content type="html">&lt;h3 id=&quot;kube-scheduler-简介&quot;&gt;&lt;a href=&quot;#kube-scheduler-简介&quot; class=&quot;headerlink&quot; title=&quot;kube-scheduler 简介&quot;&gt;&lt;/a&gt;kube-scheduler 简介&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;kube-scheduler&lt;/code&gt;是 kubernetes 系统的核心组件之一，主要负责整个集群资源的调度功能，根据特定的调度算法和策略，将 Pod 调度到最优的工作节点上面去，从而更加合理、更加充分的利用集群的资源，这也是我们选择使用 kubernetes 一个非常重要的理由。如果一门新的技术不能帮助企业节约成本、提供效率，我相信是很难推进的。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;调度流程&quot;&gt;&lt;a href=&quot;#调度流程&quot; class=&quot;headerlink&quot; title=&quot;调度流程&quot;&gt;&lt;/a&gt;调度流程&lt;/h3&gt;&lt;p&gt;默认情况下，kube-scheduler 提供的默认调度器能够满足我们绝大多数的要求，我们前面和大家接触的示例也基本上用的默认的策略，都可以保证我们的 Pod 可以被分配到资源充足的节点上运行。但是在实际的线上项目中，可能我们自己会比 kubernetes 更加了解我们自己的应用，比如我们希望一个 Pod 只能运行在特定的几个节点上，或者这几个节点只能用来运行特定类型的应用，这就需要我们的调度器能够可控。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;kube-scheduler&lt;/code&gt; 是 kubernetes 的调度器，它的主要作用就是根据特定的调度算法和调度策略将 Pod 调度到合适的 Node 节点上去，是一个独立的二进制程序，启动之后会一直监听 API Server，获取到 PodSpec.NodeName 为空的 Pod，对每个 Pod 都会创建一个 binding。&lt;br&gt;&lt;img src=&quot;/images/k8s/kube-scheduler-structrue.jpg&quot; alt=&quot;K8s scheduler structure&quot;&gt;&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;这个过程在我们看来好像比较简单，但在实际的生产环境中，需要考虑的问题就有很多了：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如何保证全部的节点调度的公平性？要知道并不是说有节点资源配置都是一样的&lt;/li&gt;
&lt;li&gt;如何保证每个节点都能被分配资源？&lt;/li&gt;
&lt;li&gt;集群资源如何能够被高效利用？&lt;/li&gt;
&lt;li&gt;集群资源如何才能被最大化使用？&lt;/li&gt;
&lt;li&gt;如何保证 Pod 调度的性能和效率？&lt;/li&gt;
&lt;li&gt;用户是否可以根据自己的实际需求定制自己的调度策略？&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;考虑到实际环境中的各种复杂情况，kubernetes 的调度器采用插件化的形式实现，可以方便用户进行定制或者二次开发，我们可以自定义一个调度器并以插件形式和 kubernetes 进行集成。&lt;/p&gt;
&lt;p&gt;kubernetes 调度器的源码位于 kubernetes/pkg/scheduler 中，大体的代码目录结构如下所示：(不同的版本目录结构可能不太一样)&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubernetes/pkg/scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-- scheduler.go         &lt;span class=&quot;comment&quot;&gt;#调度相关的具体实现&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- algorithm&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- predicates      &lt;span class=&quot;comment&quot;&gt;#节点筛选策略&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- priorities      &lt;span class=&quot;comment&quot;&gt;#节点打分策略&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- algorithmprovider&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- defaults        &lt;span class=&quot;comment&quot;&gt;#定义默认的调度器&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中 Scheduler 创建和运行的核心程序，对应的代码在 pkg/scheduler/scheduler.go，如果要查看&lt;code&gt;kube-scheduler&lt;/code&gt;的入口程序，对应的代码在 cmd/kube-scheduler/scheduler.go。&lt;/p&gt;
&lt;p&gt;调度主要分为以下几个部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;首先是预选过程，过滤掉不满足条件的节点，这个过程称为&lt;code&gt;Predicates&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;然后是优选过程，对通过的节点按照优先级排序，称之为&lt;code&gt;Priorities&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;最后从中选择优先级最高的节点，如果中间任何一步骤有错误，就直接返回错误&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;Predicates&lt;/code&gt;阶段首先遍历全部节点，过滤掉不满足条件的节点，属于强制性规则，这一阶段输出的所有满足要求的 Node 将被记录并作为第二阶段的输入，如果所有的节点都不满足条件，那么 Pod 将会一直处于 Pending 状态，直到有节点满足条件，在这期间调度器会不断的重试。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;所以我们在部署应用的时候，如果发现有 Pod 一直处于 Pending 状态，那么就是没有满足调度条件的节点，这个时候可以去检查下节点资源是否可用。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code&gt;Priorities&lt;/code&gt;阶段即再次对节点进行筛选，如果有多个节点都满足条件的话，那么系统会按照节点的优先级(priorites)大小对节点进行排序，最后选择优先级最高的节点来部署 Pod 应用。&lt;/p&gt;
&lt;p&gt;下面是调度过程的简单示意图：&lt;br&gt;&lt;img src=&quot;/images/k8s/kube-scheduler-filter.jpg&quot; alt=&quot;K8s scheduler filter&quot;&gt;&lt;/p&gt;
&lt;p&gt;更详细的流程是这样的：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;首先，客户端通过 API Server 的 REST API 或者 kubectl 工具创建 Pod 资源&lt;/li&gt;
&lt;li&gt;API Server 收到用户请求后，存储相关数据到 etcd 数据库中&lt;/li&gt;
&lt;li&gt;调度器监听 API Server 查看为调度(bind)的 Pod 列表，循环遍历地为每个 Pod 尝试分配节点，这个分配过程就是我们上面提到的两个阶段：&lt;ul&gt;
&lt;li&gt;预选阶段(Predicates)，过滤节点，调度器用一组规则过滤掉不符合要求的 Node 节点，比如 Pod 设置了资源的 request，那么可用资源比 Pod 需要的资源少的主机显然就会被过滤掉&lt;/li&gt;
&lt;li&gt;优选阶段(Priorities)，为节点的优先级打分，将上一阶段过滤出来的 Node 列表进行打分，调度器会考虑一些整体的优化策略，比如把 Deployment 控制的多个 Pod 副本分布到不同的主机上，使用最低负载的主机等等策略&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;经过上面的阶段过滤后选择打分最高的 Node 节点和 Pod 进行 binding 操作，然后将结果存储到 etcd 中&lt;/li&gt;
&lt;li&gt;最后被选择出来的 Node 节点对应的 kubelet 去执行创建 Pod 的相关操作&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;其中&lt;code&gt;Predicates&lt;/code&gt;过滤有一系列的算法可以使用，我们这里简单列举几个：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;PodFitsResources：节点上剩余的资源是否大于 Pod 请求的资源&lt;/li&gt;
&lt;li&gt;PodFitsHost：如果 Pod 指定了 NodeName，检查节点名称是否和 NodeName 匹配&lt;/li&gt;
&lt;li&gt;PodFitsHostPorts：节点上已经使用的 port 是否和 Pod 申请的 port 冲突&lt;/li&gt;
&lt;li&gt;PodSelectorMatches：过滤掉和 Pod 指定的 label 不匹配的节点&lt;/li&gt;
&lt;li&gt;NoDiskConflict：已经 mount 的 volume 和 Pod 指定的 volume 不冲突，除非它们都是只读的&lt;/li&gt;
&lt;li&gt;CheckNodeDiskPressure：检查节点磁盘空间是否符合要求&lt;/li&gt;
&lt;li&gt;CheckNodeMemoryPressure：检查节点内存是否够用&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;除了这些过滤算法之外，还有一些其他的算法，更多更详细的我们可以查看源码文件：k8s.io/kubernetes/pkg/scheduler/algorithm/predicates/predicates.go。&lt;/p&gt;
&lt;p&gt;而&lt;code&gt;Priorities&lt;/code&gt;优先级是由一系列键值对组成的，键是该优先级的名称，值是它的权重值，同样，我们这里给大家列举几个具有代表性的选项：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;LeastRequestedPriority：通过计算 CPU 和内存的使用率来决定权重，使用率越低权重越高，当然正常肯定也是资源是使用率越低权重越高，能给别的 Pod 运行的可能性就越大&lt;/li&gt;
&lt;li&gt;SelectorSpreadPriority：为了更好的高可用，对同属于一个 Deployment 或者 RC 下面的多个 Pod 副本，尽量调度到多个不同的节点上，当一个 Pod 被调度的时候，会先去查找该 Pod 对应的 controller，然后查看该 controller 下面的已存在的 Pod，运行 Pod 越少的节点权重越高&lt;/li&gt;
&lt;li&gt;ImageLocalityPriority：就是如果在某个节点上已经有要使用的镜像节点了，镜像总大小值越大，权重就越高&lt;/li&gt;
&lt;li&gt;NodeAffinityPriority：这个就是根据节点的亲和性来计算一个权重值，后面我们会详细讲解亲和性的使用方法&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;除了这些策略之外，还有很多其他的策略，同样我们可以查看源码文件：k8s.io/kubernetes/pkg/scheduler/algorithm/priorities/ 了解更多信息。每一个优先级函数会返回一个0-10的分数，分数越高表示节点越优，同时每一个函数也会对应一个表示权重的值。最终主机的得分用以下公式计算得出：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;finalScoreNode = (weight1 * priorityFunc1) + (weight2 * priorityFunc2) + … + (weightn * priorityFuncn)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;自定义调度&quot;&gt;&lt;a href=&quot;#自定义调度&quot; class=&quot;headerlink&quot; title=&quot;自定义调度&quot;&gt;&lt;/a&gt;自定义调度&lt;/h3&gt;&lt;p&gt;上面就是 kube-scheduler 默认调度的基本流程，除了使用默认的调度器之外，我们也可以自定义调度策略。&lt;/p&gt;
&lt;h4 id=&quot;调度器扩展&quot;&gt;&lt;a href=&quot;#调度器扩展&quot; class=&quot;headerlink&quot; title=&quot;调度器扩展&quot;&gt;&lt;/a&gt;调度器扩展&lt;/h4&gt;&lt;p&gt;&lt;code&gt;kube-scheduler&lt;/code&gt;在启动的时候可以通过 &lt;code&gt;--policy-config-file&lt;/code&gt;参数来指定调度策略文件，我们可以根据我们自己的需要来组装&lt;code&gt;Predicates&lt;/code&gt;和&lt;code&gt;Priority&lt;/code&gt;函数。选择不同的过滤函数和优先级函数、控制优先级函数的权重、调整过滤函数的顺序都会影响调度过程。&lt;/p&gt;
&lt;p&gt;下面是官方的 Policy 文件示例：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;kind&quot;&lt;/span&gt; : &lt;span class=&quot;string&quot;&gt;&quot;Policy&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;apiVersion&quot;&lt;/span&gt; : &lt;span class=&quot;string&quot;&gt;&quot;v1&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;predicates&quot;&lt;/span&gt; : [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;string&quot;&gt;&quot;PodFitsHostPorts&quot;&lt;/span&gt;&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;string&quot;&gt;&quot;PodFitsResources&quot;&lt;/span&gt;&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;string&quot;&gt;&quot;NoDiskConflict&quot;&lt;/span&gt;&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;string&quot;&gt;&quot;NoVolumeZoneConflict&quot;&lt;/span&gt;&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;string&quot;&gt;&quot;MatchNodeSelector&quot;&lt;/span&gt;&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;string&quot;&gt;&quot;HostName&quot;&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ],&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;priorities&quot;&lt;/span&gt; : [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;string&quot;&gt;&quot;LeastRequestedPriority&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;weight&quot;&lt;/span&gt; : 1&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;string&quot;&gt;&quot;BalancedResourceAllocation&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;weight&quot;&lt;/span&gt; : 1&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;string&quot;&gt;&quot;ServiceSpreadingPriority&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;weight&quot;&lt;/span&gt; : 1&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;string&quot;&gt;&quot;EqualPriority&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;weight&quot;&lt;/span&gt; : 1&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;多调度器&quot;&gt;&lt;a href=&quot;#多调度器&quot; class=&quot;headerlink&quot; title=&quot;多调度器&quot;&gt;&lt;/a&gt;多调度器&lt;/h4&gt;&lt;p&gt;如果默认的调度器不满足要求，还可以部署自定义的调度器。并且，在整个集群中还可以同时运行多个调度器实例，通过&lt;code&gt;podSpec.schedulerName&lt;/code&gt; 来选择使用哪一个调度器（默认使用内置的调度器）。&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    app:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  schedulerName:&lt;/span&gt; my-scheduler  &lt;span class=&quot;comment&quot;&gt;# 选择使用自定义调度器 my-scheduler&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    image:&lt;/span&gt; nginx:&lt;span class=&quot;number&quot;&gt;1.10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;要开发我们自己的调度器也是比较容易的，比如我们这里的 my-scheduler:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;首先需要通过指定的 API 获取节点和 Pod&lt;/li&gt;
&lt;li&gt;然后选择&lt;code&gt;phase=Pending&lt;/code&gt;和&lt;code&gt;schedulerName=my-scheduler&lt;/code&gt;的pod&lt;/li&gt;
&lt;li&gt;计算每个 Pod 需要放置的位置之后，调度程序将创建一个&lt;code&gt;Binding&lt;/code&gt;对象&lt;/li&gt;
&lt;li&gt;然后根据我们自定义的调度器的算法计算出最适合的目标节点&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;优先级调度&quot;&gt;&lt;a href=&quot;#优先级调度&quot; class=&quot;headerlink&quot; title=&quot;优先级调度&quot;&gt;&lt;/a&gt;优先级调度&lt;/h4&gt;&lt;p&gt;与前面所讲的调度优选策略中的优先级（Priorities）不同，前面所讲的优先级指的是节点优先级，而我们这里所说的优先级 pod priority 指的是 Pod 的优先级，高优先级的 Pod 会优先被调度，或者在资源不足低情况牺牲低优先级的 Pod，以便于重要的 Pod 能够得到资源部署。&lt;/p&gt;
&lt;p&gt;要定义 Pod 优先级，就需要先定义&lt;code&gt;PriorityClass&lt;/code&gt;对象，该对象没有 Namespace 的限制：&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; PriorityClass&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; high-priority&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;value:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1000000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;globalDefault:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;description:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;This priority class should be used for XYZ service pods only.&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;value&lt;/code&gt;为 32 位整数的优先级，该值越大，优先级越高&lt;/li&gt;
&lt;li&gt;&lt;code&gt;globalDefault&lt;/code&gt;用于未配置 PriorityClassName 的 Pod，整个集群中应该只有一个&lt;code&gt;PriorityClass&lt;/code&gt;将其设置为 true&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;然后通过在 Pod 的&lt;code&gt;spec.priorityClassName&lt;/code&gt;中指定已定义的&lt;code&gt;PriorityClass&lt;/code&gt;名称即可：&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    app:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    image:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    imagePullPolicy:&lt;/span&gt; IfNotPresent&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  priorityClassName:&lt;/span&gt; high-priority&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;另外一个值得注意的是当节点没有足够的资源供调度器调度 Pod，导致 Pod 处于 pending 时，抢占（preemption）逻辑就会被触发。&lt;code&gt;Preemption&lt;/code&gt;会尝试从一个节点删除低优先级的 Pod，从而释放资源使高优先级的 Pod 得到节点资源进行部署。&lt;/p&gt;
&lt;p&gt;现在我们通过下面的图再去回顾下 kubernetes 的调度过程是不是就清晰很多了：&lt;br&gt;&lt;img src=&quot;/images/k8s/kube-scheduler-detail.png&quot; alt=&quot;K8s scheduler detail&quot;&gt;&lt;/p&gt;
&lt;p&gt;来源: k8s技术圈&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;kube-scheduler-简介&quot;&gt;&lt;a href=&quot;#kube-scheduler-简介&quot; class=&quot;headerlink&quot; title=&quot;kube-scheduler 简介&quot;&gt;&lt;/a&gt;kube-scheduler 简介&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;kube-scheduler&lt;/code&gt;是 kubernetes 系统的核心组件之一，主要负责整个集群资源的调度功能，根据特定的调度算法和策略，将 Pod 调度到最优的工作节点上面去，从而更加合理、更加充分的利用集群的资源，这也是我们选择使用 kubernetes 一个非常重要的理由。如果一门新的技术不能帮助企业节约成本、提供效率，我相信是很难推进的。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;调度流程&quot;&gt;&lt;a href=&quot;#调度流程&quot; class=&quot;headerlink&quot; title=&quot;调度流程&quot;&gt;&lt;/a&gt;调度流程&lt;/h3&gt;&lt;p&gt;默认情况下，kube-scheduler 提供的默认调度器能够满足我们绝大多数的要求，我们前面和大家接触的示例也基本上用的默认的策略，都可以保证我们的 Pod 可以被分配到资源充足的节点上运行。但是在实际的线上项目中，可能我们自己会比 kubernetes 更加了解我们自己的应用，比如我们希望一个 Pod 只能运行在特定的几个节点上，或者这几个节点只能用来运行特定类型的应用，这就需要我们的调度器能够可控。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;kube-scheduler&lt;/code&gt; 是 kubernetes 的调度器，它的主要作用就是根据特定的调度算法和调度策略将 Pod 调度到合适的 Node 节点上去，是一个独立的二进制程序，启动之后会一直监听 API Server，获取到 PodSpec.NodeName 为空的 Pod，对每个 Pod 都会创建一个 binding。&lt;br&gt;&lt;img src=&quot;/images/k8s/kube-scheduler-structrue.jpg&quot; alt=&quot;K8s scheduler structure&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="调度器" scheme="http://icyxp.github.io/categories/kubernetes/%E8%B0%83%E5%BA%A6%E5%99%A8/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="调度" scheme="http://icyxp.github.io/tags/%E8%B0%83%E5%BA%A6/"/>
    
      <category term="scheduler" scheme="http://icyxp.github.io/tags/scheduler/"/>
    
  </entry>
  
  <entry>
    <title>使用Kubeadm 1.11.x + etcd集群 部署多Master集群</title>
    <link href="http://icyxp.github.io//blog/2018/12/k8s-kubeadm-etcd-ha-1-11-x.html"/>
    <id>http://icyxp.github.io//blog/2018/12/k8s-kubeadm-etcd-ha-1-11-x.html</id>
    <published>2018-12-29T04:00:00.000Z</published>
    <updated>2019-02-15T06:36:22.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;环境介绍&quot;&gt;&lt;a href=&quot;#环境介绍&quot; class=&quot;headerlink&quot; title=&quot;环境介绍&quot;&gt;&lt;/a&gt;环境介绍&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left&quot;&gt;IP&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;Hostname&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;备注&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.183&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy + etcd&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.184&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy + etcd&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.185&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-3&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy + etcd&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.186&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.187&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.100&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;vip&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云使用keepalive+haproxy搭建，公有云使用内部负载均衡器&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;环境初始化&quot;&gt;&lt;a href=&quot;#环境初始化&quot; class=&quot;headerlink&quot; title=&quot;环境初始化&quot;&gt;&lt;/a&gt;环境初始化&lt;/h2&gt;&lt;h3 id=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;a href=&quot;#修改hosts信息，在所有master机器上运行&quot; class=&quot;headerlink&quot; title=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;/a&gt;修改hosts信息，在所有master机器上运行&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/hosts&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.183 master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.184 master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.185 master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-1-机器上执行以下命令：&quot;&gt;&lt;a href=&quot;#在master-1-机器上执行以下命令：&quot; class=&quot;headerlink&quot; title=&quot;在master-1 机器上执行以下命令：&quot;&gt;&lt;/a&gt;在master-1 机器上执行以下命令：&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ssh-keygen -t rsa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;优化所有master-amp-node-节点的机器环境&quot;&gt;&lt;a href=&quot;#优化所有master-amp-node-节点的机器环境&quot; class=&quot;headerlink&quot; title=&quot;优化所有master &amp;amp; node 节点的机器环境&quot;&gt;&lt;/a&gt;优化所有master &amp;amp; node 节点的机器环境&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;在所有master &amp;amp; node 机器上都要执行以下命令&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#################################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装4.18版本内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 由于最新稳定版4.19内核将nf_conntrack_ipv4更名为nf_conntrack，目前的kube-proxy不支持在4.19版本内核下开启ipvs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 详情可以查看：https://github.com/kubernetes/kubernetes/issues/70304&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 对于该问题的修复10月30日刚刚合并到代码主干，所以目前还没有包含此修复的kubernetes版本发出&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 可以选择安装4.18版本内核，或者不开启IPVS&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#################################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# start #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 升级内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm ;yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml -y&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 检查默认内核版本是否大于4.14，否则请调整默认启动参数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;grub2-editenv list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#重启以更换内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;reboot&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 开启ip_vs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; /etc/sysconfig/modules/ipvs.modules &amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ipvs_modules_dir=&lt;span class=&quot;string&quot;&gt;&quot;/usr/lib/modules/\`uname -r\`/kernel/net/netfilter/ipvs&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; \`ls \&lt;span class=&quot;variable&quot;&gt;$ipvs_modules_dir&lt;/span&gt; | sed  -r &lt;span class=&quot;string&quot;&gt;&#39;s#(.*).ko.*#\1#&#39;&lt;/span&gt;\`; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    /sbin/modinfo -F filename \&lt;span class=&quot;variable&quot;&gt;$i&lt;/span&gt;  &amp;amp;&amp;gt; /dev/null&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; [ \$? &lt;span class=&quot;_&quot;&gt;-eq&lt;/span&gt; 0 ]; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        /sbin/modprobe \&lt;span class=&quot;variable&quot;&gt;$i&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;fi&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#检查是否开启了ip_vs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; bash /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; lsmod | grep ip_vs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# end #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 优化内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt;  /etc/sysctl.d/k8s.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.ip_forward = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.bridge.bridge-nf-call-ip6tables = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.bridge.bridge-nf-call-iptables = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.netfilter.nf_conntrack_max=2310720&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.may_detach_mounts = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.inotify.max_user_watches=1048576&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.inotify.max_user_instances = 8192&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.file-max=52706963&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.nr_open=52706963&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vm.swappiness = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vm.panic_on_oom=0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vm.overcommit_memory=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sysctl --system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 执行sysctl报错请参考centos7添加bridge-nf-call-ip6tables出现No such file or directory: https://blog.csdn.net/airuozhaoyang/article/details/40534953&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 优化文件打开数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* soft nofile 65536&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* hard nofile 65536&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* soft nproc 65536&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* hard nproc 65536&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* soft  memlock  unlimited&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* hard memlock  unlimited&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 关闭Selinux/firewalld&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl stop firewalld&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;disable&lt;/span&gt; firewalld&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;setenforce 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot;&lt;/span&gt; /etc/selinux/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 关闭交换分区&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;swapoff &lt;span class=&quot;_&quot;&gt;-a&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yes | cp /etc/fstab /etc/fstab_bak&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat /etc/fstab_bak |grep -v swap &amp;gt; /etc/fstab&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 同步时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install -y ntpdate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ntpdate -u ntp.api.bz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置kubernet yum源&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; /etc/yum.repos.d/kubernetes.repo &amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[kubernetes]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name=Kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;enabled=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgcheck=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;repo_gpgcheck=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装kubernet&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install kubeadm-1.11.5-0 kubelet-1.11.5-0 kubectl-1.11.5-0 --disableexcludes=kubernetes -y&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置docker源&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; /etc/yum.repos.d/docker.repo &amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[docker]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name=Docker Repository&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;baseurl=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/repo/centos7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;enabled=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgcheck=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgkey=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/gpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装docker-engine&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum -y install docker-engine-1.13.1 --disableexcludes=docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置kubelet启动配置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cgroupDriver=$(docker info|grep Cg)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;driver=&lt;span class=&quot;variable&quot;&gt;$&amp;#123;cgroupDriver##*: &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;driver is &lt;span class=&quot;variable&quot;&gt;$&amp;#123;driver&amp;#125;&lt;/span&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[Service]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_NETWORK_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_DNS_ARGS=--cluster-dns=10.96.0.10 --cluster-domain=cluster.local&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_AUTHZ_ARGS=--authorization-mode=Webhook --client-ca-file=/etc/kubernetes/pki/ca.crt&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_CADVISOR_ARGS=--cadvisor-port=0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_CGROUP_ARGS=--cgroup-driver=&lt;span class=&quot;variable&quot;&gt;$&amp;#123;driver&amp;#125;&lt;/span&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_CERTIFICATE_ARGS=--rotate-certificates=true --cert-dir=/var/lib/kubelet/pki&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_EXTRA_ARGS=--system-reserved=cpu=200m,memory=250Mi --kube-reserved=cpu=200m,memory=250Mi --eviction-soft=memory.available&amp;lt;500Mi,nodefs.available&amp;lt;2Gi --eviction-soft-grace-period=memory.available=1m30s,nodefs.available=1m30s --eviction-max-pod-grace-period=120 --eviction-hard=memory.available&amp;lt;500Mi,nodefs.available&amp;lt;1Gi --eviction-minimum-reclaim=memory.available=0Mi,nodefs.available=500Mi,imagefs.available=2Gi --node-status-update-frequency=10s --eviction-pressure-transition-period=30s&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ExecStart=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ExecStart=/usr/bin/kubelet \&lt;span class=&quot;variable&quot;&gt;$KUBELET_KUBECONFIG_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_SYSTEM_PODS_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_NETWORK_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_DNS_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_AUTHZ_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_CADVISOR_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_CGROUP_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_CERTIFICATE_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_EXTRA_ARGS&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;搭建keepalived-haproxy-公有云不需要搭建&quot;&gt;&lt;a href=&quot;#搭建keepalived-haproxy-公有云不需要搭建&quot; class=&quot;headerlink&quot; title=&quot;搭建keepalived + haproxy (公有云不需要搭建)&quot;&gt;&lt;/a&gt;搭建keepalived + haproxy (公有云不需要搭建)&lt;/h2&gt;&lt;h3 id=&quot;在master-1上配置&quot;&gt;&lt;a href=&quot;#在master-1上配置&quot; class=&quot;headerlink&quot; title=&quot;在master-1上配置&quot;&gt;&lt;/a&gt;在master-1上配置&lt;/h3&gt;&lt;h4 id=&quot;keepalived-安装配置&quot;&gt;&lt;a href=&quot;#keepalived-安装配置&quot; class=&quot;headerlink&quot; title=&quot;keepalived 安装配置&quot;&gt;&lt;/a&gt;keepalived 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install -y keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/keepalived/keepalived.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;! Configuration File &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    global_defs &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            root@localhost      &lt;span class=&quot;comment&quot;&gt;#发送邮箱&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email_from keepalived@localhost    &lt;span class=&quot;comment&quot;&gt;#邮箱地址   &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_server 127.0.0.1   &lt;span class=&quot;comment&quot;&gt;#邮件服务器地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_connect_timeout 30 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        router_id node1         &lt;span class=&quot;comment&quot;&gt;#主机名，每个节点不同即可&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;       &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vrrp_instance VI_1 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    state MASTER        &lt;span class=&quot;comment&quot;&gt;#在另一个节点上为BACKUP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    interface eth0      &lt;span class=&quot;comment&quot;&gt;#IP地址漂移到的网卡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_router_id 6 &lt;span class=&quot;comment&quot;&gt;#多个节点必须相同&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    priority 100        &lt;span class=&quot;comment&quot;&gt;#优先级，备用节点的值必须低于主节点的值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    advert_int 1        &lt;span class=&quot;comment&quot;&gt;#通告间隔1秒&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    authentication &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; PASS      &lt;span class=&quot;comment&quot;&gt;#预共享密钥认证&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_pass 571f97b2  &lt;span class=&quot;comment&quot;&gt;#密钥&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_ipaddress &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        172.19.170.100    &lt;span class=&quot;comment&quot;&gt;#VIP地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start keepalived&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;haproxy-安装配置&quot;&gt;&lt;a href=&quot;#haproxy-安装配置&quot; class=&quot;headerlink&quot; title=&quot;haproxy 安装配置&quot;&gt;&lt;/a&gt;haproxy 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install  -y haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/haproxy/haproxy.cfg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;         127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    chroot      /var/lib/haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pidfile     /var/run/haproxy.pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    maxconn     4000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    user        haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    group       haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    daemon&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;defaults&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode                    tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;                     global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    retries                 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout connect         10s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout client          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout server          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;frontend kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; *:8443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    default_backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    balance roundrobin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-1 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-2 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-3 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start haproxy&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-2上配置&quot;&gt;&lt;a href=&quot;#在master-2上配置&quot; class=&quot;headerlink&quot; title=&quot;在master-2上配置&quot;&gt;&lt;/a&gt;在master-2上配置&lt;/h3&gt;&lt;h4 id=&quot;keepalived-安装配置-1&quot;&gt;&lt;a href=&quot;#keepalived-安装配置-1&quot; class=&quot;headerlink&quot; title=&quot;keepalived 安装配置&quot;&gt;&lt;/a&gt;keepalived 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install -y keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/keepalived/keepalived.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;! Configuration File &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    global_defs &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            root@localhost      &lt;span class=&quot;comment&quot;&gt;#发送邮箱&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email_from keepalived@localhost    &lt;span class=&quot;comment&quot;&gt;#邮箱地址   &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_server 127.0.0.1   &lt;span class=&quot;comment&quot;&gt;#邮件服务器地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_connect_timeout 30 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        router_id node2         &lt;span class=&quot;comment&quot;&gt;#主机名，每个节点不同即可&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;       &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vrrp_instance VI_1 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    state BACKUP        &lt;span class=&quot;comment&quot;&gt;#在另一个节点上为BACKUP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    interface eth0      &lt;span class=&quot;comment&quot;&gt;#IP地址漂移到的网卡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_router_id 6 &lt;span class=&quot;comment&quot;&gt;#多个节点必须相同&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    priority 80        &lt;span class=&quot;comment&quot;&gt;#优先级，备用节点的值必须低于主节点的值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    advert_int 1        &lt;span class=&quot;comment&quot;&gt;#通告间隔1秒&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    authentication &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; PASS      &lt;span class=&quot;comment&quot;&gt;#预共享密钥认证&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_pass 571f97b2  &lt;span class=&quot;comment&quot;&gt;#密钥&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_ipaddress &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        172.19.170.100    &lt;span class=&quot;comment&quot;&gt;#VIP地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start keepalived&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;haproxy-安装配置-1&quot;&gt;&lt;a href=&quot;#haproxy-安装配置-1&quot; class=&quot;headerlink&quot; title=&quot;haproxy 安装配置&quot;&gt;&lt;/a&gt;haproxy 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install  -y haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/haproxy/haproxy.cfg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;         127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    chroot      /var/lib/haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pidfile     /var/run/haproxy.pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    maxconn     4000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    user        haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    group       haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    daemon&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;defaults&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode                    tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;                     global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    retries                 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout connect         10s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout client          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout server          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;frontend kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; *:8443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    default_backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    balance roundrobin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-1 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-2 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-3 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start haproxy&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-3上配置&quot;&gt;&lt;a href=&quot;#在master-3上配置&quot; class=&quot;headerlink&quot; title=&quot;在master-3上配置&quot;&gt;&lt;/a&gt;在master-3上配置&lt;/h3&gt;&lt;h4 id=&quot;keepalived-安装配置-2&quot;&gt;&lt;a href=&quot;#keepalived-安装配置-2&quot; class=&quot;headerlink&quot; title=&quot;keepalived 安装配置&quot;&gt;&lt;/a&gt;keepalived 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install -y keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/keepalived/keepalived.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;! Configuration File &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    global_defs &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            root@localhost      &lt;span class=&quot;comment&quot;&gt;#发送邮箱&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email_from keepalived@localhost    &lt;span class=&quot;comment&quot;&gt;#邮箱地址   &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_server 127.0.0.1   &lt;span class=&quot;comment&quot;&gt;#邮件服务器地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_connect_timeout 30 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        router_id node3         &lt;span class=&quot;comment&quot;&gt;#主机名，每个节点不同即可&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;       &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vrrp_instance VI_1 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    state BACKUP        &lt;span class=&quot;comment&quot;&gt;#在另一个节点上为BACKUP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    interface eth0      &lt;span class=&quot;comment&quot;&gt;#IP地址漂移到的网卡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_router_id 6 &lt;span class=&quot;comment&quot;&gt;#多个节点必须相同&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    priority 80        &lt;span class=&quot;comment&quot;&gt;#优先级，备用节点的值必须低于主节点的值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    advert_int 1        &lt;span class=&quot;comment&quot;&gt;#通告间隔1秒&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    authentication &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; PASS      &lt;span class=&quot;comment&quot;&gt;#预共享密钥认证&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_pass 571f97b2  &lt;span class=&quot;comment&quot;&gt;#密钥&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_ipaddress &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        172.19.170.100    &lt;span class=&quot;comment&quot;&gt;#VIP地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start keepalived&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;haproxy-安装配置-2&quot;&gt;&lt;a href=&quot;#haproxy-安装配置-2&quot; class=&quot;headerlink&quot; title=&quot;haproxy 安装配置&quot;&gt;&lt;/a&gt;haproxy 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install  -y haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/haproxy/haproxy.cfg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;         127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    chroot      /var/lib/haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pidfile     /var/run/haproxy.pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    maxconn     4000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    user        haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    group       haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    daemon&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;defaults&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode                    tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;                     global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    retries                 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout connect         10s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout client          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout server          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;frontend kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; *:8443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    default_backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    balance roundrobin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-1 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-2 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-3 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start haproxy&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;搭建etcd&quot;&gt;&lt;a href=&quot;#搭建etcd&quot; class=&quot;headerlink&quot; title=&quot;搭建etcd&quot;&gt;&lt;/a&gt;搭建etcd&lt;/h2&gt;&lt;h3 id=&quot;在master-1上执行&quot;&gt;&lt;a href=&quot;#在master-1上执行&quot; class=&quot;headerlink&quot; title=&quot;在master-1上执行&quot;&gt;&lt;/a&gt;在master-1上执行&lt;/h3&gt;&lt;h4 id=&quot;安装cfssl&quot;&gt;&lt;a href=&quot;#安装cfssl&quot; class=&quot;headerlink&quot; title=&quot;安装cfssl&quot;&gt;&lt;/a&gt;安装cfssl&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;wget -O /bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;wget -O /bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;wget -O /bin/cfssl-certinfo  https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; cfssl &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; `ls /bin/cfssl*`;&lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; chmod +x &lt;span class=&quot;variable&quot;&gt;$cfssl&lt;/span&gt;;&lt;span class=&quot;keyword&quot;&gt;done&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;配置生成etcd-证书&quot;&gt;&lt;a href=&quot;#配置生成etcd-证书&quot; class=&quot;headerlink&quot; title=&quot;配置生成etcd 证书&quot;&gt;&lt;/a&gt;配置生成etcd 证书&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 配置证书&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mkdir -pv &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/ssl &amp;amp;&amp;amp; &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/ssl&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; ca-config.json &amp;lt;&amp;lt; EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;&quot;signing&quot;&lt;/span&gt;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;default&quot;&lt;/span&gt;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;expiry&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;87600h&quot;&lt;/span&gt; //10年&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;profiles&quot;&lt;/span&gt;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;kubernetes&quot;&lt;/span&gt;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;usages&quot;&lt;/span&gt;: [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;signing&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;key encipherment&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;server auth&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;client auth&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ],&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;expiry&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;87600h&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; etcd-ca-csr.json &amp;lt;&amp;lt; EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;&quot;CN&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;etcd&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;&quot;key&quot;&lt;/span&gt;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;algo&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;rsa&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;size&quot;&lt;/span&gt;: 2048&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;string&quot;&gt;&quot;names&quot;&lt;/span&gt;: [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;C&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;CN&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;ST&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;JiangSu&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;L&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;SuZhou&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;O&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;etcd&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;OU&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;Etcd Security&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; etcd-csr.json &amp;lt;&amp;lt; EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;CN&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;etcd&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;hosts&quot;&lt;/span&gt;: [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;172.19.170.183&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;172.19.170.184&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;172.19.170.185&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ],&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;key&quot;&lt;/span&gt;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;algo&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;rsa&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;size&quot;&lt;/span&gt;: 2048&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;names&quot;&lt;/span&gt;: [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;C&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;CN&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;ST&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;JiangSu&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;L&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;SuZhou&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;O&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;etcd&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;OU&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;Etcd Security&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 生成证书并复制证书至其他etcd节点&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare etcd-ca&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cfssl gencert -ca=etcd-ca.pem -ca-key=etcd-ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 移动证书&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mkdir -pv /etc/etcd/ssl&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cp etcd*.pem /etc/etcd/ssl&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 将证书拷贝到其它节点&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp -r /etc/etcd master-2:/etc/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp -r /etc/etcd master-3:/etc/&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;安装配置etcd&quot;&gt;&lt;a href=&quot;#安装配置etcd&quot; class=&quot;headerlink&quot; title=&quot;安装配置etcd&quot;&gt;&lt;/a&gt;安装配置etcd&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install -y etcd &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/etcd/etcd.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_DATA_DIR=&lt;span class=&quot;string&quot;&gt;&quot;/var/lib/etcd/default.etcd&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_LISTEN_PEER_URLS=&lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.183:2380&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_LISTEN_CLIENT_URLS=&lt;span class=&quot;string&quot;&gt;&quot;https://127.0.0.1:2379,https://172.19.170.183:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_NAME=&lt;span class=&quot;string&quot;&gt;&quot;etcd1&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_INITIAL_ADVERTISE_PEER_URLS=&lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.183:2380&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_ADVERTISE_CLIENT_URLS=&lt;span class=&quot;string&quot;&gt;&quot;https://127.0.0.1:2379,https://172.19.170.183:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_INITIAL_CLUSTER=&lt;span class=&quot;string&quot;&gt;&quot;etcd1=https://172.19.170.183:2380,etcd2=https://172.19.170.184:2380,etcd3=https://172.19.170.185:2380&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_INITIAL_CLUSTER_TOKEN=&lt;span class=&quot;string&quot;&gt;&quot;BigBoss&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_INITIAL_CLUSTER_STATE=&lt;span class=&quot;string&quot;&gt;&quot;new&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;#这里要设置为new&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_CERT_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_KEY_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd-key.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_TRUSTED_CA_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd-ca.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_PEER_CERT_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_PEER_KEY_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd-key.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_PEER_TRUSTED_CA_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd-ca.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;chown -R etcd.etcd /etc/etcd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; etcd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#启动会卡住，等待其它节点的加入&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start etcd&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-2-上执行&quot;&gt;&lt;a href=&quot;#在master-2-上执行&quot; class=&quot;headerlink&quot; title=&quot;在master-2 上执行&quot;&gt;&lt;/a&gt;在master-2 上执行&lt;/h3&gt;&lt;h4 id=&quot;安装配置etcd-1&quot;&gt;&lt;a href=&quot;#安装配置etcd-1&quot; class=&quot;headerlink&quot; title=&quot;安装配置etcd&quot;&gt;&lt;/a&gt;安装配置etcd&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install -y etcd &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/etcd/etcd.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_DATA_DIR=&lt;span class=&quot;string&quot;&gt;&quot;/var/lib/etcd/default.etcd&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_LISTEN_PEER_URLS=&lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.184:2380&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_LISTEN_CLIENT_URLS=&lt;span class=&quot;string&quot;&gt;&quot;https://127.0.0.1:2379,https://172.19.170.184:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_NAME=&lt;span class=&quot;string&quot;&gt;&quot;etcd2&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_INITIAL_ADVERTISE_PEER_URLS=&lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.184:2380&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_ADVERTISE_CLIENT_URLS=&lt;span class=&quot;string&quot;&gt;&quot;https://127.0.0.1:2379,https://172.19.170.184:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_INITIAL_CLUSTER=&lt;span class=&quot;string&quot;&gt;&quot;etcd1=https://172.19.170.183:2380,etcd2=https://172.19.170.184:2380,etcd3=https://172.19.170.185:2380&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_INITIAL_CLUSTER_TOKEN=&lt;span class=&quot;string&quot;&gt;&quot;BigBoss&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_INITIAL_CLUSTER_STATE=&lt;span class=&quot;string&quot;&gt;&quot;existing&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;#如果etcd 启动报错，可先把这行注释掉，然后在启动&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_CERT_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_KEY_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd-key.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_TRUSTED_CA_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd-ca.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_PEER_CERT_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_PEER_KEY_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd-key.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_PEER_TRUSTED_CA_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd-ca.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;chown -R etcd.etcd /etc/etcd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; etcd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start etcd&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-3-上执行&quot;&gt;&lt;a href=&quot;#在master-3-上执行&quot; class=&quot;headerlink&quot; title=&quot;在master-3 上执行&quot;&gt;&lt;/a&gt;在master-3 上执行&lt;/h3&gt;&lt;h4 id=&quot;安装配置etcd-2&quot;&gt;&lt;a href=&quot;#安装配置etcd-2&quot; class=&quot;headerlink&quot; title=&quot;安装配置etcd&quot;&gt;&lt;/a&gt;安装配置etcd&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/etcd/etcd.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_DATA_DIR=&lt;span class=&quot;string&quot;&gt;&quot;/var/lib/etcd/default.etcd&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_LISTEN_PEER_URLS=&lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.185:2380&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_LISTEN_CLIENT_URLS=&lt;span class=&quot;string&quot;&gt;&quot;https://127.0.0.1:2379,https://172.19.170.185:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_NAME=&lt;span class=&quot;string&quot;&gt;&quot;etcd3&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_INITIAL_ADVERTISE_PEER_URLS=&lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.185:2380&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_ADVERTISE_CLIENT_URLS=&lt;span class=&quot;string&quot;&gt;&quot;https://127.0.0.1:2379,https://172.19.170.185:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_INITIAL_CLUSTER=&lt;span class=&quot;string&quot;&gt;&quot;etcd1=https://172.19.170.183:2380,etcd2=https://172.19.170.184:2380,etcd3=https://172.19.170.185:2380&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_INITIAL_CLUSTER_TOKEN=&lt;span class=&quot;string&quot;&gt;&quot;BigBoss&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_INITIAL_CLUSTER_STATE=&lt;span class=&quot;string&quot;&gt;&quot;existing&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_CERT_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_KEY_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd-key.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_TRUSTED_CA_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd-ca.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_PEER_CERT_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_PEER_KEY_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd-key.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ETCD_PEER_TRUSTED_CA_FILE=&lt;span class=&quot;string&quot;&gt;&quot;/etc/etcd/ssl/etcd-ca.pem&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;chown -R etcd.etcd /etc/etcd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; etcd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start etcd&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;etcd-集群验证&quot;&gt;&lt;a href=&quot;#etcd-集群验证&quot; class=&quot;headerlink&quot; title=&quot;etcd 集群验证&quot;&gt;&lt;/a&gt;etcd 集群验证&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;随意在任何一台etcd (master) 节点上进行验证&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;etcdctl --endpoints &lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.183:2379,https://172.19.170.184:2379,https://172.19.170.185:2379&quot;&lt;/span&gt;   --ca-file=/etc/etcd/ssl/etcd-ca.pem  \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--cert-file=/etc/etcd/ssl/etcd.pem   --key-file=/etc/etcd/ssl/etcd-key.pem   cluster-health&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;搭建kubernetes-master-集群&quot;&gt;&lt;a href=&quot;#搭建kubernetes-master-集群&quot; class=&quot;headerlink&quot; title=&quot;搭建kubernetes master 集群&quot;&gt;&lt;/a&gt;搭建kubernetes master 集群&lt;/h2&gt;&lt;h3 id=&quot;初始化master-1&quot;&gt;&lt;a href=&quot;#初始化master-1&quot; class=&quot;headerlink&quot; title=&quot;初始化master-1&quot;&gt;&lt;/a&gt;初始化master-1&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt; &lt;code&gt;在master-1 上执行&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;token=$(kubeadm token generate)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;variable&quot;&gt;$token&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-1.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1alpha2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: MasterConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubernetesVersion: v1.11.5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;api:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  advertiseAddress: 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt;Port: 6443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  controlPlaneEndpoint: 172.19.170.100:8443    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiServerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 127.0.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeProxy:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  config:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode: iptables&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;etcd:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  external:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    endpoints:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - &lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.183:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - &lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.184:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - &lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.185:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    caFile: /etc/etcd/ssl/etcd-ca.pem&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    certFile: /etc/etcd/ssl/etcd.pem&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    keyFile: /etc/etcd/ssl/etcd-key.pem&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;token: &lt;span class=&quot;variable&quot;&gt;$token&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;tokenTTL: &lt;span class=&quot;string&quot;&gt;&quot;0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;networking:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  podSubnet: 192.168.0.0/16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm config images pull --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-1.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm init --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-1.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mkdir -p &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/.kube&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cp &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; /etc/kubernetes/admin.conf &lt;span class=&quot;variable&quot;&gt;$&amp;#123;HOME&amp;#125;&lt;/span&gt;/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 查看etcd是否启动，等待返回Running 说明启动成功&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl get pods -n kube-system 2&amp;gt;&amp;amp;1|grep etcd|awk &lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;print $3&amp;#125;&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置其他master&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh master-2 &lt;span class=&quot;string&quot;&gt;&quot;mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh master-3 &lt;span class=&quot;string&quot;&gt;&quot;mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 拷贝文件至 master-2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.crt master-2:/etc/kubernetes/pki/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.key master-2:/etc/kubernetes/pki/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.key master-2:/etc/kubernetes/pki/sa.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.pub master-2:/etc/kubernetes/pki/sa.pub&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.crt master-2:/etc/kubernetes/pki/front-proxy-ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.key master-2:/etc/kubernetes/pki/front-proxy-ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-2:/etc/kubernetes/admin.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-2:~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#拷贝文件至 master-3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.crt master-3:/etc/kubernetes/pki/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.key master-3:/etc/kubernetes/pki/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.key master-3:/etc/kubernetes/pki/sa.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.pub master-3:/etc/kubernetes/pki/sa.pub&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.crt master-3:/etc/kubernetes/pki/front-proxy-ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.key master-3:/etc/kubernetes/pki/front-proxy-ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-3:/etc/kubernetes/admin.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-3:~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;初始化master-2&quot;&gt;&lt;a href=&quot;#初始化master-2&quot; class=&quot;headerlink&quot; title=&quot;初始化master-2&quot;&gt;&lt;/a&gt;初始化master-2&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt; &lt;code&gt;在master-2 上执行&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1alpha2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: MasterConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubernetesVersion: v1.11.5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;api:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  advertiseAddress: 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt;Port: 6443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  controlPlaneEndpoint: 172.19.170.100:8443 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiServerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 127.0.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeProxy:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  config:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode: iptables&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;etcd:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  external:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    endpoints:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - &lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.183:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - &lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.184:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - &lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.185:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    caFile: /etc/etcd/ssl/etcd-ca.pem&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    certFile: /etc/etcd/ssl/etcd.pem&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    keyFile: /etc/etcd/ssl/etcd-key.pem&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;token: &lt;span class=&quot;variable&quot;&gt;$token&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;tokenTTL: &lt;span class=&quot;string&quot;&gt;&quot;0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;networking:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  podSubnet: 192.168.0.0/16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase certs all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig controller-manager --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig scheduler --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubelet config write-to-disk --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubelet write-env-file --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig kubelet --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase controlplane all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase mark-master --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;初始化master-3&quot;&gt;&lt;a href=&quot;#初始化master-3&quot; class=&quot;headerlink&quot; title=&quot;初始化master-3&quot;&gt;&lt;/a&gt;初始化master-3&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt; &lt;code&gt;在master-3 上执行&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1alpha2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: MasterConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubernetesVersion: v1.11.5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;api:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  advertiseAddress: 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt;Port: 6443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  controlPlaneEndpoint: 172.19.170.100:8443    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiServerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 127.0.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeProxy:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  config:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode: iptables&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;etcd:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  external:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    endpoints:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - &lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.183:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - &lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.184:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - &lt;span class=&quot;string&quot;&gt;&quot;https://172.19.170.185:2379&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    caFile: /etc/etcd/ssl/etcd-ca.pem&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    certFile: /etc/etcd/ssl/etcd.pem&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    keyFile: /etc/etcd/ssl/etcd-key.pem&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;token: &lt;span class=&quot;variable&quot;&gt;$token&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;tokenTTL: &lt;span class=&quot;string&quot;&gt;&quot;0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;networking:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  podSubnet: 192.168.0.0/16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase certs all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig controller-manager --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig scheduler --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubelet config write-to-disk --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubelet write-env-file --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig kubelet --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase controlplane all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase mark-master --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;################## 至此集群搭建完成 #####################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;开启kubernetes-插件&quot;&gt;&lt;a href=&quot;#开启kubernetes-插件&quot; class=&quot;headerlink&quot; title=&quot;开启kubernetes 插件&quot;&gt;&lt;/a&gt;开启kubernetes 插件&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;在随意一台master执行&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;安装calico-网络插件&quot;&gt;&lt;a href=&quot;#安装calico-网络插件&quot; class=&quot;headerlink&quot; title=&quot;安装calico 网络插件&quot;&gt;&lt;/a&gt;安装calico 网络插件&lt;/h3&gt;&lt;p&gt;确保 &lt;code&gt;Kubernetes controller manager (/etc/kubernetes/manifests/kube-controller-manager.yaml)&lt;/code&gt; 设置了以下标志：&lt;code&gt;--cluster-cidr=192.168.0.0/16和--allocate-node-cidrs=true&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;提示：在kubeadm上，您可以传递&lt;code&gt;--pod-network-cidr=192.168.0.0/16&lt;/code&gt; 给kubeadm以设置两个Kubernetes控制器标志。&lt;/p&gt;
&lt;p&gt;在ConfigMap命名中&lt;code&gt;calico-config&lt;/code&gt;，找到&lt;code&gt;typha_service_name&lt;/code&gt;，删除&lt;code&gt;none&lt;/code&gt;值，并替换为&lt;code&gt;calico-typha&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;我们建议每&lt;code&gt;200&lt;/code&gt;个节点至少&lt;code&gt;复制一个副本&lt;/code&gt;，不超过20个副本。在生产中，我们建议至少使用&lt;code&gt;三个副本&lt;/code&gt;来减少滚动升级和故障的影响。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;警告：如果您设置typha_service_name而不增加其默认值为0 Felix的副本计数将尝试连接到Typha，找不到要连接的Typha实例，并且无法启动。&lt;/code&gt;&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; www.jiunile.com/k8s/plugin/1.11.5/calico.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;安装heapster-监控插件&quot;&gt;&lt;a href=&quot;#安装heapster-监控插件&quot; class=&quot;headerlink&quot; title=&quot;安装heapster 监控插件&quot;&gt;&lt;/a&gt;安装heapster 监控插件&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; www.jiunile.com/k8s/plugin/1.11.5/heapster.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;安装dashboard-插件&quot;&gt;&lt;a href=&quot;#安装dashboard-插件&quot; class=&quot;headerlink&quot; title=&quot;安装dashboard 插件&quot;&gt;&lt;/a&gt;安装dashboard 插件&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; www.jiunile.com/k8s/plugin/1.11.5/dashboard.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;获取加入master集群命令&quot;&gt;&lt;a href=&quot;#获取加入master集群命令&quot; class=&quot;headerlink&quot; title=&quot;获取加入master集群命令&quot;&gt;&lt;/a&gt;获取加入master集群命令&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubeadm token create --print-join-command&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;初始化所有kubernetes-node&quot;&gt;&lt;a href=&quot;#初始化所有kubernetes-node&quot; class=&quot;headerlink&quot; title=&quot;初始化所有kubernetes node&quot;&gt;&lt;/a&gt;初始化所有kubernetes node&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 拉取calico网络对应需要的镜像，拉取比教缓慢&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull quay.io/calico/typha:v3.2.4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull quay.io/calico/node:v3.2.4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull quay.io/calico/cni:v3.2.4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 加入集群&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm join 172.19.170.100:8443 --token mrvxeb.mfr1wx6upq5bbwqt --discovery-token-ca-cert-hash sha256:8ee893d8bf69f1f622f55a983f1401a9f2a236ffa9248894cb614c972de47f48&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;可以在master机器上查看对应的node状态&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl get node&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl get pod -n kube-system&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;测试&quot;&gt;&lt;a href=&quot;#测试&quot; class=&quot;headerlink&quot; title=&quot;测试&quot;&gt;&lt;/a&gt;测试&lt;/h2&gt;&lt;h3 id=&quot;测试应用和dns是否正常&quot;&gt;&lt;a href=&quot;#测试应用和dns是否正常&quot; class=&quot;headerlink&quot; title=&quot;测试应用和dns是否正常&quot;&gt;&lt;/a&gt;测试应用和dns是否正常&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;在随意一台master机器上运行&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 部署一个服务&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /root &amp;amp;&amp;amp; mkdir nginx &amp;amp;&amp;amp; &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; nginx.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: Service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  selector:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    app: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt;: NodePort&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ports:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - port: 80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    nodePort: 31000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    name: nginx-port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    targetPort: 80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    protocol: TCP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: apps/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  replicas: 2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  selector:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    matchLabels:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      app: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  template:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      labels:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        app: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      containers:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        image: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ports:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        - containerPort: 80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; nginx.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 创建一个POD来测试DNS解析&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl run curl --image=radial/busyboxplus:curl -i --tty&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nslookup kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Server:    10.96.0.10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Name:      kubernetes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;curl nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 有返回结果表明ok&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl delete deployment curl&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;测试master-amp-Haproxy高可用&quot;&gt;&lt;a href=&quot;#测试master-amp-Haproxy高可用&quot; class=&quot;headerlink&quot; title=&quot;测试master &amp;amp; Haproxy高可用&quot;&gt;&lt;/a&gt;测试master &amp;amp; Haproxy高可用&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#随机关掉一台master机器&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;init 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在别的master机器上执行命令&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl get node&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#NAME      STATUS     ROLES     AGE       VERSION&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#master-1   NotReady   master    1h        v1.11.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#master-2   Ready      master    59m       v1.11.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#master-3   Ready      master    59m       v1.11.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#node-1     Ready      &amp;lt;none&amp;gt;    58m       v1.11.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#node-2     Ready      &amp;lt;none&amp;gt;    58m       v1.11.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#重新创建一个pod，看看是否能创建成功&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl run curl --image=radial/busyboxplus:curl -i --tty&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl delete deployment curl&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;环境介绍&quot;&gt;&lt;a href=&quot;#环境介绍&quot; class=&quot;headerlink&quot; title=&quot;环境介绍&quot;&gt;&lt;/a&gt;环境介绍&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left&quot;&gt;IP&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;Hostname&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;备注&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.183&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy + etcd&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.184&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy + etcd&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.185&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-3&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy + etcd&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.186&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.187&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.100&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;vip&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云使用keepalive+haproxy搭建，公有云使用内部负载均衡器&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;环境初始化&quot;&gt;&lt;a href=&quot;#环境初始化&quot; class=&quot;headerlink&quot; title=&quot;环境初始化&quot;&gt;&lt;/a&gt;环境初始化&lt;/h2&gt;&lt;h3 id=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;a href=&quot;#修改hosts信息，在所有master机器上运行&quot; class=&quot;headerlink&quot; title=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;/a&gt;修改hosts信息，在所有master机器上运行&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/hosts&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.183 master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.184 master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.185 master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-1-机器上执行以下命令：&quot;&gt;&lt;a href=&quot;#在master-1-机器上执行以下命令：&quot; class=&quot;headerlink&quot; title=&quot;在master-1 机器上执行以下命令：&quot;&gt;&lt;/a&gt;在master-1 机器上执行以下命令：&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ssh-keygen -t rsa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="容器云" scheme="http://icyxp.github.io/categories/kubernetes/%E5%AE%B9%E5%99%A8%E4%BA%91/"/>
    
      <category term="kubadm" scheme="http://icyxp.github.io/categories/kubernetes/%E5%AE%B9%E5%99%A8%E4%BA%91/kubadm/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="kubeadm" scheme="http://icyxp.github.io/tags/kubeadm/"/>
    
      <category term="etcd" scheme="http://icyxp.github.io/tags/etcd/"/>
    
      <category term="集群" scheme="http://icyxp.github.io/tags/%E9%9B%86%E7%BE%A4/"/>
    
      <category term="ha" scheme="http://icyxp.github.io/tags/ha/"/>
    
  </entry>
  
  <entry>
    <title>chrome 访问k8s dashboard 出现ssl证书错误</title>
    <link href="http://icyxp.github.io//blog/2018/12/k8s-dashboard-chrome-err.html"/>
    <id>http://icyxp.github.io//blog/2018/12/k8s-dashboard-chrome-err.html</id>
    <published>2018-12-18T14:00:00.000Z</published>
    <updated>2018-12-18T02:14:12.000Z</updated>
    
    <content type="html">&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;最近上了k8s后，给开发提供dashboard访问，发现有不少开发无法使用chrome访问，出现问题的大部分都是使用的windows系统，主要有以下两类问题，这里记录下如何解决&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;ERR-SSL-SERVER-CERT-BAD-FORMAT&quot;&gt;&lt;a href=&quot;#ERR-SSL-SERVER-CERT-BAD-FORMAT&quot; class=&quot;headerlink&quot; title=&quot;ERR_SSL_SERVER_CERT_BAD_FORMAT&quot;&gt;&lt;/a&gt;ERR_SSL_SERVER_CERT_BAD_FORMAT&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;解决方法：重新安装chrome最新版本解决&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;NET-ERR-CERT-INVALID&quot;&gt;&lt;a href=&quot;#NET-ERR-CERT-INVALID&quot; class=&quot;headerlink&quot; title=&quot;NET::ERR_CERT_INVALID&quot;&gt;&lt;/a&gt;NET::ERR_CERT_INVALID&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/k8s/chrome_err.png&quot; alt=&quot;NET::ERR_CERT_INVALID&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;解决方法：创建chrome桌面快捷方式，然后到桌面：右键chrome–&amp;gt;属性–&amp;gt;在目标后面添加如下：&lt;code&gt;--disable-infobars --ignore-certificate-errors&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;示例：&lt;code&gt;&amp;quot;C:\Program Files (x86)\Google\Chrome\Application\chrome.exe&amp;quot; --disable-infobars --ignore-certificate-errors&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;最近上了k8s后，给开发提供dashboard访问，发现有不少开发无法使用chrome访问，出现问题的大部分都是使
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="容器云" scheme="http://icyxp.github.io/categories/kubernetes/%E5%AE%B9%E5%99%A8%E4%BA%91/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="chrome" scheme="http://icyxp.github.io/tags/chrome/"/>
    
      <category term="ssl" scheme="http://icyxp.github.io/tags/ssl/"/>
    
  </entry>
  
  <entry>
    <title>使用Kubeadm 1.12.x 部署多Master集群</title>
    <link href="http://icyxp.github.io//blog/2018/12/k8s-kubeadm-ha-1-12-x.html"/>
    <id>http://icyxp.github.io//blog/2018/12/k8s-kubeadm-ha-1-12-x.html</id>
    <published>2018-12-18T13:00:00.000Z</published>
    <updated>2019-02-15T06:43:19.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;环境介绍&quot;&gt;&lt;a href=&quot;#环境介绍&quot; class=&quot;headerlink&quot; title=&quot;环境介绍&quot;&gt;&lt;/a&gt;环境介绍&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left&quot;&gt;IP&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;Hostname&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;备注&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.183&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.184&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.185&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-3&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.186&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.187&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.100&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;vip&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云使用keepalive+haproxy搭建，公有云使用内部负载均衡器&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;环境初始化&quot;&gt;&lt;a href=&quot;#环境初始化&quot; class=&quot;headerlink&quot; title=&quot;环境初始化&quot;&gt;&lt;/a&gt;环境初始化&lt;/h2&gt;&lt;h3 id=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;a href=&quot;#修改hosts信息，在所有master机器上运行&quot; class=&quot;headerlink&quot; title=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;/a&gt;修改hosts信息，在所有master机器上运行&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/hosts&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.183 master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.184 master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.185 master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-1-机器上执行以下命令：&quot;&gt;&lt;a href=&quot;#在master-1-机器上执行以下命令：&quot; class=&quot;headerlink&quot; title=&quot;在master-1 机器上执行以下命令：&quot;&gt;&lt;/a&gt;在master-1 机器上执行以下命令：&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ssh-keygen -t rsa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;优化所有master-amp-node-节点的机器环境&quot;&gt;&lt;a href=&quot;#优化所有master-amp-node-节点的机器环境&quot; class=&quot;headerlink&quot; title=&quot;优化所有master &amp;amp; node 节点的机器环境&quot;&gt;&lt;/a&gt;优化所有master &amp;amp; node 节点的机器环境&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;在所有master &amp;amp; node 机器上都要执行以下命令&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#################################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装4.18版本内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 由于最新稳定版4.19内核将nf_conntrack_ipv4更名为nf_conntrack，目前的kube-proxy不支持在4.19版本内核下开启ipvs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 详情可以查看：https://github.com/kubernetes/kubernetes/issues/70304&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 对于该问题的修复10月30日刚刚合并到代码主干，所以目前还没有包含此修复的kubernetes版本发出&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 可以选择安装4.18版本内核，或者不开启IPVS&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#################################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# start #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 升级内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm ;yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml -y&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 检查默认内核版本是否大于4.14，否则请调整默认启动参数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;grub2-editenv list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#重启以更换内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;reboot&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 开启ip_vs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; /etc/sysconfig/modules/ipvs.modules &amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ipvs_modules_dir=&lt;span class=&quot;string&quot;&gt;&quot;/usr/lib/modules/\`uname -r\`/kernel/net/netfilter/ipvs&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; \`ls \&lt;span class=&quot;variable&quot;&gt;$ipvs_modules_dir&lt;/span&gt; | sed  -r &lt;span class=&quot;string&quot;&gt;&#39;s#(.*).ko.*#\1#&#39;&lt;/span&gt;\`; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    /sbin/modinfo -F filename \&lt;span class=&quot;variable&quot;&gt;$i&lt;/span&gt;  &amp;amp;&amp;gt; /dev/null&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; [ \$? &lt;span class=&quot;_&quot;&gt;-eq&lt;/span&gt; 0 ]; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        /sbin/modprobe \&lt;span class=&quot;variable&quot;&gt;$i&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;fi&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#检查是否开启了ip_vs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; bash /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; lsmod | grep ip_vs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# end #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 优化内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt;  /etc/sysctl.d/k8s.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.ip_forward = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.bridge.bridge-nf-call-ip6tables = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.bridge.bridge-nf-call-iptables = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.netfilter.nf_conntrack_max=2310720&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.may_detach_mounts = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.inotify.max_user_watches=1048576&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.inotify.max_user_instances = 8192&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.file-max=52706963&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.nr_open=52706963&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vm.swappiness = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vm.panic_on_oom=0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vm.overcommit_memory=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sysctl --system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 执行sysctl报错请参考centos7添加bridge-nf-call-ip6tables出现No such file or directory: https://blog.csdn.net/airuozhaoyang/article/details/40534953&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 优化文件打开数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* soft nofile 65536&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* hard nofile 65536&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* soft nproc 65536&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* hard nproc 65536&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* soft  memlock  unlimited&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* hard memlock  unlimited&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 关闭Selinux/firewalld&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl stop firewalld&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;disable&lt;/span&gt; firewalld&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;setenforce 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot;&lt;/span&gt; /etc/selinux/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 关闭交换分区&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;swapoff &lt;span class=&quot;_&quot;&gt;-a&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yes | cp /etc/fstab /etc/fstab_bak&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat /etc/fstab_bak |grep -v swap &amp;gt; /etc/fstab&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 同步时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install -y ntpdate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ntpdate -u ntp.api.bz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置kubernet yum源&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; /etc/yum.repos.d/kubernetes.repo &amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[kubernetes]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name=Kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;enabled=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgcheck=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;repo_gpgcheck=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装kubernet&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install kubeadm-1.12.3-0 kubelet-1.12.3-0 kubectl-1.12.3-0 --disableexcludes=kubernetes -y&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置docker源&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; /etc/yum.repos.d/docker.repo &amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[docker]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name=Docker Repository&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;baseurl=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/repo/centos7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;enabled=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgcheck=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgkey=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/gpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装docker-engine&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum -y install docker-engine-1.13.1 --disableexcludes=docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置kubelet启动配置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cgroupDriver=$(docker info|grep Cg)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;driver=&lt;span class=&quot;variable&quot;&gt;$&amp;#123;cgroupDriver##*: &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;driver is &lt;span class=&quot;variable&quot;&gt;$&amp;#123;driver&amp;#125;&lt;/span&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[Service]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_NETWORK_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_DNS_ARGS=--cluster-dns=10.96.0.10 --cluster-domain=cluster.local&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_AUTHZ_ARGS=--authorization-mode=Webhook --client-ca-file=/etc/kubernetes/pki/ca.crt&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_CGROUP_ARGS=--cgroup-driver=&lt;span class=&quot;variable&quot;&gt;$&amp;#123;driver&amp;#125;&lt;/span&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_CERTIFICATE_ARGS=--rotate-certificates=true --cert-dir=/var/lib/kubelet/pki&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_EXTRA_ARGS=--system-reserved=cpu=200m,memory=250Mi --kube-reserved=cpu=200m,memory=250Mi --eviction-soft=memory.available&amp;lt;500Mi,nodefs.available&amp;lt;2Gi --eviction-soft-grace-period=memory.available=1m30s,nodefs.available=1m30s --eviction-max-pod-grace-period=120 --eviction-hard=memory.available&amp;lt;500Mi,nodefs.available&amp;lt;1Gi --eviction-minimum-reclaim=memory.available=0Mi,nodefs.available=500Mi,imagefs.available=2Gi --node-status-update-frequency=10s --eviction-pressure-transition-period=30s&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ExecStart=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ExecStart=/usr/bin/kubelet \&lt;span class=&quot;variable&quot;&gt;$KUBELET_KUBECONFIG_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_SYSTEM_PODS_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_NETWORK_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_DNS_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_AUTHZ_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_CGROUP_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_CERTIFICATE_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_EXTRA_ARGS&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;搭建keepalived-haproxy-公有云不需要搭建&quot;&gt;&lt;a href=&quot;#搭建keepalived-haproxy-公有云不需要搭建&quot; class=&quot;headerlink&quot; title=&quot;搭建keepalived + haproxy (公有云不需要搭建)&quot;&gt;&lt;/a&gt;搭建keepalived + haproxy (公有云不需要搭建)&lt;/h2&gt;&lt;h3 id=&quot;在master-1上配置&quot;&gt;&lt;a href=&quot;#在master-1上配置&quot; class=&quot;headerlink&quot; title=&quot;在master-1上配置&quot;&gt;&lt;/a&gt;在master-1上配置&lt;/h3&gt;&lt;h4 id=&quot;keepalived-安装配置&quot;&gt;&lt;a href=&quot;#keepalived-安装配置&quot; class=&quot;headerlink&quot; title=&quot;keepalived 安装配置&quot;&gt;&lt;/a&gt;keepalived 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install -y keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/keepalived/keepalived.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;! Configuration File &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    global_defs &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            root@localhost      &lt;span class=&quot;comment&quot;&gt;#发送邮箱&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email_from keepalived@localhost    &lt;span class=&quot;comment&quot;&gt;#邮箱地址   &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_server 127.0.0.1   &lt;span class=&quot;comment&quot;&gt;#邮件服务器地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_connect_timeout 30 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        router_id node1         &lt;span class=&quot;comment&quot;&gt;#主机名，每个节点不同即可&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;       &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vrrp_instance VI_1 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    state MASTER        &lt;span class=&quot;comment&quot;&gt;#在另一个节点上为BACKUP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    interface eth0      &lt;span class=&quot;comment&quot;&gt;#IP地址漂移到的网卡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_router_id 6 &lt;span class=&quot;comment&quot;&gt;#多个节点必须相同&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    priority 100        &lt;span class=&quot;comment&quot;&gt;#优先级，备用节点的值必须低于主节点的值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    advert_int 1        &lt;span class=&quot;comment&quot;&gt;#通告间隔1秒&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    authentication &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; PASS      &lt;span class=&quot;comment&quot;&gt;#预共享密钥认证&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_pass 571f97b2  &lt;span class=&quot;comment&quot;&gt;#密钥&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_ipaddress &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        172.19.170.100    &lt;span class=&quot;comment&quot;&gt;#VIP地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start keepalived&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;haproxy-安装配置&quot;&gt;&lt;a href=&quot;#haproxy-安装配置&quot; class=&quot;headerlink&quot; title=&quot;haproxy 安装配置&quot;&gt;&lt;/a&gt;haproxy 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install  -y haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/haproxy/haproxy.cfg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;         127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    chroot      /var/lib/haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pidfile     /var/run/haproxy.pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    maxconn     4000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    user        haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    group       haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    daemon&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;defaults&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode                    tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;                     global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    retries                 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout connect         10s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout client          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout server          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;frontend kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; *:8443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    default_backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    balance roundrobin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-1 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-2 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-3 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start haproxy&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-2上配置&quot;&gt;&lt;a href=&quot;#在master-2上配置&quot; class=&quot;headerlink&quot; title=&quot;在master-2上配置&quot;&gt;&lt;/a&gt;在master-2上配置&lt;/h3&gt;&lt;h4 id=&quot;keepalived-安装配置-1&quot;&gt;&lt;a href=&quot;#keepalived-安装配置-1&quot; class=&quot;headerlink&quot; title=&quot;keepalived 安装配置&quot;&gt;&lt;/a&gt;keepalived 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install -y keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/keepalived/keepalived.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;! Configuration File &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    global_defs &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            root@localhost      &lt;span class=&quot;comment&quot;&gt;#发送邮箱&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email_from keepalived@localhost    &lt;span class=&quot;comment&quot;&gt;#邮箱地址   &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_server 127.0.0.1   &lt;span class=&quot;comment&quot;&gt;#邮件服务器地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_connect_timeout 30 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        router_id node2         &lt;span class=&quot;comment&quot;&gt;#主机名，每个节点不同即可&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;       &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vrrp_instance VI_1 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    state BACKUP        &lt;span class=&quot;comment&quot;&gt;#在另一个节点上为BACKUP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    interface eth0      &lt;span class=&quot;comment&quot;&gt;#IP地址漂移到的网卡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_router_id 6 &lt;span class=&quot;comment&quot;&gt;#多个节点必须相同&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    priority 80        &lt;span class=&quot;comment&quot;&gt;#优先级，备用节点的值必须低于主节点的值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    advert_int 1        &lt;span class=&quot;comment&quot;&gt;#通告间隔1秒&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    authentication &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; PASS      &lt;span class=&quot;comment&quot;&gt;#预共享密钥认证&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_pass 571f97b2  &lt;span class=&quot;comment&quot;&gt;#密钥&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_ipaddress &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        172.19.170.100    &lt;span class=&quot;comment&quot;&gt;#VIP地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start keepalived&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;haproxy-安装配置-1&quot;&gt;&lt;a href=&quot;#haproxy-安装配置-1&quot; class=&quot;headerlink&quot; title=&quot;haproxy 安装配置&quot;&gt;&lt;/a&gt;haproxy 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install  -y haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/haproxy/haproxy.cfg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;         127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    chroot      /var/lib/haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pidfile     /var/run/haproxy.pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    maxconn     4000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    user        haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    group       haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    daemon&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;defaults&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode                    tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;                     global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    retries                 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout connect         10s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout client          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout server          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;frontend kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; *:8443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    default_backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    balance roundrobin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-1 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-2 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-3 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start haproxy&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-3上配置&quot;&gt;&lt;a href=&quot;#在master-3上配置&quot; class=&quot;headerlink&quot; title=&quot;在master-3上配置&quot;&gt;&lt;/a&gt;在master-3上配置&lt;/h3&gt;&lt;h4 id=&quot;keepalived-安装配置-2&quot;&gt;&lt;a href=&quot;#keepalived-安装配置-2&quot; class=&quot;headerlink&quot; title=&quot;keepalived 安装配置&quot;&gt;&lt;/a&gt;keepalived 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install -y keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/keepalived/keepalived.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;! Configuration File &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    global_defs &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            root@localhost      &lt;span class=&quot;comment&quot;&gt;#发送邮箱&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email_from keepalived@localhost    &lt;span class=&quot;comment&quot;&gt;#邮箱地址   &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_server 127.0.0.1   &lt;span class=&quot;comment&quot;&gt;#邮件服务器地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_connect_timeout 30 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        router_id node3         &lt;span class=&quot;comment&quot;&gt;#主机名，每个节点不同即可&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;       &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vrrp_instance VI_1 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    state BACKUP        &lt;span class=&quot;comment&quot;&gt;#在另一个节点上为BACKUP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    interface eth0      &lt;span class=&quot;comment&quot;&gt;#IP地址漂移到的网卡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_router_id 6 &lt;span class=&quot;comment&quot;&gt;#多个节点必须相同&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    priority 80        &lt;span class=&quot;comment&quot;&gt;#优先级，备用节点的值必须低于主节点的值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    advert_int 1        &lt;span class=&quot;comment&quot;&gt;#通告间隔1秒&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    authentication &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; PASS      &lt;span class=&quot;comment&quot;&gt;#预共享密钥认证&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_pass 571f97b2  &lt;span class=&quot;comment&quot;&gt;#密钥&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_ipaddress &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        172.19.170.100    &lt;span class=&quot;comment&quot;&gt;#VIP地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start keepalived&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;haproxy-安装配置-2&quot;&gt;&lt;a href=&quot;#haproxy-安装配置-2&quot; class=&quot;headerlink&quot; title=&quot;haproxy 安装配置&quot;&gt;&lt;/a&gt;haproxy 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install  -y haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/haproxy/haproxy.cfg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;         127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    chroot      /var/lib/haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pidfile     /var/run/haproxy.pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    maxconn     4000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    user        haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    group       haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    daemon&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;defaults&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode                    tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;                     global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    retries                 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout connect         10s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout client          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout server          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;frontend kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; *:8443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    default_backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    balance roundrobin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-1 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-2 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-3 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start haproxy&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;搭建kubernetes-master-集群&quot;&gt;&lt;a href=&quot;#搭建kubernetes-master-集群&quot; class=&quot;headerlink&quot; title=&quot;搭建kubernetes master 集群&quot;&gt;&lt;/a&gt;搭建kubernetes master 集群&lt;/h2&gt;&lt;h3 id=&quot;初始化master-1&quot;&gt;&lt;a href=&quot;#初始化master-1&quot; class=&quot;headerlink&quot; title=&quot;初始化master-1&quot;&gt;&lt;/a&gt;初始化master-1&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt; &lt;code&gt;在master-1 上执行&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-1.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: InitConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1alpha3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1alpha3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: ClusterConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubernetesVersion: v1.12.3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;api:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  advertiseAddress: 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt;Port: 6443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  controlPlaneEndpoint: 172.19.170.100:8443    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiServerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 127.0.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;etcd:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    extraArgs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      listen-client-urls: https://127.0.0.1:2379,https://172.19.170.183:2379&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      advertise-client-urls: https://172.19.170.183:2379&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      listen-peer-urls: https://172.19.170.183:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-advertise-peer-urls: https://172.19.170.183:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-cluster: master-1=https://172.19.170.183:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-cluster-state: new&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    serverCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    peerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;networking:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# This CIDR is a Calico default. Substitute or remove for your CNI provider.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  podSubnet: 192.168.0.0/16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  &lt;span class=&quot;comment&quot;&gt;# image的仓库源 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeproxy.config.k8s.io/v1alpha1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: KubeProxyConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mode: iptables &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm config images pull --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-1.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm init --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-1.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mkdir -p &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/.kube&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cp &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; /etc/kubernetes/admin.conf &lt;span class=&quot;variable&quot;&gt;$&amp;#123;HOME&amp;#125;&lt;/span&gt;/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 查看etcd是否启动，等待返回Running 说明启动成功&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl get pods -n kube-system 2&amp;gt;&amp;amp;1|grep etcd|awk &lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;print $3&amp;#125;&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置其他master&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh master-2 &lt;span class=&quot;string&quot;&gt;&quot;mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh master-3 &lt;span class=&quot;string&quot;&gt;&quot;mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 拷贝文件至 master-2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.crt master-2:/etc/kubernetes/pki/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.key master-2:/etc/kubernetes/pki/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.key master-2:/etc/kubernetes/pki/sa.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.pub master-2:/etc/kubernetes/pki/sa.pub&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.crt master-2:/etc/kubernetes/pki/front-proxy-ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.key master-2:/etc/kubernetes/pki/front-proxy-ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/etcd/ca.crt master-2:/etc/kubernetes/pki/etcd/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/etcd/ca.key master-2:/etc/kubernetes/pki/etcd/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-2:/etc/kubernetes/admin.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-2:~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#拷贝文件至 master-3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.crt master-3:/etc/kubernetes/pki/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.key master-3:/etc/kubernetes/pki/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.key master-3:/etc/kubernetes/pki/sa.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.pub master-3:/etc/kubernetes/pki/sa.pub&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.crt master-3:/etc/kubernetes/pki/front-proxy-ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.key master-3:/etc/kubernetes/pki/front-proxy-ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/etcd/ca.crt master-3:/etc/kubernetes/pki/etcd/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/etcd/ca.key master-3:/etc/kubernetes/pki/etcd/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-3:/etc/kubernetes/admin.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-3:~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;初始化master-2&quot;&gt;&lt;a href=&quot;#初始化master-2&quot; class=&quot;headerlink&quot; title=&quot;初始化master-2&quot;&gt;&lt;/a&gt;初始化master-2&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt; &lt;code&gt;在master-2 上执行&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: InitConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1alpha3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1alpha3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: ClusterConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubernetesVersion: v1.12.3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;api:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  advertiseAddress: 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt;Port: 6443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  controlPlaneEndpoint: 172.19.170.100:8443 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiServerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 127.0.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;etcd:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    extraArgs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      listen-client-urls: https://127.0.0.1:2379,https://172.19.170.184:2379&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      advertise-client-urls: https://172.19.170.184:2379&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      listen-peer-urls: https://172.19.170.184:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-advertise-peer-urls: https://172.19.170.184:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-cluster: master-1=https://172.19.170.183:2380,master-2=https://172.19.170.184:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-cluster-state: existing&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    serverCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    peerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;networking:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# This CIDR is a Calico default. Substitute or remove for your CNI provider.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  podSubnet: 192.168.0.0/16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  &lt;span class=&quot;comment&quot;&gt;# image的仓库源 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeproxy.config.k8s.io/v1alpha1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: KubeProxyConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mode: iptables &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;################## 切换至master-1执行 ##################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-n kube-system etcd-master-1 -- etcdctl \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--ca-file /etc/kubernetes/pki/etcd/ca.crt \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--cert-file /etc/kubernetes/pki/etcd/peer.crt \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--key-file /etc/kubernetes/pki/etcd/peer.key \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--endpoints=https://172.19.170.183:2379 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;member add master-2 https://172.19.170.184:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在master-1 执行后会卡在那边，等待其他的etcd节点加入&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;################## 切换至master-2执行 ##################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase certs all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig controller-manager --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig scheduler --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubelet config write-to-disk --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubelet write-env-file --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig kubelet --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase etcd &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt; --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase controlplane all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase mark-master --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;初始化master-3&quot;&gt;&lt;a href=&quot;#初始化master-3&quot; class=&quot;headerlink&quot; title=&quot;初始化master-3&quot;&gt;&lt;/a&gt;初始化master-3&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt; &lt;code&gt;在master-3 上执行&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: InitConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1alpha3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1alpha3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: ClusterConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubernetesVersion: v1.12.3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;api:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  advertiseAddress: 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt;Port: 6443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  controlPlaneEndpoint: 172.19.170.100:8443    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiServerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 127.0.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;etcd:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    extraArgs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      listen-client-urls: https://127.0.0.1:2379,https://172.19.170.185:2379&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      advertise-client-urls: https://172.19.170.185:2379&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      listen-peer-urls: https://172.19.170.185:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-advertise-peer-urls: https://172.19.170.185:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-cluster: master-1=https://172.19.170.183:2380,master-2=https://172.19.170.184:2380,master-3=https://172.19.170.185:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-cluster-state: existing&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    serverCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    peerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;networking:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# This CIDR is a Calico default. Substitute or remove for your CNI provider.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  podSubnet: 192.168.0.0/16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  &lt;span class=&quot;comment&quot;&gt;# image的仓库源  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeproxy.config.k8s.io/v1alpha1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: KubeProxyConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mode: iptables &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;################## 切换至master-1执行 ##################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-n kube-system etcd-master-1 -- etcdctl \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--ca-file /etc/kubernetes/pki/etcd/ca.crt \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--cert-file /etc/kubernetes/pki/etcd/peer.crt \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--key-file /etc/kubernetes/pki/etcd/peer.key \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--endpoints=https://172.19.170.183:2379 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;member add master-3 https://172.19.170.185:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在master-1 执行后会卡在那边，等待其他的etcd节点加入&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;################## 切换至master-3执行 ##################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase certs all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig controller-manager --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig scheduler --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubelet config write-to-disk --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubelet write-env-file --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig kubelet --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase etcd &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt; --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase controlplane all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase mark-master --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;调整配置，使用vip来进行调度&quot;&gt;&lt;a href=&quot;#调整配置，使用vip来进行调度&quot; class=&quot;headerlink&quot; title=&quot;调整配置，使用vip来进行调度&quot;&gt;&lt;/a&gt;调整配置，使用vip来进行调度&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;在所有master机器上都执行以下命令&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在master-1 上执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/etcd-servers=https:\/\/127.0.0.1:2379/etcd-servers=https:\/\/172.19.170.183:2379,https:\/\/172.19.170.184:2379,https:\/\/172.19.170.185:2379/g&#39;&lt;/span&gt; /etc/kubernetes/manifests/kube-apiserver.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/172.19.170.183:6443/172.19.170.100:8443/g&#39;&lt;/span&gt; ~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/172.19.170.183:6443/172.19.170.100:8443/g&#39;&lt;/span&gt; /etc/kubernetes/kubelet.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在master-2 上执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/etcd-servers=https:\/\/127.0.0.1:2379/etcd-servers=https:\/\/172.19.170.183:2379,https:\/\/172.19.170.184:2379,https:\/\/172.19.170.185:2379/g&#39;&lt;/span&gt; /etc/kubernetes/manifests/kube-apiserver.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/172.19.170.184:6443/172.19.170.100:8443/g&#39;&lt;/span&gt; ~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/172.19.170.184:6443/172.19.170.100:8443/g&#39;&lt;/span&gt; /etc/kubernetes/kubelet.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在master-3 上执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/etcd-servers=https:\/\/127.0.0.1:2379/etcd-servers=https:\/\/172.19.170.183:2379,https:\/\/172.19.170.184:2379,https:\/\/172.19.170.185:2379/g&#39;&lt;/span&gt; /etc/kubernetes/manifests/kube-apiserver.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/172.19.170.185:6443/172.19.170.100:8443/g&#39;&lt;/span&gt; ~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/172.19.170.185:6443/172.19.170.100:8443/g&#39;&lt;/span&gt; /etc/kubernetes/kubelet.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;################## 至此集群搭建完成 #####################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;开启kubernetes-插件&quot;&gt;&lt;a href=&quot;#开启kubernetes-插件&quot; class=&quot;headerlink&quot; title=&quot;开启kubernetes 插件&quot;&gt;&lt;/a&gt;开启kubernetes 插件&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;在随意一台master执行&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;安装calico-网络插件&quot;&gt;&lt;a href=&quot;#安装calico-网络插件&quot; class=&quot;headerlink&quot; title=&quot;安装calico 网络插件&quot;&gt;&lt;/a&gt;安装calico 网络插件&lt;/h3&gt;&lt;p&gt;确保 &lt;code&gt;Kubernetes controller manager (/etc/kubernetes/manifests/kube-controller-manager.yaml)&lt;/code&gt; 设置了以下标志：&lt;code&gt;--cluster-cidr=192.168.0.0/16和--allocate-node-cidrs=true&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;提示：在kubeadm上，您可以传递&lt;code&gt;--pod-network-cidr=192.168.0.0/16&lt;/code&gt; 给kubeadm以设置两个Kubernetes控制器标志。&lt;/p&gt;
&lt;p&gt;在ConfigMap命名中&lt;code&gt;calico-config&lt;/code&gt;，找到&lt;code&gt;typha_service_name&lt;/code&gt;，删除&lt;code&gt;none&lt;/code&gt;值，并替换为&lt;code&gt;calico-typha&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;我们建议每&lt;code&gt;200&lt;/code&gt;个节点至少&lt;code&gt;复制一个副本&lt;/code&gt;，不超过20个副本。在生产中，我们建议至少使用&lt;code&gt;三个副本&lt;/code&gt;来减少滚动升级和故障的影响。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;警告：如果您设置typha_service_name而不增加其默认值为0 Felix的副本计数将尝试连接到Typha，找不到要连接的Typha实例，并且无法启动。&lt;/code&gt;&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; www.jiunile.com/k8s/plugin/1.12.3/calico.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;安装heapster-监控插件&quot;&gt;&lt;a href=&quot;#安装heapster-监控插件&quot; class=&quot;headerlink&quot; title=&quot;安装heapster 监控插件&quot;&gt;&lt;/a&gt;安装heapster 监控插件&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; www.jiunile.com/k8s/plugin/1.12.3/heapster.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;安装dashboard-插件&quot;&gt;&lt;a href=&quot;#安装dashboard-插件&quot; class=&quot;headerlink&quot; title=&quot;安装dashboard 插件&quot;&gt;&lt;/a&gt;安装dashboard 插件&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; www.jiunile.com/k8s/plugin/1.12.3/dashboard.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;获取加入master集群命令&quot;&gt;&lt;a href=&quot;#获取加入master集群命令&quot; class=&quot;headerlink&quot; title=&quot;获取加入master集群命令&quot;&gt;&lt;/a&gt;获取加入master集群命令&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubeadm token create --print-join-command&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;初始化所有kubernetes-node&quot;&gt;&lt;a href=&quot;#初始化所有kubernetes-node&quot; class=&quot;headerlink&quot; title=&quot;初始化所有kubernetes node&quot;&gt;&lt;/a&gt;初始化所有kubernetes node&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 拉取calico网络对应需要的镜像，拉取比教缓慢&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull quay.io/calico/typha:v3.3.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull quay.io/calico/node:v3.3.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull quay.io/calico/cni:v3.3.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 加入集群&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm join 172.19.170.100:8443 --token mrvxeb.mfr1wx6upq5bbwqt --discovery-token-ca-cert-hash sha256:8ee893d8bf69f1f622f55a983f1401a9f2a236ffa9248894cb614c972de47f48&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;可以在master机器上查看对应的node状态&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl get node&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl get pod -n kube-system&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;测试&quot;&gt;&lt;a href=&quot;#测试&quot; class=&quot;headerlink&quot; title=&quot;测试&quot;&gt;&lt;/a&gt;测试&lt;/h2&gt;&lt;h3 id=&quot;测试应用和dns是否正常&quot;&gt;&lt;a href=&quot;#测试应用和dns是否正常&quot; class=&quot;headerlink&quot; title=&quot;测试应用和dns是否正常&quot;&gt;&lt;/a&gt;测试应用和dns是否正常&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;在随意一台master机器上运行&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 部署一个服务&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /root &amp;amp;&amp;amp; mkdir nginx &amp;amp;&amp;amp; &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; nginx.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: Service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  selector:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    app: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt;: NodePort&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ports:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - port: 80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    nodePort: 31000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    name: nginx-port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    targetPort: 80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    protocol: TCP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: apps/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  replicas: 2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  selector:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    matchLabels:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      app: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  template:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      labels:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        app: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      containers:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        image: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ports:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        - containerPort: 80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; nginx.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 创建一个POD来测试DNS解析&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl run curl --image=radial/busyboxplus:curl -i --tty&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nslookup kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Server:    10.96.0.10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Name:      kubernetes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;curl nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 有返回结果表明ok&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl delete deployment curl&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;测试master-amp-Haproxy高可用&quot;&gt;&lt;a href=&quot;#测试master-amp-Haproxy高可用&quot; class=&quot;headerlink&quot; title=&quot;测试master &amp;amp; Haproxy高可用&quot;&gt;&lt;/a&gt;测试master &amp;amp; Haproxy高可用&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#随机关掉一台master机器&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;init 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在别的master机器上执行命令&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl get node&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#NAME      STATUS     ROLES     AGE       VERSION&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#master-1   NotReady   master    1h        v1.12.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#master-2   Ready      master    59m       v1.12.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#master-3   Ready      master    59m       v1.12.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#node-1     Ready      &amp;lt;none&amp;gt;    58m       v1.12.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#node-2     Ready      &amp;lt;none&amp;gt;    58m       v1.12.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#重新创建一个pod，看看是否能创建成功&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl run curl --image=radial/busyboxplus:curl -i --tty&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl delete deployment curl&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;环境介绍&quot;&gt;&lt;a href=&quot;#环境介绍&quot; class=&quot;headerlink&quot; title=&quot;环境介绍&quot;&gt;&lt;/a&gt;环境介绍&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left&quot;&gt;IP&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;Hostname&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;备注&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.183&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.184&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.185&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-3&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.186&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.187&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.100&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;vip&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云使用keepalive+haproxy搭建，公有云使用内部负载均衡器&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;环境初始化&quot;&gt;&lt;a href=&quot;#环境初始化&quot; class=&quot;headerlink&quot; title=&quot;环境初始化&quot;&gt;&lt;/a&gt;环境初始化&lt;/h2&gt;&lt;h3 id=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;a href=&quot;#修改hosts信息，在所有master机器上运行&quot; class=&quot;headerlink&quot; title=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;/a&gt;修改hosts信息，在所有master机器上运行&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/hosts&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.183 master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.184 master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.185 master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-1-机器上执行以下命令：&quot;&gt;&lt;a href=&quot;#在master-1-机器上执行以下命令：&quot; class=&quot;headerlink&quot; title=&quot;在master-1 机器上执行以下命令：&quot;&gt;&lt;/a&gt;在master-1 机器上执行以下命令：&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ssh-keygen -t rsa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="容器云" scheme="http://icyxp.github.io/categories/kubernetes/%E5%AE%B9%E5%99%A8%E4%BA%91/"/>
    
      <category term="kubadm" scheme="http://icyxp.github.io/categories/kubernetes/%E5%AE%B9%E5%99%A8%E4%BA%91/kubadm/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="kubeadm" scheme="http://icyxp.github.io/tags/kubeadm/"/>
    
      <category term="集群" scheme="http://icyxp.github.io/tags/%E9%9B%86%E7%BE%A4/"/>
    
      <category term="ha" scheme="http://icyxp.github.io/tags/ha/"/>
    
  </entry>
  
  <entry>
    <title>使用Kubeadm 1.11.x 部署多Master集群</title>
    <link href="http://icyxp.github.io//blog/2018/12/k8s-kubeadm-ha-1-11-x.html"/>
    <id>http://icyxp.github.io//blog/2018/12/k8s-kubeadm-ha-1-11-x.html</id>
    <published>2018-12-17T13:00:00.000Z</published>
    <updated>2018-12-19T03:30:50.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;环境介绍&quot;&gt;&lt;a href=&quot;#环境介绍&quot; class=&quot;headerlink&quot; title=&quot;环境介绍&quot;&gt;&lt;/a&gt;环境介绍&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left&quot;&gt;IP&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;Hostname&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;备注&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.183&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.184&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.185&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-3&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.186&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.187&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.100&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;vip&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云使用keepalive+haproxy搭建，公有云使用内部负载均衡器&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;环境初始化&quot;&gt;&lt;a href=&quot;#环境初始化&quot; class=&quot;headerlink&quot; title=&quot;环境初始化&quot;&gt;&lt;/a&gt;环境初始化&lt;/h2&gt;&lt;h3 id=&quot;在master-1-机器上执行以下命令：&quot;&gt;&lt;a href=&quot;#在master-1-机器上执行以下命令：&quot; class=&quot;headerlink&quot; title=&quot;在master-1 机器上执行以下命令：&quot;&gt;&lt;/a&gt;在master-1 机器上执行以下命令：&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ssh-keygen -t rsa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;a href=&quot;#修改hosts信息，在所有master机器上运行&quot; class=&quot;headerlink&quot; title=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;/a&gt;修改hosts信息，在所有master机器上运行&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/hosts&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.183 master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.184 master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.185 master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;优化所有master-amp-node-节点的机器环境&quot;&gt;&lt;a href=&quot;#优化所有master-amp-node-节点的机器环境&quot; class=&quot;headerlink&quot; title=&quot;优化所有master &amp;amp; node 节点的机器环境&quot;&gt;&lt;/a&gt;优化所有master &amp;amp; node 节点的机器环境&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;在所有master &amp;amp; node 机器上都要执行以下命令&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#################################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装4.18版本内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 由于最新稳定版4.19内核将nf_conntrack_ipv4更名为nf_conntrack，目前的kube-proxy不支持在4.19版本内核下开启ipvs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 详情可以查看：https://github.com/kubernetes/kubernetes/issues/70304&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 对于该问题的修复10月30日刚刚合并到代码主干，所以目前还没有包含此修复的kubernetes版本发出&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 可以选择安装4.18版本内核，或者不开启IPVS&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#################################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# start #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 升级内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm ;yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml -y&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 检查默认内核版本是否大于4.14，否则请调整默认启动参数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;grub2-editenv list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#重启以更换内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;reboot&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 开启ip_vs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; /etc/sysconfig/modules/ipvs.modules &amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ipvs_modules_dir=&lt;span class=&quot;string&quot;&gt;&quot;/usr/lib/modules/\`uname -r\`/kernel/net/netfilter/ipvs&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; \`ls \&lt;span class=&quot;variable&quot;&gt;$ipvs_modules_dir&lt;/span&gt; | sed  -r &lt;span class=&quot;string&quot;&gt;&#39;s#(.*).ko.*#\1#&#39;&lt;/span&gt;\`; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    /sbin/modinfo -F filename \&lt;span class=&quot;variable&quot;&gt;$i&lt;/span&gt;  &amp;amp;&amp;gt; /dev/null&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; [ \$? &lt;span class=&quot;_&quot;&gt;-eq&lt;/span&gt; 0 ]; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        /sbin/modprobe \&lt;span class=&quot;variable&quot;&gt;$i&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;fi&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#检查是否开启了ip_vs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; bash /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; lsmod | grep ip_vs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# end #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 优化内核&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt;  /etc/sysctl.d/k8s.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.ipv4.ip_forward = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.bridge.bridge-nf-call-ip6tables = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.bridge.bridge-nf-call-iptables = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.netfilter.nf_conntrack_max=2310720&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.may_detach_mounts = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.inotify.max_user_watches=1048576&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.inotify.max_user_instances = 8192&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.file-max=52706963&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fs.nr_open=52706963&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vm.swappiness = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vm.panic_on_oom=0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vm.overcommit_memory=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sysctl --system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 执行sysctl报错请参考centos7添加bridge-nf-call-ip6tables出现No such file or directory: https://blog.csdn.net/airuozhaoyang/article/details/40534953&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 优化文件打开数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* soft nofile 65536&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* hard nofile 65536&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* soft nproc 65536&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* hard nproc 65536&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* soft  memlock  unlimited&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* hard memlock  unlimited&quot;&lt;/span&gt;  &amp;gt;&amp;gt; /etc/security/limits.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 关闭Selinux/firewalld&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl stop firewalld&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;disable&lt;/span&gt; firewalld&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;setenforce 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot;&lt;/span&gt; /etc/selinux/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 关闭交换分区&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;swapoff &lt;span class=&quot;_&quot;&gt;-a&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yes | cp /etc/fstab /etc/fstab_bak&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat /etc/fstab_bak |grep -v swap &amp;gt; /etc/fstab&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 同步时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install -y ntpdate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ntpdate -u ntp.api.bz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置kubernet yum源&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; /etc/yum.repos.d/kubernetes.repo &amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[kubernetes]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name=Kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;enabled=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgcheck=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;repo_gpgcheck=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装kubernet&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install kubeadm-1.11.5-0 kubelet-1.11.5-0 kubectl-1.11.5-0 --disableexcludes=kubernetes -y&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置docker源&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; /etc/yum.repos.d/docker.repo &amp;lt;&amp;lt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[docker]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name=Docker Repository&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;baseurl=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/repo/centos7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;enabled=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgcheck=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgkey=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/gpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装docker-engine&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum -y install docker-engine-1.13.1 --disableexcludes=docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置kubelet启动配置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cgroupDriver=$(docker info|grep Cg)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;driver=&lt;span class=&quot;variable&quot;&gt;$&amp;#123;cgroupDriver##*: &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;driver is &lt;span class=&quot;variable&quot;&gt;$&amp;#123;driver&amp;#125;&lt;/span&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[Service]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_NETWORK_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_DNS_ARGS=--cluster-dns=10.96.0.10 --cluster-domain=cluster.local&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_AUTHZ_ARGS=--authorization-mode=Webhook --client-ca-file=/etc/kubernetes/pki/ca.crt&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_CADVISOR_ARGS=--cadvisor-port=0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_CGROUP_ARGS=--cgroup-driver=&lt;span class=&quot;variable&quot;&gt;$&amp;#123;driver&amp;#125;&lt;/span&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_CERTIFICATE_ARGS=--rotate-certificates=true --cert-dir=/var/lib/kubelet/pki&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_EXTRA_ARGS=--system-reserved=cpu=200m,memory=250Mi --kube-reserved=cpu=200m,memory=250Mi --eviction-soft=memory.available&amp;lt;500Mi,nodefs.available&amp;lt;2Gi --eviction-soft-grace-period=memory.available=1m30s,nodefs.available=1m30s --eviction-max-pod-grace-period=120 --eviction-hard=memory.available&amp;lt;300Mi,nodefs.available&amp;lt;1Gi --eviction-minimum-reclaim=memory.available=0Mi,nodefs.available=500Mi,imagefs.available=2Gi --node-status-update-frequency=10s --eviction-pressure-transition-period=30s&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ExecStart=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ExecStart=/usr/bin/kubelet \&lt;span class=&quot;variable&quot;&gt;$KUBELET_KUBECONFIG_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_SYSTEM_PODS_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_NETWORK_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_DNS_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_AUTHZ_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_CADVISOR_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_CGROUP_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_CERTIFICATE_ARGS&lt;/span&gt; \&lt;span class=&quot;variable&quot;&gt;$KUBELET_EXTRA_ARGS&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;搭建keepalived-haproxy-公有云不需要搭建&quot;&gt;&lt;a href=&quot;#搭建keepalived-haproxy-公有云不需要搭建&quot; class=&quot;headerlink&quot; title=&quot;搭建keepalived + haproxy (公有云不需要搭建)&quot;&gt;&lt;/a&gt;搭建keepalived + haproxy (公有云不需要搭建)&lt;/h2&gt;&lt;h3 id=&quot;在master-1上配置&quot;&gt;&lt;a href=&quot;#在master-1上配置&quot; class=&quot;headerlink&quot; title=&quot;在master-1上配置&quot;&gt;&lt;/a&gt;在master-1上配置&lt;/h3&gt;&lt;h4 id=&quot;keepalived-安装配置&quot;&gt;&lt;a href=&quot;#keepalived-安装配置&quot; class=&quot;headerlink&quot; title=&quot;keepalived 安装配置&quot;&gt;&lt;/a&gt;keepalived 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install -y keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/keepalived/keepalived.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;! Configuration File &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    global_defs &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            root@localhost      &lt;span class=&quot;comment&quot;&gt;#发送邮箱&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email_from keepalived@localhost    &lt;span class=&quot;comment&quot;&gt;#邮箱地址   &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_server 127.0.0.1   &lt;span class=&quot;comment&quot;&gt;#邮件服务器地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_connect_timeout 30 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        router_id node1         &lt;span class=&quot;comment&quot;&gt;#主机名，每个节点不同即可&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;       &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vrrp_instance VI_1 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    state MASTER        &lt;span class=&quot;comment&quot;&gt;#在另一个节点上为BACKUP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    interface eth0      &lt;span class=&quot;comment&quot;&gt;#IP地址漂移到的网卡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_router_id 6 &lt;span class=&quot;comment&quot;&gt;#多个节点必须相同&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    priority 100        &lt;span class=&quot;comment&quot;&gt;#优先级，备用节点的值必须低于主节点的值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    advert_int 1        &lt;span class=&quot;comment&quot;&gt;#通告间隔1秒&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    authentication &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; PASS      &lt;span class=&quot;comment&quot;&gt;#预共享密钥认证&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_pass 571f97b2  &lt;span class=&quot;comment&quot;&gt;#密钥&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_ipaddress &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        172.19.170.100    &lt;span class=&quot;comment&quot;&gt;#VIP地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start keepalived&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;haproxy-安装配置&quot;&gt;&lt;a href=&quot;#haproxy-安装配置&quot; class=&quot;headerlink&quot; title=&quot;haproxy 安装配置&quot;&gt;&lt;/a&gt;haproxy 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install  -y haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/haproxy/haproxy.cfg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;         127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    chroot      /var/lib/haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pidfile     /var/run/haproxy.pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    maxconn     4000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    user        haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    group       haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    daemon&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;defaults&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode                    tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;                     global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    retries                 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout connect         10s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout client          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout server          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;frontend kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; *:8443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    default_backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    balance roundrobin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-1 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-2 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-3 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start haproxy&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-2上配置&quot;&gt;&lt;a href=&quot;#在master-2上配置&quot; class=&quot;headerlink&quot; title=&quot;在master-2上配置&quot;&gt;&lt;/a&gt;在master-2上配置&lt;/h3&gt;&lt;h4 id=&quot;keepalived-安装配置-1&quot;&gt;&lt;a href=&quot;#keepalived-安装配置-1&quot; class=&quot;headerlink&quot; title=&quot;keepalived 安装配置&quot;&gt;&lt;/a&gt;keepalived 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install -y keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/keepalived/keepalived.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;! Configuration File &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    global_defs &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            root@localhost      &lt;span class=&quot;comment&quot;&gt;#发送邮箱&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email_from keepalived@localhost    &lt;span class=&quot;comment&quot;&gt;#邮箱地址   &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_server 127.0.0.1   &lt;span class=&quot;comment&quot;&gt;#邮件服务器地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_connect_timeout 30 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        router_id node2         &lt;span class=&quot;comment&quot;&gt;#主机名，每个节点不同即可&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;       &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vrrp_instance VI_1 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    state BACKUP        &lt;span class=&quot;comment&quot;&gt;#在另一个节点上为BACKUP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    interface eth0      &lt;span class=&quot;comment&quot;&gt;#IP地址漂移到的网卡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_router_id 6 &lt;span class=&quot;comment&quot;&gt;#多个节点必须相同&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    priority 80        &lt;span class=&quot;comment&quot;&gt;#优先级，备用节点的值必须低于主节点的值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    advert_int 1        &lt;span class=&quot;comment&quot;&gt;#通告间隔1秒&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    authentication &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; PASS      &lt;span class=&quot;comment&quot;&gt;#预共享密钥认证&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_pass 571f97b2  &lt;span class=&quot;comment&quot;&gt;#密钥&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_ipaddress &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        172.19.170.100    &lt;span class=&quot;comment&quot;&gt;#VIP地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start keepalived&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;haproxy-安装配置-1&quot;&gt;&lt;a href=&quot;#haproxy-安装配置-1&quot; class=&quot;headerlink&quot; title=&quot;haproxy 安装配置&quot;&gt;&lt;/a&gt;haproxy 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install  -y haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/haproxy/haproxy.cfg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;         127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    chroot      /var/lib/haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pidfile     /var/run/haproxy.pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    maxconn     4000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    user        haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    group       haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    daemon&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;defaults&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode                    tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;                     global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    retries                 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout connect         10s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout client          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout server          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;frontend kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; *:8443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    default_backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    balance roundrobin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-1 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-2 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-3 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start haproxy&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;在master-3上配置&quot;&gt;&lt;a href=&quot;#在master-3上配置&quot; class=&quot;headerlink&quot; title=&quot;在master-3上配置&quot;&gt;&lt;/a&gt;在master-3上配置&lt;/h3&gt;&lt;h4 id=&quot;keepalived-安装配置-2&quot;&gt;&lt;a href=&quot;#keepalived-安装配置-2&quot; class=&quot;headerlink&quot; title=&quot;keepalived 安装配置&quot;&gt;&lt;/a&gt;keepalived 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install -y keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/keepalived/keepalived.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;! Configuration File &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    global_defs &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            root@localhost      &lt;span class=&quot;comment&quot;&gt;#发送邮箱&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        notification_email_from keepalived@localhost    &lt;span class=&quot;comment&quot;&gt;#邮箱地址   &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_server 127.0.0.1   &lt;span class=&quot;comment&quot;&gt;#邮件服务器地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        smtp_connect_timeout 30 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        router_id node3         &lt;span class=&quot;comment&quot;&gt;#主机名，每个节点不同即可&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;       &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vrrp_instance VI_1 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    state BACKUP        &lt;span class=&quot;comment&quot;&gt;#在另一个节点上为BACKUP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    interface eth0      &lt;span class=&quot;comment&quot;&gt;#IP地址漂移到的网卡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_router_id 6 &lt;span class=&quot;comment&quot;&gt;#多个节点必须相同&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    priority 80        &lt;span class=&quot;comment&quot;&gt;#优先级，备用节点的值必须低于主节点的值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    advert_int 1        &lt;span class=&quot;comment&quot;&gt;#通告间隔1秒&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    authentication &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; PASS      &lt;span class=&quot;comment&quot;&gt;#预共享密钥认证&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        auth_pass 571f97b2  &lt;span class=&quot;comment&quot;&gt;#密钥&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    virtual_ipaddress &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        172.19.170.100    &lt;span class=&quot;comment&quot;&gt;#VIP地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; keepalived&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start keepalived&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;haproxy-安装配置-2&quot;&gt;&lt;a href=&quot;#haproxy-安装配置-2&quot; class=&quot;headerlink&quot; title=&quot;haproxy 安装配置&quot;&gt;&lt;/a&gt;haproxy 安装配置&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install  -y haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; /etc/haproxy/haproxy.cfg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;         127.0.0.1 &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    chroot      /var/lib/haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pidfile     /var/run/haproxy.pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    maxconn     4000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    user        haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    group       haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    daemon&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;defaults&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode                    tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;                     global&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    retries                 3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout connect         10s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout client          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timeout server          1m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;frontend kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; *:8443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    default_backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;backend kubernetes-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    balance roundrobin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-1 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-2 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server master-3 172.19.170.183:6443 check maxconn 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; haproxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start haproxy&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;搭建kubernetes-master-集群&quot;&gt;&lt;a href=&quot;#搭建kubernetes-master-集群&quot; class=&quot;headerlink&quot; title=&quot;搭建kubernetes master 集群&quot;&gt;&lt;/a&gt;搭建kubernetes master 集群&lt;/h2&gt;&lt;h3 id=&quot;初始化master-1&quot;&gt;&lt;a href=&quot;#初始化master-1&quot; class=&quot;headerlink&quot; title=&quot;初始化master-1&quot;&gt;&lt;/a&gt;初始化master-1&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt; &lt;code&gt;在master-1 上执行&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-1.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1alpha2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: MasterConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubernetesVersion: v1.11.5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;api:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  advertiseAddress: 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt;Port: 6443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  controlPlaneEndpoint: 172.19.170.100:8443    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiServerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 127.0.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeProxy:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  config:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode: iptables&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;etcd:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    extraArgs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      listen-client-urls: https://127.0.0.1:2379,https://172.19.170.183:2379&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      advertise-client-urls: https://172.19.170.183:2379&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      listen-peer-urls: https://172.19.170.183:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-advertise-peer-urls: https://172.19.170.183:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-cluster: master-1=https://172.19.170.183:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-cluster-state: new&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    serverCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    peerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;networking:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# This CIDR is a Calico default. Substitute or remove for your CNI provider.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  podSubnet: 192.168.0.0/16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  &lt;span class=&quot;comment&quot;&gt;# image的仓库源  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm config images pull --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-1.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm init --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-1.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mkdir -p &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/.kube&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cp &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; /etc/kubernetes/admin.conf &lt;span class=&quot;variable&quot;&gt;$&amp;#123;HOME&amp;#125;&lt;/span&gt;/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 查看etcd是否启动，等待返回Running 说明启动成功&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl get pods -n kube-system 2&amp;gt;&amp;amp;1|grep etcd|awk &lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;print $3&amp;#125;&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 设置其他master&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh master-2 &lt;span class=&quot;string&quot;&gt;&quot;mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh master-3 &lt;span class=&quot;string&quot;&gt;&quot;mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 拷贝文件至 master-2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.crt master-2:/etc/kubernetes/pki/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.key master-2:/etc/kubernetes/pki/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.key master-2:/etc/kubernetes/pki/sa.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.pub master-2:/etc/kubernetes/pki/sa.pub&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.crt master-2:/etc/kubernetes/pki/front-proxy-ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.key master-2:/etc/kubernetes/pki/front-proxy-ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/etcd/ca.crt master-2:/etc/kubernetes/pki/etcd/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/etcd/ca.key master-2:/etc/kubernetes/pki/etcd/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-2:/etc/kubernetes/admin.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-2:~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#拷贝文件至 master-3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.crt master-3:/etc/kubernetes/pki/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/ca.key master-3:/etc/kubernetes/pki/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.key master-3:/etc/kubernetes/pki/sa.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/sa.pub master-3:/etc/kubernetes/pki/sa.pub&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.crt master-3:/etc/kubernetes/pki/front-proxy-ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/front-proxy-ca.key master-3:/etc/kubernetes/pki/front-proxy-ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/etcd/ca.crt master-3:/etc/kubernetes/pki/etcd/ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/pki/etcd/ca.key master-3:/etc/kubernetes/pki/etcd/ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-3:/etc/kubernetes/admin.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scp /etc/kubernetes/admin.conf master-3:~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;初始化master-2&quot;&gt;&lt;a href=&quot;#初始化master-2&quot; class=&quot;headerlink&quot; title=&quot;初始化master-2&quot;&gt;&lt;/a&gt;初始化master-2&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt; &lt;code&gt;在master-2 上执行&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1alpha2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: MasterConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubernetesVersion: v1.11.5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;api:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  advertiseAddress: 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt;Port: 6443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  controlPlaneEndpoint: 172.19.170.100:8443 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiServerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 127.0.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeProxy:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  config:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode: iptables&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;etcd:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    extraArgs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      listen-client-urls: https://127.0.0.1:2379,https://172.19.170.184:2379&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      advertise-client-urls: https://172.19.170.184:2379&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      listen-peer-urls: https://172.19.170.184:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-advertise-peer-urls: https://172.19.170.184:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-cluster: master-1=https://172.19.170.183:2380,master-2=https://172.19.170.184:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-cluster-state: existing&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    serverCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    peerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;networking:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# This CIDR is a Calico default. Substitute or remove for your CNI provider.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  podSubnet: 192.168.0.0/16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  &lt;span class=&quot;comment&quot;&gt;# image的仓库源  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;################## 切换至master-1执行 ##################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-n kube-system etcd-master-1 -- etcdctl \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--ca-file /etc/kubernetes/pki/etcd/ca.crt \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--cert-file /etc/kubernetes/pki/etcd/peer.crt \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--key-file /etc/kubernetes/pki/etcd/peer.key \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--endpoints=https://172.19.170.183:2379 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;member add master-2 https://172.19.170.184:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在master-1 执行后会卡在那边，等待其他的etcd节点加入&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;################## 切换至master-2执行 ##################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase certs all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig controller-manager --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig scheduler --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubelet config write-to-disk --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubelet write-env-file --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig kubelet --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase etcd &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt; --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase controlplane all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase mark-master --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-2.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;初始化master-3&quot;&gt;&lt;a href=&quot;#初始化master-3&quot; class=&quot;headerlink&quot; title=&quot;初始化master-3&quot;&gt;&lt;/a&gt;初始化master-3&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt; &lt;code&gt;在master-3 上执行&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1alpha2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: MasterConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubernetesVersion: v1.11.5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;api:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  advertiseAddress: 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt;Port: 6443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  controlPlaneEndpoint: 172.19.170.100:8443    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiServerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 172.19.170.100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- 127.0.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeProxy:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  config:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mode: iptables&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;etcd:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    extraArgs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      listen-client-urls: https://127.0.0.1:2379,https://172.19.170.185:2379&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      advertise-client-urls: https://172.19.170.185:2379&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      listen-peer-urls: https://172.19.170.185:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-advertise-peer-urls: https://172.19.170.185:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-cluster: master-1=https://172.19.170.183:2380,master-2=https://172.19.170.184:2380,master-3=https://172.19.170.185:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      initial-cluster-state: existing&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    serverCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    peerCertSANs:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 172.19.170.185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;networking:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# This CIDR is a Calico default. Substitute or remove for your CNI provider.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  podSubnet: 192.168.0.0/16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  &lt;span class=&quot;comment&quot;&gt;# image的仓库源  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;################## 切换至master-1执行 ##################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-n kube-system etcd-master-1 -- etcdctl \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--ca-file /etc/kubernetes/pki/etcd/ca.crt \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--cert-file /etc/kubernetes/pki/etcd/peer.crt \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--key-file /etc/kubernetes/pki/etcd/peer.key \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--endpoints=https://172.19.170.183:2379 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;member add master-3 https://172.19.170.185:2380&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在master-1 执行后会卡在那边，等待其他的etcd节点加入&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;################## 切换至master-3执行 ##################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase certs all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig controller-manager --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig scheduler --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubelet config write-to-disk --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubelet write-env-file --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig kubelet --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase etcd &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt; --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase controlplane all --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase mark-master --config &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/kubeadm-3.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;调整配置，使用vip来进行调度&quot;&gt;&lt;a href=&quot;#调整配置，使用vip来进行调度&quot; class=&quot;headerlink&quot; title=&quot;调整配置，使用vip来进行调度&quot;&gt;&lt;/a&gt;调整配置，使用vip来进行调度&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;在所有master机器上都执行以下命令&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在master-1 上执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/etcd-servers=https:\/\/127.0.0.1:2379/etcd-servers=https:\/\/172.19.170.183:2379,https:\/\/172.19.170.184:2379,https:\/\/172.19.170.185:2379/g&#39;&lt;/span&gt; /etc/kubernetes/manifests/kube-apiserver.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/172.19.170.183:6443/172.19.170.100:8443/g&#39;&lt;/span&gt; ~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/172.19.170.183:6443/172.19.170.100:8443/g&#39;&lt;/span&gt; /etc/kubernetes/kubelet.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在master-2 上执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/etcd-servers=https:\/\/127.0.0.1:2379/etcd-servers=https:\/\/172.19.170.183:2379,https:\/\/172.19.170.184:2379,https:\/\/172.19.170.185:2379/g&#39;&lt;/span&gt; /etc/kubernetes/manifests/kube-apiserver.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/172.19.170.184:6443/172.19.170.100:8443/g&#39;&lt;/span&gt; ~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/172.19.170.184:6443/172.19.170.100:8443/g&#39;&lt;/span&gt; /etc/kubernetes/kubelet.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在master-3 上执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/etcd-servers=https:\/\/127.0.0.1:2379/etcd-servers=https:\/\/172.19.170.183:2379,https:\/\/172.19.170.184:2379,https:\/\/172.19.170.185:2379/g&#39;&lt;/span&gt; /etc/kubernetes/manifests/kube-apiserver.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/172.19.170.185:6443/172.19.170.100:8443/g&#39;&lt;/span&gt; ~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/172.19.170.185:6443/172.19.170.100:8443/g&#39;&lt;/span&gt; /etc/kubernetes/kubelet.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;################## 至此集群搭建完成 #####################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;######################################################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;开启kubernetes-插件&quot;&gt;&lt;a href=&quot;#开启kubernetes-插件&quot; class=&quot;headerlink&quot; title=&quot;开启kubernetes 插件&quot;&gt;&lt;/a&gt;开启kubernetes 插件&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;在随意一台master执行&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;安装calico-网络插件&quot;&gt;&lt;a href=&quot;#安装calico-网络插件&quot; class=&quot;headerlink&quot; title=&quot;安装calico 网络插件&quot;&gt;&lt;/a&gt;安装calico 网络插件&lt;/h3&gt;&lt;p&gt;确保 &lt;code&gt;Kubernetes controller manager (/etc/kubernetes/manifests/kube-controller-manager.yaml)&lt;/code&gt; 设置了以下标志：&lt;code&gt;--cluster-cidr=192.168.0.0/16和--allocate-node-cidrs=true&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;提示：在kubeadm上，您可以传递&lt;code&gt;--pod-network-cidr=192.168.0.0/16&lt;/code&gt; 给kubeadm以设置两个Kubernetes控制器标志。&lt;/p&gt;
&lt;p&gt;在ConfigMap命名中&lt;code&gt;calico-config&lt;/code&gt;，找到&lt;code&gt;typha_service_name&lt;/code&gt;，删除&lt;code&gt;none&lt;/code&gt;值，并替换为&lt;code&gt;calico-typha&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;我们建议每&lt;code&gt;200&lt;/code&gt;个节点至少&lt;code&gt;复制一个副本&lt;/code&gt;，不超过20个副本。在生产中，我们建议至少使用&lt;code&gt;三个副本&lt;/code&gt;来减少滚动升级和故障的影响。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;警告：如果您设置typha_service_name而不增加其默认值为0 Felix的副本计数将尝试连接到Typha，找不到要连接的Typha实例，并且无法启动。&lt;/code&gt;&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; www.jiunile.com/k8s/plugin/1.11.5/calico.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;安装heapster-监控插件&quot;&gt;&lt;a href=&quot;#安装heapster-监控插件&quot; class=&quot;headerlink&quot; title=&quot;安装heapster 监控插件&quot;&gt;&lt;/a&gt;安装heapster 监控插件&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; www.jiunile.com/k8s/plugin/1.11.5/heapster.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;安装dashboard-插件&quot;&gt;&lt;a href=&quot;#安装dashboard-插件&quot; class=&quot;headerlink&quot; title=&quot;安装dashboard 插件&quot;&gt;&lt;/a&gt;安装dashboard 插件&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; www.jiunile.com/k8s/plugin/1.11.5/dashboard.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;获取加入master集群命令&quot;&gt;&lt;a href=&quot;#获取加入master集群命令&quot; class=&quot;headerlink&quot; title=&quot;获取加入master集群命令&quot;&gt;&lt;/a&gt;获取加入master集群命令&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubeadm token create --print-join-command&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;初始化所有kubernetes-node&quot;&gt;&lt;a href=&quot;#初始化所有kubernetes-node&quot; class=&quot;headerlink&quot; title=&quot;初始化所有kubernetes node&quot;&gt;&lt;/a&gt;初始化所有kubernetes node&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 拉取calico网络对应需要的镜像，拉取比教缓慢&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull quay.io/calico/typha:v3.2.4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull quay.io/calico/node:v3.2.4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull quay.io/calico/cni:v3.2.4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 加入集群&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm join 172.19.170.100:8443 --token mrvxeb.mfr1wx6upq5bbwqt --discovery-token-ca-cert-hash sha256:8ee893d8bf69f1f622f55a983f1401a9f2a236ffa9248894cb614c972de47f48&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;可以在master机器上查看对应的node状态&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl get node&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl get pod -n kube-system&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;测试&quot;&gt;&lt;a href=&quot;#测试&quot; class=&quot;headerlink&quot; title=&quot;测试&quot;&gt;&lt;/a&gt;测试&lt;/h2&gt;&lt;h3 id=&quot;测试应用和dns是否正常&quot;&gt;&lt;a href=&quot;#测试应用和dns是否正常&quot; class=&quot;headerlink&quot; title=&quot;测试应用和dns是否正常&quot;&gt;&lt;/a&gt;测试应用和dns是否正常&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;在随意一台master机器上运行&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 部署一个服务&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /root &amp;amp;&amp;amp; mkdir nginx &amp;amp;&amp;amp; &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt; EOF &amp;gt; nginx.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: Service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  selector:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    app: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt;: NodePort&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ports:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - port: 80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    nodePort: 31000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    name: nginx-port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    targetPort: 80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    protocol: TCP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: apps/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  replicas: 2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  selector:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    matchLabels:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      app: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  template:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      labels:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        app: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      containers:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        image: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ports:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        - containerPort: 80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; nginx.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 创建一个POD来测试DNS解析&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl run curl --image=radial/busyboxplus:curl -i --tty&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nslookup kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Server:    10.96.0.10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Name:      kubernetes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;curl nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 有返回结果表明ok&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl delete deployment curl&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;测试master-amp-Haproxy高可用&quot;&gt;&lt;a href=&quot;#测试master-amp-Haproxy高可用&quot; class=&quot;headerlink&quot; title=&quot;测试master &amp;amp; Haproxy高可用&quot;&gt;&lt;/a&gt;测试master &amp;amp; Haproxy高可用&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#随机关掉一台master机器&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;init 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在别的master机器上执行命令&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl get node&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#NAME      STATUS     ROLES     AGE       VERSION&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#master-1   NotReady   master    1h        v1.11.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#master-2   Ready      master    59m       v1.11.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#master-3   Ready      master    59m       v1.11.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#node-1     Ready      &amp;lt;none&amp;gt;    58m       v1.11.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#node-2     Ready      &amp;lt;none&amp;gt;    58m       v1.11.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#重新创建一个pod，看看是否能创建成功&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl run curl --image=radial/busyboxplus:curl -i --tty&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl delete deployment curl&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;环境介绍&quot;&gt;&lt;a href=&quot;#环境介绍&quot; class=&quot;headerlink&quot; title=&quot;环境介绍&quot;&gt;&lt;/a&gt;环境介绍&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left&quot;&gt;IP&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;Hostname&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;备注&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.183&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.184&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.185&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;master-3&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云安装keepalived + haproxy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.186&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.187&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;node-2&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;无&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;172.19.170.100&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;vip&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;私有云使用keepalive+haproxy搭建，公有云使用内部负载均衡器&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;环境初始化&quot;&gt;&lt;a href=&quot;#环境初始化&quot; class=&quot;headerlink&quot; title=&quot;环境初始化&quot;&gt;&lt;/a&gt;环境初始化&lt;/h2&gt;&lt;h3 id=&quot;在master-1-机器上执行以下命令：&quot;&gt;&lt;a href=&quot;#在master-1-机器上执行以下命令：&quot; class=&quot;headerlink&quot; title=&quot;在master-1 机器上执行以下命令：&quot;&gt;&lt;/a&gt;在master-1 机器上执行以下命令：&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ssh-keygen -t rsa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssh-copy-id root@master-3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;a href=&quot;#修改hosts信息，在所有master机器上运行&quot; class=&quot;headerlink&quot; title=&quot;修改hosts信息，在所有master机器上运行&quot;&gt;&lt;/a&gt;修改hosts信息，在所有master机器上运行&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/hosts&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.183 master-1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.184 master-2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.19.170.185 master-3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="容器云" scheme="http://icyxp.github.io/categories/kubernetes/%E5%AE%B9%E5%99%A8%E4%BA%91/"/>
    
      <category term="kubadm" scheme="http://icyxp.github.io/categories/kubernetes/%E5%AE%B9%E5%99%A8%E4%BA%91/kubadm/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="kubeadm" scheme="http://icyxp.github.io/tags/kubeadm/"/>
    
      <category term="集群" scheme="http://icyxp.github.io/tags/%E9%9B%86%E7%BE%A4/"/>
    
      <category term="ha" scheme="http://icyxp.github.io/tags/ha/"/>
    
  </entry>
  
  <entry>
    <title>认识Kubernetes Descheduler</title>
    <link href="http://icyxp.github.io//blog/2018/12/k8s-descheduler.html"/>
    <id>http://icyxp.github.io//blog/2018/12/k8s-descheduler.html</id>
    <published>2018-12-12T13:00:00.000Z</published>
    <updated>2019-02-14T10:27:37.000Z</updated>
    
    <content type="html">&lt;p&gt;&lt;code&gt;kube-scheduler&lt;/code&gt; 是 Kubernetes 中负责调度的组件，它本身的调度功能已经很强大了。但由于 Kubernetes 集群非常活跃，它的状态会随时间而改变，由于各种原因，你可能需要将已经运行的 Pod 移动到其他节点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;某些节点负载过高&lt;/li&gt;
&lt;li&gt;某些资源对象被添加了 &lt;a href=&quot;https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#node-affinity-beta-feature&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;node 亲和性&lt;/a&gt; 或 &lt;a href=&quot;https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#inter-pod-affinity-and-anti-affinity-beta-feature&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;pod （反）亲和性&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;集群中加入了新节点&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;一旦 Pod 启动之后 &lt;code&gt;kube-scheduler&lt;/code&gt; 便不会再尝试重新调度它。根据环境的不同，你可能会有很多需要手动调整 Pod 的分布，例如：如果集群中新加入了一个节点，那么已经运行的 Pod 并不会被分摊到这台节点上，这台节点可能只运行了少量的几个 Pod，这并不理想，对吧？&lt;/p&gt;
&lt;h3 id=&quot;Descheduler-如何工作？&quot;&gt;&lt;a href=&quot;#Descheduler-如何工作？&quot; class=&quot;headerlink&quot; title=&quot;Descheduler 如何工作？&quot;&gt;&lt;/a&gt;Descheduler 如何工作？&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes-incubator/descheduler&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Descheduler&lt;/a&gt; 会检查 Pod 的状态，并根据自定义的策略将不满足要求的 Pod 从该节点上驱逐出去。Descheduler 并不是 &lt;code&gt;kube-scheduler&lt;/code&gt; 的替代品，而是要依赖于它。该项目目前放在 Kubernetes 的孵化项目中，还没准备投入生产，但经过我实验发现它的运行效果很好，而且非常稳定。那么该如何安装呢？&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;部署方法&quot;&gt;&lt;a href=&quot;#部署方法&quot; class=&quot;headerlink&quot; title=&quot;部署方法&quot;&gt;&lt;/a&gt;部署方法&lt;/h3&gt;&lt;p&gt;你可以通过 &lt;code&gt;Job&lt;/code&gt; 或 &lt;code&gt;CronJob&lt;/code&gt; 来运行 descheduler。我已经创建了一个镜像 &lt;code&gt;komljen/descheduler:v0.5.0-4-ga7ceb671&lt;/code&gt;（包含在下面的 yaml 文件中），但由于这个项目的更新速度很快，你可以通过以下的命令创建你自己的镜像：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;⚡ git &lt;span class=&quot;built_in&quot;&gt;clone&lt;/span&gt; https://github.com/kubernetes-incubator/descheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;⚡ &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; descheduler &amp;amp;&amp;amp; make image&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后打好标签 push 到自己的镜像仓库中。&lt;/p&gt;
&lt;p&gt;通过我创建的 chart 模板，你可以用 &lt;code&gt;Helm&lt;/code&gt; 来部署 descheduler，该模板支持 RBAC 并且已经在 Kubernetes v1.9 上测试通过。&lt;/p&gt;
&lt;p&gt;添加我的 helm 私有仓库，然后部署 descheduler：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;⚡ helm repo add akomljen-charts \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    https://raw.githubusercontent.com/komljen/helm-charts/master/charts/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;⚡ helm install --name ds \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    --namespace kube-system \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    akomljen-charts/descheduler&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;你也可以不使用 helm，通过手动部署。首先创建 serviceaccount 和 clusterrolebinding：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Create a cluster role&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;⚡ cat &amp;lt;&amp;lt; EOF| kubectl create -n kube-system &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; -&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: rbac.authorization.k8s.io/v1beta1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: ClusterRole&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  name: descheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rules:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- apiGroups: [&lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  resources: [&lt;span class=&quot;string&quot;&gt;&quot;nodes&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  verbs: [&lt;span class=&quot;string&quot;&gt;&quot;get&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;watch&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;list&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- apiGroups: [&lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  resources: [&lt;span class=&quot;string&quot;&gt;&quot;pods&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  verbs: [&lt;span class=&quot;string&quot;&gt;&quot;get&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;watch&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;list&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;delete&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- apiGroups: [&lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  resources: [&lt;span class=&quot;string&quot;&gt;&quot;pods/eviction&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  verbs: [&lt;span class=&quot;string&quot;&gt;&quot;create&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Create a service account&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;⚡ kubectl create sa descheduler -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Bind the cluster role to the service account&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;⚡ kubectl create clusterrolebinding descheduler \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    -n kube-system \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    --clusterrole=descheduler \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    --serviceaccount=kube-system:descheduler&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后通过 &lt;code&gt;configmap&lt;/code&gt; 创建 descheduler 策略。目前只支持四种策略：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/kubernetes-incubator/descheduler#removeduplicates&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;RemoveDuplicates&lt;/a&gt;&lt;br&gt;RS、deployment 中的 pod 不能同时出现在一台机器上&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/kubernetes-incubator/descheduler#lownodeutilization&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;LowNodeUtilization&lt;/a&gt;&lt;br&gt;找到资源使用率比较低的 node，然后驱逐其他资源使用率比较高节点上的 pod，期望调度器能够重新调度让资源更均衡&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/kubernetes-incubator/descheduler#removepodsviolatinginterpodantiaffinity&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;RemovePodsViolatingInterPodAntiAffinity&lt;/a&gt;&lt;br&gt;找到已经违反 Pod Anti Affinity 规则的 pods 进行驱逐，可能是因为反亲和是后面加上去的&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/kubernetes-incubator/descheduler#removepodsviolatingnodeaffinity&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;RemovePodsViolatingNodeAffinity&lt;/a&gt;&lt;br&gt;找到违反 Node Affinity 规则的 pods 进行驱逐，可能是因为 node 后面修改了 label&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;默认这四种策略全部开启，你可以根据需要关闭它们。下面在 &lt;code&gt;kube-system&lt;/code&gt; 命名空间中创建一个 configmap：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;⚡ cat &amp;lt;&amp;lt; EOF| kubectl create -n kube-system &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; -&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: ConfigMap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  name: descheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;data:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  policy.yaml: |-  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    apiVersion: descheduler/v1alpha1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    kind: DeschedulerPolicy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    strategies:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      RemoveDuplicates:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         enabled: &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      LowNodeUtilization:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         enabled: &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         params:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           nodeResourceUtilizationThresholds:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             thresholds:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               cpu: 20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               memory: 20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               pods: 20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             targetThresholds:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               cpu: 50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               memory: 50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               pods: 50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      RemovePodsViolatingInterPodAntiAffinity:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        enabled: &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      RemovePodsViolatingNodeAffinity:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        enabled: &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        params:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          nodeAffinityType:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          - requiredDuringSchedulingIgnoredDuringExecution&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在 &lt;code&gt;kube-system&lt;/code&gt; 命名空间中创建一个 CronJob，该 CroJob 每 30 分钟运行一次：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;⚡ cat &amp;lt;&amp;lt; EOF| kubectl create -n kube-system &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; -&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: batch/v1beta1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: CronJob&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  name: descheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  schedule: &lt;span class=&quot;string&quot;&gt;&quot;*/30 * * * *&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  jobTemplate:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      name: descheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      annotations:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        scheduler.alpha.kubernetes.io/critical-pod: &lt;span class=&quot;string&quot;&gt;&quot;true&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      template:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          serviceAccountName: descheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          containers:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          - name: descheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            image: komljen/descheduler:v0.6.0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            volumeMounts:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            - mountPath: /policy-dir&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              name: policy-volume&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;command&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            - /bin/descheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            - --v=4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            - --max-pods-to-evict-per-node=10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            - --policy-config-file=/policy-dir/policy.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          restartPolicy: &lt;span class=&quot;string&quot;&gt;&quot;OnFailure&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          volumes:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          - name: policy-volume&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            configMap:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              name: descheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;⚡ kubectl get cronjobs -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME             SCHEDULE       SUSPEND   ACTIVE    LAST SCHEDULE   AGE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;descheduler      */30 * * * *   False     0         2m              32m&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;当 CronJob 开始工作后，可以通过以下命令查看已经成功结束的 Pod：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;⚡ kubectl get pods -n kube-system &lt;span class=&quot;_&quot;&gt;-a&lt;/span&gt; | grep Completed&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;descheduler-1525520700-297pq          0/1       Completed   0          1h&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;descheduler-1525521000-tz2ch          0/1       Completed   0          32m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;descheduler-1525521300-mrw4t          0/1       Completed   0          2m&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;也可以查看这些 Pod 的日志，然后根据需要调整 descheduler 策略：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;⚡ kubectl logs descheduler-1525521300-mrw4t -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.554195       1 reflector.go:202] Starting reflector *v1.Node (1h0m0s) from github.com/kubernetes-incubator/descheduler/pkg/descheduler/node/node.go:84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.554255       1 reflector.go:240] Listing and watching *v1.Node from github.com/kubernetes-incubator/descheduler/pkg/descheduler/node/node.go:84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.767903       1 lownodeutilization.go:147] Node &lt;span class=&quot;string&quot;&gt;&quot;ip-10-4-63-172.eu-west-1.compute.internal&quot;&lt;/span&gt; is appropriately utilized with usage: api.ResourceThresholds&amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;cpu&quot;&lt;/span&gt;:41.5, &lt;span class=&quot;string&quot;&gt;&quot;memory&quot;&lt;/span&gt;:1.3635487207675927, &lt;span class=&quot;string&quot;&gt;&quot;pods&quot;&lt;/span&gt;:8.181818181818182&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.767942       1 lownodeutilization.go:149] allPods:9, nonRemovablePods:9, bePods:0, bPods:0, gPods:0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.768141       1 lownodeutilization.go:144] Node &lt;span class=&quot;string&quot;&gt;&quot;ip-10-4-36-223.eu-west-1.compute.internal&quot;&lt;/span&gt; is over utilized with usage: api.ResourceThresholds&amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;cpu&quot;&lt;/span&gt;:48.75, &lt;span class=&quot;string&quot;&gt;&quot;memory&quot;&lt;/span&gt;:61.05259502942694, &lt;span class=&quot;string&quot;&gt;&quot;pods&quot;&lt;/span&gt;:30&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.768156       1 lownodeutilization.go:149] allPods:33, nonRemovablePods:12, bePods:1, bPods:19, gPods:1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.768376       1 lownodeutilization.go:144] Node &lt;span class=&quot;string&quot;&gt;&quot;ip-10-4-41-14.eu-west-1.compute.internal&quot;&lt;/span&gt; is over utilized with usage: api.ResourceThresholds&amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;cpu&quot;&lt;/span&gt;:39.125, &lt;span class=&quot;string&quot;&gt;&quot;memory&quot;&lt;/span&gt;:98.19259268881142, &lt;span class=&quot;string&quot;&gt;&quot;pods&quot;&lt;/span&gt;:33.63636363636363&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.768390       1 lownodeutilization.go:149] allPods:37, nonRemovablePods:8, bePods:0, bPods:29, gPods:0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.768538       1 lownodeutilization.go:147] Node &lt;span class=&quot;string&quot;&gt;&quot;ip-10-4-34-29.eu-west-1.compute.internal&quot;&lt;/span&gt; is appropriately utilized with usage: api.ResourceThresholds&amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;memory&quot;&lt;/span&gt;:43.19826999287199, &lt;span class=&quot;string&quot;&gt;&quot;pods&quot;&lt;/span&gt;:30.90909090909091, &lt;span class=&quot;string&quot;&gt;&quot;cpu&quot;&lt;/span&gt;:35.25&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.768552       1 lownodeutilization.go:149] allPods:34, nonRemovablePods:11, bePods:8, bPods:15, gPods:0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.768556       1 lownodeutilization.go:65] Criteria &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; a node under utilization: CPU: 20, Mem: 20, Pods: 20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.768571       1 lownodeutilization.go:69] No node is underutilized, nothing to &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; here, you might tune your thersholds further&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.768576       1 pod_antiaffinity.go:45] Processing node: &lt;span class=&quot;string&quot;&gt;&quot;ip-10-4-63-172.eu-west-1.compute.internal&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.779313       1 pod_antiaffinity.go:45] Processing node: &lt;span class=&quot;string&quot;&gt;&quot;ip-10-4-36-223.eu-west-1.compute.internal&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.796766       1 pod_antiaffinity.go:45] Processing node: &lt;span class=&quot;string&quot;&gt;&quot;ip-10-4-41-14.eu-west-1.compute.internal&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.813303       1 pod_antiaffinity.go:45] Processing node: &lt;span class=&quot;string&quot;&gt;&quot;ip-10-4-34-29.eu-west-1.compute.internal&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.829109       1 node_affinity.go:40] Executing &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; nodeAffinityType: requiredDuringSchedulingIgnoredDuringExecution&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.829133       1 node_affinity.go:45] Processing node: &lt;span class=&quot;string&quot;&gt;&quot;ip-10-4-63-172.eu-west-1.compute.internal&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.840416       1 node_affinity.go:45] Processing node: &lt;span class=&quot;string&quot;&gt;&quot;ip-10-4-36-223.eu-west-1.compute.internal&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.856735       1 node_affinity.go:45] Processing node: &lt;span class=&quot;string&quot;&gt;&quot;ip-10-4-41-14.eu-west-1.compute.internal&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.945566       1 request.go:480] Throttling request took 88.738917ms, request: GET:https://100.64.0.1:443/api/v1/pods?fieldSelector=spec.nodeName%3Dip-10-4-41-14.eu-west-1.compute.internal%2Cstatus.phase%21%3DFailed%2Cstatus.phase%21%3DSucceeded&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:07.972702       1 node_affinity.go:45] Processing node: &lt;span class=&quot;string&quot;&gt;&quot;ip-10-4-34-29.eu-west-1.compute.internal&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:08.145559       1 request.go:480] Throttling request took 172.751657ms, request: GET:https://100.64.0.1:443/api/v1/pods?fieldSelector=spec.nodeName%3Dip-10-4-34-29.eu-west-1.compute.internal%2Cstatus.phase%21%3DFailed%2Cstatus.phase%21%3DSucceeded&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0505 11:55:08.160964       1 node_affinity.go:72] Evicted 0 pods&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;哇哦，现在你的集群中已经运行了一个 descheduler！&lt;/p&gt;
&lt;h3 id=&quot;总结&quot;&gt;&lt;a href=&quot;#总结&quot; class=&quot;headerlink&quot; title=&quot;总结&quot;&gt;&lt;/a&gt;总结&lt;/h3&gt;&lt;p&gt;Kubernetes 的默认调度器已经做的很好，但由于集群处于不断变化的状态中，某些 Pod 可能运行在错误的节点上，或者你想要均衡集群资源的分配，这时候就需要 descheduler 来帮助你将某些节点上的 Pod 驱逐到正确的节点上去。我很期待正式版的发布！&lt;/p&gt;
&lt;p&gt;参考文档:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Meet a Kubernetes Descheduler&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;kube-scheduler&lt;/code&gt; 是 Kubernetes 中负责调度的组件，它本身的调度功能已经很强大了。但由于 Kubernetes 集群非常活跃，它的状态会随时间而改变，由于各种原因，你可能需要将已经运行的 Pod 移动到其他节点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;某些节点负载过高&lt;/li&gt;
&lt;li&gt;某些资源对象被添加了 &lt;a href=&quot;https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#node-affinity-beta-feature&quot;&gt;node 亲和性&lt;/a&gt; 或 &lt;a href=&quot;https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#inter-pod-affinity-and-anti-affinity-beta-feature&quot;&gt;pod （反）亲和性&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;集群中加入了新节点&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;一旦 Pod 启动之后 &lt;code&gt;kube-scheduler&lt;/code&gt; 便不会再尝试重新调度它。根据环境的不同，你可能会有很多需要手动调整 Pod 的分布，例如：如果集群中新加入了一个节点，那么已经运行的 Pod 并不会被分摊到这台节点上，这台节点可能只运行了少量的几个 Pod，这并不理想，对吧？&lt;/p&gt;
&lt;h3 id=&quot;Descheduler-如何工作？&quot;&gt;&lt;a href=&quot;#Descheduler-如何工作？&quot; class=&quot;headerlink&quot; title=&quot;Descheduler 如何工作？&quot;&gt;&lt;/a&gt;Descheduler 如何工作？&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes-incubator/descheduler&quot;&gt;Descheduler&lt;/a&gt; 会检查 Pod 的状态，并根据自定义的策略将不满足要求的 Pod 从该节点上驱逐出去。Descheduler 并不是 &lt;code&gt;kube-scheduler&lt;/code&gt; 的替代品，而是要依赖于它。该项目目前放在 Kubernetes 的孵化项目中，还没准备投入生产，但经过我实验发现它的运行效果很好，而且非常稳定。那么该如何安装呢？&lt;br&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="调度器" scheme="http://icyxp.github.io/categories/kubernetes/%E8%B0%83%E5%BA%A6%E5%99%A8/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="调度" scheme="http://icyxp.github.io/tags/%E8%B0%83%E5%BA%A6/"/>
    
      <category term="descheduler" scheme="http://icyxp.github.io/tags/descheduler/"/>
    
  </entry>
  
  <entry>
    <title>使用Kubernetes正确的处理用户请求</title>
    <link href="http://icyxp.github.io//blog/2018/12/k8s-handling-client-requests-properly-with-kubernetes.html"/>
    <id>http://icyxp.github.io//blog/2018/12/k8s-handling-client-requests-properly-with-kubernetes.html</id>
    <published>2018-12-11T13:00:00.000Z</published>
    <updated>2018-12-11T13:03:36.000Z</updated>
    
    <content type="html">&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;毫无疑问，我们希望正确处理客户端请求。当pod正在启动或关闭时，我们显然不希望看到断开的连接。Kubernetes本身并不能确保这种情况永远不会发生。您的应用需要遵循一些规则以防止断开连接。本文讨论这些规则。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;确保正确处理所有客户端请求&quot;&gt;&lt;a href=&quot;#确保正确处理所有客户端请求&quot; class=&quot;headerlink&quot; title=&quot;确保正确处理所有客户端请求&quot;&gt;&lt;/a&gt;确保正确处理所有客户端请求&lt;/h3&gt;&lt;p&gt;我们先从访问Pod的客户端的视角来看看Pod的生命周期（客户端使用pod提供的服务）。我们希望确保客户的请求得到妥善处理，因为如果当pod启动或关闭时连接开始中断，我们就会遇到麻烦。Kubernetes本身并不保证不会发生这种情况，所以让我们看看我们需要做些什么来防止它发生。&lt;/p&gt;
&lt;h3 id=&quot;当Pod启动时阻止连接中断&quot;&gt;&lt;a href=&quot;#当Pod启动时阻止连接中断&quot; class=&quot;headerlink&quot; title=&quot;当Pod启动时阻止连接中断&quot;&gt;&lt;/a&gt;当Pod启动时阻止连接中断&lt;/h3&gt;&lt;p&gt;如果你理解services和service endpoints的工作原理，确保在pod启动时正确处理每个连接都非常简单。当pod启动时，它会作为一个endpoints被添加到所有匹配该Pod标签的Services里。Pod也会发出信号告诉Kubernetes它已就绪。只有它变成一个service endpoints时才可以接收来自客户端的请求。&lt;/p&gt;
&lt;p&gt;如果你没有在Pod Spec里指定readiness探针，则会始终认为该pod已准备就绪。这意味着它将立即开始接收请求 - 只要第一个Kube-Proxy在其节点上更新iptables规则并且第一个客户端pod尝试连接到该服务。如果那个时候你的应用并没有做好接收请求的准备，那么客户端将会见到“connection refused”类型的错误。&lt;/p&gt;
&lt;p&gt;你所需要做的就是保证你的readiness探针当且仅当你的应用可以正确处理收到的请求时才返回成功结果。所以添加一个HTTP GET readiness探针并让它指向你应用的基础URL会是一个很好的开始。在很多情况下，这可以让你省去实现一个特定的readiness端点的工作量。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;在pod关闭期间防止断开连接&quot;&gt;&lt;a href=&quot;#在pod关闭期间防止断开连接&quot; class=&quot;headerlink&quot; title=&quot;在pod关闭期间防止断开连接&quot;&gt;&lt;/a&gt;在pod关闭期间防止断开连接&lt;/h3&gt;&lt;p&gt;现在让我们看看当一个Pod生命周期结束时发生了什么——当Pod被删除和它里面的容器被停止时。一旦Pod的容器接收到SIGTERM后它就会开始关闭（或者是在那之前先执行prestop钩子），但这是否能保证所有的客户端请求可以被正确地处理？&lt;/p&gt;
&lt;p&gt;我们的应用在收到结束信号时应该如何响应？它是否应该继续接收请求？那么那些已经收到的请求但是还未完成的请求呢？那么那些正在发送请求的间隔中且仍然处理打开状态的持久HTTP连接（连接上没有活跃的请求）呢？在回答这些问题之前，我们需要深入了解一下当Pod结束时集群里发生的一系列事件。&lt;/p&gt;
&lt;h3 id=&quot;了解Pod删除时发生的一系列事件&quot;&gt;&lt;a href=&quot;#了解Pod删除时发生的一系列事件&quot; class=&quot;headerlink&quot; title=&quot;了解Pod删除时发生的一系列事件&quot;&gt;&lt;/a&gt;了解Pod删除时发生的一系列事件&lt;/h3&gt;&lt;p&gt;您需要始终牢记Kubernetes的各个组件是独立运行在集群的节点上的。它们之间并不是一个巨大的单体应用。这些组件间同步状态会花费一点时间。让我们一起来看看当Pod删除时发生了什么。&lt;/p&gt;
&lt;p&gt;当APIserver收到一个停止Pod的请求时，它首先修改了etcd里Pod的状态，并通知关注这个删除事件所有的watcher。这些watcher里包括Kubelet和Endpoint Controller。这两个序列的事件是并行发生的（标记为A和B），如图1所示。&lt;br&gt;&lt;img src=&quot;/images/k8s/k8s_pod_03.png&quot; alt=&quot;pod停止时的事件&quot;&gt;&lt;/p&gt;
&lt;p&gt;在A系列事件里，你会看到在Kubelet收到该Pod要停止的通知以后会尽快开始停止Pod的一系列操作（执行prestop钩子，发送SIGTERM信号，等待一段时间然后如果这个容器没有自动退出的话就强行杀掉这个容器）。如果应用响应了SIGTERM并迅速停止接收请求，那么任何尝试连接它的客户端都会收到一个Connection Refusd的错误。因为APIserver是直接向Kubelet发送的请求，那么从Pod被删除开始计算，Pod用于执行这段逻辑的时间相当短。&lt;/p&gt;
&lt;p&gt;现在，让我们一起看看另外一系列事件都发生了什么——移除这个Pod相关的iptables规则（图中所示事件系列B）。当Endpoints Controller（运行在在Kubernetes控制平面里的Controller Manager里）收到这个Pod被删除的通知，然后它会把这个Pod从所有关联到这个Pod的Service里剔除。它通过向APIserver发送一个REST请求对Endpoint对象进行修改来实现。APIserver然后通知每个监视Endpoint对象的组件。在这些组件里包含了每个工作节点上运行的Kubeproxy。这些代理负责更新它所在节点上的iptables规则，这些规则可以用来阻止外面的请求被转发到要停止的Pod上。这里有个非常重要的细节，移除这些iptables规则对于已有的连接不会有任何影响——连接到这个Pod的客户端仍然可以通过已有连接向它发送请求。&lt;/p&gt;
&lt;p&gt;这些请求都是并行发生的。更确切地，关停应用所需要的时间要比iptables更新花费所需的时间稍短一些。这是因为iptables修改的事件链看起来稍微长一些（见图2），因为这些事件需要先到达Endpoints Controller，然后它向APIServer发送一个新请求，接着在Proxy最终修改iptables规则之前，APIserver必须通知到每个KubeProxy。这意味着SIGTERM可能会在所有节点iptables规则更新前发送。&lt;br&gt;&lt;img src=&quot;/images/k8s/k8s_pod_04.png&quot; alt=&quot;删除pod时的事件时间线&quot;&gt;&lt;/p&gt;
&lt;p&gt;结果是pod在收到终止信号后仍然可以接收客户端请求。如果应用程序立即停止接受连接，则会导致客户端收到“Connection Refused”类型的错误（就像在没有定义Readiness探针时，Pod启动但无法对外提供服务时一样） 。&lt;/p&gt;
&lt;h3 id=&quot;解决问题&quot;&gt;&lt;a href=&quot;#解决问题&quot; class=&quot;headerlink&quot; title=&quot;解决问题&quot;&gt;&lt;/a&gt;解决问题&lt;/h3&gt;&lt;p&gt;谷歌搜索此问题的解决方案，似乎给Pod添加一个Readiness探针就可以解决这个问题。按照推测，你所需要做的就是让你的Readiness探针在应用收到SIGTERM信号后尽快失败。这可以让Pod从Service上移除。只有在Readiness探针连续失败几次后才会从Service上移除（这可以在Readiness探针里进行配置）。并且显然这个移除事件会在iptables规则更新前先到达Kubeproxy。&lt;/p&gt;
&lt;p&gt;实际上，Readiness探针在整个过程中并未起到关键作用。一旦Endpoints Controller收到Pod删除事件后（当Pod配置里的deletionTimestamp域不再为空时），它会尽快从Service上移除这些Pod。从那时起，这已经就与Readiness探测结果不相关了。&lt;/p&gt;
&lt;p&gt;那么什么是问题的正确解决方案？我们如何保证所有的请求都可以被正确处理？&lt;/p&gt;
&lt;p&gt;好吧，很明显，即使收到终止信号后，pod也需要继续接受连接，直到所有Kube代理完成更新iptables规则。那么，不止是Kubeproxy。可能有一些IngressController或者其他直接向Pod转发请求的负载均衡设备等不需要经过Service的。这还包括使用客户端负载平衡的客户端。&lt;br&gt;为了确保没有任何客户端遇到断开的连接，您必须等到所有客户端以某种方式通知您他们将不再转发到该Pod的连接。&lt;/p&gt;
&lt;p&gt;但这是不可能的，因为这些组件都分布在不同的计算机上。即使你知道它们每个所在的位置或者等着它们每个都满足停止Pod的需求，如果它们其中之一没有响应你会该怎么办？你要等待多久？记着，在那段时间里，你需要暂停关闭进程。&lt;/p&gt;
&lt;p&gt;你唯一可能的做事情是你可以等待足够长的时间直到所有的代理都完成了它们的工作。但是多长时间才算够？在大多数情况中，短暂的几秒就足够了，但是显然这并不能满足全部的情况。当APIserver或者Endpoints Controller过载时，它们可能需要更长时间来通知到每个代理。重要的是要了解您无法完美地解决问题，但是即使是5秒或者10秒都可以显著提升用户体验。你可以设置更长的延迟，但是别太过分，因为这些延迟推迟了容器的停止时间，并且会导致容器在被关停后仍然被显示在列表里，这会对用户带来一定的困扰。&lt;/p&gt;
&lt;p&gt;正确关闭应用程序包括以下步骤：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;等待几秒，然后停止接收新连接&lt;/li&gt;
&lt;li&gt;关闭所有未在请求中的keep-alived连接&lt;/li&gt;
&lt;li&gt;等到所有活跃的请求关闭，然后&lt;/li&gt;
&lt;li&gt;彻底关闭&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;要了解在此过程中连接和请求发生的情况，请仔细检查图3。&lt;br&gt;&lt;img src=&quot;/images/k8s/k8s_pod_05.png&quot; alt=&quot;在收到终止信号后正确处理现有和新连接&quot;&gt;&lt;/p&gt;
&lt;p&gt;没有像收到终止信号后立即退出过程一样简单，对吧？这一切是值得的吗？这要靠你自己来决定。但是至少你可以添加一个prestop钩子并等待几秒，就像下面所示：&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;lifecycle:&lt;/span&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    preStop:&lt;/span&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        exec:&lt;/span&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            command:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;             -&lt;/span&gt; sh&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;             -&lt;/span&gt; -c&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;             -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;sleep 5&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这样，您根本不需要修改应用程序的代码。如果您的应用要确保完全处理所有正在进行的请求，这个preStop钩子就可以满足所有你的需要。&lt;/p&gt;
&lt;p&gt;参考文档:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;handling-client-requests-properly-with-kubernetes&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;毫无疑问，我们希望正确处理客户端请求。当pod正在启动或关闭时，我们显然不希望看到断开的连接。Kubernetes本身并不能确保这种情况永远不会发生。您的应用需要遵循一些规则以防止断开连接。本文讨论这些规则。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;确保正确处理所有客户端请求&quot;&gt;&lt;a href=&quot;#确保正确处理所有客户端请求&quot; class=&quot;headerlink&quot; title=&quot;确保正确处理所有客户端请求&quot;&gt;&lt;/a&gt;确保正确处理所有客户端请求&lt;/h3&gt;&lt;p&gt;我们先从访问Pod的客户端的视角来看看Pod的生命周期（客户端使用pod提供的服务）。我们希望确保客户的请求得到妥善处理，因为如果当pod启动或关闭时连接开始中断，我们就会遇到麻烦。Kubernetes本身并不保证不会发生这种情况，所以让我们看看我们需要做些什么来防止它发生。&lt;/p&gt;
&lt;h3 id=&quot;当Pod启动时阻止连接中断&quot;&gt;&lt;a href=&quot;#当Pod启动时阻止连接中断&quot; class=&quot;headerlink&quot; title=&quot;当Pod启动时阻止连接中断&quot;&gt;&lt;/a&gt;当Pod启动时阻止连接中断&lt;/h3&gt;&lt;p&gt;如果你理解services和service endpoints的工作原理，确保在pod启动时正确处理每个连接都非常简单。当pod启动时，它会作为一个endpoints被添加到所有匹配该Pod标签的Services里。Pod也会发出信号告诉Kubernetes它已就绪。只有它变成一个service endpoints时才可以接收来自客户端的请求。&lt;/p&gt;
&lt;p&gt;如果你没有在Pod Spec里指定readiness探针，则会始终认为该pod已准备就绪。这意味着它将立即开始接收请求 - 只要第一个Kube-Proxy在其节点上更新iptables规则并且第一个客户端pod尝试连接到该服务。如果那个时候你的应用并没有做好接收请求的准备，那么客户端将会见到“connection refused”类型的错误。&lt;/p&gt;
&lt;p&gt;你所需要做的就是保证你的readiness探针当且仅当你的应用可以正确处理收到的请求时才返回成功结果。所以添加一个HTTP GET readiness探针并让它指向你应用的基础URL会是一个很好的开始。在很多情况下，这可以让你省去实现一个特定的readiness端点的工作量。&lt;br&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="请求" scheme="http://icyxp.github.io/tags/%E8%AF%B7%E6%B1%82/"/>
    
  </entry>
  
  <entry>
    <title>Kubeadm 证书说明</title>
    <link href="http://icyxp.github.io//blog/2018/12/k8s-kubeadm-ca-desc.html"/>
    <id>http://icyxp.github.io//blog/2018/12/k8s-kubeadm-ca-desc.html</id>
    <published>2018-12-11T12:00:00.000Z</published>
    <updated>2018-12-11T13:03:00.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;如果你使用过kubeadm部署过Kubernetes的环境, master主机节点上就一定会在相应的目录创建了一大批证书文件, 本篇文章就来说说kubeadm到底为我们生成了哪些证书&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在Kubernetes的部署中, 创建证书, 配置证书是一道绕不过去坎儿, 好在有kubeadm这样的自动化工具, 帮我们去生成, 配置这些证书. 对于只是想体验Kubernetes或只是想测试的亲来说, 这已经够了, 但是作为Kubernetes的集群维护者来说, kubeadm更像是一个黑盒, 本篇文章就来说说黑盒中关于证书的事儿~&lt;/p&gt;
&lt;p&gt;使用kubeadm创建完Kubernetes集群后, 默认会在&lt;code&gt;/etc/kubernetes/pki&lt;/code&gt;目录下存放集群中需要用到的证书文件, 整体结构如下图所示:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;root@k8s-master:/etc/kubernetes/pki&lt;span class=&quot;comment&quot;&gt;# tree&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- apiserver.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- apiserver-etcd-client.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- apiserver-etcd-client.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- apiserver.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- apiserver-kubelet-client.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- apiserver-kubelet-client.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- etcd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- healthcheck-client.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- healthcheck-client.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- peer.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- peer.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- server.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   `-- server.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- front-proxy-ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- front-proxy-ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- front-proxy-client.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- front-proxy-client.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- sa.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;`-- sa.pub&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1 directory, 22 files&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;以上22个文件就是kubeadm为我们创建的所有证书相关的文件, 下面我们来一一解析&lt;/p&gt;
&lt;h3 id=&quot;证书分组&quot;&gt;&lt;a href=&quot;#证书分组&quot; class=&quot;headerlink&quot; title=&quot;证书分组&quot;&gt;&lt;/a&gt;证书分组&lt;/h3&gt;&lt;p&gt;Kubernetes把证书放在了两个文件夹中&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;/etc/kubernetes/pki&lt;/li&gt;
&lt;li&gt;/etc/kubernetes/pki/etcd&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们再将这22个文件按照更细的粒度去分组&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;Kubernetes-集群根证书&quot;&gt;&lt;a href=&quot;#Kubernetes-集群根证书&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes 集群根证书&quot;&gt;&lt;/a&gt;Kubernetes 集群根证书&lt;/h3&gt;&lt;p&gt;Kubernetes 集群根证书CA(Kubernetes集群组件的证书签发机构)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;/etc/kubernetes/pki/ca.crt&lt;/li&gt;
&lt;li&gt;/etc/kubernetes/pki/ca.key&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以上这组证书为签发其他Kubernetes组件证书使用的根证书, 可以认为是Kubernetes集群中证书签发机构之一&lt;/p&gt;
&lt;p&gt;由此根证书签发的证书有:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;kube-apiserver 组件持有的服务端证书&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;/etc/kubernetes/pki/apiserver.crt&lt;/li&gt;
&lt;li&gt;/etc/kubernetes/pki/apiserver.key&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;kubelet 组件持有的客户端证书, 用作 kube-apiserver 主动向 kubelet 发起请求时的客户端认证&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;/etc/kubernetes/pki/apiserver-kubelet-client.crt&lt;/li&gt;
&lt;li&gt;/etc/kubernetes/pki/apiserver-kubelet-client.key&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;注意: Kubernetes集群组件之间的交互是双向的, kubelet 既需要主动访问 kube-apiserver, kube-apiserver 也需要主动向 kubelet 发起请求, 所以双方都需要有自己的根证书以及使用该根证书签发的服务端证书和客户端证书. 在 kube-apiserver 中, 一般明确指定用于 https 访问的服务端证书和带有&lt;code&gt;CN 用户名&lt;/code&gt;信息的客户端证书. 而在 kubelet 的启动配置中, 一般只指定了 ca 根证书, 而没有明确指定用于 https 访问的服务端证书, 这是因为, 在生成服务端证书时, 一般会指定服务端地址或主机名, kube-apiserver 相对变化不是很频繁, 所以在创建集群之初就可以预先分配好用作 kube-apiserver 的 IP 或主机名/域名, 但是由于部署在 node 节点上的 kubelet 会因为集群规模的变化而频繁变化, 而无法预知 node 的所有 IP 信息, 所以 kubelet 上一般不会明确指定服务端证书, 而是只指定 ca 根证书, 让 kubelet 根据本地主机信息自动生成服务端证书并保存到配置的&lt;code&gt;cert-dir&lt;/code&gt;文件夹中.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;好了, 至此, Kubernetes集群根证书所签发的证书都在上面了, 算上根证书一共涉及到6个文件, 22-6=16, 我们还剩下16个文件&lt;/p&gt;
&lt;h3 id=&quot;汇聚层证书&quot;&gt;&lt;a href=&quot;#汇聚层证书&quot; class=&quot;headerlink&quot; title=&quot;汇聚层证书&quot;&gt;&lt;/a&gt;汇聚层证书&lt;/h3&gt;&lt;p&gt;kube-apiserver 的另一种访问方式就是使用 &lt;code&gt;kubectl proxy&lt;/code&gt; 来代理访问, 而该证书就是用来支持SSL代理访问的. 在该种访问模式下, 我们是以http的方式发起请求到代理服务的, 此时, 代理服务会将该请求发送给 kube-apiserver, 在此之前, 代理会将发送给 kube-apiserver 的请求头里加入证书信息, 以下两个配置&lt;/p&gt;
&lt;p&gt;API Aggregation允许在不修改Kubernetes核心代码的同时扩展Kubernetes API. 开启 API Aggregation 需要在 kube-apiserver 中添加如下配置:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;--requestheader-client-ca-file=&amp;lt;path to aggregator CA cert&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--requestheader-allowed-names=front-proxy-client&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--requestheader-extra-headers-prefix=X-Remote-Extra-&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--requestheader-group-headers=X-Remote-Group&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--requestheader-username-headers=X-Remote-User&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--proxy-client-cert-file=&amp;lt;path to aggregator proxy cert&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--proxy-client-key-file=&amp;lt;path to aggregator proxy key&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;官方警告: 除非你了解保护 CA 使用的风险和机制, 否则不要在不通上下文中重用已经使用过的 CA&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;如果 kube-proxy 没有和 API server 运行在同一台主机上，那么需要确保启用了如下 apiserver 标记：&lt;code&gt;--enable-aggregator-routing=true&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;客户端 ---发起请求---&amp;gt; 代理 ---Add Header:发起请求---&amp;gt; kube-apiserver&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                   (客户端证书)                        (服务端证书)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;kube-apiserver 代理根证书(客户端证书)&lt;/p&gt;
&lt;p&gt;用在&lt;code&gt;requestheader-client-ca-file&lt;/code&gt;配置选项中, kube-apiserver 使用该证书来验证客户端证书是否为自己所签发&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;/etc/kubernetes/pki/front-proxy-ca.crt&lt;/li&gt;
&lt;li&gt;/etc/kubernetes/pki/front-proxy-ca.key&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;由此根证书签发的证书只有一组:&lt;/p&gt;
&lt;p&gt;代理层(如汇聚层aggregator)使用此套代理证书来向 kube-apiserver 请求认证&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;代理端使用的客户端证书, 用作代用户与 kube-apiserver 认证&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;/etc/kubernetes/pki/front-proxy-client.crt&lt;/li&gt;
&lt;li&gt;/etc/kubernetes/pki/front-proxy-client.key&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考文档:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;kube-apiserver 配置参数: &lt;a href=&quot;https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;使用汇聚层扩展 Kubernetes API: &lt;a href=&quot;https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;配置汇聚层: &lt;a href=&quot;https://kubernetes.io/docs/tasks/access-kubernetes-api/configure-aggregation-layer/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/tasks/access-kubernetes-api/configure-aggregation-layer&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;至此, 刨除代理专用的证书外, 还剩下 16-4=12 个文件&lt;/p&gt;
&lt;h3 id=&quot;etcd-集群根证书&quot;&gt;&lt;a href=&quot;#etcd-集群根证书&quot; class=&quot;headerlink&quot; title=&quot;etcd 集群根证书&quot;&gt;&lt;/a&gt;etcd 集群根证书&lt;/h3&gt;&lt;p&gt;etcd集群所用到的证书都保存在&lt;code&gt;/etc/kubernetes/pki/etcd&lt;/code&gt;这路径下, 很明显, 这一套证书是用来专门给etcd集群服务使用的, 设计以下证书文件&lt;/p&gt;
&lt;p&gt;etcd 集群根证书CA(etcd 所用到的所有证书的签发机构)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;/etc/kubernetes/pki/etcd/ca.crt&lt;/li&gt;
&lt;li&gt;/etc/kubernetes/pki/etcd/ca.key&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;由此根证书签发机构签发的证书有:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;etcd server 持有的服务端证书&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;/etc/kubernetes/pki/etcd/server.crt&lt;/li&gt;
&lt;li&gt;/etc/kubernetes/pki/etcd/server.key&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;peer 集群中节点互相通信使用的客户端证书&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;/etc/kubernetes/pki/etcd/peer.crt&lt;/li&gt;
&lt;li&gt;/etc/kubernetes/pki/etcd/peer.key&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;注: Peer：对同一个etcd集群中另外一个Member的称呼&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;pod 中定义 Liveness 探针使用的客户端证书&lt;br&gt; kubeadm 部署的 Kubernetes 集群是以 pod 的方式运行 etcd 服务的, 在该 pod 的定义中, 配置了 Liveness 探活探针&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;/etc/kubernetes/pki/etcd/healthcheck-client.crt&lt;/li&gt;
&lt;li&gt;/etc/kubernetes/pki/etcd/healthcheck-client.key&lt;br&gt;当你 describe etcd 的 pod 时, 会看到如下一行配置:&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Liveness:       &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; [/bin/sh -ec ETCDCTL_API=3 etcdctl --endpoints=https://[127.0.0.1]:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt --key=/etc/kubernetes/pki/etcd/healthcheck-client.key get foo] delay=15s timeout=15s period=10s &lt;span class=&quot;comment&quot;&gt;#success=1 #failure=8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;配置在 kube-apiserver 中用来与 etcd server 做双向认证的客户端证书&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;/etc/kubernetes/pki/apiserver-etcd-client.crt&lt;/li&gt;
&lt;li&gt;/etc/kubernetes/pki/apiserver-etcd-client.key&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;至此, 介绍了涉及到 etcd 服务的10个证书文件, 12-10=2, 仅剩两个没有介绍到的文件啦, 胜利在望, 坚持一下~&lt;/p&gt;
&lt;h3 id=&quot;Serveice-Account秘钥&quot;&gt;&lt;a href=&quot;#Serveice-Account秘钥&quot; class=&quot;headerlink&quot; title=&quot;Serveice Account秘钥&quot;&gt;&lt;/a&gt;Serveice Account秘钥&lt;/h3&gt;&lt;p&gt;最后介绍的这组”证书”其实不是证书, 而是一组秘钥. 看着后缀名是不是有点眼熟呢, 没错, 这组秘钥对儿其实跟我们在Linux上创建, 用于免密登录的密钥对儿原理是一样的~&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;这组的密钥对儿仅提供给 kube-controller-manager 使用. kube-controller-manager 通过 sa.key 对 token 进行签名, master 节点通过公钥 sa.pub 进行签名的验证&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;/etc/kubernetes/pki/sa.key&lt;/li&gt;
&lt;li&gt;/etc/kubernetes/pki/sa.pub&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;至此, kubeadm 工具帮我们创建的所有证书文件都已经介绍完了, 整个 Kubernetes&amp;amp;etcd 集群中所涉及到的绝大部分证书都差不多在这里了. 有的行家可能会看出来, 至少还少了一组证书呀, 就是 kube-proxy 持有的证书怎么没有自动生成呀. 因为 kubeadm 创建的集群, kube-proxy 是以 pod 形式运行的, 在 pod 中, 直接使用 service account 与 kube-apiserver 进行认证, 此时就不需要再单独为 kube-proxy 创建证书了. 如果你的 kube-proxy 是以守护进程的方式直接运行在宿主机的, 那么你就需要为它创建一套证书了. 创建的方式也很简单, 直接使用上面第一条提到的 &lt;code&gt;Kubernetes 集群根证书&lt;/code&gt; 进行签发就可以了(注意CN和O的设置)&lt;/p&gt;
&lt;p&gt;参考文档:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.io/docs/setup/certificates/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/setup/certificates/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.io/docs/setup/independent/setup-ha-etcd-with-kubeadm/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/setup/independent/setup-ha-etcd-with-kubeadm/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;docs.lvrui.io&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;如果你使用过kubeadm部署过Kubernetes的环境, master主机节点上就一定会在相应的目录创建了一大批证书文件, 本篇文章就来说说kubeadm到底为我们生成了哪些证书&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在Kubernetes的部署中, 创建证书, 配置证书是一道绕不过去坎儿, 好在有kubeadm这样的自动化工具, 帮我们去生成, 配置这些证书. 对于只是想体验Kubernetes或只是想测试的亲来说, 这已经够了, 但是作为Kubernetes的集群维护者来说, kubeadm更像是一个黑盒, 本篇文章就来说说黑盒中关于证书的事儿~&lt;/p&gt;
&lt;p&gt;使用kubeadm创建完Kubernetes集群后, 默认会在&lt;code&gt;/etc/kubernetes/pki&lt;/code&gt;目录下存放集群中需要用到的证书文件, 整体结构如下图所示:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;root@k8s-master:/etc/kubernetes/pki&lt;span class=&quot;comment&quot;&gt;# tree&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- apiserver.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- apiserver-etcd-client.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- apiserver-etcd-client.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- apiserver.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- apiserver-kubelet-client.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- apiserver-kubelet-client.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- etcd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- healthcheck-client.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- healthcheck-client.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- peer.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- peer.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- server.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   `-- server.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- front-proxy-ca.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- front-proxy-ca.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- front-proxy-client.crt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- front-proxy-client.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- sa.key&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;`-- sa.pub&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1 directory, 22 files&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;以上22个文件就是kubeadm为我们创建的所有证书相关的文件, 下面我们来一一解析&lt;/p&gt;
&lt;h3 id=&quot;证书分组&quot;&gt;&lt;a href=&quot;#证书分组&quot; class=&quot;headerlink&quot; title=&quot;证书分组&quot;&gt;&lt;/a&gt;证书分组&lt;/h3&gt;&lt;p&gt;Kubernetes把证书放在了两个文件夹中&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;/etc/kubernetes/pki&lt;/li&gt;
&lt;li&gt;/etc/kubernetes/pki/etcd&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们再将这22个文件按照更细的粒度去分组&lt;br&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="kubeadm" scheme="http://icyxp.github.io/categories/kubernetes/kubeadm/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="kubeadm" scheme="http://icyxp.github.io/tags/kubeadm/"/>
    
      <category term="证书" scheme="http://icyxp.github.io/tags/%E8%AF%81%E4%B9%A6/"/>
    
  </entry>
  
  <entry>
    <title>Kubeadm证书过期时间调整</title>
    <link href="http://icyxp.github.io//blog/2018/12/k8s-kubeadm-ca-upgdate.html"/>
    <id>http://icyxp.github.io//blog/2018/12/k8s-kubeadm-ca-upgdate.html</id>
    <published>2018-12-11T12:00:00.000Z</published>
    <updated>2019-03-20T01:30:27.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt; kubeadm 默认证书为一年，一年过期后，会导致api service不可用，使用过程中会出现：x509: certificate has expired or is not yet valid&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;如何进行调整，下面给了两个方案，供大家选择&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;方案一-通过修改kubeadm-调整证书过期时间&quot;&gt;&lt;a href=&quot;#方案一-通过修改kubeadm-调整证书过期时间&quot; class=&quot;headerlink&quot; title=&quot;方案一 通过修改kubeadm 调整证书过期时间&quot;&gt;&lt;/a&gt;方案一 通过修改kubeadm 调整证书过期时间&lt;/h3&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h4 id=&quot;修改代码，调整过期时间&quot;&gt;&lt;a href=&quot;#修改代码，调整过期时间&quot; class=&quot;headerlink&quot; title=&quot;修改代码，调整过期时间&quot;&gt;&lt;/a&gt;修改代码，调整过期时间&lt;/h4&gt;&lt;p&gt; 克隆代码：&lt;code&gt;git clone https://github.com/kubernetes/kubernetes.git&lt;/code&gt;, 切换到指定的tag或者版本修改&lt;code&gt;vendor/k8s.io/client-go/util/cert/cert.go&lt;/code&gt;文件，&lt;code&gt;git diff&lt;/code&gt; 对比如下：&lt;br&gt;&lt;figure class=&quot;highlight diff&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;diff --git a/staging/src/k8s.io/client-go/util/cert/cert.go b/staging/src/k8s.io/client-go/util/cert/cert.go&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;index fb7f5fa..e800962 100644&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;--- a/staging/src/k8s.io/client-go/util/cert/cert.go&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;+++ b/staging/src/k8s.io/client-go/util/cert/cert.go&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@@ -104,7 +104,7 @@ func NewSignedCert(cfg Config, key *rsa.PrivateKey, caCert *x509.Certificate, ca&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                IPAddresses:  cfg.AltNames.IPs,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                SerialNumber: serial,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                NotBefore:    caCert.NotBefore,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-               NotAfter:     time.Now().Add(duration365d).UTC(),&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+               NotAfter:     time.Now().Add(duration365d * 10).UTC(),&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                KeyUsage:     x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                ExtKeyUsage:  cfg.Usages,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@@ -149,7 +149,7 @@ func GenerateSelfSignedCertKey(host string, alternateIPs []net.IP, alternateDNS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        CommonName: fmt.Sprintf(&quot;%s-ca@%d&quot;, host, time.Now().Unix()),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                NotBefore: time.Now(),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-               NotAfter:  time.Now().Add(time.Hour * 24 * 365),&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+               NotAfter:  time.Now().Add(time.Hour * 24 * 3650),&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                KeyUsage:              x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature | x509.KeyUsageCertSign,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                BasicConstraintsValid: true,&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;编译代码&quot;&gt;&lt;a href=&quot;#编译代码&quot; class=&quot;headerlink&quot; title=&quot;编译代码&quot;&gt;&lt;/a&gt;编译代码&lt;/h4&gt;&lt;p&gt;编译环境我已经做了对应的1.11.5、1.12.3、1.13.0、1.13.2、1.13.4，已上传到docker hub 上，大家可下载使用，地址如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker pull icyboy/k8s_build:v1.11.5  &lt;span class=&quot;comment&quot;&gt;# 基于 golang:1.10.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull icyboy/k8s_build:v1.12.3  &lt;span class=&quot;comment&quot;&gt;# 基于 golang:1.10.4 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull icyboy/k8s_build:v1.13.0  &lt;span class=&quot;comment&quot;&gt;# 基于 golang:1.11.2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull icyboy/k8s_build:v1.13.2  &lt;span class=&quot;comment&quot;&gt;# 基于 golang:1.11.4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker pull icyboy/k8s_build:v1.13.4  &lt;span class=&quot;comment&quot;&gt;# 基于 golang:1.11.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;编译&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker run --rm -v 你修改后的代码目录:/go/src/k8s.io/kubernetes -it icyboy/k8s_build:v1.11.5 bash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /go/src/k8s.io/kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 编译kubeadm, 这里主要编译kubeadm 即可&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;make all WHAT=cmd/kubeadm GOFLAGS=-v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 编译kubelet&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# make all WHAT=cmd/kubelet GOFLAGS=-v&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 编译kubectl&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# make all WHAT=cmd/kubectl GOFLAGS=-v&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#编译完产物在 _output/bin/kubeadm 目录下&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#将kubeadm 文件拷贝出来，替换系统中的kubeadm&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;对应的kubeadm 文件我也编译好后放到百度云中，大家可放心下载使用，可通过&lt;code&gt;kubeadm version&lt;/code&gt; 查看对应的版本信息和官方的进行比对&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#编译过后的&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm version: &amp;amp;version.Info&amp;#123;Major:&lt;span class=&quot;string&quot;&gt;&quot;1&quot;&lt;/span&gt;, Minor:&lt;span class=&quot;string&quot;&gt;&quot;11+&quot;&lt;/span&gt;, GitVersion:&lt;span class=&quot;string&quot;&gt;&quot;v1.11.5-dirty&quot;&lt;/span&gt;, GitCommit:&lt;span class=&quot;string&quot;&gt;&quot;753b2dbc622f5cc417845f0ff8a77f539a4213ea&quot;&lt;/span&gt;, GitTreeState:&lt;span class=&quot;string&quot;&gt;&quot;dirty&quot;&lt;/span&gt;, BuildDate:&lt;span class=&quot;string&quot;&gt;&quot;2018-12-07T05:58:18Z&quot;&lt;/span&gt;, GoVersion:&lt;span class=&quot;string&quot;&gt;&quot;go1.10.3&quot;&lt;/span&gt;, Compiler:&lt;span class=&quot;string&quot;&gt;&quot;gc&quot;&lt;/span&gt;, Platform:&lt;span class=&quot;string&quot;&gt;&quot;linux/amd64&quot;&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#官方的&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm version: &amp;amp;version.Info&amp;#123;Major:&lt;span class=&quot;string&quot;&gt;&quot;1&quot;&lt;/span&gt;, Minor:&lt;span class=&quot;string&quot;&gt;&quot;11&quot;&lt;/span&gt;, GitVersion:&lt;span class=&quot;string&quot;&gt;&quot;v1.11.5&quot;&lt;/span&gt;, GitCommit:&lt;span class=&quot;string&quot;&gt;&quot;753b2dbc622f5cc417845f0ff8a77f539a4213ea&quot;&lt;/span&gt;, GitTreeState:&lt;span class=&quot;string&quot;&gt;&quot;clean&quot;&lt;/span&gt;, BuildDate:&lt;span class=&quot;string&quot;&gt;&quot;2018-11-26T14:38:30Z&quot;&lt;/span&gt;, GoVersion:&lt;span class=&quot;string&quot;&gt;&quot;go1.10.3&quot;&lt;/span&gt;, Compiler:&lt;span class=&quot;string&quot;&gt;&quot;gc&quot;&lt;/span&gt;, Platform:&lt;span class=&quot;string&quot;&gt;&quot;linux/amd64&quot;&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;kubeadm 下载地址：&lt;a href=&quot;https://pan.baidu.com/s/1PplHyDkYDTusx46j9uHwDA&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://pan.baidu.com/s/1PplHyDkYDTusx46j9uHwDA&lt;/a&gt;&lt;br&gt;提取码：dy6f&lt;/p&gt;
&lt;h4 id=&quot;替换证书&quot;&gt;&lt;a href=&quot;#替换证书&quot; class=&quot;headerlink&quot; title=&quot;替换证书&quot;&gt;&lt;/a&gt;替换证书&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#用新的kubeadm 替换官方的kubeadm&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;chmod +x kubeadm &amp;amp;&amp;amp; \cp &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; kubeadm /usr/bin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#备份原有的证书&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mv /etc/kubernetes/pki /etc/kubernetes/pki.old&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#生成新的证书，kubeadm.yaml 指定你自己服务器上的&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase certs all --config  ~/kubeadm.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#备份原有的conf文件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mv /etc/kubernetes/*conf /etc/kubernetes/*conf-old&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#根据新证书重新生成新的配置文件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubeadm alpha phase kubeconfig all --config ~/kubeadm.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#替换老的config文件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;\cp &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; /etc/kubernetes/admin.conf ~/.kube/config&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;验证&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /etc/kubernetes/pki&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;openssl x509 -in apiserver-etcd-client.crt -text -noout&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#Certificate:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#    Data:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#        Version: 3 (0x2)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#        Serial Number: 2755977466456048186 (0x263f32e76918023a)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#    Signature Algorithm: sha256WithRSAEncryption&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#        Issuer: CN=kubernetes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#        Validity&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#            Not Before: Dec  7 09:33:32 2018 GMT&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             Not After : Dec  4 09:33:32 2028 GMT  &lt;span class=&quot;comment&quot;&gt;#这里变成10年了&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#        Subject: O=system:masters, CN=kube-apiserver-etcd-client&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#        Subject Public Key Info:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#        ....&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 其余证书安装上述方法同样进行验证&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;方案二-启用自动轮换kubelet-证书&quot;&gt;&lt;a href=&quot;#方案二-启用自动轮换kubelet-证书&quot; class=&quot;headerlink&quot; title=&quot;方案二 启用自动轮换kubelet 证书&quot;&gt;&lt;/a&gt;方案二 启用自动轮换kubelet 证书&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;kubelet证书分为server和client两种， &lt;code&gt;k8s 1.9&lt;/code&gt;默认启用了client证书的自动轮换，但server证书自动轮换需要用户开启&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;增加-kubelet-参数&quot;&gt;&lt;a href=&quot;#增加-kubelet-参数&quot; class=&quot;headerlink&quot; title=&quot;增加 kubelet 参数&quot;&gt;&lt;/a&gt;增加 kubelet 参数&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在/etc/systemd/system/kubelet.service.d/10-kubeadm.conf 增加如下参数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Environment=&lt;span class=&quot;string&quot;&gt;&quot;KUBELET_EXTRA_ARGS=--feature-gates=RotateKubeletServerCertificate=true&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;增加-controller-manager-参数&quot;&gt;&lt;a href=&quot;#增加-controller-manager-参数&quot; class=&quot;headerlink&quot; title=&quot;增加 controller-manager 参数&quot;&gt;&lt;/a&gt;增加 controller-manager 参数&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在/etc/kubernetes/manifests/kube-controller-manager.yaml 添加如下参数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - &lt;span class=&quot;built_in&quot;&gt;command&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - kube-controller-manager&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - --experimental-cluster-signing-duration=87600h0m0s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - --feature-gates=RotateKubeletServerCertificate=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - ....&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;创建-rbac-对象&quot;&gt;&lt;a href=&quot;#创建-rbac-对象&quot; class=&quot;headerlink&quot; title=&quot;创建 rbac 对象&quot;&gt;&lt;/a&gt;创建 rbac 对象&lt;/h4&gt;&lt;p&gt;创建rbac对象，允许节点轮换kubelet server证书：&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cat &amp;gt; ca-update.yaml &amp;lt;&amp;lt; EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; rbac.authorization.k8s.io/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ClusterRole&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  annotations:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    rbac.authorization.kubernetes.io/autoupdate: &lt;span class=&quot;string&quot;&gt;&quot;true&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    kubernetes.io/bootstrapping: rbac-defaults&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; system:certificates.k8s.io:certificatesigningrequests:selfnodeserver&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;rules:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; certificates.k8s.io&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; certificatesigningrequests/selfnodeserver&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; create&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; rbac.authorization.k8s.io/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ClusterRoleBinding&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; kubeadm:node-autoapprove-certificate-server&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;roleRef:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  apiGroup:&lt;/span&gt; rbac.authorization.k8s.io&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  kind:&lt;/span&gt; ClusterRole&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; system:certificates.k8s.io:certificatesigningrequests:selfnodeserver&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;subjects:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- apiGroup:&lt;/span&gt; rbac.authorization.k8s.io&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  kind:&lt;/span&gt; Group&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; system:nodes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl create –f ca-update.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;离线一键安装包&quot;&gt;&lt;a href=&quot;#离线一键安装包&quot; class=&quot;headerlink&quot; title=&quot;离线一键安装包&quot;&gt;&lt;/a&gt;离线一键安装包&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;k8s 离线一键安装包教程&amp;amp;&amp;amp;地址：&lt;a href=&quot;http://team.jiunile.com/pro/k8s/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;一键安装&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt; kubeadm 默认证书为一年，一年过期后，会导致api service不可用，使用过程中会出现：x509: certificate has expired or is not yet valid&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;如何进行调整，下面给了两个方案，供大家选择&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;方案一-通过修改kubeadm-调整证书过期时间&quot;&gt;&lt;a href=&quot;#方案一-通过修改kubeadm-调整证书过期时间&quot; class=&quot;headerlink&quot; title=&quot;方案一 通过修改kubeadm 调整证书过期时间&quot;&gt;&lt;/a&gt;方案一 通过修改kubeadm 调整证书过期时间&lt;/h3&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
      <category term="kubeadm" scheme="http://icyxp.github.io/categories/kubernetes/kubeadm/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="kubeadm" scheme="http://icyxp.github.io/tags/kubeadm/"/>
    
      <category term="证书过期" scheme="http://icyxp.github.io/tags/%E8%AF%81%E4%B9%A6%E8%BF%87%E6%9C%9F/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Pod 的生命周期管理</title>
    <link href="http://icyxp.github.io//blog/2018/11/k8s-k8s-pod-life-cycle.html"/>
    <id>http://icyxp.github.io//blog/2018/11/k8s-k8s-pod-life-cycle.html</id>
    <published>2018-11-30T06:30:00.000Z</published>
    <updated>2018-12-03T02:14:29.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Pod的生命周期&quot;&gt;&lt;a href=&quot;#Pod的生命周期&quot; class=&quot;headerlink&quot; title=&quot;Pod的生命周期&quot;&gt;&lt;/a&gt;Pod的生命周期&lt;/h2&gt;&lt;hr&gt;
&lt;h3 id=&quot;Pod-phase&quot;&gt;&lt;a href=&quot;#Pod-phase&quot; class=&quot;headerlink&quot; title=&quot;Pod phase&quot;&gt;&lt;/a&gt;Pod phase&lt;/h3&gt;&lt;p&gt;Pod 的 status 在信息保存在 &lt;a href=&quot;https://github.com/kubernetes/kubernetes/blob/3ae0b84e0b114692dc666d9486fb032d8a33bb58/pkg/api/types.go#L2471&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;PodStatus&lt;/a&gt; 中定义，其中有一个 phase 字段。&lt;/p&gt;
&lt;p&gt;Pod 的相位（phase）是 Pod 在其生命周期中的简单宏观概述。该阶段并不是对容器或 Pod 的综合汇总，也不是为了做为综合状态机。&lt;/p&gt;
&lt;p&gt;Pod 相位的数量和含义是严格指定的。除了本文档中列举的状态外，不应该再假定 Pod 有其他的 phase 值。&lt;/p&gt;
&lt;p&gt;无论你是手动创建 Pod，还是通过 deployment、daemonset 或 statefulset来创建，Pod 的 phase 都有以下几个可能的值：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;挂起（Pending）&lt;/strong&gt;：Pod 已被 Kubernetes 系统接受，但有一个或者多个容器镜像尚未创建。等待时间包括调度 Pod 的时间和通过网络下载镜像的时间，这可能需要花点时间。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;运行中（Running）&lt;/strong&gt;：该 Pod 已经绑定到了一个节点上，Pod 中所有的容器都已被创建。至少有一个容器正在运行，或者正处于启动或重启状态。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;成功（Successed）&lt;/strong&gt;：Pod 中的所有容器都被成功终止，并且不会再重启。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;失败（Failed）&lt;/strong&gt;：Pod 中的所有容器都已终止了，并且至少有一个容器是因为失败终止。也就是说，容器以非0状态退出或者被系统终止。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;未知（Unkonwn）&lt;/strong&gt;：因为某些原因无法取得 Pod 的状态，通常是因为与 Pod 所在主机通信失败。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;下图是 Pod 的生命周期示意图，从图中可以看到 Pod 状态的变化。&lt;br&gt;&lt;img src=&quot;/images/k8s/k8s_pod_01.jpg&quot; alt=&quot;K8s pod 生命周期&quot;&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;Pod-状态&quot;&gt;&lt;a href=&quot;#Pod-状态&quot; class=&quot;headerlink&quot; title=&quot;Pod 状态&quot;&gt;&lt;/a&gt;Pod 状态&lt;/h3&gt;&lt;p&gt;Pod 有一个 PodStatus 对象，其中包含一个 &lt;a href=&quot;https://github.com/kubernetes/kubernetes/blob/3ae0b84e0b114692dc666d9486fb032d8a33bb58/pkg/api/types.go#L1964&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;PodCondition&lt;/a&gt; 数组。 PodCondition 数组的每个元素都有一个 type 字段和一个 status 字段。type 字段是字符串，可能的值有 &lt;code&gt;PodScheduled&lt;/code&gt;、&lt;code&gt;Ready&lt;/code&gt;、&lt;code&gt;Initialized&lt;/code&gt; 和 &lt;code&gt;Unschedulable&lt;/code&gt;。status 字段是一个字符串，可能的值有 &lt;code&gt;True&lt;/code&gt;、&lt;code&gt;False&lt;/code&gt; 和 &lt;code&gt;Unknown&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;当你通过 &lt;code&gt;kubectl get pod&lt;/code&gt; 查看 Pod 时，&lt;code&gt;STATUS&lt;/code&gt; 这一列可能会显示与上述5个状态不同的值，例如 &lt;code&gt;Init:0/1&lt;/code&gt; 和 &lt;code&gt;CrashLoopBackOff&lt;/code&gt;。这是因为 Pod 状态的定义除了包含 phase 之外，还有 &lt;code&gt;InitContainerStatuses&lt;/code&gt; 和 &lt;code&gt;containerStatuses&lt;/code&gt; 等其他字段，具体代码参考 &lt;a href=&quot;https://github.com/kubernetes/kubernetes/blob/3ae0b84e0b114692dc666d9486fb032d8a33bb58/pkg/api/types.go#L2471&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;overall status of a pod&lt;/a&gt; .&lt;/p&gt;
&lt;p&gt;如果想知道究竟发生了什么，可以通过命令 &lt;code&gt;kubectl describe pod/$PODNAME&lt;/code&gt; 查看输出信息的 &lt;code&gt;Events&lt;/code&gt; 条目。通过 Events 条目可以看到一些具体的信息，比如正在拉取容器镜像，Pod 已经被调度，或者某个 container 处于 unhealthy 状态。&lt;/p&gt;
&lt;h2 id=&quot;Pod-的启动关闭流程&quot;&gt;&lt;a href=&quot;#Pod-的启动关闭流程&quot; class=&quot;headerlink&quot; title=&quot;Pod 的启动关闭流程&quot;&gt;&lt;/a&gt;Pod 的启动关闭流程&lt;/h2&gt;&lt;hr&gt;
&lt;p&gt;下面通过一个具体的示例来探究一下 Pod 的整个生命周期流程。为了确定事情发生的顺序，通过下面的 manifest 来部署一个 deployment。&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt;                   Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt;             apps/v1beta1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt;                 loap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  replicas:&lt;/span&gt;             &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  template:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        app:&lt;/span&gt;            loap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      initContainers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - name:&lt;/span&gt;           init&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        image:&lt;/span&gt;          busybox&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        command:&lt;/span&gt;       [&lt;span class=&quot;string&quot;&gt;&#39;sh&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;-c&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;echo $(date +%s): INIT &amp;gt;&amp;gt; /loap/timing&#39;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        volumeMounts:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - mountPath:&lt;/span&gt;    /loap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          name:&lt;/span&gt;         timing&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - name:&lt;/span&gt;           main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        image:&lt;/span&gt;          busybox&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        command:&lt;/span&gt;       [&lt;span class=&quot;string&quot;&gt;&#39;sh&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;-c&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;echo $(date +%s): START &amp;gt;&amp;gt; /loap/timing;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sleep 10; echo $(date +%s): END &amp;gt;&amp;gt; /loap/timing;&#39;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        volumeMounts:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - mountPath:&lt;/span&gt;    /loap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          name:&lt;/span&gt;         timing&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        livenessProbe:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          exec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            command:&lt;/span&gt;   [&lt;span class=&quot;string&quot;&gt;&#39;sh&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;-c&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;echo $(date +%s): LIVENESS &amp;gt;&amp;gt; /loap/timing&#39;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        readinessProbe:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          exec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            command:&lt;/span&gt;   [&lt;span class=&quot;string&quot;&gt;&#39;sh&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;-c&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;echo $(date +%s): READINESS &amp;gt;&amp;gt; /loap/timing&#39;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        lifecycle:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          postStart:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            exec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;              command:&lt;/span&gt;   [&lt;span class=&quot;string&quot;&gt;&#39;sh&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;-c&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;echo $(date +%s): POST-START &amp;gt;&amp;gt; /loap/timing&#39;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          preStop:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            exec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;              command:&lt;/span&gt;  [&lt;span class=&quot;string&quot;&gt;&#39;sh&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;-c&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;echo $(date +%s): PRE-HOOK &amp;gt;&amp;gt; /loap/timing&#39;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      volumes:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - name:&lt;/span&gt;           timing&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        hostPath:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          path:&lt;/span&gt;         /tmp/loap&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;等待 Pod 状态变为 &lt;code&gt;Running&lt;/code&gt; 之后，通过以下命令来强制停止 Pod：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl scale deployment loap --replicas=0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看 &lt;code&gt;/tmp/loap/timing&lt;/code&gt; 文件的内容：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /tmp/loap/timing&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1525334577: INIT&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1525334581: START&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1525334581: POST-START&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1525334584: READINESS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1525334584: LIVENESS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1525334588: PRE-HOOK&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1525334589: END&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;/tmp/loap/timing&lt;/code&gt; 文件的内容很好地体现了 Pod 的启动和关闭流程，具体过程如下：&lt;br&gt;&lt;img src=&quot;/images/k8s/k8s_pod_02.jpg&quot; alt=&quot;Pod 的启动和关闭流程&quot;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;首先启动一个 Infra 容器（又叫 Pause 容器），用来和 Pod 中的其他容器共享 linux 命名空间，并开启 init 进程。（上图中忽略了这一步）&lt;/li&gt;
&lt;li&gt;然后启动 Init 容器，它是一种专用的容器，在应用程序容器启动之前运行，用来对 Pod 进行一些初始化操作，并包括一些应用镜像中不存在的实用工具和安装脚本。&lt;/li&gt;
&lt;li&gt;4 秒之后，应用程序容器和 &lt;code&gt;post-start hook&lt;/code&gt; 同时启动。&lt;/li&gt;
&lt;li&gt;7 秒之后开始启动 &lt;a href=&quot;https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;liveness 和 readiness 探针&lt;/a&gt;。&lt;/li&gt;
&lt;li&gt;11 秒之后，通过手动杀掉 Pod，&lt;code&gt;pre-stop hook&lt;/code&gt; 执行，优雅删除期限过期后（默认是 30 秒），应用程序容器停止。实际的 Pod 终止过程要更复杂，具体参考 &lt;a href=&quot;https://jimmysong.io/kubernetes-handbook/concepts/pod.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Pod 的终止&lt;/a&gt;。&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;必须主动杀掉 Pod 才会触发 &lt;code&gt;pre-stop hook&lt;/code&gt;，如果是 Pod 自己 Down 掉，则不会执行 &lt;code&gt;pre-stop hook&lt;/code&gt;。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;如何快速-DEBUG&quot;&gt;&lt;a href=&quot;#如何快速-DEBUG&quot; class=&quot;headerlink&quot; title=&quot;如何快速 DEBUG&quot;&gt;&lt;/a&gt;如何快速 DEBUG&lt;/h2&gt;&lt;hr&gt;
&lt;p&gt;当 Pod 出现致命的错误时，如果能够快速 DEBUG，将会帮助我们快速定位问题。为了实现这个目的，可以把把致命事件的信息通过 &lt;code&gt;.spec.terminationMessagePath&lt;/code&gt; 配置写入指定位置的文件，就像打印错误、异常和堆栈信息一样。该位置的内容可以很方便的通过 dashboards、监控软件等工具检索和展示，默认路径为 &lt;code&gt;/dev/termination-log&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;以下是一个小例子：&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# termination-demo.yaml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; termination-demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; termination-demo-container&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    image:&lt;/span&gt; alpine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    command:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;/bin/sh&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    args:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;-c&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;sleep 10 &amp;amp;&amp;amp; echo Sleep expired &amp;gt; /dev/termination-log&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这些消息的最后部分会使用其他的规定来单独存储：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl create &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; termination-demo.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sleep 20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pod termination-demo -o go-template=&lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;&amp;#123;range .status.containerStatuses&amp;#125;&amp;#125;&amp;#123;&amp;#123;.lastState.terminated.message&amp;#125;&amp;#125;&amp;#123;&amp;#123;end&amp;#125;&amp;#125;&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Sleep expired&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pod termination-demo -o go-template=&lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;&amp;#123;range .status.containerStatuses&amp;#125;&amp;#125;&amp;#123;&amp;#123;.lastState.terminated.exitCode&amp;#125;&amp;#125;&amp;#123;&amp;#123;end&amp;#125;&amp;#125;&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h2&gt;&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://jimmysong.io/kubernetes-handbook/concepts/pod-hook.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Pod hook&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://blog.openshift.com/kubernetes-pods-life/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kubernetes: A Pod’s Life&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://k8smeetup.github.io/docs/tasks/debug-application-cluster/determine-reason-pod-failure/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;确定 Pod 失败的原因&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Ryan Yang &lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Pod的生命周期&quot;&gt;&lt;a href=&quot;#Pod的生命周期&quot; class=&quot;headerlink&quot; title=&quot;Pod的生命周期&quot;&gt;&lt;/a&gt;Pod的生命周期&lt;/h2&gt;&lt;hr&gt;
&lt;h3 id=&quot;Pod-phase&quot;&gt;&lt;a href=&quot;#Pod-phase&quot; class=&quot;headerlink&quot; title=&quot;Pod phase&quot;&gt;&lt;/a&gt;Pod phase&lt;/h3&gt;&lt;p&gt;Pod 的 status 在信息保存在 &lt;a href=&quot;https://github.com/kubernetes/kubernetes/blob/3ae0b84e0b114692dc666d9486fb032d8a33bb58/pkg/api/types.go#L2471&quot;&gt;PodStatus&lt;/a&gt; 中定义，其中有一个 phase 字段。&lt;/p&gt;
&lt;p&gt;Pod 的相位（phase）是 Pod 在其生命周期中的简单宏观概述。该阶段并不是对容器或 Pod 的综合汇总，也不是为了做为综合状态机。&lt;/p&gt;
&lt;p&gt;Pod 相位的数量和含义是严格指定的。除了本文档中列举的状态外，不应该再假定 Pod 有其他的 phase 值。&lt;/p&gt;
&lt;p&gt;无论你是手动创建 Pod，还是通过 deployment、daemonset 或 statefulset来创建，Pod 的 phase 都有以下几个可能的值：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;挂起（Pending）&lt;/strong&gt;：Pod 已被 Kubernetes 系统接受，但有一个或者多个容器镜像尚未创建。等待时间包括调度 Pod 的时间和通过网络下载镜像的时间，这可能需要花点时间。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;运行中（Running）&lt;/strong&gt;：该 Pod 已经绑定到了一个节点上，Pod 中所有的容器都已被创建。至少有一个容器正在运行，或者正处于启动或重启状态。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;成功（Successed）&lt;/strong&gt;：Pod 中的所有容器都被成功终止，并且不会再重启。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;失败（Failed）&lt;/strong&gt;：Pod 中的所有容器都已终止了，并且至少有一个容器是因为失败终止。也就是说，容器以非0状态退出或者被系统终止。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;未知（Unkonwn）&lt;/strong&gt;：因为某些原因无法取得 Pod 的状态，通常是因为与 Pod 所在主机通信失败。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;下图是 Pod 的生命周期示意图，从图中可以看到 Pod 状态的变化。&lt;br&gt;&lt;img src=&quot;/images/k8s/k8s_pod_01.jpg&quot; alt=&quot;K8s pod 生命周期&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/categories/kubernetes/"/>
    
    
      <category term="k8s" scheme="http://icyxp.github.io/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://icyxp.github.io/tags/kubernetes/"/>
    
      <category term="pod" scheme="http://icyxp.github.io/tags/pod/"/>
    
  </entry>
  
  <entry>
    <title>Java和Docker限制的那些事儿</title>
    <link href="http://icyxp.github.io//blog/2018/07/docker-java%E4%B8%8Edocker%E7%9A%84%E9%82%A3%E7%82%B9%E4%BA%8B.html"/>
    <id>http://icyxp.github.io//blog/2018/07/docker-java与docker的那点事.html</id>
    <published>2018-07-18T13:30:00.000Z</published>
    <updated>2018-07-18T13:27:38.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;揭秘&quot;&gt;&lt;a href=&quot;#揭秘&quot; class=&quot;headerlink&quot; title=&quot;揭秘&quot;&gt;&lt;/a&gt;揭秘&lt;/h2&gt;&lt;p&gt;Java和Docker不是天然的朋友。 Docker可以设置内存和CPU限制，而Java不能自动检测到。使用Java的Xmx标识（繁琐/重复）或新的实验性JVM标识，我们可以解决这个问题。&lt;/p&gt;
&lt;h2 id=&quot;虚拟化中的不匹配&quot;&gt;&lt;a href=&quot;#虚拟化中的不匹配&quot; class=&quot;headerlink&quot; title=&quot;虚拟化中的不匹配&quot;&gt;&lt;/a&gt;虚拟化中的不匹配&lt;/h2&gt;&lt;p&gt;Java和Docker的结合并不是完美匹配的，最初的时候离完美匹配有相当大的距离。对于初学者来说，JVM的全部设想就是，虚拟机可以让程序与底层硬件无关。&lt;/p&gt;
&lt;p&gt;那么，把我们的Java应用打包到JVM中，然后整个再塞进Docker容器中，能给我们带来什么好处呢？大多数情况下，你只是在复制JVMs和Linux容器，除了浪费更多的内存，没任何好处。感觉这样子挺傻的。&lt;/p&gt;
&lt;p&gt;不过，Docker可以把你的程序，设置，特定的JDK，Linux设置和应用服务器，还有其他工具打包在一起，当做一个东西。站在DevOps/Cloud的角度来看，这样一个完整的容器有着更高层次的封装。&lt;/p&gt;
&lt;h3 id=&quot;问题一：内存&quot;&gt;&lt;a href=&quot;#问题一：内存&quot; class=&quot;headerlink&quot; title=&quot;问题一：内存&quot;&gt;&lt;/a&gt;问题一：内存&lt;/h3&gt;&lt;p&gt;时至今日，绝大多数产品级应用仍然在使用Java 8（或者更旧的版本），而这可能会带来问题。Java 8（update 131之前的版本）跟Docker无法很好地一起工作。问题是在你的机器上，JVM的可用内存和CPU数量并不是Docker允许你使用的可用内存和CPU数量。&lt;/p&gt;
&lt;p&gt;比如，如果你限制了你的Docker容器只能使用100MB内存，但是呢，旧版本的Java并不能识别这个限制。Java看不到这个限制。JVM会要求更多内存，而且远超这个限制。如果使用太多内存，Docker将采取行动并杀死容器内的进程！JAVA进程被干掉了，很明显，这并不是我们想要的。&lt;/p&gt;
&lt;p&gt;为了解决这个问题，你需要给Java指定一个最大内存限制。在旧版本的Java（8u131之前），你需要在容器中通过设置-Xmx来限制堆大小。这感觉不太对，你可不想定义这些限制两次，也不太想在你的容器中来定义。&lt;/p&gt;
&lt;p&gt;幸运的是我们现在有了更好的方式来解决这个问题。从Java 9之后（8u131+），JVM增加了如下标志：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这些标志强制JVM检查Linux的cgroup配置，Docker是通过cgroup来实现最大内存设置的。现在，如果你的应用到达了Docker设置的限制（比如500MB），JVM是可以看到这个限制的。JVM将会尝试GC操作。如果仍然超过内存限制，JVM就会做它该做的事情，抛出OutOfMemoryException。也就是说，JVM能够看到Docker的这些设置。&lt;/p&gt;
&lt;p&gt;从Java 10之后（参考下面的测试），这些体验标志位是默认开启的，也可以使用-XX:+UseContainerSupport来使能（你可以通过设置-XX:-UseContainerSupport来禁止这些行为）。&lt;/p&gt;
&lt;h3 id=&quot;问题二：CPU&quot;&gt;&lt;a href=&quot;#问题二：CPU&quot; class=&quot;headerlink&quot; title=&quot;问题二：CPU&quot;&gt;&lt;/a&gt;问题二：CPU&lt;/h3&gt;&lt;p&gt;第二个问题是类似的，但它与CPU有关。简而言之，JVM将查看硬件并检测CPU的数量。它会优化你的runtime以使用这些CPUs。但是同样的情况，这里还有另一个不匹配，Docker可能不允许你使用所有这些CPUs。可惜的是，这在Java 8或Java 9中并没有修复，但是在Java 10中得到了解决。&lt;/p&gt;
&lt;p&gt;从Java 10开始，可用的CPUs的计算将采用以不同的方式（默认情况下）解决此问题（同样是通过UseContainerSupport）。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;Java和Docker的内存处理测试&quot;&gt;&lt;a href=&quot;#Java和Docker的内存处理测试&quot; class=&quot;headerlink&quot; title=&quot;Java和Docker的内存处理测试&quot;&gt;&lt;/a&gt;Java和Docker的内存处理测试&lt;/h2&gt;&lt;p&gt;作为一个有趣的练习，让我们验证并测试Docker如何使用几个不同的JVM版本/标志甚至不同的JVM来处理内存不足。&lt;/p&gt;
&lt;p&gt;首先，我们创建一个测试应用程序，它只是简单地“吃”内存并且不释放它。&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.ArrayList;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.List;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MemEat&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String[] args)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        List l = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt; b[] = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;[&lt;span class=&quot;number&quot;&gt;1048576&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            l.add(b);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Runtime rt = Runtime.getRuntime();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            System.out.println( &lt;span class=&quot;string&quot;&gt;&quot;free memory: &quot;&lt;/span&gt; + rt.freeMemory() );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们可以启动Docker容器并运行这个应用程序来查看会发生什么。&lt;/p&gt;
&lt;h3 id=&quot;测试一：Java-8u111&quot;&gt;&lt;a href=&quot;#测试一：Java-8u111&quot; class=&quot;headerlink&quot; title=&quot;测试一：Java 8u111&quot;&gt;&lt;/a&gt;测试一：Java 8u111&lt;/h3&gt;&lt;p&gt;首先，我们将从具有旧版本Java 8的容器开始（update 111）。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker run -m 100m -it java:openjdk-8u111 /bin/bash&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们编译并运行MemEat.java文件：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;javac MemEat.java&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java MemEat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 67194416&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 66145824&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 65097232&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Killed&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;正如所料，Docker已经杀死了我们的Java进程。不是我们想要的（！）。你也可以看到输出，Java认为它仍然有大量的内存需要分配。&lt;/p&gt;
&lt;p&gt;我们可以通过使用-Xmx标志为Java提供最大内存来解决此问题：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;javac MemEat.java&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java -Xmx100m MemEat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 1155664&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 1679936&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 2204208&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 1315752&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Exception &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; thread &lt;span class=&quot;string&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.OutOfMemoryError: Java heap space&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    at MemEat.main(MemEat.java:8)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在提供了我们自己的内存限制之后，进程正常停止，JVM理解它正在运行的限制。然而，问题在于你现在将这些内存限制设置了两次，Docker一次，JVM一次。&lt;/p&gt;
&lt;h3 id=&quot;测试二：Java-8u144&quot;&gt;&lt;a href=&quot;#测试二：Java-8u144&quot; class=&quot;headerlink&quot; title=&quot;测试二：Java 8u144&quot;&gt;&lt;/a&gt;测试二：Java 8u144&lt;/h3&gt;&lt;p&gt;如前所述，随着增加新标志来修复问题，JVM现在可以遵循Docker所提供的设置。我们可以使用版本新一点的JVM来测试它。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker run -m 100m -it adoptopenjdk/openjdk8 /bin/bash&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;（在撰写本文时，此OpenJDK Java镜像的版本是Java 8u144）&lt;/p&gt;
&lt;p&gt;接下来，我们再次编译并运行MemEat.java文件，不带任何标志：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;javac MemEat.java&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java MemEat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 67194416&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 66145824&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 65097232&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Killed&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;依然存在同样的问题。但是我们现在可以提供上面提到的实验性标志来试试看：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;javac MemEat.java&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap MemEat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 1679936&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 2204208&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 1155616&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 1155600&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Exception &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; thread &lt;span class=&quot;string&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.OutOfMemoryError: Java heap space&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   at MemEat.main(MemEat.java:8)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这一次我们没有告诉JVM限制的是什么，我们只是告诉JVM去检查正确的限制设置！现在感觉好多了。&lt;/p&gt;
&lt;h3 id=&quot;测试三：Java-10u23&quot;&gt;&lt;a href=&quot;#测试三：Java-10u23&quot; class=&quot;headerlink&quot; title=&quot;测试三：Java 10u23&quot;&gt;&lt;/a&gt;测试三：Java 10u23&lt;/h3&gt;&lt;p&gt;有些人在评论和Reddit上提到Java 10通过使实验标志成为新的默认值来解决所有问题。这种行为可以通过禁用此标志来关闭：-XX：-UseContainerSupport。&lt;/p&gt;
&lt;p&gt;当我测试它时，它最初不起作用。在撰写本文时，AdoptAJDK OpenJDK10镜像与jdk-10+23一起打包。这个JVM显然还是不理解UseContainerSupport标志，该进程仍然被Docker杀死。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker run -m 100m -it adoptopenjdk/openjdk10 /bin/bash&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;测试了代码（甚至手动提供需要的标志）：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;javac MemEat.java&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java MemEat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 96262112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 94164960&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 92067808&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 89970656&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Killed&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java -XX:+UseContainerSupport MemEat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Unrecognized VM option &lt;span class=&quot;string&quot;&gt;&#39;UseContainerSupport&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Error: Could not create the Java Virtual Machine.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Error: A fatal exception has occurred. Program will exit.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;测试四：Java-10u46（Nightly）&quot;&gt;&lt;a href=&quot;#测试四：Java-10u46（Nightly）&quot; class=&quot;headerlink&quot; title=&quot;测试四：Java 10u46（Nightly）&quot;&gt;&lt;/a&gt;测试四：Java 10u46（Nightly）&lt;/h3&gt;&lt;p&gt;我决定尝试AdoptAJDK OpenJDK 10的最新nightly构建。它包含的版本是Java 10+46，而不是Java 10+23。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker run -m 100m -it adoptopenjdk/openjdk10:nightly /bin/bash&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然而，在这个ngithly构建中有一个问题，导出的PATH指向旧的Java 10+23目录，而不是10+46，我们需要修复这个问题。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt; PATH=&lt;span class=&quot;variable&quot;&gt;$PATH&lt;/span&gt;:/opt/java/openjdk/jdk-10+46/bin/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;javac MemEat.java&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java MemEat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 3566824&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 2796008&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 1480320&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Exception &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; thread &lt;span class=&quot;string&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.OutOfMemoryError: Java heap space&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  at MemEat.main(MemEat.java:8)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;成功！不提供任何标志，Java 10依然可以正确检测到Dockers内存限制。&lt;/p&gt;
&lt;h3 id=&quot;测试五：OpenJ9&quot;&gt;&lt;a href=&quot;#测试五：OpenJ9&quot; class=&quot;headerlink&quot; title=&quot;测试五：OpenJ9&quot;&gt;&lt;/a&gt;测试五：OpenJ9&lt;/h3&gt;&lt;p&gt;我最近也在试用OpenJ9，这个免费的替代JVM已经从IBM J9开源，现在由Eclipse维护。&lt;/p&gt;
&lt;p&gt;请在我的下一篇博文&lt;a href=&quot;http://royvanrijn.com/blog/2018/05/openj9-jvm-shootout/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://royvanrijn.com/blog/2018/05/openj9-jvm-shootout/&lt;/a&gt;阅读关于OpenJ9的更多信息。&lt;/p&gt;
&lt;p&gt;它运行速度快，内存管理非常好，性能卓越，经常可以为我们的微服务节省多达30-50％的内存。这几乎可以将Spring Boot应用程序定义为’micro’了，其运行时间只有100-200mb，而不是300mb+。我打算尽快就此写一篇关于这方面的文章。&lt;/p&gt;
&lt;p&gt;但令我惊讶的是，OpenJ9还没有类似于Java 8/9/10+中针对cgroup内存限制的标志（backported）的选项。如果我们将以前的测试用例应用到最新的AdoptAJDK OpenJDK 9 + OpenJ9 build：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker run -m 100m -it adoptopenjdk/openjdk9-openj9 /bin/bash&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们添加OpenJDK标志（OpenJ9会忽略的标志）：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;java -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap MemEat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 83988984&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 82940400&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 81891816&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Killed&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Oops，JVM再次被Docker杀死。&lt;/p&gt;
&lt;p&gt;我真的希望类似的选项将很快添加到OpenJ9中，因为我希望在生产环境中运行这个选项，而不必指定最大内存两次。 Eclipse/IBM正在努力修复这个问题，已经提了issues，甚至已经针对issues提交了PR。&lt;/p&gt;
&lt;h3 id=&quot;更新：（不推荐Hack）&quot;&gt;&lt;a href=&quot;#更新：（不推荐Hack）&quot; class=&quot;headerlink&quot; title=&quot;更新：（不推荐Hack）&quot;&gt;&lt;/a&gt;更新：（不推荐Hack）&lt;/h3&gt;&lt;p&gt;一个稍微丑陋/hacky的方式来解决这个问题是使用下面的组合标志：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;java -Xmx`cat /sys/fs/cgroup/memory/memory.limit_&lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt;_bytes` MemEat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 3171536&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 2127048&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 2397632&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 1344952&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP039I Processing dump event &lt;span class=&quot;string&quot;&gt;&quot;systhrow&quot;&lt;/span&gt;, detail &lt;span class=&quot;string&quot;&gt;&quot;java/lang/OutOfMemoryError&quot;&lt;/span&gt; at 2018/05/15 14:04:26 - please wait.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP032I JVM requested System dump using &lt;span class=&quot;string&quot;&gt;&#39;//core.20180515.140426.125.0001.dmp&#39;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; response to an event&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP010I System dump written to //core.20180515.140426.125.0001.dmp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP032I JVM requested Heap dump using &lt;span class=&quot;string&quot;&gt;&#39;//heapdump.20180515.140426.125.0002.phd&#39;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; response to an event&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP010I Heap dump written to //heapdump.20180515.140426.125.0002.phd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP032I JVM requested Java dump using &lt;span class=&quot;string&quot;&gt;&#39;//javacore.20180515.140426.125.0003.txt&#39;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; response to an event&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP010I Java dump written to //javacore.20180515.140426.125.0003.txt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP032I JVM requested Snap dump using &lt;span class=&quot;string&quot;&gt;&#39;//Snap.20180515.140426.125.0004.trc&#39;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; response to an event&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP010I Snap dump written to //Snap.20180515.140426.125.0004.trc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP013I Processed dump event &lt;span class=&quot;string&quot;&gt;&quot;systhrow&quot;&lt;/span&gt;, detail &lt;span class=&quot;string&quot;&gt;&quot;java/lang/OutOfMemoryError&quot;&lt;/span&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Exception &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; thread &lt;span class=&quot;string&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.OutOfMemoryError: Java heap space&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  at MemEat.main(MemEat.java:8)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在这种情况下，堆大小受限于分配给Docker实例的内存，这适用于较旧的JVM和OpenJ9。这当然是错误的，因为容器本身和堆外的JVM的其他部分也使用内存。但它似乎工作，显然Docker在这种情况下是宽松的。也许某些bash大神会做出更好的版本，从其他进程的字节中减去一部分。&lt;/p&gt;
&lt;p&gt;无论如何，不要这样做，它可能无法正常工作。&lt;/p&gt;
&lt;h3 id=&quot;测试六：OpenJ9（Nightly）&quot;&gt;&lt;a href=&quot;#测试六：OpenJ9（Nightly）&quot; class=&quot;headerlink&quot; title=&quot;测试六：OpenJ9（Nightly）&quot;&gt;&lt;/a&gt;测试六：OpenJ9（Nightly）&lt;/h3&gt;&lt;p&gt;有人建议使用OpenJ9的最新nightly版本。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker run -m 100m -it adoptopenjdk/openjdk9-openj9:nightly /bin/bash&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;最新的OpenJ9夜间版本，它有两个东西：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;另一个有问题的PATH参数，需要先解决这个问题&lt;/li&gt;
&lt;li&gt;JVM支持新标志UseContainerSupport（就像Java 10一样）&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt; PATH=&lt;span class=&quot;variable&quot;&gt;$PATH&lt;/span&gt;:/opt/java/openjdk/jdk-9.0.4+12/bin/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;javac MemEat.java&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java -XX:+UseContainerSupport MemEat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 5864464&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 4815880&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 3443712&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;free memory: 2391032&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP039I Processing dump event &lt;span class=&quot;string&quot;&gt;&quot;systhrow&quot;&lt;/span&gt;, detail &lt;span class=&quot;string&quot;&gt;&quot;java/lang/OutOfMemoryError&quot;&lt;/span&gt; at 2018/05/15 21:32:07 - please wait.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP032I JVM requested System dump using &lt;span class=&quot;string&quot;&gt;&#39;//core.20180515.213207.62.0001.dmp&#39;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; response to an event&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP010I System dump written to //core.20180515.213207.62.0001.dmp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP032I JVM requested Heap dump using &lt;span class=&quot;string&quot;&gt;&#39;//heapdump.20180515.213207.62.0002.phd&#39;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; response to an event&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP010I Heap dump written to //heapdump.20180515.213207.62.0002.phd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP032I JVM requested Java dump using &lt;span class=&quot;string&quot;&gt;&#39;//javacore.20180515.213207.62.0003.txt&#39;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; response to an event&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP010I Java dump written to //javacore.20180515.213207.62.0003.txt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP032I JVM requested Snap dump using &lt;span class=&quot;string&quot;&gt;&#39;//Snap.20180515.213207.62.0004.trc&#39;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; response to an event&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP010I Snap dump written to //Snap.20180515.213207.62.0004.trc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JVMDUMP013I Processed dump event &lt;span class=&quot;string&quot;&gt;&quot;systhrow&quot;&lt;/span&gt;, detail &lt;span class=&quot;string&quot;&gt;&quot;java/lang/OutOfMemoryError&quot;&lt;/span&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Exception &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; thread &lt;span class=&quot;string&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.OutOfMemoryError: Java heap space&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;TADAAA，正在修复中！&lt;/p&gt;
&lt;p&gt;奇怪的是，这个标志在OpenJ9中默认没有启用，就像它在Java 10中一样。再说一次：确保你测试了这是你想在一个Docker容器中运行Java。&lt;/p&gt;
&lt;h2 id=&quot;结论&quot;&gt;&lt;a href=&quot;#结论&quot; class=&quot;headerlink&quot; title=&quot;结论&quot;&gt;&lt;/a&gt;结论&lt;/h2&gt;&lt;p&gt;简言之：注意资源限制的不匹配。测试你的内存设置和JVM标志，不要假设任何东西。&lt;/p&gt;
&lt;p&gt;如果您在Docker容器中运行Java，请确保你设置了Docker内存限制和在JVM中也做了限制，或者你的JVM能够理解这些限制。&lt;/p&gt;
&lt;p&gt;如果您无法升级您的Java版本，请使用-Xmx设置您自己的限制。&lt;/p&gt;
&lt;p&gt;对于Java 8和Java 9，请更新到最新版本并使用：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-XX：+UnlockExperimentalVMOptions -XX：+UseCGroupMemoryLimitForHeap&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;对于Java 10，确保它支持’UseContainerSupport’（更新到最新版本）。&lt;/p&gt;
&lt;p&gt;对于OpenJ9（我强烈建议使用，可以在生产环境中有效减少内存占用量），现在使用-Xmx设置限制，但很快会出现一个支持UseContainerSupport标志的版本。&lt;/p&gt;
&lt;p&gt;原文链接：&lt;a href=&quot;http://royvanrijn.com/blog/2018/05/java-and-docker-memory-limits/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://royvanrijn.com/blog/2018/05/java-and-docker-memory-limits/&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;揭秘&quot;&gt;&lt;a href=&quot;#揭秘&quot; class=&quot;headerlink&quot; title=&quot;揭秘&quot;&gt;&lt;/a&gt;揭秘&lt;/h2&gt;&lt;p&gt;Java和Docker不是天然的朋友。 Docker可以设置内存和CPU限制，而Java不能自动检测到。使用Java的Xmx标识（繁琐/重复）或新的实验性JVM标识，我们可以解决这个问题。&lt;/p&gt;
&lt;h2 id=&quot;虚拟化中的不匹配&quot;&gt;&lt;a href=&quot;#虚拟化中的不匹配&quot; class=&quot;headerlink&quot; title=&quot;虚拟化中的不匹配&quot;&gt;&lt;/a&gt;虚拟化中的不匹配&lt;/h2&gt;&lt;p&gt;Java和Docker的结合并不是完美匹配的，最初的时候离完美匹配有相当大的距离。对于初学者来说，JVM的全部设想就是，虚拟机可以让程序与底层硬件无关。&lt;/p&gt;
&lt;p&gt;那么，把我们的Java应用打包到JVM中，然后整个再塞进Docker容器中，能给我们带来什么好处呢？大多数情况下，你只是在复制JVMs和Linux容器，除了浪费更多的内存，没任何好处。感觉这样子挺傻的。&lt;/p&gt;
&lt;p&gt;不过，Docker可以把你的程序，设置，特定的JDK，Linux设置和应用服务器，还有其他工具打包在一起，当做一个东西。站在DevOps/Cloud的角度来看，这样一个完整的容器有着更高层次的封装。&lt;/p&gt;
&lt;h3 id=&quot;问题一：内存&quot;&gt;&lt;a href=&quot;#问题一：内存&quot; class=&quot;headerlink&quot; title=&quot;问题一：内存&quot;&gt;&lt;/a&gt;问题一：内存&lt;/h3&gt;&lt;p&gt;时至今日，绝大多数产品级应用仍然在使用Java 8（或者更旧的版本），而这可能会带来问题。Java 8（update 131之前的版本）跟Docker无法很好地一起工作。问题是在你的机器上，JVM的可用内存和CPU数量并不是Docker允许你使用的可用内存和CPU数量。&lt;/p&gt;
&lt;p&gt;比如，如果你限制了你的Docker容器只能使用100MB内存，但是呢，旧版本的Java并不能识别这个限制。Java看不到这个限制。JVM会要求更多内存，而且远超这个限制。如果使用太多内存，Docker将采取行动并杀死容器内的进程！JAVA进程被干掉了，很明显，这并不是我们想要的。&lt;/p&gt;
&lt;p&gt;为了解决这个问题，你需要给Java指定一个最大内存限制。在旧版本的Java（8u131之前），你需要在容器中通过设置-Xmx来限制堆大小。这感觉不太对，你可不想定义这些限制两次，也不太想在你的容器中来定义。&lt;/p&gt;
&lt;p&gt;幸运的是我们现在有了更好的方式来解决这个问题。从Java 9之后（8u131+），JVM增加了如下标志：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这些标志强制JVM检查Linux的cgroup配置，Docker是通过cgroup来实现最大内存设置的。现在，如果你的应用到达了Docker设置的限制（比如500MB），JVM是可以看到这个限制的。JVM将会尝试GC操作。如果仍然超过内存限制，JVM就会做它该做的事情，抛出OutOfMemoryException。也就是说，JVM能够看到Docker的这些设置。&lt;/p&gt;
&lt;p&gt;从Java 10之后（参考下面的测试），这些体验标志位是默认开启的，也可以使用-XX:+UseContainerSupport来使能（你可以通过设置-XX:-UseContainerSupport来禁止这些行为）。&lt;/p&gt;
&lt;h3 id=&quot;问题二：CPU&quot;&gt;&lt;a href=&quot;#问题二：CPU&quot; class=&quot;headerlink&quot; title=&quot;问题二：CPU&quot;&gt;&lt;/a&gt;问题二：CPU&lt;/h3&gt;&lt;p&gt;第二个问题是类似的，但它与CPU有关。简而言之，JVM将查看硬件并检测CPU的数量。它会优化你的runtime以使用这些CPUs。但是同样的情况，这里还有另一个不匹配，Docker可能不允许你使用所有这些CPUs。可惜的是，这在Java 8或Java 9中并没有修复，但是在Java 10中得到了解决。&lt;/p&gt;
&lt;p&gt;从Java 10开始，可用的CPUs的计算将采用以不同的方式（默认情况下）解决此问题（同样是通过UseContainerSupport）。&lt;br&gt;
    
    </summary>
    
      <category term="docker" scheme="http://icyxp.github.io/categories/docker/"/>
    
    
      <category term="docker" scheme="http://icyxp.github.io/tags/docker/"/>
    
      <category term="java" scheme="http://icyxp.github.io/tags/java/"/>
    
      <category term="内存" scheme="http://icyxp.github.io/tags/%E5%86%85%E5%AD%98/"/>
    
  </entry>
  
  <entry>
    <title>Centos 6.x 上升级go 1.10.3</title>
    <link href="http://icyxp.github.io//blog/2018/07/go-%E5%8D%87%E7%BA%A7go1-10-x%E9%97%AE%E9%A2%98.html"/>
    <id>http://icyxp.github.io//blog/2018/07/go-升级go1-10-x问题.html</id>
    <published>2018-07-18T12:30:00.000Z</published>
    <updated>2018-07-18T13:41:55.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;前提&quot;&gt;&lt;a href=&quot;#前提&quot; class=&quot;headerlink&quot; title=&quot;前提&quot;&gt;&lt;/a&gt;前提&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;目前本地Linux (Centos 6.x) 编译环境还滞留在1.8.x上，为了提升go性能，想将go升级到最新版，但在升级过程中遇到如下问题，故此记录下！忘后续的go友能跳过此坑！&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h2&gt;&lt;p&gt;在Centos 6.x 升级go 1.10.x过程中遇到如下问题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;step1.  下载go 1.10.x 源码&lt;/li&gt;
&lt;li&gt;step2.  解压，进入go/src&lt;/li&gt;
&lt;li&gt;step3.  执行./all.bash&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Building Go cmd/dist using /root/go1.4.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Building Go toolchain1 using /root/go1.4.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Building Go bootstrap cmd/go (go_bootstrap) using Go toolchain1.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Building Go toolchain2 using go_bootstrap and Go toolchain1.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Building Go toolchain3 using go_bootstrap and Go toolchain2.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Building packages and commands &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; linux/amd64.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;##### Testing packages.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.... 过程略长，特此省略&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/internal/src    0.001s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/internal/&lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;2json    0.097s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/link    1.988s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/link/internal/ld    43.529s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/nm    3.417s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/objdump    1.588s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/pack    1.217s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/trace    0.007s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--- FAIL: TestObjFile (0.01s)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    binutils_test.go:231: SourceLine: unexpected error write |1: broken pipe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FAIL&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FAIL    cmd/vendor/github.com/google/pprof/internal/binutils    0.018s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/driver    12.194s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/elfexec    0.002s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/graph    0.002s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/measurement    0.002s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/report    0.048s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/symbolizer    0.004s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/symbolz    0.004s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/profile    0.045s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/ianlancetaylor/demangle    0.012s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/golang.org/x/arch/arm/armasm    0.007s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/golang.org/x/arch/arm64/arm64asm    0.043s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/golang.org/x/arch/ppc64/ppc64asm    0.003s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/golang.org/x/arch/x86/x86asm    0.064s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vet    1.205s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vet/internal/cfg    0.002s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2018/07/18 17:59:22 Failed: &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt; status 1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;问题分析&quot;&gt;&lt;a href=&quot;#问题分析&quot; class=&quot;headerlink&quot; title=&quot;问题分析&quot;&gt;&lt;/a&gt;问题分析&lt;/h2&gt;&lt;p&gt;为什么在执行binutils_test.go 会Failed，最终查看代码原因是因为如下命令引起：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;120807 3650  execve(&lt;span class=&quot;string&quot;&gt;&quot;/usr/bin/addr2line&quot;&lt;/span&gt;, [&lt;span class=&quot;string&quot;&gt;&quot;/usr/bin/addr2line&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;-aif&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;-e&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;testdata/exe_linux_64&quot;&lt;/span&gt;], [/* 15 vars */] &amp;lt;unfinished ...&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;有关生成此命令的源代码可查看如下地址：&lt;a href=&quot;https://github.com/google/pprof/blob/a74ae6fb3cd7047c79272e3ea0814b08154a2d3c/internal/binutils/addr2liner.go#L92&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;addr2line&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;add2line文件来自于包：binutils&lt;/p&gt;
&lt;p&gt;执行命令失败，是因为在CentOS 6.x上，binutils的版本是2.20，&lt;a href=&quot;https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;a=blob_plain;f=binutils/NEWS;hb=refs/tags/binutils-2_27&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;参考文献&lt;/a&gt; ，然后addr2line命令中的-a参数在binutils 2.21版中才添加&lt;/p&gt;
&lt;p&gt;因此，为了解决这个问题，我从源码重新进行编译binutils并将其构建的二进制文件添加到PATH中，然后运行测试，并成功通过。&lt;/p&gt;
&lt;p&gt;编译安装binutils过程如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;wget https://ftp.gnu.org/gnu/binutils/binutils-2.27.tar.gz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;tar zxvf binutils-2.27.tar.gz &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; binutils-2.27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./configure --prefix=/usr&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;make &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;make install&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;特此说明，在Centos 7.x 上能成功避免此坑！！&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前提&quot;&gt;&lt;a href=&quot;#前提&quot; class=&quot;headerlink&quot; title=&quot;前提&quot;&gt;&lt;/a&gt;前提&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;目前本地Linux (Centos 6.x) 编译环境还滞留在1.8.x上，为了提升go性能，想将go升级到最新版，但在升级过程中遇到如下问题，故此记录下！忘后续的go友能跳过此坑！&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h2&gt;&lt;p&gt;在Centos 6.x 升级go 1.10.x过程中遇到如下问题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;step1.  下载go 1.10.x 源码&lt;/li&gt;
&lt;li&gt;step2.  解压，进入go/src&lt;/li&gt;
&lt;li&gt;step3.  执行./all.bash&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Building Go cmd/dist using /root/go1.4.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Building Go toolchain1 using /root/go1.4.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Building Go bootstrap cmd/go (go_bootstrap) using Go toolchain1.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Building Go toolchain2 using go_bootstrap and Go toolchain1.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Building Go toolchain3 using go_bootstrap and Go toolchain2.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Building packages and commands &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; linux/amd64.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;##### Testing packages.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.... 过程略长，特此省略&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/internal/src    0.001s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/internal/&lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;2json    0.097s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/link    1.988s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/link/internal/ld    43.529s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/nm    3.417s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/objdump    1.588s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/pack    1.217s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/trace    0.007s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--- FAIL: TestObjFile (0.01s)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    binutils_test.go:231: SourceLine: unexpected error write |1: broken pipe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FAIL&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FAIL    cmd/vendor/github.com/google/pprof/internal/binutils    0.018s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/driver    12.194s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/elfexec    0.002s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/graph    0.002s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/measurement    0.002s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/report    0.048s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/symbolizer    0.004s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/internal/symbolz    0.004s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/google/pprof/profile    0.045s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/github.com/ianlancetaylor/demangle    0.012s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/golang.org/x/arch/arm/armasm    0.007s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/golang.org/x/arch/arm64/arm64asm    0.043s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/golang.org/x/arch/ppc64/ppc64asm    0.003s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vendor/golang.org/x/arch/x86/x86asm    0.064s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vet    1.205s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ok      cmd/vet/internal/cfg    0.002s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2018/07/18 17:59:22 Failed: &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt; status 1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="golang" scheme="http://icyxp.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="http://icyxp.github.io/tags/golang/"/>
    
      <category term="go" scheme="http://icyxp.github.io/tags/go/"/>
    
      <category term="升级" scheme="http://icyxp.github.io/tags/%E5%8D%87%E7%BA%A7/"/>
    
  </entry>
  
  <entry>
    <title>Logstash filter插件开发</title>
    <link href="http://icyxp.github.io//blog/2017/08/log-logstash-filter.html"/>
    <id>http://icyxp.github.io//blog/2017/08/log-logstash-filter.html</id>
    <published>2017-08-15T16:00:00.000Z</published>
    <updated>2017-08-16T15:30:02.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;Logstash是一个具有实时管线能力的开源数据收集引擎。在ELK Stack中，通常选择更轻量级的Filebeat收集日志，然后将日志输出到Logstash进行加工处理，再将处理后的日志输出到指定的目标（ElasticSearch，Kafka等）当中。&lt;/p&gt;
&lt;p&gt;Logstash事件的处理管线是inputs → filters → outputs，三个阶段都可以自定义插件，本文主要介绍如何开发自定义需求最多的filter插件。&lt;/p&gt;
&lt;p&gt;Logstash的安装就不详细介绍了，下载传送门：&lt;a href=&quot;https://www.elastic.co/downloads/logstash&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.elastic.co/downloads/logstash&lt;/a&gt;。&lt;/p&gt;
&lt;h2 id=&quot;前置准备&quot;&gt;&lt;a href=&quot;#前置准备&quot; class=&quot;headerlink&quot; title=&quot;前置准备&quot;&gt;&lt;/a&gt;前置准备&lt;/h2&gt;&lt;p&gt;我们使用docker来讲解如何给logstash定制一个filter插件，首先，我们下载logstash官方最新版本的镜像。下载方式: &lt;code&gt;docker pull logstash&lt;/code&gt;，下载好后我们就来Run这个镜像，命令：&lt;code&gt;docker run -it logstash bash&lt;/code&gt;，这样我们就进入到logstash容器中了。接下来我们就安装下两个基本的软件包，一个vim，一个rsyslog，命令如下：&lt;code&gt;apt-get update &amp;amp;&amp;amp; apt-get -y install vim rsyslog &amp;amp;&amp;amp; /etc/init.d/rsysylog start&lt;/code&gt;。到此我们的准备工作就完毕了。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;生成filter插件&quot;&gt;&lt;a href=&quot;#生成filter插件&quot; class=&quot;headerlink&quot; title=&quot;生成filter插件&quot;&gt;&lt;/a&gt;生成filter插件&lt;/h2&gt;&lt;p&gt;cd到Logstash的跟目录，使用&lt;code&gt;bin/logstash-plugin&lt;/code&gt;生成filter插件模板，如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /usr/share/logstash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mkdir -p vendor/localgems&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;bin/logstash-plugin generate --type filter --name &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt; --path vendor/localgems&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#vendor/localgems 可修改为你自己的路径&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看filter插件的目录结构，如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;root@c11787c4cef3:/usr/share/logstash/vendor/localgems&lt;span class=&quot;comment&quot;&gt;# tree .&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;└── logstash-filter-test&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ├── CHANGELOG.md&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ├── CONTRIBUTORS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ├── DEVELOPER.md&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ├── Gemfile&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ├── LICENSE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ├── README.md&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ├── Rakefile&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ├── lib&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    │   └── logstash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    │       └── filters&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    │           └── test.rb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ├── logstash-filter-test.gemspec&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ├── spec&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    │   ├── filters&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    │   │   └── &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;_spec.rb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    │   └── spec_helper.rb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    └── test.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6 directories, 12 files&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;filter插件初探&quot;&gt;&lt;a href=&quot;#filter插件初探&quot; class=&quot;headerlink&quot; title=&quot;filter插件初探&quot;&gt;&lt;/a&gt;filter插件初探&lt;/h2&gt;&lt;p&gt;Logstash插件是用ruby写的，查看&lt;code&gt;logstash-filter-test/lib/logstash/filters/test.rb&lt;/code&gt;文件，如下：&lt;br&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# logstash依赖于UTF-8编码，需要在插件代码开始处添加&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# encoding: utf-8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#引入了插件必备的包&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;logstash/filters/base&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;logstash/namespace&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 插件继承自Base基类，并配置插件的使用名称&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;LogStash::Filters::Test&lt;/span&gt; &amp;lt; LogStash::Filters::&lt;span class=&quot;title&quot;&gt;Base&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# 插件名称，在Logstash配置的filter块中使用&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;#filter&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;#  test&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;#      source =&amp;gt; &quot;message&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;#  &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;#&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  config_name &lt;span class=&quot;string&quot;&gt;&quot;test&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# 插件参数配置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# source是插件test的可选参数，默认值是&quot;Hello World!&quot;。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  config &lt;span class=&quot;symbol&quot;&gt;:source&lt;/span&gt;, &lt;span class=&quot;symbol&quot;&gt;:validate&lt;/span&gt; =&amp;gt; &lt;span class=&quot;symbol&quot;&gt;:string&lt;/span&gt;, &lt;span class=&quot;symbol&quot;&gt;:default&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;Hello World!&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# 下面是参数的通用配置代码&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# config :variable_name, :validate =&amp;gt; :variable_type, :default =&amp;gt; &quot;Default value&quot;, :required =&amp;gt; boolean, :deprecated =&amp;gt; boolean, :obsolete =&amp;gt; string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# :variable_name：参数名称&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# :validate：验证参数类型，如:string, :password, :boolean, :number, :array, :hash, :path等&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# :required：是否必须配置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# :default：默认值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# :deprecated：是否废弃&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# :obsolete：声明该配置不再使用，通常提供升级方案&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  public&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;register&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# 方法相当于初始化方法，不需要手动调用，可以在这个方法里面调用配置变量，如&lt;span class=&quot;doctag&quot;&gt;@message&lt;/span&gt;，也可以初始化自己的实例变量。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  public&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(event)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# 方法是插件的数据处理逻辑，其中event变量封装了数据流，可以通过接口访问event中的内容，具体参见 https://www.elastic.co/guide/en/logstash/5.1/event-api.html。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (source = event.get(@source))      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      datas = source.split(&lt;span class=&quot;string&quot;&gt;&quot;|&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      event.set(&lt;span class=&quot;string&quot;&gt;&quot;data&quot;&lt;/span&gt;, datas[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      event.set(&lt;span class=&quot;string&quot;&gt;&quot;data2&quot;&lt;/span&gt;, datas[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      event.set(&lt;span class=&quot;string&quot;&gt;&quot;user&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;xp&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#这个方法用于保证Logstash的配置`add_field`, `remove_field`, `add_tag`和`remove_tag`会被正确执行。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    filter_matched(event)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# def filter&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# class LogStash::Filters::Test&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看&lt;code&gt;logstash-filter-test/logstash-filter-test.gemspec&lt;/code&gt;文件，如下：&lt;br&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Gem::Specification.new &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;|s|&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.name          = &lt;span class=&quot;string&quot;&gt;&#39;logstash-filter-test&#39;&lt;/span&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.version       = &lt;span class=&quot;string&quot;&gt;&#39;0.1.0&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.licenses      = [&lt;span class=&quot;string&quot;&gt;&#39;Apache License (2.0)&#39;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.summary       = &lt;span class=&quot;string&quot;&gt;&#39;描述这个插件的概要&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.description   = &lt;span class=&quot;string&quot;&gt;&#39;这个插件的详细说明&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.homepage      = &lt;span class=&quot;string&quot;&gt;&#39;http://icyxp.github.io&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.authors       = [&lt;span class=&quot;string&quot;&gt;&#39;icyboy&#39;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.email         = &lt;span class=&quot;string&quot;&gt;&#39;icyboy@me.com&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.require_paths = [&lt;span class=&quot;string&quot;&gt;&#39;lib&#39;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# Files&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.files = Dir[&lt;span class=&quot;string&quot;&gt;&#39;lib/**/*&#39;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&#39;spec/**/*&#39;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&#39;vendor/**/*&#39;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&#39;*.gemspec&#39;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&#39;*.md&#39;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&#39;CONTRIBUTORS&#39;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&#39;Gemfile&#39;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&#39;LICENSE&#39;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&#39;NOTICE.TXT&#39;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;# Tests&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.test_files = s.files.grep(&lt;span class=&quot;regexp&quot;&gt;%r&amp;#123;^(test|spec|features)/&amp;#125;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# Special flag to let us know this is actually a logstash plugin&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.metadata = &amp;#123; &lt;span class=&quot;string&quot;&gt;&quot;logstash_plugin&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;true&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;logstash_group&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;filter&quot;&lt;/span&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# Gem dependencies&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.add_runtime_dependency &lt;span class=&quot;string&quot;&gt;&quot;logstash-core-plugin-api&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;~&amp;gt; 2.0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  s.add_development_dependency &lt;span class=&quot;string&quot;&gt;&#39;logstash-devutils&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;在Logstash中配置定制的插件&quot;&gt;&lt;a href=&quot;#在Logstash中配置定制的插件&quot; class=&quot;headerlink&quot; title=&quot;在Logstash中配置定制的插件&quot;&gt;&lt;/a&gt;在Logstash中配置定制的插件&lt;/h2&gt;&lt;p&gt;cd到Logstash根目录下&lt;code&gt;cd /usr/shar/logstash&lt;/code&gt;，在&lt;code&gt;Gemfile&lt;/code&gt;末尾添加以下配置：&lt;br&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;gem &lt;span class=&quot;string&quot;&gt;&quot;logstash-filter-test&quot;&lt;/span&gt;, &lt;span class=&quot;symbol&quot;&gt;:path&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;vendor/localgems/logstash-filter-test&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;启动Logstash&quot;&gt;&lt;a href=&quot;#启动Logstash&quot; class=&quot;headerlink&quot; title=&quot;启动Logstash&quot;&gt;&lt;/a&gt;启动Logstash&lt;/h2&gt;&lt;p&gt;先编写一个配置文件&lt;code&gt;test.conf&lt;/code&gt;，这里我使用了rsyslog&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#来源rsyslog&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;input&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    file&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    path =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;/var/log/messages&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#或者可以设置为终端输入&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#input&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#    stdin&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#    &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;filter&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# 定制的filter插件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    &lt;span class=&quot;built_in&quot;&gt;source&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;message&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#输出到终端&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;output&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    stdout&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        codec =&amp;gt; rubydebug&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;运行起来&lt;code&gt;logstash -f test.conf&lt;/code&gt;，然后往rsyslog里写日志你就可以看下如下情况就说明ok了。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#logger &quot;测试一下&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;string&quot;&gt;&quot;path&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;/var/log/messages&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;@timestamp&quot;&lt;/span&gt; =&amp;gt; 2017-08-16T15:27:46.606Z,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;string&quot;&gt;&quot;data&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;Aug 16 15:27:45 c11787c4cef3 root: 测试一下&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;string&quot;&gt;&quot;data2&quot;&lt;/span&gt; =&amp;gt; nil,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;@version&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;1&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;string&quot;&gt;&quot;host&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;c11787c4cef3&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;span class=&quot;string&quot;&gt;&quot;message&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;Aug 16 15:27:45 c11787c4cef3 root: 测试一下&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;string&quot;&gt;&quot;user&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;xp&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#logger &quot;测试一下|from by icyboy&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;string&quot;&gt;&quot;path&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;/var/log/messages&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;@timestamp&quot;&lt;/span&gt; =&amp;gt; 2017-08-16T15:28:17.661Z,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;string&quot;&gt;&quot;data&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;Aug 16 15:28:16 c11787c4cef3 root: 测试一下&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;string&quot;&gt;&quot;data2&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;from by icyboy&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;string&quot;&gt;&quot;@version&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;1&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;string&quot;&gt;&quot;host&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;c11787c4cef3&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;span class=&quot;string&quot;&gt;&quot;message&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;Aug 16 15:28:16 c11787c4cef3 root: 测试一下|from by icyboy&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;string&quot;&gt;&quot;user&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;xp&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;Logstash是一个具有实时管线能力的开源数据收集引擎。在ELK Stack中，通常选择更轻量级的Filebeat收集日志，然后将日志输出到Logstash进行加工处理，再将处理后的日志输出到指定的目标（ElasticSearch，Kafka等）当中。&lt;/p&gt;
&lt;p&gt;Logstash事件的处理管线是inputs → filters → outputs，三个阶段都可以自定义插件，本文主要介绍如何开发自定义需求最多的filter插件。&lt;/p&gt;
&lt;p&gt;Logstash的安装就不详细介绍了，下载传送门：&lt;a href=&quot;https://www.elastic.co/downloads/logstash&quot;&gt;https://www.elastic.co/downloads/logstash&lt;/a&gt;。&lt;/p&gt;
&lt;h2 id=&quot;前置准备&quot;&gt;&lt;a href=&quot;#前置准备&quot; class=&quot;headerlink&quot; title=&quot;前置准备&quot;&gt;&lt;/a&gt;前置准备&lt;/h2&gt;&lt;p&gt;我们使用docker来讲解如何给logstash定制一个filter插件，首先，我们下载logstash官方最新版本的镜像。下载方式: &lt;code&gt;docker pull logstash&lt;/code&gt;，下载好后我们就来Run这个镜像，命令：&lt;code&gt;docker run -it logstash bash&lt;/code&gt;，这样我们就进入到logstash容器中了。接下来我们就安装下两个基本的软件包，一个vim，一个rsyslog，命令如下：&lt;code&gt;apt-get update &amp;amp;&amp;amp; apt-get -y install vim rsyslog &amp;amp;&amp;amp; /etc/init.d/rsysylog start&lt;/code&gt;。到此我们的准备工作就完毕了。&lt;/p&gt;
    
    </summary>
    
      <category term="日志" scheme="http://icyxp.github.io/categories/%E6%97%A5%E5%BF%97/"/>
    
      <category term="开发" scheme="http://icyxp.github.io/categories/%E6%97%A5%E5%BF%97/%E5%BC%80%E5%8F%91/"/>
    
      <category term="logstash" scheme="http://icyxp.github.io/categories/%E6%97%A5%E5%BF%97/%E5%BC%80%E5%8F%91/logstash/"/>
    
    
      <category term="logstash" scheme="http://icyxp.github.io/tags/logstash/"/>
    
      <category term="日志" scheme="http://icyxp.github.io/tags/%E6%97%A5%E5%BF%97/"/>
    
      <category term="ruby" scheme="http://icyxp.github.io/tags/ruby/"/>
    
  </entry>
  
  <entry>
    <title>一语点醒技术人：你不是Google</title>
    <link href="http://icyxp.github.io//blog/2017/07/gossip-%E4%BD%A0%E4%B8%8D%E6%98%AFGoogle.html"/>
    <id>http://icyxp.github.io//blog/2017/07/gossip-你不是Google.html</id>
    <published>2017-07-26T15:00:00.000Z</published>
    <updated>2017-07-26T14:56:34.000Z</updated>
    
    <content type="html">&lt;p&gt;&lt;img src=&quot;/images/gossip/01/cover.png&quot; alt=&quot;01&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;在为问题寻找解决方案时要先充分了解问题本身，而不是一味地盲目崇拜那些巨头公司。Ozan Onay以Amazon、LinkedIn和Google为例，为执迷不悟的人敲响警钟。以下内容已获得作者翻译授权，查看原文：&lt;a href=&quot;https://blog.bradfieldcs.com/you-are-not-google-84912cf44afb&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;You Are Not Google&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;软件工程师总是着迷于荒唐古怪的事。我们看起来似乎很理性，但在面对技术选型时，总是陷入抓狂——从Hacker News到各种博客，像一只飞蛾一样，来回折腾，最后精疲力尽，无助地飞向一团亮光，跪倒在它的前面——那就是我们一直在寻找的东西。&lt;/p&gt;
&lt;p&gt;真正理性的人不是这样做决定的。不过工程师一贯如此，比如决定是否使用MapReduce。&lt;/p&gt;
&lt;p&gt;Joe Hellerstein在他的大学数据库教程视频中说道：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;世界上只有差不多5个公司需要运行这么大规模的作业。至于其他公司……他们使用了所有的IO来实现不必要的容错。在2000年代，人们狂热地追随着Google：“我们要做Google做过的每一件事，因为我们也运行着世界上最大的互联网数据服务。”&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;超出实际需求的容错没有什么问题，但我们却为此付出了的惨重的代价：不仅增加了IO，还有可能让原先成熟的系统——包含了事务、索引和查询优化器——变得破碎不堪。这是一个多么严重的历史倒退！有多少个Hadoop用户是有意识地做出这种决定的？有多少人知道他们的决定到底是不是一个明智之举？&lt;/p&gt;
&lt;p&gt;MapReduce已经成为一个众矢之的，那些盲目崇拜者也意识到事情不对劲。但这种情况却普遍存在：虽然你使用了大公司的技术，但你的情况却与他们大不一样，而且你的决定并没有经过深思熟虑，你只是习以为常地认为，模仿巨头公司就一定也能给你带来同样的财富。&lt;/p&gt;
&lt;p&gt;是的，这又是一篇劝大家“不要盲目崇拜”的文章。不过这次我列出了一长串有用的清单，或许能够帮助你们做出更好的决定。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;很酷的技术？UNPHAT&quot;&gt;&lt;a href=&quot;#很酷的技术？UNPHAT&quot; class=&quot;headerlink&quot; title=&quot;很酷的技术？UNPHAT&quot;&gt;&lt;/a&gt;很酷的技术？UNPHAT&lt;/h2&gt;&lt;p&gt;如果你还在使用Google搜索新技术来重建你的软件架构，那么我建议你不要再这么做了。相反，你可以考虑应用UNPHAT原则。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;在彻底了解（Understand）你的问题之前，不要急着去寻找解决方案。你的目标应该是在问题领域内“解决”问题，而不是在方案领域内解决问题。&lt;/li&gt;
&lt;li&gt;列出（eNumerate）多种方案，不要只把眼睛盯在你最喜欢的方案上。&lt;/li&gt;
&lt;li&gt;选择一个候选方案，并阅读相关论文（Paper）。&lt;/li&gt;
&lt;li&gt;了解候选方案的产生背景（Historical context）。&lt;/li&gt;
&lt;li&gt;比较优点（Advantages）和缺点，扬长避短。&lt;/li&gt;
&lt;li&gt;思考（Think）！冷静地思考候选方案是否适合用于解决你的问题。要出现怎样异常的情况才会让你改变注意？例如，数据要少到什么程度才会让你打消使用Hadoop的念头？&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;你不是Amazon&quot;&gt;&lt;a href=&quot;#你不是Amazon&quot; class=&quot;headerlink&quot; title=&quot;你不是Amazon&quot;&gt;&lt;/a&gt;你不是Amazon&lt;/h2&gt;&lt;p&gt;UNPHAT原则十分直截了当。最近我与一个公司有过一次对话，这个公司打算在一个读密集的系统里使用Cassandra，他们的数据是在夜间加载到系统里的。&lt;/p&gt;
&lt;p&gt;他们阅读了Dynamo的相关论文，并且知道Cassandra是最接近Dynamo的一个产品。我们知道，这些分布式数据库优先保证写可用性（Amazon是不会让“添加到购物车”这种操作出现失败的）。为了达到这个目的，他们在一致性以及几乎所有在传统RDBMS中出现过的特性上做出了妥协。但这家公司其实没有必要优先考虑写可用性，因为他们每天只有一次写入操作，只是数据量比较大。&lt;/p&gt;
&lt;p&gt;他们之所以考虑使用Cassandra，是因为PostgreSQL查询需要耗费几分钟的时间。他们认为是硬件的问题，经过排查，我们发现数据表里有5000万条数据，每条数据最多80个字节。如果从SSD上整块地读取所有数据大概需要5秒钟，这个不算快，但比起实际的查询，它要快上两个数量级。&lt;/p&gt;
&lt;p&gt;我真的很想多问他们几个问题（了解问题！），在问题变得愈加严重时，我为他们准备了5个方案（列出多个候选方案！），不过很显然，Cassandra对于他们来说完全是一个错误的方案。他们只需要耐心地做一些调优，比如对部分数据重新建模，或许可以考虑使用（当然也有可能没有）其他技术……但一定不是这种写高可用的键值存储系统，Amazon当初创建Cassandra是用来解决他们的购物车问题的！&lt;/p&gt;
&lt;h2 id=&quot;你不是LinkedIn&quot;&gt;&lt;a href=&quot;#你不是LinkedIn&quot; class=&quot;headerlink&quot; title=&quot;你不是LinkedIn&quot;&gt;&lt;/a&gt;你不是LinkedIn&lt;/h2&gt;&lt;p&gt;我发现一个学生创办的小公司居然在他们的系统里使用Kafka，这让我感到很惊讶。因为据我所知，他们每天只有很少的事务需要处理——最好的情况下，一天最多只有几百个。这样的吞吐量几乎可以直接记在记事本上。&lt;/p&gt;
&lt;p&gt;Kafka被设计用于处理LinkedIn内部的吞吐量，那可是一个天文数字。即使是在几年前，这个数字已经达到了每天数万亿，在高峰时段每秒钟需要处理1000万个消息。不过Kafka也可以用于处理低吞吐量的负载，或许再低10个数量级？&lt;/p&gt;
&lt;p&gt;或许工程师们在做决定时确实是基于他们的预期需求，并且也很了解Kafka的适用场景。但我猜测他们是抵挡不住社区对Kafka的追捧，并没有仔细想过Kafka是否适合他们。要知道，那可是10个数量级的差距！&lt;/p&gt;
&lt;h2 id=&quot;再一次，你不是Amazon&quot;&gt;&lt;a href=&quot;#再一次，你不是Amazon&quot; class=&quot;headerlink&quot; title=&quot;再一次，你不是Amazon&quot;&gt;&lt;/a&gt;再一次，你不是Amazon&lt;/h2&gt;&lt;p&gt;比Amazon的分布式数据库更为著名的是它的可伸缩架构模式，也就是面向服务架构。Werner Vogels在2006年的一次访谈中指出，Amazon在2001年时就意识到他们的前端需要横向伸缩，而面向服务架构有助于他们实现前端伸缩。工程师们面面相觑，最后只有少数几个工程师着手去做这件事情，而几乎没有人愿意将他们的静态网页拆分成小型的服务。&lt;/p&gt;
&lt;p&gt;不过Amazon还是决定向SOA转型，他们当时有7800个员工和30亿美元的销售规模。&lt;/p&gt;
&lt;p&gt;当然，并不是说你也要等到有7800个员工的时候才能转向SOA……只是你要多想想，它真的能解决你的问题吗？你的问题的根源是什么？可以通过其他的方式解决它们吗？&lt;/p&gt;
&lt;p&gt;如果你告诉我说，你那50个人的公司打算转向SOA，那么我不禁感到疑惑：为什么很多大型的公司仍然在乐此不彼地使用具有模块化的大型单体应用？&lt;/p&gt;
&lt;h2 id=&quot;甚至Google也不是Google&quot;&gt;&lt;a href=&quot;#甚至Google也不是Google&quot; class=&quot;headerlink&quot; title=&quot;甚至Google也不是Google&quot;&gt;&lt;/a&gt;甚至Google也不是Google&lt;/h2&gt;&lt;p&gt;使用Hadoop和Spark这样的大规模数据流引擎会非常有趣，但在很多情况下，传统的DBMS更适合当前的负载，有时候数据量小到可以直接放进内存。你是否愿意花10,000美金去购买1TB的内存？如果你有十亿个用户，每个用户仅能使用1KB的内存，所以你的投入远远不够。&lt;/p&gt;
&lt;p&gt;或许你的负载大到需要把数据写回磁盘。那么你需要多少磁盘？你到底有多少数据量？Google之所以要创建GFS和MapReduce，是要解决整个Web的计算问题，比如重建整个Web的搜索索引。&lt;/p&gt;
&lt;p&gt;或许你已经阅读过GFS和MapReduce的论文，Google的部分问题在于吞吐量，而不是容量，他们之所以需要分布式的存储，是因为从磁盘读取字节流要花费太多的时间。那么你在2017年需要使用多少设备吞吐量？你一定不需要像Google那么大的吞吐量，所以你可能会考虑使用更好的设备。如果都用上SSD会给你增加多少成本？&lt;/p&gt;
&lt;p&gt;或许你还想要伸缩性。但你有仔细算过吗，你的数据增长速度会快过SSD降价的速度吗？在你的数据撑爆所有的机器之前，你的业务会有多少增长？截止2016年，Stack Exchange每天要处理2亿个请求，但是他们只用了4个SQL Server，一个用于Stack Overflow，一个用于其他用途，另外两个作为备份复本。&lt;/p&gt;
&lt;p&gt;或许你在应用UNPHAT原则之后，仍然决定要使用Hadoop或Spark。或许你的决定是对的，但关键的是你要用对工具。Google非常明白这个道理，当他们意识到MapReduce不再适合用于构建索引之后，他们就不再使用它。&lt;/p&gt;
&lt;h2 id=&quot;先了解你的问题&quot;&gt;&lt;a href=&quot;#先了解你的问题&quot; class=&quot;headerlink&quot; title=&quot;先了解你的问题&quot;&gt;&lt;/a&gt;先了解你的问题&lt;/h2&gt;&lt;p&gt;我所说的也不是什么新观点，不过或许UNPHAT对于你们来说已经足够了。如果你觉得还不够，可以听听Rich Hickey的演讲“&lt;a href=&quot;https://www.youtube.com/watch?v=f84n5oFoZBc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;吊床驱动开发&lt;/a&gt;”，或者看看Polya的书《&lt;a href=&quot;https://www.amazon.com/How-Solve-Mathematical-Princeton-Science/dp/069111966X?ie=UTF8&amp;amp;%2aVersion%2a=1&amp;amp;%2aentries%2a=0&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;How to Solve It&lt;/a&gt;》， 或者学习一下Hamming的课程“&lt;a href=&quot;https://www.youtube.com/playlist?list=PL2FF649D0C4407B30&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;The Art of Doing Science and Engineering&lt;/a&gt;”。我恳请你们一定要多思考！在尝试解决问题之前先对它们有充分的了解。最后送上Polya的一个金句名言：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;回答一个你不了解的问题是愚蠢的，到达一个你不期望的终点是悲哀的。&lt;/p&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;/images/gossip/01/cover.png&quot; alt=&quot;01&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;在为问题寻找解决方案时要先充分了解问题本身，而不是一味地盲目崇拜那些巨头公司。Ozan Onay以Amazon、LinkedIn和Google为例，为执迷不悟的人敲响警钟。以下内容已获得作者翻译授权，查看原文：&lt;a href=&quot;https://blog.bradfieldcs.com/you-are-not-google-84912cf44afb&quot;&gt;You Are Not Google&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;软件工程师总是着迷于荒唐古怪的事。我们看起来似乎很理性，但在面对技术选型时，总是陷入抓狂——从Hacker News到各种博客，像一只飞蛾一样，来回折腾，最后精疲力尽，无助地飞向一团亮光，跪倒在它的前面——那就是我们一直在寻找的东西。&lt;/p&gt;
&lt;p&gt;真正理性的人不是这样做决定的。不过工程师一贯如此，比如决定是否使用MapReduce。&lt;/p&gt;
&lt;p&gt;Joe Hellerstein在他的大学数据库教程视频中说道：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;世界上只有差不多5个公司需要运行这么大规模的作业。至于其他公司……他们使用了所有的IO来实现不必要的容错。在2000年代，人们狂热地追随着Google：“我们要做Google做过的每一件事，因为我们也运行着世界上最大的互联网数据服务。”&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;超出实际需求的容错没有什么问题，但我们却为此付出了的惨重的代价：不仅增加了IO，还有可能让原先成熟的系统——包含了事务、索引和查询优化器——变得破碎不堪。这是一个多么严重的历史倒退！有多少个Hadoop用户是有意识地做出这种决定的？有多少人知道他们的决定到底是不是一个明智之举？&lt;/p&gt;
&lt;p&gt;MapReduce已经成为一个众矢之的，那些盲目崇拜者也意识到事情不对劲。但这种情况却普遍存在：虽然你使用了大公司的技术，但你的情况却与他们大不一样，而且你的决定并没有经过深思熟虑，你只是习以为常地认为，模仿巨头公司就一定也能给你带来同样的财富。&lt;/p&gt;
&lt;p&gt;是的，这又是一篇劝大家“不要盲目崇拜”的文章。不过这次我列出了一长串有用的清单，或许能够帮助你们做出更好的决定。&lt;/p&gt;
    
    </summary>
    
      <category term="茶余饭后" scheme="http://icyxp.github.io/categories/%E8%8C%B6%E4%BD%99%E9%A5%AD%E5%90%8E/"/>
    
    
      <category term="茶余饭后" scheme="http://icyxp.github.io/tags/%E8%8C%B6%E4%BD%99%E9%A5%AD%E5%90%8E/"/>
    
  </entry>
  
</feed>

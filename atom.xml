<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>CloudNative æ¶æ„</title>
  <subtitle>CloudNative|äº‘åŸç”Ÿåº”ç”¨æ¶æ„|äº‘åŸç”Ÿæ¶æ„|å®¹å™¨åŒ–æ¶æ„|å¾®æœåŠ¡æ¶æ„|å¹³å°æ¶æ„|åŸºç¡€æ¶æ„</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://team.jiunile.com/"/>
  <updated>2020-10-12T02:25:52.000Z</updated>
  <id>http://team.jiunile.com/</id>
  
  <author>
    <name>icyboy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>è®°ä¸€æ¬¡çº¿ä¸ŠGoæœåŠ¡å†…å­˜å ç”¨ç‡è¿‡é«˜é—®é¢˜æ’æŸ¥</title>
    <link href="http://team.jiunile.com//blog/2020/10/go-debug-memory2.html"/>
    <id>http://team.jiunile.com//blog/2020/10/go-debug-memory2.html</id>
    <published>2020-10-12T12:00:00.000Z</published>
    <updated>2020-10-12T02:25:52.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;æ•…éšœç°è±¡&quot;&gt;&lt;a href=&quot;#æ•…éšœç°è±¡&quot; class=&quot;headerlink&quot; title=&quot;æ•…éšœç°è±¡&quot;&gt;&lt;/a&gt;æ•…éšœç°è±¡&lt;/h2&gt;&lt;p&gt;æŸçº¿ä¸ŠåŸ‹ç‚¹ä¸ŠæŠ¥æœºå™¨å¶å°”è§¦å‘å†…å­˜å ç”¨è¿‡å¤šçš„æŠ¥è­¦ã€‚sshåˆ°æœºå™¨topå‘ç°ä¸»è¦å†…å­˜è¢«åŸ‹ç‚¹æœåŠ¡å ç”¨ã€‚ä¹‹å‰é‡å¯è¿‡å‡ æ¬¡ï¼Œä½†æ˜¯è¿‡æ®µæ—¶é—´ä»ç„¶ä¼šå‘ç”Ÿå†…å­˜å ç”¨è¿‡å¤šçš„è­¦æŠ¥ã€‚ä¸‹é¢æ˜¯æŠ¥è­¦è¯¦æƒ…ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[P1][PROBLEM][ali-e-xxx-service03.bj][][ all(#3) mem.memfree.percent 4.19575&lt;5][o3&gt;2019-10-28 10:20:00]&lt;/5][o3&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;é—®é¢˜æ¨æ–­&quot;&gt;&lt;a href=&quot;#é—®é¢˜æ¨æ–­&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æ¨æ–­&quot;&gt;&lt;/a&gt;é—®é¢˜æ¨æ–­&lt;/h2&gt;&lt;p&gt;åŸ‹ç‚¹æœåŠ¡ä¸»è¦æ¥æ”¶å®¢æˆ·ç«¯å‹ç¼©è¿‡çš„ä¸ŠæŠ¥è¯·æ±‚ï¼Œå¹¶å¯¹è¯·æ±‚æ•°æ®åšè§£å‹ï¼ŒæŠ•é€’åˆ°kafkaï¼Œé€»è¾‘åŠŸèƒ½ç›¸å¯¹ç®€å•ã€‚åˆæ­¥æ€€ç–‘æ˜¯æŸäº›èµ„æºæ²¡æœ‰é‡Šæ”¾å¯¼è‡´çš„å†…å­˜æ³„éœ²æˆ–Groutineæ³„éœ²ã€‚&lt;/p&gt;
&lt;h2 id=&quot;é—®é¢˜æ’æŸ¥&quot;&gt;&lt;a href=&quot;#é—®é¢˜æ’æŸ¥&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æ’æŸ¥&quot;&gt;&lt;/a&gt;é—®é¢˜æ’æŸ¥&lt;/h2&gt;&lt;p&gt;ç”±äºä»£ç ä¸æ˜¯ç”±æˆ‘ä»¬ä¸šåŠ¡æ–¹ç»´æŠ¤çš„ï¼Œé¦–å…ˆå‘ç›¸å…³éƒ¨é—¨ç´¢è¦äº†ä»£ç æƒé™ã€‚é˜…è¯»äº†ä¸€ä¸‹æºç ï¼Œæ‰€æœ‰èµ„æºé‡Šæ”¾éƒ½æ˜¯ç”±deferè¿›è¡Œæ“ä½œçš„ï¼Œå¹¶æ²¡æœ‰å‘ç°å¾ˆæ˜æ˜¾çš„èµ„æºæœªé‡Šæ”¾çš„æƒ…å†µã€‚&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;1-ä¿®æ”¹çº¿ä¸Šç¯å¢ƒé…ç½®ï¼Œæ‰“å¼€traceç«¯å£&quot;&gt;&lt;a href=&quot;#1-ä¿®æ”¹çº¿ä¸Šç¯å¢ƒé…ç½®ï¼Œæ‰“å¼€traceç«¯å£&quot; class=&quot;headerlink&quot; title=&quot;1. ä¿®æ”¹çº¿ä¸Šç¯å¢ƒé…ç½®ï¼Œæ‰“å¼€traceç«¯å£&quot;&gt;&lt;/a&gt;1. ä¿®æ”¹çº¿ä¸Šç¯å¢ƒé…ç½®ï¼Œæ‰“å¼€traceç«¯å£&lt;/h3&gt;&lt;p&gt;åœ¨è°ƒè¯•åˆ†æé—®é¢˜ä¹‹å‰ï¼Œç†Ÿæ‚‰goçš„åŒå­¦éƒ½çŸ¥é“ Golang æä¾›äº†éå¸¸æ–¹ä¾¿çš„æ€§èƒ½è¯Šæ–­å·¥å…· &lt;code&gt;go tool trace&lt;/code&gt;;  &lt;code&gt;go tool trace&lt;/code&gt; æ˜¯ Golang ä¸­çš„æ€§èƒ½å¤§æ€å™¨ï¼Œ èƒ½æ­éœ²è¿è¡Œä¸­çš„æ‰€æœ‰çš„è¿è¡Œæ—¶äº‹ä»¶å’Œå†…å­˜å ç”¨ç­‰ã€‚ å®ƒæ˜¯ Go ç”Ÿæ€ç³»ç»Ÿä¸­ç”¨äºè¯Šæ–­æ€§èƒ½é—®é¢˜æ—¶ï¼ˆå¦‚å»¶è¿Ÿï¼Œå¹¶è¡ŒåŒ–å’Œç«äº‰å¼‚å¸¸ï¼‰æœ€æœ‰ç”¨çš„å·¥å…·ä¹‹ä¸€ã€‚ æ›´å¤š go tool å·¥å…·å¯æŸ¥çœ‹&lt;a href=&quot;http://team.jiunile.com/blog/2020/09/go-pprof.html&quot;&gt;å¦‚ä½•ä½¿ç”¨ go pprof å®šä½å†…å­˜æ³„æ¼&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ç”±äºéƒ½æ˜¯é‡‡ç”¨å…¬å¸çš„åŸºç¡€åº“ï¼ŒåŸºç¡€åº“ä¸“é—¨å¯¹ &lt;code&gt;go trace&lt;/code&gt; åšäº†å°è£…ã€‚åªéœ€è¦åœ¨çº¿ä¸Šæœºå™¨ä¿®æ”¹config æ–‡ä»¶ï¼Œå°† trace ä¿¡æ¯å‘é€åˆ°é…ç½®æ–‡ä»¶ä¸­çš„æŒ‡å®šç«¯å£å°±å¯ä»¥ä½¿ç”¨ &lt;code&gt;go tool&lt;/code&gt; è¿›è¡Œåˆ†æäº†ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶åæˆ‘åœ¨æœ¬åœ°è¿›è¡Œä½¿ç”¨ &lt;code&gt;go tool&lt;/code&gt; å·¥å…·å‘ç°ç½‘ç»œä¸é€šï¼Œæ’æŸ¥äº†ä¸€ä¸‹å‘ç° trace ç«¯å£æ²¡æœ‰ç»‘å®šåˆ°0.0.0.0ä¸Šã€‚éšå³ç”¨ proxy å·¥å…·å°† 9900 ç«¯å£åå‘ä»£ç†åˆ° 9999 ç«¯å£ï¼Œç„¶åä½¿ç”¨ &lt;code&gt;go tool&lt;/code&gt; å¯¹æ­£å¸¸çŠ¶æ€çš„å†…å­˜å ç”¨åšäº†ä¸€ä¸ªå†…å­˜ç«ç„°å›¾ã€‚å¦‚ä¸‹å›¾:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/go/flame-graph.jpg&quot; alt=&quot;go ç«ç„°å›¾&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;2-é—®é¢˜å¤ç°&quot;&gt;&lt;a href=&quot;#2-é—®é¢˜å¤ç°&quot; class=&quot;headerlink&quot; title=&quot;2. é—®é¢˜å¤ç°&quot;&gt;&lt;/a&gt;2. é—®é¢˜å¤ç°&lt;/h3&gt;&lt;p&gt;è¿‡äº†å‡ å¤©ååˆæ”¶åˆ°äº†æœåŠ¡å™¨è­¦æŠ¥ï¼Œç”±äº qps ä¸Šå‡ï¼Œè¿™æ¬¡æ¯”å‰å‡ æ¬¡æ¥çš„éƒ½æ—©ä¸€äº›ã€‚æ¥åˆ°è­¦æŠ¥åç«‹å³å¯¹å†…å­˜åšäº†ä¸€ä¸ª top&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof -alloc_space http://&amp;#123;addr&amp;#125;/debug/pprof/heap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Showing top 20 nodes out of 55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      flat  flat%   sum%        cum   cum%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    2.76GB 59.76% 59.76%     2.76GB 59.76%  compress/flate.NewReader&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    0.45GB  9.73% 69.49%      0.45GB  9.73%  net/http.newBufioWriterSize&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    0.29GB  6.33% 75.82%     3.05GB 66.09%  compress/gzip.(*Reader).Reset&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    0.25GB  5.35% 81.17%     0.25GB  5.35%  net/http.newBufioReader&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    0.13GB  2.85% 84.01%     0.13GB  2.85%  runtime.rawstringtmp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    0.11GB  2.31% 86.32%     0.11GB  2.31%  bytes.makeSlice&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    0.10GB  2.26% 88.58%     0.10GB  2.26%  runtime.hashGrow&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ¯ä¸€è¡Œè¡¨ç¤ºä¸€ä¸ªå‡½æ•°çš„ä¿¡æ¯ã€‚å‰ä¸¤åˆ—è¡¨ç¤ºå‡½æ•°ä½¿ç”¨å†…å­˜ä»¥åŠç™¾åˆ†æ¯”ï¼›ç¬¬ä¸‰åˆ—æ˜¯å½“å‰æ‰€æœ‰å‡½æ•°ç´¯åŠ ä½¿ç”¨ Memory çš„æ¯”ä¾‹ï¼›ç¬¬å››åˆ—å’Œç¬¬äº”åˆ—ä»£è¡¨è¿™ä¸ªå‡½æ•°ä»¥åŠå­å‡½æ•°è¿è¡Œæ‰€å ç”¨çš„ Memory å’Œæ¯”ä¾‹ï¼ˆä¹Ÿè¢«ç§°ä¸ºç´¯åŠ å€¼ cumulativeï¼‰ï¼Œåº”è¯¥å¤§äºç­‰äºå‰ä¸¤åˆ—çš„å€¼ï¼›æœ€åä¸€åˆ—å°±æ˜¯å‡½æ•°çš„åå­—ã€‚å¦‚æœåº”ç”¨ç¨‹åºæœ‰æ€§èƒ½é—®é¢˜ï¼Œä¸Šé¢è¿™äº›ä¿¡æ¯åº”è¯¥èƒ½å‘Šè¯‰æˆ‘ä»¬å†…å­˜éƒ½èŠ±è´¹åœ¨å“ªäº›å‡½æ•°çš„æ‰§è¡Œä¸Šäº†ï¼Œå¦å¤– pprof çš„ CPU æ—¶é—´åˆ†æä¹Ÿç±»ä¼¼ã€‚&lt;/p&gt;
&lt;p&gt;pprof ä¸ä»…èƒ½æ‰“å°å‡ºæœ€è€—å†…å­˜çš„çš„åœ°æ–¹(top)ï¼Œè¿˜èƒ½åˆ—å‡ºå‡½æ•°ä»£ç ä»¥åŠå¯¹åº”çš„å–æ ·æ•°æ®(list)ã€æ±‡ç¼–ä»£ç ä»¥åŠå¯¹åº”çš„å–æ ·æ•°æ®(disasm)ï¼Œè€Œä¸”èƒ½ä»¥å„ç§æ ·å¼è¿›è¡Œè¾“å‡ºï¼Œæ¯”å¦‚ svgã€gvã€callgrindã€pngã€gif ç­‰ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°çš„æ˜¯å¤§éƒ¨åˆ†å†…å­˜éƒ½è¢«è¿™äº› Reader å ç”¨äº†.&lt;/p&gt;
&lt;h3 id=&quot;3-å¸¦ç€é—®é¢˜é‡æ–°é˜…è¯»ä»£ç &quot;&gt;&lt;a href=&quot;#3-å¸¦ç€é—®é¢˜é‡æ–°é˜…è¯»ä»£ç &quot; class=&quot;headerlink&quot; title=&quot;3.å¸¦ç€é—®é¢˜é‡æ–°é˜…è¯»ä»£ç &quot;&gt;&lt;/a&gt;3.å¸¦ç€é—®é¢˜é‡æ–°é˜…è¯»ä»£ç &lt;/h3&gt;&lt;p&gt;å‰é¢æˆ‘ä»¬è¿›è¡Œäº†å ç”¨çš„åˆæ­¥åˆ†æï¼Œæ‰¾åˆ°äº†å†…å­˜å ç”¨å¤šçš„ Fcuntion æ˜¯ &lt;code&gt;flate.NewReader&lt;/code&gt;, &lt;code&gt;Package flate&lt;/code&gt; å®ç°äº† &lt;code&gt;RFC 1951&lt;/code&gt; ä¸­æè¿°çš„ &lt;code&gt;DEFLATE&lt;/code&gt; å‹ç¼©æ•°æ®æ ¼å¼, gzip åŒ…å®ç°äº†å¯¹åŸºäº &lt;code&gt;DEFLATE&lt;/code&gt; çš„æ–‡ä»¶æ ¼å¼çš„è®¿é—®ã€‚æ‰€ä»¥æˆ‘ä»¬å¸¦ç€é—®é¢˜æˆ‘ä»¬å†æ¬¡å®šä½åˆ°ç›¸å…³æºç å®ç°ï¼Œä¸‹é¢æ˜¯ä¸€äº›å…³é”®å®šä¹‰:&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; Gzip GzipPool&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;GetReader&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(src io.Reader)&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(*gzip.Reader, error)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; Gzip.GetReader(src)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;PutReader&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(reader *gzip.Reader)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Gzip.PutReader(reader)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// GzipPool manages a pool of gzip.Writer.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// The pool uses sync.Pool internally.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; GzipPool &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    readers sync.Pool&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    writers sync.Pool&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œç”¨åˆ°äº† &lt;code&gt;sync.Pool&lt;/code&gt; æ¥ä¼˜åŒ– GC, ä¸ºäº†éªŒè¯å†…å­˜éƒ½åœ¨ pool ä¸Šï¼Œæˆ‘ä»¬åˆä½¿ç”¨ &lt;code&gt;go tool&lt;/code&gt; æä¾›çš„ web å·¥å…·å¯¹æŸ¥çœ‹äº†ä¸€ä¸‹ pool çš„å†…å­˜å ç”¨ï¼Œæœç„¶å¤§éƒ¨åˆ†å ç”¨éƒ½åœ¨ pool ä¸Šã€‚&lt;/p&gt;
&lt;h3 id=&quot;ä»€ä¹ˆæ˜¯-sync-Pool&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯-sync-Pool&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯ sync.Pool?&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯ sync.Pool?&lt;/h3&gt;&lt;p&gt;syncåŒ…æä¾›äº†åŸºç¡€çš„golangå¹¶å‘ç¼–ç¨‹å·¥å…·ã€‚æ ¹æ®å®˜æ–¹æ–‡æ¡£çš„æè¿°:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Poolâ€™s purpose is to cache allocated but unused items for later reuse, relieving pressure on the garbage collector. That is, it makes it easy to build efficient, thread-safe free lists. However, it is not suitable for all free lists.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æˆ‘ä»¬é€šå¸¸ç”¨ golang æ¥æ„å»ºé«˜å¹¶å‘åœºæ™¯ä¸‹çš„åº”ç”¨ï¼Œä½†æ˜¯ç”±äº golang å†…å»ºçš„ GC æœºåˆ¶ä¼šå½±å“åº”ç”¨çš„æ€§èƒ½ï¼Œä¸ºäº†å‡å°‘ GCï¼Œgolang æä¾›äº†å¯¹è±¡é‡ç”¨çš„æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ &lt;code&gt;sync.Pool&lt;/code&gt; å¯¹è±¡æ± ã€‚ &lt;code&gt;sync.Pool&lt;/code&gt; æ˜¯å¯ä¼¸ç¼©çš„ï¼Œå¹¶å‘å®‰å…¨çš„ã€‚å…¶å¤§å°ä»…å—é™äºå†…å­˜çš„å¤§å°ï¼Œå¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€ä¸ªå­˜æ”¾å¯é‡ç”¨å¯¹è±¡çš„å€¼çš„å®¹å™¨ã€‚ è®¾è®¡çš„ç›®çš„æ˜¯å­˜æ”¾å·²ç»åˆ†é…çš„ä½†æ˜¯æš‚æ—¶ä¸ç”¨çš„å¯¹è±¡ï¼Œåœ¨éœ€è¦ç”¨åˆ°çš„æ—¶å€™ç›´æ¥ä» pool ä¸­å–ã€‚çœ‹åˆ°è¿™é‡Œç›¸ä¿¡è®¸å¤šç†Ÿæ‚‰ GC çš„åŒå­¦å¿ƒé‡Œå·²ç»æœ‰ç­”æ¡ˆçš„çŒœæµ‹äº†:  æˆ–è®¸å’Œ GC æœ‰å…³ã€‚&lt;/p&gt;
&lt;h3 id=&quot;Soï¼ŒGolang-çš„-GC-è§¦å‘æ—¶æœºæ˜¯ä»€ä¹ˆï¼Ÿ&quot;&gt;&lt;a href=&quot;#Soï¼ŒGolang-çš„-GC-è§¦å‘æ—¶æœºæ˜¯ä»€ä¹ˆï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;Soï¼ŒGolang çš„ GC è§¦å‘æ—¶æœºæ˜¯ä»€ä¹ˆï¼Ÿ&quot;&gt;&lt;/a&gt;Soï¼ŒGolang çš„ GC è§¦å‘æ—¶æœºæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/h3&gt;&lt;p&gt;Golang GC1.13 ç‰ˆæœ¬çš„ GC å®ç°æ˜¯ä¸‰è‰²æ ‡è®°å¹¶é…åˆå†™å±éšœå’Œè¾…åŠ© GCã€‚è§¦å‘æ¡ä»¶ä¸»è¦æœ‰ä¸¤ä¸ª:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è¶…è¿‡å†…å­˜å¤§å°é˜ˆå€¼&lt;/li&gt;
&lt;li&gt;è¾¾åˆ°å®šæ—¶æ—¶é—´&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;é˜ˆå€¼æ˜¯ç”±ä¸€ä¸ª &lt;code&gt;gcpercent&lt;/code&gt; çš„å˜é‡æ§åˆ¶çš„,å½“æ–°åˆ†é…çš„å†…å­˜å å·²åœ¨ä½¿ç”¨ä¸­çš„å†…å­˜çš„æ¯”ä¾‹è¶…è¿‡ &lt;code&gt;gcprecent&lt;/code&gt; æ—¶å°±ä¼šè§¦å‘ã€‚æ¯”å¦‚ä¸€æ¬¡å›æ”¶å®Œæ¯•åï¼Œå†…å­˜çš„ä½¿ç”¨é‡ä¸º 5Mï¼Œé‚£ä¹ˆä¸‹æ¬¡å›æ”¶çš„æ—¶æœºåˆ™æ˜¯å†…å­˜åˆ†é…è¾¾åˆ° 10M çš„æ—¶å€™ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¹¶ä¸æ˜¯å†…å­˜åˆ†é…è¶Šå¤šï¼Œåƒåœ¾å›æ”¶é¢‘ç‡è¶Šé«˜ã€‚å¦‚æœä¸€ç›´è¾¾ä¸åˆ°å†…å­˜å¤§å°çš„é˜ˆå€¼å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™ GC å°±ä¼šè¢«å®šæ—¶æ—¶é—´è§¦å‘ï¼Œæ¯”å¦‚ä¸€ç›´è¾¾ä¸åˆ°10Mï¼Œé‚£å°±å®šæ—¶ï¼ˆé»˜è®¤2minè§¦å‘ä¸€æ¬¡ï¼‰è§¦å‘ä¸€æ¬¡ GC ä¿è¯èµ„æºçš„å›æ”¶ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æ‰€ä»¥æˆ‘ä»¬å½“å†…å­˜å ç”¨æ…¢æ…¢å‡é«˜çš„æ—¶å€™ï¼Œgc è§¦å‘æ¬¡æ•°ä¼šå‡å°‘å¹¶ä¸”è¶‹è¿‘äº 2minï¼Œæ²¡æœ‰ gc å°±ä¸ä¼šå¯¹ pool ä¸­å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œå¯¼è‡´å†…å­˜å ç”¨ç‡é€æ¸å‡é«˜ã€‚&lt;/p&gt;
&lt;h3 id=&quot;ä¸»åŠ¨è§¦å‘GCè¿›è¡ŒéªŒè¯&quot;&gt;&lt;a href=&quot;#ä¸»åŠ¨è§¦å‘GCè¿›è¡ŒéªŒè¯&quot; class=&quot;headerlink&quot; title=&quot;ä¸»åŠ¨è§¦å‘GCè¿›è¡ŒéªŒè¯&quot;&gt;&lt;/a&gt;ä¸»åŠ¨è§¦å‘GCè¿›è¡ŒéªŒè¯&lt;/h3&gt;&lt;p&gt;ä¿®æ”¹ä»£ç ï¼Œé™åˆ¶ rlimitï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ª goroutine æ¯ 30s ä¸»åŠ¨è°ƒç”¨ gcï¼Œç„¶åè¿›è¡Œæµ‹è¯•åä¸Šçº¿ã€‚è§‚æµ‹çº¿ä¸Šæ¥å£è€—æ—¶å¹¶æœªå‘ç”Ÿæ˜æ˜¾å˜åŒ–ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œå†…å­˜å ç”¨æŠ¥è­¦å†ä¹Ÿæ²¡æœ‰è¢«è§¦å‘è¿‡ã€‚&lt;/p&gt;
&lt;h2 id=&quot;é—®é¢˜æ€»ç»“&quot;&gt;&lt;a href=&quot;#é—®é¢˜æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æ€»ç»“&quot;&gt;&lt;/a&gt;é—®é¢˜æ€»ç»“&lt;/h2&gt;&lt;p&gt;åˆšå¼€å§‹å¯¹å¶å°”è§¦å‘çš„å†…å­˜æŠ¥è­¦å¹¶æ²¡æœ‰è¿‡å¤šçš„åœ¨æ„ï¼Œæœ‰è®¸å¤šä¾¥å¹¸å¿ƒç†ï¼Œä½†é—®é¢˜æ€»å½’æ˜¯å®¢è§‚å­˜åœ¨çš„ï¼ŒåŠæ—¶å‘ç°é—®é¢˜ï¼Œå®šæ—¶æ€»ç»“æ‰èƒ½ä¸æ–­è¿›æ­¥æˆé•¿ï¼Œå°½é‡é¿å…ä¸€æœ‰é—®é¢˜å°±é‡å¯ï¼Œé˜²æ­¢æˆä¸ºSRB(Service ReBoot BoyğŸ˜).&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡ä½œè€…ï¼šä¿æŠ¤æˆ‘æ–¹æå…ƒèŠ³&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;å¾®ä¿¡è®¢é˜…å·&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;æ•…éšœç°è±¡&quot;&gt;&lt;a href=&quot;#æ•…éšœç°è±¡&quot; class=&quot;headerlink&quot; title=&quot;æ•…éšœç°è±¡&quot;&gt;&lt;/a&gt;æ•…éšœç°è±¡&lt;/h2&gt;&lt;p&gt;æŸçº¿ä¸ŠåŸ‹ç‚¹ä¸ŠæŠ¥æœºå™¨å¶å°”è§¦å‘å†…å­˜å ç”¨è¿‡å¤šçš„æŠ¥è­¦ã€‚sshåˆ°æœºå™¨topå‘ç°ä¸»è¦å†…å­˜è¢«åŸ‹ç‚¹æœåŠ¡å ç”¨ã€‚ä¹‹å‰é‡å¯è¿‡å‡ æ¬¡ï¼Œä½†æ˜¯è¿‡æ®µæ—¶é—´ä»ç„¶ä¼šå‘ç”Ÿå†…å­˜å ç”¨è¿‡å¤šçš„è­¦æŠ¥ã€‚ä¸‹é¢æ˜¯æŠ¥è­¦è¯¦æƒ…ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[P1][PROBLEM][ali-e-xxx-service03.bj][][ all(#3) mem.memfree.percent 4.19575&lt;5][O3 &gt;2019-10-28 10:20:00]&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;é—®é¢˜æ¨æ–­&quot;&gt;&lt;a href=&quot;#é—®é¢˜æ¨æ–­&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æ¨æ–­&quot;&gt;&lt;/a&gt;é—®é¢˜æ¨æ–­&lt;/h2&gt;&lt;p&gt;åŸ‹ç‚¹æœåŠ¡ä¸»è¦æ¥æ”¶å®¢æˆ·ç«¯å‹ç¼©è¿‡çš„ä¸ŠæŠ¥è¯·æ±‚ï¼Œå¹¶å¯¹è¯·æ±‚æ•°æ®åšè§£å‹ï¼ŒæŠ•é€’åˆ°kafkaï¼Œé€»è¾‘åŠŸèƒ½ç›¸å¯¹ç®€å•ã€‚åˆæ­¥æ€€ç–‘æ˜¯æŸäº›èµ„æºæ²¡æœ‰é‡Šæ”¾å¯¼è‡´çš„å†…å­˜æ³„éœ²æˆ–Groutineæ³„éœ²ã€‚&lt;/p&gt;
&lt;h2 id=&quot;é—®é¢˜æ’æŸ¥&quot;&gt;&lt;a href=&quot;#é—®é¢˜æ’æŸ¥&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æ’æŸ¥&quot;&gt;&lt;/a&gt;é—®é¢˜æ’æŸ¥&lt;/h2&gt;&lt;p&gt;ç”±äºä»£ç ä¸æ˜¯ç”±æˆ‘ä»¬ä¸šåŠ¡æ–¹ç»´æŠ¤çš„ï¼Œé¦–å…ˆå‘ç›¸å…³éƒ¨é—¨ç´¢è¦äº†ä»£ç æƒé™ã€‚é˜…è¯»äº†ä¸€ä¸‹æºç ï¼Œæ‰€æœ‰èµ„æºé‡Šæ”¾éƒ½æ˜¯ç”±deferè¿›è¡Œæ“ä½œçš„ï¼Œå¹¶æ²¡æœ‰å‘ç°å¾ˆæ˜æ˜¾çš„èµ„æºæœªé‡Šæ”¾çš„æƒ…å†µã€‚&lt;br&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="æ•…éšœåˆ†æ" scheme="http://team.jiunile.com/categories/golang/%E6%95%85%E9%9A%9C%E5%88%86%E6%9E%90/"/>
    
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="å†…å­˜æ³„æ¼" scheme="http://team.jiunile.com/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"/>
    
      <category term="sync.pool" scheme="http://team.jiunile.com/tags/sync-pool/"/>
    
      <category term="gc" scheme="http://team.jiunile.com/tags/gc/"/>
    
  </entry>
  
  <entry>
    <title>å¸¦ä½ è®¤è¯†Kubernetes ç½‘ç»œæ’ä»¶Flannelä¸Calico</title>
    <link href="http://team.jiunile.com//blog/2020/10/k8s-cni.html"/>
    <id>http://team.jiunile.com//blog/2020/10/k8s-cni.html</id>
    <published>2020-10-09T12:00:00.000Z</published>
    <updated>2020-10-09T08:17:27.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h2&gt;&lt;p&gt;å®¹å™¨çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆæœ‰å¾ˆå¤šç§ï¼Œæ¯æ”¯æŒä¸€ç§ç½‘ç»œå®ç°å°±è¿›è¡Œä¸€æ¬¡é€‚é…æ˜¾ç„¶æ˜¯ä¸ç°å®çš„ï¼Œè€Œ CNI å°±æ˜¯ä¸ºäº†å…¼å®¹å¤šç§ç½‘ç»œæ–¹æ¡ˆè€Œå‘æ˜çš„ã€‚CNI æ˜¯ Container Network Interface çš„ç¼©å†™ï¼Œæ˜¯ä¸€ä¸ªæ ‡å‡†çš„é€šç”¨çš„æ¥å£ï¼Œç”¨äºè¿æ¥å®¹å™¨ç®¡ç†ç³»ç»Ÿå’Œç½‘ç»œæ’ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;ç®€å•æ¥è¯´ï¼Œå®¹å™¨ runtime ä¸ºå®¹å™¨æä¾› network namespaceï¼Œç½‘ç»œæ’ä»¶è´Ÿè´£å°† network interface æ’å…¥è¯¥ network namespace ä¸­å¹¶ä¸”åœ¨å®¿ä¸»æœºåšä¸€äº›å¿…è¦çš„é…ç½®ï¼Œæœ€åå¯¹ namespace ä¸­çš„ interface è¿›è¡Œ IP å’Œè·¯ç”±çš„é…ç½®ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ç½‘ç»œæ’ä»¶çš„ä¸»è¦å·¥ä½œå°±åœ¨äºä¸ºå®¹å™¨æä¾›ç½‘ç»œç¯å¢ƒï¼ŒåŒ…æ‹¬ä¸º pod è®¾ç½® ip åœ°å€ã€é…ç½®è·¯ç”±ä¿è¯é›†ç¾¤å†…ç½‘ç»œçš„é€šç•…ã€‚ç›®å‰æ¯”è¾ƒæµè¡Œçš„ç½‘ç»œæ’ä»¶æ˜¯ Flannel å’Œ Calicoã€‚&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;Flannel&quot;&gt;&lt;a href=&quot;#Flannel&quot; class=&quot;headerlink&quot; title=&quot;Flannel&quot;&gt;&lt;/a&gt;Flannel&lt;/h2&gt;&lt;p&gt;Flannel ä¸»è¦æä¾›çš„æ˜¯é›†ç¾¤å†…çš„ Overlay ç½‘ç»œï¼Œæ”¯æŒä¸‰ç§åç«¯å®ç°ï¼Œåˆ†åˆ«æ˜¯ï¼šUDP æ¨¡å¼ã€VXLAN æ¨¡å¼ã€host-gw æ¨¡å¼ã€‚&lt;/p&gt;
&lt;h3 id=&quot;UDPæ¨¡å¼&quot;&gt;&lt;a href=&quot;#UDPæ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;UDPæ¨¡å¼&quot;&gt;&lt;/a&gt;UDPæ¨¡å¼&lt;/h3&gt;&lt;p&gt;UDP æ¨¡å¼ï¼Œæ˜¯ Flannel é¡¹ç›®æœ€æ—©æ”¯æŒçš„ä¸€ç§æ–¹å¼ï¼Œå´ä¹Ÿæ˜¯æ€§èƒ½æœ€å·®çš„ä¸€ç§æ–¹å¼ã€‚è¿™ç§æ¨¡å¼æä¾›çš„æ˜¯ä¸€ä¸ªä¸‰å±‚çš„ Overlay ç½‘ç»œï¼Œå³ï¼šå®ƒé¦–å…ˆå¯¹å‘å‡ºç«¯çš„ IP åŒ…è¿›è¡Œ UDP å°è£…ï¼Œç„¶ååœ¨æ¥æ”¶ç«¯è¿›è¡Œè§£å°è£…æ‹¿åˆ°åŸå§‹çš„ IP åŒ…ï¼Œè¿›è€ŒæŠŠè¿™ä¸ª IP åŒ…è½¬å‘ç»™ç›®æ ‡å®¹å™¨ã€‚å·¥ä½œåŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚&lt;br&gt;&lt;img src=&quot;/images/k8s/cni-flannel-udp.jpg&quot; alt=&quot;cni flannel&quot;&gt;&lt;/p&gt;
&lt;p&gt;node1 ä¸Šçš„ pod1 è¯·æ±‚ node2 ä¸Šçš„ pod2 æ—¶ï¼Œæµé‡çš„èµ°å‘å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;pod1 é‡Œçš„è¿›ç¨‹å‘èµ·è¯·æ±‚ï¼Œå‘å‡º IP åŒ…&lt;/li&gt;
&lt;li&gt;IP åŒ…æ ¹æ® pod1 é‡Œçš„ veth è®¾å¤‡å¯¹ï¼Œè¿›å…¥åˆ° cni0 ç½‘æ¡¥&lt;/li&gt;
&lt;li&gt;ç”±äº IP åŒ…çš„ç›®çš„ ip ä¸åœ¨ node1 ä¸Šï¼Œæ ¹æ® flannel åœ¨èŠ‚ç‚¹ä¸Šåˆ›å»ºå‡ºæ¥çš„è·¯ç”±è§„åˆ™ï¼Œè¿›å…¥åˆ° flannel0 ä¸­&lt;/li&gt;
&lt;li&gt;æ­¤æ—¶ flanneld è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ªåŒ…ï¼Œflanneld åˆ¤æ–­è¯¥åŒ…åº”è¯¥åœ¨å“ªå° node ä¸Šï¼Œç„¶åå°†å…¶å°è£…åœ¨ä¸€ä¸ª UDP åŒ…ä¸­&lt;/li&gt;
&lt;li&gt;æœ€åé€šè¿‡ node1 ä¸Šçš„ç½‘å…³ï¼Œå‘é€ç»™ node2&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;flannel0 æ˜¯ä¸€ä¸ª TUN è®¾å¤‡ï¼ˆTunnel è®¾å¤‡ï¼‰ã€‚åœ¨ Linux ä¸­ï¼ŒTUN è®¾å¤‡æ˜¯ä¸€ç§å·¥ä½œåœ¨ä¸‰å±‚ï¼ˆNetwork Layerï¼‰çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ã€‚TUN è®¾å¤‡çš„åŠŸèƒ½ï¼šåœ¨æ“ä½œç³»ç»Ÿå†…æ ¸å’Œç”¨æˆ·åº”ç”¨ç¨‹åºä¹‹é—´ä¼ é€’ IP åŒ…ã€‚&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§æ¨¡å¼æ€§èƒ½å·®çš„åŸå› åœ¨äºï¼Œæ•´ä¸ªåŒ…çš„ UDP å°è£…è¿‡ç¨‹æ˜¯ flanneld ç¨‹åºåšçš„ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ€ï¼Œè€Œè¿™å°±å¸¦æ¥äº†ä¸€æ¬¡å†…æ ¸æ€å‘ç”¨æˆ·æ€çš„è½¬æ¢ï¼Œä»¥åŠä¸€æ¬¡ç”¨æˆ·æ€å‘å†…æ ¸æ€çš„è½¬æ¢ã€‚åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç”¨æˆ·æ€æ“ä½œçš„ä»£ä»·å…¶å®æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œè€Œ UDP æ¨¡å¼å› ä¸ºå°åŒ…æ‹†åŒ…å¸¦æ¥äº†é¢å¤–çš„æ€§èƒ½æ¶ˆè€—ã€‚&lt;/p&gt;
&lt;h3 id=&quot;VXLAN-æ¨¡å¼&quot;&gt;&lt;a href=&quot;#VXLAN-æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;VXLAN æ¨¡å¼&quot;&gt;&lt;/a&gt;VXLAN æ¨¡å¼&lt;/h3&gt;&lt;p&gt;VXLANï¼Œå³ Virtual Extensible LANï¼ˆè™šæ‹Ÿå¯æ‰©å±•å±€åŸŸç½‘ï¼‰ï¼Œæ˜¯ Linux å†…æ ¸æœ¬èº«å°±æ”¯æŒçš„ä¸€ç§ç½‘ç»œè™šä¼¼åŒ–æŠ€æœ¯ã€‚é€šè¿‡åˆ©ç”¨ Linux å†…æ ¸çš„è¿™ç§ç‰¹æ€§ï¼Œä¹Ÿå¯ä»¥å®ç°åœ¨å†…æ ¸æ€çš„å°è£…å’Œè§£å°è£…çš„èƒ½åŠ›ï¼Œä»è€Œæ„å»ºå‡ºè¦†ç›–ç½‘ç»œã€‚å…¶å·¥ä½œåŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br&gt;&lt;img src=&quot;/images/k8s/cni-flannel-vxlan.jpg&quot; alt=&quot;cni flannel&quot;&gt;&lt;/p&gt;
&lt;p&gt;VXLAN æ¨¡å¼çš„ flannel ä¼šåœ¨èŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªå« flannel.1 çš„ VTEP (VXLAN Tunnel End Pointï¼Œè™šæ‹Ÿéš§é“ç«¯ç‚¹) è®¾å¤‡ï¼Œè·Ÿ UDP æ¨¡å¼ä¸€æ ·ï¼Œè¯¥è®¾å¤‡å°†äºŒå±‚æ•°æ®å¸§å°è£…åœ¨ UDP åŒ…é‡Œï¼Œå†è½¬å‘å‡ºå»ï¼Œè€Œä¸ UDP æ¨¡å¼ä¸ä¸€æ ·çš„æ˜¯ï¼Œæ•´ä¸ªå°è£…çš„è¿‡ç¨‹æ˜¯åœ¨å†…æ ¸æ€å®Œæˆçš„ã€‚&lt;/p&gt;
&lt;p&gt;node1 ä¸Šçš„ pod1 è¯·æ±‚ node2 ä¸Šçš„ pod2 æ—¶ï¼Œæµé‡çš„èµ°å‘å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;pod1 é‡Œçš„è¿›ç¨‹å‘èµ·è¯·æ±‚ï¼Œå‘å‡º IP åŒ…&lt;/li&gt;
&lt;li&gt;IP åŒ…æ ¹æ® pod1 é‡Œçš„ veth è®¾å¤‡å¯¹ï¼Œè¿›å…¥åˆ° cni0 ç½‘æ¡¥&lt;/li&gt;
&lt;li&gt;ç”±äº IP åŒ…çš„ç›®çš„ ip ä¸åœ¨ node1 ä¸Šï¼Œæ ¹æ® flannel åœ¨èŠ‚ç‚¹ä¸Šåˆ›å»ºå‡ºæ¥çš„è·¯ç”±è§„åˆ™ï¼Œè¿›å…¥åˆ° flannel.1 ä¸­&lt;/li&gt;
&lt;li&gt;flannel.1 å°†åŸå§‹ IP åŒ…åŠ ä¸Šä¸€ä¸ªç›®çš„ MAC åœ°å€ï¼Œå°è£…æˆä¸€ä¸ªäºŒå±‚æ•°æ®å¸§ï¼›ç„¶åå†…æ ¸å°†æ•°æ®å¸§å°è£…è¿›ä¸€ä¸ª UDP åŒ…é‡Œ&lt;/li&gt;
&lt;li&gt;æœ€åé€šè¿‡ node1 ä¸Šçš„ç½‘å…³ï¼Œå‘é€ç»™ node2&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&quot;æŠ“åŒ…éªŒè¯&quot;&gt;&lt;a href=&quot;#æŠ“åŒ…éªŒè¯&quot; class=&quot;headerlink&quot; title=&quot;æŠ“åŒ…éªŒè¯&quot;&gt;&lt;/a&gt;æŠ“åŒ…éªŒè¯&lt;/h4&gt;&lt;p&gt;åœ¨ node1 ä¸Šéƒ¨ç½²ä¸€ä¸ª nginx pod1ï¼Œnode2 ä¸Šéƒ¨ç½²ä¸€ä¸ª nginx pod2ã€‚ç„¶ååœ¨ pod1 çš„å®¹å™¨ä¸­ curl pod2 å®¹å™¨çš„ 80 ç«¯å£ã€‚&lt;/p&gt;
&lt;p&gt;é›†ç¾¤ç½‘ç»œç¯å¢ƒå¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;node1 ç½‘å¡ ens33ï¼š192.168.50.10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pod1 vethï¼š10.244.0.7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node1 cni0ï¼š10.244.0.1/24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node1 flannel.1ï¼š10.244.0.0/32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node2 ç½‘å¡ ens33ï¼š192.168.50.11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pod2 vethï¼š10.244.1.9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node2 cni0ï¼š10.244.1.1/24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node2 flannel.1ï¼š10.244.1.0/32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;node1 ä¸Šçš„è·¯ç”±ä¿¡æ¯å¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;âœ  ~ ip route&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;default via 192.168.50.1 dev ens33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10.244.0.0/24 dev cni0 proto kernel scope link src 10.244.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10.244.2.0/24 via 10.244.2.0 dev flannel.1 onlink&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;192.168.50.0/24 dev ens33 proto kernel scope link src 192.168.50.10 metric 100&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;node1 çš„ç½‘å¡ ens33 çš„æŠ“åŒ…æƒ…å†µï¼š&lt;br&gt;&lt;img src=&quot;/images/k8s/cni-flannel-tcpdump.png&quot; alt=&quot;cni flannel&quot;&gt;&lt;/p&gt;
&lt;p&gt;åªèƒ½çœ‹åˆ°æº ip ä¸º node1 ipã€ç›®çš„ ip ä¸º node2 ip çš„ UDP åŒ…ã€‚ç”±äº flannel.1 è¿›è¡Œäº†ä¸€å±‚ UDP å°åŒ…ï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨ Wireshark ä¸­è®¾ç½®ä¸€ä¸‹å°† UDP åŒ…è§£æä¸º VxLAN æ ¼å¼ï¼ˆç«¯å£ä¸º 8472ï¼‰ï¼Œè®¾ç½®è¿‡ç¨‹ä¸º Analyze-&amp;gt;Decode Asï¼š&lt;br&gt;&lt;img src=&quot;/images/k8s/cni-flannel-tcpdump2.png&quot; alt=&quot;cni flannel&quot;&gt;&lt;/p&gt;
&lt;p&gt;ç„¶åå†æ¥çœ‹ä¸€ä¸‹ node1 ç½‘å¡ä¸Šæ”¶åˆ°çš„åŒ…ï¼š&lt;br&gt;&lt;img src=&quot;/images/k8s/cni-flannel-tcpdump3.png&quot; alt=&quot;cni flannel&quot;&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°æº ip ä¸º pod1 ipã€ç›®çš„ ip ä¸º pod2 ipï¼Œå¹¶ä¸”è¯¥ IP åŒ…è¢«å°è£…åœ¨ UDP åŒ…ä¸­ã€‚&lt;/p&gt;
&lt;h3 id=&quot;host-gw-æ¨¡å¼&quot;&gt;&lt;a href=&quot;#host-gw-æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;host-gw æ¨¡å¼&quot;&gt;&lt;/a&gt;host-gw æ¨¡å¼&lt;/h3&gt;&lt;p&gt;æœ€åä¸€ç§ host-gw æ¨¡å¼æ˜¯ä¸€ç§çº¯ä¸‰å±‚ç½‘ç»œæ–¹æ¡ˆã€‚å…¶å·¥ä½œåŸç†ä¸ºå°†æ¯ä¸ª Flannel å­ç½‘çš„â€œä¸‹ä¸€è·³â€è®¾ç½®æˆäº†è¯¥å­ç½‘å¯¹åº”çš„å®¿ä¸»æœºçš„ IP åœ°å€ï¼Œè¿™å°ä¸»æœºä¼šå……å½“è¿™æ¡å®¹å™¨é€šä¿¡è·¯å¾„é‡Œçš„â€œç½‘å…³â€ã€‚è¿™æ · IP åŒ…å°±èƒ½é€šè¿‡äºŒå±‚ç½‘ç»œè¾¾åˆ°ç›®çš„ä¸»æœºï¼Œè€Œæ­£æ˜¯å› ä¸ºè¿™ä¸€ç‚¹ï¼Œhost-gw æ¨¡å¼è¦æ±‚é›†ç¾¤å®¿ä¸»æœºä¹‹é—´çš„ç½‘ç»œæ˜¯äºŒå±‚è¿é€šçš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚&lt;br&gt;&lt;img src=&quot;/images/k8s/cni-flannel-host-gw.jpg&quot; alt=&quot;cni flannel&quot;&gt;&lt;/p&gt;
&lt;p&gt;å®¿ä¸»æœºä¸Šçš„è·¯ç”±ä¿¡æ¯æ˜¯ flanneld è®¾ç½®çš„ï¼Œå› ä¸º flannel å­ç½‘å’Œä¸»æœºçš„ä¿¡æ¯ä¿å­˜åœ¨ etcd ä¸­ï¼Œæ‰€ä»¥ flanneld åªéœ€è¦ watch è¿™äº›æ•°æ®çš„å˜åŒ–ï¼Œå®æ—¶æ›´æ–°è·¯ç”±è¡¨å³å¯ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå®¹å™¨é€šä¿¡çš„è¿‡ç¨‹å°±å…é™¤äº†é¢å¤–çš„å°åŒ…å’Œè§£åŒ…å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚&lt;/p&gt;
&lt;p&gt;node1 ä¸Šçš„ pod1 è¯·æ±‚ node2 ä¸Šçš„ pod2 æ—¶ï¼Œæµé‡çš„èµ°å‘å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;pod1 é‡Œçš„è¿›ç¨‹å‘èµ·è¯·æ±‚ï¼Œå‘å‡º IP åŒ…ï¼Œä»ç½‘ç»œå±‚è¿›å…¥é“¾è·¯å±‚å°è£…æˆå¸§&lt;/li&gt;
&lt;li&gt;æ ¹æ®ä¸»æœºä¸Šçš„è·¯ç”±è§„åˆ™ï¼Œæ•°æ®å¸§ä» Node 1 é€šè¿‡å®¿ä¸»æœºçš„äºŒå±‚ç½‘ç»œåˆ°è¾¾ Node 2 ä¸Š&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;Calico&quot;&gt;&lt;a href=&quot;#Calico&quot; class=&quot;headerlink&quot; title=&quot;Calico&quot;&gt;&lt;/a&gt;Calico&lt;/h2&gt;&lt;p&gt;Calico æ²¡æœ‰ä½¿ç”¨ CNI çš„ç½‘æ¡¥æ¨¡å¼ï¼Œè€Œæ˜¯å°†èŠ‚ç‚¹å½“æˆè¾¹ç•Œè·¯ç”±å™¨ï¼Œç»„æˆäº†ä¸€ä¸ªå…¨è¿é€šçš„ç½‘ç»œï¼Œé€šè¿‡ BGP åè®®äº¤æ¢è·¯ç”±ã€‚æ‰€ä»¥ï¼ŒCalico çš„ CNI æ’ä»¶è¿˜éœ€è¦åœ¨å®¿ä¸»æœºä¸Šä¸ºæ¯ä¸ªå®¹å™¨çš„ Veth Pair è®¾å¤‡é…ç½®ä¸€æ¡è·¯ç”±è§„åˆ™ï¼Œç”¨äºæ¥æ”¶ä¼ å…¥çš„ IP åŒ…ã€‚&lt;/p&gt;
&lt;p&gt;Calico çš„ç»„ä»¶ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;CNI æ’ä»¶ï¼šCalico ä¸ Kubernetes å¯¹æ¥çš„éƒ¨åˆ†&lt;/li&gt;
&lt;li&gt;Felixï¼šè´Ÿè´£åœ¨å®¿ä¸»æœºä¸Šæ’å…¥è·¯ç”±è§„åˆ™ï¼ˆå³ï¼šå†™å…¥ Linux å†…æ ¸çš„ FIB è½¬å‘ä¿¡æ¯åº“ï¼‰ï¼Œä»¥åŠç»´æŠ¤ Calico æ‰€éœ€çš„ç½‘ç»œè®¾å¤‡ç­‰å·¥ä½œã€‚&lt;/li&gt;
&lt;li&gt;BIRD (BGP Route Reflector)ï¼šæ˜¯ BGP çš„å®¢æˆ·ç«¯ï¼Œä¸“é—¨è´Ÿè´£åœ¨é›†ç¾¤é‡Œåˆ†å‘è·¯ç”±è§„åˆ™ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ä¸‰ä¸ªç»„ä»¶éƒ½æ˜¯é€šè¿‡ä¸€ä¸ª DaemonSet å®‰è£…çš„ã€‚CNI æ’ä»¶æ˜¯é€šè¿‡ initContainer å®‰è£…çš„ï¼›è€Œ Felix å’Œ BIRD æ˜¯åŒä¸€ä¸ª pod çš„ä¸¤ä¸ª containerã€‚&lt;/p&gt;
&lt;h3 id=&quot;BGP-å·¥ä½œåŸç†&quot;&gt;&lt;a href=&quot;#BGP-å·¥ä½œåŸç†&quot; class=&quot;headerlink&quot; title=&quot;BGP å·¥ä½œåŸç†&quot;&gt;&lt;/a&gt;BGP å·¥ä½œåŸç†&lt;/h3&gt;&lt;p&gt;Calico é‡‡ç”¨çš„ BGPï¼Œå°±æ˜¯åœ¨å¤§è§„æ¨¡ç½‘ç»œä¸­å®ç°èŠ‚ç‚¹è·¯ç”±ä¿¡æ¯å…±äº«çš„ä¸€ç§åè®®ã€‚å…¨ç§°æ˜¯ Border Gateway Protocolï¼Œå³ï¼šè¾¹ç•Œç½‘å…³åè®®ã€‚å®ƒæ˜¯ä¸€ä¸ª Linux å†…æ ¸åŸç”Ÿå°±æ”¯æŒçš„ã€ä¸“é—¨ç”¨åœ¨å¤§è§„æ¨¡æ•°æ®ä¸­å¿ƒé‡Œç»´æŠ¤ä¸åŒçš„ â€œè‡ªæ²»ç³»ç»Ÿâ€ ä¹‹é—´è·¯ç”±ä¿¡æ¯çš„ã€æ— ä¸­å¿ƒçš„è·¯ç”±åè®®ã€‚&lt;/p&gt;
&lt;p&gt;ç”±äºæ²¡æœ‰ä½¿ç”¨ CNI çš„ç½‘æ¡¥ï¼ŒCalico çš„ CNI æ’ä»¶éœ€è¦ä¸ºæ¯ä¸ªå®¹å™¨è®¾ç½®ä¸€ä¸ª Veth Pair è®¾å¤‡ï¼Œç„¶åæŠŠå…¶ä¸­çš„ä¸€ç«¯æ”¾ç½®åœ¨å®¿ä¸»æœºä¸Šï¼Œè¿˜éœ€è¦åœ¨å®¿ä¸»æœºä¸Šä¸ºæ¯ä¸ªå®¹å™¨çš„ Veth Pair è®¾å¤‡é…ç½®ä¸€æ¡è·¯ç”±è§„åˆ™ï¼Œç”¨äºæ¥æ”¶ä¼ å…¥çš„ IP åŒ…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;br&gt;&lt;img src=&quot;/images/k8s/cni-calico-bgp.jpg&quot; alt=&quot;cni calico&quot;&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥ä½¿ç”¨ calicoctl æŸ¥çœ‹ node1 çš„èŠ‚ç‚¹è¿æ¥æƒ…å†µï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;~ calicoctl get no&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;~ calicoctl node status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Calico process is running.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;IPv4 BGP status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+---------------+-------------------+-------+------------+-------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| PEER ADDRESS  |     PEER TYPE     | STATE |   SINCE    |    INFO     |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+---------------+-------------------+-------+------------+-------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| 192.168.50.11 | node-to-node mesh | up    | 2020-09-28 | Established |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| 192.168.50.12 | node-to-node mesh | up    | 2020-09-28 | Established |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+---------------+-------------------+-------+------------+-------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;IPv6 BGP status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;No IPv6 peers found.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°æ•´ä¸ª calico é›†ç¾¤ä¸Šæœ‰ 3 ä¸ªèŠ‚ç‚¹ï¼Œnode1 å’Œå¦å¤–ä¸¤ä¸ªèŠ‚ç‚¹å¤„äºè¿æ¥çŠ¶æ€ï¼Œæ¨¡å¼ä¸º â€œNode-to-Node Meshâ€ã€‚å†çœ‹ä¸‹ node1 ä¸Šçš„è·¯ç”±ä¿¡æ¯å¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;~ ip route&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;default via 192.168.50.1 dev ens33 proto static metric 100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10.244.104.0/26 via 192.168.50.11 dev ens33 proto bird&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10.244.135.0/26 via 192.168.50.12 dev ens33 proto bird&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10.244.166.128 dev cali717821d73f3 scope link&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;blackhole 10.244.166.128/26 proto bird&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;192.168.50.0/24 dev ens33 proto kernel scope link src 192.168.50.10 metric 100&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å…¶ä¸­ï¼Œç¬¬ 2 æ¡çš„è·¯ç”±è§„åˆ™è¡¨æ˜ 10.244.104.0/26 ç½‘æ®µçš„æ•°æ®åŒ…é€šè¿‡ bird åè®®ç”± ens33 è®¾å¤‡å‘å¾€ç½‘å…³ 192.168.50.11ã€‚è¿™ä¹Ÿå°±å®šä¹‰äº†ç›®çš„ ip ä¸º node2 ä¸Š pod è¯·æ±‚çš„èµ°å‘ã€‚ç¬¬ 3 æ¡è·¯ç”±è§„åˆ™ä¸ä¹‹ç±»ä¼¼ã€‚&lt;/p&gt;
&lt;h4 id=&quot;æŠ“åŒ…éªŒè¯-1&quot;&gt;&lt;a href=&quot;#æŠ“åŒ…éªŒè¯-1&quot; class=&quot;headerlink&quot; title=&quot;æŠ“åŒ…éªŒè¯&quot;&gt;&lt;/a&gt;æŠ“åŒ…éªŒè¯&lt;/h4&gt;&lt;p&gt;ä¸ä¸Šé¢ä¸€æ ·ï¼Œä» node1 ä¸Šçš„ pod1 å‘é€ä¸€ä¸ª http è¯·æ±‚åˆ° node2 ä¸Šçš„ pod2ã€‚&lt;/p&gt;
&lt;p&gt;é›†ç¾¤ç½‘ç»œç¯å¢ƒå¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;node1 ç½‘å¡ ens33ï¼š192.168.50.10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pod1 ipï¼š10.244.166.128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node2 ç½‘å¡ ens33ï¼š192.168.50.11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pod2 ipï¼š10.244.104.1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;node1 çš„ç½‘å¡ ens33 çš„æŠ“åŒ…æƒ…å†µï¼š&lt;br&gt;&lt;img src=&quot;/images/k8s/cni-calico-tcpdump.png&quot; alt=&quot;cni calico&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;IPIP-æ¨¡å¼&quot;&gt;&lt;a href=&quot;#IPIP-æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;IPIP æ¨¡å¼&quot;&gt;&lt;/a&gt;IPIP æ¨¡å¼&lt;/h3&gt;&lt;p&gt;IPIP æ¨¡å¼ä¸ºäº†è§£å†³ä¸¤ä¸ª node ä¸åœ¨ä¸€ä¸ªå­ç½‘çš„é—®é¢˜ã€‚åªè¦å°†åä¸º calico-node çš„ daemonset çš„ç¯å¢ƒå˜é‡ CALICO_IPV4POOL_IPIP è®¾ç½®ä¸º â€œAlwaysâ€ å³å¯ã€‚å¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;- name: CALICO_IPV4POOL_IPIP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  value: &lt;span class=&quot;string&quot;&gt;&quot;Off&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;IPIP æ¨¡å¼çš„ calico ä½¿ç”¨äº† tunl0 è®¾å¤‡ï¼Œè¿™æ˜¯ä¸€ä¸ª IP éš§é“è®¾å¤‡ã€‚IP åŒ…è¿›å…¥ tunl0 åï¼Œå†…æ ¸ä¼šå°†åŸå§‹ IP åŒ…ç›´æ¥å°è£…åœ¨å®¿ä¸»æœºçš„ IP åŒ…ä¸­ï¼›å°è£…åçš„ IP åŒ…çš„ç›®çš„åœ°å€ä¸ºä¸‹ä¸€è·³åœ°å€ï¼Œå³ node2 çš„ IP åœ°å€ã€‚ç”±äºå®¿ä¸»æœºä¹‹é—´å·²ç»ä½¿ç”¨è·¯ç”±å™¨é…ç½®äº†ä¸‰å±‚è½¬å‘ï¼Œæ‰€ä»¥è¿™ä¸ª IP åŒ…åœ¨ç¦»å¼€ node 1 ä¹‹åï¼Œå°±å¯ä»¥ç»è¿‡è·¯ç”±å™¨ï¼Œæœ€ç»ˆå‘é€åˆ° node 2 ä¸Šã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚&lt;br&gt;&lt;img src=&quot;/images/k8s/cni-calico-ipip.jpg&quot; alt=&quot;cni calico&quot;&gt;&lt;/p&gt;
&lt;p&gt;ç”±äº IPIP æ¨¡å¼çš„ Calico é¢å¤–å¤šå‡ºäº†å°åŒ…å’Œæ‹†åŒ…çš„è¿‡ç¨‹ï¼Œé›†ç¾¤çš„ç½‘ç»œæ€§èƒ½å—åˆ°äº†å½±å“ï¼Œæ‰€ä»¥åœ¨é›†ç¾¤çš„äºŒå±‚ç½‘ç»œé€šçš„æƒ…å†µä¸‹ï¼Œå»ºè®®ä¸è¦ä½¿ç”¨ IPIP æ¨¡å¼ã€‚&lt;/p&gt;
&lt;p&gt;çœ‹ä¸‹ node1 ä¸Šçš„è·¯ç”±ä¿¡æ¯ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;~ ip route&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;default via 192.168.50.1 dev ens33 proto static metric 100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10.244.104.0/26 via 192.168.50.11 dev tunl0 proto bird onlink&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10.244.135.0/26 via 192.168.50.12 dev tunl0 proto bird onlink&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;blackhole 10.244.166.128/26 proto bird&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10.244.166.129 dev calif3c799362a5 scope link&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;192.168.50.0/24 dev ens33 proto kernel scope link src 192.168.50.10 metric 100&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œä¸ä¹‹å‰ä¸ä¸€æ ·çš„æ˜¯ï¼Œç›®çš„ IP ä¸º node2 ä¸Šçš„ Pod çš„æ•°æ®åŒ…æ˜¯ç»ç”± tunl0 å‘é€åˆ°ç½‘å…³ 192.168.50.11ã€‚&lt;/p&gt;
&lt;h4 id=&quot;æŠ“åŒ…éªŒè¯-2&quot;&gt;&lt;a href=&quot;#æŠ“åŒ…éªŒè¯-2&quot; class=&quot;headerlink&quot; title=&quot;æŠ“åŒ…éªŒè¯&quot;&gt;&lt;/a&gt;æŠ“åŒ…éªŒè¯&lt;/h4&gt;&lt;p&gt;ä» node1 ä¸Šçš„ pod1 å‘é€ä¸€ä¸ª http è¯·æ±‚åˆ° node2 ä¸Šçš„ pod2ã€‚&lt;/p&gt;
&lt;p&gt;é›†ç¾¤ç½‘ç»œç¯å¢ƒå¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;node1 ç½‘å¡ ens33ï¼š192.168.50.10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node1 tunl0ï¼š10.244.166.128/32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pod1 ipï¼š10.244.166.129&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node2 ç½‘å¡ ens33ï¼š192.168.50.11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pod2 ipï¼š10.244.104.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node2 tunl0ï¼š10.244.104.0/32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;tunl0 è®¾å¤‡çš„æŠ“åŒ…æƒ…å†µï¼š&lt;br&gt;&lt;img src=&quot;/images/k8s/cni-calico-ipip-tcpdump.jpg&quot; alt=&quot;cni calico&quot;&gt;&lt;/p&gt;
&lt;p&gt;node1 ç½‘å¡ ens33 çš„æŠ“åŒ…æƒ…å†µï¼š&lt;br&gt;&lt;img src=&quot;/images/k8s/cni-calico-ipip-tcpdump2.jpg&quot; alt=&quot;cni calico&quot;&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼ŒIP åŒ…åœ¨ tunl0 è®¾å¤‡ä¸­è¢«å°è£…è¿›äº†å¦ä¸€ä¸ª IP åŒ…ï¼Œå…¶ç›®çš„ IP ä¸º node2 çš„ IPï¼Œæº IP ä¸º node1 çš„ IPã€‚&lt;/p&gt;
&lt;h2 id=&quot;æ€»ç»“&quot;&gt;&lt;a href=&quot;#æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;æ€»ç»“&quot;&gt;&lt;/a&gt;æ€»ç»“&lt;/h2&gt;&lt;p&gt;Kubernetes çš„é›†ç¾¤ç½‘ç»œæ’ä»¶å®ç°æ–¹æ¡ˆæœ‰å¾ˆå¤šç§ï¼Œæœ¬æ–‡ä¸»è¦åˆ†æäº†ç¤¾åŒºæ¯”è¾ƒå¸¸è§çš„ä¸¤ç§ Flannel å’Œ Calico çš„å·¥ä½œåŸç†ï¼Œé’ˆå¯¹é›†ç¾¤å†…ä¸åŒèŠ‚ç‚¹çš„ pod é—´é€šä¿¡çš„åœºæ™¯ï¼ŒæŠ“åŒ…åˆ†æäº†ç½‘ç»œåŒ…çš„èµ°å‘ã€‚&lt;/p&gt;
&lt;p&gt;Flannel ä¸»è¦æä¾›äº† Overlay çš„ç½‘ç»œæ–¹æ¡ˆï¼ŒUDP æ¨¡å¼ç”±äºå…¶å°åŒ…æ‹†åŒ…çš„è¿‡ç¨‹æ¶‰åŠäº†å¤šæ¬¡ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œå¯¼è‡´æ€§èƒ½å¾ˆå·®ï¼Œé€æ¸è¢«ç¤¾åŒºæŠ›å¼ƒï¼›VXLAN æ¨¡å¼çš„å°åŒ…æ‹†åŒ…è¿‡ç¨‹å‡åœ¨å†…æ ¸æ€ï¼Œæ€§èƒ½è¦æ¯” UDP å¥½å¾ˆå¤šï¼Œä¹Ÿæ˜¯æœ€ç»å¸¸ä½¿ç”¨çš„æ¨¡å¼ï¼›host-gw æ¨¡å¼ä¸æ¶‰åŠå°åŒ…æ‹†åŒ…ï¼Œæ‰€ä»¥æ€§èƒ½ç›¸å¯¹è¾ƒé«˜ï¼Œä½†è¦æ±‚èŠ‚ç‚¹é—´äºŒå±‚äº’é€šã€‚&lt;/p&gt;
&lt;p&gt;Calico ä¸»è¦é‡‡ç”¨äº† BGP åè®®äº¤æ¢è·¯ç”±ï¼Œæ²¡æœ‰é‡‡ç”¨ cni0 ç½‘æ¡¥ï¼Œå½“äºŒå±‚ç½‘ç»œä¸é€šçš„æ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨ IPIP æ¨¡å¼ï¼Œä½†ç”±äºæ¶‰åŠåˆ°å°åŒ…æ‹†åŒ…çš„è¿‡ç¨‹ï¼Œæ€§èƒ½ç›¸å¯¹è¾ƒå¼±ï¼Œä¸ Flannel çš„ VXLAN æ¨¡å¼ç›¸å½“ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡ä½œè€…ï¼šæµ·çš„æ¾œè‰² æ¥è‡ªCSå®éªŒå®¤&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;å¾®ä¿¡è®¢é˜…å·&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h2&gt;&lt;p&gt;å®¹å™¨çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆæœ‰å¾ˆå¤šç§ï¼Œæ¯æ”¯æŒä¸€ç§ç½‘ç»œå®ç°å°±è¿›è¡Œä¸€æ¬¡é€‚é…æ˜¾ç„¶æ˜¯ä¸ç°å®çš„ï¼Œè€Œ CNI å°±æ˜¯ä¸ºäº†å…¼å®¹å¤šç§ç½‘ç»œæ–¹æ¡ˆè€Œå‘æ˜çš„ã€‚CNI æ˜¯ Container Network Interface çš„ç¼©å†™ï¼Œæ˜¯ä¸€ä¸ªæ ‡å‡†çš„é€šç”¨çš„æ¥å£ï¼Œç”¨äºè¿æ¥å®¹å™¨ç®¡ç†ç³»ç»Ÿå’Œç½‘ç»œæ’ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;ç®€å•æ¥è¯´ï¼Œå®¹å™¨ runtime ä¸ºå®¹å™¨æä¾› network namespaceï¼Œç½‘ç»œæ’ä»¶è´Ÿè´£å°† network interface æ’å…¥è¯¥ network namespace ä¸­å¹¶ä¸”åœ¨å®¿ä¸»æœºåšä¸€äº›å¿…è¦çš„é…ç½®ï¼Œæœ€åå¯¹ namespace ä¸­çš„ interface è¿›è¡Œ IP å’Œè·¯ç”±çš„é…ç½®ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ç½‘ç»œæ’ä»¶çš„ä¸»è¦å·¥ä½œå°±åœ¨äºä¸ºå®¹å™¨æä¾›ç½‘ç»œç¯å¢ƒï¼ŒåŒ…æ‹¬ä¸º pod è®¾ç½® ip åœ°å€ã€é…ç½®è·¯ç”±ä¿è¯é›†ç¾¤å†…ç½‘ç»œçš„é€šç•…ã€‚ç›®å‰æ¯”è¾ƒæµè¡Œçš„ç½‘ç»œæ’ä»¶æ˜¯ Flannel å’Œ Calicoã€‚&lt;br&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/categories/kubernetes/"/>
    
      <category term="cni" scheme="http://team.jiunile.com/categories/kubernetes/cni/"/>
    
      <category term="ç½‘ç»œæ’ä»¶" scheme="http://team.jiunile.com/categories/kubernetes/cni/%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="calico" scheme="http://team.jiunile.com/tags/calico/"/>
    
      <category term="cni" scheme="http://team.jiunile.com/tags/cni/"/>
    
      <category term="flannel" scheme="http://team.jiunile.com/tags/flannel/"/>
    
      <category term="ç½‘ç»œæ’ä»¶" scheme="http://team.jiunile.com/tags/%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•ä½¿ç”¨go pprofå®šä½å†…å­˜æ³„éœ²</title>
    <link href="http://team.jiunile.com//blog/2020/09/go-pprof.html"/>
    <id>http://team.jiunile.com//blog/2020/09/go-pprof.html</id>
    <published>2020-09-30T12:00:00.000Z</published>
    <updated>2020-09-30T02:59:33.000Z</updated>
    
    <content type="html">&lt;p&gt;æœ€è¿‘è§£å†³äº†æˆ‘ä»¬é¡¹ç›®ä¸­çš„ä¸€ä¸ªå†…å­˜æ³„éœ²é—®é¢˜ï¼Œäº‹å®å†æ¬¡è¯æ˜ pprof æ˜¯ä¸€ä¸ªå¥½å·¥å…·ï¼Œä½†æŒæ¡å¥½å·¥å…·çš„æ­£ç¡®ç”¨æ³•ï¼Œæ‰èƒ½å‘æŒ¥å¥½å·¥å…·çš„å¨åŠ›ï¼Œä¸ç„¶å°±ç®—ä½ æ‰‹é‡Œæœ‰å± é¾™åˆ€ï¼Œä¹Ÿæˆä¸äº†å¤©ä¸‹ç¬¬ä¸€ï¼Œæœ¬æ–‡å°±æ˜¯å¸¦ä½ ç”¨ pprof å®šä½å†…å­˜æ³„éœ²é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;å…³äºGoçš„å†…å­˜æ³„éœ²æœ‰è¿™ä¹ˆä¸€å¥è¯ä¸çŸ¥é“ä½ å¬è¿‡æ²¡æœ‰ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;10æ¬¡å†…å­˜æ³„éœ²ï¼Œæœ‰9æ¬¡æ˜¯ goroutine æ³„éœ²ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æˆ‘æ‰€è§£å†³çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯ goroutine æ³„éœ²å¯¼è‡´çš„å†…å­˜æ³„éœ²ï¼Œæ‰€ä»¥&lt;strong&gt;è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»Goç¨‹åºçš„goroutine æ³„éœ²ï¼ŒæŒæ¡äº†å¦‚ä½•å®šä½å’Œè§£å†³ goroutine æ³„éœ²ï¼Œå°±æŒæ¡äº†å†…å­˜æ³„éœ²çš„å¤§éƒ¨åˆ†åœºæ™¯&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡è‰ç¨¿æœ€åˆæ•°æ®éƒ½æ˜¯ç”Ÿäº§åå¢ƒæ•°æ®ï¼Œä¸ºäº†é˜²æ­¢æ•æ„Ÿå†…å®¹æ³„éœ²ï¼Œå…¨éƒ¨æ›¿æ¢æˆäº†demoæ•°æ®ï¼Œdemoçš„æ•°æ®æ¯”ç”Ÿäº§ç¯å¢ƒæ•°æ®ç®€å•å¤šäº†ï¼Œæ›´é€‚åˆå…¥é—¨ç†è§£ï¼Œæœ‰åŠ©äºæŒæ¡ pprofã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;go-pprofåŸºæœ¬çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#go-pprofåŸºæœ¬çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;go pprofåŸºæœ¬çŸ¥è¯†&quot;&gt;&lt;/a&gt;go pprofåŸºæœ¬çŸ¥è¯†&lt;/h2&gt;&lt;p&gt;å®šä½ goroutine æ³„éœ²ä¼šä½¿ç”¨åˆ° pprofï¼Œpprof æ˜¯Goçš„æ€§èƒ½å·¥å…·ï¼Œåœ¨å¼€å§‹ä»‹ç»å†…å­˜æ³„éœ²å‰ï¼Œå…ˆç®€å•ä»‹ç»ä¸‹ pprof çš„åŸºæœ¬ä½¿ç”¨ï¼Œæ›´è¯¦ç»†çš„ä½¿ç”¨ç»™å¤§å®¶æ¨èäº†èµ„æ–™ã€‚&lt;/p&gt;
&lt;h3 id=&quot;ä»€ä¹ˆæ˜¯pprof&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯pprof&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯pprof&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯pprof&lt;/h3&gt;&lt;p&gt;pprof æ˜¯Goçš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥è®°å½•ç¨‹åºçš„è¿è¡Œä¿¡æ¯ï¼Œå¯ä»¥æ˜¯CPUä½¿ç”¨æƒ…å†µã€å†…å­˜ä½¿ç”¨æƒ…å†µã€goroutine è¿è¡Œæƒ…å†µç­‰ï¼Œå½“éœ€è¦æ€§èƒ½è°ƒä¼˜æˆ–è€…å®šä½Bugæ—¶å€™ï¼Œè¿™äº›è®°å½•çš„ä¿¡æ¯æ˜¯ç›¸å½“é‡è¦ã€‚&lt;/p&gt;
&lt;h3 id=&quot;åŸºæœ¬ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#åŸºæœ¬ä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;åŸºæœ¬ä½¿ç”¨&quot;&gt;&lt;/a&gt;åŸºæœ¬ä½¿ç”¨&lt;/h3&gt;&lt;p&gt;ä½¿ç”¨ pprof æœ‰å¤šç§æ–¹å¼ï¼ŒGoå·²ç»ç°æˆå°è£…å¥½äº†1ä¸ªï¼š&lt;code&gt;net/http/pprof&lt;/code&gt;ï¼Œä½¿ç”¨ç®€å•çš„å‡ è¡Œå‘½ä»¤ï¼Œå°±å¯ä»¥å¼€å¯ pprofï¼Œè®°å½•è¿è¡Œä¿¡æ¯ï¼Œå¹¶ä¸”æä¾›äº†WebæœåŠ¡ï¼Œèƒ½å¤Ÿé€šè¿‡æµè§ˆå™¨å’Œå‘½ä»¤è¡Œ2ç§æ–¹å¼è·å–è¿è¡Œæ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;çœ‹ä¸ªæœ€ç®€å•çš„ pprof çš„ demo ä¾‹å­ï¼š&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;net/http&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _ &lt;span class=&quot;string&quot;&gt;&quot;net/http/pprof&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// å¼€å¯pprofï¼Œç›‘å¬è¯·æ±‚&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ip := &lt;span class=&quot;string&quot;&gt;&quot;0.0.0.0:6060&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := http.ListenAndServe(ip, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        fmt.Printf(&lt;span class=&quot;string&quot;&gt;&quot;start pprof failed on %s\n&quot;&lt;/span&gt;, ip)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;æµè§ˆå™¨æ–¹å¼&quot;&gt;&lt;a href=&quot;#æµè§ˆå™¨æ–¹å¼&quot; class=&quot;headerlink&quot; title=&quot;æµè§ˆå™¨æ–¹å¼&quot;&gt;&lt;/a&gt;æµè§ˆå™¨æ–¹å¼&lt;/h3&gt;&lt;p&gt;å°†ä¸Šè¿°çš„go pprofä¾‹å­è¿è¡Œèµ·æ¥åé€šè¿‡æµè§ˆå™¨è®¿é—®ï¼š&lt;br&gt;&lt;img src=&quot;/images/go/pprof_1.png&quot; alt=&quot;go pprof&quot;&gt;&lt;br&gt;è¾“å…¥ç½‘å€ &lt;code&gt;http://ip:port/debug/pprof/&lt;/code&gt; æ‰“å¼€pprofä¸»é¡µï¼Œä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ˜¯5ç±»profileä¿¡æ¯ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;block&lt;/strong&gt;ï¼šgoroutine çš„é˜»å¡ä¿¡æ¯ï¼Œæœ¬ä¾‹å°±æˆªå–è‡ªä¸€ä¸ª goroutine é˜»å¡çš„ demoï¼Œä½† block ä¸º0ï¼Œæ²¡æŒæ¡ block çš„ç”¨æ³•&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;goroutine&lt;/strong&gt;ï¼šæ‰€æœ‰ goroutine çš„ä¿¡æ¯ï¼Œä¸‹é¢çš„ &lt;code&gt;full goroutine stack dump&lt;/code&gt; æ˜¯è¾“å‡ºæ‰€æœ‰ goroutine çš„è°ƒç”¨æ ˆï¼Œæ˜¯ goroutine çš„ debug=2 ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;heap&lt;/strong&gt;ï¼šå †å†…å­˜çš„ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;mutex&lt;/strong&gt;ï¼šé”çš„ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;threadcreate&lt;/strong&gt;ï¼šçº¿ç¨‹ä¿¡æ¯&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¸»è¦å…³æ³¨ goroutine å’Œ heap ï¼Œè¿™ä¸¤ä¸ªéƒ½ä¼šæ‰“å°è°ƒç”¨æ ˆä¿¡æ¯ï¼Œgoroutine é‡Œé¢è¿˜ä¼šåŒ…å« goroutine çš„æ•°é‡ä¿¡æ¯ï¼Œheap åˆ™æ˜¯å†…å­˜åˆ†é…ä¿¡æ¯ï¼Œæœ¬æ–‡ç”¨ä¸åˆ°çš„åœ°æ–¹å°±ä¸å±•ç¤ºäº†ï¼Œæœ€åæ¨èå‡ ç¯‡æ–‡ç« å¤§å®¶å»çœ‹ã€‚&lt;/p&gt;
&lt;h3 id=&quot;å‘½ä»¤è¡Œæ–¹å¼&quot;&gt;&lt;a href=&quot;#å‘½ä»¤è¡Œæ–¹å¼&quot; class=&quot;headerlink&quot; title=&quot;å‘½ä»¤è¡Œæ–¹å¼&quot;&gt;&lt;/a&gt;å‘½ä»¤è¡Œæ–¹å¼&lt;/h3&gt;&lt;p&gt;å½“è¿æ¥åœ¨æœåŠ¡å™¨ç»ˆç«¯ä¸Šçš„æ—¶å€™ï¼Œæ˜¯æ²¡æœ‰æµè§ˆå™¨å¯ä»¥ä½¿ç”¨çš„ï¼ŒGoæä¾›äº†å‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œèƒ½å¤Ÿè·å–ä»¥ä¸Š5ç±»ä¿¡æ¯ï¼Œè¿™ç§æ–¹å¼ç”¨èµ·æ¥æ›´æ–¹ä¾¿ã€‚&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨å‘½ä»¤ &lt;code&gt;go tool pprof url&lt;/code&gt; å¯ä»¥è·å–æŒ‡å®šçš„ profile æ–‡ä»¶ï¼Œæ­¤å‘½ä»¤ä¼šå‘èµ· http è¯·æ±‚ï¼Œç„¶åä¸‹è½½æ•°æ®åˆ°æœ¬åœ°ï¼Œä¹‹åè¿›å…¥äº¤äº’å¼æ¨¡å¼ï¼Œå°±åƒ gdb ä¸€æ ·ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹è¿è¡Œä¿¡æ¯ï¼Œä»¥ä¸‹æ˜¯5ç±»è¯·æ±‚çš„æ–¹å¼ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä¸‹è½½cpu profileï¼Œé»˜è®¤ä»å½“å‰å¼€å§‹æ”¶é›†30sçš„cpuä½¿ç”¨æƒ…å†µï¼Œéœ€è¦ç­‰å¾…30s&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://localhost:6060/debug/pprof/profile   &lt;span class=&quot;comment&quot;&gt;# 30-second CPU profile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://localhost:6060/debug/pprof/profile?seconds=120     &lt;span class=&quot;comment&quot;&gt;# wait 120s&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä¸‹è½½heap profile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://localhost:6060/debug/pprof/heap      &lt;span class=&quot;comment&quot;&gt;# heap profile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä¸‹è½½goroutine profile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://localhost:6060/debug/pprof/goroutine &lt;span class=&quot;comment&quot;&gt;# goroutine profile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä¸‹è½½block profile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://localhost:6060/debug/pprof/block     &lt;span class=&quot;comment&quot;&gt;# goroutine blocking profile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä¸‹è½½mutex profile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://localhost:6060/debug/pprof/mutex&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šé¢çš„ pprof/demo.go å¤ªç®€å•äº†ï¼Œå¦‚æœå»è·å–å†…å­˜ profileï¼Œå‡ ä¹è·å–ä¸åˆ°ä»€ä¹ˆï¼Œæ¢ä¸€ä¸ªDemoè¿›è¡Œå†…å­˜ profile çš„å±•ç¤ºï¼š&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// å±•ç¤ºå†…å­˜å¢é•¿å’Œpprofï¼Œå¹¶ä¸æ˜¯æ³„éœ²&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;net/http&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _ &lt;span class=&quot;string&quot;&gt;&quot;net/http/pprof&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;os&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// è¿è¡Œä¸€æ®µæ—¶é—´ï¼šfatal error: runtime: out of memory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// å¼€å¯pprof&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ip := &lt;span class=&quot;string&quot;&gt;&quot;0.0.0.0:6060&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := http.ListenAndServe(ip, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            fmt.Printf(&lt;span class=&quot;string&quot;&gt;&quot;start pprof failed on %s\n&quot;&lt;/span&gt;, ip)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            os.Exit(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    tick := time.Tick(time.Second / &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; buf []&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; tick &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        buf = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(buf, &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt;)...)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šé¢è¿™ä¸ªdemoä¼šä¸æ–­çš„ç”³è¯·å†…å­˜ï¼ŒæŠŠå®ƒç¼–è¯‘è¿è¡Œèµ·æ¥ï¼Œç„¶åæ‰§è¡Œï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ go tool pprof http://localhost:6060/debug/pprof/heap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Fetching profile over HTTP from http://localhost:6060/debug/pprof/heap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Saved profile &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; /home/ubuntu/pprof/pprof.demo.alloc_objects.alloc_space.inuse_objects.inuse_space.001.pb.gz       //&amp;lt;--- ä¸‹è½½åˆ°çš„å†…å­˜profileæ–‡ä»¶&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;File: demo // ç¨‹åºåç§°&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Build ID: a9069a125ee9c0df3713b2149ca859e8d4d11d5a&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Type: inuse_space&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Time: May 16, 2019 at 8:55pm (CST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Entering interactive mode (&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;help&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; commands, &lt;span class=&quot;string&quot;&gt;&quot;o&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; options)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof) &lt;span class=&quot;built_in&quot;&gt;help&lt;/span&gt;  // ä½¿ç”¨&lt;span class=&quot;built_in&quot;&gt;help&lt;/span&gt;æ‰“å°æ‰€æœ‰å¯ç”¨å‘½ä»¤&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Commands:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    callgrind        Outputs a graph &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; callgrind format&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    comments         Output all profile comments&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    disasm           Output assembly listings annotated with samples&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    dot              Outputs a graph &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; DOT format&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    eog              Visualize graph through eog&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    evince           Visualize graph through evince&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    gif              Outputs a graph image &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; GIF format&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    gv               Visualize graph through gv&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    kcachegrind      Visualize report &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; KCachegrind&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    list             Output annotated &lt;span class=&quot;built_in&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;functions&lt;/span&gt; matching regexp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pdf              Outputs a graph &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; PDF format&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    peek             Output callers/callees of &lt;span class=&quot;built_in&quot;&gt;functions&lt;/span&gt; matching regexp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    png              Outputs a graph image &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; PNG format&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    proto            Outputs the profile &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; compressed protobuf format&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ps               Outputs a graph &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; PS format&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    raw              Outputs a text representation of the raw profile&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    svg              Outputs a graph &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; SVG format&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    tags             Outputs all tags &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; the profile&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    text             Outputs top entries &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; text form&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    top              Outputs top entries &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; text form&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    topproto         Outputs top entries &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; compressed protobuf format&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    traces           Outputs all profile samples &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; text form&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    tree             Outputs a text rendering of call graph&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    web              Visualize graph through web browser&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    weblist          Display annotated &lt;span class=&quot;built_in&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; a web browser&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    o/options        List options and their current values&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    quit/&lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;/^D     Exit pprof&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ....&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä»¥ä¸Šä¿¡æ¯æˆ‘ä»¬åªå…³æ³¨2ä¸ªåœ°æ–¹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¸‹è½½å¾—åˆ°çš„æ–‡ä»¶ï¼š&lt;code&gt;/home/ubuntu/pprof/pprof.demo.alloc_objects.alloc_space.inuse_objects.inuse_space.001.pb.gz&lt;/code&gt;ï¼Œè¿™å…¶ä¸­åŒ…å«äº†ç¨‹åºå &lt;code&gt;demo&lt;/code&gt;ï¼Œprofile ç±»å‹ &lt;code&gt;alloc&lt;/code&gt; å·²åˆ†é…çš„å†…å­˜ï¼Œ&lt;code&gt;inuse&lt;/code&gt; ä»£è¡¨ä½¿ç”¨ä¸­çš„å†…å­˜ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;help&lt;/code&gt; å¯ä»¥è·å–å¸®åŠ©ï¼Œæœ€å…ˆä¼šåˆ—å‡ºæ”¯æŒçš„å‘½ä»¤ï¼Œæƒ³æŒæ¡ pprofï¼Œè¦å¤šçœ‹çœ‹ï¼Œå¤šå°è¯•ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å…³äºå‘½ä»¤ï¼Œæœ¬æ–‡åªä¼šç”¨åˆ°3ä¸ªï¼Œæˆ‘è®¤ä¸ºä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ï¼š&lt;code&gt;top&lt;/code&gt;ã€&lt;code&gt;list&lt;/code&gt;ã€&lt;code&gt;traces&lt;/code&gt;ï¼Œåˆ†åˆ«ä»‹ç»ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;h4 id=&quot;top&quot;&gt;&lt;a href=&quot;#top&quot; class=&quot;headerlink&quot; title=&quot;top&quot;&gt;&lt;/a&gt;top&lt;/h4&gt;&lt;p&gt;æŒ‰æŒ‡æ ‡å¤§å°åˆ—å‡ºå‰10ä¸ªå‡½æ•°ï¼Œæ¯”å¦‚å†…å­˜æ˜¯æŒ‰å†…å­˜å ç”¨å¤šå°‘ï¼ŒCPUæ˜¯æŒ‰æ‰§è¡Œæ—¶é—´å¤šå°‘ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(pprof) top&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Showing nodes accounting &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 814.62MB, 100% of 814.62MB total&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      flat  flat%   sum%        cum   cum%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  814.62MB   100%   100%   814.62MB   100%  main.main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%   814.62MB   100%  runtime.main&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;topä¼šåˆ—å‡º5ä¸ªç»Ÿè®¡æ•°æ®ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;flat&lt;/strong&gt;: æœ¬å‡½æ•°å ç”¨çš„å†…å­˜é‡ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;flat%&lt;/strong&gt;: æœ¬å‡½æ•°å†…å­˜å ä½¿ç”¨ä¸­å†…å­˜æ€»é‡çš„ç™¾åˆ†æ¯”ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;sum%&lt;/strong&gt;: å‰é¢æ¯ä¸€è¡Œ flat ç™¾åˆ†æ¯”çš„å’Œï¼Œæ¯”å¦‚ç¬¬2è¡Œè™½ç„¶çš„100% æ˜¯ 100% + 0%ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;cum&lt;/strong&gt;: æ˜¯ç´¯è®¡é‡ï¼ŒåŠ å…¥mainå‡½æ•°è°ƒç”¨äº†å‡½æ•°fï¼Œå‡½æ•°få ç”¨çš„å†…å­˜é‡ï¼Œä¹Ÿä¼šè®°è¿›æ¥ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;cum%&lt;/strong&gt;: æ˜¯ç´¯è®¡é‡å æ€»é‡çš„ç™¾åˆ†æ¯”ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;list&quot;&gt;&lt;a href=&quot;#list&quot; class=&quot;headerlink&quot; title=&quot;list&quot;&gt;&lt;/a&gt;list&lt;/h4&gt;&lt;p&gt;æŸ¥çœ‹æŸä¸ªå‡½æ•°çš„ä»£ç ï¼Œä»¥åŠè¯¥å‡½æ•°æ¯è¡Œä»£ç çš„æŒ‡æ ‡ä¿¡æ¯ï¼Œå¦‚æœå‡½æ•°åä¸æ˜ç¡®ï¼Œä¼šè¿›è¡Œæ¨¡ç³ŠåŒ¹é…ï¼Œæ¯”å¦‚ &lt;code&gt;list main&lt;/code&gt; ä¼šåˆ—å‡º &lt;code&gt;main.main&lt;/code&gt; å’Œ &lt;code&gt;runtime.main&lt;/code&gt;ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(pprof) list main.main  // ç²¾ç¡®åˆ—å‡ºå‡½æ•°&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Total: 814.62MB&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ROUTINE ======================== main.main &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; /home/ubuntu/heap/demo2.go&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  814.62MB   814.62MB (flat, cum)   100% of Total&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     20:    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     21:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     22:    tick := time.Tick(time.Second / 100)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     23:    var buf []byte&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     24:    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; range tick &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  814.62MB   814.62MB     25:        buf = append(buf, make([]byte, 1024*1024)...)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     26:    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     27:&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     28:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof) list main  // åŒ¹é…æ‰€æœ‰å‡½æ•°åå¸¦mainçš„å‡½æ•°&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Total: 814.62MB&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ROUTINE ======================== main.main &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; /home/ubuntu/heap/demo2.go&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  814.62MB   814.62MB (flat, cum)   100% of Total&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     20:    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     21:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;..... // çœç•¥å‡ è¡Œ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     28:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ROUTINE ======================== runtime.main &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; /usr/lib/go-1.10/src/runtime/proc.go&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0   814.62MB (flat, cum)   100% of Total&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .    193:        // A program compiled with -buildmode=c-archive or c-shared&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;..... // çœç•¥å‡ è¡Œ&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°åœ¨ &lt;code&gt;main.main&lt;/code&gt; ä¸­çš„ç¬¬25è¡Œå ç”¨äº†814.62MBå†…å­˜ï¼Œå·¦å³2ä¸ªæ•°æ®åˆ†åˆ«æ˜¯ flat å’Œcumï¼Œå«ä¹‰å’Œ top ä¸­è§£é‡Šçš„ä¸€æ ·ã€‚&lt;/p&gt;
&lt;h4 id=&quot;traces&quot;&gt;&lt;a href=&quot;#traces&quot; class=&quot;headerlink&quot; title=&quot;traces&quot;&gt;&lt;/a&gt;traces&lt;/h4&gt;&lt;p&gt;æ‰“å°æ‰€æœ‰è°ƒç”¨æ ˆï¼Œä»¥åŠè°ƒç”¨æ ˆçš„æŒ‡æ ‡ä¿¡æ¯ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(pprof) traces&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;File: demo2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Type: inuse_space&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Time: May 16, 2019 at 7:08pm (CST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-----------+-------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     bytes:  813.46MB&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  813.46MB   main.main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             runtime.main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-----------+-------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     bytes:  650.77MB&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0   main.main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             runtime.main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;....... // çœç•¥å‡ åè¡Œ&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ¯ä¸ª &lt;code&gt;- - - - -&lt;/code&gt; éš”å¼€çš„æ˜¯ä¸€ä¸ªè°ƒç”¨æ ˆï¼Œèƒ½çœ‹åˆ° &lt;code&gt;runtime.main&lt;/code&gt; è°ƒç”¨äº† &lt;code&gt;main.main&lt;/code&gt;ï¼Œå¹¶ä¸” &lt;code&gt;main.main&lt;/code&gt; ä¸­å ç”¨äº†813.46MBå†…å­˜ã€‚&lt;/p&gt;
&lt;p&gt;å…¶ä»–çš„ profile æ“ä½œå’Œå†…å­˜æ˜¯ç±»ä¼¼çš„ï¼Œè¿™é‡Œå°±ä¸å±•ç¤ºäº†ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œåªæ˜¯ç®€å•ä»‹ç»æœ¬æ–‡ç”¨åˆ°çš„ pprof çš„åŠŸèƒ½ï¼Œpprof åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œä¹Ÿç»å¸¸å’Œ benchmark ç»“åˆèµ·æ¥ï¼Œä½†è¿™ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œæ‰€ä»¥å°±ä¸å¤šä»‹ç»äº†ï¼Œä¸ºå¤§å®¶æ¨èå‡ ç¯‡æ–‡ç« ï¼Œä¸€å®šè¦å¥½å¥½ç ”è¯»ã€å®è·µï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Goå®˜æ–¹åšå®¢å…³äºpprofçš„ä»‹ç»ï¼Œå¾ˆè¯¦ç»†ï¼Œä¹ŸåŒ…å«æ ·ä¾‹ï¼Œå¯ä»¥å®æ“ï¼š&lt;a href=&quot;https://blog.golang.org/profiling-go-programs&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Profiling Go Programs&lt;/a&gt;ã€‚&lt;/li&gt;
&lt;li&gt;ç…é±¼çš„è¿™ç¯‡æ–‡ç« ä¹Ÿå¾ˆé€‚åˆå…¥é—¨ï¼š &lt;a href=&quot;https://github.com/EDDYCJY/blog/blob/master/golang/2018-09-15-Golang%20%E5%A4%A7%E6%9D%80%E5%99%A8%E4%B9%8B%E6%80%A7%E8%83%BD%E5%89%96%E6%9E%90%20PProf.md&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Golang å¤§æ€å™¨ä¹‹æ€§èƒ½å‰–æ PProf&lt;/a&gt;ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²&lt;/h2&gt;&lt;p&gt;å†…å­˜æ³„éœ²æŒ‡çš„æ˜¯ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å·²ä¸å†ä½¿ç”¨çš„å†…å­˜ï¼Œæ²¡æœ‰è¢«é‡Šæ”¾æ‰ï¼Œå¯¼è‡´è¿™äº›å†…å­˜æ— æ³•è¢«ä½¿ç”¨ï¼Œç›´åˆ°ç¨‹åºç»“æŸè¿™äº›å†…å­˜æ‰è¢«é‡Šæ”¾çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;Goè™½ç„¶æœ‰ GC æ¥å›æ”¶ä¸å†ä½¿ç”¨çš„å †å†…å­˜ï¼Œå‡è½»äº†å¼€å‘äººå‘˜å¯¹å†…å­˜çš„ç®¡ç†è´Ÿæ‹…ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€Goç¨‹åºä¸å†æœ‰å†…å­˜æ³„éœ²é—®é¢˜ã€‚åœ¨Goç¨‹åºä¸­ï¼Œå¦‚æœæ²¡æœ‰Goè¯­è¨€çš„ç¼–ç¨‹æ€ç»´ï¼Œä¹Ÿä¸éµå®ˆè‰¯å¥½çš„ç¼–ç¨‹å®è·µï¼Œå°±å¯èƒ½åŸ‹ä¸‹éšæ‚£ï¼Œé€ æˆå†…å­˜æ³„éœ²é—®é¢˜ã€‚&lt;/p&gt;
&lt;h2 id=&quot;æ€ä¹ˆå‘ç°å†…å­˜æ³„éœ²&quot;&gt;&lt;a href=&quot;#æ€ä¹ˆå‘ç°å†…å­˜æ³„éœ²&quot; class=&quot;headerlink&quot; title=&quot;æ€ä¹ˆå‘ç°å†…å­˜æ³„éœ²&quot;&gt;&lt;/a&gt;æ€ä¹ˆå‘ç°å†…å­˜æ³„éœ²&lt;/h2&gt;&lt;p&gt;åœ¨Goä¸­å‘ç°å†…å­˜æ³„éœ²æœ‰2ç§æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯é€šç”¨çš„ç›‘æ§å·¥å…·ï¼Œå¦ä¸€ä¸ªæ˜¯ go pprofï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;ç›‘æ§å·¥å…·&lt;/strong&gt;ï¼šå›ºå®šå‘¨æœŸå¯¹è¿›ç¨‹çš„å†…å­˜å ç”¨æƒ…å†µè¿›è¡Œé‡‡æ ·ï¼Œæ•°æ®å¯è§†åŒ–åï¼Œæ ¹æ®å†…å­˜å ç”¨èµ°åŠ¿ï¼ˆæŒç»­ä¸Šå‡ï¼‰ï¼Œå¾ˆå®¹æ˜“å‘ç°æ˜¯å¦å‘ç”Ÿå†…å­˜æ³„éœ²ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;go pprof&lt;/strong&gt;ï¼šé€‚åˆæ²¡æœ‰ç›‘æ§å·¥å…·çš„æƒ…å†µï¼Œä½¿ç”¨Goæä¾›çš„ pprof å·¥å…·åˆ¤æ–­æ˜¯å¦å‘ç”Ÿå†…å­˜æ³„éœ²ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è¿™2ç§æ–¹å¼åˆ†åˆ«ä»‹ç»ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;h3 id=&quot;ç›‘æ§å·¥å…·æŸ¥çœ‹è¿›ç¨‹å†…åœ¨å ç”¨æƒ…å†µ&quot;&gt;&lt;a href=&quot;#ç›‘æ§å·¥å…·æŸ¥çœ‹è¿›ç¨‹å†…åœ¨å ç”¨æƒ…å†µ&quot; class=&quot;headerlink&quot; title=&quot;ç›‘æ§å·¥å…·æŸ¥çœ‹è¿›ç¨‹å†…åœ¨å ç”¨æƒ…å†µ&quot;&gt;&lt;/a&gt;ç›‘æ§å·¥å…·æŸ¥çœ‹è¿›ç¨‹å†…åœ¨å ç”¨æƒ…å†µ&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;å¦‚æœä½¿ç”¨äº‘å¹³å°éƒ¨ç½²Goç¨‹åº&lt;/strong&gt;ï¼Œäº‘å¹³å°éƒ½æä¾›äº†å†…å­˜æŸ¥çœ‹çš„å·¥å…·ï¼Œå¯ä»¥æŸ¥çœ‹OSçš„å†…å­˜å ç”¨æƒ…å†µå’ŒæŸä¸ªè¿›ç¨‹çš„å†…å­˜å ç”¨æƒ…å†µï¼Œæ¯”å¦‚é˜¿é‡Œäº‘ï¼Œæˆ‘ä»¬åœ¨1ä¸ªäº‘ä¸»æœºä¸Šåªéƒ¨ç½²äº†1ä¸ªGoæœåŠ¡ï¼Œæ‰€ä»¥OSçš„å†…å­˜å ç”¨æƒ…å†µï¼ŒåŸºæœ¬æ˜¯ä¹Ÿåæ˜ äº†è¿›ç¨‹å†…å­˜å ç”¨æƒ…å†µï¼ŒOSå†…å­˜å ç”¨æƒ…å†µå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°&lt;strong&gt;éšç€æ—¶é—´çš„æ¨è¿›ï¼Œå†…å­˜çš„å ç”¨ç‡åœ¨ä¸æ–­çš„æé«˜ï¼Œè¿™æ˜¯å†…å­˜æ³„éœ²çš„æœ€æ˜æ˜¾ç°è±¡&lt;/strong&gt;ï¼š&lt;br&gt;&lt;img src=&quot;/images/go/pprof_2.png&quot; alt=&quot;go pprof&quot;&gt;&lt;br&gt;&lt;strong&gt;å¦‚æœæ²¡æœ‰äº‘å¹³å°è¿™ç§å†…å­˜ç›‘æ§å·¥å…·ï¼Œå¯ä»¥åˆ¶ä½œä¸€ä¸ªç®€å•çš„å†…å­˜è®°å½•å·¥å…·&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;1ã€å»ºç«‹ä¸€ä¸ªè„šæœ¬ &lt;code&gt;prog_mem.sh&lt;/code&gt;ï¼Œè·å–è¿›ç¨‹å ç”¨çš„ç‰©ç†å†…å­˜æƒ…å†µï¼Œè„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;prog_name=&lt;span class=&quot;string&quot;&gt;&quot;your_programe_name&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;prog_mem=$(pidstat  -r -u -h -C &lt;span class=&quot;variable&quot;&gt;$prog_name&lt;/span&gt; |awk &lt;span class=&quot;string&quot;&gt;&#39;NR==4&amp;#123;print $12&amp;#125;&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;time=$(date &lt;span class=&quot;string&quot;&gt;&quot;+%Y-%m-%d %H:%M:%S&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;variable&quot;&gt;$time&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&quot;\tmemory(Byte)\t&quot;&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;$prog_mem&lt;/span&gt; &amp;gt;&amp;gt;/root/prog_mem.log&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;2ã€ç„¶åä½¿ç”¨ &lt;code&gt;crontab&lt;/code&gt; å»ºç«‹å®šæ—¶ä»»åŠ¡ï¼Œæ¯åˆ†é’Ÿè®°å½•1æ¬¡ã€‚ä½¿ç”¨ &lt;code&gt;crontab -e&lt;/code&gt; ç¼–è¾‘crontab é…ç½®ï¼Œåœ¨æœ€åå¢åŠ 1è¡Œ&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;*/1 * * * * /root/prog_mem.sh&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è„šæœ¬è¾“å‡ºçš„å†…å®¹ä¿å­˜åœ¨ &lt;code&gt;prog_mem.log&lt;/code&gt;ï¼Œåªè¦å¤§ä½“æµè§ˆä¸€ä¸‹å°±å¯ä»¥å‘ç°å†…å­˜çš„å¢é•¿æƒ…å†µï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨å†…å­˜æ³„éœ²ã€‚å¦‚æœéœ€è¦å¯è§†åŒ–ï¼Œå¯ä»¥ç›´æ¥é»è´´ &lt;code&gt;prog_mem.log&lt;/code&gt; å†…å®¹åˆ° Excel ç­‰è¡¨æ ¼å·¥å…·ï¼Œç»˜åˆ¶å†…å­˜å ç”¨å›¾ã€‚&lt;br&gt;&lt;img src=&quot;/images/go/pprof_3.png&quot; alt=&quot;go pprof&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;go-pprofå‘ç°å­˜åœ¨å†…å­˜é—®é¢˜&quot;&gt;&lt;a href=&quot;#go-pprofå‘ç°å­˜åœ¨å†…å­˜é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;go pprofå‘ç°å­˜åœ¨å†…å­˜é—®é¢˜&quot;&gt;&lt;/a&gt;go pprofå‘ç°å­˜åœ¨å†…å­˜é—®é¢˜&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;æœ‰æƒ…æé†’ï¼šå¦‚æœå¯¹ pprof ä¸äº†è§£ï¼Œå¯ä»¥å…ˆçœ‹ go pprof åŸºæœ¬çŸ¥è¯†&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¦‚æœä½  Google æˆ–è€…ç™¾åº¦ï¼ŒGoç¨‹åºå†…å­˜æ³„éœ²çš„æ–‡ç« ï¼Œå®ƒæ€»ä¼šå‘Šè¯‰ä½ ä½¿ç”¨ &lt;strong&gt;pprof heap&lt;/strong&gt;ï¼Œèƒ½å¤Ÿç”Ÿæˆæ¼‚äº®çš„è°ƒç”¨è·¯å¾„å›¾ï¼Œç«ç„°å›¾ç­‰ç­‰ï¼Œç„¶åä½ æ ¹æ®è°ƒç”¨è·¯å¾„å°±èƒ½å®šä½å†…å­˜æ³„éœ²é—®é¢˜ï¼Œæˆ‘æœ€åˆä¹Ÿæ˜¯å¯¹æ­¤æ·±ä¿¡ä¸ç–‘ï¼Œå°è¯•äº†è‹¥å¹²å¤©åï¼Œåªæ˜¯å‘ç°å†…å­˜æ³„éœ²è·ŸæŸç§åœºæ™¯æœ‰å…³ï¼Œæ ¹æœ¬æ‰¾ä¸åˆ°å†…å­˜æ³„éœ²çš„æ ¹æºï¼Œ&lt;strong&gt;å¦‚æœå“ªä½æœ‹å‹ç”¨heapå°±èƒ½å®šä½å†…å­˜æ³„éœ²çš„çº¿ä¸Šé—®é¢˜ï¼Œéº»çƒ¦ä»‹ç»ä¸‹&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;åæ¥è¯»äº† Dave çš„ã€ŠHigh Performance Go Workshopã€‹ï¼Œåˆ·æ–°äº†å¯¹ heap çš„è®¤è¯†ï¼Œå†…å­˜pprof çš„ç®€è¦å†…å®¹å¦‚ä¸‹ï¼š&lt;br&gt;&lt;img src=&quot;/images/go/pprof_4.png&quot; alt=&quot;go pprof&quot;&gt;&lt;br&gt;Daveè®²äº†ä»¥ä¸‹å‡ ç‚¹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;å†…å­˜ profiling è®°å½•çš„æ˜¯å †å†…å­˜åˆ†é…çš„æƒ…å†µï¼Œä»¥åŠè°ƒç”¨æ ˆä¿¡æ¯&lt;/strong&gt;ï¼Œå¹¶ä¸æ˜¯è¿›ç¨‹å®Œæ•´çš„å†…å­˜æƒ…å†µï¼ŒçŒœæµ‹è¿™ä¹Ÿæ˜¯åœ¨ go pprof ä¸­ç§°ä¸º heap è€Œä¸æ˜¯ memory çš„åŸå› ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ ˆå†…å­˜çš„åˆ†é…æ˜¯åœ¨è°ƒç”¨æ ˆç»“æŸåä¼šè¢«é‡Šæ”¾çš„å†…å­˜ï¼Œæ‰€ä»¥å¹¶ä¸åœ¨å†…å­˜ profile ä¸­&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;li&gt;å†…å­˜ profiling æ˜¯åŸºäºæŠ½æ ·çš„ï¼Œé»˜è®¤æ˜¯æ¯1000æ¬¡å †å†…å­˜åˆ†é…ï¼Œæ‰§è¡Œ1æ¬¡ profile è®°å½•ã€‚&lt;/li&gt;
&lt;li&gt;å› ä¸ºå†…å­˜ profiling æ˜¯åŸºäºæŠ½æ ·å’Œå®ƒè·Ÿè¸ªçš„æ˜¯å·²åˆ†é…çš„å†…å­˜ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¸­çš„å†…å­˜ï¼Œï¼ˆæ¯”å¦‚æœ‰äº›å†…å­˜å·²ç»åˆ†é…ï¼Œçœ‹ä¼¼ä½¿ç”¨ï¼Œä½†å®é™…ä»¥åŠä¸ä½¿ç”¨çš„å†…å­˜ï¼Œæ¯”å¦‚å†…å­˜æ³„éœ²çš„é‚£éƒ¨åˆ†ï¼‰ï¼Œæ‰€ä»¥&lt;strong&gt;ä¸èƒ½ä½¿ç”¨å†…å­˜ profiling è¡¡é‡ç¨‹åºæ€»ä½“çš„å†…å­˜ä½¿ç”¨æƒ…å†µ&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Dave ä¸ªäººè§‚ç‚¹ï¼šä½¿ç”¨å†…å­˜ profiling ä¸èƒ½å¤Ÿå‘ç°å†…å­˜æ³„éœ²&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;åŸºäºç›®å‰å¯¹ heap çš„è®¤çŸ¥ï¼Œæˆ‘æœ‰2ä¸ªè§‚ç‚¹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;heap èƒ½å¸®åŠ©æˆ‘ä»¬å‘ç°å†…å­˜é—®é¢˜ï¼Œä½†ä¸ä¸€å®šèƒ½å‘ç°å†…å­˜æ³„éœ²é—®é¢˜&lt;/strong&gt;ï¼Œè¿™ä¸ªçœ‹æ³•ä¸ Dave æ˜¯ç±»ä¼¼çš„ã€‚heap è®°å½•äº†å†…å­˜åˆ†é…çš„æƒ…å†µï¼Œæˆ‘ä»¬èƒ½é€šè¿‡ heap è§‚å¯Ÿå†…å­˜çš„å˜åŒ–ï¼Œå¢é•¿ä¸å‡å°‘ï¼Œå†…å­˜ä¸»è¦è¢«å“ªäº›ä»£ç å ç”¨äº†ï¼Œç¨‹åºå­˜åœ¨å†…å­˜é—®é¢˜ï¼Œè¿™åªèƒ½è¯´æ˜å†…å­˜æœ‰ä½¿ç”¨ä¸åˆç†çš„åœ°æ–¹ï¼Œä½†å¹¶ä¸èƒ½è¯´æ˜è¿™æ˜¯å†…å­˜æ³„éœ²ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;heap åœ¨å¸®åŠ©å®šä½å†…å­˜æ³„éœ²åŸå› ä¸Šè´¡çŒ®çš„åŠ›é‡å¾®ä¹å…¶å¾®&lt;/strong&gt;ã€‚å¦‚ç¬¬ä¸€æ¡æ‰€è¨€ï¼Œèƒ½é€šè¿‡ heap æ‰¾åˆ°å ç”¨å†…å­˜å¤šçš„ä½ç½®ï¼Œä½†è¿™ä¸ªä½ç½®é€šå¸¸ä¸ä¸€å®šæ˜¯å†…å­˜æ³„éœ²ï¼Œå°±ç®—æ˜¯å†…å­˜æ³„éœ²ï¼Œä¹Ÿåªæ˜¯å†…å­˜æ³„éœ²çš„ç»“æœï¼Œå¹¶ä¸æ˜¯çœŸæ­£å¯¼è‡´å†…å­˜æ³„éœ²çš„æ ¹æºã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ¥ä¸‹æ¥ï¼Œæˆ‘ä»‹ç»æ€ä¹ˆç”¨ heap å‘ç°é—®é¢˜ï¼Œç„¶åå†è§£é‡Šä¸ºä»€ä¹ˆ heap å‡ ä¹ä¸èƒ½å®šä½å†…å­˜æ³„éœ²çš„æ ¹å› ã€‚&lt;/p&gt;
&lt;h4 id=&quot;æ€ä¹ˆç”¨heapå‘ç°å†…å­˜é—®é¢˜&quot;&gt;&lt;a href=&quot;#æ€ä¹ˆç”¨heapå‘ç°å†…å­˜é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;æ€ä¹ˆç”¨heapå‘ç°å†…å­˜é—®é¢˜&quot;&gt;&lt;/a&gt;æ€ä¹ˆç”¨heapå‘ç°å†…å­˜é—®é¢˜&lt;/h4&gt;&lt;p&gt;ä½¿ç”¨ pprof çš„ heap èƒ½å¤Ÿè·å–ç¨‹åºè¿è¡Œæ—¶çš„å†…å­˜ä¿¡æ¯ï¼Œåœ¨ç¨‹åºå¹³ç¨³è¿è¡Œçš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªä¸€æ®µæ—¶é—´ä½¿ç”¨ heap è·å–å†…å­˜çš„ profile ï¼Œ&lt;strong&gt;ç„¶åä½¿ç”¨ &lt;code&gt;base&lt;/code&gt; èƒ½å¤Ÿå¯¹æ¯”ä¸¤ä¸ª profile æ–‡ä»¶çš„å·®åˆ«ï¼Œå°±åƒ &lt;code&gt;diff&lt;/code&gt; å‘½ä»¤ä¸€æ ·æ˜¾ç¤ºå‡ºå¢åŠ å’Œå‡å°‘çš„å˜åŒ–&lt;/strong&gt;ï¼Œä½¿ç”¨ä¸€ä¸ªç®€å•çš„demoæ¥è¯´æ˜ heap å’Œ base çš„ä½¿ç”¨ï¼Œä¾ç„¶ä½¿ç”¨demo2è¿›è¡Œå±•ç¤ºã€‚&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// å±•ç¤ºå†…å­˜å¢é•¿å’Œpprofï¼Œå¹¶ä¸æ˜¯æ³„éœ²&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;net/http&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _ &lt;span class=&quot;string&quot;&gt;&quot;net/http/pprof&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;os&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// è¿è¡Œä¸€æ®µæ—¶é—´ï¼šfatal error: runtime: out of memory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// å¼€å¯pprof&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ip := &lt;span class=&quot;string&quot;&gt;&quot;0.0.0.0:6060&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := http.ListenAndServe(ip, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            fmt.Printf(&lt;span class=&quot;string&quot;&gt;&quot;start pprof failed on %s\n&quot;&lt;/span&gt;, ip)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            os.Exit(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    tick := time.Tick(time.Second / &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; buf []&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; tick &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        buf = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(buf, &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt;)...)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å°†ä¸Šé¢ä»£ç è¿è¡Œèµ·æ¥ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤è·å– profile æ–‡ä»¶ï¼ŒCtrl-D é€€å‡ºï¼Œ1åˆ†é’Ÿåå†è·å–1æ¬¡ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://localhost:6060/debug/pprof/heap&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘å·²ç»è·å–åˆ°äº†ä¸¤ä¸ª profile æ–‡ä»¶ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ ls&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pprof.demo2.alloc_objects.alloc_space.inuse_objects.inuse_space.001.pb.gz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pprof.demo2.alloc_objects.alloc_space.inuse_objects.inuse_space.002.pb.gz&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨ &lt;code&gt;base&lt;/code&gt; æŠŠ001æ–‡ä»¶ä½œä¸ºåŸºå‡†ï¼Œç„¶åç”¨002å’Œ001å¯¹æ¯”ï¼Œå…ˆæ‰§è¡Œ &lt;code&gt;top&lt;/code&gt; çœ‹ &lt;code&gt;top&lt;/code&gt; çš„å¯¹æ¯”ï¼Œç„¶åæ‰§è¡Œ &lt;code&gt;list main&lt;/code&gt; åˆ—å‡º &lt;code&gt;main&lt;/code&gt; å‡½æ•°çš„å†…å­˜å¯¹æ¯”ï¼Œç»“æœå¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ go tool pprof -base pprof.demo2.alloc_objects.alloc_space.inuse_objects.inuse_space.001.pb.gz pprof.demo2.alloc_objects.alloc_space.inuse_objects.inuse_space.002.pb.gz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;File: demo2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Type: inuse_space&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Time: May 14, 2019 at 2:33pm (CST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Entering interactive mode (&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;help&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; commands, &lt;span class=&quot;string&quot;&gt;&quot;o&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; options)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof) top&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Showing nodes accounting &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 970.34MB, 32.30% of 3003.99MB total&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      flat  flat%   sum%        cum   cum%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  970.34MB 32.30% 32.30%   970.34MB 32.30%  main.main   // çœ‹è¿™&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0% 32.30%   970.34MB 32.30%  runtime.main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof) list main.main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Total: 2.93GB&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ROUTINE ======================== main.main &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; /home/ubuntu/heap/demo2.go&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  970.34MB   970.34MB (flat, cum) 32.30% of Total&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     20:    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     21:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     22:    tick := time.Tick(time.Second / 100)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     23:    var buf []byte&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     24:    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; range tick &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  970.34MB   970.34MB     25:        buf = append(buf, make([]byte, 1024*1024)...) // çœ‹è¿™&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     26:    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     27:&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     28:&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;top&lt;/code&gt; åˆ—å‡ºäº† &lt;code&gt;main.main&lt;/code&gt; å’Œ &lt;code&gt;runtime.main&lt;/code&gt;ï¼Œ&lt;code&gt;main.main&lt;/code&gt; å°±æ˜¯æˆ‘ä»¬ç¼–å†™çš„ mainå‡½æ•°ï¼Œ&lt;code&gt;runtime.main&lt;/code&gt; æ˜¯ runtime åŒ…ä¸­çš„ main å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰ main å‡½æ•°çš„å…¥å£ï¼Œè¿™é‡Œä¸å¤šä»‹ç»äº†ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹ä¹‹å‰çš„è°ƒåº¦å™¨æ–‡ç« &lt;a href=&quot;http://lessisbetter.site/2019/03/26/golang-scheduler-2-macro-view/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ã€ŠGoè°ƒåº¦å™¨ç³»åˆ—ï¼ˆ2ï¼‰å®è§‚çœ‹è°ƒåº¦å™¨ã€‹&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;top&lt;/code&gt; æ˜¾ç¤º &lt;code&gt;main.main&lt;/code&gt; ç¬¬2æ¬¡å†…å­˜å ç”¨ï¼Œæ¯”ç¬¬1æ¬¡å†…å­˜å ç”¨å¤šäº†970.34MBã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;list main.main&lt;/code&gt; å‘Šè¯‰äº†æˆ‘ä»¬å¢é•¿çš„å†…å­˜éƒ½åœ¨è¿™ä¸€è¡Œï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;buf = append(buf, make([]byte, 1024*1024)...)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;001å’Œ002 profile çš„æ–‡ä»¶ä¸è¿›å»çœ‹äº†ï¼Œä½ æœ¬åœ°æµ‹è¯•ä¸‹è®¡ç®—å·®å€¼ï¼Œç»å¯¹æ˜¯åˆšæ‰å¯¹æ¯”å‡ºçš„970.34MBã€‚&lt;/p&gt;
&lt;h4 id=&quot;heapâ€œä¸èƒ½â€å®šä½å†…å­˜æ³„éœ²&quot;&gt;&lt;a href=&quot;#heapâ€œä¸èƒ½â€å®šä½å†…å­˜æ³„éœ²&quot; class=&quot;headerlink&quot; title=&quot;heapâ€œä¸èƒ½â€å®šä½å†…å­˜æ³„éœ²&quot;&gt;&lt;/a&gt;heapâ€œä¸èƒ½â€å®šä½å†…å­˜æ³„éœ²&lt;/h4&gt;&lt;p&gt;heap èƒ½æ˜¾ç¤ºå†…å­˜çš„åˆ†é…æƒ…å†µï¼Œä»¥åŠå“ªè¡Œä»£ç å ç”¨äº†å¤šå°‘å†…å­˜ï¼Œæˆ‘ä»¬èƒ½è½»æ˜“çš„æ‰¾åˆ°å ç”¨å†…å­˜æœ€å¤šçš„åœ°æ–¹ï¼Œå¦‚æœè¿™ä¸ªåœ°æ–¹çš„æ•°å€¼è¿˜åœ¨ä¸æ–­æ€å¤§ï¼ŒåŸºæœ¬å¯ä»¥è®¤å®šè¿™é‡Œå°±æ˜¯å†…å­˜æ³„éœ²çš„ä½ç½®ã€‚&lt;/p&gt;
&lt;p&gt;æ›¾æƒ³æŒ‰å›¾ç´¢éª¥ï¼Œä»å†…å­˜æ³„éœ²çš„ä½ç½®ï¼Œæ ¹æ®è°ƒç”¨æ ˆå‘ä¸ŠæŸ¥æ‰¾ï¼Œæ€»èƒ½æ‰¾åˆ°å†…å­˜æ³„éœ²çš„åŸå› ï¼Œè¿™ç§æ–¹æ¡ˆçœ‹èµ·æ¥æ˜¯ä¸é”™çš„ï¼Œä½†å®æ–½èµ·æ¥å´æ‰¾ä¸åˆ°å†…å­˜æ³„éœ²çš„åŸå› ï¼Œç»“æœæ˜¯äº‹åŠåŠŸå€ã€‚&lt;/p&gt;
&lt;p&gt;åŸå› åœ¨äºä¸€ä¸ªGoç¨‹åºï¼Œå…¶ä¸­æœ‰å¤§é‡çš„ goroutineï¼Œè¿™å…¶ä¸­çš„è°ƒç”¨å…³ç³»ä¹Ÿè®¸æœ‰ç‚¹å¤æ‚ï¼Œä¹Ÿè®¸å†…å­˜æ³„éœ²æ˜¯åœ¨æŸä¸ªä¸‰æ–¹åŒ…é‡Œã€‚ä¸¾ä¸ªæ —å­ï¼Œæ¯”å¦‚ä¸‹é¢è¿™å¹…å›¾ï¼Œæ¯ä¸ªæ¤­åœ†ä»£è¡¨1ä¸ª goroutineï¼Œå…¶ä¸­çš„æ•°å­—ä¸ºç¼–å·ï¼Œç®­å¤´ä»£è¡¨è°ƒç”¨å…³ç³»ã€‚heap profile æ˜¾ç¤º g111ï¼ˆæœ€ä¸‹æ–¹æ ‡çº¢èŠ‚ç‚¹ï¼‰è¿™ä¸ªåç¨‹çš„ä»£ç å‡ºç°äº†æ³„éœ²ï¼Œä»»ä½•ä¸€ä¸ªä» g101 åˆ° g111 çš„è°ƒç”¨è·¯å¾„éƒ½å¯èƒ½é€ æˆäº† g111 çš„å†…å­˜æ³„éœ²ï¼Œæœ‰2ç±»å¯èƒ½ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è¯¥ goroutine åªè°ƒç”¨äº†å°‘æ•°å‡ æ¬¡ï¼Œä½†æ¶ˆè€—äº†å¤§é‡çš„å†…å­˜ï¼Œè¯´æ˜æ¯ä¸ª goroutine è°ƒç”¨éƒ½æ¶ˆè€—äº†ä¸å°‘å†…å­˜ï¼Œ&lt;strong&gt;å†…å­˜æ³„éœ²çš„åŸå› åŸºæœ¬å°±åœ¨è¯¥åç¨‹å†…éƒ¨&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;li&gt;è¯¥ goroutine çš„è°ƒç”¨æ¬¡æ•°éå¸¸å¤šï¼Œè™½ç„¶æ¯ä¸ªåç¨‹è°ƒç”¨è¿‡ç¨‹ä¸­æ¶ˆè€—çš„å†…å­˜ä¸å¤šï¼Œä½†è¯¥è°ƒç”¨è·¯å¾„ä¸Šï¼Œåç¨‹æ•°é‡å·¨å¤§ï¼Œé€ æˆæ¶ˆè€—å¤§é‡çš„å†…å­˜ï¼Œå¹¶ä¸”è¿™äº› goroutine ç”±äºæŸç§åŸå› æ— æ³•é€€å‡ºï¼Œå ç”¨çš„å†…å­˜ä¸ä¼šé‡Šæ”¾ï¼Œ&lt;strong&gt;å†…å­˜æ³„éœ²çš„åŸå› åœ¨åˆ° g111 è°ƒç”¨è·¯å¾„ä¸ŠæŸæ®µä»£ç å®ç°æœ‰é—®é¢˜ï¼Œé€ æˆåˆ›å»ºäº†å¤§é‡çš„ g111&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;ç¬¬2ç§æƒ…å†µï¼Œå°±æ˜¯ goroutine æ³„éœ²ï¼Œè¿™æ˜¯é€šè¿‡ heap æ— æ³•å‘ç°çš„ï¼Œæ‰€ä»¥ heap åœ¨å®šä½å†…å­˜æ³„éœ²è¿™ä»¶äº‹ä¸Šï¼Œå‘æŒ¥çš„ä½œç”¨ä¸å¤§&lt;/strong&gt;ã€‚&lt;br&gt;&lt;img src=&quot;/images/go/pprof_5.png&quot; alt=&quot;go pprof&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;goroutine-æ³„éœ²æ€ä¹ˆå¯¼è‡´å†…å­˜æ³„éœ²&quot;&gt;&lt;a href=&quot;#goroutine-æ³„éœ²æ€ä¹ˆå¯¼è‡´å†…å­˜æ³„éœ²&quot; class=&quot;headerlink&quot; title=&quot;goroutine æ³„éœ²æ€ä¹ˆå¯¼è‡´å†…å­˜æ³„éœ²&quot;&gt;&lt;/a&gt;goroutine æ³„éœ²æ€ä¹ˆå¯¼è‡´å†…å­˜æ³„éœ²&lt;/h2&gt;&lt;h3 id=&quot;ä»€ä¹ˆæ˜¯-goroutine-æ³„éœ²&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯-goroutine-æ³„éœ²&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯ goroutine æ³„éœ²&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯ goroutine æ³„éœ²&lt;/h3&gt;&lt;p&gt;å¦‚æœä½ å¯åŠ¨äº†1ä¸ª goroutineï¼Œä½†å¹¶æ²¡æœ‰ç¬¦åˆé¢„æœŸçš„é€€å‡ºï¼Œç›´åˆ°ç¨‹åºç»“æŸï¼Œæ­¤ goroutine æ‰é€€å‡ºï¼Œè¿™ç§æƒ…å†µå°±æ˜¯ goroutine æ³„éœ²ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æå‰æ€è€ƒï¼šä»€ä¹ˆä¼šå¯¼è‡´ goroutine æ— æ³•é€€å‡º/é˜»å¡ï¼Ÿ&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;goroutine-æ³„éœ²æ€ä¹ˆå¯¼è‡´å†…å­˜æ³„éœ²-1&quot;&gt;&lt;a href=&quot;#goroutine-æ³„éœ²æ€ä¹ˆå¯¼è‡´å†…å­˜æ³„éœ²-1&quot; class=&quot;headerlink&quot; title=&quot;goroutine æ³„éœ²æ€ä¹ˆå¯¼è‡´å†…å­˜æ³„éœ²&quot;&gt;&lt;/a&gt;goroutine æ³„éœ²æ€ä¹ˆå¯¼è‡´å†…å­˜æ³„éœ²&lt;/h3&gt;&lt;p&gt;æ¯ä¸ª goroutine å ç”¨ 2KB å†…å­˜ï¼Œæ³„éœ²1ç™¾ä¸‡ goroutine è‡³å°‘æ³„éœ² &lt;code&gt;2KB * 1000000 = 2GB&lt;/code&gt; å†…å­˜ï¼Œä¸ºä»€ä¹ˆè¯´è‡³å°‘å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;goroutine æ‰§è¡Œè¿‡ç¨‹ä¸­è¿˜å­˜åœ¨ä¸€äº›å˜é‡ï¼Œå¦‚æœè¿™äº›å˜é‡æŒ‡å‘å †å†…å­˜ä¸­çš„å†…å­˜ï¼ŒGCä¼šè®¤ä¸ºè¿™äº›å†…å­˜ä»åœ¨ä½¿ç”¨ï¼Œä¸ä¼šå¯¹å…¶è¿›è¡Œå›æ”¶ï¼Œè¿™äº›å†…å­˜è°éƒ½æ— æ³•ä½¿ç”¨ï¼Œé€ æˆäº†å†…å­˜æ³„éœ²ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ goroutine æ³„éœ²æœ‰2ç§æ–¹å¼é€ æˆå†…å­˜æ³„éœ²ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;goroutine æœ¬èº«çš„æ ˆæ‰€å ç”¨çš„ç©ºé—´é€ æˆå†…å­˜æ³„éœ²ã€‚&lt;/li&gt;
&lt;li&gt;goroutine ä¸­çš„å˜é‡æ‰€å ç”¨çš„å †å†…å­˜å¯¼è‡´å †å†…å­˜æ³„éœ²ï¼Œè¿™ä¸€éƒ¨åˆ†æ˜¯èƒ½é€šè¿‡ heap profile ä½“ç°å‡ºæ¥çš„ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Dave åœ¨æ–‡ç« ä¸­ä¹Ÿæåˆ°äº†ï¼Œå¦‚æœä¸çŸ¥é“ä½•æ—¶åœæ­¢ä¸€ä¸ª goroutine ï¼Œè¿™ä¸ª goroutine å°±æ˜¯æ½œåœ¨çš„å†…å­˜æ³„éœ²ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://dave.cheney.net/high-performance-go-workshop/dotgo-paris.html#know_when_to_stop_a_goroutine&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;7.1.1 Know when to stop a goroutine&lt;/a&gt;&lt;br&gt;If you donâ€™t know the answer, thatâ€™s a potential memory leak as the goroutine will pin its stackâ€™s memory on the heap, as well as any heap allocated variables reachable from the stack.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;æ€ä¹ˆç¡®å®šæ˜¯goroutineæ³„éœ²å¼•å‘çš„å†…å­˜æ³„éœ²&quot;&gt;&lt;a href=&quot;#æ€ä¹ˆç¡®å®šæ˜¯goroutineæ³„éœ²å¼•å‘çš„å†…å­˜æ³„éœ²&quot; class=&quot;headerlink&quot; title=&quot;æ€ä¹ˆç¡®å®šæ˜¯goroutineæ³„éœ²å¼•å‘çš„å†…å­˜æ³„éœ²&quot;&gt;&lt;/a&gt;æ€ä¹ˆç¡®å®šæ˜¯goroutineæ³„éœ²å¼•å‘çš„å†…å­˜æ³„éœ²&lt;/h3&gt;&lt;p&gt;æŒæ¡äº†å‰é¢çš„ pprof å‘½ä»¤è¡Œçš„åŸºæœ¬ç”¨æ³•ï¼Œå¾ˆå¿«å°±å¯ä»¥ç¡®è®¤æ˜¯å¦æ˜¯ goroutine æ³„éœ²å¯¼è‡´å†…å­˜æ³„éœ²ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åˆ¤æ–­ä¾æ®ï¼šåœ¨èŠ‚ç‚¹æ­£å¸¸è¿è¡Œçš„æƒ…å†µä¸‹ï¼Œéš”ä¸€æ®µæ—¶é—´è·å– goroutine çš„æ•°é‡ï¼Œå¦‚æœåé¢è·å–çš„é‚£æ¬¡ï¼ŒæŸäº› goroutine æ¯”å‰ä¸€æ¬¡å¤šï¼Œå¦‚æœå¤šè·å–å‡ æ¬¡ï¼Œæ˜¯æŒç»­å¢é•¿çš„ï¼Œå°±ææœ‰å¯èƒ½æ˜¯goroutine æ³„éœ²ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;goroutine å¯¼è‡´å†…å­˜æ³„éœ²çš„ demoï¼š&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// goroutineæ³„éœ²å¯¼è‡´å†…å­˜æ³„éœ²&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;net/http&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _ &lt;span class=&quot;string&quot;&gt;&quot;net/http/pprof&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;os&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// å¼€å¯pprof&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ip := &lt;span class=&quot;string&quot;&gt;&quot;0.0.0.0:6060&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := http.ListenAndServe(ip, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            fmt.Printf(&lt;span class=&quot;string&quot;&gt;&quot;start pprof failed on %s\n&quot;&lt;/span&gt;, ip)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            os.Exit(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    outCh := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// æ­»ä»£ç ï¼Œæ°¸ä¸è¯»å–&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;lt;-outCh&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;select&lt;/span&gt; &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// æ¯sèµ·100ä¸ªgoroutineï¼Œgoroutineä¼šé˜»å¡ï¼Œä¸é‡Šæ”¾å†…å­˜&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    tick := time.Tick(time.Second / &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; tick &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        i++&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        fmt.Println(i)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        alloc1(outCh)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;alloc1&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(outCh &lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt;&amp;lt;- &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; alloc2(outCh)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;alloc2&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(outCh &lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt;&amp;lt;- &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;alloc-fm exit&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// åˆ†é…å†…å­˜ï¼Œå€Ÿç”¨ä¸€ä¸‹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        buf := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _ = &lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(buf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;alloc done&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        outCh &amp;lt;- &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 53è¡Œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç¼–è¯‘å¹¶è¿è¡Œä»¥ä¸Šä»£ç ï¼Œç„¶åä½¿ç”¨ &lt;code&gt;go tool pprof&lt;/code&gt; è·å– gorourine çš„ profile æ–‡ä»¶ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://localhost:6060/debug/pprof/goroutine&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å·²ç»é€šè¿‡ pprof å‘½ä»¤è·å–äº†2ä¸ª goroutine çš„ profile æ–‡ä»¶:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ ls&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/home/ubuntu/pprof/pprof.leak_demo.goroutine.001.pb.gz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/home/ubuntu/pprof/pprof.leak_demo.goroutine.002.pb.gz&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åŒ heap ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ &lt;code&gt;base&lt;/code&gt; å¯¹æ¯”2ä¸ª goroutine profile æ–‡ä»¶ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable&quot;&gt;$go&lt;/span&gt; tool pprof -base pprof.leak_demo.goroutine.001.pb.gz pprof.leak_demo.goroutine.002.pb.gz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;File: leak_demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Type: goroutine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Time: May 16, 2019 at 2:44pm (CST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Entering interactive mode (&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;help&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; commands, &lt;span class=&quot;string&quot;&gt;&quot;o&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; options)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof) top&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Showing nodes accounting &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 20312, 100% of 20312 total&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      flat  flat%   sum%        cum   cum%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     20312   100%   100%      20312   100%  runtime.gopark&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      20312   100%  main.alloc2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      20312   100%  main.alloc2.func1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      20312   100%  runtime.chansend&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      20312   100%  runtime.chansend1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      20312   100%  runtime.goparkunlock&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°è¿è¡Œåˆ° &lt;code&gt;runtime.gopark&lt;/code&gt; çš„ goroutine æ•°é‡å¢åŠ äº†20312ä¸ªã€‚å†é€šè¿‡002æ–‡ä»¶ï¼Œçœ‹ä¸€çœ¼æ‰§è¡Œåˆ° &lt;code&gt;gopark&lt;/code&gt; çš„ goroutine æ•°é‡ï¼Œå³æŒ‚èµ·çš„ goroutine æ•°é‡ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof pprof.leak_demo.goroutine.002.pb.gz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;File: leak_demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Type: goroutine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Time: May 16, 2019 at 2:47pm (CST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Entering interactive mode (&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;help&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; commands, &lt;span class=&quot;string&quot;&gt;&quot;o&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; options)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof) top&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Showing nodes accounting &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 24330, 100% of 24331 total&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Dropped 32 nodes (cum &amp;lt;= 121)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      flat  flat%   sum%        cum   cum%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     24330   100%   100%      24330   100%  runtime.gopark&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      24326   100%  main.alloc2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      24326   100%  main.alloc2.func1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      24326   100%  runtime.chansend&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      24326   100%  runtime.chansend1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      24327   100%  runtime.goparkunlock&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ˜¾ç¤ºæœ‰24330ä¸ª goroutine è¢«æŒ‚èµ·ï¼Œè¿™ä¸æ˜¯ goroutine æ³„éœ²è¿™æ˜¯å•¥ï¼Ÿå·²ç»èƒ½ç¡®å®šå…«ä¹æˆgoroutine æ³„éœ²äº†ã€‚&lt;/p&gt;
&lt;p&gt;æ˜¯ä»€ä¹ˆå¯¼è‡´å¦‚æ­¤å¤šçš„ goroutine è¢«æŒ‚èµ·è€Œæ— æ³•é€€å‡ºï¼Ÿæ¥ä¸‹æ¥å°±çœ‹æ€ä¹ˆå®šä½ goroutine æ³„éœ²ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å®šä½goroutineæ³„éœ²çš„2ç§æ–¹æ³•&quot;&gt;&lt;a href=&quot;#å®šä½goroutineæ³„éœ²çš„2ç§æ–¹æ³•&quot; class=&quot;headerlink&quot; title=&quot;å®šä½goroutineæ³„éœ²çš„2ç§æ–¹æ³•&quot;&gt;&lt;/a&gt;å®šä½goroutineæ³„éœ²çš„2ç§æ–¹æ³•&lt;/h2&gt;&lt;p&gt;ä½¿ç”¨ pprof æœ‰2ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯webç½‘é¡µï¼Œä¸€ç§æ˜¯ &lt;code&gt;go tool pprof&lt;/code&gt; å‘½ä»¤è¡Œäº¤äº’ï¼Œè¿™ä¸¤ç§æ–¹æ³•æŸ¥çœ‹ goroutine éƒ½æ”¯æŒï¼Œä½†æœ‰è½»å¾®ä¸åŒï¼Œä¹Ÿæœ‰å„è‡ªçš„ä¼˜ç¼ºç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆçœ‹Webçš„æ–¹å¼ï¼Œå†çœ‹å‘½ä»¤è¡Œäº¤äº’çš„æ–¹å¼ï¼Œè¿™ä¸¤ç§éƒ½å¾ˆå¥½ä½¿ç”¨ï¼Œç»“åˆèµ·æ¥ç”¨ä¹Ÿä¸é”™ã€‚&lt;/p&gt;
&lt;h3 id=&quot;Webå¯è§†åŒ–æŸ¥çœ‹&quot;&gt;&lt;a href=&quot;#Webå¯è§†åŒ–æŸ¥çœ‹&quot; class=&quot;headerlink&quot; title=&quot;Webå¯è§†åŒ–æŸ¥çœ‹&quot;&gt;&lt;/a&gt;Webå¯è§†åŒ–æŸ¥çœ‹&lt;/h3&gt;&lt;p&gt;Webæ–¹å¼é€‚åˆwebæœåŠ¡å™¨çš„ç«¯å£èƒ½è®¿é—®çš„æƒ…å†µï¼Œä½¿ç”¨èµ·æ¥æ–¹ä¾¿ï¼Œæœ‰2ç§æ–¹å¼ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;æŸ¥çœ‹æŸæ¡è°ƒç”¨è·¯å¾„ä¸Šï¼Œå½“å‰é˜»å¡åœ¨æ­¤ goroutine çš„æ•°é‡&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;æŸ¥çœ‹æ‰€æœ‰ goroutine çš„è¿è¡Œæ ˆï¼ˆè°ƒç”¨è·¯å¾„ï¼‰ï¼Œå¯ä»¥&lt;strong&gt;æ˜¾ç¤ºé˜»å¡åœ¨æ­¤çš„æ—¶é—´&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&quot;æ–¹å¼ä¸€&quot;&gt;&lt;a href=&quot;#æ–¹å¼ä¸€&quot; class=&quot;headerlink&quot; title=&quot;æ–¹å¼ä¸€&quot;&gt;&lt;/a&gt;æ–¹å¼ä¸€&lt;/h4&gt;&lt;p&gt;urlè¯·æ±‚ä¸­è®¾ç½®debug=1ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;http://ip:port/debug/pprof/goroutine?debug=1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ•ˆæœå¦‚ä¸‹ï¼š&lt;br&gt;&lt;img src=&quot;/images/go/pprof_6.png&quot; alt=&quot;go pprof&quot;&gt;&lt;/p&gt;
&lt;p&gt;çœ‹èµ·æ¥å¯†å¯†éº»éº»çš„ï¼Œå…¶å®ç®€å•åˆååˆ†æœ‰ç”¨ï¼Œçœ‹ä¸Šå›¾æ ‡å‡ºæ¥çš„éƒ¨åˆ†ï¼Œæ‰‹æœºä¸Šå›¾çœ‹èµ·æ¥å¯èƒ½ä¸æ–¹ä¾¿ï¼Œé‚£å°±æ”¾å¤§å›¾ç‰‡ï¼Œæˆ–ç›´æ¥çœ‹ä¸‹é¢å„å­—æ®µçš„å«ä¹‰ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;goroutine profile: total 32023&lt;/code&gt;ï¼š32023 æ˜¯ &lt;strong&gt;goroutine çš„æ€»æ•°é‡&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;32015 @ 0x42e15a 0x42e20e 0x40534b 0x4050e5 ...&lt;/code&gt;ï¼š32015 ä»£è¡¨å½“å‰æœ‰32015 ä¸ª goroutine è¿è¡Œè¿™ä¸ªè°ƒç”¨æ ˆï¼Œå¹¶ä¸”åœåœ¨ç›¸åŒä½ç½®ï¼Œ@åé¢çš„åå…­è¿›åˆ¶ï¼Œç°åœ¨ç”¨ä¸åˆ°è¿™ä¸ªæ•°æ®ï¼Œæ‰€ä»¥æš‚ä¸æ·±ç©¶äº†&lt;/li&gt;
&lt;li&gt;ä¸‹é¢æ˜¯å½“å‰ goroutine çš„&lt;strong&gt;è°ƒç”¨æ ˆ&lt;/strong&gt;ï¼Œåˆ—å‡ºäº†&lt;strong&gt;å‡½æ•°å’Œæ‰€åœ¨æ–‡ä»¶çš„è¡Œæ•°ï¼Œè¿™ä¸ªè¡Œæ•°å¯¹å®šä½å¾ˆæœ‰å¸®åŠ©&lt;/strong&gt;ï¼Œå¦‚ä¸‹ï¼š&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;32015 @ 0x42e15a 0x42e20e 0x40534b 0x4050e5 0x6d8559 0x6d831b 0x45abe1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#    0x6d8558    main.alloc2.func1+0xf8    /home/ubuntu/heap/leak_demo.go:53&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#    0x6d831a    main.alloc2+0x2a    /home/ubuntu/heap/leak_demo.go:54&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ ¹æ®ä¸Šé¢çš„æç¤ºï¼Œå°±èƒ½åˆ¤æ–­32015ä¸ª goroutine è¿è¡Œåˆ° &lt;code&gt;leak_demo.go&lt;/code&gt; çš„53è¡Œï¼š&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;alloc2&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(outCh &lt;span class=&quot;keyword&quot;&gt;chan&lt;/span&gt;&amp;lt;- &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;alloc-fm exit&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// åˆ†é…å†…å­˜ï¼Œå‡ç”¨ä¸€ä¸‹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        buf := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _ = &lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(buf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;alloc done&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        outCh &amp;lt;- &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 53è¡Œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;é˜»å¡çš„åŸå› æ˜¯ outCh è¿™ä¸ªå†™æ“ä½œæ— æ³•å®Œæˆï¼ŒoutCh æ˜¯æ— ç¼“å†²çš„é€šé“ï¼Œå¹¶ä¸”ç”±äºä»¥ä¸‹ä»£ç æ˜¯æ­»ä»£ç ï¼Œæ‰€ä»¥ goroutine å§‹ç»ˆæ²¡æœ‰ä» outCh è¯»æ•°æ®ï¼Œé€ æˆ outCh é˜»å¡ï¼Œè¿›è€Œé€ æˆæ— æ•°ä¸ªalloc2 çš„ goroutine é˜»å¡ï¼Œå½¢æˆå†…å­˜æ³„éœ²ï¼š&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;-outCh&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;æ–¹å¼äºŒ&quot;&gt;&lt;a href=&quot;#æ–¹å¼äºŒ&quot; class=&quot;headerlink&quot; title=&quot;æ–¹å¼äºŒ&quot;&gt;&lt;/a&gt;æ–¹å¼äºŒ&lt;/h4&gt;&lt;p&gt;url è¯·æ±‚ä¸­è®¾ç½® debug=2 ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;http://ip:port/debug/pprof/goroutine?debug=2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/go/pprof_7.png&quot; alt=&quot;go pprof&quot;&gt;&lt;/p&gt;
&lt;p&gt;ç¬¬2ç§æ–¹å¼å’Œç¬¬1ç§æ–¹å¼æ˜¯äº’è¡¥çš„ï¼Œå®ƒå¯ä»¥çœ‹åˆ°æ¯ä¸ª goroutine çš„ä¿¡æ¯ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;goroutine 20 [chan send, 2 minutes]&lt;/code&gt;ï¼š20 æ˜¯ goroutine idï¼Œ[]ä¸­æ˜¯å½“å‰goroutine çš„çŠ¶æ€ï¼Œé˜»å¡åœ¨å†™ channel ï¼Œå¹¶ä¸”é˜»å¡äº†2åˆ†é’Ÿï¼Œé•¿æ—¶é—´è¿è¡Œçš„ç³»ç»Ÿï¼Œä½ èƒ½çœ‹åˆ°é˜»å¡æ—¶é—´æ›´é•¿çš„æƒ…å†µã€‚&lt;/li&gt;
&lt;li&gt;åŒæ—¶ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°è°ƒç”¨æ ˆï¼Œçœ‹å½“å‰æ‰§è¡Œåœåˆ°å“ªäº†ï¼š&lt;code&gt;leak_demo.go&lt;/code&gt; çš„53è¡Œ&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;goroutine 20 [chan send, 2 minutes]:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;main.alloc2.func1(0xc42015e060)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    /home/ubuntu/heap/leak_demo.go:53 +0xf9  // è¿™&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;main.alloc2(0xc42015e060)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    /home/ubuntu/heap/leak_demo.go:54 +0x2b&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;created by main.alloc1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    /home/ubuntu/heap/leak_demo.go:42 +0x3f&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;å‘½ä»¤è¡Œäº¤äº’å¼æ–¹æ³•&quot;&gt;&lt;a href=&quot;#å‘½ä»¤è¡Œäº¤äº’å¼æ–¹æ³•&quot; class=&quot;headerlink&quot; title=&quot;å‘½ä»¤è¡Œäº¤äº’å¼æ–¹æ³•&quot;&gt;&lt;/a&gt;å‘½ä»¤è¡Œäº¤äº’å¼æ–¹æ³•&lt;/h3&gt;&lt;p&gt;Webçš„æ–¹æ³•æ˜¯ç®€å•ç²—æš´ï¼Œæ— éœ€ç™»å½•æœåŠ¡å™¨ï¼Œæµè§ˆå™¨æ‰“å¼€çœ‹çœ‹å°±è¡Œäº†ã€‚ä½†å°±åƒå‰é¢æçš„ï¼Œæ²¡æœ‰æµè§ˆå™¨å¯è®¿é—®æ—¶ï¼Œå‘½ä»¤è¡Œäº¤äº’å¼æ‰æ˜¯æœ€ä½³çš„æ–¹å¼ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯æ‰‹åˆ°æ“’æ¥ï¼Œæ„Ÿè§‰æ¯”Webä¸€æ ·æ–¹ä¾¿ã€‚&lt;/p&gt;
&lt;p&gt;å‘½ä»¤è¡Œäº¤äº’å¼åªæœ‰1ç§è·å– goroutine profile çš„æ–¹æ³•ï¼Œä¸åƒWebç½‘é¡µåˆ† &lt;code&gt;debug=1&lt;/code&gt; å’Œ&lt;code&gt;debug=2&lt;/code&gt; 2ç§æ–¹å¼ï¼Œå¹¶å°† profile æ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;// æ³¨æ„å‘½ä»¤æ²¡æœ‰`debug=1`ï¼Œdebug=1ï¼ŒåŠ debugæœ‰äº›ç‰ˆæœ¬çš„goä¸æ”¯æŒ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ go tool pprof http://0.0.0.0:6060/debug/pprof/goroutine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Fetching profile over HTTP from http://localhost:6061/debug/pprof/goroutine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Saved profile &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; /home/ubuntu/pprof/pprof.leak_demo.goroutine.001.pb.gz  // profileæ–‡ä»¶ä¿å­˜ä½ç½®&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;File: leak_demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Type: goroutine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Time: May 16, 2019 at 2:44pm (CST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Entering interactive mode (&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;help&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; commands, &lt;span class=&quot;string&quot;&gt;&quot;o&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; options)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å‘½ä»¤è¡Œåªéœ€è¦æŒæ¡3ä¸ªå‘½ä»¤å°±å¥½äº†ï¼Œä¸Šé¢ä»‹ç»è¿‡äº†ï¼Œè¯¦ç»†çš„å€’å›å»çœ‹ &lt;code&gt;top&lt;/code&gt;, &lt;code&gt;list&lt;/code&gt;, &lt;code&gt;traces&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;top&lt;/strong&gt;ï¼šæ˜¾ç¤ºæ­£è¿è¡Œåˆ°æŸä¸ªå‡½æ•° goroutine çš„æ•°é‡&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;traces&lt;/strong&gt;ï¼šæ˜¾ç¤ºæ‰€æœ‰ goroutine çš„è°ƒç”¨æ ˆ&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;list&lt;/strong&gt;ï¼šåˆ—å‡ºä»£ç è¯¦ç»†çš„ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æˆ‘ä»¬ä¾ç„¶ä½¿ç”¨ &lt;code&gt;leak_demo.go&lt;/code&gt; è¿™ä¸ªdemo&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$  go tool pprof -base pprof.leak_demo.goroutine.001.pb.gz pprof.leak_demo.goroutine.002.pb.gz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;File: leak_demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Type: goroutine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Time: May 16, 2019 at 2:44pm (CST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Entering interactive mode (&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;help&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; commands, &lt;span class=&quot;string&quot;&gt;&quot;o&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; options)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof) top&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Showing nodes accounting &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 20312, 100% of 20312 total&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      flat  flat%   sum%        cum   cum%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     20312   100%   100%      20312   100%  runtime.gopark&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      20312   100%  main.alloc2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      20312   100%  main.alloc2.func1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      20312   100%  runtime.chansend&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      20312   100%  runtime.chansend1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0     0%   100%      20312   100%  runtime.goparkunlock&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof) traces&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;File: leak_demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Type: goroutine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Time: May 16, 2019 at 2:44pm (CST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-----------+-------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     20312   runtime.gopark&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             runtime.goparkunlock&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             runtime.chansend&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             runtime.chansend1 // channelå‘é€&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             main.alloc2.func1 // alloc2ä¸­çš„åŒ¿åå‡½æ•°&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             main.alloc2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-----------+-------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;top å‘½ä»¤åœ¨æ€ä¹ˆç¡®å®šæ˜¯ goroutine æ³„éœ²å¼•å‘çš„å†…å­˜æ³„éœ²ä»‹ç»è¿‡äº†ï¼Œç›´æ¥çœ‹ traces å‘½ä»¤ï¼Œtraces èƒ½åˆ—å‡º002ä¸­æ¯”001ä¸­å¤šçš„é‚£äº› goroutine çš„è°ƒç”¨æ ˆï¼Œè¿™é‡Œåªæœ‰1ä¸ªè°ƒç”¨æ ˆï¼Œæœ‰20312ä¸ª goroutine éƒ½æ‰§è¡Œè¿™ä¸ªè°ƒç”¨è·¯å¾„ï¼Œå¯ä»¥çœ‹åˆ° alloc2 ä¸­çš„åŒ¿åå‡½æ•° &lt;code&gt;alloc2.func1&lt;/code&gt; è°ƒç”¨äº†å†™ channel çš„æ“ä½œï¼Œç„¶åé˜»å¡æŒ‚èµ·äº† goroutineï¼Œä½¿ç”¨ list åˆ—å‡º &lt;code&gt;alloc2.func1&lt;/code&gt; çš„ä»£ç ï¼Œæ˜¾ç¤ºæœ‰20312ä¸ª goroutine é˜»å¡åœ¨53è¡Œï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(pprof) list main.alloc2.func1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Total: 20312&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ROUTINE ======================== main.alloc2.func1 &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; /home/ubuntu/heap/leak_demo.go&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         0      20312 (flat, cum)   100% of Total&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     48:        // åˆ†é…å†…å­˜ï¼Œå‡ç”¨ä¸€ä¸‹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     49:        buf := make([]byte, 1024*1024*10)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     50:        _ = len(buf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     51:        fmt.Println(&lt;span class=&quot;string&quot;&gt;&quot;alloc done&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     52:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .      20312     53:        outCh &amp;lt;- 0  // çœ‹è¿™&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     54:    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     55:&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         .          .     56:&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å‹æƒ…æé†’ï¼šä½¿ç”¨listå‘½ä»¤çš„å‰ææ˜¯ç¨‹åºçš„æºç åœ¨å½“å‰æœºå™¨ï¼Œä¸ç„¶å¯æ²¡æ³•åˆ—å‡ºæºç &lt;/strong&gt;ã€‚æœåŠ¡å™¨ä¸Šï¼Œé€šå¸¸æ²¡æœ‰æºç ï¼Œé‚£æˆ‘ä»¬å’‹åŠå‘¢ï¼Ÿåˆšæ‰ä»‹ç»äº†WebæŸ¥çœ‹çš„æ–¹å¼ï¼Œé‚£é‡Œä¼šåˆ—å‡ºä»£ç è¡Œæ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ &lt;code&gt;wget&lt;/code&gt; ä¸‹è½½ç½‘é¡µï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ wget http://localhost:6060/debug/pprof/goroutine?debug=1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä¸‹è½½ç½‘é¡µåï¼Œä½¿ç”¨ç¼–è¾‘å™¨æ‰“å¼€æ–‡ä»¶ï¼Œä½¿ç”¨å…³é”®å­— &lt;code&gt;main.alloc2.func1&lt;/code&gt; è¿›è¡Œæœç´¢ï¼Œæ‰¾åˆ°ä¸å½“å‰ç›¸åŒçš„è°ƒç”¨æ ˆï¼Œå°±å¯ä»¥çœ‹åˆ°è¯¥ goroutine é˜»å¡åœ¨å“ªä¸€è¡Œäº†ï¼Œä¸è¦å¿˜è®°ä½¿ç”¨ &lt;code&gt;debug=2&lt;/code&gt; è¿˜å¯ä»¥çœ‹åˆ°é˜»å¡äº†å¤šä¹…å’ŒåŸå› ï¼ŒWebæ–¹å¼ä¸­å·²ç»ä»‹ç»äº†ï¼Œæ­¤å¤„çœç•¥ä»£ç å‡ åè¡Œã€‚&lt;/p&gt;
&lt;h2 id=&quot;æ€»ç»“&quot;&gt;&lt;a href=&quot;#æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;æ€»ç»“&quot;&gt;&lt;/a&gt;æ€»ç»“&lt;/h2&gt;&lt;h3 id=&quot;goroutine-æ³„éœ²çš„æœ¬è´¨&quot;&gt;&lt;a href=&quot;#goroutine-æ³„éœ²çš„æœ¬è´¨&quot; class=&quot;headerlink&quot; title=&quot;goroutine æ³„éœ²çš„æœ¬è´¨&quot;&gt;&lt;/a&gt;goroutine æ³„éœ²çš„æœ¬è´¨&lt;/h3&gt;&lt;p&gt;goroutine æ³„éœ²çš„æœ¬è´¨æ˜¯ channel é˜»å¡ï¼Œæ— æ³•ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå¯¼è‡´æ­¤ goroutine å…³è”çš„å†…å­˜éƒ½æ— æ³•é‡Šæ”¾ï¼Œè¿›ä¸€æ­¥é€ æˆå†…å­˜æ³„éœ²ã€‚&lt;/p&gt;
&lt;h3 id=&quot;goroutine-æ³„éœ²çš„å‘ç°å’Œå®šä½&quot;&gt;&lt;a href=&quot;#goroutine-æ³„éœ²çš„å‘ç°å’Œå®šä½&quot; class=&quot;headerlink&quot; title=&quot;goroutine æ³„éœ²çš„å‘ç°å’Œå®šä½&quot;&gt;&lt;/a&gt;goroutine æ³„éœ²çš„å‘ç°å’Œå®šä½&lt;/h3&gt;&lt;p&gt;åˆ©ç”¨å¥½ go pprof è·å– goroutine profile æ–‡ä»¶ï¼Œç„¶ååˆ©ç”¨3ä¸ªå‘½ä»¤ &lt;code&gt;top&lt;/code&gt;ã€&lt;code&gt;traces&lt;/code&gt;ã€&lt;code&gt;list&lt;/code&gt; å®šä½å†…å­˜æ³„éœ²çš„åŸå› ã€‚&lt;/p&gt;
&lt;h3 id=&quot;goroutine-æ³„éœ²çš„åœºæ™¯&quot;&gt;&lt;a href=&quot;#goroutine-æ³„éœ²çš„åœºæ™¯&quot; class=&quot;headerlink&quot; title=&quot;goroutine æ³„éœ²çš„åœºæ™¯&quot;&gt;&lt;/a&gt;goroutine æ³„éœ²çš„åœºæ™¯&lt;/h3&gt;&lt;p&gt;æ³„éœ²çš„åœºæ™¯ä¸ä»…é™äºä»¥ä¸‹ä¸¤ç±»ï¼Œä½†å› channelç›¸å…³çš„æ³„éœ²æ˜¯æœ€å¤šçš„ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;channel çš„è¯»æˆ–è€…å†™ï¼š&lt;ol&gt;
&lt;li&gt;æ— ç¼“å†² channel çš„é˜»å¡é€šå¸¸æ˜¯å†™æ“ä½œå› ä¸ºæ²¡æœ‰è¯»è€Œé˜»å¡&lt;/li&gt;
&lt;li&gt;æœ‰ç¼“å†²çš„ channel å› ä¸ºç¼“å†²åŒºæ»¡äº†ï¼Œå†™æ“ä½œé˜»å¡&lt;/li&gt;
&lt;li&gt;æœŸå¾…ä» channel è¯»æ•°æ®ï¼Œç»“æœæ²¡æœ‰ goroutine å†™&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;select æ“ä½œï¼Œselect é‡Œä¹Ÿæ˜¯ channel æ“ä½œï¼Œå¦‚æœæ‰€æœ‰ case ä¸Šçš„æ“ä½œé˜»å¡ï¼Œgoroutine ä¹Ÿæ— æ³•ç»§ç»­æ‰§è¡Œã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;ç¼–ç -goroutine-æ³„éœ²çš„å»ºè®®&quot;&gt;&lt;a href=&quot;#ç¼–ç -goroutine-æ³„éœ²çš„å»ºè®®&quot; class=&quot;headerlink&quot; title=&quot;ç¼–ç  goroutine æ³„éœ²çš„å»ºè®®&quot;&gt;&lt;/a&gt;ç¼–ç  goroutine æ³„éœ²çš„å»ºè®®&lt;/h3&gt;&lt;p&gt;ä¸ºé¿å… goroutine æ³„éœ²é€ æˆå†…å­˜æ³„éœ²ï¼Œå¯åŠ¨ goroutine å‰è¦æ€è€ƒæ¸…æ¥šï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;goroutine å¦‚ä½•é€€å‡ºï¼Ÿ&lt;/li&gt;
&lt;li&gt;æ˜¯å¦ä¼šæœ‰é˜»å¡é€ æˆæ— æ³•é€€å‡ºï¼Ÿå¦‚æœæœ‰ï¼Œé‚£ä¹ˆè¿™ä¸ªè·¯å¾„æ˜¯å¦ä¼šåˆ›å»ºå¤§é‡çš„ goroutineï¼Ÿ&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æœ¬æ–‡ä½œè€…ï¼šå¤§å½¬&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;å¾®ä¿¡è®¢é˜…å·&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘è§£å†³äº†æˆ‘ä»¬é¡¹ç›®ä¸­çš„ä¸€ä¸ªå†…å­˜æ³„éœ²é—®é¢˜ï¼Œäº‹å®å†æ¬¡è¯æ˜ pprof æ˜¯ä¸€ä¸ªå¥½å·¥å…·ï¼Œä½†æŒæ¡å¥½å·¥å…·çš„æ­£ç¡®ç”¨æ³•ï¼Œæ‰èƒ½å‘æŒ¥å¥½å·¥å…·çš„å¨åŠ›ï¼Œä¸ç„¶å°±ç®—ä½ æ‰‹é‡Œæœ‰å± é¾™åˆ€ï¼Œä¹Ÿæˆä¸äº†å¤©ä¸‹ç¬¬ä¸€ï¼Œæœ¬æ–‡å°±æ˜¯å¸¦ä½ ç”¨ pprof å®šä½å†…å­˜æ³„éœ²é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;å…³äºGoçš„å†…å­˜æ³„éœ²æœ‰è¿™ä¹ˆä¸€å¥è¯ä¸çŸ¥é“ä½ å¬è¿‡æ²¡æœ‰ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;10æ¬¡å†…å­˜æ³„éœ²ï¼Œæœ‰9æ¬¡æ˜¯ goroutine æ³„éœ²ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æˆ‘æ‰€è§£å†³çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯ goroutine æ³„éœ²å¯¼è‡´çš„å†…å­˜æ³„éœ²ï¼Œæ‰€ä»¥&lt;strong&gt;è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»Goç¨‹åºçš„goroutine æ³„éœ²ï¼ŒæŒæ¡äº†å¦‚ä½•å®šä½å’Œè§£å†³ goroutine æ³„éœ²ï¼Œå°±æŒæ¡äº†å†…å­˜æ³„éœ²çš„å¤§éƒ¨åˆ†åœºæ™¯&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡è‰ç¨¿æœ€åˆæ•°æ®éƒ½æ˜¯ç”Ÿäº§åå¢ƒæ•°æ®ï¼Œä¸ºäº†é˜²æ­¢æ•æ„Ÿå†…å®¹æ³„éœ²ï¼Œå…¨éƒ¨æ›¿æ¢æˆäº†demoæ•°æ®ï¼Œdemoçš„æ•°æ®æ¯”ç”Ÿäº§ç¯å¢ƒæ•°æ®ç®€å•å¤šäº†ï¼Œæ›´é€‚åˆå…¥é—¨ç†è§£ï¼Œæœ‰åŠ©äºæŒæ¡ pprofã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="pprof" scheme="http://team.jiunile.com/categories/golang/pprof/"/>
    
    
      <category term="goroutine" scheme="http://team.jiunile.com/tags/goroutine/"/>
    
      <category term="pprof" scheme="http://team.jiunile.com/tags/pprof/"/>
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="å†…å­˜æ³„æ¼" scheme="http://team.jiunile.com/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes hostpathå’Œlocal volumeåŒºåˆ«</title>
    <link href="http://team.jiunile.com//blog/2020/09/k8s-local-volume.html"/>
    <id>http://team.jiunile.com//blog/2020/09/k8s-local-volume.html</id>
    <published>2020-09-16T12:00:00.000Z</published>
    <updated>2020-09-16T09:45:48.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;å¾ˆå¤šäººå¯¹hostPath volumeå’Œlocal persistent volumeçš„ä½¿ç”¨åœºæ™¯è¿˜å­˜åœ¨å¾ˆå¤šå›°æƒ‘ã€‚ä¸‹é¢å¯¹ç€ä¸¤ç§volumeçš„ä½¿ç”¨åœºæ™¯ã€åŸºæœ¬çš„å·¥ä½œæœºåˆ¶è¿›è¡Œäº†åˆ†æï¼Œä»‹ç»äº†ä½¿ç”¨æ—¶çš„æ³¨æ„äº‹é¡¹ï¼Œå¹¶ç®€å•ä»‹ç»&lt;a href=&quot;https://github.com/kubernetes-incubator/external-storage/tree/master/local-volume&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;local volume manager&lt;/a&gt;å¦‚ä½•å¸®åŠ©administratorè¿›è¡Œlocal persistent volumeçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;hostPath-volumeå­˜åœ¨çš„é—®é¢˜&quot;&gt;&lt;a href=&quot;#hostPath-volumeå­˜åœ¨çš„é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;hostPath volumeå­˜åœ¨çš„é—®é¢˜&quot;&gt;&lt;/a&gt;hostPath volumeå­˜åœ¨çš„é—®é¢˜&lt;/h2&gt;&lt;p&gt;è¿‡å»æˆ‘ä»¬ç»å¸¸ä¼šé€šè¿‡hostPath volumeè®©Podèƒ½å¤Ÿä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œå°†Nodeæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æˆ–è€…ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ï¼Œä½†æ˜¯hostPath volumeçš„ä½¿ç”¨æ˜¯å¾ˆéš¾å—çš„ï¼Œå¹¶ä¸é€‚åˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆçœ‹çœ‹hostPath Typeæœ‰å“ªäº›ç±»å‹ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;strong&gt;å–å€¼&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;è¡Œä¸º&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;ç©ºå­—ç¬¦ä¸²ï¼ˆé»˜è®¤ï¼‰ç”¨äºå‘åå…¼å®¹ï¼Œè¿™æ„å‘³ç€åœ¨å®‰è£… hostPath å·ä¹‹å‰ä¸ä¼šæ‰§è¡Œä»»ä½•æ£€æŸ¥ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;DirectoryOrCreate&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åœ¨ç»™å®šï¤·å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„ç›®å½•ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;FileOrCreate&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å¦‚æœåœ¨ç»™å®šè·¯å¾„ä¸Šä»€ä¹ˆéƒ½ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°†åœ¨é‚£é‡Œæ ¹æ®éœ€è¦åˆ›å»ºç©ºæ–‡ä»¶ï¼Œæƒé™è®¾ç½®ä¸º 0644ï¼Œå…·æœ‰ä¸ Kubelet ç›¸åŒçš„ç»„å’Œæ‰€æœ‰æƒã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;File&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„æ–‡ä»¶ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Socket&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„ UNIX å¥—æ¥å­—ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;CharDevice&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„å­—ç¬¦è®¾å¤‡ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;BlockDevice&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„å—è®¾å¤‡ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;çœ‹èµ·æ¥æ”¯æŒè¿™ä¹ˆå¤štypeè¿˜æ˜¯æŒºå¥½çš„ï¼Œä½†ä¸ºä»€ä¹ˆè¯´ä¸é€‚åˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å‘¢ï¼Ÿ&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç”±äºé›†ç¾¤å†…æ¯ä¸ªèŠ‚ç‚¹çš„å·®å¼‚åŒ–ï¼Œè¦ä½¿ç”¨ &lt;code&gt;hostPath Volume&lt;/code&gt;ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡&lt;code&gt;NodeSelector&lt;/code&gt; ç­‰æ–¹å¼è¿›è¡Œç²¾ç¡®è°ƒåº¦ï¼Œè¿™ç§äº‹æƒ…å¤šäº†ï¼Œä½ å°±ä¼šä¸è€çƒ¦äº†ã€‚&lt;/li&gt;
&lt;li&gt;æ³¨æ„ &lt;code&gt;DirectoryOrCreate&lt;/code&gt; å’Œ &lt;code&gt;FileOrCreate&lt;/code&gt; ä¸¤ç§ç±»å‹çš„ &lt;code&gt;hostPath&lt;/code&gt;ï¼Œå½“Nodeä¸Šæ²¡æœ‰å¯¹åº”çš„ &lt;code&gt;File/Directory&lt;/code&gt; æ—¶ï¼Œä½ éœ€è¦ä¿è¯kubeletæœ‰åœ¨ &lt;code&gt;Nodeä¸ŠCreate File/Directory&lt;/code&gt; çš„æƒé™ã€‚&lt;/li&gt;
&lt;li&gt;å¦å¤–ï¼Œå¦‚æœ Node ä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•æ˜¯ç”± root åˆ›å»ºçš„ï¼ŒæŒ‚è½½åˆ°å®¹å™¨å†…ä¹‹åï¼Œä½ é€šå¸¸è¿˜è¦ä¿è¯å®¹å™¨å†…è¿›ç¨‹æœ‰æƒé™å¯¹è¯¥æ–‡ä»¶æˆ–è€…ç›®å½•è¿›è¡Œå†™å…¥ï¼Œæ¯”å¦‚ä½ éœ€è¦ä»¥ root ç”¨æˆ·å¯åŠ¨è¿›ç¨‹å¹¶è¿è¡Œäº privileged å®¹å™¨ï¼Œæˆ–è€…ä½ éœ€è¦äº‹å…ˆä¿®æ”¹å¥½ Node ä¸Šçš„æ–‡ä»¶æƒé™é…ç½®ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Scheduler&lt;/code&gt; å¹¶ä¸ä¼šè€ƒè™‘ &lt;code&gt;hostPath volume&lt;/code&gt; çš„å¤§å°ï¼Œ&lt;code&gt;hostPath&lt;/code&gt; ä¹Ÿä¸èƒ½ç”³æ˜éœ€è¦çš„ &lt;code&gt;storage size&lt;/code&gt;ï¼Œè¿™æ ·è°ƒåº¦æ—¶å­˜å‚¨çš„è€ƒè™‘ï¼Œå°±éœ€è¦äººä¸ºæ£€æŸ¥å¹¶ä¿è¯ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;local-persistent-volumeå·¥ä½œæœºåˆ¶&quot;&gt;&lt;a href=&quot;#local-persistent-volumeå·¥ä½œæœºåˆ¶&quot; class=&quot;headerlink&quot; title=&quot;local persistent volumeå·¥ä½œæœºåˆ¶&quot;&gt;&lt;/a&gt;local persistent volumeå·¥ä½œæœºåˆ¶&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Local persistent volume&lt;/code&gt; å°±æ˜¯ç”¨æ¥è§£å†³ &lt;code&gt;hostPath volume&lt;/code&gt; é¢ä¸´çš„ &lt;strong&gt;portability, disk accounting, and scheduling&lt;/strong&gt; çš„ç¼ºé™·ã€‚&lt;code&gt;PV Controller&lt;/code&gt; å’Œ &lt;code&gt;Scheduler&lt;/code&gt; ä¼šå¯¹ &lt;code&gt;local PV&lt;/code&gt; åšç‰¹æ®Šçš„é€»è¾‘å¤„ç†ï¼Œä»¥å®ç° Pod ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ—¶å‘ç”ŸPod &lt;code&gt;re-schedule&lt;/code&gt; çš„æƒ…å†µä¸‹èƒ½å†æ¬¡è°ƒåº¦åˆ° &lt;code&gt;local volume&lt;/code&gt; æ‰€åœ¨çš„ Nodeã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;local pv&lt;/code&gt; åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ï¼Œä¹Ÿæ˜¯éœ€è¦è°¨æ…çš„ï¼Œæ¯•ç«Ÿå®ƒæœ¬è´¨ä¸Šè¿˜æ˜¯ä½¿ç”¨çš„æ˜¯èŠ‚ç‚¹ä¸Šçš„æœ¬åœ°å­˜å‚¨ï¼Œå¦‚æœæ²¡æœ‰ç›¸åº”çš„å­˜å‚¨å‰¯æœ¬æœºåˆ¶ï¼Œé‚£æ„å‘³ç€ä¸€æ—¦èŠ‚ç‚¹æˆ–è€…ç£ç›˜å¼‚å¸¸ï¼Œä½¿ç”¨è¯¥volumeçš„Podä¹Ÿä¼šå¼‚å¸¸ï¼Œç”šè‡³å‡ºç°æ•°æ®ä¸¢å¤±ï¼Œé™¤éä½ æ˜ç¡®çŸ¥é“è¿™ä¸ªé£é™©ä¸ä¼šå¯¹ä½ çš„åº”ç”¨é€ æˆå¾ˆå¤§å½±å“æˆ–è€…å…è®¸æ•°æ®ä¸¢å¤±ã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆé€šå¸¸ä»€ä¹ˆæƒ…å†µä¼šä½¿ç”¨Local PVå‘¢ï¼Ÿ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ¯”å¦‚èŠ‚ç‚¹ä¸Šçš„ç›®å½•æ•°æ®æ˜¯ä»è¿œç¨‹çš„ç½‘ç»œå­˜å‚¨ä¸ŠæŒ‚è½½æˆ–è€…é¢„å…ˆè¯»å–åˆ°æœ¬åœ°çš„ï¼Œä¸ºäº†èƒ½åŠ é€ŸPodè¯»å–è¿™äº›æ•°æ®çš„é€Ÿåº¦ï¼Œç›¸å½“äºèµ·Cacheä½œç”¨ï¼Œè¿™ç§æƒ…å†µä¸‹å› ä¸ºåªè¯»ï¼Œä¸å­˜åœ¨æƒ§æ€•æ•°æ®ä¸¢å¤±ã€‚è¿™ç§AIè®­ç»ƒä¸­å­˜åœ¨éœ€è¦é‡å¤åˆ©ç”¨å¹¶ä¸”è®­ç»ƒæ•°æ®å·¨å¤§çš„æ—¶å€™å¯èƒ½ä¼šé‡‡å–çš„æ–¹å¼ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœæœ¬åœ°èŠ‚ç‚¹ä¸Šç›®å½•/ç£ç›˜å®é™…æ˜¯å…·æœ‰å‰¯æœ¬/åˆ†ç‰‡æœºåˆ¶çš„åˆ†å¸ƒå¼å­˜å‚¨(æ¯”å¦‚gluster, cephç­‰)æŒ‚è½½è¿‡æ¥çš„ï¼Œè¿™ç§æƒ…å†µä¹Ÿå¯ä»¥ä½¿ç”¨&lt;code&gt;local pv&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;Local volume&lt;/code&gt; å…è®¸æŒ‚è½½æœ¬åœ°çš„ disk, partition, directory åˆ°å®¹å™¨å†…æŸä¸ªæŒ‚è½½ç‚¹ã€‚åœ¨ Kuberentes 1.11 ä»ç„¶ä»…æ”¯æŒ &lt;code&gt;local pv&lt;/code&gt; çš„ &lt;code&gt;static provision&lt;/code&gt;ï¼Œä¸æ”¯æŒ&lt;code&gt;dynamic provision&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Kubernetes ä½¿ç”¨ &lt;code&gt;PersistentVolume&lt;/code&gt; çš„ &lt;code&gt;.spec.nodeAffinityfield&lt;/code&gt; æ¥æè¿°&lt;code&gt;local volume&lt;/code&gt; ä¸ Node çš„ç»‘å®šå…³ç³»ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ &lt;code&gt;volumeBindingMode: WaitForFirstConsumer&lt;/code&gt; çš„ &lt;code&gt;local-storage StorageClass&lt;/code&gt; æ¥å®ç° PVC çš„å»¶è¿Ÿç»‘å®šï¼Œä½¿å¾— &lt;code&gt;PV Controller&lt;/code&gt; å¹¶ä¸ä¼šç«‹åˆ»ä¸º PVC åš Boundï¼Œè€Œæ˜¯ç­‰å¾…æŸä¸ªéœ€è¦ä½¿ç”¨è¯¥ &lt;code&gt;local pv&lt;/code&gt; çš„ Pod å®Œæˆè°ƒåº¦åï¼Œæ‰å»åš Boundã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸‹é¢æ˜¯å®šä¹‰local pvçš„Sampleï¼š&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; PersistentVolume&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; example-pv&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  capacity:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    storage:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;Gi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# volumeMode field requires BlockVolume Alpha feature gate to be enabled.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  volumeMode:&lt;/span&gt; Filesystem&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  accessModes:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; ReadWriteOnce&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  persistentVolumeReclaimPolicy:&lt;/span&gt; Retain&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  storageClassName:&lt;/span&gt; local-storage&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  local:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    path:&lt;/span&gt; /mnt/disks/ssd1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  nodeAffinity:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    required:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      nodeSelectorTerms:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - matchExpressions:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - key:&lt;/span&gt; kubernetes.io/hostname&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          operator:&lt;/span&gt; In&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          values:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;          -&lt;/span&gt; example-node&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯¹åº”çš„&lt;code&gt;local-storage storageClass&lt;/code&gt;å®šä¹‰å¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; StorageClass&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; storage.k8s.io/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; local-storage&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;provisioner:&lt;/span&gt; kubernetes.io/&lt;span class=&quot;literal&quot;&gt;no&lt;/span&gt;-provisioner&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;volumeBindingMode:&lt;/span&gt; WaitForFirstConsumer&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;ä½¿ç”¨local-persistent-volumeæ³¨æ„äº‹é¡¹&quot;&gt;&lt;a href=&quot;#ä½¿ç”¨local-persistent-volumeæ³¨æ„äº‹é¡¹&quot; class=&quot;headerlink&quot; title=&quot;ä½¿ç”¨local persistent volumeæ³¨æ„äº‹é¡¹&quot;&gt;&lt;/a&gt;ä½¿ç”¨local persistent volumeæ³¨æ„äº‹é¡¹&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨ &lt;code&gt;local pv&lt;/code&gt; æ—¶å¿…é¡»å®šä¹‰ &lt;code&gt;nodeAffinity&lt;/code&gt;ï¼ŒKubernetes Scheduler éœ€è¦ä½¿ç”¨PV çš„ &lt;code&gt;nodeAffinity&lt;/code&gt; æè¿°ä¿¡æ¯æ¥ä¿è¯ Pod èƒ½å¤Ÿè°ƒåº¦åˆ°æœ‰å¯¹åº” &lt;code&gt;local volume&lt;/code&gt; çš„Node ä¸Šã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;volumeMode&lt;/code&gt; å¯ä»¥æ˜¯ &lt;code&gt;FileSystemï¼ˆDefaultï¼‰&lt;/code&gt;å’Œ Blockï¼Œå¹¶ä¸”éœ€è¦ &lt;code&gt;enable BlockVolume Alpha feature gate&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;p&gt;åˆ›å»º &lt;code&gt;local PV&lt;/code&gt; ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆä¿è¯æœ‰å¯¹åº”çš„ &lt;code&gt;storageClass&lt;/code&gt; å·²ç»åˆ›å»ºã€‚å¹¶ä¸”è¯¥&lt;code&gt;storageClass&lt;/code&gt; çš„ &lt;code&gt;volumeBindingMode&lt;/code&gt; å¿…é¡»æ˜¯ &lt;code&gt;WaitForFirstConsumer&lt;/code&gt; ä»¥æ ‡è¯†å»¶è¿Ÿ &lt;code&gt;Volume Binding&lt;/code&gt; ã€‚&lt;code&gt;WaitForFirstConsumer&lt;/code&gt; å¯ä»¥ä¿è¯æ­£å¸¸çš„ Pod è°ƒåº¦è¦æ±‚ï¼ˆresource requirements, node selectors, Pod affinity, and Pod anti-affinityç­‰ï¼‰ï¼Œåˆèƒ½ä¿è¯ Pod éœ€è¦çš„ &lt;code&gt;Local PV&lt;/code&gt; çš„ &lt;code&gt;nodeAffinity&lt;/code&gt; å¾—åˆ°æ»¡è¶³ï¼Œå®é™…ä¸Šï¼Œä¸€å…±æœ‰ä»¥ä¸‹ä¸¤ç§ &lt;code&gt;volumeBindingMode&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// VolumeBindingImmediate indicates that PersistentVolumeClaims should be&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// immediately provisioned and bound.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;VolumeBindingImmediate VolumeBindingMode = &lt;span class=&quot;string&quot;&gt;&quot;Immediate&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// VolumeBindingWaitForFirstConsumer indicates that PersistentVolumeClaims&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// should not be provisioned and bound until the first Pod is created that&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// references the PeristentVolumeClaim.  The volume provisioning and&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// binding will occur during Pod scheduing.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;VolumeBindingWaitForFirstConsumer VolumeBindingMode = &lt;span class=&quot;string&quot;&gt;&quot;WaitForFirstConsumer&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;èŠ‚ç‚¹ä¸Š &lt;code&gt;local volume&lt;/code&gt; çš„åˆå§‹åŒ–éœ€è¦æˆ‘ä»¬äººä¸ºå»å®Œæˆï¼ˆæ¯”å¦‚ &lt;code&gt;local disk&lt;/code&gt; éœ€è¦ pre-partitioned, formatted, and mounted. å…±äº«å­˜å‚¨å¯¹åº”çš„ Directories ä¹Ÿéœ€è¦ pre-createdï¼‰ï¼Œå¹¶ä¸”äººå·¥åˆ›å»ºè¿™ä¸ª &lt;code&gt;local PV&lt;/code&gt;ï¼Œå½“ Pod ç»“æŸï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‰‹åŠ¨çš„æ¸…ç† &lt;code&gt;local volume&lt;/code&gt;ï¼Œç„¶åæ‰‹åŠ¨åˆ é™¤è¯¥ &lt;code&gt;local PV&lt;/code&gt; å¯¹è±¡ã€‚å› æ­¤ï¼Œ&lt;code&gt;persistentVolumeReclaimPolicy&lt;/code&gt; åªèƒ½æ˜¯ &lt;code&gt;Retain&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;local-volume-manager&quot;&gt;&lt;a href=&quot;#local-volume-manager&quot; class=&quot;headerlink&quot; title=&quot;local volume manager&quot;&gt;&lt;/a&gt;local volume manager&lt;/h2&gt;&lt;p&gt;ä¸Šé¢è¿™ä¹ˆå¤šäº‹æƒ…éœ€è¦äººä¸ºçš„å»åšé¢„å¤„ç†çš„å·¥ä½œï¼Œæˆ‘ä»¬å¿…é¡»è¦æœ‰è§£å†³æ–¹æ¡ˆå¸®æˆ‘ä»¬è‡ªåŠ¨å®Œæˆ &lt;code&gt;local volume&lt;/code&gt; çš„ create å’Œ cleanup çš„å·¥ä½œã€‚å®˜æ–¹ç»™å‡ºäº†ä¸€ä¸ªç®€å•çš„ &lt;a href=&quot;https://github.com/kubernetes-incubator/external-storage/tree/master/local-volume&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;local volume manager&lt;/a&gt; ï¼Œæ³¨æ„å®ƒä»ç„¶åªæ˜¯ä¸€ä¸ª &lt;code&gt;static provisioner&lt;/code&gt;ï¼Œç›®å‰ä¸»è¦å¸®æˆ‘ä»¬åšä¸¤ä»¶äº‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;local volume manager&lt;/code&gt; ç›‘æ§é…ç½®å¥½çš„ discovery directory çš„æ–°çš„æŒ‚è½½ç‚¹ï¼Œå¹¶ä¸ºæ¯ä¸ªæŒ‚è½½ç‚¹æ ¹æ®å¯¹åº”çš„ storageClassName, path, nodeAffinity, and capacity åˆ›å»º&lt;code&gt;PersistentVolume object&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;å½“Podç»“æŸå¹¶åˆ é™¤äº†ä½¿ç”¨ &lt;code&gt;local volume&lt;/code&gt; çš„ PVCï¼Œ&lt;code&gt;local volume manager&lt;/code&gt; å°†è‡ªåŠ¨æ¸…ç†è¯¥ local mount ä¸Šçš„æ‰€æœ‰æ–‡ä»¶, ç„¶ååˆ é™¤å¯¹åº”çš„ &lt;code&gt;PersistentVolume object&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å› æ­¤ï¼Œé™¤äº†éœ€è¦äººä¸ºçš„å®Œæˆ &lt;code&gt;local volume&lt;/code&gt; çš„ mount æ“ä½œï¼Œ&lt;code&gt;local PV&lt;/code&gt; çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å°±å…¨éƒ¨äº¤ç»™ &lt;a href=&quot;https://github.com/kubernetes-incubator/external-storage/tree/master/local-volume&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;local volume manager&lt;/a&gt; äº†ã€‚ä¸‹é¢æˆ‘ä»¬ä¸“é—¨ä»‹ç»ä¸‹è¿™ä¸ª &lt;code&gt;Static Local Volume Provisioner&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;åé¢æˆ‘ä¼šå•ç‹¬å†™ä¸€ä¸ªåšæ–‡å¯¹ &lt;a href=&quot;https://github.com/kubernetes-incubator/external-storage/tree/master/local-volume&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;local volume manager&lt;/a&gt; è¿›è¡Œæ·±åº¦å‰–æã€‚&lt;/p&gt;
&lt;h2 id=&quot;æ€»ç»“&quot;&gt;&lt;a href=&quot;#æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;æ€»ç»“&quot;&gt;&lt;/a&gt;æ€»ç»“&lt;/h2&gt;&lt;p&gt;æœ¬æ–‡å¯¹ &lt;code&gt;hostPath volume&lt;/code&gt; ä¸èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¾ˆå¥½ä½¿ç”¨çš„åŸå› è¿›è¡Œäº†é˜è¿°ï¼Œç„¶åå¯¹ &lt;code&gt;local persistent volume&lt;/code&gt; çš„ä½¿ç”¨åœºæ™¯ã€åŸºæœ¬çš„å·¥ä½œæœºåˆ¶è¿›è¡Œäº†åˆ†æï¼Œä»‹ç»äº†ä½¿ç”¨æ—¶çš„æ³¨æ„äº‹é¡¹ï¼Œæœ€åç®€å•ä»‹ç»äº† &lt;code&gt;local volume manager&lt;/code&gt; å¦‚ä½•å¸®åŠ© administrator è¿›è¡Œ &lt;code&gt;local persistent volume&lt;/code&gt; çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„ã€‚&lt;/p&gt;
&lt;p&gt;æ¥æºï¼šoschina&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;å¾®ä¿¡è®¢é˜…å·&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;å¾ˆå¤šäººå¯¹hostPath volumeå’Œlocal persistent volumeçš„ä½¿ç”¨åœºæ™¯è¿˜å­˜åœ¨å¾ˆå¤šå›°æƒ‘ã€‚ä¸‹é¢å¯¹ç€ä¸¤ç§volumeçš„ä½¿ç”¨åœºæ™¯ã€åŸºæœ¬çš„å·¥ä½œæœºåˆ¶è¿›è¡Œäº†åˆ†æï¼Œä»‹ç»äº†ä½¿ç”¨æ—¶çš„æ³¨æ„äº‹é¡¹ï¼Œå¹¶ç®€å•ä»‹ç»&lt;a href=&quot;https://github.com/kubernetes-incubator/external-storage/tree/master/local-volume&quot;&gt;local volume manager&lt;/a&gt;å¦‚ä½•å¸®åŠ©administratorè¿›è¡Œlocal persistent volumeçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;hostPath-volumeå­˜åœ¨çš„é—®é¢˜&quot;&gt;&lt;a href=&quot;#hostPath-volumeå­˜åœ¨çš„é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;hostPath volumeå­˜åœ¨çš„é—®é¢˜&quot;&gt;&lt;/a&gt;hostPath volumeå­˜åœ¨çš„é—®é¢˜&lt;/h2&gt;&lt;p&gt;è¿‡å»æˆ‘ä»¬ç»å¸¸ä¼šé€šè¿‡hostPath volumeè®©Podèƒ½å¤Ÿä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œå°†Nodeæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æˆ–è€…ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ï¼Œä½†æ˜¯hostPath volumeçš„ä½¿ç”¨æ˜¯å¾ˆéš¾å—çš„ï¼Œå¹¶ä¸é€‚åˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆçœ‹çœ‹hostPath Typeæœ‰å“ªäº›ç±»å‹ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;strong&gt;å–å€¼&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;è¡Œä¸º&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;ç©ºå­—ç¬¦ä¸²ï¼ˆé»˜è®¤ï¼‰ç”¨äºå‘åå…¼å®¹ï¼Œè¿™æ„å‘³ç€åœ¨å®‰è£… hostPath å·ä¹‹å‰ä¸ä¼šæ‰§è¡Œä»»ä½•æ£€æŸ¥ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;DirectoryOrCreate&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åœ¨ç»™å®šï¤·å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„ç›®å½•ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;FileOrCreate&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å¦‚æœåœ¨ç»™å®šè·¯å¾„ä¸Šä»€ä¹ˆéƒ½ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°†åœ¨é‚£é‡Œæ ¹æ®éœ€è¦åˆ›å»ºç©ºæ–‡ä»¶ï¼Œæƒé™è®¾ç½®ä¸º 0644ï¼Œå…·æœ‰ä¸ Kubelet ç›¸åŒçš„ç»„å’Œæ‰€æœ‰æƒã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;File&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„æ–‡ä»¶ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Socket&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„ UNIX å¥—æ¥å­—ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;CharDevice&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„å­—ç¬¦è®¾å¤‡ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;BlockDevice&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„å—è®¾å¤‡ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;çœ‹èµ·æ¥æ”¯æŒè¿™ä¹ˆå¤štypeè¿˜æ˜¯æŒºå¥½çš„ï¼Œä½†ä¸ºä»€ä¹ˆè¯´ä¸é€‚åˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å‘¢ï¼Ÿ&lt;br&gt;
    
    </summary>
    
      <category term="kubrenetes" scheme="http://team.jiunile.com/categories/kubrenetes/"/>
    
      <category term="volume" scheme="http://team.jiunile.com/categories/kubrenetes/volume/"/>
    
      <category term="pv" scheme="http://team.jiunile.com/categories/kubrenetes/volume/pv/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/tags/kubernetes/"/>
    
      <category term="local volume" scheme="http://team.jiunile.com/tags/local-volume/"/>
    
      <category term="hostpath volume" scheme="http://team.jiunile.com/tags/hostpath-volume/"/>
    
      <category term="pv" scheme="http://team.jiunile.com/tags/pv/"/>
    
  </entry>
  
  <entry>
    <title>Go Singleflightå¯¼è‡´æ­»é”é—®é¢˜åˆ†æ</title>
    <link href="http://team.jiunile.com//blog/2020/09/go-singleflight-deadlock.html"/>
    <id>http://team.jiunile.com//blog/2020/09/go-singleflight-deadlock.html</id>
    <published>2020-09-14T12:00:00.000Z</published>
    <updated>2020-09-16T05:45:23.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;æ€è·¯æ’æŸ¥&quot;&gt;&lt;a href=&quot;#æ€è·¯æ’æŸ¥&quot; class=&quot;headerlink&quot; title=&quot;æ€è·¯æ’æŸ¥&quot;&gt;&lt;/a&gt;æ€è·¯æ’æŸ¥&lt;/h2&gt;&lt;h3 id=&quot;Dump-å †æ ˆå¾ˆé‡è¦&quot;&gt;&lt;a href=&quot;#Dump-å †æ ˆå¾ˆé‡è¦&quot; class=&quot;headerlink&quot; title=&quot;Dump å †æ ˆå¾ˆé‡è¦&quot;&gt;&lt;/a&gt;Dump å †æ ˆå¾ˆé‡è¦&lt;/h3&gt;&lt;p&gt;çº¿ä¸ŠæŸä¸ªç¯å¢ƒå‘ç° S3 ä¸Šä¼ è¯·æ±‚å¡ä½ï¼Œè¯·æ±‚ä¸è¿”å›ï¼Œå¡äº†30åˆ†é’Ÿï¼Œé•¿æ—¶é—´æ²¡æœ‰å‘ç°æœ‰æ•ˆæ—¥å¿—ã€‚ä¸€èˆ¬æ¥è®²ï¼Œæ­»é”é—®é¢˜è¿˜æ˜¯å¥½æ’æŸ¥çš„ï¼Œå› ä¸ºç°åœºä¸€èˆ¬éƒ½åœ¨ã€‚ç±»ä¼¼äº c ç¨‹åºï¼Œé‡åˆ°æ­»é”é—®é¢˜éƒ½ä¼šç”¨ pstack çœ‹ä¸€æŠŠã€‚golang æ­»é”æ’æŸ¥æ€è·¯ä¹Ÿç±»ä¼¼ï¼ˆgolang ä¸é€‚åˆä½¿ç”¨ pstackï¼Œå› ä¸º golang è°ƒåº¦çš„æ˜¯åç¨‹ï¼Œpstack åªèƒ½çœ‹åˆ°çº¿ç¨‹æ ˆï¼‰ï¼Œæˆ‘ä»¬å…¶å®æ˜¯éœ€è¦çŸ¥é“ S3 ç¨‹åºé‡Œ goroutine çš„æ ˆçŠ¶æ€ã€‚golang é‡åˆ°è¿™ä¸ªé—®é¢˜æˆ‘ä»¬æœ‰ä¸¤ä¸ªåŠæ³•ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ–¹æ³•ä¸€ï¼šæ¡ä»¶å…è®¸çš„è¯ï¼Œgcore å‡ºä¸€ä¸ªå †æ ˆï¼Œè¿™ä¸ªæ˜¯æœ€æœ‰æ•ˆçš„æ–¹æ³•ï¼Œå› ä¸ºæ˜¯æŠŠæ•´ä¸ª golang ç¨‹åºçš„å†…å­˜é•œåƒ dump å‡ºæ¥ï¼Œç„¶åç”¨ dlv åˆ†æ&lt;/li&gt;
&lt;li&gt;æ–¹æ³•äºŒï¼šå¦‚æœä½ æå‰å¼€å¯ net/pprof åº“çš„å¼•ç”¨ï¼Œå¼€å¯äº† debug æ¥å£ï¼Œé‚£ä¹ˆå°±å¯ä»¥è°ƒç”¨ curl æ¥å£ï¼Œé€šè¿‡ http æ¥å£è·å–è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;éœ€è¦æ³¨æ„åˆ°ï¼Œgolang ç¨‹åºå’Œ c ç¨‹åºè¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«ï¼Œgoroutine éå¸¸å¤šï¼Œæˆç™¾ä¸Šåƒä¸ª goroutine æ˜¯å¸¸æ€ï¼Œç”šè‡³ä¸Šä¸‡ä¸ªä¹Ÿä¸ç¨€å¥‡ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬æ— æ³•åœ¨ç»ˆç«¯ä¸Šç›´æ¥çœ‹å®Œæ‰€æœ‰çš„æ ˆï¼Œä¸€èˆ¬éƒ½æ˜¯æŠŠæ‰€æœ‰çš„ goroutine æ ˆ dump åˆ°æ–‡ä»¶ï¼Œç„¶ç”¨ vi æ‰“å¼€æ…¢æ…¢åˆ†æã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è°ƒè¯•è¿™ä¸ª core æ–‡ä»¶ï¼Œæ„å›¾ä»å †æ ˆé‡Œæ‰¾åˆ°äº›ä¸œè¥¿ï¼Œç”±äºå †æ ˆå¤ªå¤šäº†ï¼Œæ‰€ä»¥å°±ä½¿ç”¨ &lt;code&gt;gorouties -t -u&lt;/code&gt; è¿™ä¸ªå‘½ä»¤ï¼Œå¹¶ä¸”æŠŠè¾“å‡º dump åˆ°æ–‡ä»¶ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;curl xxx/debug/pprof/goroutine&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;å…³é”®æ€è·¯&quot;&gt;&lt;a href=&quot;#å…³é”®æ€è·¯&quot; class=&quot;headerlink&quot; title=&quot;å…³é”®æ€è·¯&quot;&gt;&lt;/a&gt;å…³é”®æ€è·¯&lt;/h3&gt;&lt;p&gt;æˆåƒä¸Šä¸‡ä¸ª goroutine ï¼Œç›´æ¥æ˜¾ç¤ºåˆ°ç»ˆç«¯æ˜¯ä¸åˆé€‚çš„ï¼Œæˆ‘ä»¬ dump åˆ°æ–‡ä»¶ test.txtï¼Œç„¶ååˆ†æ test.txt è¿™ä¸ªæ–‡ä»¶ã€‚&lt;strong&gt;å»æŸ¥æ‰¾å‘ç°äº†ä¸€äº›å¯ç–‘å †æ ˆï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯å¯ç–‘å †æ ˆï¼Ÿé‡ç‚¹å…³æ³¨åŠ é”ç­‰å¾…çš„å †æ ˆï¼Œå…³é”®å­—æ˜¯ &lt;code&gt;runtime_notifyListWait&lt;/code&gt; ã€&lt;code&gt;semaphore&lt;/code&gt; ã€&lt;code&gt;sync.(*Cond).Wait&lt;/code&gt; ã€&lt;code&gt;Acquire&lt;/code&gt;  è¿™äº›é˜»å¡åœºæ™¯æ‰ä¼šç”¨åˆ°çš„ï¼Œå¦‚æœä¸šåŠ¡å †æ ˆä¸Šå‡ºç°è¿™ä¸ªåŠ é”è°ƒç”¨ï¼Œå°±éå¸¸å¯ç–‘&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åˆ’é‡ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ç•™æ„é˜»å¡å…³é”®å­— &lt;code&gt;runtime_notifyListWait&lt;/code&gt; ã€&lt;code&gt;semaphore&lt;/code&gt; ã€&lt;code&gt;sync.(*Cond).Wait&lt;/code&gt; ã€&lt;code&gt;Acquire&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;ä¸šåŠ¡å †æ ˆï¼ˆé runtime çš„ä¸€äº›å†…éƒ¨å †æ ˆï¼‰&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;/images/go/singleflight01.png&quot; alt=&quot;singleflight-heap&quot;&gt;&lt;/p&gt;
&lt;p&gt;ç»Ÿè®¡åˆ†æå‘ç°ï¼Œæœ‰ 11 ä¸ªè¿™ä¸ªå †æ ˆéƒ½åœ¨è¿™åŒä¸€ä¸ªåœ°æ–¹ï¼Œéƒ½æ˜¯åœ¨ç­‰åŒä¸€æŠŠé” &lt;code&gt;blockingKeyCountLimit.lock&lt;/code&gt;ï¼Œæ‰€ä»¥åŸºæœ¬ç¡®è®¤äº†é˜»å¡çš„ä½ç½®ï¼Œå°±æ˜¯è¿™ä¸ªåœ°æ–¹é˜»å¡åˆ°äº†æ‰€æœ‰çš„è¯·æ±‚ï¼Œä½†æ˜¯è¿™æŠŠé”æˆ‘ä»¬ä½¿ç”¨ defer é‡Šæ”¾çš„ï¼Œä½¿ç”¨å§¿åŠ¿å¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// do someting&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;lock.Acquire(key)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; lock.Release(key)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// ä»¥ä¸‹ä¸ºé”å†…æ“ä½œï¼›&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;blockingKeyCountLimit æ˜¯æˆ‘ä»¬å°è£…é’ˆå¯¹ key æ“ä½œæµæ§çš„ç»„ä»¶ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœ limit == 1ï¼Œkeyä¸º â€œtestâ€ åœ¨ g1 ä¸Š Acquire æˆåŠŸï¼Œg2 acquire(â€œtestâ€) å°±ä¼šç­‰å¾…ï¼Œè¿™ä¸ªå¯ä»¥ç®—æ˜¯æˆ‘ä»¬ä¼˜åŒ–çš„ä¸€ä¸ªé€»è¾‘ã€‚å¦‚æœ limit == 2ï¼Œé‚£ä¹ˆå°±å…è®¸ä¸¤ä¸ªäººåŠ é”åˆ°ï¼Œåé¢çš„äººéƒ½ç­‰å¾…ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä»ä»£ç æ¥çœ‹ï¼Œå‡½æ•°é€€å‡ºä¸€å®šä¼šé‡Šæ”¾çš„ï¼Œä½†æ˜¯ååç°åœ¨é”å°±å¡åœ¨è¿™ä¸ªåœ°æ–¹ï¼Œæ‰€ä»¥å°±éå¸¸å¥‡æ€ªã€‚æˆ‘ä»¬å…ˆæ‰¾å“ªä¸ª goroutine å ç€è¿™æŠŠé”ä¸é‡Šæ”¾ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½ææ¸…æ¥šæ€æ ·å¯¼è‡´è¿™é‡ŒæŠ¢ä¸åˆ°é”çš„åŸå› ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡å®¡æŸ¥ä¸šåŠ¡ä»£ç åˆ†æï¼Œå‘ç°å¯èƒ½çš„æºå¤´å‡½æ•°ï¼ˆè¿™ä¸ªå‡½æ•°æ˜¯å‘åç«¯è¯·æ±‚çš„å‡½æ•°ï¼‰ï¼š&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;api.(*Client).getBytesNolc&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç¡®è®¤æ˜¯ &lt;code&gt;getBytesNolc&lt;/code&gt; è¿™ä¸ªå‡½æ•°æ‰§è¡Œçš„æ“ä½œï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡å°±æ˜¯å¡åœ¨è¿™ä¸ªåœ°æ–¹äº†ã€‚ç”¨è¿™ä¸ª &lt;code&gt;getBytesNolc&lt;/code&gt; å­—ç¬¦ä¸²æœç´¢å †æ ˆï¼Œæ‰¾ä¸‹æ˜¯å“ªä¸ªå †æ ˆ ï¼Ÿæœç´¢åˆ°è¿™ä¸ªå †æ ˆ &lt;code&gt;goroutine 19458&lt;/code&gt;&lt;br&gt;&lt;img src=&quot;/images/go/singleflight02.png&quot; alt=&quot;singleflight-heap&quot;&gt;&lt;/p&gt;
&lt;p&gt;å¤§æ¦‚ç‡å°±æ˜¯ç¬¬ 1 ä¸ªå †æ ˆäº†ï¼Œä¹Ÿå°±æ˜¯å…¶ä»–çš„ 11 ä¸ª goroutine éƒ½åœ¨ç­‰è¿™ &lt;code&gt;goroutine 19458&lt;/code&gt;  æ¥æ”¾é”ï¼Œä»”ç»†çœ‹è¿™ä¸ªå †æ ˆã€‚é‚£ä¹ˆä¸ºå•¥è¿™ä¸ªå †æ ˆä¸æ”¾é”å‘¢ï¼Ÿè¿™é‡Œæœ‰ä¸ªç»†èŠ‚è¦æ³¨æ„ä¸‹ï¼Œè¿™é‡Œæ˜¯å¡åˆ° &lt;code&gt;gihub.com/golang/groupcache/singleflight/singleflight.go:48&lt;/code&gt; è¿™ä¸€è¡Œï¼š&lt;br&gt;&lt;img src=&quot;/images/go/singleflight03.png&quot; alt=&quot;singleflight&quot;&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ˜¯ä¸€ä¸ªå¼€æºåº“ï¼Œsingleflight å®ç°äº†ç¼“å­˜é˜²å‡»ç©¿çš„åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ç®€å•ä»‹ç»ä¸‹ &lt;code&gt;singleflight&lt;/code&gt; çš„åŠŸèƒ½ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ•ˆçš„å·¥å…·ã€‚åœ¨ç¼“å­˜å¤§é‡å¤±æ•ˆçš„åœºæ™¯ï¼Œå¦‚æœé’ˆå¯¹åŒä¸€ä¸ª key ï¼Œå…¶å®åªéœ€è¦æœ‰ä¸€ä¸ªäººç©¿é€åˆ°åç«¯è¯·æ±‚æ•°æ®ï¼Œå…¶ä»–äººç­‰å¾…ä»–å®Œæˆï¼Œç„¶åå–ç¼“å­˜ç»“æœå³å¯ã€‚è¿™ä¸ªå°±æ˜¯ &lt;code&gt;singleflight&lt;/code&gt; å®ç°çš„åŠŸèƒ½ã€‚å…·ä½“å®ç°å°±æ˜¯ï¼šæ¥äº†è¯·æ±‚ä¹‹åï¼ŒæŠŠ key æ’å…¥åˆ° map é‡Œï¼Œåé¢çš„è¯·æ±‚å¦‚æœå‘ç°åŒå key åœ¨ map é‡Œé¢ï¼Œé‚£ä¹ˆå°±ç­‰å¾…å®ƒå®Œæˆå°±å¥½ï¼›&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æˆªå±æ˜¾ç¤ºå¡åˆ° &lt;code&gt;c.wg.Wait()&lt;/code&gt; è¿™ä¸€è¡Œï¼Œé‚£ä¹ˆè¯´æ˜ map é‡Œé¢è‚¯å®šæœ‰å·²ç»å­˜åœ¨çš„ keyï¼Œè¯´æ˜ &lt;code&gt;goroutine 19458&lt;/code&gt; ä¸æ˜¯ç¬¬ä¸€ä¸ªäººï¼Ÿä½†æ˜¯å¤–é¢è¿˜æœ‰ä¸€ä¸ª &lt;code&gt;blockingKeyCountLimit&lt;/code&gt; çš„äº’æ–¥å‘¢ï¼ŒæŒ‰é“ç†å…¶ä»–çš„äººä¹Ÿè¿›ä¸æ¥ï¼ˆå› ä¸º limit == 1ï¼‰ï¼Œè¿™é‡Œè¿™ä¹ˆè®²æ¥è‚¯å®šè¦æ˜¯æºå¤´æ‰å¯¹ï¼Ÿ&lt;/p&gt;
&lt;h3 id=&quot;æ€è·¯æ•´ç†&quot;&gt;&lt;a href=&quot;#æ€è·¯æ•´ç†&quot; class=&quot;headerlink&quot; title=&quot;æ€è·¯æ•´ç†&quot;&gt;&lt;/a&gt;æ€è·¯æ•´ç†&lt;/h3&gt;&lt;p&gt;ä¼ªä»£ç æ˜¾ç¤ºå¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;xxx&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// å¤§éƒ¨åˆ†åç¨‹éƒ½å¡åœ¨è¿™é‡Œï¼ˆ11ä¸ªï¼‰&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// è¿™ä¸ªé”çš„æ•ˆæœä¸»è¦æ˜¯æµæ§ï¼Œlimit å€¼åˆå§‹åŒ–èµ‹å€¼ï¼Œå¯ä»¥æ˜¯ 1ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ï¼›&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// locker ä¸º blockingKeyCountLimit ç±»å‹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    limitLocker.Acquire( key )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; limitLocker.Release( key )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// è·å–æ•°æ®&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    getBytesNolc( key , ...)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;getBytesNolc&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ä¸‹é¢å°±æ˜¯ singleflight.Group çš„ç”¨æ³•ï¼Œé˜²ç©¿é€&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// åŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªäººå»åç«¯æ›´æ–°&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ret, err = x.Group.Do(id, &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt;&amp;#123;&amp;#125;, error)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// å»æœåŠ¡åå°è·å–ï¼Œæ›´æ–°æ•°æ®ï¼›&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å›¾ç¤ºæ˜¾ç¤ºå½“å‰çš„ç°çŠ¶ï¼š&lt;br&gt;&lt;img src=&quot;/images/go/singleflight04.png&quot; alt=&quot;singleflight&quot;&gt;&lt;/p&gt;
&lt;p&gt;ç°çŠ¶å°ç»“ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å¤§é‡çš„åç¨‹éƒ½åœ¨ç­‰ &lt;code&gt;blockingKeyCountLimit&lt;/code&gt; è¿™æŠŠé”é‡Šæ”¾ï¼›&lt;/li&gt;
&lt;li&gt;åç¨‹ &lt;code&gt;goroutine 19458&lt;/code&gt; æŒæœ‰ &lt;code&gt;blockingKeyCountLimit&lt;/code&gt; è¿™æŠŠé”ï¼›&lt;/li&gt;
&lt;li&gt;åç¨‹ &lt;code&gt;goroutine 19458&lt;/code&gt;  å´åœ¨ç­‰ä¸€ä¸ªç›¸åŒ key åå­—çš„ä»»åŠ¡çš„å®Œæˆï¼ˆ &lt;code&gt;singleflight&lt;/code&gt; ä¸€ä¸ªé˜²å‡»ç©¿çš„åº“ï¼ŒåŒä¸€æ—¶é—´ç›¸åŒ key åªå…è®¸æ”¾åˆ°ä¸€ä¸ªåç«¯å»æ‰§è¡Œï¼‰ï¼Œå´æ°¸è¿œæ²¡ç­‰åˆ°ï¼Œåç¨‹å› æ­¤å‘ˆç°æ­»é”ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å½“å‰çš„ç–‘é—®å°±æ˜¯ç¬¬ä¸€ä¸ª key çš„ä»»åŠ¡ä¸ºå•¥æ°¸è¿œå®Œä¸æˆï¼Œå †æ ˆä¹Ÿæ‰¾ä¸åˆ°äº†ï¼Œå»å“ªé‡Œäº†ï¼Ÿ&lt;/p&gt;
&lt;h3 id=&quot;å‘ç°è››ä¸é©¬è¿¹&quot;&gt;&lt;a href=&quot;#å‘ç°è››ä¸é©¬è¿¹&quot; class=&quot;headerlink&quot; title=&quot;å‘ç°è››ä¸é©¬è¿¹&quot;&gt;&lt;/a&gt;å‘ç°è››ä¸é©¬è¿¹&lt;/h3&gt;&lt;p&gt;æˆ‘ä»¬å†ä»”ç»†å®¡ä¸€ä¸‹ &lt;code&gt;singleflight&lt;/code&gt; çš„ä»£ç ï¼š&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(g *Group)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Do&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(key &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;, fn &lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;()&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt;&amp;#123;&amp;#125;, error)&lt;/span&gt;) &lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt;&amp;#123;&amp;#125;, error)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    g.mu.Lock()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; g.m == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        g.m = &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;map&lt;/span&gt;[&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;]*call)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// å¦‚æœæ‰¾åˆ°åŒå key å·²ç»å­˜åœ¨ï¼›&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; c, ok := g.m[key]; ok &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        g.mu.Unlock()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// ç­‰å¾…è€…èµ°åˆ°è¿™ä¸ªåˆ†æ”¯ï¼šç­‰å¾…ç¬¬ä¸€ä¸ªäººæ‰§è¡Œå®Œæˆï¼Œæœ€åç›´æ¥è¿”å›å®ƒçš„ç»“æœå°±è¡Œäº†ï¼›&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        c.wg.Wait()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; c.val, c.err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// å¦‚æœåŒå key ä¸å­˜åœ¨ï¼ˆç¬¬ä¸€ä¸ªäººèµ°åˆ°è¿™ä¸ªåˆ†æ”¯ï¼‰&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    c := &lt;span class=&quot;built_in&quot;&gt;new&lt;/span&gt;(call)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    c.wg.Add(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// map é‡Œæ”¾ç½® key&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    g.m[key] = c&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    g.mu.Unlock()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// æ‰§è¡Œä»»åŠ¡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    c.val, c.err = fn()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// å”¤é†’æ‰€æœ‰çš„ç­‰å¾…è€…&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    c.wg.Done()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    g.mu.Lock()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// åˆ é™¤ map é‡Œçš„ key&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;delete&lt;/span&gt;(g.m, key)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    g.mu.Unlock()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; c.val, c.err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å‘ç°æœ‰ä¸ªçº¿ç´¢ï¼Œæˆ‘ä»¬çš„ S3 æœåŠ¡ç¨‹åºä¸€ä¸ª http è¯·æ±‚å¯¹åº”ä¸€ä¸ªåç¨‹å¤„ç†ï¼Œä¸ºäº†æé«˜æœåŠ¡ç«¯è¿›ç¨‹çš„å¯ç”¨æ€§ï¼Œåœ¨æ¡†æ¶é‡Œä¼šæ•æ‰ &lt;code&gt;panic&lt;/code&gt;ï¼Œè¿™æ ·ç¡®ä¿å•ä¸ªåç¨‹å¤„ç†ä¸ä¼šå½±å“åˆ°å…¶ä»–çš„è¯·æ±‚ã€‚åŸºäºè¿™ä¸ªå‰æï¼Œæˆ‘ä»¬å‡è®¾ï¼šå¦‚æœ &lt;code&gt;fn()&lt;/code&gt; æ‰§è¡Œå¼‚å¸¸ï¼Œ&lt;code&gt;panic&lt;/code&gt; æ‰äº†ï¼Œé‚£ä¹ˆå°±ä¸ä¼šèµ° &lt;code&gt;delete(g.m, key)&lt;/code&gt; çš„ä»£ç ï¼Œé‚£ä¹ˆ key å°±æ°¸è¿œéƒ½æ®‹ç•™åœ¨ map é‡Œé¢ï¼Œè€Œè¿›ç¨‹å´åˆè¿˜æ´»ç€ã€‚æç„¶å¤§æ‚Ÿã€‚&lt;/p&gt;
&lt;h3 id=&quot;å®Œæ•´çš„æ¨ç†æµç¨‹&quot;&gt;&lt;a href=&quot;#å®Œæ•´çš„æ¨ç†æµç¨‹&quot; class=&quot;headerlink&quot; title=&quot;å®Œæ•´çš„æ¨ç†æµç¨‹&quot;&gt;&lt;/a&gt;å®Œæ•´çš„æ¨ç†æµç¨‹&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;ç¬¬ä¸€ä¸ªåç¨‹ g1 æ¥äº†ï¼ŒåŠ äº† &lt;code&gt;blockingKeyCountLimit&lt;/code&gt; é”ï¼Œç„¶åå‡†å¤‡ç©¿é€åˆ°åç«¯ï¼Œè°ƒç”¨å‡½æ•° &lt;code&gt;getBytesNolc&lt;/code&gt; è·å–æ•°æ®ï¼Œå¹¶èµ°è¿›äº† &lt;code&gt;singlelight&lt;/code&gt; ï¼Œæ·»åŠ äº†ä¸€ä¸ª keyï¼šxï¼Œ å‡†å¤‡å¹²æ´»ï¼›&lt;ol&gt;
&lt;li&gt;å¹²æ´»å‘ç”Ÿäº†ä¸€äº›ä¸å¯é¢„æœŸçš„å¼‚å¸¸ï¼ˆåé¢å‘ç°æ˜¯é…ç½®çš„å¼‚å¸¸ï¼‰ï¼Œnil æŒ‡é’ˆå¼•ç”¨ä¹‹ç±»çš„ï¼Œ &lt;code&gt;panic&lt;/code&gt; å †æ ˆäº†ï¼Œ&lt;code&gt;panic&lt;/code&gt; å¯¼è‡´åé¢ &lt;code&gt;delete key&lt;/code&gt; æ“ä½œæ²¡æœ‰æ‰§è¡Œ&lt;/li&gt;
&lt;li&gt;è™½ç„¶ g1 ç°åœ¨ &lt;code&gt;panic&lt;/code&gt; äº†ï¼Œä½†æ˜¯ç”±äºåœ¨å‡½æ•° &lt;code&gt;func xxx&lt;/code&gt; é‡Œé¢ &lt;code&gt;blockingKeyCountLimit&lt;/code&gt; æ˜¯ defer æ‰§è¡Œçš„ï¼Œæ‰€ä»¥è¿™æŠŠé”è¿˜æ˜¯ï¼Œä½†æ˜¯ &lt;code&gt;singlelight&lt;/code&gt; çš„ key è¿˜å­˜åœ¨ï¼Œäºæ˜¯æ®‹ç•™åœ¨ map é‡Œé¢&lt;/li&gt;
&lt;li&gt;ä½†æ˜¯ç”±äºæˆ‘ä»¬æœåŠ¡ç¨‹åºä¸ºäº†é«˜å¯ç”¨æ˜¯ &lt;code&gt;recover&lt;/code&gt; äº† &lt;code&gt;panic&lt;/code&gt; çš„ï¼Œå•ä¸ªè¯·æ±‚çš„å¤±è´¥ä¸ä¼šå¯¼è‡´æ•´ä¸ªè¿›ç¨‹æŒ‚æ‰ï¼Œæ‰€ä»¥è¿›ç¨‹è¿˜æ˜¯å¥½å¥½çš„&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;ç¬¬äºŒä¸ª &lt;code&gt;goroutine 19458&lt;/code&gt; åç¨‹æ¥äº†ï¼Œ&lt;code&gt;blockingKeyCountLimit&lt;/code&gt; åŠ é”ï¼Œç„¶åèµ°åˆ° &lt;code&gt;singlelight&lt;/code&gt; çš„æ—¶å€™ï¼Œå‘ç°æœ‰ &lt;code&gt;key: x&lt;/code&gt; äº†ï¼Œäºæ˜¯å°±ç­‰å¾…&lt;ol&gt;
&lt;li&gt;å¹¶ä¸”ç­‰å¾…çš„æ˜¯ä¸€ä¸ªæ°¸è¿œå¾—ä¸åˆ°çš„é”ï¼Œå› ä¸º g1 æ—©å°±æ²¡äº†ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;åç»­çš„ 11 ä¸ª åç¨‹æ¥äº†ï¼Œäºæ˜¯è¢« &lt;code&gt;blockingKeyCountLimit&lt;/code&gt; é˜»å¡ä½ï¼Œå¹¶ä¸”æ°¸è¿œä¸èƒ½é‡Šæ”¾&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å®é”¤ï¼šåç»­åŸºäºè¿™ä¸ªçŒœæƒ³ï¼Œå†å»æœç´¢ä¸€éæ—¥å¿—ï¼Œå‘ç°ç¡®å®æ˜¯æœ‰ä¸€æ¡ panic ç›¸å…³çš„æ—¥å¿—ã€‚è¿™ä¸ªæ—¶é—´ç‚¹åé¢çš„è¯·æ±‚å…¨éƒ¨è¢«å¡ä½ã€‚&lt;/p&gt;
&lt;h2 id=&quot;æ€è€ƒæ€»ç»“&quot;&gt;&lt;a href=&quot;#æ€è€ƒæ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;æ€è€ƒæ€»ç»“&quot;&gt;&lt;/a&gt;æ€è€ƒæ€»ç»“&lt;/h2&gt;&lt;p&gt;ä¸€èˆ¬æ¥è®² c è¯­è¨€å†™ç¨‹åºå®¹æ˜“å‡ºç°æ­»é”é—®é¢˜ï¼Œå› ä¸ºå„ç§å¼‚å¸¸é€»è¾‘å¯èƒ½ä¼šå¯¼è‡´å¿˜è®°æ”¾é”ï¼Œä»è€Œå¯¼è‡´æŠ¢ä¸€ä¸ªæ°¸è¿œéƒ½ä¸å¯èƒ½å¾—åˆ°çš„é”ã€‚&lt;strong&gt;golang ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€èˆ¬æ˜¯ç”¨ defer æœºåˆ¶æ¥å®ç°ï¼Œä½¿ç”¨å§¿åŠ¿å¦‚ä¸‹&lt;/strong&gt;ï¼š&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    mtx.Lock()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; mtx.Unlock()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/* ä¸´ç•ŒåŒº */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;golang çš„ defer æœºåˆ¶æ˜¯ä¸€ä¸ªç»è¿‡ç»éªŒæ²‰æ·€ä¸‹æ¥çš„æœ‰æ•ˆåŠŸèƒ½&lt;/strong&gt;ã€‚æˆ‘ä»¬å¿…é¡»è¦åˆç†ä½¿ç”¨ã€‚defer å®ç°åŸç†æ˜¯å’Œæ‰€åœ¨å‡½æ•°ç»‘å®šï¼Œä¿è¯å‡½æ•° return çš„æ—¶å€™ä¸€å®šèƒ½è°ƒç”¨åˆ°ï¼ˆ panic é€€å‡ºä¹Ÿèƒ½ï¼‰ï¼Œæ‰€ä»¥ golang åŠ é”æ”¾é”çš„æœ‰æ•ˆå®è·µæ˜¯å†™åœ¨ç›¸é‚»çš„ä¸¤è¡Œã€‚&lt;/p&gt;
&lt;p&gt;å…¶å®æ€è€ƒä¸‹ï¼Œ&lt;strong&gt;&lt;code&gt;singleflight&lt;/code&gt; ä½œä¸ºä¸€ä¸ªé€šç”¨å¼€æºåº“ï¼Œå…¶å®å¯ä»¥æŠŠ &lt;code&gt;delete map key&lt;/code&gt; æ”¾åˆ° defer é‡Œï¼Œè¿™æ ·å°±èƒ½ä¿è¯ map é‡Œé¢çš„ key ä¸€å®šæ˜¯å¯ä»¥è¢«æ¸…ç†çš„&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;è¿˜æœ‰ä¸€ç‚¹ï¼Œ&lt;strong&gt;å…¶å® golang æ˜¯ä¸æå€¡å¼‚å¸¸-æ•æ‰è¿™æ ·çš„æ–¹å¼ç¼–ç¨‹&lt;/strong&gt;ï¼Œ&lt;code&gt;panic&lt;/code&gt; ä¸€èˆ¬ä¸è®©éšä¾¿ç”¨ï¼Œå¦‚æœçœŸæ˜¯ä¸¥é‡çš„é—®é¢˜ï¼ŒæŒ‚æ‰å°±æŒ‚æ‰ï¼Œè¿™ä¸ªä¼°è®¡è¿˜å¥½ä¸€äº›ã€‚å½“ç„¶è¿™æ˜¯è¦çœ‹åœºæ™¯çš„ï¼Œè¿˜æ˜¯æœ‰ä¸€äº›ç‰¹æ®Šåœºæ™¯çš„ï¼Œæ¯•ç«Ÿ golang éƒ½å·²ç»æä¾›äº† &lt;code&gt;panic-recover&lt;/code&gt; è¿™æ ·çš„ä¸€ä¸ªæ‰‹æ®µï¼Œå°±è¯´æ˜è¿˜æ˜¯æœ‰éœ€æ±‚ã€‚è¿™ä¸ªå°±è·Ÿ unsafe åº“ä¸€æ ·ï¼Œä½ åªæœ‰æ˜ç¡®çŸ¥é“è‡ªå·±çš„è¡Œä¸ºå½±å“ï¼Œæ‰å»ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œå¦åˆ™åˆ«ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;æ¥æºï¼šå¥‡ä¼¢äº‘å­˜å‚¨&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;å¾®ä¿¡è®¢é˜…å·&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;æ€è·¯æ’æŸ¥&quot;&gt;&lt;a href=&quot;#æ€è·¯æ’æŸ¥&quot; class=&quot;headerlink&quot; title=&quot;æ€è·¯æ’æŸ¥&quot;&gt;&lt;/a&gt;æ€è·¯æ’æŸ¥&lt;/h2&gt;&lt;h3 id=&quot;Dump-å †æ ˆå¾ˆé‡è¦&quot;&gt;&lt;a href=&quot;#Dump-å †æ ˆå¾ˆé‡è¦&quot; class=&quot;headerlink&quot; title=&quot;Dump å †æ ˆå¾ˆé‡è¦&quot;&gt;&lt;/a&gt;Dump å †æ ˆå¾ˆé‡è¦&lt;/h3&gt;&lt;p&gt;çº¿ä¸ŠæŸä¸ªç¯å¢ƒå‘ç° S3 ä¸Šä¼ è¯·æ±‚å¡ä½ï¼Œè¯·æ±‚ä¸è¿”å›ï¼Œå¡äº†30åˆ†é’Ÿï¼Œé•¿æ—¶é—´æ²¡æœ‰å‘ç°æœ‰æ•ˆæ—¥å¿—ã€‚ä¸€èˆ¬æ¥è®²ï¼Œæ­»é”é—®é¢˜è¿˜æ˜¯å¥½æ’æŸ¥çš„ï¼Œå› ä¸ºç°åœºä¸€èˆ¬éƒ½åœ¨ã€‚ç±»ä¼¼äº c ç¨‹åºï¼Œé‡åˆ°æ­»é”é—®é¢˜éƒ½ä¼šç”¨ pstack çœ‹ä¸€æŠŠã€‚golang æ­»é”æ’æŸ¥æ€è·¯ä¹Ÿç±»ä¼¼ï¼ˆgolang ä¸é€‚åˆä½¿ç”¨ pstackï¼Œå› ä¸º golang è°ƒåº¦çš„æ˜¯åç¨‹ï¼Œpstack åªèƒ½çœ‹åˆ°çº¿ç¨‹æ ˆï¼‰ï¼Œæˆ‘ä»¬å…¶å®æ˜¯éœ€è¦çŸ¥é“ S3 ç¨‹åºé‡Œ goroutine çš„æ ˆçŠ¶æ€ã€‚golang é‡åˆ°è¿™ä¸ªé—®é¢˜æˆ‘ä»¬æœ‰ä¸¤ä¸ªåŠæ³•ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ–¹æ³•ä¸€ï¼šæ¡ä»¶å…è®¸çš„è¯ï¼Œgcore å‡ºä¸€ä¸ªå †æ ˆï¼Œè¿™ä¸ªæ˜¯æœ€æœ‰æ•ˆçš„æ–¹æ³•ï¼Œå› ä¸ºæ˜¯æŠŠæ•´ä¸ª golang ç¨‹åºçš„å†…å­˜é•œåƒ dump å‡ºæ¥ï¼Œç„¶åç”¨ dlv åˆ†æ&lt;/li&gt;
&lt;li&gt;æ–¹æ³•äºŒï¼šå¦‚æœä½ æå‰å¼€å¯ net/pprof åº“çš„å¼•ç”¨ï¼Œå¼€å¯äº† debug æ¥å£ï¼Œé‚£ä¹ˆå°±å¯ä»¥è°ƒç”¨ curl æ¥å£ï¼Œé€šè¿‡ http æ¥å£è·å–è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;éœ€è¦æ³¨æ„åˆ°ï¼Œgolang ç¨‹åºå’Œ c ç¨‹åºè¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«ï¼Œgoroutine éå¸¸å¤šï¼Œæˆç™¾ä¸Šåƒä¸ª goroutine æ˜¯å¸¸æ€ï¼Œç”šè‡³ä¸Šä¸‡ä¸ªä¹Ÿä¸ç¨€å¥‡ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬æ— æ³•åœ¨ç»ˆç«¯ä¸Šç›´æ¥çœ‹å®Œæ‰€æœ‰çš„æ ˆï¼Œä¸€èˆ¬éƒ½æ˜¯æŠŠæ‰€æœ‰çš„ goroutine æ ˆ dump åˆ°æ–‡ä»¶ï¼Œç„¶ç”¨ vi æ‰“å¼€æ…¢æ…¢åˆ†æã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è°ƒè¯•è¿™ä¸ª core æ–‡ä»¶ï¼Œæ„å›¾ä»å †æ ˆé‡Œæ‰¾åˆ°äº›ä¸œè¥¿ï¼Œç”±äºå †æ ˆå¤ªå¤šäº†ï¼Œæ‰€ä»¥å°±ä½¿ç”¨ &lt;code&gt;gorouties -t -u&lt;/code&gt; è¿™ä¸ªå‘½ä»¤ï¼Œå¹¶ä¸”æŠŠè¾“å‡º dump åˆ°æ–‡ä»¶ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;curl xxx/debug/pprof/goroutine&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="go" scheme="http://team.jiunile.com/categories/go/"/>
    
      <category term="singleflight" scheme="http://team.jiunile.com/categories/go/singleflight/"/>
    
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="singleflight" scheme="http://team.jiunile.com/tags/singleflight/"/>
    
      <category term="æ­»é”" scheme="http://team.jiunile.com/tags/%E6%AD%BB%E9%94%81/"/>
    
  </entry>
  
  <entry>
    <title>Istio å®æˆ˜ç³»åˆ—(1) - åº”ç”¨å®¹å™¨å¯¹ Envoy Sidecar çš„å¯åŠ¨ä¾èµ–é—®é¢˜</title>
    <link href="http://team.jiunile.com//blog/2020/09/istio-depend-sidecar.html"/>
    <id>http://team.jiunile.com//blog/2020/09/istio-depend-sidecar.html</id>
    <published>2020-09-10T12:00:00.000Z</published>
    <updated>2020-09-10T03:14:14.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;æ•…éšœç°è±¡&quot;&gt;&lt;a href=&quot;#æ•…éšœç°è±¡&quot; class=&quot;headerlink&quot; title=&quot;æ•…éšœç°è±¡&quot;&gt;&lt;/a&gt;æ•…éšœç°è±¡&lt;/h2&gt;&lt;p&gt;å…¸å‹æ¡ˆä¾‹ï¼šæŸè¿ç»´åŒå­¦åé¦ˆï¼šæ˜¨å¤©æ™šä¸Š &lt;code&gt;Istio&lt;/code&gt; ç¯å¢ƒä¸­åº”ç”¨çš„å¿ƒè·³æ£€æµ‹æŠ¥ &lt;code&gt;connect reset&lt;/code&gt;ï¼Œç„¶åæœåŠ¡é‡å¯äº†ã€‚æ€€ç–‘æ˜¯ &lt;code&gt;Istio&lt;/code&gt; ç¯å¢ƒä¸­ç½‘ç»œä¸ç¨³å®šå¯¼è‡´äº†æœåŠ¡é‡å¯ã€‚&lt;/p&gt;
&lt;p&gt;è¯¥é—®é¢˜çš„è¡¨ç°æ˜¯å®‰è£…äº† &lt;code&gt;sidecar proxy&lt;/code&gt; çš„åº”ç”¨ï¼Œåœ¨å¯åŠ¨åçš„ä¸€å°æ®µæ—¶é—´å†…æ— æ³•é€šè¿‡ç½‘ç»œè®¿é—® pod å¤–éƒ¨çš„å…¶ä»–æœåŠ¡ï¼Œä¾‹å¦‚å¤–éƒ¨çš„ HTTPï¼ŒMySQLï¼ŒRedisç­‰æœåŠ¡ã€‚å¦‚æœåº”ç”¨æ²¡æœ‰å¯¹ä¾èµ–æœåŠ¡çš„å¼‚å¸¸è¿›è¡Œå®¹é”™å¤„ç†ï¼Œè¯¥é—®é¢˜è¿˜å¸¸å¸¸ä¼šå¯¼è‡´åº”ç”¨å¯åŠ¨å¤±è´¥ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬ä»¥è¯¥é—®é¢˜å¯¼è‡´çš„ä¸€ä¸ªå…¸å‹æ•…éšœçš„åˆ†æè¿‡ç¨‹ä¸ºä¾‹ï¼Œå¯¹è¯¥é—®é¢˜çš„åŸå› è¿›è¡Œè¯´æ˜ã€‚&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;æ•…éšœåˆ†æ&quot;&gt;&lt;a href=&quot;#æ•…éšœåˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;æ•…éšœåˆ†æ&quot;&gt;&lt;/a&gt;æ•…éšœåˆ†æ&lt;/h2&gt;&lt;p&gt;æ ¹æ®è¿ç»´åŒå­¦çš„åé¦ˆï¼Œè¯¥ pod æ›¾å¤šæ¬¡é‡å¯ã€‚å› æ­¤æˆ‘ä»¬å…ˆç”¨ &lt;code&gt;kubectl logs --previous&lt;/code&gt; å‘½ä»¤æŸ¥è¯¢ awesome-app å®¹å™¨æœ€åä¸€æ¬¡é‡å¯å‰çš„æ—¥å¿—ï¼Œä»¥ä»æ—¥å¿—ä¸­æŸ¥æ‰¾å…¶é‡å¯çš„åŸå› ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl logs --previous awesome-app-cd1234567-gzgwg -c awesome-app&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä»æ—¥å¿—ä¸­æŸ¥è¯¢åˆ°äº†å…¶é‡å¯å‰æœ€åçš„é”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Logging system failed to initialize using configuration from &lt;span class=&quot;string&quot;&gt;&#39;http://log-config-server:12345/******/logback-spring.xml&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java.net.ConnectException: Connection refused (Connection refused)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at java.net.PlainSocketImpl.socketConnect(Native Method)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä»é”™è¯¯ä¿¡æ¯å¯ä»¥å¾—çŸ¥ï¼Œåº”ç”¨è¿›ç¨‹åœ¨å¯åŠ¨æ—¶è¯•å›¾é€šè¿‡ HTTP åè®®ä»é…ç½®ä¸­å¿ƒæ‹‰å– logback çš„é…ç½®ä¿¡æ¯ï¼Œä½†è¯¥æ“ä½œç”±äºç½‘ç»œå¼‚å¸¸å¤±è´¥äº†ï¼Œå¯¼è‡´åº”ç”¨è¿›ç¨‹å¯åŠ¨å¤±è´¥ï¼Œæœ€ç»ˆå¯¼è‡´å®¹å™¨é‡å¯ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ˜¯ä»€ä¹ˆå¯¼è‡´äº†ç½‘ç»œå¼‚å¸¸å‘¢ï¼Ÿ&lt;/strong&gt;æˆ‘ä»¬å†ç”¨ &lt;code&gt;Kubectl get pod&lt;/code&gt; å‘½ä»¤æŸ¥è¯¢ Pod çš„è¿è¡ŒçŠ¶æ€ï¼Œå°è¯•æ‰¾åˆ°æ›´å¤šçš„çº¿ç´¢ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl get pod awesome-app-cd1234567-gzgwg  -o yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å‘½ä»¤è¾“å‡ºçš„ pod è¯¦ç»†å†…å®¹å¦‚ä¸‹ï¼Œè¯¥ yaml ç‰‡æ®µçœç•¥äº†å…¶ä»–æ— å…³çš„ç»†èŠ‚ï¼Œåªæ˜¾ç¤ºäº† lastState å’Œ state éƒ¨åˆ†çš„å®¹å™¨çŠ¶æ€ä¿¡æ¯ã€‚&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;containerStatuses:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - containerID:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    lastState:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      terminated:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        containerID:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        exitCode:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        finishedAt:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2020&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-09&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-01&lt;/span&gt;T13:&lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;23&lt;/span&gt;Z&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        reason:&lt;/span&gt; Error&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        startedAt:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2020&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-09&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-01&lt;/span&gt;T13:&lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;22&lt;/span&gt;Z&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    name:&lt;/span&gt; awesome-app&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    ready:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    restartCount:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    state:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      running:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        startedAt:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2020&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-09&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-01&lt;/span&gt;T13:&lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;36&lt;/span&gt;Z&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - containerID:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    lastState:&lt;/span&gt; &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    name:&lt;/span&gt; istio-proxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    ready:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    restartCount:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    state:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      running:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        startedAt:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2020&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-09&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-01&lt;/span&gt;T13:&lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;Z&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  hostIP:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.6&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.161&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä»è¯¥è¾“å‡ºå¯ä»¥çœ‹åˆ° pod ä¸­çš„åº”ç”¨å®¹å™¨ awesome-app é‡å¯äº†ä¸¤æ¬¡ã€‚æ•´ç†è¯¥ pod ä¸­ awesome-app åº”ç”¨å®¹å™¨å’Œ istio-proxy sidecar å®¹å™¨çš„å¯åŠ¨å’Œç»ˆæ­¢çš„æ—¶é—´é¡ºåºï¼Œå¯ä»¥å¾—åˆ°ä¸‹é¢çš„æ—¶é—´çº¿ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;2020-09-01T13:16:20Z istio-proxy å¯åŠ¨&lt;/li&gt;
&lt;li&gt;2020-09-01T13:16:22Z awesome-app ä¸Šä¸€æ¬¡å¯åŠ¨æ—¶é—´&lt;/li&gt;
&lt;li&gt;2020-09-01T13:16:23Z awesome-app ä¸Šä¸€æ¬¡å¼‚å¸¸é€€å‡ºæ—¶é—´&lt;/li&gt;
&lt;li&gt;2020-09-01T13:16:36Z awesome-app æœ€åä¸€æ¬¡å¯åŠ¨ï¼Œä»¥åå°±ä¸€ç›´æ­£å¸¸è¿è¡Œ&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°åœ¨ &lt;code&gt;istio-proxy&lt;/code&gt; å¯åŠ¨2ç§’åï¼Œawesome-app å¯åŠ¨ï¼Œå¹¶äº1ç§’åå¼‚å¸¸é€€å‡ºã€‚ç»“åˆå‰é¢çš„æ—¥å¿—ä¿¡æ¯ï¼Œæˆ‘ä»¬çŸ¥é“è¿™æ¬¡å¯åŠ¨å¤±è´¥çš„ç›´æ¥åŸå› æ˜¯åº”ç”¨è®¿é—®é…ç½®ä¸­å¿ƒå¤±è´¥å¯¼è‡´ã€‚åœ¨ &lt;code&gt;istio-proxy&lt;/code&gt; å¯åŠ¨16ç§’åï¼Œawesome-app å†æ¬¡å¯åŠ¨ï¼Œè¿™æ¬¡å¯åŠ¨æˆåŠŸï¼Œä¹‹åä¸€ç›´æ­£å¸¸è¿è¡Œã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;istio-proxy&lt;/code&gt; å¯åŠ¨å’Œ awesome-app ä¸Šä¸€æ¬¡å¼‚å¸¸é€€å‡ºçš„æ—¶é—´é—´éš”å¾ˆçŸ­ï¼Œåªæœ‰2ç§’é’Ÿï¼Œå› æ­¤æˆ‘ä»¬åŸºæœ¬å¯ä»¥åˆ¤æ–­æ­¤æ—¶ &lt;code&gt;istio-proxy&lt;/code&gt; å°šæœªå¯åŠ¨åˆå§‹åŒ–å®Œæˆï¼Œå¯¼è‡´ awesome-app ä¸èƒ½é€šè¿‡&lt;code&gt;istio-proxy&lt;/code&gt; è¿æ¥åˆ°å¤–éƒ¨æœåŠ¡ï¼Œå¯¼è‡´å…¶å¯åŠ¨å¤±è´¥ã€‚å¾… awesome-app äº 2020-09-01T13:16:36Z å†æ¬¡å¯åŠ¨æ—¶ï¼Œç”±äº &lt;code&gt;istio-proxy&lt;/code&gt; å·²ç»å¯åŠ¨äº†è¾ƒé•¿æ—¶é—´ï¼Œå®Œæˆäº†ä» pilot è·å–åŠ¨æ€é…ç½®çš„è¿‡ç¨‹ï¼Œå› æ­¤ awesome-app å‘ pod å¤–éƒ¨çš„ç½‘ç»œè®¿é—®å°±æ­£å¸¸äº†ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒEnvoy å¯åŠ¨åä¼šé€šè¿‡ xDS åè®®å‘ pilot è¯·æ±‚æœåŠ¡å’Œè·¯ç”±é…ç½®ä¿¡æ¯ï¼ŒPilot æ”¶åˆ°è¯·æ±‚åä¼šæ ¹æ® Envoy æ‰€åœ¨çš„èŠ‚ç‚¹ï¼ˆpodæˆ–è€…VMï¼‰ç»„è£…é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ &lt;code&gt;Listener&lt;/code&gt;ã€&lt;code&gt;Route&lt;/code&gt;ã€&lt;code&gt;Cluster&lt;/code&gt; ç­‰ï¼Œç„¶åå†é€šè¿‡ xDS åè®®ä¸‹å‘ç»™ Envoyã€‚æ ¹æ® Mesh çš„è§„æ¨¡å’Œç½‘ç»œæƒ…å†µï¼Œè¯¥é…ç½®ä¸‹å‘è¿‡ç¨‹éœ€è¦æ•°ç§’åˆ°æ•°åç§’çš„æ—¶é—´ã€‚ç”±äºåˆå§‹åŒ–å®¹å™¨å·²ç»åœ¨ pod ä¸­åˆ›å»ºäº† Iptables rule è§„åˆ™ï¼Œå› æ­¤è¿™æ®µæ—¶é—´å†…åº”ç”¨å‘å¤–å‘é€çš„ç½‘ç»œæµé‡ä¼šè¢«é‡å®šå‘åˆ° Envoy ï¼Œè€Œæ­¤æ—¶ Envoy ä¸­å°šæ²¡æœ‰å¯¹è¿™äº›ç½‘ç»œè¯·æ±‚è¿›è¡Œå¤„ç†çš„ç›‘å¬å™¨å’Œè·¯ç”±è§„åˆ™ï¼Œæ— æ³•å¯¹æ­¤è¿›è¡Œå¤„ç†ï¼Œå¯¼è‡´ç½‘ç»œè¯·æ±‚å¤±è´¥ã€‚ï¼ˆå…³äº &lt;code&gt;Envoy sidecar&lt;/code&gt; åˆå§‹åŒ–è¿‡ç¨‹å’Œ &lt;code&gt;Istio&lt;/code&gt; æµé‡ç®¡ç†åŸç†çš„æ›´å¤šå†…å®¹ï¼Œå¯ä»¥å‚è€ƒ &lt;a href=&quot;https://zhaohuabing.com/post/2018-09-25-istio-traffic-management-impl-intro/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Istioæµé‡ç®¡ç†å®ç°æœºåˆ¶æ·±åº¦è§£æ-åŸºäº1.4.0æ›´æ–°&lt;/a&gt;ï¼‰&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/istio/istio-1.png&quot; alt=&quot;Envory sidecaråˆå§‹åŒ–&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;è§£å†³æ–¹æ¡ˆ&quot;&gt;&lt;a href=&quot;#è§£å†³æ–¹æ¡ˆ&quot; class=&quot;headerlink&quot; title=&quot;è§£å†³æ–¹æ¡ˆ&quot;&gt;&lt;/a&gt;è§£å†³æ–¹æ¡ˆ&lt;/h2&gt;&lt;h3 id=&quot;åœ¨åº”ç”¨å¯åŠ¨å‘½ä»¤ä¸­åˆ¤æ–­-Envoy-åˆå§‹åŒ–çŠ¶æ€&quot;&gt;&lt;a href=&quot;#åœ¨åº”ç”¨å¯åŠ¨å‘½ä»¤ä¸­åˆ¤æ–­-Envoy-åˆå§‹åŒ–çŠ¶æ€&quot; class=&quot;headerlink&quot; title=&quot;åœ¨åº”ç”¨å¯åŠ¨å‘½ä»¤ä¸­åˆ¤æ–­ Envoy åˆå§‹åŒ–çŠ¶æ€&quot;&gt;&lt;/a&gt;åœ¨åº”ç”¨å¯åŠ¨å‘½ä»¤ä¸­åˆ¤æ–­ Envoy åˆå§‹åŒ–çŠ¶æ€&lt;/h3&gt;&lt;p&gt;ä»å‰é¢çš„åˆ†æå¯ä»¥å¾—çŸ¥ï¼Œè¯¥é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ç”±äºåº”ç”¨è¿›ç¨‹å¯¹ &lt;code&gt;Envoy sidecar&lt;/code&gt; é…ç½®åˆå§‹åŒ–çš„ä¾èµ–å¯¼è‡´çš„ã€‚å› æ­¤æœ€ç›´æ¥çš„è§£å†³æ€è·¯å°±æ˜¯ï¼šåœ¨åº”ç”¨è¿›ç¨‹å¯åŠ¨æ—¶åˆ¤æ–­ &lt;code&gt;Envoy sidecar&lt;/code&gt; çš„åˆå§‹åŒ–çŠ¶æ€ï¼Œå¾…å…¶åˆå§‹åŒ–å®Œæˆåå†å¯åŠ¨åº”ç”¨è¿›ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;Envoy çš„å¥åº·æ£€æŸ¥æ¥å£ &lt;code&gt;localhost:15020/healthz/ready&lt;/code&gt; ä¼šåœ¨ xDS é…ç½®åˆå§‹åŒ–å®Œæˆåæ‰è¿”å› 200ï¼Œå¦åˆ™å°†è¿”å› 503ï¼Œå› æ­¤å¯ä»¥æ ¹æ®è¯¥æ¥å£åˆ¤æ–­ Envoy çš„é…ç½®åˆå§‹åŒ–çŠ¶æ€ï¼Œå¾…å…¶å®Œæˆåå†å¯åŠ¨åº”ç”¨å®¹å™¨ã€‚æˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨å®¹å™¨çš„å¯åŠ¨å‘½ä»¤ä¸­åŠ å…¥è°ƒç”¨ Envoy å¥åº·æ£€æŸ¥çš„è„šæœ¬ï¼Œå¦‚ä¸‹é¢çš„é…ç½®ç‰‡æ®µæ‰€ç¤ºã€‚åœ¨å…¶ä»–åº”ç”¨ä¸­ä½¿ç”¨æ—¶ï¼Œå°† &lt;code&gt;start-awesome-app-cmd&lt;/code&gt; æ”¹ä¸ºå®¹å™¨ä¸­çš„åº”ç”¨å¯åŠ¨å‘½ä»¤å³å¯ã€‚&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; apps/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; awesome-app-deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  selector:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    matchLabels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      app:&lt;/span&gt; awesome-app&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  replicas:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  template:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        app:&lt;/span&gt; awesome-app&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - name:&lt;/span&gt; awesome-app&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        image:&lt;/span&gt; awesome-app&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - containerPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        command:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;/bin/bash&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;-c&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        args:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;while [[ \&quot;$(curl -s -o /dev/null -w &#39;&#39;&lt;span class=&quot;template-variable&quot;&gt;%&amp;#123;http_code&amp;#125;&lt;/span&gt;&#39;&#39; localhost:15020/healthz/ready)\&quot; != &#39;200&#39; ]]; do echo Waiting for Sidecar;sleep 1; done; echo Sidecar available; start-awesome-app-cmd&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¯¥æµç¨‹çš„æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;Kubernetes&lt;/code&gt; å¯åŠ¨ åº”ç”¨å®¹å™¨ã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨å®¹å™¨å¯åŠ¨è„šæœ¬ä¸­é€šè¿‡ &lt;code&gt;curl get localhost:15020/healthz/ready&lt;/code&gt; æŸ¥è¯¢ &lt;code&gt;Envoy sidcar&lt;/code&gt; çŠ¶æ€ï¼Œç”±äºæ­¤æ—¶ &lt;code&gt;Envoy sidecar&lt;/code&gt; å°šæœªå°±ç»ªï¼Œå› æ­¤è¯¥è„šæœ¬ä¼šä¸æ–­é‡è¯•ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Kubernetes&lt;/code&gt; å¯åŠ¨ &lt;code&gt;Envoy sidecar&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Envoy sidecar&lt;/code&gt; é€šè¿‡ xDS è¿æ¥ Pilotï¼Œè¿›è¡Œé…ç½®åˆå§‹åŒ–ã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨å®¹å™¨å¯åŠ¨è„šæœ¬é€šè¿‡ &lt;code&gt;Envoy sidecar&lt;/code&gt; çš„å¥åº·æ£€æŸ¥æ¥å£åˆ¤æ–­å…¶åˆå§‹åŒ–å·²ç»å®Œæˆï¼Œå¯åŠ¨åº”ç”¨è¿›ç¨‹ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è¯¥æ–¹æ¡ˆè™½ç„¶å¯ä»¥è§„é¿ä¾èµ–é¡ºåºçš„é—®é¢˜ï¼Œä½†éœ€è¦å¯¹åº”ç”¨å®¹å™¨çš„å¯åŠ¨è„šæœ¬è¿›è¡Œä¿®æ”¹ï¼Œå¯¹ Envoy çš„å¥åº·çŠ¶æ€è¿›è¡Œåˆ¤æ–­ã€‚æ›´ç†æƒ³çš„æ–¹æ¡ˆåº”è¯¥æ˜¯åº”ç”¨å¯¹ &lt;code&gt;Envoy sidecar&lt;/code&gt; ä¸æ„ŸçŸ¥ã€‚&lt;/p&gt;
&lt;h3 id=&quot;é€šè¿‡-pod-å®¹å™¨å¯åŠ¨é¡ºåºè¿›è¡Œæ§åˆ¶&quot;&gt;&lt;a href=&quot;#é€šè¿‡-pod-å®¹å™¨å¯åŠ¨é¡ºåºè¿›è¡Œæ§åˆ¶&quot; class=&quot;headerlink&quot; title=&quot;é€šè¿‡ pod å®¹å™¨å¯åŠ¨é¡ºåºè¿›è¡Œæ§åˆ¶&quot;&gt;&lt;/a&gt;é€šè¿‡ pod å®¹å™¨å¯åŠ¨é¡ºåºè¿›è¡Œæ§åˆ¶&lt;/h3&gt;&lt;p&gt;é€šè¿‡é˜…è¯» &lt;a href=&quot;https://github.com/kubernetes/kubernetes/blob/537a602195efdc04cdf2cb0368792afad082d9fd/pkg/kubelet/kuberuntime/kuberuntime_manager.go#L827-L830&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kubernetesæºç &lt;/a&gt; ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å½“ pod ä¸­æœ‰å¤šä¸ªå®¹å™¨æ—¶ï¼Œ&lt;code&gt;Kubernetes&lt;/code&gt; ä¼šåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä¾æ¬¡å¯åŠ¨è¿™äº›å®¹å™¨ï¼Œå¦‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ‰€ç¤ºï¼š&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Step 7: start containers in podContainerChanges.ContainersToStart.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; _, idx := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; podContainerChanges.ContainersToStart &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  start(&lt;span class=&quot;string&quot;&gt;&quot;container&quot;&lt;/span&gt;, containerStartSpec(&amp;amp;pod.Spec.Containers[idx]))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨å‘ pod ä¸­æ³¨å…¥ &lt;code&gt;Envoy sidecar&lt;/code&gt; æ—¶å°† &lt;code&gt;Envoy sidecar&lt;/code&gt; æ”¾åˆ°åº”ç”¨å®¹å™¨ä¹‹å‰ï¼Œè¿™æ · &lt;code&gt;Kubernetes&lt;/code&gt; ä¼šå…ˆå¯åŠ¨ &lt;code&gt;Envoy sidecar&lt;/code&gt;ï¼Œå†å¯åŠ¨åº”ç”¨å®¹å™¨ã€‚ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒEnvoy å¯åŠ¨åæˆ‘ä»¬å¹¶ä¸èƒ½ç«‹å³å¯åŠ¨åº”ç”¨å®¹å™¨ï¼Œè¿˜éœ€è¦ç­‰å¾… xDS é…ç½®åˆå§‹åŒ–å®Œæˆã€‚è¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥é‡‡ç”¨å®¹å™¨çš„ &lt;a href=&quot;https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;postStart lifecycle hook&lt;/a&gt; æ¥è¾¾æˆè¯¥ç›®çš„ã€‚&lt;code&gt;Kubernetes&lt;/code&gt; ä¼šåœ¨å¯åŠ¨å®¹å™¨åè°ƒç”¨è¯¥å®¹å™¨çš„ &lt;code&gt;postStart hook&lt;/code&gt;ï¼Œ&lt;code&gt;postStart hook&lt;/code&gt; ä¼šé˜»å¡ pod ä¸­çš„ä¸‹ä¸€ä¸ªå®¹å™¨çš„å¯åŠ¨ï¼Œç›´åˆ° &lt;code&gt;postStart hook&lt;/code&gt; æ‰§è¡Œå®Œæˆã€‚å› æ­¤å¦‚æœåœ¨ &lt;code&gt;Envoy sidecar&lt;/code&gt; çš„ &lt;code&gt;postStart hook&lt;/code&gt; ä¸­å¯¹ Envoy çš„é…ç½®åˆå§‹åŒ–çŠ¶æ€è¿›è¡Œåˆ¤æ–­ï¼Œå¾…å®Œæˆåˆå§‹åŒ–åå†è¿”å›ï¼Œå°±å¯ä»¥ä¿è¯ &lt;code&gt;Kubernetes&lt;/code&gt; åœ¨ &lt;code&gt;Envoy sidecar&lt;/code&gt; é…ç½®åˆå§‹åŒ–å®Œæˆåå†å¯åŠ¨åº”ç”¨å®¹å™¨ã€‚è¯¥æµç¨‹çš„æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;Kubernetes&lt;/code&gt; å¯åŠ¨ &lt;code&gt;Envoy sidecar&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Kubernetes&lt;/code&gt; æ‰§è¡Œ &lt;code&gt;postStart hook&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;postStart hook&lt;/code&gt; é€šè¿‡ Envoy å¥åº·æ£€æŸ¥æ¥å£åˆ¤æ–­å…¶é…ç½®åˆå§‹åŒ–çŠ¶æ€ï¼Œç›´åˆ° Envoy å¯åŠ¨å®Œæˆ ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Kubernetes&lt;/code&gt; å¯åŠ¨åº”ç”¨å®¹å™¨ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;code&gt;Istio&lt;/code&gt; å·²ç»åœ¨ 1.7 ä¸­åˆå…¥äº†è¯¥ä¿®å¤æ–¹æ¡ˆï¼Œå‚è§ &lt;a href=&quot;https://github.com/istio/istio/pull/24737&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Allow users to delay application start until proxy is ready&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;æ’å…¥ &lt;code&gt;sidecar&lt;/code&gt; åçš„ pod spec å¦‚ä¸‹é¢çš„ yaml ç‰‡æ®µæ‰€ç¤ºã€‚&lt;code&gt;postStart hook&lt;/code&gt; é…ç½®çš„ &lt;code&gt;pilot-agent wait&lt;/code&gt; å‘½ä»¤ä¼šæŒç»­è°ƒç”¨ &lt;code&gt;Envoy&lt;/code&gt; çš„å¥åº·æ£€æŸ¥æ¥å£ â€˜/healthz/readyâ€™ æ£€æŸ¥å…¶çŠ¶æ€ï¼Œç›´åˆ° Envoy å®Œæˆé…ç½®åˆå§‹åŒ–ã€‚è¿™ç¯‡æ–‡ç«  &lt;a href=&quot;https://medium.com/@marko.luksa/delaying-application-start-until-sidecar-is-ready-2ec2d21a7b74&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Delaying application start until sidecar is ready&lt;/a&gt; ä¸­ä»‹ç»äº†æ›´å¤šå…³äºè¯¥æ–¹æ¡ˆçš„ç»†èŠ‚ã€‚&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; sidecar-starts-first&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; istio-proxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    image:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    lifecycle:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      postStart:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        exec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          command:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;          -&lt;/span&gt; pilot-agent&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;          -&lt;/span&gt; wait&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; application&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    image:&lt;/span&gt; my-application&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¯¥æ–¹æ¡ˆåœ¨ä¸å¯¹åº”ç”¨è¿›è¡Œä¿®æ”¹çš„æƒ…å†µä¸‹æ¯”è¾ƒå®Œç¾åœ°è§£å†³äº†åº”ç”¨å®¹å™¨å’Œ &lt;code&gt;Envoy sidecar&lt;/code&gt; åˆå§‹åŒ–çš„ä¾èµ–é—®é¢˜ã€‚ä½†æ˜¯è¯¥è§£å†³æ–¹æ¡ˆå¯¹ &lt;code&gt;Kubernetes&lt;/code&gt; æœ‰ä¸¤ä¸ªéšå¼ä¾èµ–æ¡ä»¶ï¼š&lt;code&gt;Kubernetes&lt;/code&gt; åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æŒ‰å®šä¹‰é¡ºåºä¾æ¬¡å¯åŠ¨ pod ä¸­çš„å¤šä¸ªå®¹å™¨ï¼Œä»¥åŠå‰ä¸€ä¸ªå®¹å™¨çš„ &lt;code&gt;postStart hook&lt;/code&gt; æ‰§è¡Œå®Œæ¯•åå†å¯åŠ¨ä¸‹ä¸€ä¸ªå®¹å™¨ã€‚è¿™ä¸¤ä¸ªå‰ææ¡ä»¶åœ¨ç›®å‰çš„ &lt;code&gt;Kuberenetes&lt;/code&gt; ä»£ç å®ç°ä¸­æ˜¯æ»¡è¶³çš„ï¼Œä½†ç”±äºè¿™å¹¶ä¸æ˜¯ &lt;code&gt;Kubernetes&lt;/code&gt; çš„ API è§„èŒƒï¼Œå› æ­¤è¯¥å‰æåœ¨å°†æ¥ &lt;code&gt;Kubernetes&lt;/code&gt; å‡çº§åå¾ˆå¯èƒ½è¢«æ‰“ç ´ï¼Œå¯¼è‡´è¯¥é—®é¢˜å†æ¬¡å‡ºç°ã€‚&lt;/p&gt;
&lt;h3 id=&quot;Kubernetes-æ”¯æŒå®šä¹‰-pod-ä¸­å®¹å™¨ä¹‹é—´çš„ä¾èµ–å…³ç³»&quot;&gt;&lt;a href=&quot;#Kubernetes-æ”¯æŒå®šä¹‰-pod-ä¸­å®¹å™¨ä¹‹é—´çš„ä¾èµ–å…³ç³»&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes æ”¯æŒå®šä¹‰ pod ä¸­å®¹å™¨ä¹‹é—´çš„ä¾èµ–å…³ç³»&quot;&gt;&lt;/a&gt;Kubernetes æ”¯æŒå®šä¹‰ pod ä¸­å®¹å™¨ä¹‹é—´çš„ä¾èµ–å…³ç³»&lt;/h3&gt;&lt;p&gt;ä¸ºäº†å½»åº•è§£å†³è¯¥é—®é¢˜ï¼Œé¿å… &lt;code&gt;Kubernetes&lt;/code&gt; ä»£ç å˜åŠ¨åè¯¥é—®é¢˜å†æ¬¡å‡ºç°ï¼Œæ›´åˆç†çš„æ–¹å¼åº”è¯¥æ˜¯ç”± &lt;code&gt;Kubernetes&lt;/code&gt; æ”¯æŒæ˜¾å¼å®šä¹‰ pod ä¸­ä¸€ä¸ªå®¹å™¨çš„å¯åŠ¨ä¾èµ–äºå¦ä¸€ä¸ªå®¹å™¨çš„å¥åº·çŠ¶æ€ã€‚ç›®å‰ &lt;code&gt;Kubernetes&lt;/code&gt; ä¸­å·²ç»æœ‰ä¸€ä¸ª &lt;a href=&quot;https://github.com/kubernetes/kubernetes/issues/65502&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;issue Support startup dependencies between containers on the same Pod&lt;/a&gt; å¯¹è¯¥é—®é¢˜è¿›è¡Œè·Ÿè¸ªå¤„ç†ã€‚å¦‚æœ &lt;code&gt;Kubernetes&lt;/code&gt; æ”¯æŒäº†è¯¥ç‰¹æ€§ï¼Œåˆ™è¯¥æµç¨‹çš„æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;Kubernetes&lt;/code&gt; å¯åŠ¨ &lt;code&gt;Envoy sidecar&lt;/code&gt; å®¹å™¨ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Kubernetes&lt;/code&gt; é€šè¿‡ &lt;code&gt;Envoy sidecar&lt;/code&gt; å®¹å™¨çš„ readiness probe æ£€æŸ¥å…¶çŠ¶æ€ï¼Œç›´åˆ° readiness probe åé¦ˆ &lt;code&gt;Envoy sidecar&lt;/code&gt; å·²ç» readyï¼Œå³å·²ç»åˆå§‹åŒ–å®Œæ¯•ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Kubernetes&lt;/code&gt; å¯åŠ¨åº”ç”¨å®¹å™¨ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;è§£è€¦åº”ç”¨æœåŠ¡ä¹‹é—´çš„å¯åŠ¨ä¾èµ–å…³ç³»&quot;&gt;&lt;a href=&quot;#è§£è€¦åº”ç”¨æœåŠ¡ä¹‹é—´çš„å¯åŠ¨ä¾èµ–å…³ç³»&quot; class=&quot;headerlink&quot; title=&quot;è§£è€¦åº”ç”¨æœåŠ¡ä¹‹é—´çš„å¯åŠ¨ä¾èµ–å…³ç³»&quot;&gt;&lt;/a&gt;è§£è€¦åº”ç”¨æœåŠ¡ä¹‹é—´çš„å¯åŠ¨ä¾èµ–å…³ç³»&lt;/h3&gt;&lt;p&gt;ä»¥ä¸Šå‡ ä¸ªè§£å†³æ–¹æ¡ˆçš„æ€è·¯éƒ½æ˜¯æ§åˆ¶ pod ä¸­å®¹å™¨çš„å¯åŠ¨é¡ºåºï¼Œåœ¨ &lt;code&gt;Envoy sidecar&lt;/code&gt; åˆå§‹åŒ–å®Œæˆåå†å¯åŠ¨åº”ç”¨å®¹å™¨ï¼Œä»¥ç¡®ä¿åº”ç”¨å®¹å™¨å¯åŠ¨æ—¶èƒ½å¤Ÿé€šè¿‡ç½‘ç»œæ­£å¸¸è®¿é—®å…¶ä»–æœåŠ¡ã€‚ä½†è¿™äº›æ–¹æ¡ˆåªæ˜¯ã€å¤´ç—›åŒ»å¤´ï¼Œè„šç—›åŒ»è„šã€,æ˜¯æ²»æ ‡ä¸æ²»æœ¬çš„æ–¹æ³•ã€‚å› ä¸ºå³ä½¿ pod ä¸­å¯¹å¤–çš„ç½‘ç»œè®¿é—®æ²¡æœ‰é—®é¢˜ï¼Œåº”ç”¨å®¹å™¨ä¾èµ–çš„å…¶ä»–æœåŠ¡ä¹Ÿå¯èƒ½ç”±äºå°šæœªå¯åŠ¨ï¼Œæˆ–è€…æŸäº›é—®é¢˜è€Œä¸èƒ½åœ¨æ­¤æ—¶æ­£å¸¸æä¾›æœåŠ¡ã€‚è¦å½»åº•è§£å†³è¯¥é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è§£è€¦åº”ç”¨æœåŠ¡ä¹‹é—´çš„å¯åŠ¨ä¾èµ–å…³ç³»ï¼Œä½¿åº”ç”¨å®¹å™¨çš„å¯åŠ¨ä¸å†å¼ºä¾èµ–å…¶ä»–æœåŠ¡ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ä¸€ä¸ªå¾®æœåŠ¡ç³»ç»Ÿä¸­ï¼ŒåŸå•ä½“åº”ç”¨ä¸­çš„å„ä¸ªä¸šåŠ¡æ¨¡å—è¢«æ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹è¿›ç¨‹ï¼ˆæœåŠ¡ï¼‰ã€‚è¿™äº›æœåŠ¡çš„å¯åŠ¨é¡ºåºæ˜¯éšæœºçš„ï¼Œå¹¶ä¸”æœåŠ¡ä¹‹é—´é€šè¿‡ä¸å¯é çš„ç½‘ç»œè¿›è¡Œé€šä¿¡ã€‚å¾®æœåŠ¡å¤šè¿›ç¨‹éƒ¨ç½²ã€è·¨è¿›ç¨‹ç½‘ç»œé€šä¿¡çš„ç‰¹å®šå†³å®šäº†æœåŠ¡ä¹‹é—´çš„è°ƒç”¨å‡ºç°å¼‚å¸¸æ˜¯ä¸€ä¸ªå¸¸è§çš„æƒ…å†µã€‚ä¸ºäº†åº”å¯¹å¾®æœåŠ¡çš„è¯¥ç‰¹ç‚¹ï¼Œå¾®æœåŠ¡çš„ä¸€ä¸ªåŸºæœ¬çš„è®¾è®¡åŸåˆ™æ˜¯ &lt;strong&gt;â€œdesign for failureâ€&lt;/strong&gt;ï¼Œå³éœ€è¦ä»¥ä¼˜é›…çš„æ–¹å¼åº”å¯¹å¯èƒ½å‡ºç°çš„å„ç§å¼‚å¸¸æƒ…å†µã€‚å½“åœ¨å¾®æœåŠ¡è¿›ç¨‹ä¸­ä¸èƒ½è®¿é—®ä¸€ä¸ªä¾èµ–çš„å¤–éƒ¨æœåŠ¡æ—¶ï¼Œéœ€è¦é€šè¿‡é‡è¯•ã€é™çº§ã€è¶…æ—¶ã€æ–­è·¯ç­‰ç­–ç•¥å¯¹å¼‚å¸¸è¿›è¡Œå®¹é”™å¤„ç†ï¼Œä»¥å°½å¯èƒ½ä¿è¯ç³»ç»Ÿçš„æ­£å¸¸è¿è¡Œã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Envoy sidecar&lt;/code&gt; åˆå§‹åŒ–æœŸé—´ç½‘ç»œæš‚æ—¶ä¸èƒ½è®¿é—®çš„æƒ…å†µåªæ˜¯æ”¾å¤§äº†å¾®æœåŠ¡ç³»ç»Ÿæœªèƒ½æ­£ç¡®å¤„ç†æœåŠ¡ä¾èµ–çš„é—®é¢˜ï¼Œå³ä½¿è§£å†³äº† &lt;code&gt;Envoy sidecar&lt;/code&gt; çš„ä¾èµ–é¡ºåºï¼Œè¯¥é—®é¢˜ä¾ç„¶å­˜åœ¨ã€‚ä¾‹å¦‚åœ¨æœ¬æ¡ˆä¾‹ä¸­ï¼Œé…ç½®ä¸­å¿ƒä¹Ÿæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡ï¼Œå½“ä¸€ä¸ªä¾èµ–é…ç½®ä¸­å¿ƒçš„å¾®æœåŠ¡å¯åŠ¨æ—¶ï¼Œé…ç½®ä¸­å¿ƒæœ‰å¯èƒ½å°šæœªå¯åŠ¨ï¼Œæˆ–è€…å°šæœªåˆå§‹åŒ–å®Œæˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœåœ¨ä»£ç ä¸­æ²¡æœ‰å¯¹è¯¥å¼‚å¸¸æƒ…å†µè¿›è¡Œå¤„ç†ï¼Œä¹Ÿä¼šå¯¼è‡´ä¾èµ–é…ç½®ä¸­å¿ƒçš„å¾®æœåŠ¡å¯åŠ¨å¤±è´¥ã€‚åœ¨ä¸€ä¸ªæ›´ä¸ºå¤æ‚çš„ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªå¾®æœåŠ¡è¿›ç¨‹ä¹‹é—´å¯èƒ½å­˜åœ¨ç½‘çŠ¶ä¾èµ–å…³ç³»ï¼Œå¦‚æœæ²¡æœ‰æŒ‰ç…§ &lt;strong&gt;â€œdesign for failureâ€&lt;/strong&gt; çš„åŸåˆ™å¯¹å¾®æœåŠ¡è¿›è¡Œå®¹é”™å¤„ç†ï¼Œé‚£ä¹ˆåªæ˜¯å°†æ•´ä¸ªç³»ç»Ÿå¯åŠ¨èµ·æ¥å°±å°†æ˜¯ä¸€ä¸ªå·¨å¤§çš„æŒ‘æˆ˜ã€‚å¯¹äºæœ¬ä¾‹è€Œè¨€ï¼Œå¯ä»¥é‡‡ç”¨ä¸€ä¸ªç±»ä¼¼è¿™æ ·çš„ç®€å•å®¹é”™ç­–ç•¥ï¼šå…ˆç”¨ä¸€ä¸ªç¼ºçœçš„ logback é…ç½®å¯åŠ¨åº”ç”¨è¿›ç¨‹ï¼Œå¹¶åœ¨å¯åŠ¨åå¯¹é…ç½®ä¸­å¿ƒè¿›è¡Œé‡è¯•ï¼Œå¾…è¿æ¥ä¸Šé…ç½®ä¸­å¿ƒåï¼Œå†ä½¿ç”¨é…ç½®ä¸­å¿ƒä¸‹å‘çš„é…ç½®å¯¹ logback è¿›è¡Œè®¾ç½®ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å°ç»“&quot;&gt;&lt;a href=&quot;#å°ç»“&quot; class=&quot;headerlink&quot; title=&quot;å°ç»“&quot;&gt;&lt;/a&gt;å°ç»“&lt;/h2&gt;&lt;p&gt;åº”ç”¨å®¹å™¨å¯¹ &lt;code&gt;Envoy Sidecar&lt;/code&gt; å¯åŠ¨ä¾èµ–é—®é¢˜çš„å…¸å‹è¡¨ç°æ˜¯åº”ç”¨å®¹å™¨åœ¨åˆšå¯åŠ¨çš„ä¸€å°æ®µæ—¶é—´å†…è°ƒç”¨å¤–éƒ¨æœåŠ¡å¤±è´¥ã€‚åŸå› æ˜¯æ­¤æ—¶ &lt;code&gt;Envoy sidecar&lt;/code&gt; å°šæœªå®Œæˆ xDS é…ç½®çš„åˆå§‹åŒ–ï¼Œå› æ­¤ä¸èƒ½ä¸ºåº”ç”¨å®¹å™¨è½¬å‘ç½‘ç»œè¯·æ±‚ã€‚è¯¥è°ƒç”¨å¤±è´¥å¯èƒ½å¯¼è‡´åº”ç”¨å®¹å™¨ä¸èƒ½æ­£å¸¸å¯åŠ¨ã€‚æ­¤é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯å¾®æœåŠ¡åº”ç”¨ä¸­å¯¹ä¾èµ–æœåŠ¡çš„è°ƒç”¨å¤±è´¥æ²¡æœ‰è¿›è¡Œåˆç†çš„å®¹é”™å¤„ç†ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äºé—ç•™ç³»ç»Ÿï¼Œä¸ºäº†å°½é‡é¿å…å¯¹åº”ç”¨çš„å½±å“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨åº”ç”¨å¯åŠ¨å‘½ä»¤ä¸­åˆ¤æ–­ &lt;code&gt;Envoy&lt;/code&gt; åˆå§‹åŒ–çŠ¶æ€çš„æ–¹æ¡ˆï¼Œæˆ–è€…å‡çº§åˆ° &lt;code&gt;Istio 1.7&lt;/code&gt; æ¥ç¼“è§£è¯¥é—®é¢˜ã€‚ä½†ä¸ºäº†å½»åº•è§£å†³æœåŠ¡ä¾èµ–å¯¼è‡´çš„é”™è¯¯ï¼Œå»ºè®®å‚è€ƒ &lt;strong&gt;â€œdesign for failureâ€&lt;/strong&gt; çš„è®¾è®¡åŸåˆ™ï¼Œè§£è€¦å¾®æœåŠ¡ä¹‹é—´çš„å¼ºä¾èµ–å…³ç³»ï¼Œåœ¨å‡ºç°æš‚æ—¶ä¸èƒ½è®¿é—®ä¸€ä¸ªä¾èµ–çš„å¤–éƒ¨æœåŠ¡çš„æƒ…å†µæ—¶ï¼Œé€šè¿‡é‡è¯•ã€é™çº§ã€è¶…æ—¶ã€æ–­è·¯ç­‰ç­–ç•¥è¿›è¡Œå¤„ç†ï¼Œä»¥å°½å¯èƒ½ä¿è¯ç³»ç»Ÿçš„æ­£å¸¸è¿è¡Œã€‚&lt;/p&gt;
&lt;p&gt;æ¥æºï¼šmp.weixin.qq.com/s/iXU2LH90_ZA3VeN7xORmBw&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;å¾®ä¿¡è®¢é˜…å·&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;æ•…éšœç°è±¡&quot;&gt;&lt;a href=&quot;#æ•…éšœç°è±¡&quot; class=&quot;headerlink&quot; title=&quot;æ•…éšœç°è±¡&quot;&gt;&lt;/a&gt;æ•…éšœç°è±¡&lt;/h2&gt;&lt;p&gt;å…¸å‹æ¡ˆä¾‹ï¼šæŸè¿ç»´åŒå­¦åé¦ˆï¼šæ˜¨å¤©æ™šä¸Š &lt;code&gt;Istio&lt;/code&gt; ç¯å¢ƒä¸­åº”ç”¨çš„å¿ƒè·³æ£€æµ‹æŠ¥ &lt;code&gt;connect reset&lt;/code&gt;ï¼Œç„¶åæœåŠ¡é‡å¯äº†ã€‚æ€€ç–‘æ˜¯ &lt;code&gt;Istio&lt;/code&gt; ç¯å¢ƒä¸­ç½‘ç»œä¸ç¨³å®šå¯¼è‡´äº†æœåŠ¡é‡å¯ã€‚&lt;/p&gt;
&lt;p&gt;è¯¥é—®é¢˜çš„è¡¨ç°æ˜¯å®‰è£…äº† &lt;code&gt;sidecar proxy&lt;/code&gt; çš„åº”ç”¨ï¼Œåœ¨å¯åŠ¨åçš„ä¸€å°æ®µæ—¶é—´å†…æ— æ³•é€šè¿‡ç½‘ç»œè®¿é—® pod å¤–éƒ¨çš„å…¶ä»–æœåŠ¡ï¼Œä¾‹å¦‚å¤–éƒ¨çš„ HTTPï¼ŒMySQLï¼ŒRedisç­‰æœåŠ¡ã€‚å¦‚æœåº”ç”¨æ²¡æœ‰å¯¹ä¾èµ–æœåŠ¡çš„å¼‚å¸¸è¿›è¡Œå®¹é”™å¤„ç†ï¼Œè¯¥é—®é¢˜è¿˜å¸¸å¸¸ä¼šå¯¼è‡´åº”ç”¨å¯åŠ¨å¤±è´¥ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬ä»¥è¯¥é—®é¢˜å¯¼è‡´çš„ä¸€ä¸ªå…¸å‹æ•…éšœçš„åˆ†æè¿‡ç¨‹ä¸ºä¾‹ï¼Œå¯¹è¯¥é—®é¢˜çš„åŸå› è¿›è¡Œè¯´æ˜ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="istio" scheme="http://team.jiunile.com/categories/istio/"/>
    
    
      <category term="istio" scheme="http://team.jiunile.com/tags/istio/"/>
    
      <category term="sidecar" scheme="http://team.jiunile.com/tags/sidecar/"/>
    
      <category term="istio-proxy" scheme="http://team.jiunile.com/tags/istio-proxy/"/>
    
      <category term="å¯åŠ¨ä¾èµ–" scheme="http://team.jiunile.com/tags/%E5%90%AF%E5%8A%A8%E4%BE%9D%E8%B5%96/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes securityContext</title>
    <link href="http://team.jiunile.com//blog/2020/09/k8s-securitycontext.html"/>
    <id>http://team.jiunile.com//blog/2020/09/k8s-securitycontext.html</id>
    <published>2020-09-09T12:00:00.000Z</published>
    <updated>2020-09-09T10:25:47.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;kubernetes ä¸­çš„ &lt;code&gt;securityContext&lt;/code&gt; æ˜¯ä»€ä¹ˆï¼Ÿåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹æ¥ä½¿ç”¨ï¼Ÿç¬¬ä¸€æ„Ÿè§‰åæ­£æ˜¯å’Œå®‰å…¨ç›¸å…³çš„ä¸œè¥¿ï¼Œæ¥è‡ªå®˜æ–¹å®šä¹‰å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆSecurity Contextï¼‰å®šä¹‰ Pod æˆ– Container çš„ç‰¹æƒä¸è®¿é—®æ§åˆ¶è®¾ç½®ã€‚ å®‰å…¨ä¸Šä¸‹æ–‡åŒ…æ‹¬ä½†ä¸é™äºï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è‡ªä¸»è®¿é—®æ§åˆ¶ï¼ˆDiscretionary Access Controlï¼‰ï¼šåŸºäº ç”¨æˆ· IDï¼ˆUIDï¼‰å’Œç»„ IDï¼ˆGIDï¼‰. æ¥åˆ¤å®šå¯¹å¯¹è±¡ï¼ˆä¾‹å¦‚æ–‡ä»¶ï¼‰çš„è®¿é—®æƒé™&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://zh.wikipedia.org/wiki/%E5%AE%89%E5%85%A8%E5%A2%9E%E5%BC%BA%E5%BC%8FLinux&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;å®‰å…¨æ€§å¢å¼ºçš„ Linuxï¼ˆSELinuxï¼‰&lt;/a&gt;ï¼š ä¸ºå¯¹è±¡èµ‹äºˆå®‰å…¨æ€§æ ‡ç­¾ã€‚&lt;/li&gt;
&lt;li&gt;ä»¥ç‰¹æƒæ¨¡å¼æˆ–è€…éç‰¹æƒæ¨¡å¼è¿è¡Œã€‚&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://linux-audit.com/linux-capabilities-hardening-linux-binaries-by-removing-setuid/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Linux æƒèƒ½&lt;/a&gt;: ä¸ºè¿›ç¨‹èµ‹äºˆ root ç”¨æˆ·çš„éƒ¨åˆ†ç‰¹æƒè€Œéå…¨éƒ¨ç‰¹æƒã€‚&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.io/zh/docs/tutorials/clusters/apparmor/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AppArmor&lt;/a&gt;ï¼šä½¿ç”¨ç¨‹åºæ–‡ä»¶æ¥é™åˆ¶å•ä¸ªç¨‹åºçš„æƒé™ã€‚&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Seccomp&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Seccomp&lt;/a&gt;ï¼šé™åˆ¶ä¸€ä¸ªè¿›ç¨‹è®¿é—®æ–‡ä»¶æè¿°ç¬¦çš„æƒé™ã€‚&lt;/li&gt;
&lt;li&gt;AllowPrivilegeEscalationï¼šæ§åˆ¶è¿›ç¨‹æ˜¯å¦å¯ä»¥è·å¾—è¶…å‡ºå…¶çˆ¶è¿›ç¨‹çš„ç‰¹æƒã€‚ æ­¤å¸ƒå°”å€¼ç›´æ¥æ§åˆ¶æ˜¯å¦ä¸ºå®¹å™¨è¿›ç¨‹è®¾ç½® &lt;a href=&quot;https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;no_new_privs&lt;/a&gt; æ ‡å¿—ã€‚ å½“å®¹å™¨ä»¥ç‰¹æƒæ¨¡å¼è¿è¡Œæˆ–è€…å…·æœ‰ &lt;code&gt;CAP_SYS_ADMIN&lt;/code&gt; æƒèƒ½æ—¶ï¼ŒAllowPrivilegeEscalation æ€»æ˜¯ä¸º &lt;strong&gt;&lt;code&gt;true&lt;/code&gt;&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;li&gt;readOnlyRootFilesystemï¼šä»¥åªè¯»æ–¹å¼åŠ è½½å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»¥ä¸Šæ¡ç›®ä¸æ˜¯å®‰å…¨ä¸Šä¸‹æ–‡è®¾ç½®çš„å®Œæ•´åˆ—è¡¨ â€“ è¯·å‚é˜… &lt;a href=&quot;https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#securitycontext-v1-core&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;SecurityContext&lt;/a&gt; äº†è§£å…¶å®Œæ•´åˆ—è¡¨ã€‚&lt;/p&gt;
&lt;p&gt;å…³äºåœ¨ Linux ç³»ç»Ÿä¸­çš„å®‰å…¨æœºåˆ¶çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜… &lt;a href=&quot;https://www.linux.com/learn/overview-linux-kernel-security-features&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Linux å†…æ ¸å®‰å…¨æ€§èƒ½åŠ›æ¦‚è¿°&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ä¸Šé¢çš„å®šä¹‰æœ‰äº›ä¼¼æ‡‚éæ‡‚ï¼Œèƒ½ä¸èƒ½æ›´åŠ ç›´ç™½çš„æè¿°ä¸‹å‘¢ï¼Ÿå¥½å§ï¼Œä¸‹é¢æ¥ç»™å¤§å®¶æ¥ä¸€äº›å®é™…çš„åº”ç”¨åœºæ™¯æ¥è®²è§£ä¸‹ã€‚&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;Security-Context-åº”ç”¨åœºæ™¯&quot;&gt;&lt;a href=&quot;#Security-Context-åº”ç”¨åœºæ™¯&quot; class=&quot;headerlink&quot; title=&quot;Security Context åº”ç”¨åœºæ™¯&quot;&gt;&lt;/a&gt;Security Context åº”ç”¨åœºæ™¯&lt;/h2&gt;&lt;h3 id=&quot;åœºæ™¯ä¸€ï¼šæˆ‘æœ‰ä¸ªé•œåƒï¼Œå·²érootç”¨æˆ·è¿è¡Œï¼ŒåŒæ—¶æˆ‘éœ€è¦æŒ‚è½½ä¸€å—ç£ç›˜ï¼Œéœ€è¦å°†å¯¹åº”æƒé™æ”¹æˆå½“å‰è¿è¡Œçš„ç”¨æˆ·&quot;&gt;&lt;a href=&quot;#åœºæ™¯ä¸€ï¼šæˆ‘æœ‰ä¸ªé•œåƒï¼Œå·²érootç”¨æˆ·è¿è¡Œï¼ŒåŒæ—¶æˆ‘éœ€è¦æŒ‚è½½ä¸€å—ç£ç›˜ï¼Œéœ€è¦å°†å¯¹åº”æƒé™æ”¹æˆå½“å‰è¿è¡Œçš„ç”¨æˆ·&quot; class=&quot;headerlink&quot; title=&quot;åœºæ™¯ä¸€ï¼šæˆ‘æœ‰ä¸ªé•œåƒï¼Œå·²érootç”¨æˆ·è¿è¡Œï¼ŒåŒæ—¶æˆ‘éœ€è¦æŒ‚è½½ä¸€å—ç£ç›˜ï¼Œéœ€è¦å°†å¯¹åº”æƒé™æ”¹æˆå½“å‰è¿è¡Œçš„ç”¨æˆ·&quot;&gt;&lt;/a&gt;åœºæ™¯ä¸€ï¼šæˆ‘æœ‰ä¸ªé•œåƒï¼Œå·²érootç”¨æˆ·è¿è¡Œï¼ŒåŒæ—¶æˆ‘éœ€è¦æŒ‚è½½ä¸€å—ç£ç›˜ï¼Œéœ€è¦å°†å¯¹åº”æƒé™æ”¹æˆå½“å‰è¿è¡Œçš„ç”¨æˆ·&lt;/h3&gt;&lt;p&gt;æœ‰äº†ä¸Šé¢çš„åœºæ™¯ï¼Œé‚£æˆ‘ä»¬å¦‚ä½•æ¥è¿›è¡Œè®¾å®šå‘¢ï¼Ÿå‡è®¾è¿è¡Œç”¨æˆ·å¯¹åº”çš„ uidä¸º999 gidä¸º999&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; apps/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; StatefulSet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; sc-demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  template:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    securityContext:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      runAsUser:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      runAsGroup:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;999&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      fsGroup:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; sc-demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      image:&lt;/span&gt; xxxxxx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      command:&lt;/span&gt; [ &lt;span class=&quot;string&quot;&gt;&quot;sh&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;-c&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;sleep 1h&quot;&lt;/span&gt; ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      volumeMounts:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - name:&lt;/span&gt; sc-vol&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        mountPath:&lt;/span&gt; /data/demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      securityContext:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        runAsUser:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;999&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  volumeClaimTemplates:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        name:&lt;/span&gt; sc-vol&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        accessModes:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;          -&lt;/span&gt; ReadWriteOnce&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          requests:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            storage:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;Gi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        storageClassName:&lt;/span&gt; gp2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæœ‰ä¸¤ä¸ª &lt;code&gt;securityContext&lt;/code&gt; è®¾å®šï¼Œä¸€ä¸ªæ˜¯é’ˆå¯¹ pod çº§åˆ«çš„ï¼Œå¦å¤–ä¸€ä¸ªåˆ™æ˜¯é’ˆå¯¹ container çº§åˆ«çš„ï¼Œé‚£ä¸¤è€…çš„ä¼˜å…ˆçº§å¦‚ä½•å®šä¹‰å‘¢ï¼Ÿè§„åˆ™å°±æ˜¯ï¼š&lt;strong&gt;containerä¸­çš„ä¼šè¦†å†™podä¸­çš„å®šä¹‰&lt;/strong&gt;ã€‚äº†è§£äº†ä¼˜å…ˆçº§åï¼Œæ¥è®²è§£ä¸‹ runAsUserã€runAsGroupã€fsGroup è¿™ä¸‰ä¸ªå‚æ•°çš„æ„ä¹‰ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;runAsUser&lt;/code&gt; å­—æ®µæŒ‡å®š Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å†…çš„è¿›ç¨‹éƒ½ä½¿ç”¨ ç”¨æˆ·ID 1000 æ¥è¿è¡Œã€‚&lt;code&gt;ä½†è¿™é‡Œ sc-demo å®¹å™¨è¿›è¡Œäº†è¦†å†™ï¼Œå¦‚æœ sc-demo å®¹å™¨å†…çš„è¿›è¡Œä½¿ç”¨ç”¨æˆ· ID ä¸º999æ¥è¿è¡Œ&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;runAsGroup&lt;/code&gt; å­—æ®µæŒ‡å®šæ‰€æœ‰å®¹å™¨ä¸­çš„è¿›ç¨‹éƒ½ä»¥ä¸» ç»„ID 999 æ¥è¿è¡Œã€‚ å¦‚æœå¿½ç•¥æ­¤å­—æ®µï¼Œåˆ™å®¹å™¨çš„ ä¸»ç»„ID å°†æ˜¯ rootï¼ˆ0ï¼‰ã€‚ å½“ &lt;code&gt;runAsGroup&lt;/code&gt; è¢«è®¾ç½®æ—¶ï¼Œæ‰€æœ‰åˆ›å»ºçš„æ–‡ä»¶ä¹Ÿä¼šåˆ’å½’ä¸º ç”¨æˆ·1000 å’Œ ç»„999ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;fsGroup&lt;/code&gt; ç”±äº &lt;code&gt;fsGroup&lt;/code&gt; è¢«è®¾ç½®ï¼Œå®¹å™¨ä¸­æ‰€æœ‰è¿›ç¨‹ä¹Ÿä¼šæ˜¯é™„ ç»„ID 0 (root) çš„ä¸€éƒ¨åˆ†ã€‚ å· &lt;code&gt;/data/demo&lt;/code&gt; åŠåœ¨è¯¥å·ä¸­åˆ›å»ºçš„ä»»ä½•æ–‡ä»¶çš„å±ä¸»éƒ½ä¼šæ˜¯ ç»„ID 0 (root)ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿›å…¥å®¹å™¨ä¸­æŸ¥çœ‹&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ id&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;uid=999(xx) gid=999(xx) groups=999(xx),0(root)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ ls &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt; /data/demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;drwxrwsr-x 3 xx root  4096 Sep  8 17:51 &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¸º Pod é…ç½®å·è®¿é—®æƒé™å’Œå±ä¸»å˜æ›´ç­–ç•¥&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;FEATURE STATE: Kubernetes v1.18 [alpha]&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetes åœ¨æŒ‚è½½ä¸€ä¸ªå·æ—¶ï¼Œä¼šé€’å½’åœ°æ›´æ”¹æ¯ä¸ªå·ä¸­çš„å†…å®¹çš„å±ä¸»å’Œè®¿é—®æƒé™ï¼Œä½¿ä¹‹ä¸ Pod çš„ &lt;code&gt;securityContext&lt;/code&gt; ä¸­æŒ‡å®šçš„ &lt;code&gt;fsGroup&lt;/code&gt; åŒ¹é…ã€‚ å¯¹äºè¾ƒå¤§çš„æ•°æ®å·ï¼Œæ£€æŸ¥å’Œå˜æ›´å±ä¸»ä¸è®¿é—®æƒé™å¯èƒ½ä¼šèŠ±è´¹å¾ˆé•¿æ—¶é—´ï¼Œé™ä½ Pod å¯åŠ¨é€Ÿåº¦ã€‚ ä½ å¯ä»¥åœ¨ &lt;code&gt;securityContext&lt;/code&gt; ä¸­ä½¿ç”¨ &lt;code&gt;fsGroupChangePolicy&lt;/code&gt; å­—æ®µæ¥æ§åˆ¶ Kubernetes æ£€æŸ¥å’Œç®¡ç†å·å±ä¸»å’Œè®¿é—®æƒé™çš„æ–¹å¼ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;fsGroupChangePolicy&lt;/strong&gt; - &lt;code&gt;fsGroupChangePolicy&lt;/code&gt; å®šä¹‰åœ¨å·è¢«æš´éœ²ç»™ Pod å†…éƒ¨ä¹‹å‰å¯¹å…¶ å†…å®¹çš„å±ä¸»å’Œè®¿é—®è®¸å¯è¿›è¡Œå˜æ›´çš„è¡Œä¸ºã€‚æ­¤å­—æ®µä»…é€‚ç”¨äºé‚£äº›æ”¯æŒä½¿ç”¨ &lt;code&gt;fsGroup&lt;/code&gt; æ¥ æ§åˆ¶å±ä¸»ä¸è®¿é—®æƒé™çš„å·ç±»å‹ã€‚æ­¤å­—æ®µçš„å–å€¼å¯ä»¥æ˜¯ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;OnRootMismatch&lt;/code&gt;ï¼šåªæœ‰æ ¹ç›®å½•çš„å±ä¸»ä¸è®¿é—®æƒé™ä¸å·æ‰€æœŸæœ›çš„æƒé™ä¸ä¸€è‡´æ—¶ï¼Œæ‰æ”¹å˜å…¶ä¸­å†…å®¹çš„å±ä¸»å’Œè®¿é—®æƒé™ã€‚è¿™ä¸€è®¾ç½®æœ‰åŠ©äºç¼©çŸ­æ›´æ”¹å·çš„å±ä¸»ä¸è®¿é—®æƒé™æ‰€éœ€è¦çš„æ—¶é—´ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Always&lt;/code&gt;ï¼šåœ¨æŒ‚è½½å·æ—¶æ€»æ˜¯æ›´æ”¹å·ä¸­å†…å®¹çš„å±ä¸»å’Œè®¿é—®æƒé™ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;securityContext:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  runAsUser:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  runAsGroup:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  fsGroup:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  fsGroupChangePolicy:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;OnRootMismatch&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;è¿™æ˜¯ä¸€ä¸ª Alpha é˜¶æ®µçš„åŠŸèƒ½ç‰¹æ€§ã€‚è¦ä½¿ç”¨æ­¤ç‰¹æ€§ï¼Œéœ€è¦åœ¨ kube-apiserverã€kube-controller-manager å’Œ kubelet ä¸Šå¯ç”¨ ConfigurableFSGroupPolicy &lt;a href=&quot;https://kubernetes.io/zh/docs/reference/command-line-tools-reference/feature-gates/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ç‰¹æ€§é—¨æ§&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;h3 id=&quot;åœºæ™¯äºŒï¼šæˆ‘éœ€è¦å¯¹å¯åŠ¨çš„å®¹å™¨ä½¿ç”¨sysctlä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œæ¯”å¦‚esè¿™ç±»å®¹å™¨é•œåƒã€‚&quot;&gt;&lt;a href=&quot;#åœºæ™¯äºŒï¼šæˆ‘éœ€è¦å¯¹å¯åŠ¨çš„å®¹å™¨ä½¿ç”¨sysctlä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œæ¯”å¦‚esè¿™ç±»å®¹å™¨é•œåƒã€‚&quot; class=&quot;headerlink&quot; title=&quot;åœºæ™¯äºŒï¼šæˆ‘éœ€è¦å¯¹å¯åŠ¨çš„å®¹å™¨ä½¿ç”¨sysctlä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œæ¯”å¦‚esè¿™ç±»å®¹å™¨é•œåƒã€‚&quot;&gt;&lt;/a&gt;åœºæ™¯äºŒï¼šæˆ‘éœ€è¦å¯¹å¯åŠ¨çš„å®¹å™¨ä½¿ç”¨sysctlä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œæ¯”å¦‚esè¿™ç±»å®¹å™¨é•œåƒã€‚&lt;/h3&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; apps/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; StatefulSet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; sc-demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  template:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; sc-demo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      image:&lt;/span&gt; xxxxxx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      command:&lt;/span&gt; [ &lt;span class=&quot;string&quot;&gt;&quot;sh&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;-c&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;sleep 1h&quot;&lt;/span&gt; ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      securityContext:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        privileged:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ç»™äºˆ &lt;code&gt;privileged: true&lt;/code&gt; æ˜¯ä¸€ä¸ªæ¯”è¾ƒç²—çš„æƒé™ï¼Œä¸€èˆ¬ä¸å»ºè®®å¦‚æ­¤ï¼Œå¯ä»¥ä¸ºæƒé™å®šä¹‰æ›´ç»†ç²’åº¦çš„æƒé™ï¼Œç±»ä¼¼éœ€è¦åœ¨å®¹å™¨ä¸­ä½¿ç”¨ &lt;code&gt;perf&lt;/code&gt; å‘½ä»¤ï¼Œåˆ™å¯ä»¥è¿›è¡Œå¦‚ä¸‹å®šä¹‰ï¼š&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;securityContext:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    capabilities:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        add:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;SYS_ADMIN&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å…·ä½“ &lt;code&gt;capabilities&lt;/code&gt; çš„ä½¿ç”¨è§„åˆ™å¯å‚è€ƒï¼š&lt;a href=&quot;http://team.jiunile.com/blog/2019/12/capabilities.html&quot;&gt;åœ¨ Kubernetes ä¸­é…ç½® Container Capabilities&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;åœºæ™¯ä¸‰ï¼šæˆ‘éœ€è¦å¯¹å¯åŠ¨çš„å®¹å™¨èµ‹äºˆSELinuxæ ‡ç­¾&quot;&gt;&lt;a href=&quot;#åœºæ™¯ä¸‰ï¼šæˆ‘éœ€è¦å¯¹å¯åŠ¨çš„å®¹å™¨èµ‹äºˆSELinuxæ ‡ç­¾&quot; class=&quot;headerlink&quot; title=&quot;åœºæ™¯ä¸‰ï¼šæˆ‘éœ€è¦å¯¹å¯åŠ¨çš„å®¹å™¨èµ‹äºˆSELinuxæ ‡ç­¾&quot;&gt;&lt;/a&gt;åœºæ™¯ä¸‰ï¼šæˆ‘éœ€è¦å¯¹å¯åŠ¨çš„å®¹å™¨èµ‹äºˆSELinuxæ ‡ç­¾&lt;/h3&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;securityContext:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  seLinuxOptions:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    level:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;s0:c123,c456&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;è¦æŒ‡å®š SELinuxï¼Œéœ€è¦åœ¨å®¿ä¸»æ“ä½œç³»ç»Ÿä¸­è£…è½½ SELinux å®‰å…¨æ€§æ¨¡å—ã€‚&lt;code&gt;seLinuxOptions&lt;/code&gt; å­—æ®µçš„å–å€¼æ˜¯ä¸€ä¸ª &lt;a href=&quot;https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#selinuxoptions-v1-core&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;SELinuxOptions&lt;/a&gt; å¯¹è±¡&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å‚è€ƒ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.io/zh/docs/tasks/configure-pod-container/security-context/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/zh/docs/tasks/configure-pod-container/security-context/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;å¾®ä¿¡è®¢é˜…å·&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;kubernetes ä¸­çš„ &lt;code&gt;securityContext&lt;/code&gt; æ˜¯ä»€ä¹ˆï¼Ÿåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹æ¥ä½¿ç”¨ï¼Ÿç¬¬ä¸€æ„Ÿè§‰åæ­£æ˜¯å’Œå®‰å…¨ç›¸å…³çš„ä¸œè¥¿ï¼Œæ¥è‡ªå®˜æ–¹å®šä¹‰å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆSecurity Contextï¼‰å®šä¹‰ Pod æˆ– Container çš„ç‰¹æƒä¸è®¿é—®æ§åˆ¶è®¾ç½®ã€‚ å®‰å…¨ä¸Šä¸‹æ–‡åŒ…æ‹¬ä½†ä¸é™äºï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è‡ªä¸»è®¿é—®æ§åˆ¶ï¼ˆDiscretionary Access Controlï¼‰ï¼šåŸºäº ç”¨æˆ· IDï¼ˆUIDï¼‰å’Œç»„ IDï¼ˆGIDï¼‰. æ¥åˆ¤å®šå¯¹å¯¹è±¡ï¼ˆä¾‹å¦‚æ–‡ä»¶ï¼‰çš„è®¿é—®æƒé™&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://zh.wikipedia.org/wiki/%E5%AE%89%E5%85%A8%E5%A2%9E%E5%BC%BA%E5%BC%8FLinux&quot;&gt;å®‰å…¨æ€§å¢å¼ºçš„ Linuxï¼ˆSELinuxï¼‰&lt;/a&gt;ï¼š ä¸ºå¯¹è±¡èµ‹äºˆå®‰å…¨æ€§æ ‡ç­¾ã€‚&lt;/li&gt;
&lt;li&gt;ä»¥ç‰¹æƒæ¨¡å¼æˆ–è€…éç‰¹æƒæ¨¡å¼è¿è¡Œã€‚&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://linux-audit.com/linux-capabilities-hardening-linux-binaries-by-removing-setuid/&quot;&gt;Linux æƒèƒ½&lt;/a&gt;: ä¸ºè¿›ç¨‹èµ‹äºˆ root ç”¨æˆ·çš„éƒ¨åˆ†ç‰¹æƒè€Œéå…¨éƒ¨ç‰¹æƒã€‚&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.io/zh/docs/tutorials/clusters/apparmor/&quot;&gt;AppArmor&lt;/a&gt;ï¼šä½¿ç”¨ç¨‹åºæ–‡ä»¶æ¥é™åˆ¶å•ä¸ªç¨‹åºçš„æƒé™ã€‚&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Seccomp&quot;&gt;Seccomp&lt;/a&gt;ï¼šé™åˆ¶ä¸€ä¸ªè¿›ç¨‹è®¿é—®æ–‡ä»¶æè¿°ç¬¦çš„æƒé™ã€‚&lt;/li&gt;
&lt;li&gt;AllowPrivilegeEscalationï¼šæ§åˆ¶è¿›ç¨‹æ˜¯å¦å¯ä»¥è·å¾—è¶…å‡ºå…¶çˆ¶è¿›ç¨‹çš„ç‰¹æƒã€‚ æ­¤å¸ƒå°”å€¼ç›´æ¥æ§åˆ¶æ˜¯å¦ä¸ºå®¹å™¨è¿›ç¨‹è®¾ç½® &lt;a href=&quot;https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt&quot;&gt;no_new_privs&lt;/a&gt; æ ‡å¿—ã€‚ å½“å®¹å™¨ä»¥ç‰¹æƒæ¨¡å¼è¿è¡Œæˆ–è€…å…·æœ‰ &lt;code&gt;CAP_SYS_ADMIN&lt;/code&gt; æƒèƒ½æ—¶ï¼ŒAllowPrivilegeEscalation æ€»æ˜¯ä¸º &lt;strong&gt;&lt;code&gt;true&lt;/code&gt;&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;li&gt;readOnlyRootFilesystemï¼šä»¥åªè¯»æ–¹å¼åŠ è½½å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»¥ä¸Šæ¡ç›®ä¸æ˜¯å®‰å…¨ä¸Šä¸‹æ–‡è®¾ç½®çš„å®Œæ•´åˆ—è¡¨ â€“ è¯·å‚é˜… &lt;a href=&quot;https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#securitycontext-v1-core&quot;&gt;SecurityContext&lt;/a&gt; äº†è§£å…¶å®Œæ•´åˆ—è¡¨ã€‚&lt;/p&gt;
&lt;p&gt;å…³äºåœ¨ Linux ç³»ç»Ÿä¸­çš„å®‰å…¨æœºåˆ¶çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚é˜… &lt;a href=&quot;https://www.linux.com/learn/overview-linux-kernel-security-features&quot;&gt;Linux å†…æ ¸å®‰å…¨æ€§èƒ½åŠ›æ¦‚è¿°&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ä¸Šé¢çš„å®šä¹‰æœ‰äº›ä¼¼æ‡‚éæ‡‚ï¼Œèƒ½ä¸èƒ½æ›´åŠ ç›´ç™½çš„æè¿°ä¸‹å‘¢ï¼Ÿå¥½å§ï¼Œä¸‹é¢æ¥ç»™å¤§å®¶æ¥ä¸€äº›å®é™…çš„åº”ç”¨åœºæ™¯æ¥è®²è§£ä¸‹ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="kubrenetes" scheme="http://team.jiunile.com/categories/kubrenetes/"/>
    
      <category term="securityContext" scheme="http://team.jiunile.com/categories/kubrenetes/securityContext/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/tags/kubernetes/"/>
    
      <category term="securityContext" scheme="http://team.jiunile.com/tags/securityContext/"/>
    
      <category term="å®‰å…¨ä¸Šä¸‹æ–‡" scheme="http://team.jiunile.com/tags/%E5%AE%89%E5%85%A8%E4%B8%8A%E4%B8%8B%E6%96%87/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes in Kuberntes</title>
    <link href="http://team.jiunile.com//blog/2020/06/k8s-k8s-in-k8s.html"/>
    <id>http://team.jiunile.com//blog/2020/06/k8s-k8s-in-k8s.html</id>
    <published>2020-06-12T12:00:00.000Z</published>
    <updated>2020-06-12T05:58:14.000Z</updated>
    
    <content type="html">&lt;p&gt;&lt;code&gt;KinD&lt;/code&gt; æ˜¯ä¸€ä¸ªéå¸¸è½»é‡çº§çš„ Kubernetes å®‰è£…å·¥å…·ï¼Œä»–å°† Docker å®¹å™¨å½“æˆ Kubernetes çš„èŠ‚ç‚¹ï¼Œä½¿ç”¨éå¸¸æ–¹ä¾¿ã€‚æ—¢ç„¶åœ¨ Docker å®¹å™¨ä¸­å¯ä»¥è¿è¡Œ Kubernetes é›†ç¾¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶å°±ä¼šæƒ³åˆ°æ˜¯å¦å¯ä»¥åœ¨ Pod ä¸­æ¥è¿è¡Œå‘¢ï¼Ÿåœ¨ Pod ä¸­è¿è¡Œä¼šé‡åˆ°å“ªäº›é—®é¢˜å‘¢ï¼Ÿ&lt;/p&gt;
&lt;h2 id=&quot;åœ¨-Pod-ä¸­å®‰è£…-Docker-Daemon&quot;&gt;&lt;a href=&quot;#åœ¨-Pod-ä¸­å®‰è£…-Docker-Daemon&quot; class=&quot;headerlink&quot; title=&quot;åœ¨ Pod ä¸­å®‰è£… Docker Daemon&quot;&gt;&lt;/a&gt;åœ¨ Pod ä¸­å®‰è£… Docker Daemon&lt;/h2&gt;&lt;p&gt;&lt;code&gt;KIND&lt;/code&gt; å½“å‰ä¾èµ–äº Dockerï¼ˆå°½ç®¡ä»–ä»¬è®¡åˆ’å¾ˆå¿«æ”¯æŒå…¶ä»–å®¹å™¨è¿è¡Œæ—¶ï¼Œä¾‹å¦‚&lt;code&gt;podman&lt;/code&gt;ï¼‰ã€‚å› æ­¤ï¼Œç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ªå®¹å™¨æ˜ åƒï¼Œè¯¥æ˜ åƒå…è®¸æ‚¨åœ¨ Pod å†…è¿è¡Œ Dockerå®ˆæŠ¤ç¨‹åºï¼Œä»¥ä¾¿ä½¿è¯¸å¦‚&lt;code&gt;docker run&lt;/code&gt;ä¹‹ç±»çš„å‘½ä»¤åœ¨Podå†…è¿è¡Œï¼ˆåˆå Docker-in-Docker æˆ– DIND ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;Docker-in-Docker æ˜¯ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„é—®é¢˜ï¼Œå¹¶ä¸”å·²ç»è§£å†³äº†ç›¸å½“ä¸€æ®µæ—¶é—´ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå½“å°è¯•åœ¨ç”Ÿäº§ Kubernetes é›†ç¾¤ä¸­æ­£ç¡®è®¾ç½® Docker-in-Docker æ—¶ï¼Œæˆ‘ä»¬ä»ç„¶é‡åˆ°å¾ˆå¤šé—®é¢˜ã€‚&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;MTUé—®é¢˜&quot;&gt;&lt;a href=&quot;#MTUé—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;MTUé—®é¢˜&quot;&gt;&lt;/a&gt;MTUé—®é¢˜&lt;/h3&gt;&lt;p&gt;MTU é—®é¢˜çš„æ€§è´¨å®é™…ä¸Šå–å†³äºç”Ÿäº§ Kubernetes é›†ç¾¤çš„ç½‘ç»œæä¾›å•†ã€‚æˆ‘ä»¬ç”¨äº CI çš„Kubernetes å‘è¡Œç‰ˆæ˜¯ &lt;a href=&quot;https://d2iq.com/solutions/ksphere/konvoy&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Konvoy&lt;/a&gt;ã€‚Konvoy ä½¿ç”¨&lt;code&gt;Calico&lt;/code&gt;ä½œä¸ºå…¶é»˜è®¤ç½‘ç»œæä¾›å•†ï¼Œå¹¶ä¸”é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨&lt;code&gt;IPIP&lt;/code&gt;å°è£…ã€‚&lt;code&gt;IPIP&lt;/code&gt;å°è£…äº§ç”Ÿ20å­—èŠ‚çš„å¼€é”€ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœç¾¤é›†ä¸­ä¸»æœºç½‘ç»œçš„ä¸»ç½‘ç»œæ¥å£çš„&lt;code&gt;MTU&lt;/code&gt;ä¸º1500ï¼Œåˆ™Podä¸­ç½‘ç»œæ¥å£çš„&lt;code&gt;MTU&lt;/code&gt;å°†ä¸º1480ã€‚å¦‚æœæ‚¨çš„ç”Ÿäº§ç¾¤é›†åœ¨æŸäº›äº‘æä¾›å•†ï¼ˆä¾‹å¦‚GCEï¼‰ä¸Šè¿è¡Œï¼Œåˆ™&lt;code&gt;MTU Pod&lt;/code&gt;çš„æœ€å¤§å€¼ç”šè‡³æ›´ä½ï¼ˆ1460-20 = 1440ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨ Pod å†…é…ç½®é»˜è®¤ Docker ç½‘ç»œçš„&lt;code&gt;MTU&lt;/code&gt;ï¼ˆ&lt;code&gt;dockerd&lt;/code&gt; çš„ &lt;code&gt;--mtu&lt;/code&gt;æ ‡å¿—ï¼‰ï¼Œä½¿å…¶ç­‰äºæˆ–å°äº Pod çš„ç½‘ç»œæ¥å£çš„&lt;code&gt;MTU&lt;/code&gt;ã€‚å¦åˆ™ï¼Œæ‚¨å°†æ— æ³•ä¸å¤–ç•Œå»ºç«‹è¿æ¥ï¼ˆä¾‹å¦‚ï¼Œä»äº’è”ç½‘ä¸Šè·å–å®¹å™¨å›¾åƒæ—¶ï¼‰ã€‚&lt;/p&gt;
&lt;h3 id=&quot;PID-1-çš„é—®é¢˜&quot;&gt;&lt;a href=&quot;#PID-1-çš„é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;PID 1 çš„é—®é¢˜&quot;&gt;&lt;/a&gt;PID 1 çš„é—®é¢˜&lt;/h3&gt;&lt;p&gt;æ¯”å¦‚æˆ‘ä»¬éœ€è¦åœ¨ä¸€ä¸ªå®¹å™¨ä¸­å»è¿è¡Œ &lt;code&gt;Docker Daemon&lt;/code&gt; ä»¥åŠä¸€äº› Kubernetes çš„é›†ç¾¤æµ‹è¯•ï¼Œè€Œè¿™äº›æµ‹è¯•ä¾èµ–äº &lt;code&gt;KinD&lt;/code&gt; å’Œ &lt;code&gt;Docker Damon&lt;/code&gt;ï¼Œåœ¨ä¸€ä¸ªå®¹å™¨ä¸­è¿è¡Œå¤šä¸ªæœåŠ¡æˆ‘ä»¬å¯èƒ½ä¼šå»ä½¿ç”¨ &lt;code&gt;systemd&lt;/code&gt;ï¼Œä½†æ˜¯ä½¿ç”¨ &lt;code&gt;systemd&lt;/code&gt; ä¹Ÿä¼šæœ‰ä¸€äº›é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚æˆ‘ä»¬éœ€è¦ä¿ç•™æµ‹è¯•çš„é€€å‡ºçŠ¶æ€ï¼ŒKubernetes ä¸­ä½¿ç”¨çš„å®¹å™¨è¿è¡Œæ—¶å¯ä»¥ watch åˆ°å®¹å™¨ä¸­çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ˆPID 1ï¼‰çš„é€€å‡ºçŠ¶æ€ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨ &lt;code&gt;systemd&lt;/code&gt; çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬æµ‹è¯•çš„è¿›ç¨‹é€€å‡ºçŠ¶æ€ä¸ä¼šè¢«è½¬å‘åˆ° Kubernetesã€‚&lt;/p&gt;
&lt;p&gt;æ­¤å¤–è·å–æµ‹è¯•çš„æ—¥å¿—ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ï¼Œåœ¨ Kubernetes ä¸­ä¼šè‡ªåŠ¨è·å–å†™å…¥åˆ° stdout å’Œ stderr çš„å®¹å™¨æ—¥å¿—ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨ &lt;code&gt;systemd&lt;/code&gt; çš„è¯ï¼Œè¦æƒ³è·å–åº”ç”¨çš„æ—¥å¿—å°±æ¯”è¾ƒéº»çƒ¦çš„ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å®¹å™¨é•œåƒä¸­ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„å¯åŠ¨è„šæœ¬ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;dockerd &amp;amp;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Wait until dockerd is ready.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;until docker ps &amp;gt;/dev/null 2&amp;gt;&amp;amp;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Waiting for dockerd...&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  sleep 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&lt;span class=&quot;variable&quot;&gt;$@&lt;/span&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬ä¸èƒ½å°†ä¸Šé¢çš„è„šæœ¬ä½œä¸ºå®¹å™¨çš„ entrypointï¼Œåœ¨é•œåƒä¸­å®šä¹‰çš„ entrypoint ä¼šåœ¨å®¹å™¨ä¸­ä»¥ PID 1 çš„å½¢å¼è¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„ &lt;code&gt;pid namespace&lt;/code&gt; ä¸­ã€‚PID 1 æ˜¯ä¸€ä¸ªå†…æ ¸ä¸­çš„ä¸€ä¸ªç‰¹æ®Šè¿›ç¨‹ï¼Œå®ƒçš„è¡Œä¸ºå’Œå…¶ä»–è¿›ç¨‹ä¸åŒã€‚&lt;/p&gt;
&lt;p&gt;æœ¬è´¨ä¸Šï¼Œæ¥æ”¶ä¿¡å·çš„è¿›ç¨‹æ˜¯ PID 1ï¼šå®ƒä¼šè¢«å†…æ ¸åšç‰¹æ®Šå¤„ç†ï¼›å¦‚æœå®ƒæ²¡æœ‰ä¸ºä¿¡å·æ³¨å†Œä¸€ä¸ªå¤„ç†å™¨ï¼Œå†…æ ¸å°±ä¸ä¼šå›åˆ°é»˜è®¤è¡Œä¸ºï¼ˆå³æ€æ­»è¿›ç¨‹ï¼‰ã€‚ç”±äºå½“æ”¶åˆ° SIGTERM ä¿¡å·æ—¶ï¼Œå†…æ ¸ä¼šé»˜è®¤æ€æ­»è¿™ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥ä¸€äº›è¿›ç¨‹ä¹Ÿè®¸ä¸ä¼šä¸º SIGTERM ä¿¡å·æ³¨å†Œä¿¡å·å¤„ç†ç¨‹åºã€‚å¦‚æœå‡ºç°äº†è¿™ç§æƒ…å†µï¼Œå½“ Kubernetes å°è¯•ç»ˆæ­¢ Pod æ—¶ï¼ŒSIGTERM å°†è¢«åå™¬ï¼Œä½ ä¼šæ³¨æ„åˆ° Pod ä¼šè¢«å¡åœ¨ Terminating çš„çŠ¶æ€ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;è¿™å…¶å®ä¸æ˜¯ä¸€ä¸ªä»€ä¹ˆæ–°é²œçš„é—®é¢˜ï¼Œä½†æ˜¯äº†è§£è¿™ä¸ªé—®é¢˜çš„äººå´å¹¶ä¸å¤šï¼Œè€Œä¸”è¿˜ä¸€ç›´åœ¨æ„å»ºæœ‰è¿™æ ·é—®é¢˜çš„å®¹å™¨ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ tini è¿™ä¸ªåº”ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°†å…¶ä½œä¸ºé•œåƒçš„å…¥å£ç‚¹ï¼Œå¦‚åœ¨ &lt;code&gt;Dockerfile&lt;/code&gt; ä¸­æ‰€ç¤ºï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ENTRYPOINT [&lt;span class=&quot;string&quot;&gt;&quot;/usr/bin/tini&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;--&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;/entrypoint.sh&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªç¨‹åºä¼šæ­£ç¡®æ³¨å†Œä¿¡å·å¤„ç†ç¨‹åºå’Œè½¬å‘ä¿¡å·ã€‚å®ƒè¿˜ä¼šæ‰§è¡Œä¸€äº›å…¶ä»– PID 1 çš„äº‹æƒ…ï¼Œæ¯”å¦‚å›æ”¶å®¹å™¨ä¸­çš„åƒµå°¸è¿›ç¨‹ã€‚&lt;/p&gt;
&lt;h3 id=&quot;æŒ‚è½½-cgroups&quot;&gt;&lt;a href=&quot;#æŒ‚è½½-cgroups&quot; class=&quot;headerlink&quot; title=&quot;æŒ‚è½½ cgroups&quot;&gt;&lt;/a&gt;æŒ‚è½½ cgroups&lt;/h3&gt;&lt;p&gt;ç”±äº &lt;code&gt;Docker Daemon&lt;/code&gt; éœ€è¦æ§åˆ¶ cgroupsï¼Œæ‰€ä»¥éœ€è¦å°† cgroup æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°å®¹å™¨ä¸­å»ã€‚ä½†æ˜¯ç”±äº cgroups å’Œå®¿ä¸»æœºæ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¡®ä¿ &lt;code&gt;Docker Daemon&lt;/code&gt; æ§åˆ¶çš„ cgroups ä¸ä¼šå½±å“åˆ°å…¶ä»–å®¹å™¨æˆ–è€…å®¿ä¸»æœºè¿›ç¨‹ä½¿ç”¨çš„å…¶ä»– cgroupsï¼Œè¿˜éœ€è¦ç¡®ä¿ &lt;code&gt;Docker Daemon&lt;/code&gt; åœ¨å®¹å™¨ä¸­åˆ›å»ºçš„ cgroups åœ¨å®¹å™¨é€€å‡ºåä¸ä¼šè¢«æ³„éœ²ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Docker Daemon&lt;/code&gt; ä¸­æœ‰ä¸€ä¸ª &lt;code&gt;--cgroupâ€”parent&lt;/code&gt; å‚æ•°æ¥å‘Šè¯‰ Daemon å°†æ‰€æœ‰å®¹å™¨çš„ cgroups åµŒå¥—åœ¨æŒ‡å®šçš„ cgroup ä¸‹é¢ã€‚å½“å®¹å™¨è¿è¡Œåœ¨ Kubernetes é›†ç¾¤ä¸‹é¢æ—¶ï¼Œæˆ‘ä»¬åœ¨å®¹å™¨ä¸­è®¾ç½® &lt;code&gt;Docker Daemon&lt;/code&gt; çš„ &lt;code&gt;--cgroupâ€”parent&lt;/code&gt; å‚æ•°ï¼Œè¿™æ ·å®ƒçš„æ‰€æœ‰ cgroups å°±ä¼šè¢«åµŒå¥—åœ¨ Kubernetes ä¸ºå®¹å™¨åˆ›å»ºçš„ cgroup ä¸‹é¢äº†ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ä»¥å‰ä¸ºäº†è®© cgroup æ–‡ä»¶ç³»ç»Ÿåœ¨å®¹å™¨ä¸­å¯ç”¨ï¼Œä¸€äº›ç”¨æˆ·ä¼šå°†å®¿ä¸»æœºä¸­çš„ &lt;code&gt;/sys/fs/cgroup&lt;/code&gt; æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„è¿™ä¸ªä½ç½®ï¼Œå¦‚æœè¿™æ ·ä½¿ç”¨çš„è¯ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨å®¹å™¨å¯åŠ¨è„šæœ¬ä¸­æŠŠ &lt;code&gt;--cgroupâ€”parent&lt;/code&gt; è®¾ç½®ä¸ºä¸‹é¢çš„å†…å®¹ï¼Œè¿™æ · &lt;code&gt;Docker Daemon&lt;/code&gt; åˆ›å»ºçš„ cgroups å°±å¯ä»¥æ­£ç¡®è¢«åµŒå¥—äº†ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;CGROUP_PARENT=&lt;span class=&quot;string&quot;&gt;&quot;&lt;span class=&quot;variable&quot;&gt;$(grep systemd /proc/self/cgroup | cut -d: -f3)&lt;/span&gt;/docker&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æ³¨æ„ï¼š&lt;code&gt;/proc/self/cgroup&lt;/code&gt; æ˜¾ç¤ºçš„æ˜¯è°ƒç”¨è¿›ç¨‹çš„ cgroup è·¯å¾„ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä½†æ˜¯æˆ‘ä»¬è¦çŸ¥é“ï¼ŒæŒ‚è½½å®¿ä¸»æœºçš„ &lt;code&gt;/sys/fs/cgroup&lt;/code&gt; æ–‡ä»¶æ˜¯éå¸¸å±é™©çš„äº‹æƒ…ï¼Œå› ä¸ºä»–æŠŠæ•´ä¸ªå®¿ä¸»æœºçš„ cgroup å±‚æ¬¡ç»“æ„éƒ½æš´éœ²ç»™äº†å®¹å™¨ã€‚ä»¥å‰ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒDocker ç”¨äº†ä¸€ä¸ªå°æŠ€å·§æŠŠä¸ç›¸å…³çš„ cgroups éšè—èµ·æ¥ï¼Œä¸è®©å®¹å™¨çœ‹åˆ°ã€‚Docker ä»å®¹å™¨çš„ cgroups å¯¹æ¯ä¸ª cgroup ç³»ç»Ÿçš„ cgroup å±‚æ¬¡ç»“æ„çš„æ ¹éƒ¨è¿›è¡Œç»‘å®šæŒ‚è½½ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ docker run --rm debian findmnt -lo &lt;span class=&quot;built_in&quot;&gt;source&lt;/span&gt;,target -t cgroup&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SOURCE                                                                               TARGET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cpuset[/docker/451b803b3&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;7&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;2b69dde64&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;833fdd799ae16f9d2d942386ec382f6d55bffac]     /sys/fs/cgroup/cpuset&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cpu[/docker/451b803b3&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;7&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;2b69dde64&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;833fdd799ae16f9d2d942386ec382f6d55bffac]        /sys/fs/cgroup/cpu&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cpuacct[/docker/451b803b3&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;7&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;2b69dde64&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;833fdd799ae16f9d2d942386ec382f6d55bffac]    /sys/fs/cgroup/cpuacct&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;blkio[/docker/451b803b3&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;7&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;2b69dde64&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;833fdd799ae16f9d2d942386ec382f6d55bffac]     /sys/fs/cgroup/blkio&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;memory[/docker/451b803b3&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;7&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;2b69dde64&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;833fdd799ae16f9d2d942386ec382f6d55bffac]     /sys/fs/cgroup/memory&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cgroup[/docker/451b803b3&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;7&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;2b69dde64&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt;833fdd799ae16f9d2d942386ec382f6d55bffac]     /sys/fs/cgroup/systemd&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡º cgroups é€šè¿‡å°†å®¿ä¸»æœº cgroup æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ &lt;code&gt;/sys/fs/cgroup/memory/memory.limit_in_bytes&lt;/code&gt; æ–‡ä»¶æ˜ å°„åˆ° &lt;code&gt;/sys/fs/cgroup/memory/docker/&amp;lt;CONTAINER_ID&amp;gt;/memory.limit_in_bytes&lt;/code&gt; æ¥æ§åˆ¶å®¹å™¨å†… cgroup å±‚æ¬¡ç»“æ„æ ¹éƒ¨çš„æ–‡ä»¶ï¼Œè¿™ç§æ–¹å¼å¯ä»¥é˜²æ­¢å®¹å™¨è¿›ç¨‹æ„å¤–åœ°ä¿®æ”¹å®¿ä¸»æœºçš„ cgroupã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯è¿™ç§æ–¹å¼æœ‰æ—¶å€™ä¼šè®© cadvisor å’Œ kubelet è¿™æ ·çš„åº”ç”¨æ„ŸåŠ¨å›°æƒ‘ï¼Œå› ä¸ºç»‘å®šæŒ‚è½½å¹¶ä¸ä¼šæ”¹å˜ &lt;code&gt;/proc/&amp;lt;PID&amp;gt;/cgroup&lt;/code&gt; é‡Œé¢çš„å†…å®¹ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ docker run --rm debian cat /proc/1/cgroup&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14:name=systemd:/docker/512f6b62e3963f85f5abc09b69c370d27ab1dc56549fa8afcbb86eec8663a141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5:memory:/docker/512f6b62e3963f85f5abc09b69c370d27ab1dc56549fa8afcbb86eec8663a141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4:blkio:/docker/512f6b62e3963f85f5abc09b69c370d27ab1dc56549fa8afcbb86eec8663a141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3:cpuacct:/docker/512f6b62e3963f85f5abc09b69c370d27ab1dc56549fa8afcbb86eec8663a141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2:cpu:/docker/512f6b62e3963f85f5abc09b69c370d27ab1dc56549fa8afcbb86eec8663a141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1:cpuset:/docker/512f6b62e3963f85f5abc09b69c370d27ab1dc56549fa8afcbb86eec8663a141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;0::/&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;cadvisor ä¼šé€šè¿‡æŸ¥çœ‹ &lt;code&gt;/proc/&amp;lt;PID&amp;gt;/cgroup&lt;/code&gt; æ¥è·å–ç»™å®šè¿›ç¨‹çš„ cgroupï¼Œå¹¶å°è¯•ä»å¯¹åº”çš„ cgroup ä¸­è·å– CPU æˆ–å†…å­˜ç»Ÿè®¡æ•°æ®ã€‚ä½†æ˜¯ç”±äº &lt;code&gt;Docker Daemon&lt;/code&gt; è¿›ç¨‹åšäº†ç»‘å®šæŒ‚è½½ï¼Œcadvisor å°±æ— æ³•æ‰¾åˆ°å®¹å™¨è¿›ç¨‹å¯¹åº”çš„ cgroupã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åœ¨å®¹å™¨å†…éƒ¨åˆåšäº†ä¸€æ¬¡æŒ‚è½½ï¼Œä» &lt;code&gt;/sys/fs/cgroup/memory&lt;/code&gt; æŒ‚è½½åˆ° &lt;code&gt;/sys/fs/cgroup/memory/docker/&amp;lt;CONTAINER_ID&amp;gt;/&lt;/code&gt;ï¼ˆé’ˆå¯¹æ‰€æœ‰çš„ cgroup å­ç³»ç»Ÿï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;ç°åœ¨æ–°çš„è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨ &lt;code&gt;cgroup namespace&lt;/code&gt;ï¼Œå¦‚æœä½ è¿è¡Œåœ¨ä¸€ä¸ªå†…æ ¸ç‰ˆæœ¬ 4.6+ çš„ Linux ç³»ç»Ÿä¸‹é¢ï¼Œrunc å’Œ docker éƒ½åŠ å…¥äº† cgroup å‘½åç©ºé—´çš„æ”¯æŒã€‚ä½†æ˜¯ç›®å‰ Kubernetes æš‚æ—¶è¿˜ä¸æ”¯æŒ cgroup å‘½åç©ºé—´ï¼Œä½†æ˜¯å¾ˆå¿«ä¼šä½œä¸º &lt;code&gt;cgroups v2&lt;/code&gt; æ”¯æŒçš„ä¸€éƒ¨åˆ†ã€‚&lt;/p&gt;
&lt;h3 id=&quot;IPtables&quot;&gt;&lt;a href=&quot;#IPtables&quot; class=&quot;headerlink&quot; title=&quot;IPtables&quot;&gt;&lt;/a&gt;IPtables&lt;/h3&gt;&lt;p&gt;åœ¨ä½¿ç”¨çš„æ—¶å€™æˆ‘ä»¬å‘ç°åœ¨çº¿ä¸Šçš„ Kubernetes é›†ç¾¤è¿è¡Œæ—¶ï¼Œæœ‰æ—¶å€™å®¹å™¨å†…çš„ &lt;code&gt;Docker Daemon&lt;/code&gt; å¯åŠ¨çš„åµŒå¥—å®¹å™¨æ— æ³•è®¿é—®å¤–ç½‘ï¼Œä½†æ˜¯åœ¨æœ¬åœ°å¼€å‘ç”µè„‘ä¸Šå´å¯ä»¥å¾ˆæ­£å¸¸çš„å·¥ä½œï¼Œå¤§éƒ¨åˆ†å¼€å‘è€…åº”è¯¥éƒ½ä¼šç»å¸¸é‡åˆ°è¿™ç§æƒ…å†µã€‚&lt;/p&gt;
&lt;p&gt;æœ€åå‘ç°å½“å‡ºç°è¿™ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œæ¥è‡ªåµŒå¥—çš„ Docker å®¹å™¨çš„æ•°æ®åŒ…å¹¶æ²¡æœ‰æ‰“åˆ° iptables çš„ POSTROUTING é“¾ï¼Œæ‰€ä»¥æ²¡æœ‰åš masqueradedã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºåŒ…å« &lt;code&gt;Docker Daemon&lt;/code&gt; çš„é•œåƒæ˜¯åŸºäº Debian buster çš„ï¼Œè€Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒDebian buster ä½¿ç”¨çš„æ˜¯ nftables ä½œä¸º iptables çš„é»˜è®¤åç«¯ï¼Œç„¶è€Œ Docker æœ¬èº«è¿˜ä¸æ”¯æŒ nftablesã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜åªéœ€è¦åœ¨å®¹å™¨é•œåƒä¸­åˆ‡æ¢åˆ° iptables å‘½ä»¤å³å¯ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;RUN update-alternatives --set iptables  /usr/sbin/iptables-legacy || &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &amp;amp;&amp;amp; \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy || &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &amp;amp;&amp;amp; \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    update-alternatives --set arptables /usr/sbin/arptables-legacy || &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å®Œæ•´çš„ Dockerfile æ–‡ä»¶å’Œå¯åŠ¨è„šæœ¬å¯ä»¥åœ¨ &lt;a href=&quot;https://github.com/jieyu/docker-images/tree/master/dind&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GitHub&lt;/a&gt; ä¸Šé¢è·å–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ &lt;code&gt;jieyu/dind-buster:v0.1.8&lt;/code&gt; è¿™ä¸ªé•œåƒæ¥æµ‹è¯•ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ docker run --rm --privileged jieyu/dind-buster:v0.1.8 docker run alpine wget baidu.com&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ Kubernetes é›†ç¾¤ä¸‹ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ Pod èµ„æºæ¸…å•éƒ¨ç½²å³å¯ï¼š&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; dind&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - image:&lt;/span&gt; jieyu/dind-buster:v0&lt;span class=&quot;number&quot;&gt;.1&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    name:&lt;/span&gt; dind&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    stdin:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    tty:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    args:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; /bin/bash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    volumeMounts:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - mountPath:&lt;/span&gt; /var/lib/docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      name:&lt;/span&gt; varlibdocker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    securityContext:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      privileged:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  volumes:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; varlibdocker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    emptyDir:&lt;/span&gt; &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;åœ¨-Pod-ä¸­è¿è¡Œ-KinD&quot;&gt;&lt;a href=&quot;#åœ¨-Pod-ä¸­è¿è¡Œ-KinD&quot; class=&quot;headerlink&quot; title=&quot;åœ¨ Pod ä¸­è¿è¡Œ KinD&quot;&gt;&lt;/a&gt;åœ¨ Pod ä¸­è¿è¡Œ KinD&lt;/h2&gt;&lt;p&gt;ä¸Šé¢æˆ‘ä»¬æˆåŠŸé…ç½®äº† Docker-in-Docker(DinD)ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥åœ¨è¯¥å®¹å™¨ä¸­ä½¿ç”¨ KinD å¯åŠ¨ Kubernetes é›†ç¾¤ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ docker run -ti --rm --privileged jieyu/dind-buster:v0.1.8 /bin/bash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Waiting &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; dockerd...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@257b543a91a5 /]&lt;span class=&quot;comment&quot;&gt;# curl -Lso ./kind https://kind.sigs.k8s.io/dl/v0.8.1/kind-$(uname)-amd64&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@257b543a91a5 /]&lt;span class=&quot;comment&quot;&gt;# chmod +x ./kind&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@257b543a91a5 /]&lt;span class=&quot;comment&quot;&gt;# mv ./kind /usr/bin/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@257b543a91a5 /]&lt;span class=&quot;comment&quot;&gt;# kind create cluster&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Creating cluster &lt;span class=&quot;string&quot;&gt;&quot;kind&quot;&lt;/span&gt; ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Ensuring node image (kindest/node:v1.18.2) ğŸ–¼&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Preparing nodes ğŸ“¦&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Writing configuration ğŸ“œ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Starting control-plane ğŸ•¹ï¸&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Installing CNI ğŸ”Œ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Installing StorageClass ğŸ’¾&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Set kubectl context to &lt;span class=&quot;string&quot;&gt;&quot;kind-kind&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;You can now use your cluster with:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl cluster-info --context kind-kind&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Have a nice day! ğŸ‘‹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@257b543a91a5 /]&lt;span class=&quot;comment&quot;&gt;# kubectl get nodes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                 STATUS   ROLES    AGE   VERSION&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind-control-plane   Ready    master   11m   v1.18.2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç”±äºæŸäº›åŸå› å¯èƒ½ä½ ç”¨ä¸Šé¢çš„å‘½ä»¤ä¸‹è½½ä¸äº† kindï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åŠæ³•æå‰ä¸‹è½½åˆ°å®¿ä¸»æœºä¸Šé¢ï¼Œç„¶åç›´æ¥æŒ‚è½½åˆ°å®¹å™¨ä¸­å»ä¹Ÿå¯ä»¥ï¼Œæˆ‘è¿™é‡Œå°† kind å’Œ kubectl å‘½ä»¤éƒ½æŒ‚è½½åˆ°å®¹å™¨ä¸­å»ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨å®¹å™¨å³å¯ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ docker run -it --rm --privileged -v /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/bin/kind:/usr/bin/kind -v /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/bin/kubectl:/usr/bin/kubectl jieyu/dind-buster:v0.1.8 /bin/bash&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/k8s/k8s_in_k8s_1.png&quot; alt=&quot;k8s-in-k8s&quot;&gt;&lt;br&gt;å¯ä»¥çœ‹åˆ°åœ¨å®¹å™¨ä¸­å¯ä»¥å¾ˆå¥½çš„ä½¿ç”¨ KinD æ¥åˆ›å»º Kubernetes é›†ç¾¤ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç›´æ¥åœ¨ Kubernetes ä¸­æ¥æµ‹è¯•ä¸€æ¬¡ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; dind.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; -ti dind /bin/bash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;root@dind:/&lt;span class=&quot;comment&quot;&gt;# curl -Lso ./kind https://kind.sigs.k8s.io/dl/v0.7.0/kind-$(uname)-amd64&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;root@dind:/&lt;span class=&quot;comment&quot;&gt;# chmod +x ./kind&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;root@dind:/&lt;span class=&quot;comment&quot;&gt;# mv ./kind /usr/bin/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;root@dind:/&lt;span class=&quot;comment&quot;&gt;# kind create cluster&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Creating cluster &lt;span class=&quot;string&quot;&gt;&quot;kind&quot;&lt;/span&gt; ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Ensuring node image (kindest/node:v1.17.0) ğŸ–¼&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Preparing nodes ğŸ“¦&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Writing configuration ğŸ“œ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ— Starting control-plane ğŸ•¹ï¸&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ERROR: failed to create cluster: failed to init node with kubeadm: &lt;span class=&quot;built_in&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;docker exec --privileged kind-control-plane kubeadm init --ignore-preflight-errors=all --config=/kind/kubeadm.conf --skip-token-print --v=6&quot;&lt;/span&gt; failed with error: &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt; status 137&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ Pod ä¸­ä½¿ç”¨ KinD æ¥åˆ›å»ºé›†ç¾¤å¤±è´¥äº†ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ KinD èŠ‚ç‚¹åµŒå¥—å®¹å™¨å†…è¿è¡Œçš„ kubelet ä¼šéšæœºæ€æ­»é¡¶å±‚å®¹å™¨å†…çš„è¿›ç¨‹ï¼Œè¿™å…¶å®è¿˜æ˜¯å’Œä¸Šé¢è®¨è®ºçš„ cgroups çš„æŒ‚è½½æœ‰å…³ã€‚&lt;/p&gt;
&lt;p&gt;ä½†å…¶å®æˆ‘è‡ªå·±åœ¨ä½¿ç”¨ v0.8.1 ç‰ˆæœ¬çš„ KinD çš„æ—¶å€™ï¼Œåœ¨ä¸Šé¢çš„ Pod ä¸­æ˜¯å¯ä»¥æ­£å¸¸åˆ›å»ºé›†ç¾¤çš„ï¼Œä¸çŸ¥é“æ˜¯å¦æ˜¯ KinD æ­å»ºçš„é›†ç¾¤æœ‰ä»€ä¹ˆç‰¹æ®Šå¤„ç†ï¼Œè¿™é‡Œéœ€è¦å†æ·±å…¥ç ”ç©¶ï¼š&lt;br&gt;&lt;img src=&quot;/images/k8s/k8s_in_k8s_2.png&quot; alt=&quot;k8s-in-k8s&quot;&gt;&lt;/p&gt;
&lt;p&gt;å¦‚æœä½ åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº†ä¸Šè¿°çš„é—®é¢˜ï¼Œåˆ™å¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹è§£å†³æ–¹æ¡ˆã€‚&lt;/p&gt;
&lt;p&gt;å½“é¡¶å±‚å®¹å™¨ï¼ˆDINDï¼‰åœ¨ Kubernetes  Pod ä¸­è¿è¡Œçš„æ—¶å€™ï¼Œå¯¹äºæ¯ä¸ª cgroup å­ç³»ç»Ÿï¼ˆæ¯”å¦‚å†…å­˜ï¼‰ï¼Œä»å®¿ä¸»æœºçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒçš„ cgroup è·¯å¾„æ˜¯ &lt;code&gt;/kubepods/burstable/&amp;lt;POD_ID&amp;gt;/&amp;lt;DIND_CID&amp;gt;&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å½“ KinD åœ¨ DIND å®¹å™¨å†…çš„åµŒå¥—èŠ‚ç‚¹å®¹å™¨å†…å¯åŠ¨ kubelet çš„æ—¶å€™ï¼Œkubelet å°†åœ¨ &lt;code&gt;/kubepods/burstable/&lt;/code&gt; ä¸‹ç›¸å¯¹äºåµŒå¥— KIND èŠ‚ç‚¹å®¹å™¨çš„æ ¹ cgroup ä¸ºå…¶ Pods æ¥æ“ä½œ cgroupã€‚ä»å®¿ä¸»æœºçš„è§’åº¦æ¥çœ‹ï¼Œcgroup è·¯å¾„å°±æ˜¯ &lt;code&gt;/kubepods/burstable/&amp;lt;POD_ID&amp;gt;/&amp;lt;DIND_CID&amp;gt;/docker/&amp;lt;KIND_CID&amp;gt;/kubepods/burstable/&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;è¿™äº›éƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯åœ¨åµŒå¥—çš„ KinD èŠ‚ç‚¹å®¹å™¨ä¸­ï¼Œæœ‰å¦ä¸€ä¸ª cgroup å­˜åœ¨äº &lt;code&gt;/kubepods/burstable/&amp;lt;POD_ID&amp;gt;/&amp;lt;DIND_CID&amp;gt;/docker/&amp;lt;DIND_CID&amp;gt;&lt;/code&gt; ä¸‹é¢ï¼Œç›¸å¯¹äºåµŒå¥—çš„ KinD èŠ‚ç‚¹å®¹å™¨çš„æ ¹ cgroupï¼Œåœ¨ kubelet å¯åŠ¨ä¹‹å‰å°±å­˜åœ¨äº†ï¼Œè¿™æ˜¯ä¸Šé¢æˆ‘ä»¬è®¨è®ºè¿‡çš„ cgroups æŒ‚è½½é€ æˆçš„ï¼Œé€šè¿‡ KinD entrypoint è„šæœ¬è®¾ç½®ã€‚è€Œå¦‚æœä½ åœ¨ KinD èŠ‚ç‚¹å®¹å™¨é‡Œé¢åšä¸€ä¸ª &lt;code&gt;cat /kubepods/burstable/&amp;lt;POD_ID&amp;gt;/docker/&amp;lt;DIND_CID&amp;gt;/tasks&lt;/code&gt;ï¼Œä½ ä¼šçœ‹åˆ° DinD å®¹å™¨çš„è¿›ç¨‹ã€‚&lt;br&gt;&lt;img src=&quot;/images/k8s/k8s_in_k8s_3.png&quot; alt=&quot;k8s-in-k8s&quot;&gt;&lt;/p&gt;
&lt;p&gt;è¿™å°±æ˜¯æœ€æ ¹æœ¬çš„åŸå› ï¼ŒKinD èŠ‚ç‚¹å®¹å™¨é‡Œé¢çš„ kubelet çœ‹åˆ°äº†è¿™ä¸ª cgroupï¼Œä»¥ä¸ºåº”è¯¥ç”±å®ƒæ¥ç®¡ç†ï¼Œä½†æ˜¯å´æ‰¾ä¸åˆ°å’Œè¿™ä¸ª cgroup ç›¸å…³è”çš„ Podï¼Œæ‰€ä»¥å°±ä¼šå°è¯•æ¥æ€æ­»å±äºè¿™ä¸ª cgroup çš„è¿›ç¨‹æ¥åˆ é™¤è¿™ä¸ª cgroupã€‚è¿™ä¸ªæ“ä½œçš„ç»“æœå°±æ˜¯éšæœºè¿›ç¨‹è¢«æ€æ­»ã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•å¯ä»¥é€šè¿‡è®¾ç½® kubelet çš„ &lt;code&gt;--cgroup-root&lt;/code&gt; å‚æ•°ï¼Œé€šè¿‡è¯¥æ ‡å¿—æ¥æŒ‡ç¤º KinD èŠ‚ç‚¹å®¹å™¨å†…çš„ kubelet ä¸ºå…¶ Pods ä½¿ç”¨ä¸åŒçš„ cgroup æ ¹è·¯å¾„ï¼ˆæ¯”å¦‚ /kubeletï¼‰ã€‚è¿™æ ·å°±å¯ä»¥åœ¨ Kubernetes é›†ç¾¤ä¸­æ¥å¯åŠ¨ KinD é›†ç¾¤äº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„ YAML èµ„æºæ¸…å•æ–‡ä»¶æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; kind-cluster&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - image:&lt;/span&gt; jieyu/kind-cluster-buster:v0&lt;span class=&quot;number&quot;&gt;.1&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    name:&lt;/span&gt; kind-cluster&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    stdin:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    tty:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    args:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; /bin/bash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    env:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; API_SERVER_ADDRESS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      valueFrom:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        fieldRef:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          fieldPath:&lt;/span&gt; status.podIP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    volumeMounts:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - mountPath:&lt;/span&gt; /var/lib/docker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      name:&lt;/span&gt; varlibdocker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - mountPath:&lt;/span&gt; /lib/modules&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      name:&lt;/span&gt; libmodules&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      readOnly:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    securityContext:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      privileged:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - containerPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;30001&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      name:&lt;/span&gt; api-server-port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      protocol:&lt;/span&gt; TCP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    readinessProbe:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      failureThreshold:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;15&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      httpGet:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        path:&lt;/span&gt; /healthz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        port:&lt;/span&gt; api-server-port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        scheme:&lt;/span&gt; HTTPS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      initialDelaySeconds:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;120&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      periodSeconds:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      successThreshold:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      timeoutSeconds:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  volumes:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; varlibdocker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    emptyDir:&lt;/span&gt; &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; libmodules&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    hostPath:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      path:&lt;/span&gt; /lib/modules&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨ä¸Šé¢çš„èµ„æºæ¸…å•æ–‡ä»¶åˆ›å»ºå®Œæˆåï¼Œç¨ç­‰ä¸€ä¼šå„¿æˆ‘ä»¬å°±å¯ä»¥è¿›å…¥ Pod ä¸­æ¥éªŒè¯ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; -ti kind-cluster /bin/bash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;root@kind-cluster:/&lt;span class=&quot;comment&quot;&gt;# kubectl get nodes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                 STATUS   ROLES    AGE   VERSION&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind-control-plane   Ready    master   72s   v1.17.0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åŒæ ·ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ Docker CLI æ¥è¿›è¡Œæµ‹è¯•ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ docker run -ti --rm --privileged jieyu/kind-cluster-buster:v0.1.0 /bin/bash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Waiting &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; dockerd...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Setting up KIND cluster&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Creating cluster &lt;span class=&quot;string&quot;&gt;&quot;kind&quot;&lt;/span&gt; ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Ensuring node image (jieyu/kind-node:v1.17.0) ğŸ–¼&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Preparing nodes ğŸ“¦&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Writing configuration ğŸ“œ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Starting control-plane ğŸ•¹ï¸&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Installing CNI ğŸ”Œ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Installing StorageClass ğŸ’¾&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; âœ“ Waiting â‰¤ 15m0s &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; control-plane = Ready â³&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; â€¢ Ready after 31s ğŸ’š&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Set kubectl context to &lt;span class=&quot;string&quot;&gt;&quot;kind-kind&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;You can now use your cluster with:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl cluster-info --context kind-kind&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Have a nice day! ğŸ‘‹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;root@d95fa1302557:/&lt;span class=&quot;comment&quot;&gt;# kubectl get nodes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                 STATUS   ROLES    AGE   VERSION&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind-control-plane   Ready    master   71s   v1.17.0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;root@d95fa1302557:/&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ä¸Šé¢é•œåƒå¯¹åº”çš„ Dockerfile å’Œå¯åŠ¨è„šæœ¬åœ°å€ï¼š&lt;a href=&quot;https://github.com/jieyu/docker-images/tree/master/kind-cluster&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/jieyu/docker-images/tree/master/kind-cluster&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä¸‹å›¾æ˜¯æˆ‘åœ¨ KinD æ­å»ºçš„ Kubernetes é›†ç¾¤ä¸­ï¼Œåˆ›å»ºçš„ä¸€ä¸ª Podï¼Œç„¶ååœ¨ Pod ä¸­åˆ›å»ºçš„ä¸€ä¸ªç‹¬ç«‹çš„ Kubernetes é›†ç¾¤æœ€ç»ˆæ•ˆæœï¼š&lt;br&gt;&lt;img src=&quot;/images/k8s/k8s_in_k8s_4.png&quot; alt=&quot;k8s-in-k8s&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;æ€»ç»“&quot;&gt;&lt;a href=&quot;#æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;æ€»ç»“&quot;&gt;&lt;/a&gt;æ€»ç»“&lt;/h2&gt;&lt;p&gt;åœ¨å®ç°ä¸Šé¢åŠŸèƒ½çš„æ—¶å€™ï¼Œè¿‡ç¨‹ä¸­è¿˜æ˜¯é‡åˆ°äº†ä¸å°‘çš„éšœç¢ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†éƒ½æ˜¯å› ä¸º Docker å®¹å™¨æ²¡æœ‰æä¾›å’Œå®¿ä¸»æœºå®Œå…¨éš”ç¦»çš„åŠŸèƒ½é€ æˆçš„ï¼ŒæŸäº›å†…æ ¸èµ„æºæ¯”å¦‚ cgroups æ˜¯åœ¨å†…æ ¸ä¸­å…±äº«çš„ï¼Œå¦‚æœå¾ˆå¤šå®¹å™¨åŒæ—¶æ“ä½œå®ƒä»¬ï¼Œä¹Ÿå¯èƒ½ä¼šé€ æˆæ½œåœ¨çš„å†²çªã€‚ä½†æ˜¯ä¸€æ—¦è§£å†³äº†è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥éå¸¸æ–¹ä¾¿çš„åœ¨ Kubernetes é›†ç¾¤ Pod ä¸­è½»æ¾åœ°è¿è¡Œä¸€ä¸ªç‹¬ç«‹çš„ Kubernetes é›†ç¾¤äº†ï¼Œè¿™åº”è¯¥ç®—çœŸæ­£çš„ Kubernetes IN Kubernetes äº†å§~&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼š&lt;a href=&quot;https://d2iq.com/blog/running-kind-inside-a-kubernetes-cluster-for-continuous-integration&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://d2iq.com/blog/running-kind-inside-a-kubernetes-cluster-for-continuous-integration&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;KinD&lt;/code&gt; æ˜¯ä¸€ä¸ªéå¸¸è½»é‡çº§çš„ Kubernetes å®‰è£…å·¥å…·ï¼Œä»–å°† Docker å®¹å™¨å½“æˆ Kubernetes çš„èŠ‚ç‚¹ï¼Œä½¿ç”¨éå¸¸æ–¹ä¾¿ã€‚æ—¢ç„¶åœ¨ Docker å®¹å™¨ä¸­å¯ä»¥è¿è¡Œ Kubernetes é›†ç¾¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶å°±ä¼šæƒ³åˆ°æ˜¯å¦å¯ä»¥åœ¨ Pod ä¸­æ¥è¿è¡Œå‘¢ï¼Ÿåœ¨ Pod ä¸­è¿è¡Œä¼šé‡åˆ°å“ªäº›é—®é¢˜å‘¢ï¼Ÿ&lt;/p&gt;
&lt;h2 id=&quot;åœ¨-Pod-ä¸­å®‰è£…-Docker-Daemon&quot;&gt;&lt;a href=&quot;#åœ¨-Pod-ä¸­å®‰è£…-Docker-Daemon&quot; class=&quot;headerlink&quot; title=&quot;åœ¨ Pod ä¸­å®‰è£… Docker Daemon&quot;&gt;&lt;/a&gt;åœ¨ Pod ä¸­å®‰è£… Docker Daemon&lt;/h2&gt;&lt;p&gt;&lt;code&gt;KIND&lt;/code&gt; å½“å‰ä¾èµ–äº Dockerï¼ˆå°½ç®¡ä»–ä»¬è®¡åˆ’å¾ˆå¿«æ”¯æŒå…¶ä»–å®¹å™¨è¿è¡Œæ—¶ï¼Œä¾‹å¦‚&lt;code&gt;podman&lt;/code&gt;ï¼‰ã€‚å› æ­¤ï¼Œç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ªå®¹å™¨æ˜ åƒï¼Œè¯¥æ˜ åƒå…è®¸æ‚¨åœ¨ Pod å†…è¿è¡Œ Dockerå®ˆæŠ¤ç¨‹åºï¼Œä»¥ä¾¿ä½¿è¯¸å¦‚&lt;code&gt;docker run&lt;/code&gt;ä¹‹ç±»çš„å‘½ä»¤åœ¨Podå†…è¿è¡Œï¼ˆåˆå Docker-in-Docker æˆ– DIND ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;Docker-in-Docker æ˜¯ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„é—®é¢˜ï¼Œå¹¶ä¸”å·²ç»è§£å†³äº†ç›¸å½“ä¸€æ®µæ—¶é—´ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå½“å°è¯•åœ¨ç”Ÿäº§ Kubernetes é›†ç¾¤ä¸­æ­£ç¡®è®¾ç½® Docker-in-Docker æ—¶ï¼Œæˆ‘ä»¬ä»ç„¶é‡åˆ°å¾ˆå¤šé—®é¢˜ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="kubrenetes" scheme="http://team.jiunile.com/categories/kubrenetes/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/tags/kubernetes/"/>
    
      <category term="k8s in k8s" scheme="http://team.jiunile.com/tags/k8s-in-k8s/"/>
    
  </entry>
  
  <entry>
    <title>å¤šé›†ç¾¤kubernetes dashboard é€šè¿‡ldapç»Ÿä¸€ç™»å½•ä¸æˆæƒ</title>
    <link href="http://team.jiunile.com//blog/2020/06/k8s-mutiboard-ldap.html"/>
    <id>http://team.jiunile.com//blog/2020/06/k8s-mutiboard-ldap.html</id>
    <published>2020-06-12T11:00:00.000Z</published>
    <updated>2020-06-12T02:11:26.000Z</updated>
    
    <content type="html">&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/icyxp/kubernetes-dashboard-ldap/master/assets/images/logo.png&quot; alt=&quot;logo.png&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;å·¥å…·ç”±æ¥&quot;&gt;&lt;a href=&quot;#å·¥å…·ç”±æ¥&quot; class=&quot;headerlink&quot; title=&quot;å·¥å…·ç”±æ¥&quot;&gt;&lt;/a&gt;å·¥å…·ç”±æ¥&lt;/h1&gt;&lt;p&gt;ä¸ºä»€ä¹ˆè¦å†™è¿™æ ·çš„ä¸€ä¸ªå·¥å…·å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºæˆ‘å¸æœ‰å¤šä¸ª &lt;code&gt;kubernetes&lt;/code&gt; é›†ç¾¤(8+)ï¼Œä¸”éƒ½æ˜¯äº‘æ‰˜ç®¡æœåŠ¡æ— æ³•æ¥è§¦åˆ°Apiserveré…ç½®ï¼Œè¿™å°±ç»™æˆ‘ä»¬å¸¦æ¥ä¸€ä¸ªç—›ç‚¹ï¼Œ&lt;strong&gt;å¼€å‘ã€sreéœ€è¦ç™»å½•k8s dashbaordä¸”ä¸åŒéƒ¨é—¨å’Œè§’è‰²é—´éœ€è¦ä¸åŒçš„æˆæƒ&lt;/strong&gt;ï¼ŒåŸå…ˆéƒ½æ˜¯é€šè¿‡ &lt;code&gt;sa token&lt;/code&gt; è¿›è¡Œç™»å½•dashboardï¼Œä½†éšç€k8sé›†ç¾¤çš„å¢é•¿ï¼Œæ¯å¢åŠ ä¸€ä¸ªé›†ç¾¤ï¼Œå°±éœ€è¦å‘ŠçŸ¥ä½¿ç”¨æ–¹å¯¹åº”dashboardè®¿é—®åœ°å€ä»¥åŠå¯¹åº”çš„tokenï¼Œè¿™ä¸ç®¡æ˜¯æä¾›æ–¹è¿˜æ˜¯ä½¿ç”¨æ–¹éƒ½è®©äººæ„Ÿè§‰éå¸¸çš„ç—›è‹¦ã€‚é‚£æ˜¯å¦æœ‰ä¸€æ¬¾å·¥å…·èƒ½&lt;strong&gt;æä¾›ç»Ÿä¸€åœ°å€ç»Ÿä¸€ç™»å½•å¤šé›†ç¾¤dashboardçš„æ–¹æ¡ˆ&lt;/strong&gt;å‘¢ï¼Ÿç»è¿‡ä¸€ç•ªæœç´¢åï¼Œå‘ç°å¹¶æ²¡æœ‰ï¼Œå¸‚é¢ä¸Šå¤§å¤šæ•°æ˜¯å•é›†ç¾¤é›†æˆ &lt;code&gt;LDAP&lt;/code&gt; çš„æ–¹æ¡ˆï¼Œä¸»è¦æ˜¯ä»¥ &lt;code&gt;DEX&lt;/code&gt; ä¸ºä¸»ï¼Œä½†å…‰å•é›†ç¾¤çš„ç»Ÿä¸€ç™»å½•æˆæƒæ–¹æ¡ˆå°±è®©äººæ„Ÿè§‰éå¸¸çš„å›°éš¾ã€‚éš¾é“å°±æ²¡æœ‰ç®€å•æ–¹ä¾¿çš„å·¥å…·ä¾›æˆ‘ä»¬ä½¿ç”¨å—ï¼Ÿå¥½å§ï¼Œé‚£æˆ‘å°±æ¥æ‰“é€ è¿™æ ·ä¸€æ¬¾å·¥å…·å§ã€‚&lt;/p&gt;
&lt;p&gt;Dashboard LDAPé›†æˆæ–¹æ¡ˆï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://k2r2bai.com/2019/09/29/ironman2020/day14/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://k2r2bai.com/2019/09/29/ironman2020/day14/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://blog.inkubate.io/access-your-kubernetes-cluster-with-your-active-directory-credentials&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://blog.inkubate.io/access-your-kubernetes-cluster-with-your-active-directory-credentials&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»¥ä¸Šä¸¤ç¯‡æ–‡æ¡£æ˜¯æˆLDAPçš„æ–¹æ¡ˆï¼Œä¸ªäººæ„Ÿè§‰è¿˜ä¸é”™ï¼Œä¾›æœ‰éœ€è¦çš„äººå‚è€ƒï¼&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;å¦‚ä½•æ‰“é€ &quot;&gt;&lt;a href=&quot;#å¦‚ä½•æ‰“é€ &quot; class=&quot;headerlink&quot; title=&quot;å¦‚ä½•æ‰“é€ &quot;&gt;&lt;/a&gt;å¦‚ä½•æ‰“é€ &lt;/h1&gt;&lt;p&gt;å¥½å§æ—¢ç„¶æ²¡æœ‰ï¼Œé‚£å°±è‡ªåŠ¨åŠ¨æ‰‹æ‰“é€ ä¸€ä¸ªï¼&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ç›®æ ‡ï¼š &lt;strong&gt;ç®€å•ä½¿ç”¨&lt;/strong&gt;ï¼ï¼ï¼é€šè¿‡è®¿é—®åŒä¸€åœ°å€ï¼Œä½¿ç”¨LDAPç™»å½•ä¸”å¯åˆ‡æ¢ä¸åŒé›†ç¾¤çš„dashboardï¼ŒåŒæ—¶å¯¹åº”ä¸åŒçš„é›†ç¾¤æƒé™å¯å•ç‹¬é…ç½®ï¼&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æœ‰äº†ä¸Šé¢çš„ç›®æ ‡ï¼Œé‚£å¦‚ä½•æ¥å®ç°å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;å®ç°æ–¹å¼å…¶å®å¾ˆç®€å•ï¼Œé¦–å…ˆå†™ä¸€ä¸ªç™»å½•ç•Œé¢ä¸å…¬å¸çš„ADè¿›è¡Œæ‰“é€šè·å–ç”¨æˆ·ä¸ç»„ï¼Œç„¶åå°†ç”¨æˆ·æˆ–è€…ç»„ä¸k8sé›†ç¾¤ä¸­çš„ &lt;code&gt;service account&lt;/code&gt; è¿›è¡Œå…³è”å°±å®ç°äº†å¯¹åº”çš„rbacä¸ç™»å½•tokenï¼Œæœ€ååœ¨ç™»å½•åå®ç°ä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å³å¯å®Œæˆã€‚&lt;/p&gt;
&lt;p&gt;æ˜¯ä¸æ˜¯éå¸¸çš„ç®€å•ï¼ï¼ï¼&lt;/p&gt;
&lt;p&gt;å®ç°æŠ€æœ¯æ ˆï¼šgolang(ginã€client-goã€viperã€ldap) + Kubernetes Dashboard&lt;/p&gt;
&lt;h1 id=&quot;å¦‚ä½•éƒ¨ç½²&quot;&gt;&lt;a href=&quot;#å¦‚ä½•éƒ¨ç½²&quot; class=&quot;headerlink&quot; title=&quot;å¦‚ä½•éƒ¨ç½²&quot;&gt;&lt;/a&gt;å¦‚ä½•éƒ¨ç½²&lt;/h1&gt;&lt;h2 id=&quot;å‰ææ¡ä»¶&quot;&gt;&lt;a href=&quot;#å‰ææ¡ä»¶&quot; class=&quot;headerlink&quot; title=&quot;å‰ææ¡ä»¶&quot;&gt;&lt;/a&gt;å‰ææ¡ä»¶&lt;/h2&gt;&lt;p&gt;åœ¨ä½¿ç”¨æ­¤å·¥å…·å‰ï¼Œéœ€è¦æœ‰ä»¥ä¸‹ä¸€äº›æ¡ä»¶çº¦æŸï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å·²åœ¨å„k8sé›†ç¾¤éƒ¨ç½² &lt;code&gt;dashboard&lt;/code&gt; ä¸”èƒ½è¢«æ­¤å·¥å…·è®¿é—®åˆ°&lt;/li&gt;
&lt;li&gt;å·²æœ‰ &lt;code&gt;ldap&lt;/code&gt; ä¸”æœ‰ç®¡ç†æƒé™èƒ½è¿›è¡Œè®¿é—®æ“ä½œ&lt;/li&gt;
&lt;li&gt;å„é›†ç¾¤ä¸­æœ‰å¯¹åº”çš„ &lt;code&gt;service account&lt;/code&gt; å¯è¿›è¡Œæ˜ å°„ï¼Œå¦‚éœ€å¯¹ä¸åŒç”¨æˆ·å’Œç»„éœ€è¦æœ‰ä¸åŒçš„æ“ä½œæƒé™ï¼Œåˆ™å¯¹saè¿›è¡Œrbacæˆæƒå³å¯ï¼Œä¸‹é¢ä¼šè¯¦ç»†è¯´æ˜ã€‚&lt;/li&gt;
&lt;li&gt;æ­¤å·¥å…·éœ€è¦æ“ä½œå„é›†ç¾¤çš„apiï¼Œæ•…éœ€è¦è·å–æ¯ä¸ªé›†ç¾¤çš„ &lt;code&gt;apiserveråœ°å€&lt;/code&gt;ã€&lt;code&gt;ca.crt&lt;/code&gt; ä»¥åŠ &lt;code&gt;token&lt;/code&gt; è¿›è¡Œé…ç½®ï¼Œè‡³äºæ¯ä¸ªé›†ç¾¤çš„ &lt;code&gt;ca.crt&lt;/code&gt; å’Œ &lt;code&gt;token&lt;/code&gt; å¦‚æœè·å–ï¼Œåé¢ä¼šè¿›è¡Œè¯´æ˜&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;å¦‚ä½•è·å–-ca-crt-åŠ-token&quot;&gt;&lt;a href=&quot;#å¦‚ä½•è·å–-ca-crt-åŠ-token&quot; class=&quot;headerlink&quot; title=&quot;å¦‚ä½•è·å– ca.crt åŠ token&quot;&gt;&lt;/a&gt;å¦‚ä½•è·å– ca.crt åŠ token&lt;/h2&gt;&lt;p&gt;æ­¤å·¥å…·éœ€è¦æ“ä½œæ¯ä¸ªé›†ç¾¤çš„apiæ¥è·å–å¯¹åº”çš„ sa ä»¥åŠ tokenï¼Œæ•…éœ€è¦æœ‰å¯¹å„é›†ç¾¤æ“ä½œçš„æƒé™ã€‚é‚£å¦‚ä½•åœ¨å„é›†ç¾¤ç”Ÿæˆå¯¹åº”çš„ caè¯ä¹¦ åŠ token å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯åˆ›å»ºä¸€ä¸ª sa å¹¶ç»™äºˆä¸€å®šçš„æƒé™ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨æ¯ä¸ªk8sé›†ç¾¤ä¸­æ‰§è¡Œå¦‚ä¸‹yamlæ–‡ä»¶:&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ServiceAccount&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; mutiboard-ldap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; default&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; rbac.authorization.k8s.io/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ClusterRoleBinding&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; mutiboard-ldap-crb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;roleRef:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  apiGroup:&lt;/span&gt; rbac.authorization.k8s.io&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  kind:&lt;/span&gt; ClusterRole&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; mutiboard-ldap-view&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;subjects:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- kind:&lt;/span&gt; ServiceAccount&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; mutiboard-ldap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; default&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; rbac.authorization.k8s.io/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ClusterRole&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; mutiboard-ldap-view&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;rules:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; serviceaccounts&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; secrets&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; namespaces&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;  -&lt;/span&gt; watch&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ­¤yamlæ–‡ä»¶çš„å«ä¹‰ï¼šåˆ›å»ºä¸€ä¸ªåä¸º&lt;code&gt;mutiboard-ldap&lt;/code&gt;çš„ saï¼Œå¹¶ä¸”ç»™äºˆ&lt;code&gt;serviceaccounts&lt;/code&gt;å’Œ&lt;code&gt;secrets&lt;/code&gt;çš„getå’Œlistçš„æƒé™ã€‚&lt;/p&gt;
&lt;p&gt;è·å– &lt;code&gt;mutiboard-ldap&lt;/code&gt; çš„ ca.crtï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(âˆ|aws-local:default)â¯ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; $(kubectl get secret $(kubectl get secret | grep mutiboard-ldap | awk &lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;print $1&amp;#125;&#39;&lt;/span&gt;) -o go-template=&lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;&amp;#123;index .data &quot;ca.crt&quot;&amp;#125;&amp;#125;&#39;&lt;/span&gt;) | base64 &lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-----BEGIN CERTIFICATE-----&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MIICyDCCAbCgAwIBAgIBADANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwprdWJl&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cm5ldGVzMB4XDTE5MDEyNTEwMTgzNFoXDTI5MDEyMjEwMTgzNFowFTETMBEGA1UE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;AxMKa3ViZXJuZXRlczCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMmc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;TW0stLLP+M6Pc9wpRgZufg6eQ7puBfbYgik20QlO4LFtocgNUDa0y+aSXjxheA2C&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;A+o9wW0IC3GHQHKgeFY8KXIJu6wM0TO+JNQy5XZAWfbsLeXU/sLhKuWET/KJzVWT&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;0uBE+GCADAAQIec1oQXMbQ551hU5gBFcr67NXHpa2qwEGA1mGtZ7ztmW4+IFUD74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;G166z4AOgmR4YWxBs/+8NhfWudFD32xevBfSKuHRxRGG5dtffY8QnRbnrmy70HE5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yzLtBvAGfCwtHLTP2ngCAnn2Fb6IeMdIYGpI1544ZjRbzT1YIWsG1v3dlu6tvK1q&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;X5Pj+UTDmJuf2SW52A0CAwEAAaMjMCEwDgYDVR0PAQH/BAQDAgKkMA8GA1UdEwEB&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAKE2hV0DIG8fSf4/eOi5R2sPRfBW&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;qTwgZDDT9dxZNhbxEInALdruwRUbKRpwaUBOGVpIlaK3/rZkAfjUwoDJ+J4fmmCX&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;w3ySrYFjx6tqVFqCPjDkBHh4xpMwUlvsvryRuCEQUQgjqBvj6sWm9GERF2n3VYBF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;S8bjsQQAZJoE4W+OKchlEoSFlKhxAoeZx9CD3Rxnhj2og6&lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;VoGCUqAMh4WZWX+w&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pENnui6M96SysH3SkrA02RXWTGeKzK4E6Av3IG+2a2hauHorbqVfaM6HeL3hkU/B&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;JCWpOgN3T4Fw7E359CBQxnSHPasmZ5VBoyIk/HUU6ZlMK6Xo6JlbS7ZvVl4=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-----END CERTIFICATE-----&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è·å– &lt;code&gt;mutiboard-ldap&lt;/code&gt; çš„ tokenï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(âˆ|aws-local:default)â¯ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; $(kubectl get secret $(kubectl get secret | grep mutiboard-ldap | awk &lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;print $1&amp;#125;&#39;&lt;/span&gt;) -o go-template=&lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;&amp;#123;.data.token&amp;#125;&amp;#125;&#39;&lt;/span&gt;) | base64 &lt;span class=&quot;_&quot;&gt;-d&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6Im11dGlib2FyZC1sZGFwLXRva2VuLWJ3NWdmIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6Im11dGlib2FyZC1sZGFwIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMjVmZjI4MGQtYWJhMi0xMWVhLWFlOGEtMDIzOTBjMzcyNzhlIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6bXV0aWJvYXJkLWxkYXA&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;Q.q14hqEu2p70_YczDviR6c8McDM5vfnKPzjO9usCsC-uQUxciBbuJU_PK9j3uawppUNlrs3rAPrZIGUS7Jv14rifEXpGxIIfGR6n8-le0b-9YvMZCgs9-jhf-1r01EAnZFh6gcXfxESFguFQI0vYOsX4P2LQvZ9XTMzsqXbW3KGYao5elAjCE4e8Rg4--9e_zU8NGTEycsvUMxP-9p0SaAzn9Iak3saZtAnzJq5hkSf1t7l2_CgEsYN-3b7uGpHupK_zdgAeOflj9ze4Cz2YScv5eixwVXJ-RcI4lgSFCgt5yzSbnIuHgxRZyN3NcYLrSBYKftezZysWm3jELgLPogQ&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è‡³æ­¤ï¼Œå„é›†ç¾¤çš„ &lt;code&gt;ca.crt&lt;/code&gt; å’Œ &lt;code&gt;token&lt;/code&gt; éƒ½å·²è·å–ï¼Œä¸‹é¢ä¼šå‘ŠçŸ¥å¦‚ä½•è¿›è¡Œé…ç½®ä½¿ç”¨è¿™äº› &lt;code&gt;ca.crt&lt;/code&gt; å’Œ &lt;code&gt;token&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;SA-RBACåˆ—å­&quot;&gt;&lt;a href=&quot;#SA-RBACåˆ—å­&quot; class=&quot;headerlink&quot; title=&quot;SA RBACåˆ—å­&quot;&gt;&lt;/a&gt;SA RBACåˆ—å­&lt;/h2&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ServiceAccount&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; ops-admin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; default&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    kubernetes.io/cluster-service: &lt;span class=&quot;string&quot;&gt;&quot;true&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    addonmanager.kubernetes.io/mode: Reconcile&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; rbac.authorization.k8s.io/v1beta1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ClusterRole&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; ops-role&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;rules:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- apiGroups:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  resources:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;namespaces&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  verbs:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;get&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;list&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;watch&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ClusterRoleBinding&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; rbac.authorization.k8s.io/v1beta1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; ops-listnamespace&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;roleRef:&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;#å¼•ç”¨çš„è§’è‰²&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  kind:&lt;/span&gt; ClusterRole&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; ops-role&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  apiGroup:&lt;/span&gt; rbac.authorization.k8s.io&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;subjects:&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;#ä¸»ä½“&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- kind:&lt;/span&gt; ServiceAccount&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; ops-admin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; default&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; RoleBinding&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; rbac.authorization.k8s.io/v1beta1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; ops-ci-admin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; ops-ci&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;roleRef:&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;#å¼•ç”¨çš„è§’è‰²&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  kind:&lt;/span&gt; ClusterRole&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; admin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  apiGroup:&lt;/span&gt; rbac.authorization.k8s.io&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;subjects:&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;#ä¸»ä½“&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- kind:&lt;/span&gt; ServiceAccount&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; ops-admin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; default&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; RoleBinding&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; rbac.authorization.k8s.io/v1beta1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; ops-qa-admin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; ops-qa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;roleRef:&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;#å¼•ç”¨çš„è§’è‰²&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  kind:&lt;/span&gt; ClusterRole&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; admin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  apiGroup:&lt;/span&gt; rbac.authorization.k8s.io&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;subjects:&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;#ä¸»ä½“&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- kind:&lt;/span&gt; ServiceAccount&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; ops-admin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; default&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;è¿™æ®µYAMLçš„æ„æ€ä¸ºï¼šåˆ›å»ºäº†ä¸€ä¸ªops-adminçš„saï¼Œå¹¶ä¸ºè¿™ä¸ªsaèµ‹äºˆäº†ä¸¤ä¸ªå‘½åç©ºé—´(ops-ciã€ops-qa) admin çš„æƒé™ã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“æƒ³äº†è§£æ›´å¤šrbacç›¸å…³çš„è¯´æ˜ï¼Œå¯å‚è€ƒï¼š&lt;a href=&quot;https://www.cnblogs.com/wlbl/p/10694364.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.cnblogs.com/wlbl/p/10694364.html&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ldapè¯´æ˜&quot;&gt;&lt;a href=&quot;#ldapè¯´æ˜&quot; class=&quot;headerlink&quot; title=&quot;ldapè¯´æ˜&quot;&gt;&lt;/a&gt;ldapè¯´æ˜&lt;/h2&gt;&lt;p&gt;æˆ‘å¸&lt;code&gt;ldap&lt;/code&gt;ç›®å½•è§„åˆ™å¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;|--åŸŸ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|--|---å…¬å¸&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|--|----|----åˆ†å…¬å¸&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|--|----|-----|----éƒ¨é—¨&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|--|----|-----|-----|-----ç”¨æˆ·&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯¹åº”çš„&lt;code&gt;Distinguished Name&lt;/code&gt;æ˜¾ç¤ºå¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;CN=Peng Xu,OU=éƒ¨é—¨,OU=åˆ†å…¬å¸,OU=å…¬å¸,DC=corp,DC=xxx,DC=com&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæˆ‘ä¼šè·å–ç¬¬ä¸€ä¸ª&lt;code&gt;OU&lt;/code&gt;ä½œä¸º&lt;code&gt;group&lt;/code&gt;ï¼Œå¦‚æœä½ çš„éœ€æ±‚å’Œæˆ‘ä¸ä¸€æ ·ï¼Œå¯ä»¥ç»™æˆ‘æ issue è¿›è¡Œé€‚é…&lt;/p&gt;
&lt;p&gt;ldap è¯¦ç»†è¯´æ˜è¯·å‚è€ƒï¼š&lt;a href=&quot;https://blog.poychang.net/ldap-introduction&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://blog.poychang.net/ldap-introduction&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;configmap-yaml-é…ç½®è¯´æ˜&quot;&gt;&lt;a href=&quot;#configmap-yaml-é…ç½®è¯´æ˜&quot; class=&quot;headerlink&quot; title=&quot;configmap.yaml é…ç½®è¯´æ˜&quot;&gt;&lt;/a&gt;configmap.yaml é…ç½®è¯´æ˜&lt;/h2&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;ldap:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  addr:&lt;/span&gt; ldap://&lt;span class=&quot;number&quot;&gt;192.168&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.3&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.81&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;389&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  adminUser:&lt;/span&gt; xxxxx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  adminPwd:&lt;/span&gt; xxxxxx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  baseDN:&lt;/span&gt; dc=corp,dc=patsnap,dc=com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  filter:&lt;/span&gt; (&amp;amp;(objectClass=person)(sAMAccountName=%s))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  attributes:&lt;/span&gt; user_dn&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  orgUnitName:&lt;/span&gt; OU=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#å…¨å±€ç”¨æˆ·/ç”¨æˆ·ç»„ä¸SAçš„æ˜ å°„&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;rbac:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  DevOps team:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    sa:&lt;/span&gt; ops-admin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    ns:&lt;/span&gt; kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  xupeng:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    sa:&lt;/span&gt; inno-admin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    ns:&lt;/span&gt; default&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;clusters:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;#é›†ç¾¤åˆ«åï¼Œåœ¨ç™»å½•ä¸‹æ‹‰æ¡†ä¸­æ˜¾ç¤ºçš„keyï¼Œè¿™ä¸ªåˆ«åéœ€è¦å’Œsecret.shä¸­çš„ca.crtå’Œtokençš„é”®åä¸€ä¸€å¯¹åº”&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  local:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#apiserveråœ°å€ï¼Œèƒ½å¤Ÿè¢«å½“å‰å·¥å…·è®¿é—®åˆ°&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    apiServer:&lt;/span&gt; apiserver-dev.jiunile.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;6443&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#kubernetes dashboardåœ°å€ï¼Œèƒ½å¤Ÿè¢«å½“å‰å·¥å…·è®¿é—®åˆ°&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    dashboard:&lt;/span&gt; dashboard-dev.jiunile.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#é›†ç¾¤è¯´æ˜ï¼Œåœ¨ç™»å½•ä¸‹æ‹‰æ¡†ä¸­æ˜¾ç¤ºçš„åç§°&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    desc:&lt;/span&gt; Dev Cluster&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#é’ˆå¯¹å•ç‹¬é›†ç¾¤ç»†åˆ†&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#rbac:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#  DevOps team:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#    sa: admin&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#    ns: kube-system&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#  xupeng:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#    sa: ops-admin&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#    ns: default&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  cnrelease:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    apiServer:&lt;/span&gt; apiserver-cn-release.jiunile.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;443&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    dashboard:&lt;/span&gt; dashboard-cn-release.jiunile.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    desc:&lt;/span&gt; CN Release Cluster&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  usrelease:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    apiServer:&lt;/span&gt; apiserver-us-release.jiunile.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;443&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    dashboard:&lt;/span&gt; dashboard-us-release.jiunile.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    desc:&lt;/span&gt; US Release Cluster&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  euprod:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    apiServer:&lt;/span&gt; apiserver-eu-prod.jiunile.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;443&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    dashboard:&lt;/span&gt; dashboard-eu-prod.jiunile.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    desc:&lt;/span&gt; EU Prod Cluster&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;éƒ¨ç½²&quot;&gt;&lt;a href=&quot;#éƒ¨ç½²&quot; class=&quot;headerlink&quot; title=&quot;éƒ¨ç½²&quot;&gt;&lt;/a&gt;éƒ¨ç½²&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;ä¿®æ”¹å¹¶éƒ¨ç½²&lt;code&gt;deploy/configmap.yaml&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;å°†å„é›†ç¾¤è·å–çš„ &lt;code&gt;ca.crt&lt;/code&gt; å’Œ &lt;code&gt;token&lt;/code&gt; å†™å…¥åˆ°å¯¹åº”çš„deploy/tokenä¸‹&lt;/li&gt;
&lt;li&gt;&lt;p&gt;æ‰§è¡Œ deploy ä¸‹çš„ secret.sh è„šæœ¬ &lt;code&gt;sh deploy/secret.sh&lt;/code&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æ³¨æ„: secret.sh ä¸­çš„&lt;code&gt;xx_token/xxx_ca.crt&lt;/code&gt;ä¸­çš„ &lt;code&gt;xx&lt;/code&gt; å¯¹åº”äº&lt;code&gt;configmap.yaml&lt;/code&gt; ä¸­çš„&lt;strong&gt;é›†ç¾¤åˆ«åï¼Œå¿…é¡»è¦ä¸€ä¸€å¯¹åº”&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;éƒ¨ç½²&lt;code&gt;deploy/deployment.yaml&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;è®¿é—®&quot;&gt;&lt;a href=&quot;#è®¿é—®&quot; class=&quot;headerlink&quot; title=&quot;è®¿é—®&quot;&gt;&lt;/a&gt;è®¿é—®&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;http://{nodeip}:31000&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://{nodeip}:31000&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è§†é¢‘åœ°å€ï¼š&lt;a href=&quot;http://www.youtube.com/watch?v=ILiviSLbSq8&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.youtube.com/watch?v=ILiviSLbSq8&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;gitåœ°å€ï¼š&lt;a href=&quot;https://github.com/icyxp/kubernetes-dashboard-ldap&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/icyxp/kubernetes-dashboard-ldap&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/icyxp/kubernetes-dashboard-ldap/master/assets/images/logo.png&quot; alt=&quot;logo.png&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;å·¥å…·ç”±æ¥&quot;&gt;&lt;a href=&quot;#å·¥å…·ç”±æ¥&quot; class=&quot;headerlink&quot; title=&quot;å·¥å…·ç”±æ¥&quot;&gt;&lt;/a&gt;å·¥å…·ç”±æ¥&lt;/h1&gt;&lt;p&gt;ä¸ºä»€ä¹ˆè¦å†™è¿™æ ·çš„ä¸€ä¸ªå·¥å…·å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºæˆ‘å¸æœ‰å¤šä¸ª &lt;code&gt;kubernetes&lt;/code&gt; é›†ç¾¤(8+)ï¼Œä¸”éƒ½æ˜¯äº‘æ‰˜ç®¡æœåŠ¡æ— æ³•æ¥è§¦åˆ°Apiserveré…ç½®ï¼Œè¿™å°±ç»™æˆ‘ä»¬å¸¦æ¥ä¸€ä¸ªç—›ç‚¹ï¼Œ&lt;strong&gt;å¼€å‘ã€sreéœ€è¦ç™»å½•k8s dashbaordä¸”ä¸åŒéƒ¨é—¨å’Œè§’è‰²é—´éœ€è¦ä¸åŒçš„æˆæƒ&lt;/strong&gt;ï¼ŒåŸå…ˆéƒ½æ˜¯é€šè¿‡ &lt;code&gt;sa token&lt;/code&gt; è¿›è¡Œç™»å½•dashboardï¼Œä½†éšç€k8sé›†ç¾¤çš„å¢é•¿ï¼Œæ¯å¢åŠ ä¸€ä¸ªé›†ç¾¤ï¼Œå°±éœ€è¦å‘ŠçŸ¥ä½¿ç”¨æ–¹å¯¹åº”dashboardè®¿é—®åœ°å€ä»¥åŠå¯¹åº”çš„tokenï¼Œè¿™ä¸ç®¡æ˜¯æä¾›æ–¹è¿˜æ˜¯ä½¿ç”¨æ–¹éƒ½è®©äººæ„Ÿè§‰éå¸¸çš„ç—›è‹¦ã€‚é‚£æ˜¯å¦æœ‰ä¸€æ¬¾å·¥å…·èƒ½&lt;strong&gt;æä¾›ç»Ÿä¸€åœ°å€ç»Ÿä¸€ç™»å½•å¤šé›†ç¾¤dashboardçš„æ–¹æ¡ˆ&lt;/strong&gt;å‘¢ï¼Ÿç»è¿‡ä¸€ç•ªæœç´¢åï¼Œå‘ç°å¹¶æ²¡æœ‰ï¼Œå¸‚é¢ä¸Šå¤§å¤šæ•°æ˜¯å•é›†ç¾¤é›†æˆ &lt;code&gt;LDAP&lt;/code&gt; çš„æ–¹æ¡ˆï¼Œä¸»è¦æ˜¯ä»¥ &lt;code&gt;DEX&lt;/code&gt; ä¸ºä¸»ï¼Œä½†å…‰å•é›†ç¾¤çš„ç»Ÿä¸€ç™»å½•æˆæƒæ–¹æ¡ˆå°±è®©äººæ„Ÿè§‰éå¸¸çš„å›°éš¾ã€‚éš¾é“å°±æ²¡æœ‰ç®€å•æ–¹ä¾¿çš„å·¥å…·ä¾›æˆ‘ä»¬ä½¿ç”¨å—ï¼Ÿå¥½å§ï¼Œé‚£æˆ‘å°±æ¥æ‰“é€ è¿™æ ·ä¸€æ¬¾å·¥å…·å§ã€‚&lt;/p&gt;
&lt;p&gt;Dashboard LDAPé›†æˆæ–¹æ¡ˆï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://k2r2bai.com/2019/09/29/ironman2020/day14/&quot;&gt;https://k2r2bai.com/2019/09/29/ironman2020/day14/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://blog.inkubate.io/access-your-kubernetes-cluster-with-your-active-directory-credentials&quot;&gt;https://blog.inkubate.io/access-your-kubernetes-cluster-with-your-active-directory-credentials&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»¥ä¸Šä¸¤ç¯‡æ–‡æ¡£æ˜¯æˆLDAPçš„æ–¹æ¡ˆï¼Œä¸ªäººæ„Ÿè§‰è¿˜ä¸é”™ï¼Œä¾›æœ‰éœ€è¦çš„äººå‚è€ƒï¼&lt;br&gt;
    
    </summary>
    
      <category term="kubrenetes" scheme="http://team.jiunile.com/categories/kubrenetes/"/>
    
      <category term="ldap" scheme="http://team.jiunile.com/categories/kubrenetes/ldap/"/>
    
      <category term="rbac" scheme="http://team.jiunile.com/categories/kubrenetes/ldap/rbac/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/tags/kubernetes/"/>
    
      <category term="ldap" scheme="http://team.jiunile.com/tags/ldap/"/>
    
      <category term="rbac" scheme="http://team.jiunile.com/tags/rbac/"/>
    
  </entry>
  
  <entry>
    <title>è‡ªå®šä¹‰ Kubernetes è°ƒåº¦å™¨</title>
    <link href="http://team.jiunile.com//blog/2020/06/k8s-custom-scheduler.html"/>
    <id>http://team.jiunile.com//blog/2020/06/k8s-custom-scheduler.html</id>
    <published>2020-06-08T11:00:00.000Z</published>
    <updated>2020-06-08T08:35:55.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;&lt;code&gt;kube-scheduler&lt;/code&gt; æ˜¯ kubernetes çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œä¸»è¦è´Ÿè´£æ•´ä¸ªé›†ç¾¤èµ„æºçš„è°ƒåº¦åŠŸèƒ½ï¼Œæ ¹æ®ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œç­–ç•¥ï¼Œå°† Pod è°ƒåº¦åˆ°æœ€ä¼˜çš„å·¥ä½œèŠ‚ç‚¹ä¸Šé¢å»ï¼Œä»è€Œæ›´åŠ åˆç†ã€æ›´åŠ å……åˆ†çš„åˆ©ç”¨é›†ç¾¤çš„èµ„æºï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ kubernetes ä¸€ä¸ªéå¸¸é‡è¦çš„ç†ç”±ã€‚å¦‚æœä¸€é—¨æ–°çš„æŠ€æœ¯ä¸èƒ½å¸®åŠ©ä¼ä¸šèŠ‚çº¦æˆæœ¬ã€æä¾›æ•ˆç‡ï¼Œæˆ‘ç›¸ä¿¡æ˜¯å¾ˆéš¾æ¨è¿›çš„ã€‚&lt;/p&gt;
&lt;h2 id=&quot;è°ƒåº¦æµç¨‹&quot;&gt;&lt;a href=&quot;#è°ƒåº¦æµç¨‹&quot; class=&quot;headerlink&quot; title=&quot;è°ƒåº¦æµç¨‹&quot;&gt;&lt;/a&gt;è°ƒåº¦æµç¨‹&lt;/h2&gt;&lt;p&gt;é»˜è®¤æƒ…å†µä¸‹ï¼Œ&lt;code&gt;kube-scheduler&lt;/code&gt; æä¾›çš„é»˜è®¤è°ƒåº¦å™¨èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬ç»å¤§å¤šæ•°çš„è¦æ±‚ï¼Œæˆ‘ä»¬å‰é¢å’Œå¤§å®¶æ¥è§¦çš„ç¤ºä¾‹ä¹ŸåŸºæœ¬ä¸Šç”¨çš„é»˜è®¤çš„ç­–ç•¥ï¼Œéƒ½å¯ä»¥ä¿è¯æˆ‘ä»¬çš„ Pod å¯ä»¥è¢«åˆ†é…åˆ°èµ„æºå……è¶³çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ä½†æ˜¯åœ¨å®é™…çš„çº¿ä¸Šé¡¹ç›®ä¸­ï¼Œå¯èƒ½æˆ‘ä»¬è‡ªå·±ä¼šæ¯” kubernetes æ›´åŠ äº†è§£æˆ‘ä»¬è‡ªå·±çš„åº”ç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸Œæœ›ä¸€ä¸ª Pod åªèƒ½è¿è¡Œåœ¨ç‰¹å®šçš„å‡ ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…è¿™å‡ ä¸ªèŠ‚ç‚¹åªèƒ½ç”¨æ¥è¿è¡Œç‰¹å®šç±»å‹çš„åº”ç”¨ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬çš„è°ƒåº¦å™¨èƒ½å¤Ÿå¯æ§ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;kube-scheduler&lt;/code&gt; çš„ä¸»è¦ä½œç”¨å°±æ˜¯æ ¹æ®ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œè°ƒåº¦ç­–ç•¥å°† Pod è°ƒåº¦åˆ°åˆé€‚çš„ Node èŠ‚ç‚¹ä¸Šå»ï¼Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äºŒè¿›åˆ¶ç¨‹åºï¼Œå¯åŠ¨ä¹‹åä¼šä¸€ç›´ç›‘å¬ API Serverï¼Œè·å–åˆ° &lt;code&gt;PodSpec.NodeName&lt;/code&gt; ä¸ºç©ºçš„ Podï¼Œå¯¹æ¯ä¸ª Pod éƒ½ä¼šåˆ›å»ºä¸€ä¸ª bindingã€‚&lt;br&gt;&lt;img src=&quot;/images/k8s/kube-scheduler-overview.png&quot; alt=&quot;kube-scheduler-overview&quot;&gt;&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;è¿™ä¸ªè¿‡ç¨‹åœ¨æˆ‘ä»¬çœ‹æ¥å¥½åƒæ¯”è¾ƒç®€å•ï¼Œä½†åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéœ€è¦è€ƒè™‘çš„é—®é¢˜å°±æœ‰å¾ˆå¤šäº†ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚ä½•ä¿è¯å…¨éƒ¨çš„èŠ‚ç‚¹è°ƒåº¦çš„å…¬å¹³æ€§ï¼Ÿè¦çŸ¥é“å¹¶ä¸æ˜¯æ‰€æœ‰èŠ‚ç‚¹èµ„æºé…ç½®ä¸€å®šéƒ½æ˜¯ä¸€æ ·çš„&lt;/li&gt;
&lt;li&gt;å¦‚ä½•ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½è¢«åˆ†é…èµ„æºï¼Ÿ&lt;/li&gt;
&lt;li&gt;é›†ç¾¤èµ„æºå¦‚ä½•èƒ½å¤Ÿè¢«é«˜æ•ˆåˆ©ç”¨ï¼Ÿ&lt;/li&gt;
&lt;li&gt;é›†ç¾¤èµ„æºå¦‚ä½•æ‰èƒ½è¢«æœ€å¤§åŒ–ä½¿ç”¨ï¼Ÿ&lt;/li&gt;
&lt;li&gt;å¦‚ä½•ä¿è¯ Pod è°ƒåº¦çš„æ€§èƒ½å’Œæ•ˆç‡ï¼Ÿ&lt;/li&gt;
&lt;li&gt;ç”¨æˆ·æ˜¯å¦å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚å®šåˆ¶è‡ªå·±çš„è°ƒåº¦ç­–ç•¥ï¼Ÿ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è€ƒè™‘åˆ°å®é™…ç¯å¢ƒä¸­çš„å„ç§å¤æ‚æƒ…å†µï¼Œkubernetes çš„è°ƒåº¦å™¨é‡‡ç”¨æ’ä»¶åŒ–çš„å½¢å¼å®ç°ï¼Œå¯ä»¥æ–¹ä¾¿ç”¨æˆ·è¿›è¡Œå®šåˆ¶æˆ–è€…äºŒæ¬¡å¼€å‘ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªè°ƒåº¦å™¨å¹¶ä»¥æ’ä»¶å½¢å¼å’Œ kubernetes è¿›è¡Œé›†æˆã€‚&lt;/p&gt;
&lt;p&gt;kubernetes è°ƒåº¦å™¨çš„æºç ä½äº &lt;code&gt;kubernetes/pkg/scheduler&lt;/code&gt; ä¸­ï¼Œå¤§ä½“çš„ä»£ç ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š(ä¸åŒçš„ç‰ˆæœ¬ç›®å½•ç»“æ„å¯èƒ½ä¸å¤ªä¸€æ ·)&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubernetes/pkg/scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-- scheduler.go         //è°ƒåº¦ç›¸å…³çš„å…·ä½“å®ç°&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- algorithm&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- predicates      //èŠ‚ç‚¹ç­›é€‰ç­–ç•¥&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- priorities      //èŠ‚ç‚¹æ‰“åˆ†ç­–ç•¥&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|-- algorithmprovider&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|   |-- defaults         //å®šä¹‰é»˜è®¤çš„è°ƒåº¦å™¨&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å…¶ä¸­ Scheduler åˆ›å»ºå’Œè¿è¡Œçš„æ ¸å¿ƒç¨‹åºï¼Œå¯¹åº”çš„ä»£ç åœ¨ &lt;code&gt;pkg/scheduler/scheduler.go&lt;/code&gt;ï¼Œå¦‚æœè¦æŸ¥çœ‹ &lt;code&gt;kube-scheduler&lt;/code&gt; çš„å…¥å£ç¨‹åºï¼Œå¯¹åº”çš„ä»£ç åœ¨ &lt;code&gt;cmd/kube-scheduler/scheduler.go&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&quot;è‡ªå®šä¹‰è°ƒåº¦å™¨&quot;&gt;&lt;a href=&quot;#è‡ªå®šä¹‰è°ƒåº¦å™¨&quot; class=&quot;headerlink&quot; title=&quot;è‡ªå®šä¹‰è°ƒåº¦å™¨&quot;&gt;&lt;/a&gt;è‡ªå®šä¹‰è°ƒåº¦å™¨&lt;/h2&gt;&lt;p&gt;ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æœ‰4ç§æ‰©å±• Kubernetes è°ƒåº¦å™¨çš„æ–¹æ³•ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸€ç§æ–¹æ³•å°±æ˜¯ç›´æ¥ clone å®˜æ–¹çš„ kube-scheduler æºä»£ç ï¼Œåœ¨åˆé€‚çš„ä½ç½®ç›´æ¥ä¿®æ”¹ä»£ç ï¼Œç„¶åé‡æ–°ç¼–è¯‘è¿è¡Œä¿®æ”¹åçš„ç¨‹åºï¼Œå½“ç„¶è¿™ç§æ–¹æ³•æ˜¯æœ€ä¸å»ºè®®ä½¿ç”¨çš„ï¼Œä¹Ÿä¸å®ç”¨ï¼Œå› ä¸ºéœ€è¦èŠ±è´¹å¤§é‡é¢å¤–çš„ç²¾åŠ›æ¥å’Œä¸Šæ¸¸çš„è°ƒåº¦ç¨‹åºæ›´æ”¹ä¿æŒä¸€è‡´ã€‚&lt;/li&gt;
&lt;li&gt;ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯å’Œé»˜è®¤çš„è°ƒåº¦ç¨‹åºä¸€èµ·è¿è¡Œç‹¬ç«‹çš„è°ƒåº¦ç¨‹åºï¼Œé»˜è®¤çš„è°ƒåº¦å™¨å’Œæˆ‘ä»¬è‡ªå®šä¹‰çš„è°ƒåº¦å™¨å¯ä»¥é€šè¿‡ Pod çš„ &lt;code&gt;spec.schedulerName&lt;/code&gt; æ¥è¦†ç›–å„è‡ªçš„ Podï¼Œé»˜è®¤æ˜¯ä½¿ç”¨ default é»˜è®¤çš„è°ƒåº¦å™¨ï¼Œä½†æ˜¯å¤šä¸ªè°ƒåº¦ç¨‹åºå…±å­˜çš„æƒ…å†µä¸‹ä¹Ÿæ¯”è¾ƒéº»çƒ¦ï¼Œæ¯”å¦‚å½“å¤šä¸ªè°ƒåº¦å™¨å°† Pod è°ƒåº¦åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼Œå› ä¸ºå¾ˆæœ‰å¯èƒ½ä¸¤ä¸ªè°ƒåº¦å™¨éƒ½åŒæ—¶å°†ä¸¤ä¸ª Pod è°ƒåº¦åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šå»ï¼Œä½†æ˜¯å¾ˆæœ‰å¯èƒ½å…¶ä¸­ä¸€ä¸ª Pod è¿è¡Œåå…¶å®èµ„æºå°±æ¶ˆè€—å®Œäº†ï¼Œå¹¶ä¸”ç»´æŠ¤ä¸€ä¸ªé«˜è´¨é‡çš„è‡ªå®šä¹‰è°ƒåº¦ç¨‹åºä¹Ÿä¸æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å…¨é¢äº†è§£é»˜è®¤çš„è°ƒåº¦ç¨‹åºï¼Œæ•´ä½“ Kubernetes çš„æ¶æ„çŸ¥è¯†ä»¥åŠå„ç§ Kubernetes API å¯¹è±¡çš„å„ç§å…³ç³»æˆ–é™åˆ¶ã€‚&lt;/li&gt;
&lt;li&gt;ç¬¬ä¸‰ç§æ–¹æ³•æ˜¯&lt;a href=&quot;https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/scheduler_extender.md&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;è°ƒåº¦å™¨æ‰©å±•ç¨‹åº&lt;/a&gt;ï¼Œè¿™ä¸ªæ–¹æ¡ˆç›®å‰æ˜¯ä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆï¼Œå¯ä»¥å’Œä¸Šæ¸¸è°ƒåº¦ç¨‹åºå…¼å®¹ï¼Œæ‰€è°“çš„è°ƒåº¦å™¨æ‰©å±•ç¨‹åºå…¶å®å°±æ˜¯ä¸€ä¸ªå¯é…ç½®çš„ Webhook è€Œå·²ï¼Œé‡Œé¢åŒ…å« &lt;code&gt;è¿‡æ»¤å™¨&lt;/code&gt; å’Œ &lt;code&gt;ä¼˜å…ˆçº§&lt;/code&gt; ä¸¤ä¸ªç«¯ç‚¹ï¼Œåˆ†åˆ«å¯¹åº”è°ƒåº¦å‘¨æœŸä¸­çš„ä¸¤ä¸ªä¸»è¦é˜¶æ®µï¼ˆè¿‡æ»¤å’Œæ‰“åˆ†ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;ç¬¬å››ç§æ–¹æ³•æ˜¯é€šè¿‡è°ƒåº¦æ¡†æ¶ï¼ˆScheduling Frameworkï¼‰ï¼ŒKubernetes v1.15 ç‰ˆæœ¬ä¸­å¼•å…¥äº†å¯æ’æ‹”æ¶æ„çš„è°ƒåº¦æ¡†æ¶ï¼Œä½¿å¾—å®šåˆ¶è°ƒåº¦å™¨è¿™ä¸ªä»»åŠ¡å˜å¾—æ›´åŠ çš„å®¹æ˜“ã€‚è°ƒåº“æ¡†æ¶å‘ç°æœ‰çš„è°ƒåº¦å™¨ä¸­æ·»åŠ äº†ä¸€ç»„æ’ä»¶åŒ–çš„ APIï¼Œè¯¥ API åœ¨ä¿æŒè°ƒåº¦ç¨‹åºâ€œæ ¸å¿ƒâ€ç®€å•ä¸”æ˜“äºç»´æŠ¤çš„åŒæ—¶ï¼Œä½¿å¾—å¤§éƒ¨åˆ†çš„è°ƒåº¦åŠŸèƒ½ä»¥æ’ä»¶çš„å½¢å¼å­˜åœ¨ï¼Œè€Œä¸”åœ¨æˆ‘ä»¬ç°åœ¨çš„ v1.16 ç‰ˆæœ¬ä¸­ä¸Šé¢çš„ &lt;code&gt;è°ƒåº¦å™¨æ‰©å±•ç¨‹åº&lt;/code&gt; ä¹Ÿå·²ç»è¢«åºŸå¼ƒäº†ï¼Œæ‰€ä»¥ä»¥åè°ƒåº¦æ¡†æ¶æ‰æ˜¯è‡ªå®šä¹‰è°ƒåº¦å™¨çš„æ ¸å¿ƒæ–¹å¼ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç®€å•ä»‹ç»ä¸‹åé¢ä¸¤ç§æ–¹å¼çš„å®ç°ã€‚&lt;/p&gt;
&lt;h3 id=&quot;è°ƒåº¦å™¨æ‰©å±•ç¨‹åº&quot;&gt;&lt;a href=&quot;#è°ƒåº¦å™¨æ‰©å±•ç¨‹åº&quot; class=&quot;headerlink&quot; title=&quot;è°ƒåº¦å™¨æ‰©å±•ç¨‹åº&quot;&gt;&lt;/a&gt;è°ƒåº¦å™¨æ‰©å±•ç¨‹åº&lt;/h3&gt;&lt;p&gt;åœ¨è¿›å…¥è°ƒåº¦å™¨æ‰©å±•ç¨‹åºä¹‹å‰ï¼Œæˆ‘ä»¬å†æ¥äº†è§£ä¸‹ Kubernetes è°ƒåº¦ç¨‹åºæ˜¯å¦‚ä½•å·¥ä½œçš„:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;é»˜è®¤è°ƒåº¦å™¨æ ¹æ®æŒ‡å®šçš„å‚æ•°å¯åŠ¨ï¼ˆæˆ‘ä»¬ä½¿ç”¨ kubeadm æ­å»ºçš„é›†ç¾¤ï¼Œå¯åŠ¨é…ç½®æ–‡ä»¶ä½äº &lt;code&gt;/etc/kubernetes/manifests/kube-schdueler.yaml&lt;/code&gt;ï¼‰&lt;/li&gt;
&lt;li&gt;watch apiserverï¼Œå°† &lt;code&gt;spec.nodeName&lt;/code&gt; ä¸ºç©ºçš„ Pod æ”¾å…¥è°ƒåº¦å™¨å†…éƒ¨çš„è°ƒåº¦é˜Ÿåˆ—ä¸­&lt;/li&gt;
&lt;li&gt;ä»è°ƒåº¦é˜Ÿåˆ—ä¸­ Pop å‡ºä¸€ä¸ª Podï¼Œå¼€å§‹ä¸€ä¸ªæ ‡å‡†çš„è°ƒåº¦å‘¨æœŸ&lt;/li&gt;
&lt;li&gt;ä» Pod å±æ€§ä¸­æ£€ç´¢â€œç¡¬æ€§è¦æ±‚â€ï¼ˆæ¯”å¦‚ CPU/å†…å­˜è¯·æ±‚å€¼ï¼ŒnodeSelector/nodeAffinityï¼‰ï¼Œç„¶åè¿‡æ»¤é˜¶æ®µå‘ç”Ÿï¼Œåœ¨è¯¥é˜¶æ®µè®¡ç®—å‡ºæ»¡è¶³è¦æ±‚çš„èŠ‚ç‚¹å€™é€‰åˆ—è¡¨&lt;/li&gt;
&lt;li&gt;ä» Pod å±æ€§ä¸­æ£€ç´¢â€œè½¯éœ€æ±‚â€ï¼Œå¹¶åº”ç”¨ä¸€äº›é»˜è®¤çš„â€œè½¯ç­–ç•¥â€ï¼ˆæ¯”å¦‚ Pod å€¾å‘äºåœ¨èŠ‚ç‚¹ä¸Šæ›´åŠ èšæ‹¢æˆ–åˆ†æ•£ï¼‰ï¼Œæœ€åï¼Œå®ƒä¸ºæ¯ä¸ªå€™é€‰èŠ‚ç‚¹ç»™å‡ºä¸€ä¸ªåˆ†æ•°ï¼Œå¹¶æŒ‘é€‰å‡ºå¾—åˆ†æœ€é«˜çš„æœ€ç»ˆè·èƒœè€…&lt;/li&gt;
&lt;li&gt;å’Œ apiserver é€šä¿¡ï¼ˆå‘é€ç»‘å®šè°ƒç”¨ï¼‰ï¼Œç„¶åè®¾ç½® Pod çš„ &lt;code&gt;spec.nodeName&lt;/code&gt; å±æ€§ä»¥è¡¨ç¤ºå°†è¯¥ Pod è°ƒåº¦åˆ°çš„èŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹&lt;a href=&quot;https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;ï¼Œå¯ä»¥é€šè¿‡ &lt;code&gt;--config&lt;/code&gt; å‚æ•°æŒ‡å®šè°ƒåº¦å™¨å°†ä½¿ç”¨å“ªäº›å‚æ•°ï¼Œè¯¥é…ç½®æ–‡ä»¶åº”è¯¥åŒ…å«ä¸€ä¸ª &lt;a href=&quot;https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#KubeSchedulerConfiguration&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;KubeSchedulerConfiguration&lt;/a&gt; å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºæ ¼å¼ï¼šï¼ˆ/etc/kubernetes/scheduler-extender.yaml)&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;# é€šè¿‡&quot;--config&quot; ä¼ é€’æ–‡ä»¶å†…å®¹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; kubescheduler.config.k8s.io/v1alpha1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; KubeSchedulerConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;clientConnection:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  kubeconfig:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/etc/kubernetes/scheduler.conf&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;algorithmSource:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  policy:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    file:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      path:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/etc/kubernetes/scheduler-extender-policy.yaml&quot;&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;# æŒ‡å®šè‡ªå®šä¹‰è°ƒåº¦ç­–ç•¥æ–‡ä»¶&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬åœ¨è¿™é‡Œåº”è¯¥è¾“å…¥çš„å…³é”®å‚æ•°æ˜¯ &lt;code&gt;algorithmSource.policy&lt;/code&gt;ï¼Œè¿™ä¸ªç­–ç•¥æ–‡ä»¶å¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ä¹Ÿå¯ä»¥æ˜¯ ConfigMap èµ„æºå¯¹è±¡ï¼Œè¿™å–å†³äºè°ƒåº¦ç¨‹åºçš„éƒ¨ç½²æ–¹å¼ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œé»˜è®¤çš„è°ƒåº¦å™¨æ˜¯é™æ€ Pod æ–¹å¼å¯åŠ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨æœ¬åœ°æ–‡ä»¶çš„å½¢å¼æ¥é…ç½®ã€‚&lt;/p&gt;
&lt;p&gt;è¯¥ç­–ç•¥æ–‡ä»¶ &lt;code&gt;/etc/kubernetes/scheduler-extender-policy.yaml&lt;/code&gt; åº”è¯¥éµå¾ª &lt;a href=&quot;https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#Policy&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;kubernetes/pkg/scheduler/apis/config/legacy_types.go#L28&lt;/a&gt; çš„è¦æ±‚ï¼Œåœ¨æˆ‘ä»¬è¿™é‡Œçš„ v1.16.2 ç‰ˆæœ¬ä¸­å·²ç»æ”¯æŒ JSON å’Œ YAML ä¸¤ç§æ ¼å¼çš„ç­–ç•¥æ–‡ä»¶ï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬å®šä¹‰çš„ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå¯ä»¥æŸ¥çœ‹ &lt;a href=&quot;https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#Extender&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Extender&lt;/a&gt; æè¿°äº†è§£ç­–ç•¥æ–‡ä»¶çš„å®šä¹‰è§„èŒƒï¼š&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Policy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;extenders:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- urlPrefix:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;http://127.0.0.1:8888/&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  filterVerb:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;filter&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  prioritizeVerb:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;prioritize&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  weight:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  enableHttps:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬è¿™é‡Œçš„ Policy ç­–ç•¥æ–‡ä»¶æ˜¯é€šè¿‡å®šä¹‰ &lt;code&gt;extenders&lt;/code&gt; æ¥æ‰©å±•è°ƒåº¦å™¨çš„ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¸éœ€è¦å»ç¼–å†™ä»£ç ï¼Œå¯ä»¥ç›´æ¥åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­é€šè¿‡æŒ‡å®š &lt;code&gt;predicates&lt;/code&gt; å’Œ &lt;code&gt;priorities&lt;/code&gt; æ¥è¿›è¡Œè‡ªå®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šåˆ™ä¼šä½¿ç”¨é»˜è®¤çš„ &lt;code&gt;DefaultProvier&lt;/code&gt;ï¼š&lt;br&gt;&lt;figure class=&quot;highlight json&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;&quot;kind&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;Policy&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;&quot;apiVersion&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;v1&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;&quot;predicates&quot;&lt;/span&gt;: [&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;MatchNodeSelector&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;, &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;PodFitsResources&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;, &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;PodFitsHostPorts&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;,&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;HostName&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ],&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;&quot;priorities&quot;&lt;/span&gt;: [&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;EqualPriority&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;weight&quot;&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;, &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;ImageLocalityPriority&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;weight&quot;&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;, &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;LeastRequestedPriority&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;weight&quot;&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;, &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;BalancedResourceAllocation&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;weight&quot;&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ],&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;&quot;extenders&quot;&lt;/span&gt;: [&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;urlPrefix&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;/prefix&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;filterVerb&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;filter&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;prioritizeVerb&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;prioritize&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;weight&quot;&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;bindVerb&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;bind&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;&quot;enableHttps&quot;&lt;/span&gt;: &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ”¹ç­–ç•¥æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ª HTTP çš„æ‰©å±•ç¨‹åºæœåŠ¡ï¼Œè¯¥æœåŠ¡è¿è¡Œåœ¨ &lt;code&gt;127.0.0.1:8888&lt;/code&gt; ä¸‹é¢ï¼Œå¹¶ä¸”å·²ç»å°†è¯¥ç­–ç•¥æ³¨å†Œåˆ°äº†é»˜è®¤çš„è°ƒåº¦å™¨ä¸­ï¼Œè¿™æ ·åœ¨è¿‡æ»¤å’Œæ‰“åˆ†é˜¶æ®µç»“æŸåï¼Œå¯ä»¥å°†ç»“æœåˆ†åˆ«ä¼ é€’ç»™è¯¥æ‰©å±•ç¨‹åºçš„ç«¯ç‚¹ &lt;code&gt;&amp;lt;urlPrefix&amp;gt;/&amp;lt;filterVerb&amp;gt;&lt;/code&gt; å’Œ &lt;code&gt;&amp;lt;urlPrefix&amp;gt;/&amp;lt;prioritizeVerb&amp;gt;&lt;/code&gt;ï¼Œåœ¨æ‰©å±•ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥è¿‡æ»¤å¹¶ç¡®å®šä¼˜å…ˆçº§ï¼Œä»¥é€‚åº”æˆ‘ä»¬çš„ç‰¹å®šä¸šåŠ¡éœ€æ±‚ã€‚&lt;/p&gt;
&lt;h4 id=&quot;ç¤ºä¾‹&quot;&gt;&lt;a href=&quot;#ç¤ºä¾‹&quot; class=&quot;headerlink&quot; title=&quot;ç¤ºä¾‹&quot;&gt;&lt;/a&gt;ç¤ºä¾‹&lt;/h4&gt;&lt;p&gt;æˆ‘ä»¬ç›´æ¥ç”¨ golang æ¥å®ç°ä¸€ä¸ªç®€å•çš„è°ƒåº¦å™¨æ‰©å±•ç¨‹åºï¼Œå½“ç„¶ä½ å¯ä»¥ä½¿ç”¨å…¶ä»–ä»»ä½•ç¼–ç¨‹è¯­è¨€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    router := httprouter.New()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    router.GET(&lt;span class=&quot;string&quot;&gt;&quot;/&quot;&lt;/span&gt;, Index)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    router.POST(&lt;span class=&quot;string&quot;&gt;&quot;/filter&quot;&lt;/span&gt;, Filter)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    router.POST(&lt;span class=&quot;string&quot;&gt;&quot;/prioritize&quot;&lt;/span&gt;, Prioritize)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Fatal(http.ListenAndServe(&lt;span class=&quot;string&quot;&gt;&quot;:8888&quot;&lt;/span&gt;, router))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç„¶åæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç° &lt;code&gt;/filter&lt;/code&gt; å’Œ &lt;code&gt;/prioritize&lt;/code&gt; ä¸¤ä¸ªç«¯ç‚¹çš„å¤„ç†ç¨‹åºã€‚&lt;/p&gt;
&lt;p&gt;å…¶ä¸­ &lt;code&gt;Filter&lt;/code&gt; è¿™ä¸ªæ‰©å±•å‡½æ•°æ¥æ”¶ä¸€ä¸ªè¾“å…¥ç±»å‹ä¸º &lt;code&gt;schedulerapi.ExtenderArgs&lt;/code&gt; çš„å‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªç±»å‹ä¸º &lt;code&gt;*schedulerapi.ExtenderFilterResult&lt;/code&gt; çš„å€¼ã€‚åœ¨å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥è¿‡æ»¤è¾“å…¥çš„èŠ‚ç‚¹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// filter æ ¹æ®æ‰©å±•ç¨‹åºå®šä¹‰çš„é¢„é€‰è§„åˆ™æ¥è¿‡æ»¤èŠ‚ç‚¹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(args schedulerapi.ExtenderArgs)&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;schedulerapi&lt;/span&gt;.&lt;span class=&quot;title&quot;&gt;ExtenderFilterResult&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; filteredNodes []v1.Node&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	failedNodes := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(schedulerapi.FailedNodesMap)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	pod := args.Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; _, node := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; args.Nodes.Items &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		fits, failReasons, _ := podFitsOnNode(pod, node)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; fits &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			filteredNodes = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(filteredNodes, node)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			failedNodes[node.Name] = strings.Join(failReasons, &lt;span class=&quot;string&quot;&gt;&quot;,&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	result := schedulerapi.ExtenderFilterResult&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		Nodes: &amp;amp;v1.NodeList&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			Items: filteredNodes,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		FailedNodes: failedNodes,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		Error:       &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &amp;amp;result&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åœ¨è¿‡æ»¤å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¾ªç¯æ¯ä¸ªèŠ‚ç‚¹ç„¶åç”¨æˆ‘ä»¬è‡ªå·±å®ç°çš„ä¸šåŠ¡é€»è¾‘æ¥åˆ¤æ–­æ˜¯å¦åº”è¯¥æ‰¹å‡†è¯¥èŠ‚ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬å®ç°æ¯”è¾ƒç®€å•ï¼Œåœ¨ &lt;code&gt;podFitsOnNode()&lt;/code&gt; å‡½æ•°ä¸­æˆ‘ä»¬åªæ˜¯ç®€å•çš„æ£€æŸ¥éšæœºæ•°æ˜¯å¦ä¸ºå¶æ•°æ¥åˆ¤æ–­å³å¯ï¼Œå¦‚æœæ˜¯çš„è¯æˆ‘ä»¬å°±è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå¹¸è¿çš„èŠ‚ç‚¹ï¼Œå¦åˆ™æ‹’ç»æ‰¹å‡†è¯¥èŠ‚ç‚¹ã€‚&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; predicatesSorted = []&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;&amp;#123;LuckyPred&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; predicatesFuncs = &lt;span class=&quot;keyword&quot;&gt;map&lt;/span&gt;[&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;]FitPredicate&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    LuckyPred: LuckyPredicate,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; FitPredicate &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(pod *v1.Pod, node v1.Node)&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;, []&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;, error)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;podFitsOnNode&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(pod *v1.Pod, node v1.Node)&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;, []&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;, error)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fits := &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; failReasons []&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; _, predicateKey := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; predicatesSorted &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        fit, failures, err := predicatesFuncs[predicateKey](pod, node)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;, err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        fits = fits &amp;amp;&amp;amp; fit&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        failReasons = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(failReasons, failures...)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; fits, failReasons, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;LuckyPredicate&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(pod *v1.Pod, node v1.Node)&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;, []&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;, error)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    lucky := rand.Intn(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; lucky &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        log.Printf(&lt;span class=&quot;string&quot;&gt;&quot;pod %v/%v is lucky to fit on node %v\n&quot;&lt;/span&gt;, pod.Name, pod.Namespace, node.Name)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Printf(&lt;span class=&quot;string&quot;&gt;&quot;pod %v/%v is unlucky to fit on node %v\n&quot;&lt;/span&gt;, pod.Name, pod.Namespace, node.Name)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;, []&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;&amp;#123;LuckyPredFailMsg&amp;#125;, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åŒæ ·çš„æ‰“åˆ†åŠŸèƒ½ç”¨åŒæ ·çš„æ–¹å¼æ¥å®ç°ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéšæœºç»™å‡ºä¸€ä¸ªåˆ†æ•°ï¼š&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// it&#39;s webhooked to pkg/scheduler/core/generic_scheduler.go#PrioritizeNodes()&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// è¿™ä¸ªå‡½æ•°è¾“å‡ºçš„åˆ†æ•°ä¼šè¢«æ·»åŠ ä¼šé»˜è®¤çš„è°ƒåº¦å™¨&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;prioritize&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(args schedulerapi.ExtenderArgs)&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;schedulerapi&lt;/span&gt;.&lt;span class=&quot;title&quot;&gt;HostPriorityList&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	pod := args.Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	nodes := args.Nodes.Items&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	hostPriorityList := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(schedulerapi.HostPriorityList, &lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(nodes))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i, node := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; nodes &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		score := rand.Intn(schedulerapi.MaxPriority + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)  &lt;span class=&quot;comment&quot;&gt;// åœ¨æœ€å¤§ä¼˜å…ˆçº§å†…éšæœºå–ä¸€ä¸ªå€¼&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		log.Printf(luckyPrioMsg, pod.Name, pod.Namespace, score)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		hostPriorityList[i] = schedulerapi.HostPriority&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			Host:  node.Name,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			Score: score,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &amp;amp;hostPriorityList&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥ç¼–è¯‘æ‰“åŒ…æˆ‘ä»¬çš„åº”ç”¨ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ GOOS=linux GOARCH=amd64 go build -o app&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æœ¬èŠ‚è°ƒåº¦å™¨æ‰©å±•ç¨‹åºå®Œæ•´çš„ä»£ç è·å–åœ°å€ï¼š&lt;a href=&quot;https://github.com/icyxp/sample-scheduler-extender&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/icyxp/sample-scheduler-extender&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æ„å»ºå®Œæˆåï¼Œå°†åº”ç”¨ &lt;code&gt;app&lt;/code&gt; æ‹·è´åˆ° &lt;code&gt;kube-scheduler&lt;/code&gt; æ‰€åœ¨çš„èŠ‚ç‚¹ç›´æ¥è¿è¡Œå³å¯ã€‚ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥å°†ä¸Šé¢çš„ç­–ç•¥æ–‡ä»¶é…ç½®åˆ° &lt;code&gt;kube-scheduler&lt;/code&gt; ç»„ä»¶ä¸­å»äº†ï¼Œæˆ‘ä»¬è¿™é‡Œé›†ç¾¤æ˜¯ kubeadm æ­å»ºçš„ï¼Œæ‰€ä»¥ç›´æ¥ä¿®æ”¹æ–‡ä»¶ &lt;code&gt;/etc/kubernetes/manifests/kube-schduler.yaml&lt;/code&gt; æ–‡ä»¶å³å¯ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  creationTimestamp:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    component:&lt;/span&gt; kube-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    tier:&lt;/span&gt; control-plane&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; kube-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - command:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; kube-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; --authentication-kubeconfig=/etc/kubernetes/scheduler.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; --authorization-kubeconfig=/etc/kubernetes/scheduler.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; --bind-address=&lt;span class=&quot;number&quot;&gt;127.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; --kubeconfig=/etc/kubernetes/scheduler.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; --leader-elect=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; --config=/etc/kubernetes/scheduler-extender.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;    -&lt;/span&gt; --v=&lt;span class=&quot;number&quot;&gt;9&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    image:&lt;/span&gt; gcr.azk8s.cn/google_containers/kube-scheduler:v1&lt;span class=&quot;number&quot;&gt;.16&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    imagePullPolicy:&lt;/span&gt; IfNotPresent&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    livenessProbe:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      failureThreshold:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      httpGet:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        host:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;127.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        path:&lt;/span&gt; /healthz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10251&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        scheme:&lt;/span&gt; HTTP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      initialDelaySeconds:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;15&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      timeoutSeconds:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;15&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    name:&lt;/span&gt; kube-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      requests:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        cpu:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    volumeMounts:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - mountPath:&lt;/span&gt; /etc/kubernetes/scheduler.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      name:&lt;/span&gt; kubeconfig&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      readOnly:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - mountPath:&lt;/span&gt; /etc/kubernetes/scheduler-extender.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      name:&lt;/span&gt; extender&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      readOnly:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - mountPath:&lt;/span&gt; /etc/kubernetes/scheduler-extender-policy.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      name:&lt;/span&gt; extender-policy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      readOnly:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  hostNetwork:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  priorityClassName:&lt;/span&gt; system-cluster-critical&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  volumes:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - hostPath:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      path:&lt;/span&gt; /etc/kubernetes/scheduler.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      type:&lt;/span&gt; FileOrCreate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    name:&lt;/span&gt; kubeconfig&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - hostPath:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      path:&lt;/span&gt; /etc/kubernetes/scheduler-extender.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      type:&lt;/span&gt; FileOrCreate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    name:&lt;/span&gt; extender&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - hostPath:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      path:&lt;/span&gt; /etc/kubernetes/scheduler-extender-policy.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      type:&lt;/span&gt; FileOrCreate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    name:&lt;/span&gt; extender-policy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;status:&lt;/span&gt; &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å½“ç„¶æˆ‘ä»¬è¿™ä¸ªåœ°æ–¹æ˜¯ç›´æ¥åœ¨ç³»ç»Ÿé»˜è®¤çš„ &lt;code&gt;kube-scheduler&lt;/code&gt; ä¸Šé¢é…ç½®çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¤åˆ¶ä¸€ä¸ªè°ƒåº¦å™¨çš„ YAML æ–‡ä»¶ç„¶åæ›´æ”¹ä¸‹ schedulerName æ¥éƒ¨ç½²ï¼Œè¿™æ ·å°±ä¸ä¼šå½±å“é»˜è®¤çš„è°ƒåº¦å™¨äº†ï¼Œç„¶ååœ¨éœ€è¦ä½¿ç”¨è¿™ä¸ªæµ‹è¯•çš„è°ƒåº¦å™¨çš„ Pod ä¸Šé¢æŒ‡å®š &lt;code&gt;spec.schedulerName&lt;/code&gt; å³å¯ã€‚å¯¹äºå¤šè°ƒåº¦å™¨çš„ä½¿ç”¨å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ &lt;a href=&quot;https://kubernetes.io/zh/docs/tasks/administer-cluster/configure-multiple-schedulers/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;é…ç½®å¤šä¸ªè°ƒåº¦å™¨&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code&gt;kube-scheduler&lt;/code&gt; é‡æ–°é…ç½®åå¯ä»¥æŸ¥çœ‹æ—¥å¿—æ¥éªŒè¯æ˜¯å¦é‡å¯æˆåŠŸï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸€å®šéœ€è¦å°† &lt;code&gt;/etc/kubernetes/scheduler-extender.yaml&lt;/code&gt; å’Œ &lt;code&gt;/etc/kubernetes/scheduler-extender-policy.yaml&lt;/code&gt; ä¸¤ä¸ªæ–‡ä»¶æŒ‚è½½åˆ° Pod ä¸­å»ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl logs &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; kube-scheduler-ydzs-master -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0102 15:17:38.824657       1 serving.go:319] Generated self-signed cert &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt;-memory&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0102 15:17:39.472276       1 server.go:143] Version: v1.16.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0102 15:17:39.472674       1 defaults.go:91] TaintNodesByCondition is enabled, PodToleratesNodeTaints predicate is mandatory&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;W0102 15:17:39.479704       1 authorization.go:47] Authorization is disabled&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;W0102 15:17:39.479733       1 authentication.go:79] Authentication is disabled&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0102 15:17:39.479777       1 deprecated_insecure_serving.go:51] Serving healthz insecurely on [::]:10251&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0102 15:17:39.480559       1 secure_serving.go:123] Serving securely on 127.0.0.1:10259&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0102 15:17:39.682180       1 leaderelection.go:241] attempting to acquire leader lease  kube-system/kube-scheduler...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0102 15:17:56.500505       1 leaderelection.go:251] successfully acquired lease kube-system/kube-scheduler&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åˆ°è¿™é‡Œæˆ‘ä»¬å°±åˆ›å»ºå¹¶é…ç½®äº†ä¸€ä¸ªéå¸¸ç®€å•çš„è°ƒåº¦æ‰©å±•ç¨‹åºï¼Œç°åœ¨æˆ‘ä»¬æ¥è¿è¡Œä¸€ä¸ª Deployment æŸ¥çœ‹å…¶å·¥ä½œåŸç†ï¼Œæˆ‘ä»¬å‡†å¤‡ä¸€ä¸ªåŒ…å«20ä¸ªå‰¯æœ¬çš„éƒ¨ç½² Yamlï¼š(test-scheduler.yaml)&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; apps/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; pause&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  replicas:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  selector:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    matchLabels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      app:&lt;/span&gt; pause&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  template:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        app:&lt;/span&gt; pause&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - name:&lt;/span&gt; pause&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        image:&lt;/span&gt; gcr.azk8s.cn/google_containers/pause:&lt;span class=&quot;number&quot;&gt;3.1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç›´æ¥åˆ›å»ºä¸Šé¢çš„èµ„æºå¯¹è±¡ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kuectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-scheduler.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deployment.apps/pause created&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å»æŸ¥çœ‹ä¸‹æˆ‘ä»¬ç¼–å†™çš„è°ƒåº¦å™¨æ‰©å±•ç¨‹åºæ—¥å¿—ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ ./app&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;......&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is unlucky to fit on node ydzs-node1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is lucky to get score 7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is lucky to get score 9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is unlucky to fit on node ydzs-node3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is unlucky to fit on node ydzs-node4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to fit on node ydzs-node1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to fit on node ydzs-node2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to get score 4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to get score 8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;......&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Pod è°ƒåº¦çš„è¿‡ç¨‹ï¼Œå¦å¤–é»˜è®¤è°ƒåº¦ç¨‹åºä¼šå®šæœŸé‡è¯•å¤±è´¥çš„ Podï¼Œå› æ­¤å®ƒä»¬å°†ä¸€æ¬¡åˆä¸€æ¬¡åœ°é‡æ–°ä¼ é€’åˆ°æˆ‘ä»¬çš„è°ƒåº¦æ‰©å±•ç¨‹åºä¸Šï¼Œæˆ‘ä»¬çš„é€»è¾‘æ˜¯æ£€æŸ¥éšæœºæ•°æ˜¯å¦ä¸ºå¶æ•°ï¼Œæ‰€ä»¥æœ€ç»ˆæ‰€æœ‰ Pod éƒ½å°†å¤„äºè¿è¡ŒçŠ¶æ€ã€‚&lt;/p&gt;
&lt;p&gt;è°ƒåº¦å™¨æ‰©å±•ç¨‹åºå¯èƒ½æ˜¯åœ¨ä¸€äº›æƒ…å†µä¸‹å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†æ˜¯ä»–ä»ç„¶æœ‰ä¸€äº›é™åˆ¶å’Œç¼ºç‚¹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é€šä¿¡æˆæœ¬ï¼šæ•°æ®åœ¨é»˜è®¤è°ƒåº¦ç¨‹åºå’Œè°ƒåº¦å™¨æ‰©å±•ç¨‹åºä¹‹é—´ä»¥ &lt;code&gt;httpï¼ˆsï¼‰&lt;/code&gt; ä¼ è¾“ï¼Œåœ¨æ‰§è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ—¶å€™æœ‰ä¸€å®šæˆæœ¬&lt;/li&gt;
&lt;li&gt;æœ‰é™çš„æ‰©å±•ç‚¹ï¼šæ‰©å±•ç¨‹åºåªèƒ½åœ¨æŸäº›é˜¶æ®µçš„æœ«å°¾å‚ä¸ï¼Œä¾‹å¦‚ &lt;code&gt;â€œFilterâ€&lt;/code&gt; å’Œ &lt;code&gt;â€œPrioritizeâ€&lt;/code&gt; ï¼Œå®ƒä»¬ä¸èƒ½åœ¨ä»»ä½•é˜¶æ®µçš„å¼€å§‹æˆ–ä¸­é—´è¢«è°ƒç”¨&lt;/li&gt;
&lt;li&gt;å‡æ³•ä¼˜äºåŠ æ³•ï¼šä¸é»˜è®¤è°ƒåº¦ç¨‹åºä¼ é€’çš„èŠ‚ç‚¹å€™é€‰åˆ—è¡¨ç›¸æ¯”ï¼Œæˆ‘ä»¬å¯èƒ½æœ‰ä¸€äº›éœ€æ±‚éœ€è¦æ·»åŠ æ–°çš„å€™é€‰èŠ‚ç‚¹åˆ—è¡¨ï¼Œä½†è¿™æ˜¯æ¯”è¾ƒå†’é™©çš„æ“ä½œï¼Œå› ä¸ºä¸èƒ½ä¿è¯æ–°èŠ‚ç‚¹å¯ä»¥é€šè¿‡å…¶ä»–è¦æ±‚ï¼Œæ‰€ä»¥ï¼Œè°ƒåº¦å™¨æ‰©å±•ç¨‹åºæœ€å¥½æ‰§è¡Œ &lt;code&gt;â€œå‡æ³•â€&lt;/code&gt;ï¼ˆè¿›ä¸€æ­¥è¿‡æ»¤ï¼‰ï¼Œè€Œä¸æ˜¯ &lt;code&gt;â€œåŠ æ³•â€&lt;/code&gt;ï¼ˆæ·»åŠ èŠ‚ç‚¹ï¼‰&lt;/li&gt;
&lt;li&gt;ç¼“å­˜å…±äº«ï¼šä¸Šé¢åªæ˜¯ä¸€ä¸ªç®€å•çš„æµ‹è¯•ç¤ºä¾‹ï¼Œä½†åœ¨çœŸå®çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬æ˜¯éœ€è¦é€šè¿‡æŸ¥çœ‹æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€æ¥åšå‡ºè°ƒåº¦å†³ç­–çš„ï¼Œé»˜è®¤è°ƒåº¦ç¨‹åºå¯ä»¥å¾ˆå¥½åœ°è°ƒåº¦å†³ç­–ï¼Œä½†æ˜¯æ— æ³•å…±äº«å…¶ç¼“å­˜ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¿…é¡»æ„å»ºå’Œç»´æŠ¤è‡ªå·±çš„ç¼“å­˜&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ç”±äºè¿™äº›å±€é™æ€§ï¼ŒKubernetes è°ƒåº¦å°ç»„å°±æå‡ºäº†ä¸Šé¢ç¬¬å››ç§æ–¹æ³•æ¥è¿›è¡Œæ›´å¥½çš„æ‰©å±•ï¼Œä¹Ÿå°±æ˜¯&lt;code&gt;è°ƒåº¦æ¡†æ¶ï¼ˆScheduler Frameworkï¼‰&lt;/code&gt;ï¼Œå®ƒåŸºæœ¬ä¸Šå¯ä»¥è§£å†³æˆ‘ä»¬é‡åˆ°çš„æ‰€æœ‰éš¾é¢˜ï¼Œç°åœ¨ä¹Ÿå·²ç»æˆå®˜æ–¹æ¨èçš„æ‰©å±•æ–¹å¼ï¼Œæ‰€ä»¥è¿™å°†æ˜¯ä»¥åæ‰©å±•è°ƒåº¦å™¨çš„æœ€ä¸»æµçš„æ–¹å¼ã€‚&lt;/p&gt;
&lt;h2 id=&quot;è°ƒåº¦æ¡†æ¶&quot;&gt;&lt;a href=&quot;#è°ƒåº¦æ¡†æ¶&quot; class=&quot;headerlink&quot; title=&quot;è°ƒåº¦æ¡†æ¶&quot;&gt;&lt;/a&gt;è°ƒåº¦æ¡†æ¶&lt;/h2&gt;&lt;p&gt;è°ƒåº¦æ¡†æ¶å®šä¹‰äº†ä¸€ç»„æ‰©å±•ç‚¹ï¼Œç”¨æˆ·å¯ä»¥å®ç°æ‰©å±•ç‚¹å®šä¹‰çš„æ¥å£æ¥å®šä¹‰è‡ªå·±çš„è°ƒåº¦é€»è¾‘ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºæ‰©å±•ï¼‰ï¼Œå¹¶å°†æ‰©å±•æ³¨å†Œåˆ°æ‰©å±•ç‚¹ä¸Šï¼Œè°ƒåº¦æ¡†æ¶åœ¨æ‰§è¡Œè°ƒåº¦å·¥ä½œæµæ—¶ï¼Œé‡åˆ°å¯¹åº”çš„æ‰©å±•ç‚¹æ—¶ï¼Œå°†è°ƒç”¨ç”¨æˆ·æ³¨å†Œçš„æ‰©å±•ã€‚è°ƒåº¦æ¡†æ¶åœ¨é¢„ç•™æ‰©å±•ç‚¹æ—¶ï¼Œéƒ½æ˜¯æœ‰ç‰¹å®šçš„ç›®çš„ï¼Œæœ‰äº›æ‰©å±•ç‚¹ä¸Šçš„æ‰©å±•å¯ä»¥æ”¹å˜è°ƒåº¦ç¨‹åºçš„å†³ç­–æ–¹æ³•ï¼Œæœ‰äº›æ‰©å±•ç‚¹ä¸Šçš„æ‰©å±•åªæ˜¯å‘é€ä¸€ä¸ªé€šçŸ¥ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬çŸ¥é“æ¯å½“è°ƒåº¦ä¸€ä¸ª Pod æ—¶ï¼Œéƒ½ä¼šæŒ‰ç…§ä¸¤ä¸ªè¿‡ç¨‹æ¥æ‰§è¡Œï¼šè°ƒåº¦è¿‡ç¨‹å’Œç»‘å®šè¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;è°ƒåº¦è¿‡ç¨‹ä¸º Pod é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„èŠ‚ç‚¹ï¼Œç»‘å®šè¿‡ç¨‹åˆ™å°†è°ƒåº¦è¿‡ç¨‹çš„å†³ç­–åº”ç”¨åˆ°é›†ç¾¤ä¸­ï¼ˆä¹Ÿå°±æ˜¯åœ¨è¢«é€‰å®šçš„èŠ‚ç‚¹ä¸Šè¿è¡Œ Podï¼‰ï¼Œå°†è°ƒåº¦è¿‡ç¨‹å’Œç»‘å®šè¿‡ç¨‹åˆåœ¨ä¸€èµ·ï¼Œç§°ä¹‹ä¸ºè°ƒåº¦ä¸Šä¸‹æ–‡ï¼ˆ&lt;strong&gt;scheduling context&lt;/strong&gt;ï¼‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è°ƒåº¦è¿‡ç¨‹æ˜¯&lt;code&gt;åŒæ­¥&lt;/code&gt;è¿è¡Œçš„ï¼ˆåŒä¸€æ—¶é—´ç‚¹åªä¸ºä¸€ä¸ª Pod è¿›è¡Œè°ƒåº¦ï¼‰ï¼Œç»‘å®šè¿‡ç¨‹å¯å¼‚æ­¥è¿è¡Œï¼ˆåŒä¸€æ—¶é—´ç‚¹å¯å¹¶å‘ä¸ºå¤šä¸ª Pod æ‰§è¡Œç»‘å®šï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;è°ƒåº¦è¿‡ç¨‹å’Œç»‘å®šè¿‡ç¨‹é‡åˆ°å¦‚ä¸‹æƒ…å†µæ—¶ä¼šä¸­é€”é€€å‡ºï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è°ƒåº¦ç¨‹åºè®¤ä¸ºå½“å‰æ²¡æœ‰è¯¥ Pod çš„å¯é€‰èŠ‚ç‚¹&lt;/li&gt;
&lt;li&gt;å†…éƒ¨é”™è¯¯&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™ä¸ªæ—¶å€™ï¼Œè¯¥ Pod å°†è¢«æ”¾å›åˆ° å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œå¹¶ç­‰å¾…ä¸‹æ¬¡é‡è¯•ã€‚&lt;/p&gt;
&lt;h3 id=&quot;æ‰©å±•ç‚¹ï¼ˆExtension-Pointsï¼‰&quot;&gt;&lt;a href=&quot;#æ‰©å±•ç‚¹ï¼ˆExtension-Pointsï¼‰&quot; class=&quot;headerlink&quot; title=&quot;æ‰©å±•ç‚¹ï¼ˆExtension Pointsï¼‰&quot;&gt;&lt;/a&gt;æ‰©å±•ç‚¹ï¼ˆExtension Pointsï¼‰&lt;/h3&gt;&lt;p&gt;ä¸‹å›¾å±•ç¤ºäº†è°ƒåº¦æ¡†æ¶ä¸­çš„è°ƒåº¦ä¸Šä¸‹æ–‡åŠå…¶ä¸­çš„æ‰©å±•ç‚¹ï¼Œä¸€ä¸ªæ‰©å±•å¯ä»¥æ³¨å†Œå¤šä¸ªæ‰©å±•ç‚¹ï¼Œä»¥ä¾¿å¯ä»¥æ‰§è¡Œæ›´å¤æ‚çš„æœ‰çŠ¶æ€çš„ä»»åŠ¡ã€‚&lt;br&gt;&lt;img src=&quot;/images/k8s/scheduling-framework-extensions.png&quot; alt=&quot;scheduling-framework-extensions&quot;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;QueueSort&lt;/code&gt; æ‰©å±•ç”¨äºå¯¹ Pod çš„å¾…è°ƒåº¦é˜Ÿåˆ—è¿›è¡Œæ’åºï¼Œä»¥å†³å®šå…ˆè°ƒåº¦å“ªä¸ª Podï¼Œ&lt;code&gt;QueueSort&lt;/code&gt; æ‰©å±•æœ¬è´¨ä¸Šåªéœ€è¦å®ç°ä¸€ä¸ªæ–¹æ³• &lt;code&gt;Less(Pod1, Pod2)&lt;/code&gt; ç”¨äºæ¯”è¾ƒä¸¤ä¸ª Pod è°æ›´ä¼˜å…ˆè·å¾—è°ƒåº¦å³å¯ï¼ŒåŒä¸€æ—¶é—´ç‚¹åªèƒ½æœ‰ä¸€ä¸ª &lt;code&gt;QueueSort&lt;/code&gt; æ’ä»¶ç”Ÿæ•ˆã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Pre-filter&lt;/code&gt; æ‰©å±•ç”¨äºå¯¹ Pod çš„ä¿¡æ¯è¿›è¡Œé¢„å¤„ç†ï¼Œæˆ–è€…æ£€æŸ¥ä¸€äº›é›†ç¾¤æˆ– Pod å¿…é¡»æ»¡è¶³çš„å‰ææ¡ä»¶ï¼Œå¦‚æœ &lt;code&gt;pre-filter&lt;/code&gt; è¿”å›äº† errorï¼Œåˆ™è°ƒåº¦è¿‡ç¨‹ç»ˆæ­¢ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Filter&lt;/code&gt; æ‰©å±•ç”¨äºæ’é™¤é‚£äº›ä¸èƒ½è¿è¡Œè¯¥ Pod çš„èŠ‚ç‚¹ï¼Œå¯¹äºæ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè°ƒåº¦å™¨å°†æŒ‰é¡ºåºæ‰§è¡Œ &lt;code&gt;filter&lt;/code&gt; æ‰©å±•ï¼›å¦‚æœä»»ä½•ä¸€ä¸ª &lt;code&gt;filter&lt;/code&gt; å°†èŠ‚ç‚¹æ ‡è®°ä¸ºä¸å¯é€‰ï¼Œåˆ™ä½™ä¸‹çš„ &lt;code&gt;filter&lt;/code&gt; æ‰©å±•å°†ä¸ä¼šè¢«æ‰§è¡Œã€‚è°ƒåº¦å™¨å¯ä»¥åŒæ—¶å¯¹å¤šä¸ªèŠ‚ç‚¹æ‰§è¡Œ &lt;code&gt;filter&lt;/code&gt; æ‰©å±•ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Post-filter&lt;/code&gt; æ˜¯ä¸€ä¸ªé€šçŸ¥ç±»å‹çš„æ‰©å±•ç‚¹ï¼Œè°ƒç”¨è¯¥æ‰©å±•çš„å‚æ•°æ˜¯ &lt;code&gt;filter&lt;/code&gt; é˜¶æ®µç»“æŸåè¢«ç­›é€‰ä¸ºå¯é€‰èŠ‚ç‚¹çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¯ä»¥åœ¨æ‰©å±•ä¸­ä½¿ç”¨è¿™äº›ä¿¡æ¯æ›´æ–°å†…éƒ¨çŠ¶æ€ï¼Œæˆ–è€…äº§ç”Ÿæ—¥å¿—æˆ– metrics ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Scoring&lt;/code&gt; æ‰©å±•ç”¨äºä¸ºæ‰€æœ‰å¯é€‰èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†ï¼Œè°ƒåº¦å™¨å°†é’ˆå¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹è°ƒç”¨ &lt;code&gt;Soring&lt;/code&gt; æ‰©å±•ï¼Œè¯„åˆ†ç»“æœæ˜¯ä¸€ä¸ªèŒƒå›´å†…çš„æ•´æ•°ã€‚åœ¨ &lt;code&gt;normalize scoring&lt;/code&gt; é˜¶æ®µï¼Œè°ƒåº¦å™¨å°†ä¼šæŠŠæ¯ä¸ª &lt;code&gt;scoring&lt;/code&gt; æ‰©å±•å¯¹å…·ä½“æŸä¸ªèŠ‚ç‚¹çš„è¯„åˆ†ç»“æœå’Œè¯¥æ‰©å±•çš„æƒé‡åˆå¹¶èµ·æ¥ï¼Œä½œä¸ºæœ€ç»ˆè¯„åˆ†ç»“æœã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Normalize scoring&lt;/code&gt; æ‰©å±•åœ¨è°ƒåº¦å™¨å¯¹èŠ‚ç‚¹è¿›è¡Œæœ€ç»ˆæ’åºä¹‹å‰ä¿®æ”¹æ¯ä¸ªèŠ‚ç‚¹çš„è¯„åˆ†ç»“æœï¼Œæ³¨å†Œåˆ°è¯¥æ‰©å±•ç‚¹çš„æ‰©å±•åœ¨è¢«è°ƒç”¨æ—¶ï¼Œå°†è·å¾—åŒä¸€ä¸ªæ’ä»¶ä¸­çš„ &lt;code&gt;scoring&lt;/code&gt; æ‰©å±•çš„è¯„åˆ†ç»“æœä½œä¸ºå‚æ•°ï¼Œè°ƒåº¦æ¡†æ¶æ¯æ‰§è¡Œä¸€æ¬¡è°ƒåº¦ï¼Œéƒ½å°†è°ƒç”¨æ‰€æœ‰æ’ä»¶ä¸­çš„ä¸€ä¸ª &lt;code&gt;normalize scoring&lt;/code&gt; æ‰©å±•ä¸€æ¬¡ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Reserve&lt;/code&gt; æ˜¯ä¸€ä¸ªé€šçŸ¥æ€§è´¨çš„æ‰©å±•ç‚¹ï¼Œæœ‰çŠ¶æ€çš„æ’ä»¶å¯ä»¥ä½¿ç”¨è¯¥æ‰©å±•ç‚¹æ¥è·å¾—èŠ‚ç‚¹ä¸Šä¸º Pod é¢„ç•™çš„èµ„æºï¼Œè¯¥äº‹ä»¶å‘ç”Ÿåœ¨è°ƒåº¦å™¨å°† Pod ç»‘å®šåˆ°èŠ‚ç‚¹ä¹‹å‰ï¼Œç›®çš„æ˜¯é¿å…è°ƒåº¦å™¨åœ¨ç­‰å¾… Pod ä¸èŠ‚ç‚¹ç»‘å®šçš„è¿‡ç¨‹ä¸­è°ƒåº¦æ–°çš„ Pod åˆ°èŠ‚ç‚¹ä¸Šæ—¶ï¼Œå‘ç”Ÿå®é™…ä½¿ç”¨èµ„æºè¶…å‡ºå¯ç”¨èµ„æºçš„æƒ…å†µã€‚ï¼ˆå› ä¸ºç»‘å®š Pod åˆ°èŠ‚ç‚¹ä¸Šæ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼‰ã€‚è¿™æ˜¯è°ƒåº¦è¿‡ç¨‹çš„æœ€åä¸€ä¸ªæ­¥éª¤ï¼ŒPod è¿›å…¥ &lt;code&gt;reserved&lt;/code&gt; çŠ¶æ€ä»¥åï¼Œè¦ä¹ˆåœ¨ç»‘å®šå¤±è´¥æ—¶è§¦å‘ &lt;code&gt;Unreserve&lt;/code&gt; æ‰©å±•ï¼Œè¦ä¹ˆåœ¨ç»‘å®šæˆåŠŸæ—¶ï¼Œç”± &lt;code&gt;Post-bind&lt;/code&gt; æ‰©å±•ç»“æŸç»‘å®šè¿‡ç¨‹ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Permit&lt;/code&gt; æ‰©å±•ç”¨äºé˜»æ­¢æˆ–è€…å»¶è¿Ÿ Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šã€‚Permit æ‰©å±•å¯ä»¥åšä¸‹é¢ä¸‰ä»¶äº‹ä¸­çš„ä¸€é¡¹ï¼š&lt;ul&gt;
&lt;li&gt;&lt;code&gt;approve&lt;/code&gt;ï¼ˆæ‰¹å‡†ï¼‰ï¼šå½“æ‰€æœ‰çš„ &lt;code&gt;permit&lt;/code&gt; æ‰©å±•éƒ½ &lt;code&gt;approve&lt;/code&gt; äº† Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šï¼Œè°ƒåº¦å™¨å°†ç»§ç»­æ‰§è¡Œç»‘å®šè¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;&lt;code&gt;deny&lt;/code&gt;ï¼ˆæ‹’ç»ï¼‰ï¼šå¦‚æœä»»ä½•ä¸€ä¸ª &lt;code&gt;permit&lt;/code&gt; æ‰©å±• &lt;code&gt;deny&lt;/code&gt; äº† Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šï¼ŒPod å°†è¢«æ”¾å›åˆ°å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œæ­¤æ—¶å°†è§¦å‘ &lt;code&gt;Unreserve&lt;/code&gt; æ‰©å±•&lt;/li&gt;
&lt;li&gt;&lt;code&gt;wait&lt;/code&gt;ï¼ˆç­‰å¾…ï¼‰ï¼šå¦‚æœä¸€ä¸ª &lt;code&gt;permit&lt;/code&gt; æ‰©å±•è¿”å›äº† &lt;code&gt;wait&lt;/code&gt;ï¼Œåˆ™ Pod å°†ä¿æŒåœ¨ &lt;code&gt;permit&lt;/code&gt; é˜¶æ®µï¼Œç›´åˆ°è¢«å…¶ä»–æ‰©å±• &lt;code&gt;approve&lt;/code&gt;ï¼Œå¦‚æœè¶…æ—¶äº‹ä»¶å‘ç”Ÿï¼Œ&lt;code&gt;wait&lt;/code&gt; çŠ¶æ€å˜æˆ &lt;code&gt;deny&lt;/code&gt;ï¼ŒPod å°†è¢«æ”¾å›åˆ°å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œæ­¤æ—¶å°†è§¦å‘ &lt;code&gt;Unreserve&lt;/code&gt; æ‰©å±•&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Pre-bind&lt;/code&gt; æ‰©å±•ç”¨äºåœ¨ Pod ç»‘å®šä¹‹å‰æ‰§è¡ŒæŸäº›é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œ&lt;code&gt;pre-bind&lt;/code&gt; æ‰©å±•å¯ä»¥å°†ä¸€ä¸ªåŸºäºç½‘ç»œçš„æ•°æ®å·æŒ‚è½½åˆ°èŠ‚ç‚¹ä¸Šï¼Œä»¥ä¾¿ Pod å¯ä»¥ä½¿ç”¨ã€‚å¦‚æœä»»ä½•ä¸€ä¸ª &lt;code&gt;pre-bind&lt;/code&gt; æ‰©å±•è¿”å›é”™è¯¯ï¼ŒPod å°†è¢«æ”¾å›åˆ°å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œæ­¤æ—¶å°†è§¦å‘ &lt;code&gt;Unreserve&lt;/code&gt; æ‰©å±•ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Bind&lt;/code&gt; æ‰©å±•ç”¨äºå°† Pod ç»‘å®šåˆ°èŠ‚ç‚¹ä¸Šï¼š&lt;ul&gt;
&lt;li&gt;åªæœ‰æ‰€æœ‰çš„ &lt;code&gt;pre-bind&lt;/code&gt; æ‰©å±•éƒ½æˆåŠŸæ‰§è¡Œäº†ï¼Œ&lt;code&gt;bind&lt;/code&gt; æ‰©å±•æ‰ä¼šæ‰§è¡Œ&lt;/li&gt;
&lt;li&gt;è°ƒåº¦æ¡†æ¶æŒ‰ç…§ &lt;code&gt;bind&lt;/code&gt; æ‰©å±•æ³¨å†Œçš„é¡ºåºé€ä¸ªè°ƒç”¨ &lt;code&gt;bind&lt;/code&gt; æ‰©å±•&lt;/li&gt;
&lt;li&gt;å…·ä½“æŸä¸ª &lt;code&gt;bind&lt;/code&gt; æ‰©å±•å¯ä»¥é€‰æ‹©å¤„ç†æˆ–è€…ä¸å¤„ç†è¯¥ Pod&lt;/li&gt;
&lt;li&gt;å¦‚æœæŸä¸ª &lt;code&gt;` æ‰©å±•å¤„ç†äº†è¯¥ Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šï¼Œä½™ä¸‹çš„&lt;/code&gt;bind` æ‰©å±•å°†è¢«å¿½ç•¥&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Post-bind&lt;/code&gt; æ˜¯ä¸€ä¸ªé€šçŸ¥æ€§è´¨çš„æ‰©å±•ï¼š&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Post-bind&lt;/code&gt; æ‰©å±•åœ¨ Pod æˆåŠŸç»‘å®šåˆ°èŠ‚ç‚¹ä¸Šä¹‹åè¢«åŠ¨è°ƒç”¨&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Post-bind&lt;/code&gt; æ‰©å±•æ˜¯ç»‘å®šè¿‡ç¨‹çš„æœ€åä¸€ä¸ªæ­¥éª¤ï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡Œèµ„æºæ¸…ç†çš„åŠ¨ä½œ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Unreserve&lt;/code&gt; æ˜¯ä¸€ä¸ªé€šçŸ¥æ€§è´¨çš„æ‰©å±•ï¼Œå¦‚æœä¸º Pod é¢„ç•™äº†èµ„æºï¼ŒPod åˆåœ¨è¢«ç»‘å®šè¿‡ç¨‹ä¸­è¢«æ‹’ç»ç»‘å®šï¼Œåˆ™ &lt;code&gt;unreserve&lt;/code&gt; æ‰©å±•å°†è¢«è°ƒç”¨ã€‚&lt;code&gt;Unreserve&lt;/code&gt; æ‰©å±•åº”è¯¥é‡Šæ”¾å·²ç»ä¸º Pod é¢„ç•™çš„èŠ‚ç‚¹ä¸Šçš„è®¡ç®—èµ„æºã€‚åœ¨ä¸€ä¸ªæ’ä»¶ä¸­ï¼Œ&lt;code&gt;reserve&lt;/code&gt; æ‰©å±•å’Œ &lt;code&gt;unreserve&lt;/code&gt; æ‰©å±•åº”è¯¥æˆå¯¹å‡ºç°ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¦‚æœæˆ‘ä»¬è¦å®ç°è‡ªå·±çš„æ’ä»¶ï¼Œå¿…é¡»å‘è°ƒåº¦æ¡†æ¶æ³¨å†Œæ’ä»¶å¹¶å®Œæˆé…ç½®ï¼Œå¦å¤–è¿˜å¿…é¡»å®ç°æ‰©å±•ç‚¹æ¥å£ï¼Œå¯¹åº”çš„æ‰©å±•ç‚¹æ¥å£æˆ‘ä»¬å¯ä»¥åœ¨æºç  &lt;code&gt;pkg/scheduler/framework/v1alpha1/interface.go&lt;/code&gt; æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Plugin is the parent type for all the scheduling framework plugins.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; Plugin &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Name() &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; QueueSortPlugin &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Plugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Less(*PodInfo, *PodInfo) &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// PreFilterPlugin is an interface that must be implemented by &quot;prefilter&quot; plugins.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// These plugins are called at the beginning of the scheduling cycle.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; PreFilterPlugin &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Plugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	PreFilter(pc *PluginContext, p *v1.Pod) *Status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// FilterPlugin is an interface for Filter plugins. These plugins are called at the&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// filter extension point for filtering out hosts that cannot run a pod.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// This concept used to be called &#39;predicate&#39; in the original scheduler.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// These plugins should return &quot;Success&quot;, &quot;Unschedulable&quot; or &quot;Error&quot; in Status.code.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// However, the scheduler accepts other valid codes as well.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Anything other than &quot;Success&quot; will lead to exclusion of the given host from&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// running the pod.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; FilterPlugin &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Plugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Filter(pc *PluginContext, pod *v1.Pod, nodeName &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;) *Status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// PostFilterPlugin is an interface for Post-filter plugin. Post-filter is an&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// informational extension point. Plugins will be called with a list of nodes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// that passed the filtering phase. A plugin may use this data to update internal&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// state or to generate logs/metrics.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; PostFilterPlugin &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Plugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	PostFilter(pc *PluginContext, pod *v1.Pod, nodes []*v1.Node, filteredNodesStatuses NodeToStatusMap) *Status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// ScorePlugin is an interface that must be implemented by &quot;score&quot; plugins to rank&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// nodes that passed the filtering phase.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; ScorePlugin &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Plugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Score(pc *PluginContext, p *v1.Pod, nodeName &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;) (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, *Status)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// ScoreWithNormalizePlugin is an interface that must be implemented by &quot;score&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// plugins that also need to normalize the node scoring results produced by the same&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// plugin&#39;s &quot;Score&quot; method.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; ScoreWithNormalizePlugin &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	ScorePlugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	NormalizeScore(pc *PluginContext, p *v1.Pod, scores NodeScoreList) *Status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// ReservePlugin is an interface for Reserve plugins. These plugins are called&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// at the reservation point. These are meant to update the state of the plugin.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// This concept used to be called &#39;assume&#39; in the original scheduler.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// These plugins should return only Success or Error in Status.code. However,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// the scheduler accepts other valid codes as well. Anything other than Success&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// will lead to rejection of the pod.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; ReservePlugin &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Plugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Reserve(pc *PluginContext, p *v1.Pod, nodeName &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;) *Status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// PreBindPlugin is an interface that must be implemented by &quot;prebind&quot; plugins.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// These plugins are called before a pod being scheduled.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; PreBindPlugin &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Plugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	PreBind(pc *PluginContext, p *v1.Pod, nodeName &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;) *Status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// PostBindPlugin is an interface that must be implemented by &quot;postbind&quot; plugins.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// These plugins are called after a pod is successfully bound to a node.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; PostBindPlugin &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Plugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	PostBind(pc *PluginContext, p *v1.Pod, nodeName &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// UnreservePlugin is an interface for Unreserve plugins. This is an informational&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// extension point. If a pod was reserved and then rejected in a later phase, then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// un-reserve plugins will be notified. Un-reserve plugins should clean up state&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// associated with the reserved Pod.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; UnreservePlugin &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Plugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Unreserve(pc *PluginContext, p *v1.Pod, nodeName &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// PermitPlugin is an interface that must be implemented by &quot;permit&quot; plugins.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// These plugins are called before a pod is bound to a node.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; PermitPlugin &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Plugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Permit(pc *PluginContext, p *v1.Pod, nodeName &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;) (*Status, time.Duration)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// BindPlugin is an interface that must be implemented by &quot;bind&quot; plugins. Bind&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// plugins are used to bind a pod to a Node.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; BindPlugin &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Plugin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Bind(pc *PluginContext, p *v1.Pod, nodeName &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;) *Status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯¹äºè°ƒåº¦æ¡†æ¶æ’ä»¶çš„å¯ç”¨æˆ–è€…ç¦ç”¨ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„ &lt;a href=&quot;https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#KubeSchedulerConfiguration&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;KubeSchedulerConfiguration&lt;/a&gt; èµ„æºå¯¹è±¡æ¥è¿›è¡Œé…ç½®ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­çš„é…ç½®å¯ç”¨äº†ä¸€ä¸ªå®ç°äº† &lt;code&gt;reserve&lt;/code&gt; å’Œ &lt;code&gt;preBind&lt;/code&gt; æ‰©å±•ç‚¹çš„æ’ä»¶ï¼Œå¹¶ä¸”ç¦ç”¨äº†å¦å¤–ä¸€ä¸ªæ’ä»¶ï¼ŒåŒæ—¶ä¸ºæ’ä»¶ foo æä¾›äº†ä¸€äº›é…ç½®ä¿¡æ¯ï¼š&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; kubescheduler.config.k8s.io/v1alpha1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; KubeSchedulerConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;plugins:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  reserve:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    enabled:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; foo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; bar&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    disabled:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; baz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  preBind:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    enabled:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; foo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    disabled:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; baz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;pluginConfig:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- name:&lt;/span&gt; foo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  args:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fooæ’ä»¶å¯ä»¥è§£æçš„ä»»æ„å†…å®¹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ‰©å±•çš„è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœæŸä¸ªæ‰©å±•ç‚¹æ²¡æœ‰é…ç½®å¯¹åº”çš„æ‰©å±•ï¼Œè°ƒåº¦æ¡†æ¶å°†ä½¿ç”¨é»˜è®¤æ’ä»¶ä¸­çš„æ‰©å±•&lt;/li&gt;
&lt;li&gt;å¦‚æœä¸ºæŸä¸ªæ‰©å±•ç‚¹é…ç½®ä¸”æ¿€æ´»äº†æ‰©å±•ï¼Œåˆ™è°ƒåº¦æ¡†æ¶å°†å…ˆè°ƒç”¨é»˜è®¤æ’ä»¶çš„æ‰©å±•ï¼Œå†è°ƒç”¨é…ç½®ä¸­çš„æ‰©å±•&lt;/li&gt;
&lt;li&gt;é»˜è®¤æ’ä»¶çš„æ‰©å±•å§‹ç»ˆè¢«æœ€å…ˆè°ƒç”¨ï¼Œç„¶åæŒ‰ç…§ &lt;code&gt;KubeSchedulerConfiguration&lt;/code&gt; ä¸­æ‰©å±•çš„æ¿€æ´» &lt;code&gt;enabled&lt;/code&gt; é¡ºåºé€ä¸ªè°ƒç”¨æ‰©å±•ç‚¹çš„æ‰©å±•&lt;/li&gt;
&lt;li&gt;å¯ä»¥å…ˆç¦ç”¨é»˜è®¤æ’ä»¶çš„æ‰©å±•ï¼Œç„¶ååœ¨ &lt;code&gt;enabled&lt;/code&gt; åˆ—è¡¨ä¸­çš„æŸä¸ªä½ç½®æ¿€æ´»é»˜è®¤æ’ä»¶çš„æ‰©å±•ï¼Œè¿™ç§åšæ³•å¯ä»¥æ”¹å˜é»˜è®¤æ’ä»¶çš„æ‰©å±•è¢«è°ƒç”¨æ—¶çš„é¡ºåº&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å‡è®¾é»˜è®¤æ’ä»¶ foo å®ç°äº† &lt;code&gt;reserve&lt;/code&gt; æ‰©å±•ç‚¹ï¼Œæ­¤æ—¶æˆ‘ä»¬è¦æ·»åŠ ä¸€ä¸ªæ’ä»¶ barï¼Œæƒ³è¦åœ¨ foo ä¹‹å‰è¢«è°ƒç”¨ï¼Œåˆ™åº”è¯¥å…ˆç¦ç”¨ foo å†æŒ‰ç…§ bar foo çš„é¡ºåºæ¿€æ´»ã€‚ç¤ºä¾‹é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; kubescheduler.config.k8s.io/v1alpha1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; KubeSchedulerConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;plugins:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  reserve:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    enabled:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; bar&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; foo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    disabled:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; foo&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åœ¨æºç ç›®å½• &lt;code&gt;pkg/scheduler/framework/plugins/examples&lt;/code&gt; ä¸­æœ‰å‡ ä¸ªç¤ºèŒƒæ’ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å‚ç…§å…¶å®ç°æ–¹å¼ã€‚&lt;/p&gt;
&lt;h3 id=&quot;ç¤ºä¾‹-1&quot;&gt;&lt;a href=&quot;#ç¤ºä¾‹-1&quot; class=&quot;headerlink&quot; title=&quot;ç¤ºä¾‹&quot;&gt;&lt;/a&gt;ç¤ºä¾‹&lt;/h3&gt;&lt;p&gt;å…¶å®è¦å®ç°ä¸€ä¸ªè°ƒåº¦æ¡†æ¶çš„æ’ä»¶ï¼Œå¹¶ä¸éš¾ï¼Œæˆ‘ä»¬åªè¦å®ç°å¯¹åº”çš„æ‰©å±•ç‚¹ï¼Œç„¶åå°†æ’ä»¶æ³¨å†Œåˆ°è°ƒåº¦å™¨ä¸­å³å¯ï¼Œä¸‹é¢æ˜¯é»˜è®¤è°ƒåº¦å™¨åœ¨åˆå§‹åŒ–çš„æ—¶å€™æ³¨å†Œçš„æ’ä»¶ï¼š&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;NewRegistry&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Registry&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; Registry&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;// FactoryMap:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;// New plugins are registered here.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;// example:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;// &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;//  stateful_plugin.Name: stateful.NewStatefulMultipointExample,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;//  fooplugin.Name: fooplugin.New,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;// &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯å¯ä»¥çœ‹åˆ°é»˜è®¤å¹¶æ²¡æœ‰æ³¨å†Œä¸€äº›æ’ä»¶ï¼Œæ‰€ä»¥è¦æƒ³è®©è°ƒåº¦å™¨èƒ½å¤Ÿè¯†åˆ«æˆ‘ä»¬çš„æ’ä»¶ä»£ç ï¼Œå°±éœ€è¦è‡ªå·±æ¥å®ç°ä¸€ä¸ªè°ƒåº¦å™¨äº†ï¼Œå½“ç„¶è¿™ä¸ªè°ƒåº¦å™¨æˆ‘ä»¬å®Œå…¨æ²¡å¿…è¦å®Œå…¨è‡ªå·±å®ç°ï¼Œç›´æ¥è°ƒç”¨é»˜è®¤çš„è°ƒåº¦å™¨ï¼Œç„¶ååœ¨ä¸Šé¢çš„ &lt;code&gt;NewRegistry()&lt;/code&gt; å‡½æ•°ä¸­å°†æˆ‘ä»¬çš„æ’ä»¶æ³¨å†Œè¿›å»å³å¯ã€‚åœ¨ &lt;code&gt;kube-scheduler&lt;/code&gt; çš„æºç æ–‡ä»¶ &lt;code&gt;kubernetes/cmd/kube-scheduler/app/server.go&lt;/code&gt; ä¸­æœ‰ä¸€ä¸ª &lt;code&gt;NewSchedulerCommand&lt;/code&gt; å…¥å£å‡½æ•°ï¼Œå…¶ä¸­çš„å‚æ•°æ˜¯ä¸€ä¸ªç±»å‹ä¸º &lt;code&gt;Option&lt;/code&gt; çš„åˆ—è¡¨ï¼Œè€Œè¿™ä¸ª &lt;code&gt;Option&lt;/code&gt; æ°å¥½å°±æ˜¯ä¸€ä¸ªæ’ä»¶é…ç½®çš„å®šä¹‰ï¼š&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Option configures a framework.Registry.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; Option &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(framework.Registry)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// &lt;span class=&quot;title&quot;&gt;NewSchedulerCommand&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;creates&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;a&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;cobra&lt;/span&gt;.&lt;span class=&quot;title&quot;&gt;Command&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;object&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;parameters&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;registryOptions&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;NewSchedulerCommand&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(registryOptions ...Option)&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;cobra&lt;/span&gt;.&lt;span class=&quot;title&quot;&gt;Command&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ......&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥æˆ‘ä»¬å®Œå…¨å°±å¯ä»¥ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥ä½œä¸ºæˆ‘ä»¬çš„å‡½æ•°å…¥å£ï¼Œå¹¶ä¸”ä¼ å…¥æˆ‘ä»¬è‡ªå·±å®ç°çš„æ’ä»¶ä½œä¸ºå‚æ•°å³å¯ï¼Œè€Œä¸”è¯¥æ–‡ä»¶ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªåä¸º &lt;code&gt;WithPlugin&lt;/code&gt; çš„å‡½æ•°å¯ä»¥æ¥åˆ›å»ºä¸€ä¸ª &lt;code&gt;Option&lt;/code&gt; å®ä¾‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// WithPlugin creates an Option based on plugin name and factory.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;WithPlugin&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(name &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;, factory framework.PluginFactory)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Option&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(registry framework.Registry)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; registry.Register(name, factory)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬çš„å…¥å£å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	rand.Seed(time.Now().UTC().UnixNano())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	command := app.NewSchedulerCommand(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		app.WithPlugin(sample.Name, sample.New), &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	logs.InitLogs()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; logs.FlushLogs()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := command.Execute(); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		_, _ = fmt.Fprintf(os.Stderr, &lt;span class=&quot;string&quot;&gt;&quot;%v\n&quot;&lt;/span&gt;, err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		os.Exit(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å…¶ä¸­ &lt;code&gt;app.WithPlugin(sample.Name, sample.New)&lt;/code&gt; å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦å®ç°çš„æ’ä»¶ï¼Œä» &lt;code&gt;WithPlugin&lt;/code&gt; å‡½æ•°çš„å‚æ•°ä¹Ÿå¯ä»¥çœ‹å‡ºæˆ‘ä»¬è¿™é‡Œçš„ &lt;code&gt;sample.New&lt;/code&gt; å¿…é¡»æ˜¯ä¸€ä¸ª &lt;code&gt;framework.PluginFactory&lt;/code&gt; ç±»å‹çš„å€¼ï¼Œè€Œ &lt;code&gt;PluginFactory&lt;/code&gt; çš„å®šä¹‰å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼š&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; PluginFactory = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(configuration *runtime.Unknown, f FrameworkHandle)&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(Plugin, error)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ &lt;code&gt;sample.New&lt;/code&gt; å®é™…ä¸Šå°±æ˜¯ä¸Šé¢çš„è¿™ä¸ªå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥è·å–åˆ°æ’ä»¶ä¸­çš„ä¸€äº›æ•°æ®ç„¶åè¿›è¡Œé€»è¾‘å¤„ç†å³å¯ï¼Œæ’ä»¶å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯ç®€å•è·å–ä¸‹æ•°æ®æ‰“å°æ—¥å¿—ï¼Œå¦‚æœä½ æœ‰å®é™…éœ€æ±‚çš„å¯ä»¥æ ¹æ®è·å–çš„æ•°æ®å°±è¡Œå¤„ç†å³å¯ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯å®ç°äº† &lt;code&gt;PreFilter&lt;/code&gt;ã€&lt;code&gt;Filter&lt;/code&gt;ã€&lt;code&gt;PreBind&lt;/code&gt; ä¸‰ä¸ªæ‰©å±•ç‚¹ï¼Œå…¶ä»–çš„å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼æ¥æ‰©å±•å³å¯ï¼š&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// æ’ä»¶åç§°&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; Name = &lt;span class=&quot;string&quot;&gt;&quot;sample-plugin&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; Args &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	FavoriteColor  &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;`json:&quot;favorite_color,omitempty&quot;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	FavoriteNumber &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;    &lt;span class=&quot;string&quot;&gt;`json:&quot;favorite_number,omitempty&quot;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	ThanksTo       &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;`json:&quot;thanks_to,omitempty&quot;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; Sample &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	args   *Args&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	handle framework.FrameworkHandle&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(s *Sample)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;string&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; Name&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(s *Sample)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;PreFilter&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(pc *framework.PluginContext, pod *v1.Pod)&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;framework&lt;/span&gt;.&lt;span class=&quot;title&quot;&gt;Status&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	klog.V(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;).Infof(&lt;span class=&quot;string&quot;&gt;&quot;prefilter pod: %v&quot;&lt;/span&gt;, pod.Name)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; framework.NewStatus(framework.Success, &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(s *Sample)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Filter&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(pc *framework.PluginContext, pod *v1.Pod, nodeName &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;framework&lt;/span&gt;.&lt;span class=&quot;title&quot;&gt;Status&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	klog.V(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;).Infof(&lt;span class=&quot;string&quot;&gt;&quot;filter pod: %v, node: %v&quot;&lt;/span&gt;, pod.Name, nodeName)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; framework.NewStatus(framework.Success, &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(s *Sample)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;PreBind&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(pc *framework.PluginContext, pod *v1.Pod, nodeName &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;framework&lt;/span&gt;.&lt;span class=&quot;title&quot;&gt;Status&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; nodeInfo, ok := s.handle.NodeInfoSnapshot().NodeInfoMap[nodeName]; !ok &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; framework.NewStatus(framework.Error, fmt.Sprintf(&lt;span class=&quot;string&quot;&gt;&quot;prebind get node info error: %+v&quot;&lt;/span&gt;, nodeName))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		klog.V(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;).Infof(&lt;span class=&quot;string&quot;&gt;&quot;prebind node info: %+v&quot;&lt;/span&gt;, nodeInfo.Node())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; framework.NewStatus(framework.Success, &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//type PluginFactory = func(configuration *runtime.Unknown, f FrameworkHandle) (Plugin, error)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;New&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(configuration *runtime.Unknown, f framework.FrameworkHandle)&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(framework.Plugin, error)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	args := &amp;amp;Args&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := framework.DecodeInto(configuration, args); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;, err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	klog.V(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;).Infof(&lt;span class=&quot;string&quot;&gt;&quot;get plugin config args: %+v&quot;&lt;/span&gt;, args)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &amp;amp;Sample&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		args: args,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		handle: f,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å®Œæ•´ä»£ç å¯ä»¥å‰å¾€ä»“åº“ &lt;a href=&quot;https://github.com/icyxp/sample-scheduler-framework&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/icyxp/sample-scheduler-framework&lt;/a&gt; è·å–ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å®ç°å®Œæˆåï¼Œç¼–è¯‘æ‰“åŒ…æˆé•œåƒå³å¯ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥å½“æˆæ™®é€šçš„åº”ç”¨ç”¨ä¸€ä¸ª &lt;code&gt;Deployment&lt;/code&gt; æ§åˆ¶å™¨æ¥éƒ¨ç½²å³å¯ï¼Œç”±äºæˆ‘ä»¬éœ€è¦å»è·å–é›†ç¾¤ä¸­çš„ä¸€äº›èµ„æºå¯¹è±¡ï¼Œæ‰€ä»¥å½“ç„¶éœ€è¦ç”³è¯· RBAC æƒé™ï¼Œç„¶ååŒæ ·é€šè¿‡ &lt;code&gt;--config&lt;/code&gt; å‚æ•°æ¥é…ç½®æˆ‘ä»¬çš„è°ƒåº¦å™¨ï¼ŒåŒæ ·è¿˜æ˜¯ä½¿ç”¨ä¸€ä¸ª &lt;code&gt;KubeSchedulerConfiguration&lt;/code&gt; èµ„æºå¯¹è±¡é…ç½®ï¼Œå¯ä»¥é€šè¿‡ &lt;code&gt;plugins&lt;/code&gt; æ¥å¯ç”¨æˆ–è€…ç¦ç”¨æˆ‘ä»¬å®ç°çš„æ’ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ &lt;code&gt;pluginConfig&lt;/code&gt; æ¥ä¼ é€’ä¸€äº›å‚æ•°å€¼ç»™æ’ä»¶ï¼š&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;133&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;134&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;135&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;136&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;137&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;138&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;139&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;140&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;142&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;143&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;144&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;145&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;146&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;147&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;148&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;149&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;150&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;151&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;152&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;153&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;154&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;155&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;156&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;157&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;158&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;159&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;160&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;161&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;162&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;163&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;164&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;165&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;166&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;167&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;168&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;169&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;170&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;171&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;173&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;174&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;175&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;176&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;177&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;178&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;179&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;180&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;181&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;182&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;186&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;187&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;188&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;189&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;190&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;191&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;192&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;193&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;194&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;195&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;196&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;197&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;198&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;199&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;200&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;201&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;202&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;203&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;204&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;205&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;206&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;207&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;208&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;209&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;210&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;211&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;212&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ClusterRole&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; rbac.authorization.k8s.io/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; sample-scheduler-clusterrole&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;rules:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; endpoints&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; events&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; create&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; nodes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; watch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; pods&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; delete&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; watch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; bindings&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; pods/binding&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; create&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; pods/status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; patch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; replicationcontrollers&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; services&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; watch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; apps&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; extensions&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; replicasets&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; watch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; apps&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; statefulsets&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; watch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; policy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; poddisruptionbudgets&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; watch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; persistentvolumeclaims&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; persistentvolumes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; watch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; configmaps&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; watch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;storage.k8s.io&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; storageclasses&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; csinodes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; watch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;coordination.k8s.io&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; leases&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; create&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - apiGroups:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;events.k8s.io&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; events&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    verbs:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; create&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; patch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;      -&lt;/span&gt; update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ServiceAccount&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; sample-scheduler-sa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ClusterRoleBinding&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; rbac.authorization.k8s.io/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; sample-scheduler-clusterrolebinding&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;roleRef:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  apiGroup:&lt;/span&gt; rbac.authorization.k8s.io&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  kind:&lt;/span&gt; ClusterRole&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; sample-scheduler-clusterrole&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;subjects:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;- kind:&lt;/span&gt; ServiceAccount&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; sample-scheduler-sa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; ConfigMap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; scheduler-config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;data:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  scheduler-config.yaml: &lt;span class=&quot;string&quot;&gt;|&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;span class=&quot;attr&quot;&gt;    apiVersion:&lt;/span&gt; kubescheduler.config.k8s.io/v1alpha1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    kind:&lt;/span&gt; KubeSchedulerConfiguration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    schedulerName:&lt;/span&gt; sample-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    leaderElection:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      leaderElect:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      lockObjectName:&lt;/span&gt; sample-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      lockObjectNamespace:&lt;/span&gt; kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    plugins:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      preFilter:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        enabled:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;sample-plugin&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      filter:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        enabled:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;sample-plugin&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      preBind:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        enabled:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;sample-plugin&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    pluginConfig:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    - name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;sample-plugin&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      args:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        favorite_color:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;#326CE5&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        favorite_number:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;7&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        thanks_to:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;thockin&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; apps/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; sample-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  namespace:&lt;/span&gt; kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    component:&lt;/span&gt; sample-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  replicas:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  selector:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    matchLabels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      component:&lt;/span&gt; sample-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  template:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        component:&lt;/span&gt; sample-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      serviceAccount:&lt;/span&gt; sample-scheduler-sa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      priorityClassName:&lt;/span&gt; system-cluster-critical&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      volumes:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - name:&lt;/span&gt; scheduler-config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          configMap:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            name:&lt;/span&gt; scheduler-config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - name:&lt;/span&gt; scheduler-ctrl&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          image:&lt;/span&gt; cnych/sample-scheduler:v0&lt;span class=&quot;number&quot;&gt;.1&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          imagePullPolicy:&lt;/span&gt; IfNotPresent&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          args:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;            -&lt;/span&gt; sample-scheduler-framework&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;            -&lt;/span&gt; --config=/etc/kubernetes/scheduler-config.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;            -&lt;/span&gt; --v=&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          resources:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            requests:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;              cpu:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;50m&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;          volumeMounts:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;            - name:&lt;/span&gt; scheduler-config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;              mountPath:&lt;/span&gt; /etc/kubernetes&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç›´æ¥éƒ¨ç½²ä¸Šé¢çš„èµ„æºå¯¹è±¡å³å¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±éƒ¨ç½²äº†ä¸€ä¸ªåä¸º &lt;code&gt;sample-scheduler&lt;/code&gt; çš„è°ƒåº¦å™¨äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥éƒ¨ç½²ä¸€ä¸ªåº”ç”¨æ¥ä½¿ç”¨è¿™ä¸ªè°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦ï¼š&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; apps/v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Deployment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; test-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  replicas:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  selector:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    matchLabels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      app:&lt;/span&gt; test-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  template:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      labels:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        app:&lt;/span&gt; test-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      schedulerName:&lt;/span&gt; sample-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;      - image:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        imagePullPolicy:&lt;/span&gt; IfNotPresent&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        name:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;        - containerPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬ç°åœ¨æ‰‹åŠ¨æŒ‡å®šäº†ä¸€ä¸ª &lt;code&gt;schedulerName&lt;/code&gt; çš„å­—æ®µï¼Œå°†å…¶è®¾ç½®æˆä¸Šé¢æˆ‘ä»¬è‡ªå®šä¹‰çš„è°ƒåº¦å™¨åç§° &lt;code&gt;sample-scheduler&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬ç›´æ¥åˆ›å»ºè¿™ä¸ªèµ„æºå¯¹è±¡ï¼Œåˆ›å»ºå®ŒæˆåæŸ¥çœ‹æˆ‘ä»¬è‡ªå®šä¹‰è°ƒåº¦å™¨çš„æ—¥å¿—ä¿¡æ¯ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods -n kube-system &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt; component=sample-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                               READY   STATUS    RESTARTS   AGE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sample-scheduler-7c469787f-rwhhd   1/1     Running   0          13m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl logs &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; sample-scheduler-7c469787f-rwhhd -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0104 08:24:22.087881       1 scheduler.go:530] Attempting to schedule pod: default/&lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-scheduler-6d779d9465-rq2bb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0104 08:24:22.087992       1 plugins.go:23] prefilter pod: &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-scheduler-6d779d9465-rq2bb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0104 08:24:22.088657       1 plugins.go:28] filter pod: &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-scheduler-6d779d9465-rq2bb, node: ydzs-node1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0104 08:24:22.088797       1 plugins.go:28] filter pod: &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-scheduler-6d779d9465-rq2bb, node: ydzs-node2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0104 08:24:22.088871       1 plugins.go:28] filter pod: &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-scheduler-6d779d9465-rq2bb, node: ydzs-node3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0104 08:24:22.088946       1 plugins.go:28] filter pod: &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-scheduler-6d779d9465-rq2bb, node: ydzs-node4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0104 08:24:22.088992       1 plugins.go:28] filter pod: &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-scheduler-6d779d9465-rq2bb, node: ydzs-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0104 08:24:22.090653       1 plugins.go:36] prebind node info: &amp;amp;Node&amp;#123;ObjectMeta:&amp;#123;ydzs-node3   /api/v1/nodes/ydzs-node3 1ff6e228-4d98-4737-b6d3-30a5d55ccdc2 15466372 0 2019-11-10 09:05:09 +0000 UTC &amp;lt;nil&amp;gt; &amp;lt;nil&amp;gt; ......&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0104 08:24:22.091761       1 factory.go:610] Attempting to &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-scheduler-6d779d9465-rq2bb to ydzs-node3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I0104 08:24:22.104994       1 scheduler.go:667] pod default/&lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-scheduler-6d779d9465-rq2bb is bound successfully on node &lt;span class=&quot;string&quot;&gt;&quot;ydzs-node3&quot;&lt;/span&gt;, 5 nodes evaluated, 4 nodes were found feasible. Bound node resource: &lt;span class=&quot;string&quot;&gt;&quot;Capacity: CPU&amp;lt;4&amp;gt;|Memory&amp;lt;8008820Ki&amp;gt;|Pods&amp;lt;110&amp;gt;|StorageEphemeral&amp;lt;17921Mi&amp;gt;; Allocatable: CPU&amp;lt;4&amp;gt;|Memory&amp;lt;7906420Ki&amp;gt;|Pods&amp;lt;110&amp;gt;|StorageEphemeral&amp;lt;16912377419&amp;gt;.&quot;&lt;/span&gt;.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°å½“æˆ‘ä»¬åˆ›å»ºå®Œ Pod åï¼Œåœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„è°ƒåº¦å™¨ä¸­å°±å‡ºç°äº†å¯¹åº”çš„æ—¥å¿—ï¼Œå¹¶ä¸”åœ¨æˆ‘ä»¬å®šä¹‰çš„æ‰©å±•ç‚¹ä¸Šé¢éƒ½å‡ºç°äº†å¯¹åº”çš„æ—¥å¿—ï¼Œè¯æ˜æˆ‘ä»¬çš„ç¤ºä¾‹æˆåŠŸäº†ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŸ¥çœ‹ Pod çš„ &lt;code&gt;schedulerName&lt;/code&gt; æ¥éªŒè¯ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                                      READY   STATUS    RESTARTS   AGE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-scheduler-6d779d9465-rq2bb           1/1     Running   0          22m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pod &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-scheduler-6d779d9465-rq2bb -o yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;......&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;restartPolicy: Always&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;schedulerName: sample-scheduler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;securityContext: &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;serviceAccount: default&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;......&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åœ¨æœ€æ–°çš„ Kubernetes v1.17 ç‰ˆæœ¬ä¸­ï¼Œ&lt;code&gt;Scheduler Framework&lt;/code&gt; å†…ç½®çš„é¢„é€‰å’Œä¼˜é€‰å‡½æ•°å·²ç»å…¨éƒ¨æ’ä»¶åŒ–ï¼Œæ‰€ä»¥è¦æ‰©å±•è°ƒåº¦å™¨æˆ‘ä»¬åº”è¯¥æŒæ¡å¹¶ç†è§£è°ƒåº¦æ¡†æ¶è¿™ç§æ–¹å¼ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼šæ˜é˜³çš„åšå®¢&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;&lt;code&gt;kube-scheduler&lt;/code&gt; æ˜¯ kubernetes çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œä¸»è¦è´Ÿè´£æ•´ä¸ªé›†ç¾¤èµ„æºçš„è°ƒåº¦åŠŸèƒ½ï¼Œæ ¹æ®ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œç­–ç•¥ï¼Œå°† Pod è°ƒåº¦åˆ°æœ€ä¼˜çš„å·¥ä½œèŠ‚ç‚¹ä¸Šé¢å»ï¼Œä»è€Œæ›´åŠ åˆç†ã€æ›´åŠ å……åˆ†çš„åˆ©ç”¨é›†ç¾¤çš„èµ„æºï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ kubernetes ä¸€ä¸ªéå¸¸é‡è¦çš„ç†ç”±ã€‚å¦‚æœä¸€é—¨æ–°çš„æŠ€æœ¯ä¸èƒ½å¸®åŠ©ä¼ä¸šèŠ‚çº¦æˆæœ¬ã€æä¾›æ•ˆç‡ï¼Œæˆ‘ç›¸ä¿¡æ˜¯å¾ˆéš¾æ¨è¿›çš„ã€‚&lt;/p&gt;
&lt;h2 id=&quot;è°ƒåº¦æµç¨‹&quot;&gt;&lt;a href=&quot;#è°ƒåº¦æµç¨‹&quot; class=&quot;headerlink&quot; title=&quot;è°ƒåº¦æµç¨‹&quot;&gt;&lt;/a&gt;è°ƒåº¦æµç¨‹&lt;/h2&gt;&lt;p&gt;é»˜è®¤æƒ…å†µä¸‹ï¼Œ&lt;code&gt;kube-scheduler&lt;/code&gt; æä¾›çš„é»˜è®¤è°ƒåº¦å™¨èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬ç»å¤§å¤šæ•°çš„è¦æ±‚ï¼Œæˆ‘ä»¬å‰é¢å’Œå¤§å®¶æ¥è§¦çš„ç¤ºä¾‹ä¹ŸåŸºæœ¬ä¸Šç”¨çš„é»˜è®¤çš„ç­–ç•¥ï¼Œéƒ½å¯ä»¥ä¿è¯æˆ‘ä»¬çš„ Pod å¯ä»¥è¢«åˆ†é…åˆ°èµ„æºå……è¶³çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ä½†æ˜¯åœ¨å®é™…çš„çº¿ä¸Šé¡¹ç›®ä¸­ï¼Œå¯èƒ½æˆ‘ä»¬è‡ªå·±ä¼šæ¯” kubernetes æ›´åŠ äº†è§£æˆ‘ä»¬è‡ªå·±çš„åº”ç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸Œæœ›ä¸€ä¸ª Pod åªèƒ½è¿è¡Œåœ¨ç‰¹å®šçš„å‡ ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…è¿™å‡ ä¸ªèŠ‚ç‚¹åªèƒ½ç”¨æ¥è¿è¡Œç‰¹å®šç±»å‹çš„åº”ç”¨ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬çš„è°ƒåº¦å™¨èƒ½å¤Ÿå¯æ§ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;kube-scheduler&lt;/code&gt; çš„ä¸»è¦ä½œç”¨å°±æ˜¯æ ¹æ®ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œè°ƒåº¦ç­–ç•¥å°† Pod è°ƒåº¦åˆ°åˆé€‚çš„ Node èŠ‚ç‚¹ä¸Šå»ï¼Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äºŒè¿›åˆ¶ç¨‹åºï¼Œå¯åŠ¨ä¹‹åä¼šä¸€ç›´ç›‘å¬ API Serverï¼Œè·å–åˆ° &lt;code&gt;PodSpec.NodeName&lt;/code&gt; ä¸ºç©ºçš„ Podï¼Œå¯¹æ¯ä¸ª Pod éƒ½ä¼šåˆ›å»ºä¸€ä¸ª bindingã€‚&lt;br&gt;&lt;img src=&quot;/images/k8s/kube-scheduler-overview.png&quot; alt=&quot;kube-scheduler-overview&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="kubrenetes" scheme="http://team.jiunile.com/categories/kubrenetes/"/>
    
      <category term="è°ƒåº¦å™¨" scheme="http://team.jiunile.com/categories/kubrenetes/%E8%B0%83%E5%BA%A6%E5%99%A8/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/tags/kubernetes/"/>
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="scheduler" scheme="http://team.jiunile.com/tags/scheduler/"/>
    
  </entry>
  
  <entry>
    <title>k8s v1.17 æ–°å¢æ‹“æ‰‘æ„ŸçŸ¥æœåŠ¡è·¯ç”±</title>
    <link href="http://team.jiunile.com//blog/2020/05/k8s-service-topology.html"/>
    <id>http://team.jiunile.com//blog/2020/05/k8s-service-topology.html</id>
    <published>2020-05-22T11:00:00.000Z</published>
    <updated>2020-05-22T07:47:44.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;åè¯è§£é‡Š&quot;&gt;&lt;a href=&quot;#åè¯è§£é‡Š&quot; class=&quot;headerlink&quot; title=&quot;åè¯è§£é‡Š&quot;&gt;&lt;/a&gt;åè¯è§£é‡Š&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;æ‹“æ‰‘åŸŸ&lt;/code&gt;: è¡¨ç¤ºåœ¨é›†ç¾¤ä¸­çš„æŸä¸€ç±» â€œåœ°æ–¹â€ï¼Œæ¯”å¦‚æŸèŠ‚ç‚¹ã€æŸæœºæ¶ã€æŸå¯ç”¨åŒºæˆ–æŸåœ°åŸŸç­‰ï¼Œè¿™äº›éƒ½å¯ä»¥ä½œä¸ºæŸç§æ‹“æ‰‘åŸŸã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;endpoint&lt;/code&gt;: k8s æŸä¸ªæœåŠ¡çš„æŸä¸ª ip+portï¼Œé€šå¸¸æ˜¯ pod çš„ ip+portã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;service&lt;/code&gt;: k8s çš„ service èµ„æº(æœåŠ¡)ï¼Œå…³è”ä¸€ç»„ endpoint ï¼Œè®¿é—® service ä¼šè¢«è½¬å‘åˆ°å…³è”çš„æŸä¸ª endpoint ä¸Šã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;æ‹“æ‰‘æ„ŸçŸ¥æœåŠ¡è·¯ç”±ï¼Œæ­¤ç‰¹æ€§æœ€åˆç”±æœå†›å¤§ä½¬æå‡ºå¹¶è®¾è®¡ã€‚ä¸ºä»€ä¹ˆè¦è®¾è®¡æ­¤ç‰¹æ€§å‘¢ï¼Ÿæƒ³è±¡ä¸€ä¸‹ï¼Œk8s é›†ç¾¤èŠ‚ç‚¹åˆ†å¸ƒåœ¨ä¸åŒçš„åœ°æ–¹ï¼Œservice å¯¹åº”çš„ endpoints åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ï¼Œä¼ ç»Ÿè½¬å‘ç­–ç•¥ä¼šå¯¹æ‰€æœ‰ endpoint åšè´Ÿè½½å‡è¡¡ï¼Œé€šå¸¸ä¼šç­‰æ¦‚ç‡è½¬å‘ï¼Œå½“è®¿é—® service æ—¶ï¼Œæµé‡å°±å¯èƒ½è¢«åˆ†æ•£æ‰“åˆ°è¿™äº›ä¸åŒçš„åœ°æ–¹ã€‚è™½ç„¶ service è½¬å‘åšäº†è´Ÿè½½å‡è¡¡ï¼Œä½†å¦‚æœ endpoint è·ç¦»æ¯”è¾ƒè¿œï¼Œæµé‡è½¬å‘è¿‡å»ç½‘ç»œæ—¶å»¶å°±ç›¸å¯¹æ¯”è¾ƒé«˜ï¼Œä¼šå½±å“ç½‘ç»œæ€§èƒ½ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ç”šè‡³è¿˜å¯èƒ½ä¼šä»˜å‡ºé¢å¤–çš„æµé‡è´¹ç”¨ã€‚è¦æ˜¯å¦‚èƒ½å®ç° service å°±è¿‘è½¬å‘ endpointï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥å®ç°é™ä½ç½‘ç»œæ—¶å»¶ï¼Œæå‡ç½‘ç»œæ€§èƒ½äº†å‘¢ï¼Ÿæ˜¯çš„ï¼è¿™ä¹Ÿæ­£æ˜¯è¯¥ç‰¹æ€§æ‰€æå‡ºçš„ç›®çš„å’Œæ„ä¹‰ã€‚&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;k8s-äº²å’Œæ€§&quot;&gt;&lt;a href=&quot;#k8s-äº²å’Œæ€§&quot; class=&quot;headerlink&quot; title=&quot;k8s äº²å’Œæ€§&quot;&gt;&lt;/a&gt;k8s äº²å’Œæ€§&lt;/h2&gt;&lt;p&gt;service çš„å°±è¿‘è½¬å‘å®é™…å°±æ˜¯ä¸€ç§ç½‘ç»œçš„äº²å’Œæ€§ï¼Œå€¾å‘äºè½¬å‘åˆ°ç¦»è‡ªå·±æ¯”è¾ƒè¿‘çš„ endpointã€‚åœ¨æ­¤ç‰¹æ€§ä¹‹å‰ï¼Œå·²ç»åœ¨è°ƒåº¦å’Œå­˜å‚¨æ–¹é¢æœ‰ä¸€äº›äº²å’Œæ€§çš„è®¾è®¡ä¸å®ç°:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;èŠ‚ç‚¹äº²å’Œæ€§ (Node Affinity)&lt;/code&gt;: è®© Pod è¢«è°ƒåº¦åˆ°ç¬¦åˆä¸€äº›æœŸæœ›æ¡ä»¶çš„ Node ä¸Šï¼Œæ¯”å¦‚é™åˆ¶è°ƒåº¦åˆ°æŸä¸€å¯ç”¨åŒºï¼Œæˆ–è€…è¦æ±‚èŠ‚ç‚¹æ”¯æŒ GPUï¼Œè¿™ç®—æ˜¯è°ƒåº¦äº²å’Œï¼Œè°ƒåº¦ç»“æœå–å†³äºèŠ‚ç‚¹å±æ€§ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Pod äº²å’Œæ€§ä¸åäº²å’Œæ€§ (Pod Affinity/AntiAffinity)&lt;/code&gt;: è®©ä¸€ç»„ Pod è°ƒåº¦åˆ°åŒä¸€æ‹“æ‰‘åŸŸçš„èŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…æ‰“æ•£åˆ°ä¸åŒæ‹“æ‰‘åŸŸçš„èŠ‚ç‚¹ï¼Œ è¿™ä¹Ÿç®—æ˜¯è°ƒåº¦äº²å’Œï¼Œè°ƒåº¦ç»“æœå–å†³äºå…¶å®ƒ Podã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;æ•°æ®å·æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦ (Volume Topology-aware Scheduling)&lt;/code&gt;: è®© Pod åªè¢«è°ƒåº¦åˆ°ç¬¦åˆå…¶ç»‘å®šçš„å­˜å‚¨æ‰€åœ¨æ‹“æ‰‘åŸŸçš„èŠ‚ç‚¹ä¸Šï¼Œè¿™ç®—æ˜¯è°ƒåº¦ä¸å­˜å‚¨çš„äº²å’Œï¼Œè°ƒåº¦ç»“æœå–å†³äºå­˜å‚¨çš„æ‹“æ‰‘åŸŸã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;æœ¬åœ°æ•°æ®å· (Local Persistent Volume)&lt;/code&gt;: è®© Pod ä½¿ç”¨æœ¬åœ°æ•°æ®å·ï¼Œæ¯”å¦‚é«˜æ€§èƒ½ SSDï¼Œåœ¨æŸäº›éœ€è¦é«˜ IOPS ä½æ—¶å»¶çš„åœºæ™¯å¾ˆæœ‰ç”¨ï¼Œå®ƒè¿˜ä¼šä¿è¯ Pod å§‹ç»ˆè¢«è°ƒåº¦åˆ°åŒä¸€èŠ‚ç‚¹ï¼Œæ•°æ®å°±ä¸ä¼šä¸ä¸¢å¤±ï¼Œè¿™ä¹Ÿç®—æ˜¯è°ƒåº¦ä¸å­˜å‚¨çš„äº²å’Œï¼Œè°ƒåº¦ç»“æœå–å†³äºå­˜å‚¨æ‰€åœ¨èŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;æ•°æ®å·æ‹“æ‰‘æ„ŸçŸ¥åŠ¨æ€åˆ›å»º (Topology-Aware Volume Dynamic Provisioning)&lt;/code&gt;: å…ˆè°ƒåº¦ Podï¼Œå†æ ¹æ® Pod æ‰€åœ¨èŠ‚ç‚¹çš„æ‹“æ‰‘åŸŸæ¥åˆ›å»ºå­˜å‚¨ï¼Œè¿™ç®—æ˜¯å­˜å‚¨ä¸è°ƒåº¦çš„äº²å’Œï¼Œå­˜å‚¨çš„åˆ›å»ºå–å†³äºè°ƒåº¦çš„ç»“æœã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è€Œ k8s ç›®å‰åœ¨ç½‘ç»œæ–¹é¢è¿˜æ²¡æœ‰äº²å’Œæ€§èƒ½åŠ›ï¼Œæ‹“æ‰‘æ„ŸçŸ¥æœåŠ¡è·¯ç”±è¿™ä¸ªæ–°ç‰¹æ€§æ°å¥½å¯ä»¥è¡¥é½è¿™ä¸ªçš„ç©ºç¼ºï¼Œæ­¤ç‰¹æ€§ä½¿å¾— service å¯ä»¥å®ç°å°±è¿‘è½¬å‘è€Œä¸æ˜¯æ‰€æœ‰ endpoint ç­‰æ¦‚ç‡è½¬å‘ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å¦‚ä½•å®ç°&quot;&gt;&lt;a href=&quot;#å¦‚ä½•å®ç°&quot; class=&quot;headerlink&quot; title=&quot;å¦‚ä½•å®ç°&quot;&gt;&lt;/a&gt;å¦‚ä½•å®ç°&lt;/h2&gt;&lt;p&gt;æˆ‘ä»¬çŸ¥é“ï¼Œservice è½¬å‘ä¸»è¦æ˜¯ node ä¸Šçš„ kube-proxy è¿›ç¨‹é€šè¿‡ watch apiserver è·å– service å¯¹åº”çš„ endpointï¼Œå†å†™å…¥ iptables æˆ– ipvs è§„åˆ™æ¥å®ç°çš„; å¯¹äº headless serviceï¼Œä¸»è¦æ˜¯é€šè¿‡ kube-dns æˆ– coredns åŠ¨æ€è§£æåˆ°ä¸åŒ endpoint ip æ¥å®ç°çš„ã€‚å®ç° service å°±è¿‘è½¬å‘çš„å…³é”®ç‚¹å°±åœ¨äºå¦‚ä½•å°†æµé‡è½¬å‘åˆ°è·Ÿå½“å‰èŠ‚ç‚¹åœ¨åŒä¸€æ‹“æ‰‘åŸŸçš„ endpoint ä¸Šï¼Œä¹Ÿå°±æ˜¯ä¼šè¿›è¡Œä¸€æ¬¡ endpoint ç­›é€‰ï¼Œé€‰å‡ºä¸€éƒ¨åˆ†ç¬¦åˆå½“å‰èŠ‚ç‚¹æ‹“æ‰‘åŸŸçš„ endpoint è¿›è¡Œè½¬å‘ã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ endpoint è·Ÿå½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨åŒä¸€æ‹“æ‰‘åŸŸé‡Œå‘¢ï¼Ÿåªè¦èƒ½è·å–åˆ° endpoint çš„æ‹“æ‰‘ä¿¡æ¯ï¼Œç”¨å®ƒè·Ÿå½“å‰èŠ‚ç‚¹æ‹“æ‰‘å¯¹æ¯”ä¸‹å°±å¯ä»¥çŸ¥é“äº†ã€‚é‚£åˆå¦‚ä½•è·å– endpoint çš„æ‹“æ‰‘ä¿¡æ¯å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡ endpoint æ‰€åœ¨èŠ‚ç‚¹çš„ labelï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ node label æ¥æè¿°æ‹“æ‰‘åŸŸã€‚&lt;/p&gt;
&lt;p&gt;é€šå¸¸åœ¨èŠ‚ç‚¹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œcontroller-manager å°±ä¼šä¸ºèŠ‚ç‚¹æ‰“ä¸Šè®¸å¤š labelï¼Œæ¯”å¦‚ &lt;code&gt;kubernetes.io/hostname&lt;/code&gt; è¡¨ç¤ºèŠ‚ç‚¹çš„ hostname æ¥åŒºåˆ†èŠ‚ç‚¹ï¼›å¦å¤–ï¼Œåœ¨äº‘å‚å•†æä¾›çš„ k8s æœåŠ¡ï¼Œæˆ–è€…ä½¿ç”¨ cloud-controller-manager çš„è‡ªå»ºé›†ç¾¤ï¼Œé€šå¸¸è¿˜ä¼šç»™èŠ‚ç‚¹æ‰“ä¸Š &lt;code&gt;failure-domain.beta.kubernetes.io/zone&lt;/code&gt; å’Œ &lt;code&gt;failure-domain.beta.kubernetes.io/region&lt;/code&gt; ä»¥åŒºåˆ†èŠ‚ç‚¹æ‰€åœ¨å¯ç”¨åŒºå’Œæ‰€åœ¨åœ°åŸŸï¼Œä½†è‡ª v1.17 å¼€å§‹å°†ä¼šæ”¹åæˆ &lt;code&gt;topology.kubernetes.io/zone&lt;/code&gt; å’Œ &lt;code&gt;topology.kubernetes.io/region&lt;/code&gt;ï¼Œå‚è§ &lt;a href=&quot;https://github.com/kubernetes/kubernetes/pull/81431&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;PR #81431&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚ä½•æ ¹æ® endpoint æŸ¥åˆ°å®ƒæ‰€åœ¨èŠ‚ç‚¹çš„è¿™äº› label å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡ &lt;code&gt;Endpoint Slice&lt;/code&gt;ï¼Œè¯¥ç‰¹æ€§åœ¨ v1.16 å‘å¸ƒäº† alphaï¼Œåœ¨ v1.17 å°†ä¼šè¿›å…¥ betaï¼Œå®ƒç›¸å½“äº Endpoint API å¢å¼ºç‰ˆï¼Œé€šè¿‡å°† endpoint åšæ•°æ®åˆ†ç‰‡æ¥è§£å†³å¤§è§„æ¨¡ endpoint çš„æ€§èƒ½é—®é¢˜ï¼Œå¹¶ä¸”å¯ä»¥æºå¸¦æ›´å¤šçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ endpoint æ‰€åœ¨èŠ‚ç‚¹çš„æ‹“æ‰‘ä¿¡æ¯ï¼Œæ‹“æ‰‘æ„ŸçŸ¥æœåŠ¡è·¯ç”±ç‰¹æ€§ä¼šé€šè¿‡ &lt;code&gt;Endpoint Slice&lt;/code&gt; è·å–è¿™äº›æ‹“æ‰‘ä¿¡æ¯å®ç° endpoint ç­›é€‰ (è¿‡æ»¤å‡ºåœ¨åŒä¸€æ‹“æ‰‘åŸŸçš„ endpoint)ï¼Œç„¶åå†è½¬æ¢ä¸º iptables æˆ– ipvs è§„åˆ™å†™å…¥èŠ‚ç‚¹ä»¥å®ç°æ‹“æ‰‘æ„ŸçŸ¥çš„è·¯ç”±è½¬å‘ã€‚&lt;/p&gt;
&lt;p&gt;ç»†å¿ƒçš„ä½ å¯èƒ½å·²ç»å‘ç°ï¼Œä¹‹å‰æ¯ä¸ªèŠ‚ç‚¹ä¸Šè½¬å‘ service çš„ iptables/ipvs è§„åˆ™åŸºæœ¬æ˜¯ä¸€æ ·çš„ï¼Œä½†å¯ç”¨äº†æ‹“æ‰‘æ„ŸçŸ¥æœåŠ¡è·¯ç”±ç‰¹æ€§ä¹‹åï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„è½¬å‘è§„åˆ™å°±å¯èƒ½ä¸ä¸€æ ·äº†ï¼Œå› ä¸ºä¸åŒèŠ‚ç‚¹çš„æ‹“æ‰‘ä¿¡æ¯ä¸ä¸€æ ·ï¼Œå¯¼è‡´è¿‡æ»¤å‡ºçš„ endpoint å°±ä¸ä¸€æ ·ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºè¿™æ ·ï¼Œservice è½¬å‘å˜å¾—ä¸å†ç­‰æ¦‚ç‡ï¼Œçµæ´»çš„å°±è¿‘è½¬å‘æ‰å¾—ä»¥å®ç°ã€‚&lt;/p&gt;
&lt;p&gt;å½“å‰è¿˜ä¸æ”¯æŒ headless service çš„æ‹“æ‰‘è·¯ç”±ï¼Œè®¡åˆ’åœ¨ beta é˜¶æ®µæ”¯æŒã€‚ç”±äº &lt;a href=&quot;https://zhuanlan.zhihu.com/p/54153164&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;headless service&lt;/a&gt; ä¸æ˜¯é€šè¿‡ kube-proxy ç”Ÿæˆè½¬å‘è§„åˆ™ï¼Œè€Œæ˜¯é€šè¿‡ dns åŠ¨æ€è§£æå®ç°çš„ï¼Œæ‰€ä»¥éœ€è¦æ”¹ kube-dns/coredns æ¥æ”¯æŒè¿™ä¸ªç‰¹æ€§ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å‰ææ¡ä»¶&quot;&gt;&lt;a href=&quot;#å‰ææ¡ä»¶&quot; class=&quot;headerlink&quot; title=&quot;å‰ææ¡ä»¶&quot;&gt;&lt;/a&gt;å‰ææ¡ä»¶&lt;/h2&gt;&lt;p&gt;å¯ç”¨å½“å‰ alpha å®ç°çš„æ‹“æ‰‘æ„ŸçŸ¥æœåŠ¡è·¯ç”±ç‰¹æ€§éœ€è¦æ»¡è¶³ä»¥ä¸‹å‰ææ¡ä»¶:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é›†ç¾¤ç‰ˆæœ¬åœ¨ v1.17 åŠå…¶ä»¥ä¸Šã€‚&lt;/li&gt;
&lt;li&gt;Kube-proxy ä»¥ iptables æˆ– IPVS æ¨¡å¼è¿è¡Œ (alpha é˜¶æ®µæš‚æ—¶åªå®ç°äº†è¿™ä¸¤ç§æ¨¡å¼)ã€‚&lt;/li&gt;
&lt;li&gt;å¯ç”¨äº† &lt;a href=&quot;https://kubernetes.io/docs/concepts/services-networking/endpoint-slices/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Endpoint Slices&lt;/a&gt; (æ­¤ç‰¹æ€§è™½ç„¶åœ¨ v1.17 è¿›å…¥ betaï¼Œä½†æ²¡æœ‰é»˜è®¤å¼€å¯)ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;å¦‚ä½•å¯ç”¨æ­¤ç‰¹æ€§&quot;&gt;&lt;a href=&quot;#å¦‚ä½•å¯ç”¨æ­¤ç‰¹æ€§&quot; class=&quot;headerlink&quot; title=&quot;å¦‚ä½•å¯ç”¨æ­¤ç‰¹æ€§&quot;&gt;&lt;/a&gt;å¦‚ä½•å¯ç”¨æ­¤ç‰¹æ€§&lt;/h2&gt;&lt;p&gt;ç»™æ‰€æœ‰ k8s ç»„ä»¶æ‰“å¼€ &lt;code&gt;ServiceTopology&lt;/code&gt; å’Œ &lt;code&gt;EndpointSlice&lt;/code&gt; è¿™ä¸¤ä¸ª feature:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;--feature-gates=&lt;span class=&quot;string&quot;&gt;&quot;ServiceTopology=true,EndpointSlice=true&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;å¦‚ä½•ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#å¦‚ä½•ä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;å¦‚ä½•ä½¿ç”¨&quot;&gt;&lt;/a&gt;å¦‚ä½•ä½¿ç”¨&lt;/h2&gt;&lt;p&gt;åœ¨ Service spec é‡ŒåŠ ä¸Š &lt;code&gt;topologyKeys&lt;/code&gt; å­—æ®µï¼Œè¡¨ç¤ºè¯¥ Service ä¼˜å…ˆé¡ºåºé€‰ç”¨çš„æ‹“æ‰‘åŸŸåˆ—è¡¨ï¼Œå¯¹åº”èŠ‚ç‚¹æ ‡ç­¾çš„ keyï¼›å½“è®¿é—®æ­¤ Service æ—¶ï¼Œä¼šæ‰¾æ˜¯å¦æœ‰ endpoint æœ‰å¯¹åº” topology key çš„æ‹“æ‰‘ä¿¡æ¯å¹¶ä¸” value è·Ÿå½“å‰èŠ‚ç‚¹ä¹Ÿä¸€æ ·ï¼Œå¦‚æœæ˜¯ï¼Œé‚£å°±é€‰å®šæ­¤ topology key ä½œä¸ºå½“å‰è½¬å‘çš„æ‹“æ‰‘åŸŸï¼Œå¹¶ä¸”ç­›é€‰å‡ºå…¶ä½™æ‰€æœ‰åœ¨è¿™ä¸ªæ‹“æ‰‘åŸŸçš„ endpoint æ¥è¿›è¡Œè½¬å‘ï¼›å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½• endpoint åœ¨å½“å‰ topology key å¯¹åº”æ‹“æ‰‘åŸŸï¼Œå°±ä¼šå°è¯•ç¬¬äºŒä¸ª topology keyï¼Œä¾æ­¤ç±»æ¨ï¼›å¦‚æœéå†å®Œæ‰€æœ‰ topology key ä¹Ÿæ²¡æœ‰åŒ¹é…åˆ° endpoint å°±ä¼šæ‹’ç»è½¬å‘ï¼Œå°±åƒæ­¤ service æ²¡æœ‰åç«¯ endpoint ä¸€æ ·ã€‚&lt;/p&gt;
&lt;p&gt;æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ topology key â€œ&lt;code&gt;*&lt;/code&gt;â€ï¼Œå®ƒå¯ä»¥åŒ¹é…æ‰€æœ‰ endpointï¼Œå¦‚æœ &lt;code&gt;topologyKeys&lt;/code&gt; åŒ…å«äº† &lt;code&gt;*&lt;/code&gt;ï¼Œå®ƒå¿…é¡»åœ¨åˆ—è¡¨æœ«å°¾ï¼Œé€šå¸¸æ˜¯åœ¨æ²¡æœ‰åŒ¹é…åˆ°åˆé€‚çš„æ‹“æ‰‘åŸŸæ¥å®ç°å°±è¿‘è½¬å‘æ—¶ï¼Œå°±æ‰“æ¶ˆå°±è¿‘è½¬å‘çš„å¿µå¤´ï¼Œå¯ä»¥è½¬å‘åˆ°ä»»æ„ endpoint ä¸Šã€‚&lt;/p&gt;
&lt;p&gt;å½“å‰ topology key æ”¯æŒä»¥ä¸‹å¯èƒ½çš„å€¼ï¼ˆæœªæ¥ä¼šå¢åŠ æ›´å¤šï¼‰:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;kubernetes.io/hostname&lt;/code&gt;: èŠ‚ç‚¹çš„ hostnameï¼Œé€šå¸¸å°†å®ƒæ”¾åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªï¼Œè¡¨ç¤ºå¦‚æœæœ¬æœºæœ‰ endpoint å°±ç›´æ¥è½¬å‘åˆ°æœ¬æœºçš„ endpointã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;topology.kubernetes.io/zone&lt;/code&gt;: èŠ‚ç‚¹æ‰€åœ¨çš„å¯ç”¨åŒºï¼Œé€šå¸¸å°†å®ƒæ”¾åœ¨ &lt;code&gt;kubernetes.io/hostname&lt;/code&gt; åé¢ï¼Œè¡¨ç¤ºå¦‚æœæœ¬æœºæ²¡æœ‰å¯¹åº” endpointï¼Œå°±è½¬å‘åˆ°å½“å‰å¯ç”¨åŒºå…¶å®ƒèŠ‚ç‚¹ä¸Šçš„ endpointï¼ˆéƒ¨åˆ†äº‘å‚å•†è·¨å¯ç”¨åŒºé€šä¿¡ä¼šæ”¶å–é¢å¤–çš„æµé‡è´¹ç”¨ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;topology.kubernetes.io/region&lt;/code&gt;: è¡¨ç¤ºèŠ‚ç‚¹æ‰€åœ¨çš„åœ°åŸŸï¼Œè¡¨ç¤ºè½¬å‘åˆ°å½“å‰åœ°åŸŸçš„ endpointï¼Œè¿™ä¸ªç”¨çš„åº”è¯¥ä¼šæ¯”è¾ƒå°‘ï¼Œå› ä¸ºé€šå¸¸é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹éƒ½åªä¼šåœ¨åŒä¸€ä¸ªåœ°åŸŸï¼Œå¦‚æœèŠ‚ç‚¹è·¨åœ°åŸŸäº†ï¼ŒèŠ‚ç‚¹ä¹‹é—´é€šä¿¡å»¶æ—¶å°†ä¼šå¾ˆé«˜ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;*&lt;/code&gt;: å¿½ç•¥æ‹“æ‰‘åŸŸï¼ŒåŒ¹é…æ‰€æœ‰ endpointï¼Œç›¸å½“äºä¸€ä¸ªä¿åº•ç­–ç•¥ï¼Œé¿å…ä¸¢åŒ…ï¼Œåªèƒ½æ”¾åœ¨åˆ—è¡¨æœ«å°¾ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹çº¦æŸ:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;topologyKeys&lt;/code&gt; ä¸ &lt;code&gt;externalTrafficPolicy=Local&lt;/code&gt; ä¸å…¼å®¹ï¼Œæ˜¯äº’æ–¥çš„ï¼Œå¦‚æœ &lt;code&gt;externalTrafficPolicy&lt;/code&gt; ä¸º &lt;code&gt;Local&lt;/code&gt;ï¼Œå°±ä¸èƒ½å®šä¹‰ &lt;code&gt;topologyKeys&lt;/code&gt;ï¼Œåä¹‹äº¦ç„¶ã€‚&lt;/li&gt;
&lt;li&gt;topology key å¿…é¡»æ˜¯åˆæ³•çš„ label æ ¼å¼ï¼Œå¹¶ä¸”æœ€å¤šå®šä¹‰ 16 ä¸ª keyã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™é‡Œç»™å‡ºä¸€ä¸ªç®€å•çš„ Service ç¤ºä¾‹:&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  type:&lt;/span&gt; ClusterIP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; http&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    port:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    protocol:&lt;/span&gt; TCP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    targetPort:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  selector:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    app:&lt;/span&gt; nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  topologyKeys:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;kubernetes.io/hostname&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;topology.kubernetes.io/zone&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;*&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è§£é‡Š: å½“è®¿é—® nginx æœåŠ¡æ—¶ï¼Œé¦–å…ˆçœ‹æœ¬æœºæ˜¯å¦æœ‰è¿™ä¸ªæœåŠ¡çš„ endpointï¼Œå¦‚æœæœ‰å°±ç›´æ¥æœ¬æœºè·¯ç”±è¿‡å»ï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±çœ‹æ˜¯å¦æœ‰ endpoint ä½äºå½“å‰èŠ‚ç‚¹æ‰€åœ¨å¯ç”¨åŒºï¼Œå¦‚æœæœ‰ï¼Œå°±è½¬å‘è¿‡å»ï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œå°±è½¬å‘ç»™ä»»æ„ endpointã€‚&lt;br&gt;&lt;img src=&quot;/images/k8s/service-topology.png&quot; alt=&quot;service-topology&quot;&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šå›¾å°±æ˜¯å…¶ä¸­ä¸€æ¬¡è½¬å‘çš„ä¾‹å­ï¼šPod è®¿é—® nginx è¿™ä¸ª service æ—¶ï¼Œå‘ç°æœ¬æœºæ²¡æœ‰ endpointï¼Œå°±æ‰¾å½“å‰å¯ç”¨åŒºçš„ï¼Œæ‰¾åˆ°äº†å°±è½¬å‘è¿‡å»ï¼Œä¹Ÿå°±ä¸ä¼šè€ƒè™‘è½¬å‘ç»™å¦ä¸€å¯ç”¨åŒºçš„ endpointã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼šimroc&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;åè¯è§£é‡Š&quot;&gt;&lt;a href=&quot;#åè¯è§£é‡Š&quot; class=&quot;headerlink&quot; title=&quot;åè¯è§£é‡Š&quot;&gt;&lt;/a&gt;åè¯è§£é‡Š&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;æ‹“æ‰‘åŸŸ&lt;/code&gt;: è¡¨ç¤ºåœ¨é›†ç¾¤ä¸­çš„æŸä¸€ç±» â€œåœ°æ–¹â€ï¼Œæ¯”å¦‚æŸèŠ‚ç‚¹ã€æŸæœºæ¶ã€æŸå¯ç”¨åŒºæˆ–æŸåœ°åŸŸç­‰ï¼Œè¿™äº›éƒ½å¯ä»¥ä½œä¸ºæŸç§æ‹“æ‰‘åŸŸã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;endpoint&lt;/code&gt;: k8s æŸä¸ªæœåŠ¡çš„æŸä¸ª ip+portï¼Œé€šå¸¸æ˜¯ pod çš„ ip+portã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;service&lt;/code&gt;: k8s çš„ service èµ„æº(æœåŠ¡)ï¼Œå…³è”ä¸€ç»„ endpoint ï¼Œè®¿é—® service ä¼šè¢«è½¬å‘åˆ°å…³è”çš„æŸä¸ª endpoint ä¸Šã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;æ‹“æ‰‘æ„ŸçŸ¥æœåŠ¡è·¯ç”±ï¼Œæ­¤ç‰¹æ€§æœ€åˆç”±æœå†›å¤§ä½¬æå‡ºå¹¶è®¾è®¡ã€‚ä¸ºä»€ä¹ˆè¦è®¾è®¡æ­¤ç‰¹æ€§å‘¢ï¼Ÿæƒ³è±¡ä¸€ä¸‹ï¼Œk8s é›†ç¾¤èŠ‚ç‚¹åˆ†å¸ƒåœ¨ä¸åŒçš„åœ°æ–¹ï¼Œservice å¯¹åº”çš„ endpoints åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ï¼Œä¼ ç»Ÿè½¬å‘ç­–ç•¥ä¼šå¯¹æ‰€æœ‰ endpoint åšè´Ÿè½½å‡è¡¡ï¼Œé€šå¸¸ä¼šç­‰æ¦‚ç‡è½¬å‘ï¼Œå½“è®¿é—® service æ—¶ï¼Œæµé‡å°±å¯èƒ½è¢«åˆ†æ•£æ‰“åˆ°è¿™äº›ä¸åŒçš„åœ°æ–¹ã€‚è™½ç„¶ service è½¬å‘åšäº†è´Ÿè½½å‡è¡¡ï¼Œä½†å¦‚æœ endpoint è·ç¦»æ¯”è¾ƒè¿œï¼Œæµé‡è½¬å‘è¿‡å»ç½‘ç»œæ—¶å»¶å°±ç›¸å¯¹æ¯”è¾ƒé«˜ï¼Œä¼šå½±å“ç½‘ç»œæ€§èƒ½ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ç”šè‡³è¿˜å¯èƒ½ä¼šä»˜å‡ºé¢å¤–çš„æµé‡è´¹ç”¨ã€‚è¦æ˜¯å¦‚èƒ½å®ç° service å°±è¿‘è½¬å‘ endpointï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥å®ç°é™ä½ç½‘ç»œæ—¶å»¶ï¼Œæå‡ç½‘ç»œæ€§èƒ½äº†å‘¢ï¼Ÿæ˜¯çš„ï¼è¿™ä¹Ÿæ­£æ˜¯è¯¥ç‰¹æ€§æ‰€æå‡ºçš„ç›®çš„å’Œæ„ä¹‰ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="kubrenetes" scheme="http://team.jiunile.com/categories/kubrenetes/"/>
    
      <category term="æ–°ç‰¹æ€§" scheme="http://team.jiunile.com/categories/kubrenetes/%E6%96%B0%E7%89%B9%E6%80%A7/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/tags/kubernetes/"/>
    
      <category term="æœåŠ¡è·¯ç”±" scheme="http://team.jiunile.com/tags/%E6%9C%8D%E5%8A%A1%E8%B7%AF%E7%94%B1/"/>
    
      <category term="æ–°ç‰¹æ€§" scheme="http://team.jiunile.com/tags/%E6%96%B0%E7%89%B9%E6%80%A7/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨NodeLocal DNSCacheæ¥æå‡CoreDNSçš„æ€§èƒ½åŠå‹åŠ›</title>
    <link href="http://team.jiunile.com//blog/2020/05/k8s-nodelocal-dnscache.html"/>
    <id>http://team.jiunile.com//blog/2020/05/k8s-nodelocal-dnscache.html</id>
    <published>2020-05-22T10:00:00.000Z</published>
    <updated>2020-05-22T02:58:40.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;æ¦‚å†µ&quot;&gt;&lt;a href=&quot;#æ¦‚å†µ&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚å†µ&quot;&gt;&lt;/a&gt;æ¦‚å†µ&lt;/h2&gt;&lt;p&gt;ä¹‹å‰åœ¨è§£å†³ CoreDNS çš„5ç§’è¶…æ—¶é—®é¢˜çš„æ—¶å€™ï¼Œé™¤äº†é€šè¿‡ &lt;code&gt;dnsConfig&lt;/code&gt; å»å¼ºåˆ¶ä½¿ç”¨ tcp æ–¹å¼è§£æä¹‹å¤–ï¼Œæˆ‘ä»¬æåˆ°è¿‡ä½¿ç”¨ &lt;code&gt;NodeLocal DNSCache&lt;/code&gt; æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚&lt;code&gt;NodeLocal DNSCache&lt;/code&gt; é€šè¿‡åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª DaemonSet æ¥æé«˜ clusterDNS æ€§èƒ½å’Œå¯é æ€§ã€‚å¤„äº &lt;code&gt;ClusterFirst&lt;/code&gt; çš„ DNS æ¨¡å¼ä¸‹çš„ Pod å¯ä»¥è¿æ¥åˆ° &lt;code&gt;kube-dns&lt;/code&gt; çš„ serviceIP è¿›è¡Œ DNS æŸ¥è¯¢ã€‚é€šè¿‡ &lt;code&gt;kube-proxy&lt;/code&gt; ç»„ä»¶æ·»åŠ çš„ &lt;code&gt;iptables&lt;/code&gt; è§„åˆ™å°†å…¶è½¬æ¢ä¸º &lt;code&gt;CoreDNS&lt;/code&gt; ç«¯ç‚¹ã€‚é€šè¿‡åœ¨æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šè¿è¡Œ DNS ç¼“å­˜ï¼Œ&lt;code&gt;NodeLocal DNSCache&lt;/code&gt; å¯ä»¥ç¼©çŸ­ DNS æŸ¥æ‰¾çš„å»¶è¿Ÿæ—¶é—´ã€ä½¿ DNS æŸ¥æ‰¾æ—¶é—´æ›´åŠ ä¸€è‡´ï¼Œä»¥åŠå‡å°‘å‘é€åˆ° &lt;code&gt;kube-dns&lt;/code&gt; çš„ DNS æŸ¥è¯¢æ¬¡æ•°ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨é›†ç¾¤ä¸­è¿è¡Œ NodeLocal DNSCache æœ‰å¦‚ä¸‹å‡ ä¸ªå¥½å¤„ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœæœ¬åœ°æ²¡æœ‰ CoreDNS å®ä¾‹ï¼Œåˆ™å…·æœ‰æœ€é«˜ DNS QPS çš„ Pod å¯èƒ½å¿…é¡»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œè§£æï¼Œä½¿ç”¨ NodeLocal DNSCache åï¼Œæ‹¥æœ‰æœ¬åœ°ç¼“å­˜å°†æœ‰åŠ©äºæ”¹å–„å»¶è¿Ÿ&lt;/li&gt;
&lt;li&gt;è·³è¿‡ iptables DNAT å’Œè¿æ¥è·Ÿè¸ªå°†æœ‰åŠ©äºå‡å°‘ &lt;code&gt;conntrack&lt;/code&gt; ç«äº‰å¹¶é¿å… UDP DNS æ¡ç›®å¡«æ»¡ &lt;code&gt;conntrack&lt;/code&gt; è¡¨ï¼ˆå¸¸è§çš„5sè¶…æ—¶é—®é¢˜å°±æ˜¯è¿™ä¸ªåŸå› é€ æˆçš„ï¼‰&lt;/li&gt;
&lt;li&gt;ä»æœ¬åœ°ç¼“å­˜ä»£ç†åˆ° kube-dns æœåŠ¡çš„è¿æ¥å¯ä»¥å‡çº§åˆ° TCPï¼ŒTCP conntrack æ¡ç›®å°†åœ¨è¿æ¥å…³é—­æ—¶è¢«åˆ é™¤ï¼Œè€Œ UDP æ¡ç›®å¿…é¡»è¶…æ—¶(&lt;a href=&quot;https://www.kernel.org/doc/Documentation/networking/nf_conntrack-sysctl.txt&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;é»˜è®¤ nf_conntrack_udp_timeout æ˜¯ 30 ç§’&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;å°† DNS æŸ¥è¯¢ä» UDP å‡çº§åˆ° TCP å°†å‡å°‘å½’å› äºä¸¢å¼ƒçš„ UDP æ•°æ®åŒ…å’Œ DNS è¶…æ—¶çš„å°¾éƒ¨ç­‰å¾…æ—¶é—´ï¼Œé€šå¸¸é•¿è¾¾ 30 ç§’ï¼ˆ3 æ¬¡é‡è¯•+ 10 ç§’è¶…æ—¶ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;&lt;img src=&quot;/images/k8s/dnscache.png&quot; alt=&quot;NodeLocal DNSCache&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;å®‰è£…ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#å®‰è£…ä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…ä½¿ç”¨&quot;&gt;&lt;/a&gt;å®‰è£…ä½¿ç”¨&lt;/h2&gt;&lt;p&gt;è¦å®‰è£… NodeLocal DNSCache ä¹Ÿéå¸¸ç®€å•ï¼Œç›´æ¥è·å–å®˜æ–¹çš„èµ„æºæ¸…å•å³å¯ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ wget https://github.com/kubernetes/kubernetes/raw/master/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¯¥èµ„æºæ¸…å•æ–‡ä»¶ä¸­åŒ…å«å‡ ä¸ªå˜é‡ï¼Œå…¶ä¸­ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;__PILLAR__DNS__SERVER__&lt;/code&gt; ï¼šè¡¨ç¤º &lt;code&gt;kube-dns&lt;/code&gt; è¿™ä¸ª Service çš„ ClusterIPï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ &lt;code&gt;kubectl get svc -n kube-system | grep kube-dns | awk &amp;#39;{ print $3 }&amp;#39;&lt;/code&gt; è·å–ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;__PILLAR__LOCAL__DNS__&lt;/code&gt;ï¼šè¡¨ç¤º DNSCache æœ¬åœ°çš„ IPï¼Œé»˜è®¤ä¸º 169.254.20.10&lt;/li&gt;
&lt;li&gt;&lt;code&gt;__PILLAR__DNS__DOMAIN__&lt;/code&gt;ï¼šè¡¨ç¤ºé›†ç¾¤åŸŸï¼Œé»˜è®¤å°±æ˜¯ cluster.local&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¦å¤–è¿˜æœ‰ä¸¤ä¸ªå‚æ•° &lt;code&gt;__PILLAR__CLUSTER__DNS__&lt;/code&gt; å’Œ &lt;code&gt;__PILLAR__UPSTREAM__SERVERS__&lt;/code&gt;ï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä¼šé€šè¿‡é•œåƒ 1.15.6 ç‰ˆæœ¬ä»¥ä¸Šçš„å»è¿›è¡Œé…ç½®ï¼Œå¯¹åº”çš„å€¼æ¥æºäº kube-dns çš„ ConfigMap å’Œå®šåˆ¶çš„ Upstream Server é…ç½®ã€‚ç›´æ¥æ‰§è¡Œå¦‚ä¸‹æ‰€ç¤ºçš„å‘½ä»¤å³å¯å®‰è£…ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sed &lt;span class=&quot;string&quot;&gt;&#39;s/k8s.gcr.io/cnych/g&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;s/__PILLAR__DNS__SERVER__/10.96.0.10/g&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;s/__PILLAR__LOCAL__DNS__/169.254.20.10/g&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;s/__PILLAR__DNS__DOMAIN__/cluster.local/g&#39;&lt;/span&gt; nodelocaldns.yaml |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; -&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹å¯¹åº”çš„ Pod æ˜¯å¦å·²ç»å¯åŠ¨æˆåŠŸï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods -n kube-system | grep node-local-dns&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node-local-dns-8zm2f                    1/1     Running     0          9m54s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node-local-dns-dd4xg                    1/1     Running     0          9m54s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node-local-dns-hs8qq                    1/1     Running     0          9m54s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node-local-dns-pxfxn                    1/1     Running     0          9m54s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node-local-dns-stjm9                    1/1     Running     0          9m54s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node-local-dns-wjxvz                    1/1     Running     0          9m54s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;node-local-dns-wn5wc                    1/1     Running     0          7m49s&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œä½¿ç”¨ DaemonSet éƒ¨ç½² node-local-dns ä½¿ç”¨äº† &lt;code&gt;hostNetwork=true&lt;/code&gt;ï¼Œä¼šå ç”¨å®¿ä¸»æœºçš„ 8080 ç«¯å£ï¼Œæ‰€ä»¥éœ€è¦ä¿è¯è¯¥ç«¯å£æœªè¢«å ç”¨ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä½†æ˜¯åˆ°è¿™é‡Œè¿˜æ²¡æœ‰å®Œï¼Œå¦‚æœ kube-proxy ç»„ä»¶ä½¿ç”¨çš„æ˜¯ ipvs æ¨¡å¼çš„è¯æˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ kubelet çš„ &lt;code&gt;--cluster-dns&lt;/code&gt; å‚æ•°ï¼Œå°†å…¶æŒ‡å‘ &lt;code&gt;169.254.20.10&lt;/code&gt;ï¼ŒDaemonset ä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªç½‘å¡æ¥ç»‘è¿™ä¸ª IPï¼ŒPod å‘æœ¬èŠ‚ç‚¹è¿™ä¸ª IP å‘ DNS è¯·æ±‚ï¼Œç¼“å­˜æ²¡æœ‰å‘½ä¸­çš„æ—¶å€™æ‰ä¼šå†ä»£ç†åˆ°ä¸Šæ¸¸é›†ç¾¤ DNS è¿›è¡ŒæŸ¥è¯¢ã€‚ &lt;code&gt;iptables&lt;/code&gt; æ¨¡å¼ä¸‹ Pod è¿˜æ˜¯å‘åŸæ¥çš„é›†ç¾¤ DNS è¯·æ±‚ï¼ŒèŠ‚ç‚¹ä¸Šæœ‰è¿™ä¸ª IP ç›‘å¬ï¼Œä¼šè¢«æœ¬æœºæ‹¦æˆªï¼Œå†è¯·æ±‚é›†ç¾¤ä¸Šæ¸¸ DNSï¼Œæ‰€ä»¥ä¸éœ€è¦æ›´æ”¹ &lt;code&gt;--cluster-dns&lt;/code&gt; å‚æ•°ã€‚&lt;/p&gt;
&lt;h3 id=&quot;ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼ä¸€&quot;&gt;&lt;a href=&quot;#ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼ä¸€&quot; class=&quot;headerlink&quot; title=&quot;ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼ä¸€&quot;&gt;&lt;/a&gt;ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼ä¸€&lt;/h3&gt;&lt;p&gt;ç”±äºæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ kubeadm å®‰è£…çš„ 1.16 ç‰ˆæœ¬çš„é›†ç¾¤ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ›¿æ¢èŠ‚ç‚¹ä¸Š &lt;code&gt;/var/lib/kubelet/config.yaml&lt;/code&gt; æ–‡ä»¶ä¸­çš„ &lt;code&gt;clusterDNS&lt;/code&gt; è¿™ä¸ªå‚æ•°å€¼ï¼Œç„¶åé‡å¯å³å¯ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/10.96.0.10/169.254.20.10/g&#39;&lt;/span&gt; /var/lib/kubelet/config.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ systemctl daemon-reload &amp;amp;&amp;amp; systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼äºŒ-ï¼ˆä¸æ¨èï¼‰&quot;&gt;&lt;a href=&quot;#ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼äºŒ-ï¼ˆä¸æ¨èï¼‰&quot; class=&quot;headerlink&quot; title=&quot;ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼äºŒ ï¼ˆä¸æ¨èï¼‰&quot;&gt;&lt;/a&gt;ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼äºŒ ï¼ˆä¸æ¨èï¼‰&lt;/h3&gt;&lt;p&gt;æˆ‘ä»¬ä¹Ÿå¯ä»¥å®Œå…¨åœ¨å®˜æ–¹çš„ DaemonSet èµ„æºå¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ª initContainer æ¥å®Œæˆè¿™ä¸ªå·¥ä½œã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;initContainers:  &lt;span class=&quot;comment&quot;&gt;# ipvsæ¨¡å¼ä¸‹éœ€è¦ä¿®æ”¹dnsé…ç½®ï¼Œé‡å¯kubelet&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - name: setup&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    image: alpine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    tty: &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    stdin: &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    securityContext:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      privileged: &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;command&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - nsenter&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - --target&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - &lt;span class=&quot;string&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - --mount&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - --uts&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - --ipc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - --net&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - --pid&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - --&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - bash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - -c&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;# ç¡®ä¿ kubelet --cluster-dns è¢«è®¾ç½®ä¸º 169.254.20.10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Configuring kubelet --cluster-dns=169.254.20.10&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      sed -i &lt;span class=&quot;string&quot;&gt;&#39;s/10.96.0.10/169.254.20.10/g&#39;&lt;/span&gt; /var/lib/kubelet/config.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      systemctl daemon-reload &amp;amp;&amp;amp; systemctl restart kubelet&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºçº¿ä¸Šç¯å¢ƒè¿˜æ˜¯ä¸æ¨èç”¨ä¸Šé¢çš„æ–¹å¼ï¼Œå› ä¸ºå®ƒä¼šä¼˜å…ˆå°† kubelet çš„ &lt;code&gt;cluster-dns&lt;/code&gt; å‚æ•°è¿›è¡Œä¿®æ”¹ï¼Œç„¶åå†å»å®‰è£… NodeLocalï¼Œè¿™ä¸­é—´æ¯•ç«Ÿæœ‰ä¸€æ®µçœŸç©ºæœŸã€‚&lt;/p&gt;
&lt;h2 id=&quot;éªŒè¯&quot;&gt;&lt;a href=&quot;#éªŒè¯&quot; class=&quot;headerlink&quot; title=&quot;éªŒè¯&quot;&gt;&lt;/a&gt;éªŒè¯&lt;/h2&gt;&lt;p&gt;å¾… &lt;code&gt;node-local-dns&lt;/code&gt; å®‰è£…é…ç½®å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥éƒ¨ç½²ä¸€ä¸ªæ–°çš„ Pod æ¥éªŒè¯ä¸‹ï¼š(test-node-local-dns.yaml)&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; test-node-local-dns&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; local-dns&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    image:&lt;/span&gt; busybox&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    command:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;/bin/sh&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;-c&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;sleep 60m&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç›´æ¥éƒ¨ç½²ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl apply &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-node-local-dns.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; -it &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;-node-local-dns /bin/sh&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/ &lt;span class=&quot;comment&quot;&gt;# cat /etc/resolv.conf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nameserver 169.254.20.10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;search default.svc.cluster.local svc.cluster.local cluster.local&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;options ndots:5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å¯ä»¥çœ‹åˆ° &lt;code&gt;nameserver&lt;/code&gt; å·²ç»å˜æˆ &lt;code&gt;169.254.20.10&lt;/code&gt; äº†ï¼Œå½“ç„¶å¯¹äºä¹‹å‰çš„å†å² Pod è¦æƒ³ä½¿ç”¨ &lt;code&gt;node-local-dns&lt;/code&gt; åˆ™éœ€è¦é‡å»ºï¼Œå½“ç„¶å¦‚æœè¦æƒ³å»è·Ÿè¸ª DNS çš„è§£æè¿‡ç¨‹çš„è¯å¯ä»¥å»é€šè¿‡æŠ“åŒ…æ¥è§‚å¯Ÿã€‚&lt;/p&gt;
&lt;h2 id=&quot;ç•ªå¤–ç¯‡&quot;&gt;&lt;a href=&quot;#ç•ªå¤–ç¯‡&quot; class=&quot;headerlink&quot; title=&quot;ç•ªå¤–ç¯‡&quot;&gt;&lt;/a&gt;ç•ªå¤–ç¯‡&lt;/h2&gt;&lt;p&gt;åœ¨ä½¿ç”¨äº†&lt;code&gt;NodeLocal DNSCache&lt;/code&gt;åï¼Œå¦‚æœåœ¨é…ç½®è‡ªå®šä¹‰åŸŸåï¼Ÿ&lt;/p&gt;
&lt;p&gt;é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨ CoreDNS çš„ ConfigMap ä¸­æ·»åŠ  hosts æ’ä»¶ï¼š&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;hosts &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;number&quot;&gt;192.168&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.3&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.211&lt;/span&gt; git.k8s.local&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  fallthrough&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å…¶æ¬¡æˆ‘ä»¬éœ€è¦ä¿®æ”¹ &lt;code&gt;NodeLocal DNSCache&lt;/code&gt; çš„ ConfigMapï¼Œå½“å‰é…ç½®å¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cluster.local:&lt;span class=&quot;number&quot;&gt;53&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    errors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cache &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            success &lt;span class=&quot;number&quot;&gt;9984&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            denial &lt;span class=&quot;number&quot;&gt;9984&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    reload&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    loop&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    bind &lt;span class=&quot;number&quot;&gt;169.254&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.20&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.10&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10.96&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    forward . &lt;span class=&quot;number&quot;&gt;10.96&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.207&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.156&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            force_tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    prometheus :&lt;span class=&quot;number&quot;&gt;9253&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    health &lt;span class=&quot;number&quot;&gt;169.254&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.20&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.10&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;8080&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;in-addr.arpa:&lt;span class=&quot;number&quot;&gt;53&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    errors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cache &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    reload&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    loop&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    bind &lt;span class=&quot;number&quot;&gt;169.254&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.20&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.10&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10.96&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    forward . &lt;span class=&quot;number&quot;&gt;10.96&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.207&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.156&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            force_tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    prometheus :&lt;span class=&quot;number&quot;&gt;9253&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ip6.arpa:&lt;span class=&quot;number&quot;&gt;53&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    errors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cache &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    reload&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    loop&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    bind &lt;span class=&quot;number&quot;&gt;169.254&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.20&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.10&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10.96&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    forward . &lt;span class=&quot;number&quot;&gt;10.96&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.207&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.156&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            force_tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    prometheus :&lt;span class=&quot;number&quot;&gt;9253&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.:&lt;span class=&quot;number&quot;&gt;53&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    errors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cache &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    reload&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    loop&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    bind &lt;span class=&quot;number&quot;&gt;169.254&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.20&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.10&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10.96&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    forward . /etc/resolv.conf &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            force_tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    prometheus :&lt;span class=&quot;number&quot;&gt;9253&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åˆ†æä¸Šé¢çš„ LocalDNS çš„é…ç½®ä¿¡æ¯ï¼Œå…¶ä¸­ &lt;code&gt;10.96.0.10&lt;/code&gt; ä¸º CoreDNS çš„ Service ClusterIPï¼Œ&lt;code&gt;169.254.20.10&lt;/code&gt; ä¸º LocalDNS çš„ IP åœ°å€ï¼Œ&lt;code&gt;10.96.207.156&lt;/code&gt; æ˜¯ LocalDNS æ–°å»ºçš„ä¸€ä¸ª Service ClusterIPï¼Œè¯¥ Service å’Œ CoreDNS ä¸€æ ·éƒ½æ˜¯å…³è”ä»¥å‰çš„ CoreDNS çš„ Endpoints åˆ—è¡¨ã€‚&lt;/p&gt;
&lt;p&gt;ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç° &lt;code&gt;cluster.local&lt;/code&gt;ã€&lt;code&gt;in-addr.arpa&lt;/code&gt; ä»¥åŠ &lt;code&gt;ip6.arpa&lt;/code&gt; éƒ½ä¼šé€šè¿‡ forward è½¬å‘åˆ° &lt;code&gt;10.96.207.156&lt;/code&gt;ï¼Œä¹Ÿå°±æ˜¯å» CoreDNS è§£æï¼Œå…¶ä»–çš„åˆ™æ˜¯ &lt;strong&gt;&lt;code&gt;forward . /etc/resolv.conf&lt;/code&gt;&lt;/strong&gt; é€šè¿‡ &lt;code&gt;resolv.conf&lt;/code&gt; æ–‡ä»¶å»è§£æï¼Œè¯¥æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;nameserver 169.254.20.10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;search default.svc.cluster.local svc.cluster.local cluster.local&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;options ndots:5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥å½“æˆ‘ä»¬è§£æåŸŸå &lt;code&gt;git.k8s.local&lt;/code&gt; çš„æ—¶å€™éœ€è¦èµ°ä¸€éæœç´¢åŸŸï¼Œè€Œ &lt;code&gt;k8s.local&lt;/code&gt; ä¸åœ¨ &lt;code&gt;cluster.local&lt;/code&gt;ã€&lt;code&gt;in-addr.arpa&lt;/code&gt; ä»¥åŠ &lt;code&gt;ip6.arpa&lt;/code&gt; è¿™äº›åŸŸä¸­ï¼Œæ‰€ä»¥å°±ä¼šèµ°åˆ° &lt;code&gt;/etc/resolv.conf&lt;/code&gt; å»è§£æã€‚è¿™æ ·å°±ä¼šå¯¼è‡´ &lt;code&gt;git.k8s.local&lt;/code&gt; æ— æ³•è¿›è¡Œè§£æã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦æŠŠ &lt;code&gt;forward . /etc/resolv.conf&lt;/code&gt; æ›´æ”¹æˆ &lt;code&gt;forward . 10.96.207.156&lt;/code&gt;ï¼Œè¿™æ ·å°±ä¼šå» CoreDNS è§£æäº†ï¼Œåœ¨ NodeLocalDNS çš„ ConfigMap ä¸­åšå¦‚ä¸‹çš„ä¿®æ”¹å³å¯ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl edit cm node-local-dns -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;......&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.:53 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    errors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cache 30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    reload&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    loop&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; 169.254.20.10 10.96.0.10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    forward . __PILLAR__CLUSTER__DNS__ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            force_tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    prometheus :9253&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;......&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åŒæ ·ä¿®æ”¹å®Œæˆåï¼Œéœ€è¦é‡å»º NodeLocalDNS çš„ Pod æ‰ä¼šç”Ÿæ•ˆã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;__PILLAR__CLUSTER__DNS__&lt;/code&gt; å’Œ &lt;code&gt;__PILLAR__UPSTREAM__SERVERS__&lt;/code&gt; è¿™ä¸¤ä¸ªå‚æ•°åœ¨é•œåƒ 1.15.6 ç‰ˆæœ¬ä»¥ä¸Šä¸­ä¼šè‡ªåŠ¨è¿›è¡Œé…ç½®ï¼Œå¯¹åº”çš„å€¼æ¥æºäº kube-dns çš„ ConfigMap å’Œå®šåˆ¶çš„ Upstream Server åœ°å€ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å‚è€ƒï¼šæ˜é˜³çš„åšå®¢&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;æ¦‚å†µ&quot;&gt;&lt;a href=&quot;#æ¦‚å†µ&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚å†µ&quot;&gt;&lt;/a&gt;æ¦‚å†µ&lt;/h2&gt;&lt;p&gt;ä¹‹å‰åœ¨è§£å†³ CoreDNS çš„5ç§’è¶…æ—¶é—®é¢˜çš„æ—¶å€™ï¼Œé™¤äº†é€šè¿‡ &lt;code&gt;dnsConfig&lt;/code&gt; å»å¼ºåˆ¶ä½¿ç”¨ tcp æ–¹å¼è§£æä¹‹å¤–ï¼Œæˆ‘ä»¬æåˆ°è¿‡ä½¿ç”¨ &lt;code&gt;NodeLocal DNSCache&lt;/code&gt; æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚&lt;code&gt;NodeLocal DNSCache&lt;/code&gt; é€šè¿‡åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª DaemonSet æ¥æé«˜ clusterDNS æ€§èƒ½å’Œå¯é æ€§ã€‚å¤„äº &lt;code&gt;ClusterFirst&lt;/code&gt; çš„ DNS æ¨¡å¼ä¸‹çš„ Pod å¯ä»¥è¿æ¥åˆ° &lt;code&gt;kube-dns&lt;/code&gt; çš„ serviceIP è¿›è¡Œ DNS æŸ¥è¯¢ã€‚é€šè¿‡ &lt;code&gt;kube-proxy&lt;/code&gt; ç»„ä»¶æ·»åŠ çš„ &lt;code&gt;iptables&lt;/code&gt; è§„åˆ™å°†å…¶è½¬æ¢ä¸º &lt;code&gt;CoreDNS&lt;/code&gt; ç«¯ç‚¹ã€‚é€šè¿‡åœ¨æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šè¿è¡Œ DNS ç¼“å­˜ï¼Œ&lt;code&gt;NodeLocal DNSCache&lt;/code&gt; å¯ä»¥ç¼©çŸ­ DNS æŸ¥æ‰¾çš„å»¶è¿Ÿæ—¶é—´ã€ä½¿ DNS æŸ¥æ‰¾æ—¶é—´æ›´åŠ ä¸€è‡´ï¼Œä»¥åŠå‡å°‘å‘é€åˆ° &lt;code&gt;kube-dns&lt;/code&gt; çš„ DNS æŸ¥è¯¢æ¬¡æ•°ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨é›†ç¾¤ä¸­è¿è¡Œ NodeLocal DNSCache æœ‰å¦‚ä¸‹å‡ ä¸ªå¥½å¤„ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœæœ¬åœ°æ²¡æœ‰ CoreDNS å®ä¾‹ï¼Œåˆ™å…·æœ‰æœ€é«˜ DNS QPS çš„ Pod å¯èƒ½å¿…é¡»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œè§£æï¼Œä½¿ç”¨ NodeLocal DNSCache åï¼Œæ‹¥æœ‰æœ¬åœ°ç¼“å­˜å°†æœ‰åŠ©äºæ”¹å–„å»¶è¿Ÿ&lt;/li&gt;
&lt;li&gt;è·³è¿‡ iptables DNAT å’Œè¿æ¥è·Ÿè¸ªå°†æœ‰åŠ©äºå‡å°‘ &lt;code&gt;conntrack&lt;/code&gt; ç«äº‰å¹¶é¿å… UDP DNS æ¡ç›®å¡«æ»¡ &lt;code&gt;conntrack&lt;/code&gt; è¡¨ï¼ˆå¸¸è§çš„5sè¶…æ—¶é—®é¢˜å°±æ˜¯è¿™ä¸ªåŸå› é€ æˆçš„ï¼‰&lt;/li&gt;
&lt;li&gt;ä»æœ¬åœ°ç¼“å­˜ä»£ç†åˆ° kube-dns æœåŠ¡çš„è¿æ¥å¯ä»¥å‡çº§åˆ° TCPï¼ŒTCP conntrack æ¡ç›®å°†åœ¨è¿æ¥å…³é—­æ—¶è¢«åˆ é™¤ï¼Œè€Œ UDP æ¡ç›®å¿…é¡»è¶…æ—¶(&lt;a href=&quot;https://www.kernel.org/doc/Documentation/networking/nf_conntrack-sysctl.txt&quot;&gt;é»˜è®¤ nf_conntrack_udp_timeout æ˜¯ 30 ç§’&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;å°† DNS æŸ¥è¯¢ä» UDP å‡çº§åˆ° TCP å°†å‡å°‘å½’å› äºä¸¢å¼ƒçš„ UDP æ•°æ®åŒ…å’Œ DNS è¶…æ—¶çš„å°¾éƒ¨ç­‰å¾…æ—¶é—´ï¼Œé€šå¸¸é•¿è¾¾ 30 ç§’ï¼ˆ3 æ¬¡é‡è¯•+ 10 ç§’è¶…æ—¶ï¼‰&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="kubrenetes" scheme="http://team.jiunile.com/categories/kubrenetes/"/>
    
      <category term="coredns" scheme="http://team.jiunile.com/categories/kubrenetes/coredns/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/tags/kubernetes/"/>
    
      <category term="coredns" scheme="http://team.jiunile.com/tags/coredns/"/>
    
      <category term="local dnscache" scheme="http://team.jiunile.com/tags/local-dnscache/"/>
    
  </entry>
  
  <entry>
    <title>Go æ€§èƒ½ä¼˜åŒ–å®æˆ˜</title>
    <link href="http://team.jiunile.com//blog/2020/05/go-performance.html"/>
    <id>http://team.jiunile.com//blog/2020/05/go-performance.html</id>
    <published>2020-05-18T10:00:00.000Z</published>
    <updated>2020-09-02T03:28:57.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;é¡¹ç›®èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#é¡¹ç›®èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;é¡¹ç›®èƒŒæ™¯&quot;&gt;&lt;/a&gt;é¡¹ç›®èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;ç½‘å…³æœåŠ¡ä½œä¸ºç»Ÿä¸€æ¥å…¥æœåŠ¡ï¼Œæ˜¯å¤§éƒ¨åˆ†æœåŠ¡çš„ç»Ÿä¸€å…¥å£ã€‚ä¸ºäº†é¿å…æˆåŠŸç“¶é¢ˆï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œå°½å¯èƒ½åœ°ä¼˜åŒ–ã€‚å› æ­¤ï¼Œç‰¹åˆ«æ€»ç»“ä¸€ä¸‹ golang åå°æœåŠ¡æ€§èƒ½ä¼˜åŒ–çš„æ–¹å¼ï¼Œå¹¶å¯¹ç½‘å…³æœåŠ¡è¿›è¡Œä¼˜åŒ–ã€‚&lt;/p&gt;
&lt;p&gt;æŠ€æœ¯èƒŒæ™¯ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åŸºäº tarsgo æ¡†æ¶çš„ http æ¥å…¥æœåŠ¡ï¼Œä¸‹æ¸¸æœåŠ¡ä½¿ç”¨ tarsgo åè®®è¿›è¡Œäº¤äº’&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;æ€§èƒ½æŒ‡æ ‡&quot;&gt;&lt;a href=&quot;#æ€§èƒ½æŒ‡æ ‡&quot; class=&quot;headerlink&quot; title=&quot;æ€§èƒ½æŒ‡æ ‡&quot;&gt;&lt;/a&gt;æ€§èƒ½æŒ‡æ ‡&lt;/h2&gt;&lt;p&gt;ç½‘å…³æœåŠ¡æœ¬èº«æ²¡æœ‰ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œä»…ä½œä¸ºç»Ÿä¸€å…¥å£è¿›è¡Œè¯·æ±‚è½¬å‘ï¼Œå› æ­¤æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸‹åˆ—æŒ‡æ ‡&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ååé‡ï¼šæ¯ç§’é’Ÿå¯ä»¥å¤„ç†çš„è¯·æ±‚æ•°&lt;/li&gt;
&lt;li&gt;å“åº”æ—¶é—´ï¼šä»å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼Œåˆ°æ”¶åˆ°å›åŒ…çš„æ€»è€—æ—¶&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;å®šä½ç“¶é¢ˆ&quot;&gt;&lt;a href=&quot;#å®šä½ç“¶é¢ˆ&quot; class=&quot;headerlink&quot; title=&quot;å®šä½ç“¶é¢ˆ&quot;&gt;&lt;/a&gt;å®šä½ç“¶é¢ˆ&lt;/h2&gt;&lt;p&gt;ä¸€èˆ¬åå°æœåŠ¡çš„ç“¶é¢ˆä¸»è¦ä¸º CPUï¼Œå†…å­˜ï¼ŒIO æ“ä½œä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªã€‚è‹¥è¿™ä¸‰è€…çš„è´Ÿè½½éƒ½ä¸é«˜ï¼Œä½†ç³»ç»Ÿååé‡ä½ï¼ŒåŸºæœ¬å°±æ˜¯ä»£ç é€»è¾‘å‡ºé—®é¢˜äº†ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ä»£ç æ­£å¸¸è¿è¡Œçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦é’ˆå¯¹æŸä¸ªæ–¹é¢çš„é«˜è´Ÿè½½è¿›è¡Œä¼˜åŒ–ï¼Œæ‰èƒ½æé«˜ç³»ç»Ÿçš„æ€§èƒ½ã€‚golang å¯é€šè¿‡ benchmark åŠ  pprof æ¥å®šä½å…·ä½“çš„æ€§èƒ½ç“¶é¢ˆã€‚&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;benchmark-ç®€ä»‹&quot;&gt;&lt;a href=&quot;#benchmark-ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;benchmark ç®€ä»‹&quot;&gt;&lt;/a&gt;benchmark ç®€ä»‹&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt; -v gate_test.go -run=none -bench=. -benchtime=3s -cpuprofile cpu.prof -memprofile mem.prof&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;-run çŸ¥é“å•æ¬¡æµ‹è¯•ï¼Œä¸€èˆ¬ç”¨äºä»£ç é€»è¾‘éªŒè¯&lt;/li&gt;
&lt;li&gt;-bench=. æ‰§è¡Œæ‰€æœ‰ Benchmarkï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç”¨ä¾‹å‡½æ•°åæ¥æŒ‡å®šéƒ¨åˆ†æµ‹è¯•ç”¨ä¾‹&lt;/li&gt;
&lt;li&gt;-benchtime æŒ‡å®šæµ‹è¯•æ‰§è¡Œæ—¶é•¿&lt;/li&gt;
&lt;li&gt;-cpuprofile è¾“å‡º cpu çš„ pprof ä¿¡æ¯æ–‡ä»¶&lt;/li&gt;
&lt;li&gt;-memprofile è¾“å‡º heap çš„ pprof ä¿¡æ¯æ–‡ä»¶ã€‚&lt;/li&gt;
&lt;li&gt;-blockprofile é˜»å¡åˆ†æï¼Œè®°å½• goroutine é˜»å¡ç­‰å¾…åŒæ­¥ï¼ˆåŒ…æ‹¬å®šæ—¶å™¨é€šé“ï¼‰çš„ä½ç½®&lt;/li&gt;
&lt;li&gt;-mutexprofile äº’æ–¥é”åˆ†æï¼ŒæŠ¥å‘Šäº’æ–¥é”çš„ç«äº‰æƒ…å†µ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;benchmark æµ‹è¯•ç”¨ä¾‹å¸¸ç”¨å‡½æ•°&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;b.ReportAllocs() è¾“å‡ºå•æ¬¡å¾ªç¯ä½¿ç”¨çš„å†…å­˜æ•°é‡å’Œå¯¹è±¡ allocs ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;b.RunParallel() ä½¿ç”¨åç¨‹å¹¶å‘æµ‹è¯•&lt;/li&gt;
&lt;li&gt;b.SetBytes(n int64) è®¾ç½®å•æ¬¡å¾ªç¯ä½¿ç”¨çš„å†…å­˜æ•°é‡&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;pprof-ç®€ä»‹&quot;&gt;&lt;a href=&quot;#pprof-ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;pprof ç®€ä»‹&quot;&gt;&lt;/a&gt;pprof ç®€ä»‹&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;ç”Ÿæˆæ–¹å¼&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;runtime/pprof&lt;/code&gt;: æ‰‹åŠ¨è°ƒç”¨å¦‚&lt;code&gt;runtime.StartCPUProfile&lt;/code&gt;æˆ–è€…&lt;code&gt;runtime.StopCPUProfile&lt;/code&gt;ç­‰ API æ¥ç”Ÿæˆå’Œå†™å…¥é‡‡æ ·æ–‡ä»¶ï¼Œçµæ´»æ€§é«˜ã€‚ä¸»è¦ç”¨äºæœ¬åœ°æµ‹è¯•ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;net/http/pprof&lt;/code&gt;: é€šè¿‡ http æœåŠ¡è·å– Profile é‡‡æ ·æ–‡ä»¶ï¼Œç®€å•æ˜“ç”¨ï¼Œé€‚ç”¨äºå¯¹åº”ç”¨ç¨‹åºçš„æ•´ä½“ç›‘æ§ã€‚é€šè¿‡ runtime/pprof å®ç°ã€‚ä¸»è¦ç”¨äºæœåŠ¡å™¨ç«¯æµ‹è¯•ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;go test&lt;/code&gt;: é€šè¿‡ &lt;code&gt;go test -bench . -cpuprofile cpuprofile.out&lt;/code&gt; ç”Ÿæˆé‡‡æ ·æ–‡ä»¶ï¼Œä¸»è¦ç”¨äºæœ¬åœ°åŸºå‡†æµ‹è¯•ã€‚å¯ç”¨äºé‡ç‚¹æµ‹è¯•æŸäº›å‡½æ•°ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹æ–¹å¼&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof [options][binary] ...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;â€“text çº¯æ–‡æœ¬&lt;/li&gt;
&lt;li&gt;â€“web ç”Ÿæˆ svg å¹¶ç”¨æµè§ˆå™¨æ‰“å¼€ï¼ˆå¦‚æœ svg çš„é»˜è®¤æ‰“å¼€æ–¹å¼æ˜¯æµè§ˆå™¨)&lt;/li&gt;
&lt;li&gt;â€“svg åªç”Ÿæˆ svg&lt;/li&gt;
&lt;li&gt;â€“list funcname ç­›é€‰å‡ºæ­£åˆ™åŒ¹é… funcname çš„å‡½æ•°çš„ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;-http=â€:portâ€ ç›´æ¥æœ¬åœ°æµè§ˆå™¨æ‰“å¼€ profile æŸ¥çœ‹ï¼ˆåŒ…æ‹¬ topï¼Œgraphï¼Œç«ç„°å›¾ç­‰ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof -base profile1 profile2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å¯¹æ¯”æŸ¥çœ‹ 2 ä¸ª profileï¼Œä¸€èˆ¬ç”¨äºä»£ç ä¿®æ”¹å‰åå¯¹æ¯”ï¼Œå®šä½å·®å¼‚ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼æŸ¥çœ‹ profile æ—¶ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œå¯¹è¯ä¸­ï¼Œä½¿ç”¨ä¸‹åˆ—å‘½ä»¤ï¼ŒæŸ¥çœ‹ç›¸å…³ä¿¡æ¯&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;flat flat%   sum%        cum   cum%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5.95s 27.56% 27.56%      5.95s 27.56%  runtime.usleep&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4.97s 23.02% 50.58%      5.08s 23.53%  sync.(*RWMutex).RLock&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4.46s 20.66% 71.24%      4.46s 20.66%  sync.(*RWMutex).RUnlock&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2.69s 12.46% 83.70%      2.69s 12.46%  runtime.pthread_cond_&lt;span class=&quot;built_in&quot;&gt;wait&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1.50s  6.95% 90.64%      1.50s  6.95%  runtime.pthread_cond_signal&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;lat&lt;/code&gt;: é‡‡æ ·æ—¶ï¼Œè¯¥å‡½æ•°æ­£åœ¨è¿è¡Œçš„æ¬¡æ•°*é‡‡æ ·é¢‘ç‡(10ms)ï¼Œå³å¾—åˆ°ä¼°ç®—çš„å‡½æ•°è¿è¡Œâ€é‡‡æ ·æ—¶é—´â€ã€‚è¿™é‡Œä¸åŒ…æ‹¬å‡½æ•°ç­‰å¾…å­å‡½æ•°è¿”å›ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;flat%&lt;/code&gt;: flat / æ€»é‡‡æ ·æ—¶é—´å€¼&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sum%&lt;/code&gt;: å‰é¢æ‰€æœ‰è¡Œçš„ flat% çš„ç´¯åŠ å€¼ï¼Œå¦‚ç¬¬ä¸‰è¡Œ sum% = 71.24% = 27.56% + 50.58%&lt;/li&gt;
&lt;li&gt;&lt;code&gt;cum&lt;/code&gt;: é‡‡æ ·æ—¶ï¼Œè¯¥å‡½æ•°å‡ºç°åœ¨è°ƒç”¨å †æ ˆçš„é‡‡æ ·æ—¶é—´ï¼ŒåŒ…æ‹¬å‡½æ•°ç­‰å¾…å­å‡½æ•°è¿”å›ã€‚å› æ­¤ flat &amp;lt;= cum&lt;/li&gt;
&lt;li&gt;&lt;code&gt;cum%&lt;/code&gt;: cum / æ€»é‡‡æ ·æ—¶é—´å€¼&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;topN [-cum]&lt;/code&gt; æŸ¥çœ‹å‰ N ä¸ªæ•°æ®ï¼š&lt;/p&gt;
&lt;p&gt;&lt;code&gt;list ncname&lt;/code&gt; æŸ¥çœ‹æŸä¸ªå‡½æ•°çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥æ˜ç¡®å…·ä½“çš„èµ„æºï¼ˆcpuï¼Œå†…å­˜ç­‰ï¼‰æ˜¯ç”±å“ªä¸€è¡Œè§¦å‘çš„ã€‚&lt;/p&gt;
&lt;h3 id=&quot;pprof-æ¥å…¥&quot;&gt;&lt;a href=&quot;#pprof-æ¥å…¥&quot; class=&quot;headerlink&quot; title=&quot;pprof æ¥å…¥&quot;&gt;&lt;/a&gt;pprof æ¥å…¥&lt;/h3&gt;&lt;p&gt;æœåŠ¡ä¸­ main æ–¹æ³•æ’å…¥ä»£ç &lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cfg := tars.GetServerConfig()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;profMux := &amp;amp;tars.TarsHttpMux&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;profMux.HandleFunc(&lt;span class=&quot;string&quot;&gt;&quot;/debug/pprof/&quot;&lt;/span&gt;, pprof.Index)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;profMux.HandleFunc(&lt;span class=&quot;string&quot;&gt;&quot;/debug/pprof/cmdline&quot;&lt;/span&gt;, pprof.Cmdline)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;profMux.HandleFunc(&lt;span class=&quot;string&quot;&gt;&quot;/debug/pprof/profile&quot;&lt;/span&gt;, pprof.Profile)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;profMux.HandleFunc(&lt;span class=&quot;string&quot;&gt;&quot;/debug/pprof/symbol&quot;&lt;/span&gt;, pprof.Symbol)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;profMux.HandleFunc(&lt;span class=&quot;string&quot;&gt;&quot;/debug/pprof/trace&quot;&lt;/span&gt;, pprof.Trace)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;tars.AddHttpServant(profMux, cfg.App+&lt;span class=&quot;string&quot;&gt;&quot;.&quot;&lt;/span&gt;+cfg.Server+&lt;span class=&quot;string&quot;&gt;&quot;.ProfObj&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;æŸ¥çœ‹æœåŠ¡çš„-pprof&quot;&gt;&lt;a href=&quot;#æŸ¥çœ‹æœåŠ¡çš„-pprof&quot; class=&quot;headerlink&quot; title=&quot;æŸ¥çœ‹æœåŠ¡çš„ pprof&quot;&gt;&lt;/a&gt;æŸ¥çœ‹æœåŠ¡çš„ pprof&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;ä¿è¯å¼€å‘æœºèƒ½ç›´æ¥è®¿é—®åˆ°èŠ‚ç‚¹éƒ¨ç½²çš„ ip å’Œ portã€‚&lt;/li&gt;
&lt;li&gt;æŸ¥çœ‹ profile(http åœ°å€ä¸­çš„ ip,port ä¸º ProfObj çš„ ip å’Œ port)&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä¸‹è½½cpu profile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://ip:port/debug/pprof/profile?seconds=120 &lt;span class=&quot;comment&quot;&gt;# ç­‰å¾…120sï¼Œä¸å¸¦æ­¤å‚æ•°æ—¶ç­‰å¾…30s&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä¸‹è½½heap profile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://ip:port/debug/pprof/heap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä¸‹è½½goroutine profile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://ip:port/debug/pprof/goroutine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä¸‹è½½block profile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://ip:port/debug/pprof/block&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä¸‹è½½mutex profile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://ip:port/debug/pprof/mutex&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä¸‹è½½20ç§’çš„traceè®°å½•ï¼ˆé‡åˆ°æ£˜æ‰‹é—®é¢˜æ—¶ï¼ŒæŸ¥çœ‹traceä¼šæ¯”è¾ƒå®¹æ˜“å®šä½)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; curl http://100.97.1.35:10078/debug/pprof/trace?seconds=20 &amp;gt; trace.out&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; go tool trace trace.out æŸ¥çœ‹&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;ç›´æ¥åœ¨ç»ˆç«¯ä¸­é€šè¿‡ pprof å‘½ä»¤æŸ¥çœ‹&lt;/li&gt;
&lt;li&gt;sz ä¸Šé¢å‘½ä»¤æ‰§è¡Œæ—¶å‡ºç°çš„&lt;code&gt;Saved profile in /root/pprof/pprof.binary.alloc_objects.xxxxxxx.xxxx.pb.gz&lt;/code&gt;åˆ°æœ¬åœ° &lt;/li&gt;
&lt;li&gt;åœ¨æœ¬åœ°ç¯å¢ƒï¼Œæ‰§è¡Œ&lt;code&gt;go tool pprof -http=&amp;quot;:8081&amp;quot; pprof.binary.alloc_objects.xxxxxxx.xxxx.pb.gz&lt;/code&gt; å³å¯ç›´æ¥é€šè¿‡&lt;code&gt;http://localhost:8081&lt;/code&gt;é¡µé¢æŸ¥çœ‹ã€‚åŒ…æ‹¬topNï¼Œç«ç„°å›¾ä¿¡æ¯ç­‰,ä¼šæ›´æ–¹ä¾¿ä¸€ç‚¹ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;GC-Trace&quot;&gt;&lt;a href=&quot;#GC-Trace&quot; class=&quot;headerlink&quot; title=&quot;GC Trace&quot;&gt;&lt;/a&gt;GC Trace&lt;/h3&gt;&lt;p&gt;golang å…·å¤‡ GC åŠŸèƒ½ï¼Œè€Œ GC æ˜¯æœ€å®¹æ˜“è¢«å¿½è§†çš„æ€§èƒ½å½±å“å› ç´ ã€‚å°¤å…¶æ˜¯åœ¨æœ¬åœ°ä½¿ç”¨ benchmark æµ‹è¯•æ—¶ï¼Œç”±äºæ—¶é—´è¾ƒçŸ­ï¼Œå ç”¨å†…å­˜è¾ƒå°‘ã€‚å¾€å¾€ä¸ä¼šè§¦å‘ GCã€‚è€Œä¸€æ—¦çº¿ä¸Šå‡ºç° GC é—®é¢˜ï¼Œåˆä¸å¤ªå¥½å®šä½ã€‚ç›®å‰å¸¸ç”¨çš„å®šä½æ–¹å¼æœ‰ä¸¤ç§ï¼š&lt;/p&gt;
&lt;h4 id=&quot;æœ¬åœ°-gctrace&quot;&gt;&lt;a href=&quot;#æœ¬åœ°-gctrace&quot; class=&quot;headerlink&quot; title=&quot;æœ¬åœ° gctrace&quot;&gt;&lt;/a&gt;æœ¬åœ° gctrace&lt;/h4&gt;&lt;p&gt;åœ¨æ‰§è¡Œç¨‹åºå‰åŠ  &lt;code&gt;GODEBUG=gctrace=1&lt;/code&gt;ï¼Œæ¯æ¬¡ gc æ—¶ä¼šè¾“å‡ºä¸€è¡Œå¦‚ä¸‹å†…å®¹&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;gc 1 @0.001s 11%: 0.007+1.5+0.004 ms clock, 0.089+1.5/2.8/0.27+0.054 ms cpu, 4-&amp;gt;4-&amp;gt;3 MB, 5 MB goal, 12 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scvg: inuse: 4, idle: 57, sys: 62, released: 57, consumed: 4 (MB)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä¹Ÿé€šè¿‡æ—¥å¿—è½¬ä¸ºå›¾å½¢åŒ–ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;GODEBUG=gctrace=1 godoc -index -http=:6060 2&amp;gt; stderr.log&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat stderr.log | gcvis&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;inuseï¼šä½¿ç”¨äº†å¤šå°‘ M å†…å­˜&lt;/li&gt;
&lt;li&gt;idleï¼šå‰©ä¸‹è¦æ¸…é™¤çš„å†…å­˜&lt;/li&gt;
&lt;li&gt;sysï¼šç³»ç»Ÿæ˜ å°„çš„å†…å­˜&lt;/li&gt;
&lt;li&gt;releasedï¼šé‡Šæ”¾çš„ç³»ç»Ÿå†…å­˜&lt;/li&gt;
&lt;li&gt;consumedï¼šç”³è¯·çš„ç³»ç»Ÿå†…å­˜&lt;/li&gt;
&lt;li&gt;gc 1 è¡¨ç¤ºç¬¬ 1 æ¬¡ gc&lt;/li&gt;
&lt;li&gt;@0.001s è¡¨ç¤ºç¨‹åºæ‰§è¡Œçš„æ€»æ—¶é—´&lt;/li&gt;
&lt;li&gt;11% è¡¨ç¤ºåƒåœ¾å›æ”¶æ—¶é—´å ç”¨æ€»çš„è¿è¡Œæ—¶é—´ç™¾åˆ†æ¯”&lt;/li&gt;
&lt;li&gt;0.007+1.5+0.004 ms clock è¡¨ç¤ºå·¥ä½œçº¿ç¨‹å®Œæˆ GC çš„ stop-the-world,sweeping,marking å’Œ waiting çš„æ—¶é—´&lt;/li&gt;
&lt;li&gt;0.089+1.5/2.8/0.27+0.054 ms cpu åƒåœ¾å›æ”¶å ç”¨ cpu æ—¶é—´&lt;/li&gt;
&lt;li&gt;4-&amp;gt;4-&amp;gt;3 MB è¡¨ç¤ºå †çš„å¤§å°ï¼Œgc åå †çš„å¤§å°ï¼Œå­˜æ´»å †çš„å¤§å°&lt;/li&gt;
&lt;li&gt;5 MB goal æ•´ä½“å †çš„å¤§å°&lt;/li&gt;
&lt;li&gt;12 P ä½¿ç”¨çš„å¤„ç†å™¨æ•°é‡&lt;/li&gt;
&lt;li&gt;scvg: inuse: 4, idle: 57, sys: 62, released: 57, consumed: 4 (MB) è¡¨ç¤ºç³»ç»Ÿå†…å­˜å›æ”¶ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;é‡‡ç”¨å›¾å½¢åŒ–çš„æ–¹å¼æŸ¥çœ‹ï¼š&lt;a href=&quot;https://github.com/davecheney/gcvis&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/davecheney/gcvis&lt;/a&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;GODEBUG=gctrace=1 go &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt; -v *.go -bench=. -run=none -benchtime 3m |&amp;amp; gcvis&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;çº¿ä¸Š-trace&quot;&gt;&lt;a href=&quot;#çº¿ä¸Š-trace&quot; class=&quot;headerlink&quot; title=&quot;çº¿ä¸Š trace&quot;&gt;&lt;/a&gt;çº¿ä¸Š trace&lt;/h4&gt;&lt;p&gt;åœ¨çº¿ä¸Šä¸šåŠ¡ä¸­æ·»åŠ &lt;strong&gt;net/http/pprof&lt;/strong&gt;åï¼Œå¯é€šè¿‡ä¸‹åˆ—å‘½ä»¤é‡‡é›† 20 ç§’çš„ trace ä¿¡æ¯&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;curl http://ip:port/debug/pprof/trace?seconds=20 &amp;gt; trace.out&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å†é€šè¿‡&lt;code&gt;go tool trace trace.out&lt;/code&gt; å³å¯åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­æŸ¥çœ‹ trace ä¿¡æ¯ã€‚&lt;br&gt;&lt;img src=&quot;/images/go/performance_1.png&quot; alt=&quot;go performance analysis&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;View traceï¼šæŸ¥çœ‹è·Ÿè¸ª&lt;/li&gt;
&lt;li&gt;Goroutine analysisï¼šGoroutine åˆ†æ&lt;/li&gt;
&lt;li&gt;Network blocking profileï¼šç½‘ç»œé˜»å¡æ¦‚å†µ&lt;/li&gt;
&lt;li&gt;Synchronization blocking profileï¼šåŒæ­¥é˜»å¡æ¦‚å†µ&lt;/li&gt;
&lt;li&gt;Syscall blocking profileï¼šç³»ç»Ÿè°ƒç”¨é˜»å¡æ¦‚å†µ&lt;/li&gt;
&lt;li&gt;Scheduler latency profileï¼šè°ƒåº¦å»¶è¿Ÿæ¦‚å†µ&lt;/li&gt;
&lt;li&gt;User defined tasksï¼šç”¨æˆ·è‡ªå®šä¹‰ä»»åŠ¡&lt;/li&gt;
&lt;li&gt;User defined regionsï¼šç”¨æˆ·è‡ªå®šä¹‰åŒºåŸŸ&lt;/li&gt;
&lt;li&gt;Minimum mutator utilizationï¼šæœ€ä½ Mutator åˆ©ç”¨ç‡&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;GC ç›¸å…³çš„ä¿¡æ¯å¯ä»¥åœ¨ View trace ä¸­çœ‹åˆ°&lt;br&gt;&lt;img src=&quot;/images/go/performance_2.png&quot; alt=&quot;go performance analysis&quot;&gt;&lt;/p&gt;
&lt;p&gt;å¯é€šè¿‡ç‚¹å‡» heap çš„è‰²å—åŒºåŸŸï¼ŒæŸ¥çœ‹ heap ä¿¡æ¯ã€‚&lt;br&gt;&lt;img src=&quot;/images/go/performance_3.png&quot; alt=&quot;go performance analysis&quot;&gt;&lt;/p&gt;
&lt;p&gt;ç‚¹å‡» GC å¯¹åº”è¡Œçš„è“è‰²è‰²å—ï¼ŒæŸ¥çœ‹ GC è€—æ—¶åŠç›¸å…³å›æ”¶ä¿¡æ¯ã€‚&lt;br&gt;&lt;img src=&quot;/images/go/performance_4.png&quot; alt=&quot;go performance analysis&quot;&gt;&lt;/p&gt;
&lt;p&gt;é€šè¿‡è¿™ä¸¤ä¸ªä¿¡æ¯å°±å¯ä»¥ç¡®è®¤æ˜¯å¦å­˜åœ¨ GC é—®é¢˜ï¼Œä»¥åŠé€ æˆé«˜ GC çš„å¯èƒ½åŸå› ã€‚&lt;/p&gt;
&lt;h4 id=&quot;ä½¿ç”¨é—®é¢˜&quot;&gt;&lt;a href=&quot;#ä½¿ç”¨é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;ä½¿ç”¨é—®é¢˜&quot;&gt;&lt;/a&gt;ä½¿ç”¨é—®é¢˜&lt;/h4&gt;&lt;p&gt;trace çš„å±•ç¤ºä»…æ”¯æŒ chrome æµè§ˆå™¨ã€‚ä½†æ˜¯ç›®å‰å¸¸ç”¨çš„ chrome æµè§ˆå™¨å±è”½äº† go tool trace ä½¿ç”¨çš„ HTML import åŠŸèƒ½ã€‚å³æ‰“å¼€â€œview traceâ€æ—¶ï¼Œä¼šå‡ºç°ä¸€ç‰‡ç©ºç™½ã€‚å¹¶å¯ä»¥åœ¨ console ä¸­çœ‹åˆ°è­¦å‘Šä¿¡æ¯ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;HTML Imports is deprecated and has now been removed as of M80. See https://www.chromestatus.com/features/5144752345317376 and https://developers.google.com/web/updates/2019/07/web-components-time-to-upgrade &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; more details.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;è§£å†³åŠæ³•&quot;&gt;&lt;a href=&quot;#è§£å†³åŠæ³•&quot; class=&quot;headerlink&quot; title=&quot;è§£å†³åŠæ³•&quot;&gt;&lt;/a&gt;è§£å†³åŠæ³•&lt;/h4&gt;&lt;p&gt;&lt;strong&gt;ç”³è¯· token&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://developers.chrome.com/origintrials/#/register_trial/2431943798780067841&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://developers.chrome.com/origintrials/#/register_trial/2431943798780067841&lt;/a&gt; ç„¶åç™»å½•&lt;/li&gt;
&lt;li&gt;web origin å¤„å¡«å†™ &lt;a href=&quot;http://localhost:8001&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://localhost:8001&lt;/a&gt; ç«¯å£åªèƒ½æ˜¯ 8000 - 8003ï¼Œæ”¯æŒ http å’Œ httpsã€‚ï¼ˆä¹Ÿå¯ä»¥å¡«å†™ 127.0.0.1:8001,ä¾èµ–äºä½ æµè§ˆå™¨ä¸­æ˜¾ç¤ºçš„åœ°å€ï¼Œå¦åˆ™å¯¹ä¸ä¸Šçš„è¯ï¼Œè¿˜è¦æ‰‹åŠ¨æ”¹ä¸€ä¸‹)&lt;br&gt;&lt;img src=&quot;/images/go/performance_5.png&quot; alt=&quot;go performance analysis&quot;&gt;&lt;/li&gt;
&lt;li&gt;ç‚¹å‡»æ³¨å†Œåå³å¯çœ‹åˆ° token&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ä¿®æ”¹ trace.go&lt;/strong&gt;&lt;br&gt;ç¼–è¾‘&lt;code&gt;${GOROOT}/src/cmd/trace/trace.go&lt;/code&gt; æ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶ä¸­æ‰¾åˆ° templTrace ç„¶ååœ¨  æ ‡ç­¾çš„ä¸‹ä¸€è¡Œæ·»åŠ &lt;code&gt;&amp;lt;meta http-equiv=&amp;quot;origin-trial&amp;quot; content=&amp;quot;ä½ å¤åˆ¶çš„token&amp;quot;&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;é‡æ–°ç¼–è¯‘ go&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;${GOROOT}/src ç›®å½•ï¼Œæ‰§è¡Œ ./all.bash&lt;/li&gt;
&lt;li&gt;è‹¥æç¤ºï¼š&lt;code&gt;ERROR: Cannot find go1.4\bin\go Set GOROOT_BOOTSTRAP to a working Go tree &amp;gt;= Go 1.4&lt;/code&gt; åˆ™éœ€è¦å…ˆå®‰è£…ä¸€ä¸ª go1.4 çš„ç‰ˆæœ¬ï¼Œå†é€šè¿‡å®ƒæ¥ç¼–è¯‘ goã€‚ï¼ˆä¸‹è½½é“¾æ¥&lt;a href=&quot;https://dl.google.com/go/go1.4-bootstrap-20171003.tar.gzï¼‰&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://dl.google.com/go/go1.4-bootstrap-20171003.tar.gzï¼‰&lt;/a&gt; åœ¨ &lt;code&gt;go1.4/src&lt;/code&gt; ä¸‹æ‰§è¡Œ &lt;code&gt;./make.bash&lt;/code&gt; . æŒ‡å®š GOROOT_BOOTSTRAP ä¸º go1.4 çš„æ ¹ç›®å½•ã€‚ç„¶åå°±å¯ä»¥é‡æ–°ç¼–è¯‘ go&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹ trace&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go tool trace -http=localhost:8001 trace.out&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è‹¥æ‰“å¼€ view trace è¿˜æ˜¯ç©ºç™½,åˆ™æ£€æŸ¥ä¸€ä¸‹æµè§ˆå™¨åœ°å€æ ä¸­çš„åœ°å€ï¼Œæ˜¯å¦ä¸æ³¨å†Œæ—¶çš„ä¸€æ ·ã€‚å³æ³¨å†Œç”¨çš„ localhost æˆ– 127.0.0.1 åˆ™åœ°å€æ ä¸­ä¹Ÿè¦ä¸€æ ·ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å¸¸è§æ€§èƒ½ç“¶é¢ˆ&quot;&gt;&lt;a href=&quot;#å¸¸è§æ€§èƒ½ç“¶é¢ˆ&quot; class=&quot;headerlink&quot; title=&quot;å¸¸è§æ€§èƒ½ç“¶é¢ˆ&quot;&gt;&lt;/a&gt;å¸¸è§æ€§èƒ½ç“¶é¢ˆ&lt;/h2&gt;&lt;h3 id=&quot;ä¸šåŠ¡é€»è¾‘&quot;&gt;&lt;a href=&quot;#ä¸šåŠ¡é€»è¾‘&quot; class=&quot;headerlink&quot; title=&quot;ä¸šåŠ¡é€»è¾‘&quot;&gt;&lt;/a&gt;ä¸šåŠ¡é€»è¾‘&lt;/h3&gt;&lt;p&gt;å‡ºç°æ— æ•ˆç”šè‡³é™ä½æ€§èƒ½çš„é€»è¾‘ã€‚å¸¸è§çš„æœ‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é€»è¾‘é‡å¤ï¼šç›¸åŒçš„æ“ä½œåœ¨ä¸åŒçš„ä½ç½®åšäº†å¤šæ¬¡æˆ–å¾ªç¯è·³å‡ºçš„æ¡ä»¶è®¾ç½®ä¸å½“ã€‚&lt;/li&gt;
&lt;li&gt;èµ„æºæœªå¤ç”¨ï¼šå†…å­˜é¢‘ç¹ç”³è¯·å’Œé‡Šæ”¾ï¼Œæ•°æ®åº“é“¾æ¥é¢‘ç¹å»ºç«‹å’Œé”€æ¯ç­‰ã€‚&lt;/li&gt;
&lt;li&gt;æ— æ•ˆä»£ç ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;å­˜å‚¨&quot;&gt;&lt;a href=&quot;#å­˜å‚¨&quot; class=&quot;headerlink&quot; title=&quot;å­˜å‚¨&quot;&gt;&lt;/a&gt;å­˜å‚¨&lt;/h3&gt;&lt;p&gt;æœªé€‰æ‹©æ°å½“çš„å­˜å‚¨æ–¹å¼ï¼Œå¸¸è§çš„æœ‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸´æ—¶æ•°æ®å­˜æ”¾åˆ°æ•°æ®åº“ä¸­ï¼Œå¯¼è‡´é¢‘ç¹è¯»å†™æ•°æ®åº“ã€‚&lt;/li&gt;
&lt;li&gt;å°†å¤æ‚çš„æ ‘çŠ¶ç»“æ„çš„æ•°æ®ç”¨ SQL æ•°æ®åº“å­˜å‚¨ï¼Œå‡ºç°å¤§é‡å†—ä½™åˆ—ï¼Œå¹¶ä¸”åœ¨è¯»å†™æ—¶è¦è¿›è¡Œæ‹†è§£å’Œæ‹¼æ¥ã€‚&lt;/li&gt;
&lt;li&gt;æ•°æ®åº“è¡¨è®¾è®¡ä¸å½“ï¼Œæ— æ³•æœ‰æ•ˆåˆ©ç”¨ç´¢å¼•æŸ¥è¯¢ï¼Œå¯¼è‡´æŸ¥è¯¢æ“ä½œè€—æ—¶é«˜ç”šè‡³å‡ºç°å¤§é‡æ…¢æŸ¥è¯¢ã€‚&lt;/li&gt;
&lt;li&gt;çƒ­ç‚¹æ•°æ®æœªä½¿ç”¨ç¼“å­˜ï¼Œå¯¼è‡´æ•°æ®åº“è´Ÿè½½è¿‡é«˜ï¼Œå“åº”é€Ÿåº¦ä¸‹é™ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;å¹¶å‘å¤„ç†&quot;&gt;&lt;a href=&quot;#å¹¶å‘å¤„ç†&quot; class=&quot;headerlink&quot; title=&quot;å¹¶å‘å¤„ç†&quot;&gt;&lt;/a&gt;å¹¶å‘å¤„ç†&lt;/h3&gt;&lt;p&gt;å¹¶å‘æ“ä½œçš„é—®é¢˜ä¸»è¦å‡ºç°åœ¨èµ„æºç«äº‰ä¸Šï¼Œå¸¸è§çš„æœ‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ­»é”/æ´»é”å¯¼è‡´å¤§é‡é˜»å¡ï¼Œæ€§èƒ½ä¸¥é‡ä¸‹é™ã€‚&lt;/li&gt;
&lt;li&gt;èµ„æºç«äº‰æ¿€çƒˆï¼šå¤§é‡çš„çº¿ç¨‹æˆ–åç¨‹æŠ¢å¤ºä¸€ä¸ªé”ã€‚&lt;/li&gt;
&lt;li&gt;ä¸´ç•ŒåŒºè¿‡å¤§ï¼šå°†ä¸å¿…è¦çš„æ“ä½œä¹Ÿæ”¾å…¥ä¸´ç•ŒåŒºï¼Œå¯¼è‡´é”çš„é‡Šæ”¾é€Ÿåº¦è¿‡æ…¢ï¼Œå¼•èµ·å…¶ä»–çº¿ç¨‹æˆ–åç¨‹é˜»å¡ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;golang-éƒ¨åˆ†ç»†èŠ‚ç®€ä»‹&quot;&gt;&lt;a href=&quot;#golang-éƒ¨åˆ†ç»†èŠ‚ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;golang éƒ¨åˆ†ç»†èŠ‚ç®€ä»‹&quot;&gt;&lt;/a&gt;golang éƒ¨åˆ†ç»†èŠ‚ç®€ä»‹&lt;/h2&gt;&lt;p&gt;åœ¨ä¼˜åŒ–ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ golang çš„å®ç°ç»†èŠ‚æœ‰ä¸€ä¸ªç®€å•çš„äº†è§£ï¼Œæ‰èƒ½æ˜ç™½å“ªäº›åœ°æ–¹æœ‰é—®é¢˜ï¼Œå“ªäº›åœ°æ–¹å¯ä»¥ä¼˜åŒ–ï¼Œä»¥åŠæ€ä¹ˆä¼˜åŒ–ã€‚ä»¥ä¸‹å†…å®¹çš„è¯¦ç»†è®²è§£å»ºè®®æŸ¥é˜…ç½‘ä¸Šä¼˜ç§€çš„ blogã€‚å¯¹è¯­è¨€çš„åº•å±‚å®ç°æœºåˆ¶æœ€å¥½æœ‰ä¸ªåŸºæœ¬çš„äº†è§£ï¼Œå¦åˆ™æœ‰æ—¶å€™æ‰åˆ°å‘é‡Œéƒ½ä¸çŸ¥é“ä¸ºå•¥ã€‚&lt;/p&gt;
&lt;h3 id=&quot;åç¨‹è°ƒåº¦&quot;&gt;&lt;a href=&quot;#åç¨‹è°ƒåº¦&quot; class=&quot;headerlink&quot; title=&quot;åç¨‹è°ƒåº¦&quot;&gt;&lt;/a&gt;åç¨‹è°ƒåº¦&lt;/h3&gt;&lt;p&gt;Golang è°ƒåº¦æ˜¯éæŠ¢å å¼å¤šä»»åŠ¡å¤„ç†ï¼Œç”±åç¨‹ä¸»åŠ¨äº¤å‡ºæ§åˆ¶æƒã€‚é‡åˆ°å¦‚ä¸‹æ¡ä»¶æ—¶ï¼Œæ‰æœ‰å¯èƒ½äº¤å‡ºæ§åˆ¶æƒ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I/O,select&lt;/li&gt;
&lt;li&gt;channel&lt;/li&gt;
&lt;li&gt;ç­‰å¾…é”&lt;/li&gt;
&lt;li&gt;å‡½æ•°è°ƒç”¨ï¼ˆæ˜¯ä¸€ä¸ªåˆ‡æ¢çš„æœºä¼šï¼Œæ˜¯å¦ä¼šåˆ‡æ¢ç”±è°ƒåº¦å™¨å†³å®šï¼‰&lt;/li&gt;
&lt;li&gt;runtime.Gosched()&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å› æ­¤ï¼Œè‹¥å­˜åœ¨è¾ƒé•¿æ—¶é—´çš„ for å¾ªç¯å¤„ç†ï¼Œå¹¶ä¸”å¾ªç¯å†…æ²¡æœ‰ä¸Šè¿°é€»è¾‘æ—¶ï¼Œä¼šé˜»å¡ä½å…¶ä»–çš„åç¨‹è°ƒåº¦ã€‚åœ¨å®é™…ç¼–ç ä¸­ä¸€å®šè¦æ³¨æ„ã€‚&lt;/p&gt;
&lt;h3 id=&quot;å†…å­˜ç®¡ç†&quot;&gt;&lt;a href=&quot;#å†…å­˜ç®¡ç†&quot; class=&quot;headerlink&quot; title=&quot;å†…å­˜ç®¡ç†&quot;&gt;&lt;/a&gt;å†…å­˜ç®¡ç†&lt;/h3&gt;&lt;p&gt;Go ä¸ºæ¯ä¸ªé€»è¾‘å¤„ç†å™¨ï¼ˆPï¼‰æä¾›äº†ä¸€ä¸ªç§°ä¸ºmcacheçš„æœ¬åœ°å†…å­˜çº¿ç¨‹ç¼“å­˜ã€‚æ¯ä¸ª mcache ä¸­æŒæœ‰ 67 ä¸ªçº§åˆ«çš„ mspanã€‚æ¯ä¸ª msapn åˆåŒ…å«ä¸¤ç§ï¼šscanï¼ˆåŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ï¼‰å’Œ noscanï¼ˆä¸åŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ï¼‰ã€‚&lt;strong&gt;åœ¨è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼ŒGC æ— éœ€éå† noscan å¯¹è±¡&lt;/strong&gt;ã€‚&lt;br&gt;&lt;img src=&quot;/images/go/performance_6.png&quot; alt=&quot;go performance analysis&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;GC-å¤„ç†&quot;&gt;&lt;a href=&quot;#GC-å¤„ç†&quot; class=&quot;headerlink&quot; title=&quot;GC å¤„ç†&quot;&gt;&lt;/a&gt;GC å¤„ç†&lt;/h3&gt;&lt;p&gt;GC çš„å·¥ä½œå°±æ˜¯ç¡®å®šå“ªäº›å†…å­˜å¯ä»¥é‡Šæ”¾ï¼Œå®ƒæ˜¯é€šè¿‡æ‰«æå†…å­˜æŸ¥æ‰¾å†…å­˜åˆ†é…çš„æŒ‡é’ˆæ¥å®Œæˆè¿™ä¸ªå·¥ä½œçš„ã€‚GC è§¦å‘æ—¶æœºï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åˆ°è¾¾å †é˜ˆå€¼ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå°†åœ¨å †å¤§å°åŠ å€æ—¶è¿è¡Œï¼Œå¯é€šè¿‡ GOGC æ¥è®¾å®šæ›´é«˜é˜ˆå€¼ï¼ˆä¸å»ºè®®å˜æ›´æ­¤é…ç½®ï¼‰&lt;/li&gt;
&lt;li&gt;åˆ°è¾¾æ—¶é—´é˜ˆå€¼ï¼šæ¯ä¸¤åˆ†é’Ÿä¼šå¼ºåˆ¶å¯åŠ¨ä¸€æ¬¡ GC å¾ªç¯&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸ºå•¥è¦æ³¨æ„ GCï¼Œæ˜¯å› ä¸º GC æ—¶å‡ºç° 2 æ¬¡ Stop the worldï¼Œå³åœæ­¢æ‰€æœ‰åç¨‹ï¼Œè¿›è¡Œæ‰«ææ“ä½œã€‚è‹¥æ˜¯ GC è€—æ—¶é«˜ï¼Œåˆ™ä¼šä¸¥é‡å½±å“æœåŠ¡å™¨æ€§èƒ½ã€‚&lt;br&gt;&lt;img src=&quot;/images/go/performance_7.png&quot; alt=&quot;go performance analysis&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;å˜é‡é€ƒé€¸&quot;&gt;&lt;a href=&quot;#å˜é‡é€ƒé€¸&quot; class=&quot;headerlink&quot; title=&quot;å˜é‡é€ƒé€¸&quot;&gt;&lt;/a&gt;å˜é‡é€ƒé€¸&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;æ³¨æ„ï¼Œgolang ä¸­çš„æ ˆæ˜¯è·Ÿå‡½æ•°ç»‘å®šçš„ï¼Œå‡½æ•°ç»“æŸæ—¶æ ˆè¢«å›æ”¶ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;å˜é‡å†…å­˜å›æ”¶ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœåˆ†é…åœ¨æ ˆä¸­ï¼Œåˆ™å‡½æ•°æ‰§è¡Œç»“æŸå¯è‡ªåŠ¨å°†å†…å­˜å›æ”¶ï¼›&lt;/li&gt;
&lt;li&gt;å¦‚æœåˆ†é…åœ¨å †ä¸­ï¼Œåˆ™å‡½æ•°æ‰§è¡Œç»“æŸå¯äº¤ç»™ GCï¼ˆåƒåœ¾å›æ”¶ï¼‰å¤„ç†ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è€Œå˜é‡é€ƒé€¸å°±æ„å‘³ç€å¢åŠ äº†å †ä¸­çš„å¯¹è±¡ä¸ªæ•°ï¼Œå½±å“ GC è€—æ—¶ã€‚ä¸€èˆ¬è¦å°½é‡é¿å…é€ƒé€¸ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;é€ƒé€¸åˆ†æä¸å˜æ€§ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½å­˜åœ¨äºå †ä¸­ï¼›&lt;/li&gt;
&lt;li&gt;æŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½åœ¨æ ˆå¯¹è±¡å›æ”¶åå­˜æ´»ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨é€ƒé€¸åˆ†æè¿‡ç¨‹ä¸­ï¼Œå‡¡æ˜¯å‘ç°å‡ºç°è¿åä¸Šè¿°çº¦å®šçš„å˜é‡ï¼Œå°±å°†å…¶ç§»åˆ°å †ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;é€ƒé€¸å¸¸è§çš„æƒ…å†µï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŒ‡é’ˆé€ƒé€¸ï¼šè¿”å›å±€éƒ¨å˜é‡çš„åœ°å€ï¼ˆä¸å˜æ€§ 2ï¼‰&lt;/li&gt;
&lt;li&gt;æ ˆç©ºé—´ä¸è¶³&lt;/li&gt;
&lt;li&gt;åŠ¨æ€ç±»å‹é€ƒé€¸ï¼šå¦‚ fmt.Sprintf,json.Marshel ç­‰æ¥å—å˜é‡ä¸ºâ€¦interface{}å‡½æ•°çš„è°ƒç”¨ï¼Œä¼šå¯¼è‡´ä¼ å…¥çš„å˜é‡é€ƒé€¸ã€‚&lt;/li&gt;
&lt;li&gt;é—­åŒ…å¼•ç”¨&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;åŒ…å«æŒ‡é’ˆç±»å‹çš„åº•å±‚ç»“æ„&quot;&gt;&lt;a href=&quot;#åŒ…å«æŒ‡é’ˆç±»å‹çš„åº•å±‚ç»“æ„&quot; class=&quot;headerlink&quot; title=&quot;åŒ…å«æŒ‡é’ˆç±»å‹çš„åº•å±‚ç»“æ„&quot;&gt;&lt;/a&gt;åŒ…å«æŒ‡é’ˆç±»å‹çš„åº•å±‚ç»“æ„&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;string&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; StringHeader &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Data &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Len  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;slice&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; SliceHeader &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Data &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Len  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Cap  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;map&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; hmap &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; count     &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; flags     &lt;span class=&quot;keyword&quot;&gt;uint8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; B         &lt;span class=&quot;keyword&quot;&gt;uint8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; noverflow &lt;span class=&quot;keyword&quot;&gt;uint16&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; hash0     &lt;span class=&quot;keyword&quot;&gt;uint32&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; buckets    unsafe.Pointer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; oldbuckets unsafe.Pointer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; nevacuate  &lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; extra *mapextra&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿™äº›æ˜¯å¸¸è§ä¼šåŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ã€‚å°¤å…¶æ˜¯ stringï¼Œåœ¨åå°åº”ç”¨ä¸­å¤§é‡å‡ºç°ã€‚å¹¶ç»å¸¸ä¼šä½œä¸º map çš„ key æˆ– valueã€‚è‹¥æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå°±ä¼šå¼•å‘ GC è€—æ—¶ä¸Šå‡ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ° string å’Œ slice éå¸¸ç›¸ä¼¼ï¼Œä»æŸç§æ„ä¹‰ä¸Šè¯´å®ƒä»¬ä¹‹é—´æ˜¯å¯ä»¥ç›´æ¥äº’ç›¸è½¬æ¢çš„ã€‚è¿™å°±å¯ä»¥é¿å… string å’Œ[]byte ä¹‹é—´ç±»å‹è½¬æ¢æ—¶ï¼Œè¿›è¡Œå†…å­˜æ‹·è´&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç±»å‹è½¬æ¢ä¼˜åŒ–&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(b []&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;string&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; *(*&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;)(unsafe.Pointer(&amp;amp;b))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Str2Bytes&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(s &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;)&lt;/span&gt; []&lt;span class=&quot;title&quot;&gt;byte&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; x := (*[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;)(unsafe.Pointer(&amp;amp;s))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; h := [&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;uintptr&lt;/span&gt;&amp;#123;x[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;], x[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;], x[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; *(*[]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;)(unsafe.Pointer(&amp;amp;h))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;æ€§èƒ½æµ‹è¯•æ–¹å¼&quot;&gt;&lt;a href=&quot;#æ€§èƒ½æµ‹è¯•æ–¹å¼&quot; class=&quot;headerlink&quot; title=&quot;æ€§èƒ½æµ‹è¯•æ–¹å¼&quot;&gt;&lt;/a&gt;æ€§èƒ½æµ‹è¯•æ–¹å¼&lt;/h2&gt;&lt;h3 id=&quot;æœ¬åœ°æµ‹è¯•&quot;&gt;&lt;a href=&quot;#æœ¬åœ°æµ‹è¯•&quot; class=&quot;headerlink&quot; title=&quot;æœ¬åœ°æµ‹è¯•&quot;&gt;&lt;/a&gt;æœ¬åœ°æµ‹è¯•&lt;/h3&gt;&lt;p&gt;å°†æœåŠ¡å¤„ç†çš„æ ¸å¿ƒé€»è¾‘ï¼Œä½¿ç”¨ go test çš„ benchmark åŠ  pprof æ¥æµ‹è¯•ã€‚å»ºè®®ä¸Šçº¿å‰ï¼Œå°±å¯¹æ•´ä¸ªä¸šåŠ¡é€»è¾‘çš„æ€§èƒ½è¿›è¡Œæµ‹è¯•ï¼Œæå‰ä¼˜åŒ–ç“¶é¢ˆã€‚&lt;/p&gt;
&lt;h3 id=&quot;çº¿ä¸Šæµ‹è¯•&quot;&gt;&lt;a href=&quot;#çº¿ä¸Šæµ‹è¯•&quot; class=&quot;headerlink&quot; title=&quot;çº¿ä¸Šæµ‹è¯•&quot;&gt;&lt;/a&gt;çº¿ä¸Šæµ‹è¯•&lt;/h3&gt;&lt;p&gt;ä¸€èˆ¬ http æœåŠ¡å¯ä»¥é€šè¿‡å¸¸è§çš„æµ‹è¯•å·¥å…·è¿›è¡Œå‹æµ‹ï¼Œå¦‚ wrkï¼Œlocust ç­‰ã€‚taf æœåŠ¡åˆ™éœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–å†™ä¸€äº›æµ‹è¯•è„šæœ¬ã€‚åŒæ—¶ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œå‹æµ‹çš„ç›®çš„æ˜¯å®šä½å‡ºæœåŠ¡çš„æœ€ä½³æ€§èƒ½ï¼Œè€Œä¸æ˜¯ç›²ç›®çš„é«˜å¹¶å‘è¯·æ±‚æµ‹è¯•ã€‚å› æ­¤ï¼Œä¸€èˆ¬éœ€è¦é€æ­¥æå‡å¹¶å‘è¯·æ±‚æ•°é‡ï¼Œæ¥å®šä½å‡ºæœåŠ¡çš„æœ€ä½³æ€§èƒ½ç‚¹ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æ³¨æ„ï¼šç”±äº taf å¹³å°å…·å¤‡æ‰©å®¹åŠŸèƒ½ï¼Œå› æ­¤ä¸ºäº†æ›´å‡†ç¡®çš„æµ‹è¯•ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨æµ‹è¯•å‰å…³é—­è¦æµ‹è¯•èŠ‚ç‚¹çš„è‡ªåŠ¨æ‰©å®¹ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;å®é™…é¡¹ç›®ä¼˜åŒ–&quot;&gt;&lt;a href=&quot;#å®é™…é¡¹ç›®ä¼˜åŒ–&quot; class=&quot;headerlink&quot; title=&quot;å®é™…é¡¹ç›®ä¼˜åŒ–&quot;&gt;&lt;/a&gt;å®é™…é¡¹ç›®ä¼˜åŒ–&lt;/h2&gt;&lt;p&gt;ä¸ºäº†é¿å…å½±å“åç«¯æœåŠ¡ï¼Œä¹Ÿä¸ºäº†é¿å…åç«¯æœåŠ¡å½±å“ç½‘å…³è‡ªèº«ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å‹æµ‹å‰ï¼Œå°†å¯¹åç«¯æœåŠ¡çš„è°ƒç”¨å±è”½ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æµ‹è¯•å‡†å¤‡ï¼šå±è”½è¿œç¨‹è°ƒç”¨ï¼šä¸‹æ¸¸æœåŠ¡è°ƒç”¨ï¼Œå¥åº·åº¦ä¸ŠæŠ¥ï¼Œç»Ÿè®¡ä¸ŠæŠ¥ï¼Œè¿œç¨‹æ—¥å¿—ã€‚ä»¥ä¾¿å…³æ³¨ç½‘å…³è‡ªèº«æ€§èƒ½ã€‚&lt;h3 id=&quot;QPS-ç°çŠ¶&quot;&gt;&lt;a href=&quot;#QPS-ç°çŠ¶&quot; class=&quot;headerlink&quot; title=&quot;QPS ç°çŠ¶&quot;&gt;&lt;/a&gt;QPS ç°çŠ¶&lt;/h3&gt;é¦–å…ˆçœ‹ä¸‹å½“å‰ä¸šåŠ¡çš„æ€§èƒ½æŒ‡æ ‡ï¼Œä½¿ç”¨ wrk å‹æµ‹ç½‘å…³æœåŠ¡&lt;br&gt;&lt;img src=&quot;/images/go/performance_8.png&quot; alt=&quot;go performance analysis&quot;&gt;&lt;br&gt;å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ€»é“¾æ¥æ•°ä¸º 70 çš„æ—¶å€™ï¼ŒQPS æœ€é«˜ï¼Œä¸º 13245ã€‚&lt;h3 id=&quot;ç«ç„°å›¾&quot;&gt;&lt;a href=&quot;#ç«ç„°å›¾&quot; class=&quot;headerlink&quot; title=&quot;ç«ç„°å›¾&quot;&gt;&lt;/a&gt;ç«ç„°å›¾&lt;/h3&gt;&lt;img src=&quot;/images/go/performance_9.png&quot; alt=&quot;go performance analysis&quot;&gt;&lt;br&gt;æ ¹æ®ç«ç„°å›¾æˆ‘ä»¬å®šä½å‡º cpu å æ¯”è¾ƒé«˜çš„å‡ ä¸ªæ–¹æ³•ä¸ºï¼š&lt;/li&gt;
&lt;li&gt;json.Marshal&lt;/li&gt;
&lt;li&gt;json.Unmarshal&lt;/li&gt;
&lt;li&gt;rogger.Infof&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œå°†ä»£ç æ”¹ä¸ºæœ¬åœ°è¿è¡Œï¼Œå¹¶é€šè¿‡ benchmark çš„æ–¹å¼æ¥å¯¹æ¯”ä¿®æ”¹å‰åçš„å·®å¼‚ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ç”±äºæ­£å¼ç¯å¢ƒä½¿ç”¨çš„ golang ç‰ˆæœ¬ä¸º 1.12ï¼Œå› æ­¤æœ¬åœ°æµ‹è¯•æ—¶ï¼Œä¹Ÿè¦ä½¿ç”¨åŒæ ·çš„ç‰ˆæœ¬ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;benchmark&quot;&gt;&lt;a href=&quot;#benchmark&quot; class=&quot;headerlink&quot; title=&quot;benchmark&quot;&gt;&lt;/a&gt;benchmark&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Benchmark   	50000000	      3669 ns/op	    4601 B/op	      73 allocs/op&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;æŸ¥çœ‹ cpu å’Œ memory çš„ profileï¼Œå‘ç°å¥åº·åº¦ä¸ŠæŠ¥çš„æ•°æ®ç»“æ„å¡«å……å æ¯”è¾ƒé«˜ã€‚è¿™éƒ¨åˆ†é€»è¾‘åŸºäº tars æ¡†æ¶å®ç°ã€‚æš‚æ—¶å¿½ç•¥ï¼Œä¸ºé¿å…å½±å“å…¶ä»–æµ‹è¯•ï¼Œå…ˆæ³¨é‡Šæ‰ã€‚å†çœ‹çœ‹ benchmarkã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Benchmark   	  500000	      3146 ns/op	    2069 B/op	      55 allocs/op&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;ä¼˜åŒ–ç­–ç•¥&quot;&gt;&lt;a href=&quot;#ä¼˜åŒ–ç­–ç•¥&quot; class=&quot;headerlink&quot; title=&quot;ä¼˜åŒ–ç­–ç•¥&quot;&gt;&lt;/a&gt;ä¼˜åŒ–ç­–ç•¥&lt;/h2&gt;&lt;h3 id=&quot;JSON-ä¼˜åŒ–&quot;&gt;&lt;a href=&quot;#JSON-ä¼˜åŒ–&quot; class=&quot;headerlink&quot; title=&quot;JSON ä¼˜åŒ–&quot;&gt;&lt;/a&gt;JSON ä¼˜åŒ–&lt;/h3&gt;&lt;p&gt;å…ˆæŸ¥çœ‹ json è§£æçš„éƒ¨åˆ†ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ä¼˜åŒ–ç©ºé—´&lt;/p&gt;
&lt;h4 id=&quot;è¯·æ±‚å¤„ç†&quot;&gt;&lt;a href=&quot;#è¯·æ±‚å¤„ç†&quot; class=&quot;headerlink&quot; title=&quot;è¯·æ±‚å¤„ç†&quot;&gt;&lt;/a&gt;è¯·æ±‚å¤„ç†&lt;/h4&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//RootHandle view.ReadReq2Json readJsonReq ä¸­è¿›è¡Œjsonè§£æ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; GatewayReqBody &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Header  GatewayReqBodyHeader   &lt;span class=&quot;string&quot;&gt;`json:&quot;header&quot;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Payload &lt;span class=&quot;keyword&quot;&gt;map&lt;/span&gt;[&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt;&amp;#123;&amp;#125; &lt;span class=&quot;string&quot;&gt;`json:&quot;payload&quot;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;readJsonReq&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(data []&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;, req *model.GatewayReqBody)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; dataMap := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;map&lt;/span&gt;[&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt;&amp;#123;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; err := jsoniter.Unmarshal(data, &amp;amp;dataMap)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  headerMap, ok := header.(&lt;span class=&quot;keyword&quot;&gt;map&lt;/span&gt;[&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt;&amp;#123;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  businessName, ok := headerMap[&lt;span class=&quot;string&quot;&gt;&quot;businessName&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  qua, ok := headerMap[&lt;span class=&quot;string&quot;&gt;&quot;qua&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  sessionId, ok := headerMap[&lt;span class=&quot;string&quot;&gt;&quot;sessionId&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  payload, ok := dataMap[&lt;span class=&quot;string&quot;&gt;&quot;payload&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  req.Payload, ok = payload.(&lt;span class=&quot;keyword&quot;&gt;map&lt;/span&gt;[&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt;&amp;#123;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;è¿™ä¸ªå‡½æ•°æœ¬è´¨ä¸Šå°† data è§£æä¸º model.GatewayReqBody ç±»å‹çš„ç»“æ„ä½“ã€‚ä½†æ˜¯è¿™é‡Œå´å­˜åœ¨ 2 ä¸ªé—®é¢˜&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä½¿ç”¨äº†å¤æ‚çš„è§£ææ–¹å¼ï¼Œå…ˆå°† data è§£æä¸º mapï¼Œå†é€šè¿‡æ¯ä¸ªå­—æ®µçš„åå­—æ¥å–å€¼ï¼Œå¹¶è¿›è¡Œç±»å‹è½¬æ¢ã€‚&lt;/li&gt;
&lt;li&gt;Req.Playload è§£æä¸ºä¸€ä¸ª mapã€‚ä½†åˆæœªä½¿ç”¨ã€‚æˆ‘ä»¬çœ‹çœ‹åé¢è¿™ä¸ª payload æ˜¯ç”¨æ¥åšå•¥ã€‚ç¡®è®¤æ˜¯å¦ä¸ºæ— æ•ˆä»£ç ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;invokeTafServant&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(resp http.ResponseWriter, gatewayHttpReq *model.GatewayHttpReq)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  payloadBytes, err := json.Marshal(gatewayHttpReq.ReqBody.Payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  commonReq.Payload = &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;(payloadBytes)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  responseData(gatewayHttpReq, StatusInternalServerError, &lt;span class=&quot;string&quot;&gt;&quot;å°è£…jsonå¼‚å¸¸&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;, resp)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;åç»­çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåˆå°†è¿™ä¸ª payload è½¬ä¸º stringã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šï¼Œä¸Šé¢çš„ json è§£ææ˜¯æ²¡æœ‰æ„ä¹‰ï¼ŒåŒæ—¶ä¹Ÿä¼šæµªè´¹èµ„æºï¼ˆpayload æ•°æ®é‡ä¸€èˆ¬ä¸å°ï¼‰ã€‚&lt;/p&gt;
&lt;h4 id=&quot;ä¼˜åŒ–æ–¹æ³•&quot;&gt;&lt;a href=&quot;#ä¼˜åŒ–æ–¹æ³•&quot; class=&quot;headerlink&quot; title=&quot;ä¼˜åŒ–æ–¹æ³•&quot;&gt;&lt;/a&gt;ä¼˜åŒ–æ–¹æ³•&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;golang è‡ªå¸¦çš„ json è§£ææ€§èƒ½è¾ƒä½ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥æ›¿æ¢ä¸ºgithub.com/json-iteratoræ¥æå‡æ€§èƒ½&lt;/li&gt;
&lt;li&gt;åœ¨ golang ä¸­ï¼Œé‡åˆ°ä¸éœ€è¦è§£æçš„ json æ•°æ®ï¼Œå¯ä»¥å°†å…¶ç±»å‹å£°æ˜ä¸ºjson.RawMessage. å³ï¼Œå¯ä»¥å°†ä¸Šè¿° 2 ä¸ªæ–¹æ³•ä¼˜åŒ–ä¸º&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; GatewayReqBody &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Header  GatewayReqBodyHeader &lt;span class=&quot;string&quot;&gt;`json:&quot;header&quot;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Payload json.RawMessage      &lt;span class=&quot;string&quot;&gt;`json:&quot;payload&quot;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;readJsonReq&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(data []&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;, req *model.GatewayReqBody)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; err := jsoniter.Unmarshal(data, req)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; jsonParseErr&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; k, v := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; req.Header.Qua &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  req.Header.Qua[k] = v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(req.Header.QuaStr) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   req.Header.QuaStr = k + &lt;span class=&quot;string&quot;&gt;&quot;=&quot;&lt;/span&gt; + v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   req.Header.QuaStr += &lt;span class=&quot;string&quot;&gt;&quot;&amp;amp;&quot;&lt;/span&gt; + k + &lt;span class=&quot;string&quot;&gt;&quot;=&quot;&lt;/span&gt; + v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;invokeTafServant&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(resp http.ResponseWriter, gatewayHttpReq *model.GatewayHttpReq)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; commonReq.Payload = &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;(gatewayHttpReq.ReqBody.Payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;è¿™é‡Œæ³¨æ„ï¼å‡ºç°äº† string å’Œ[]byte ä¹‹é—´çš„ç±»å‹è½¬æ¢.ä¸ºäº†é¿å…å†…å­˜æ‹·è´ï¼Œè¿™é‡Œå°† string()æ”¹ä¸ºä¸Šé¢çš„ç±»å‹è½¬æ¢ä¼˜åŒ–ä¸­æ‰€å®šä¹‰çš„è½¬æ¢å‡½æ•°ï¼Œå³ &lt;code&gt;commonReq.Payload = encode.String(gatewayHttpReq.ReqBody.Payload)&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;å›åŒ…å¤„ç†&quot;&gt;&lt;a href=&quot;#å›åŒ…å¤„ç†&quot; class=&quot;headerlink&quot; title=&quot;å›åŒ…å¤„ç†&quot;&gt;&lt;/a&gt;å›åŒ…å¤„ç†&lt;/h4&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; GatewayRespBody &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Header  GatewayRespBodyHeader  &lt;span class=&quot;string&quot;&gt;`json:&quot;header&quot;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Payload &lt;span class=&quot;keyword&quot;&gt;map&lt;/span&gt;[&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt;&amp;#123;&amp;#125; &lt;span class=&quot;string&quot;&gt;`json:&quot;payload&quot;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;responseData&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(gatewayReq *model.GatewayHttpReq, code &lt;span class=&quot;keyword&quot;&gt;int32&lt;/span&gt;, message &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;, payload &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;, resp http.ResponseWriter)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; jsonPayload := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;map&lt;/span&gt;[&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;]&lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt;&amp;#123;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(payload) != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  err := json.Unmarshal([]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;(payload), &amp;amp;jsonPayload)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; body := model.GatewayRespBody&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Header: model.GatewayRespBodyHeader&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   Code:    code,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   Message: message,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Payload: jsonPayload,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  data, err := view.RenderResp(&lt;span class=&quot;string&quot;&gt;&quot;json&quot;&lt;/span&gt;, &amp;amp;body)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  resp.WriteHeader(http.StatusOK)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; resp.Write(data)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;åŒæ ·çš„ï¼Œè¿™é‡Œçš„ jsonPayloadï¼Œä¹Ÿæ˜¯å‡ºç°äº†ä¸å¿…è¦çš„ json è§£æã€‚æˆ‘ä»¬å¯ä»¥æ”¹ä¸º&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; GatewayRespBody &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Header  GatewayRespBodyHeader  &lt;span class=&quot;string&quot;&gt;`json:&quot;header&quot;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; Payload json.RawMessage &lt;span class=&quot;string&quot;&gt;`json:&quot;payload&quot;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;body := model.GatewayRespBody&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Header: model.GatewayRespBodyHeader&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   Code:    code,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   Message: message,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Payload: encode.Str2Bytes(payload),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç„¶ååœ¨ view.RenderResp æ–¹æ³•ä¸­&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;RenderResp&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(format &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;, resp &lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt;&amp;#123;&amp;#125;)&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;([]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;, error)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;json&quot;&lt;/span&gt; == format &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; jsoniter.Marshal(resp)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;, errors.New(&lt;span class=&quot;string&quot;&gt;&quot;format error&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;benchmark-1&quot;&gt;&lt;a href=&quot;#benchmark-1&quot; class=&quot;headerlink&quot; title=&quot;benchmark&quot;&gt;&lt;/a&gt;benchmark&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Benchmark   	  500000	      3326 ns/op	    2842 B/op	      50 allocs/op&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;è™½ç„¶å¯¹è±¡ alloc å‡å°‘äº†ï¼Œä½†å•æ¬¡æ“ä½œå†…å­˜ä½¿ç”¨å¢åŠ äº†ï¼Œä¸”æ€§èƒ½ä¸‹é™äº†ã€‚è¿™å°±æœ‰ç‚¹å¥‡æ€ªäº†ã€‚æˆ‘ä»¬æ¥å¯¹æ¯”ä¸€ä¸‹ 2 ä¸ªæƒ…å†µä¸‹çš„ pprofã€‚&lt;/p&gt;
&lt;h3 id=&quot;é€ƒé€¸åˆ†æåŠå¤„ç†&quot;&gt;&lt;a href=&quot;#é€ƒé€¸åˆ†æåŠå¤„ç†&quot; class=&quot;headerlink&quot; title=&quot;é€ƒé€¸åˆ†æåŠå¤„ç†&quot;&gt;&lt;/a&gt;é€ƒé€¸åˆ†æåŠå¤„ç†&lt;/h3&gt;&lt;h4 id=&quot;go-tool-pprof-base&quot;&gt;&lt;a href=&quot;#go-tool-pprof-base&quot; class=&quot;headerlink&quot; title=&quot;go tool pprof -base&quot;&gt;&lt;/a&gt;go tool pprof -base&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;cpu å·®å¼‚&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;flat  flat%   sum%        cum   cum%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; 0.09s  1.17%  1.17%      0.40s  5.20%  runtime.mallocgc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; 0.01s  0.13%  1.30%      0.35s  4.55%  /vendor/github.com/json-iterator/go.(*Iterator).readObjectStart&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; 0      0%     1.30%      0.35s  4.55%  /vendor/github.com/json-iterator/go.(*twoFieldsStructDecoder).Decode&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;mem å·®å¼‚&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;    flat  flat%   sum%        cum   cum%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;478.96MB 20.33% 20.33%   279.94MB 11.88%  gateway.RootHandle&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       0     0% 20.33%   279.94MB 11.88%  &lt;span class=&quot;built_in&quot;&gt;command&lt;/span&gt;-line-arguments.BenchmarkTestHttp.func1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       0     0% 20.33%   279.94MB 11.88%  testing.(*B).RunParallel.func1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å¯ä»¥çœ‹å‡º RootHandle å¤šäº† 478.96M çš„å†…å­˜ä½¿ç”¨ã€‚é€šè¿‡ list RootHandle å¯¹æ¯” 2 ä¸ªæƒ…å†µä¸‹çš„å†…å­˜ä½¿ç”¨ã€‚å‘ç°ä¿®æ”¹åçš„ RootHandle ä¸­å¤šå‡ºäº†è¿™ä¸€è¡Œï¼š&lt;code&gt;475.46MB 475.46MB 158: gatewayHttpReq := model.GatewayHttpReq{}&lt;/code&gt; è¿™ä¸€èˆ¬æ„å‘³ç€å˜é‡ gatewayHttpReq å‡ºç°äº†é€ƒé€¸ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;go build -gcflags â€œ-m -mâ€ gateway/*.go&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;gateway/logic.go:270:26: &amp;amp;gatewayHttpReq escapes to heap&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ç¡®å®å‡ºç°äº†é€ƒé€¸ã€‚è¿™ä¸ªå¯¹åº”çš„ä»£ç ä¸º&lt;code&gt;err = view.ReadReq2Json(&amp;amp;gatewayHttpReq)&lt;/code&gt;,è€Œé€ æˆé€ƒé€¸çš„æœ¬è´¨æ˜¯å› ä¸ºä¸Šé¢æ”¹åŠ¨äº†å‡½æ•° readJsonReqï¼ˆåŠ¨æ€ç±»å‹é€ƒé€¸ï¼Œå³å‡½æ•°å‚æ•°ä¸º interface ç±»å‹ï¼Œæ— æ³•åœ¨ç¼–è¯‘æ—¶ç¡®å®šå…·ä½“ç±»å‹çš„ï¼‰&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;readJsonReq&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(data []&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;, req *model.GatewayReqBody)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; err := jsoniter.Unmarshal(data, req)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å› æ­¤ï¼Œè¿™é‡Œéœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹ï¼Œæ”¹ä¸º&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;readJsonReq&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(data []&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;, req *model.GatewayReqBody)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;error&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; tmp model.GatewayReqBody&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	err := jsoniter.Unmarshal(data, &amp;amp;tmp)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;benchmark-2&quot;&gt;&lt;a href=&quot;#benchmark-2&quot; class=&quot;headerlink&quot; title=&quot;benchmark&quot;&gt;&lt;/a&gt;benchmark&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Benchmark   	  500000	      2994 ns/op	    1892 B/op	      50 allocs/op&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°å †å†…å­˜ä½¿ç”¨æ˜æ˜¾ä¸‹é™ã€‚æ€§èƒ½ä¹Ÿæå‡äº†ã€‚å†çœ‹ä¸€ä¸‹ pprofï¼Œå¯»æ‰¾ä¸‹ä¸ªç“¶é¢ˆã€‚&lt;/p&gt;
&lt;h4 id=&quot;cpu-profile&quot;&gt;&lt;a href=&quot;#cpu-profile&quot; class=&quot;headerlink&quot; title=&quot;cpu profile&quot;&gt;&lt;/a&gt;cpu profile&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;/images/go/performance_10.png&quot; alt=&quot;go performance analysis&quot;&gt;&lt;br&gt;æŠ›å¼€ responeseData(ä»–å†…éƒ¨ä¸»è¦æ˜¯æ—¥å¿—æ‰“å°å æ¯”é«˜ï¼‰ï¼Œå æ¯”è¾ƒé«˜çš„ä¸º util.GenerateSessionIdï¼Œå…ˆæ¥çœ‹çœ‹è¿™ä¸ªæ€ä¹ˆä¼˜åŒ–ã€‚&lt;/p&gt;
&lt;h3 id=&quot;éšæœºå­—ç¬¦ä¸²ç”Ÿæˆ&quot;&gt;&lt;a href=&quot;#éšæœºå­—ç¬¦ä¸²ç”Ÿæˆ&quot; class=&quot;headerlink&quot; title=&quot;éšæœºå­—ç¬¦ä¸²ç”Ÿæˆ&quot;&gt;&lt;/a&gt;éšæœºå­—ç¬¦ä¸²ç”Ÿæˆ&lt;/h3&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; letterRunes = []&lt;span class=&quot;keyword&quot;&gt;rune&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;RandStringRunes&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(n &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;string&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; b := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;rune&lt;/span&gt;, n)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;keyword&quot;&gt;range&lt;/span&gt; b &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  b[i] = letterRunes[rand.Intn(&lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(letterRunes))]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;(b)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ç›®å‰çš„ç”Ÿæˆæ–¹å¼ä½¿ç”¨çš„ç±»å‹æ˜¯ runeï¼Œä½†å…¶å®ç”¨ byte å°±å¤Ÿäº†ã€‚å¦å¤–ï¼ŒletterRunes æ˜¯ 62 ä¸ªå­—ç¬¦ï¼Œå³æœ€å¤§éœ€è¦ 6 ä½çš„ index å°±å¯ä»¥éå†å®Œæˆäº†ã€‚è€Œéšæœºæ•°è·å–çš„æ˜¯ 63 ä½ã€‚å³æ¯ä¸ªéšæœºæ•°ï¼Œå…¶å®å¯ä»¥äº§ç”Ÿ 10 ä¸ªéšæœºå­—ç¬¦ã€‚è€Œä¸ç”¨æ¯ä¸ªå­—ç¬¦éƒ½è·å–ä¸€æ¬¡éšæœºæ•°ã€‚æ‰€ä»¥æˆ‘ä»¬æ”¹ä¸º&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; letterBytes   = &lt;span class=&quot;string&quot;&gt;&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; letterIdxBits = &lt;span class=&quot;number&quot;&gt;6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; letterIdxMask = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&amp;lt;&amp;lt;letterIdxBits - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; letterIdxMax  = &lt;span class=&quot;number&quot;&gt;63&lt;/span&gt; / letterIdxBits&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;RandStringRunes&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(n &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;)&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;string&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; b := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;, n)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i, cache, remain := n&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;, rand.Int63(), letterIdxMax; i &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; remain == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   cache, remain = rand.Int63(), letterIdxMax&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; idx := &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;(cache &amp;amp; letterIdxMask); idx &amp;lt; &lt;span class=&quot;built_in&quot;&gt;len&lt;/span&gt;(letterBytes) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   b[i] = letterBytes[idx]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   i--&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  cache &amp;gt;&amp;gt;= letterIdxBits&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  remain--&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;(b)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;benchmark-3&quot;&gt;&lt;a href=&quot;#benchmark-3&quot; class=&quot;headerlink&quot; title=&quot;benchmark&quot;&gt;&lt;/a&gt;benchmark&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Benchmark   	 1000000	      1487 ns/op	    1843 B/op	      50 allocs/op&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;ç±»å‹è½¬æ¢åŠå­—ç¬¦ä¸²æ‹¼æ¥&quot;&gt;&lt;a href=&quot;#ç±»å‹è½¬æ¢åŠå­—ç¬¦ä¸²æ‹¼æ¥&quot; class=&quot;headerlink&quot; title=&quot;ç±»å‹è½¬æ¢åŠå­—ç¬¦ä¸²æ‹¼æ¥&quot;&gt;&lt;/a&gt;ç±»å‹è½¬æ¢åŠå­—ç¬¦ä¸²æ‹¼æ¥&lt;/h3&gt;&lt;p&gt;ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéƒ½ä¼šè¯´å°† string å’Œ[]byte çš„è½¬æ¢æ”¹ä¸º unsafeï¼›ä»¥åŠåœ¨å­—ç¬¦ä¸²æ‹¼æ¥æ—¶ï¼Œç”¨ byte.Buffer ä»£æ›¿ fmt.Sprintfã€‚ä½†æ˜¯ç½‘å…³è¿™é‡Œçš„æƒ…å†µæ¯”è¾ƒç‰¹æ®Šï¼Œå­—ç¬¦ä¸²çš„æ“ä½œåŸºæœ¬é›†ä¸­åœ¨æ‰“å°æ—¥å¿—çš„æ“ä½œã€‚è€Œ tars çš„æ—¥å¿—æ‰“å°æœ¬èº«å°±æ˜¯é€šè¿‡ byte.Buffer æ‹¼æ¥çš„ã€‚æ‰€ä»¥è¿™å¯ä»¥é¿å…ã€‚å¦å¤–ï¼Œç”±äºæ—¥å¿—æ‰“å°é‡å¤§ï¼Œä½¿ç”¨ unsafe è½¬æ¢[]byte ä¸º string å¸¦æ¥çš„æ”¶ç›Šï¼Œå¾€å¾€ä¼šå› ä¸ºé€ƒé€¸ä»è€Œå½±å“ GCï¼Œåæ­£ä¼šå½±å“æ€§èƒ½ã€‚å› æ­¤ï¼Œä¸åŒçš„åœºæ™¯ä¸‹ï¼Œä¸èƒ½ç®€å•çš„å¥—ç”¨ä¸€äº›ä¼˜åŒ–æ–¹æ³•ã€‚éœ€è¦é€šè¿‡å‹æµ‹åŠç»“æœåˆ†ææ¥åˆ¤æ–­å…·ä½“çš„ä¼˜åŒ–ç­–ç•¥ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ä¼˜åŒ–ç»“æœ&quot;&gt;&lt;a href=&quot;#ä¼˜åŒ–ç»“æœ&quot; class=&quot;headerlink&quot; title=&quot;ä¼˜åŒ–ç»“æœ&quot;&gt;&lt;/a&gt;ä¼˜åŒ–ç»“æœ&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/images/go/performance_11.png&quot; alt=&quot;go performance analysis&quot;&gt;&lt;br&gt;å¯ä»¥çœ‹åˆ°ä¼˜åŒ–åï¼Œæœ€å¤§é“¾æ¥æ•°ä¸º 110ï¼Œæœ€é«˜ QPS ä¸º&lt;strong&gt;21153.35&lt;/strong&gt;ã€‚å¯¹æ¯”ä¹‹å‰çš„&lt;strong&gt;13245&lt;/strong&gt;ï¼Œå¤§çº¦æå‡ 60%ã€‚&lt;/p&gt;
&lt;h2 id=&quot;åç»­&quot;&gt;&lt;a href=&quot;#åç»­&quot; class=&quot;headerlink&quot; title=&quot;åç»­&quot;&gt;&lt;/a&gt;åç»­&lt;/h2&gt;&lt;p&gt;ä» pprof ä¸­å¯ä»¥çœ‹åˆ°æ—¥å¿—æ‰“å°ï¼Œè¿œç¨‹æ—¥å¿—ï¼Œå¥åº·ä¸ŠæŠ¥ç­‰ä¿¡æ¯å ç”¨è¾ƒå¤š cpu èµ„æºï¼Œä¸”å¯¼è‡´å¤šä¸ªæ•°æ®é€ƒé€¸ï¼ˆå°¤å…¶æ˜¯æ—¥å¿—æ‰“å°ï¼‰ã€‚è¿‡å¤šçš„æ—¥å¿—åŸºæœ¬ç­‰äºæ²¡æœ‰æ—¥å¿—ã€‚åç»­å¯è€ƒè™‘è£å‰ªæ—¥å¿—ï¼Œä»…ä¿ç•™å‡ºé”™æ—¶çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;h2 id=&quot;æ€»ç»“&quot;&gt;&lt;a href=&quot;#æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;æ€»ç»“&quot;&gt;&lt;/a&gt;æ€»ç»“&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;æ€§èƒ½æŸ¥çœ‹å·¥å…· pprof,trace åŠå‹æµ‹å·¥å…· wrk æˆ–å…¶ä»–å‹æµ‹å·¥å…·çš„ä½¿ç”¨è¦æ¯”è¾ƒäº†è§£ã€‚&lt;/li&gt;
&lt;li&gt;ä»£ç é€»è¾‘å±‚é¢çš„èµ°è¯»éå¸¸é‡è¦ï¼Œè¦å°½é‡é¿å…æ— æ•ˆé€»è¾‘ã€‚&lt;/li&gt;
&lt;li&gt;å¯¹äº golang è‡ªèº«åº“å­˜åœ¨ç¼ºé™·çš„ï¼Œå¯ä»¥å¯»æ‰¾ç¬¬ä¸‰æ–¹åº“æˆ–è‡ªå·±æ”¹é€ ã€‚&lt;/li&gt;
&lt;li&gt;golang ç‰ˆæœ¬å°½é‡æ›´æ–°ï¼Œè¿™æ¬¡çš„æµ‹è¯•æ˜¯åœ¨ golang1.12 ä¸‹è¿›è¡Œçš„ã€‚è€Œ go1.13 ç”šè‡³ go1.14 åœ¨å¾ˆå¤šåœ°æ–¹è¿›è¡Œäº†æ”¹è¿›ã€‚æ¯”å¦‚ fmt.Sprintfï¼Œsync.Pool ç­‰ã€‚æ›¿æ¢æˆæ–°ç‰ˆæœ¬åº”è¯¥èƒ½è¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚&lt;/li&gt;
&lt;li&gt;æœ¬åœ° benchmark ç»“æœä¸ç­‰äºçº¿ä¸Šè¿è¡Œç»“æœã€‚å°¤å…¶æ˜¯åœ¨ä½¿ç”¨ç¼“å­˜æ¥æé«˜å¤„ç†é€Ÿåº¦æ—¶ï¼Œè¦è€ƒè™‘ GC çš„å½±å“ã€‚&lt;/li&gt;
&lt;li&gt;ä¼ å‚æ•°æˆ–è¿”å›å€¼æ—¶ï¼Œå°½é‡æŒ‰ golang çš„è®¾è®¡å“²å­¦ï¼Œå°‘ç”¨æŒ‡é’ˆï¼Œå¤šç”¨å€¼å¯¹è±¡ï¼Œé¿å…å¼•èµ·è¿‡å¤šçš„å˜é‡é€ƒé€¸ï¼Œå¯¼è‡´ GC è€—æ—¶æš´æ¶¨ã€‚struct çš„å¤§å°ä¸€èˆ¬åœ¨ 2K ä»¥ä¸‹çš„æ‹·è´ä¼ å€¼ï¼Œæ¯”ä½¿ç”¨æŒ‡é’ˆè¦å¿«ï¼ˆå¯é’ˆå¯¹ä¸åŒçš„æœºå™¨å‹æµ‹ï¼Œåˆ¤æ–­å„è‡ªçš„é˜ˆå€¼)ã€‚&lt;/li&gt;
&lt;li&gt;å€¼ç±»å‹åœ¨æ»¡è¶³éœ€è¦çš„æƒ…å†µä¸‹ï¼Œè¶Šå°è¶Šå¥½ã€‚èƒ½ç”¨ int8ï¼Œå°±ä¸è¦ç”¨ int64ã€‚&lt;/li&gt;
&lt;li&gt;èµ„æºå°½é‡å¤ç”¨,åœ¨ golang1.13 ä»¥ä¸Šï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ sync.Pool ç¼“å­˜ä¼šé‡å¤ç”³è¯·çš„å†…å­˜æˆ–å¯¹è±¡ã€‚æˆ–è€…è‡ªå·±ä½¿ç”¨å¹¶ç®¡ç†å¤§å—å†…å­˜ï¼Œç”¨æ¥å­˜å‚¨å°å¯¹è±¡ï¼Œé¿å… GC å½±å“ï¼ˆå¦‚æœ¬åœ°ç¼“å­˜çš„åœºæ™¯)ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¨èé˜…è¯»: &lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;amp;mid=2651439020&amp;amp;idx=1&amp;amp;sn=c2094f4dccb53385dc207958e7f42f9e&amp;amp;chksm=80bb615eb7cce8481eb7a8f09d4a13e2974b3785c241dd31245647cd7540dde414d64f2b3719&amp;amp;scene=21#wechat_redirect&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;æ»´æ»´å®æˆ˜åˆ†äº«ï¼šé€šè¿‡ profiling å®šä½ golang æ€§èƒ½é—®é¢˜ - å†…å­˜ç¯‡&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ¥æºï¼štrumanyan&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;å¾®ä¿¡è®¢é˜…å·&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;é¡¹ç›®èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#é¡¹ç›®èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;é¡¹ç›®èƒŒæ™¯&quot;&gt;&lt;/a&gt;é¡¹ç›®èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;ç½‘å…³æœåŠ¡ä½œä¸ºç»Ÿä¸€æ¥å…¥æœåŠ¡ï¼Œæ˜¯å¤§éƒ¨åˆ†æœåŠ¡çš„ç»Ÿä¸€å…¥å£ã€‚ä¸ºäº†é¿å…æˆåŠŸç“¶é¢ˆï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œå°½å¯èƒ½åœ°ä¼˜åŒ–ã€‚å› æ­¤ï¼Œç‰¹åˆ«æ€»ç»“ä¸€ä¸‹ golang åå°æœåŠ¡æ€§èƒ½ä¼˜åŒ–çš„æ–¹å¼ï¼Œå¹¶å¯¹ç½‘å…³æœåŠ¡è¿›è¡Œä¼˜åŒ–ã€‚&lt;/p&gt;
&lt;p&gt;æŠ€æœ¯èƒŒæ™¯ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åŸºäº tarsgo æ¡†æ¶çš„ http æ¥å…¥æœåŠ¡ï¼Œä¸‹æ¸¸æœåŠ¡ä½¿ç”¨ tarsgo åè®®è¿›è¡Œäº¤äº’&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;æ€§èƒ½æŒ‡æ ‡&quot;&gt;&lt;a href=&quot;#æ€§èƒ½æŒ‡æ ‡&quot; class=&quot;headerlink&quot; title=&quot;æ€§èƒ½æŒ‡æ ‡&quot;&gt;&lt;/a&gt;æ€§èƒ½æŒ‡æ ‡&lt;/h2&gt;&lt;p&gt;ç½‘å…³æœåŠ¡æœ¬èº«æ²¡æœ‰ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œä»…ä½œä¸ºç»Ÿä¸€å…¥å£è¿›è¡Œè¯·æ±‚è½¬å‘ï¼Œå› æ­¤æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸‹åˆ—æŒ‡æ ‡&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ååé‡ï¼šæ¯ç§’é’Ÿå¯ä»¥å¤„ç†çš„è¯·æ±‚æ•°&lt;/li&gt;
&lt;li&gt;å“åº”æ—¶é—´ï¼šä»å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼Œåˆ°æ”¶åˆ°å›åŒ…çš„æ€»è€—æ—¶&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;å®šä½ç“¶é¢ˆ&quot;&gt;&lt;a href=&quot;#å®šä½ç“¶é¢ˆ&quot; class=&quot;headerlink&quot; title=&quot;å®šä½ç“¶é¢ˆ&quot;&gt;&lt;/a&gt;å®šä½ç“¶é¢ˆ&lt;/h2&gt;&lt;p&gt;ä¸€èˆ¬åå°æœåŠ¡çš„ç“¶é¢ˆä¸»è¦ä¸º CPUï¼Œå†…å­˜ï¼ŒIO æ“ä½œä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªã€‚è‹¥è¿™ä¸‰è€…çš„è´Ÿè½½éƒ½ä¸é«˜ï¼Œä½†ç³»ç»Ÿååé‡ä½ï¼ŒåŸºæœ¬å°±æ˜¯ä»£ç é€»è¾‘å‡ºé—®é¢˜äº†ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ä»£ç æ­£å¸¸è¿è¡Œçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦é’ˆå¯¹æŸä¸ªæ–¹é¢çš„é«˜è´Ÿè½½è¿›è¡Œä¼˜åŒ–ï¼Œæ‰èƒ½æé«˜ç³»ç»Ÿçš„æ€§èƒ½ã€‚golang å¯é€šè¿‡ benchmark åŠ  pprof æ¥å®šä½å…·ä½“çš„æ€§èƒ½ç“¶é¢ˆã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="æ€§èƒ½" scheme="http://team.jiunile.com/categories/golang/%E6%80%A7%E8%83%BD/"/>
    
    
      <category term="golang" scheme="http://team.jiunile.com/tags/golang/"/>
    
      <category term="pprof" scheme="http://team.jiunile.com/tags/pprof/"/>
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="gc" scheme="http://team.jiunile.com/tags/gc/"/>
    
      <category term="benchmark" scheme="http://team.jiunile.com/tags/benchmark/"/>
    
  </entry>
  
  <entry>
    <title>è°ƒè¯•golangçš„bugä»¥åŠæ€§èƒ½é—®é¢˜çš„å®è·µæ–¹æ³•</title>
    <link href="http://team.jiunile.com//blog/2020/05/go-debug-practice.html"/>
    <id>http://team.jiunile.com//blog/2020/05/go-debug-practice.html</id>
    <published>2020-05-11T10:00:00.000Z</published>
    <updated>2020-09-02T03:29:19.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;åœºæ™¯1ï¼š-å¦‚ä½•åˆ†æç¨‹åºçš„è¿è¡Œæ—¶é—´ä¸CPUåˆ©ç”¨ç‡æƒ…å†µï¼Ÿ&quot;&gt;&lt;a href=&quot;#åœºæ™¯1ï¼š-å¦‚ä½•åˆ†æç¨‹åºçš„è¿è¡Œæ—¶é—´ä¸CPUåˆ©ç”¨ç‡æƒ…å†µï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;åœºæ™¯1ï¼š å¦‚ä½•åˆ†æç¨‹åºçš„è¿è¡Œæ—¶é—´ä¸CPUåˆ©ç”¨ç‡æƒ…å†µï¼Ÿ&quot;&gt;&lt;/a&gt;åœºæ™¯1ï¼š å¦‚ä½•åˆ†æç¨‹åºçš„è¿è¡Œæ—¶é—´ä¸CPUåˆ©ç”¨ç‡æƒ…å†µï¼Ÿ&lt;/h2&gt;&lt;h3 id=&quot;shellå†…ç½®timeæŒ‡ä»¤&quot;&gt;&lt;a href=&quot;#shellå†…ç½®timeæŒ‡ä»¤&quot; class=&quot;headerlink&quot; title=&quot;shellå†…ç½®timeæŒ‡ä»¤&quot;&gt;&lt;/a&gt;shellå†…ç½®timeæŒ‡ä»¤&lt;/h3&gt;&lt;p&gt;è¿™ä¸ªæ–¹æ³•ä¸ç®—æ–°é¢–ï¼Œä½†æ˜¯ç¡®å¾ˆå®ç”¨ã€‚ timeæ˜¯Unix/Linuxå†…ç½®å¤šå‘½ä»¤ï¼Œä½¿ç”¨æ—¶ä¸€èˆ¬ä¸ç”¨ä¼ è¿‡å¤šå‚æ•°ï¼Œç›´æ¥è·Ÿä¸Šéœ€è¦è°ƒè¯•å¤šç¨‹åºå³å¯ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ time go run &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;2.go &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;amp;&amp;#123;&amp;#123;0 0&amp;#125; å¼ ä¸‰ 0&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;real    0m0.843s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;user    0m0.216s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sys 0m0.389s&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šé¢æ˜¯ä½¿ç”¨timeå¯¹ &lt;code&gt;go run test2.go&lt;/code&gt; å¯¹æ‰§è¡Œç¨‹åºåäº†æ€§èƒ½åˆ†æï¼Œå¾—åˆ°3ä¸ªæŒ‡æ ‡ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;real&lt;/code&gt;ï¼šä»ç¨‹åºå¼€å§‹åˆ°ç»“æŸï¼Œå®é™…åº¦è¿‡çš„æ—¶é—´ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;user&lt;/code&gt;ï¼šç¨‹åºåœ¨ç”¨æˆ·æ€åº¦è¿‡çš„æ—¶é—´ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sys&lt;/code&gt;ï¼šç¨‹åºåœ¨å†…æ ¸æ€åº¦è¿‡çš„æ—¶é—´&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸€èˆ¬æƒ…å†µä¸‹ &lt;code&gt;real&lt;/code&gt; &amp;gt;= &lt;code&gt;user&lt;/code&gt; + &lt;code&gt;sys&lt;/code&gt;ï¼Œå› ä¸ºç³»ç»Ÿè¿˜æœ‰å…¶å®ƒè¿›ç¨‹(åˆ‡æ¢å…¶ä»–è¿›ç¨‹ä¸­é—´å¯¹äºæœ¬è¿›ç¨‹å›æœ‰ç©ºç™½æœŸ)ã€‚&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;usr-bin-timeæŒ‡ä»¤&quot;&gt;&lt;a href=&quot;#usr-bin-timeæŒ‡ä»¤&quot; class=&quot;headerlink&quot; title=&quot;/usr/bin/timeæŒ‡ä»¤&quot;&gt;&lt;/a&gt;/usr/bin/timeæŒ‡ä»¤&lt;/h3&gt;&lt;p&gt;è¿™ä¸ªæŒ‡ä»¤æ¯”å†…ç½®çš„timeæ›´åŠ è¯¦ç»†ä¸€äº›ï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦ç”¨ç»å¯¹è·¯å¾„ï¼Œè€Œä¸”è¦åŠ ä¸Šå‚æ•° &lt;code&gt;-v&lt;/code&gt;&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ /usr/bin/time -v go run &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;2.go  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Command being timed: &lt;span class=&quot;string&quot;&gt;&quot;go run test2.go&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    User time (seconds): 0.12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    System time (seconds): 0.06&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Percent of CPU this job got: 115%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Elapsed (wall clock) time (h:mm:ss or m:ss): 0:00.16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Average shared text size (kbytes): 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Average unshared data size (kbytes): 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Average stack size (kbytes): 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Average total size (kbytes): 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Maximum resident &lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt; size (kbytes): 41172&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Average resident &lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt; size (kbytes): 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Major (requiring I/O) page faults: 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Minor (reclaiming a frame) page faults: 15880&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Voluntary context switches: 897&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Involuntary context switches: 183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Swaps: 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    File system inputs: 256&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    File system outputs: 2664&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Socket messages sent: 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Socket messages received: 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Signals delivered: 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Page size (bytes): 4096&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Exit status: 0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„åŠŸèƒ½è¦å¼ºå¤§å¤šäº†ï¼Œé™¤äº†ä¹‹å‰çš„ä¿¡æ¯å¤–ï¼Œè¿˜åŒ…æ‹¬äº†ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CPUå ç”¨ç‡ï¼›&lt;/li&gt;
&lt;li&gt;å†…å­˜ä½¿ç”¨æƒ…å†µï¼›&lt;/li&gt;
&lt;li&gt;Page Fault æƒ…å†µï¼›&lt;/li&gt;
&lt;li&gt;è¿›ç¨‹åˆ‡æ¢æƒ…å†µï¼›&lt;/li&gt;
&lt;li&gt;æ–‡ä»¶ç³»ç»ŸIOï¼›&lt;/li&gt;
&lt;li&gt;Socket ä½¿ç”¨æƒ…å†µï¼›&lt;/li&gt;
&lt;li&gt;â€¦â€¦&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;åœºæ™¯2ï¼š-å¦‚ä½•åˆ†ægolangç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Ÿ&quot;&gt;&lt;a href=&quot;#åœºæ™¯2ï¼š-å¦‚ä½•åˆ†ægolangç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;åœºæ™¯2ï¼š å¦‚ä½•åˆ†ægolangç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Ÿ&quot;&gt;&lt;/a&gt;åœºæ™¯2ï¼š å¦‚ä½•åˆ†ægolangç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Ÿ&lt;/h2&gt;&lt;h3 id=&quot;å†…å­˜å ç”¨æƒ…å†µæŸ¥çœ‹&quot;&gt;&lt;a href=&quot;#å†…å­˜å ç”¨æƒ…å†µæŸ¥çœ‹&quot; class=&quot;headerlink&quot; title=&quot;å†…å­˜å ç”¨æƒ…å†µæŸ¥çœ‹&quot;&gt;&lt;/a&gt;å†…å­˜å ç”¨æƒ…å†µæŸ¥çœ‹&lt;/h3&gt;&lt;p&gt;æˆ‘ä»¬å…ˆå†™ä¸€æ®µdemoä¾‹å­ä»£ç &lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;log&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;runtime&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//slice ä¼šåŠ¨æ€æ‰©å®¹ï¼Œç”¨sliceæ¥åšå †å†…å­˜ç”³è¯·&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    container := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; loop begin.&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;32&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        container = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(container, i)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; loop end.&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;Start.&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    test()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;force gc.&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    runtime.GC() &lt;span class=&quot;comment&quot;&gt;//å¼ºåˆ¶è°ƒç”¨gcå›æ”¶&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot;Done.&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    time.Sleep(&lt;span class=&quot;number&quot;&gt;3600&lt;/span&gt; * time.Second) &lt;span class=&quot;comment&quot;&gt;//ç¡çœ ï¼Œä¿æŒç¨‹åºä¸é€€å‡º&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç¼–è¯‘&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable&quot;&gt;$go&lt;/span&gt; build -o snippet_mem &amp;amp;&amp;amp; ./snippet_mem&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç„¶ååœ¨./snippet_memè¿›ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œï¼Œæˆ‘ä»¬å†å¼€ä¸€ä¸ªçª—å£ï¼Œé€šè¿‡ &lt;code&gt;top&lt;/code&gt; å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜å ç”¨æƒ…å†µ&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable&quot;&gt;$top&lt;/span&gt; -p $(pidof snippet_mem)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š&lt;br&gt;&lt;img src=&quot;/images/go/godebug_1.png&quot; alt=&quot;go debug top&quot;&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬çœ‹å‡ºæ¥ï¼Œæ²¡æœ‰é€€å‡ºçš„snippet_memè¿›ç¨‹æœ‰çº¦830mçš„å†…å­˜è¢«å ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ç›´è§‚ä¸Šæ¥è¯´ï¼Œè¿™ä¸ªç¨‹åºåœ¨ &lt;code&gt;test()&lt;/code&gt; å‡½æ•°æ‰§è¡Œå®Œåï¼Œåˆ‡ç‰‡ &lt;code&gt;contaner&lt;/code&gt; çš„å†…å­˜åº”è¯¥è¢«é‡Šæ”¾ï¼Œä¸åº”è¯¥å ç”¨830Mé‚£ä¹ˆå¤§ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢è®©æˆ‘ä»¬ä½¿ç”¨GODEBUGæ¥åˆ†æç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚&lt;/p&gt;
&lt;h3 id=&quot;GODEBUGä¸gctrace&quot;&gt;&lt;a href=&quot;#GODEBUGä¸gctrace&quot; class=&quot;headerlink&quot; title=&quot;GODEBUGä¸gctrace&quot;&gt;&lt;/a&gt;GODEBUGä¸gctrace&lt;/h3&gt;&lt;h4 id=&quot;ç”¨æ³•&quot;&gt;&lt;a href=&quot;#ç”¨æ³•&quot; class=&quot;headerlink&quot; title=&quot;ç”¨æ³•&quot;&gt;&lt;/a&gt;ç”¨æ³•&lt;/h4&gt;&lt;p&gt;æ‰§è¡Œ&lt;code&gt;snippet_mem&lt;/code&gt;ç¨‹åºä¹‹å‰æ·»åŠ ç¯å¢ƒå˜é‡&lt;code&gt;GODEBUG=&amp;#39;gctrace=1&amp;#39;&lt;/code&gt;æ¥è·Ÿè¸ªæ‰“å°åƒåœ¾å›æ”¶å™¨ä¿¡æ¯&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ GODEBUG=&lt;span class=&quot;string&quot;&gt;&#39;gctrace=1&#39;&lt;/span&gt; ./snippet_mem&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è®¾ç½®&lt;code&gt;gctrace=1&lt;/code&gt;ä¼šä½¿å¾—åƒåœ¾å›æ”¶å™¨åœ¨æ¯æ¬¡å›æ”¶æ—¶æ±‡æ€»æ‰€å›æ”¶å†…å­˜çš„å¤§å°ä»¥åŠè€—æ—¶ï¼Œ&lt;br&gt;å¹¶å°†è¿™äº›å†…å®¹æ±‡æ€»æˆå•è¡Œå†…å®¹æ‰“å°åˆ°æ ‡å‡†é”™è¯¯è¾“å‡ºä¸­ã€‚&lt;/p&gt;
&lt;h4 id=&quot;æ ¼å¼&quot;&gt;&lt;a href=&quot;#æ ¼å¼&quot; class=&quot;headerlink&quot; title=&quot;æ ¼å¼&quot;&gt;&lt;/a&gt;æ ¼å¼&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;gc &lt;span class=&quot;comment&quot;&gt;# @#s #%: #+#+# ms clock, #+#/#/#+# ms cpu, #-&amp;gt;#-&amp;gt;# MB, # MB goal, # P&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å«ä¹‰&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;gc &lt;span class=&quot;comment&quot;&gt;#        GCæ¬¡æ•°çš„ç¼–å·ï¼Œæ¯æ¬¡GCæ—¶é€’å¢&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@&lt;span class=&quot;comment&quot;&gt;#s         è·ç¦»ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶çš„æ—¶é—´&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#%          GCå ç”¨çš„æ‰§è¡Œæ—¶é—´ç™¾åˆ†æ¯”&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#+...+#     GCä½¿ç”¨çš„æ—¶é—´&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#-&amp;gt;#-&amp;gt;# MB  GCå¼€å§‹ï¼Œç»“æŸï¼Œä»¥åŠå½“å‰æ´»è·ƒå †å†…å­˜çš„å¤§å°ï¼Œå•ä½M&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# MB goal   å…¨å±€å †å†…å­˜å¤§å°&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# P         ä½¿ç”¨processorçš„æ•°é‡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¦‚æœæ¯æ¡ä¿¡æ¯æœ€åï¼Œä»¥&lt;code&gt;(forced)&lt;/code&gt;ç»“å°¾ï¼Œé‚£ä¹ˆè¯¥ä¿¡æ¯æ˜¯ç”±&lt;code&gt;runtime.GC()&lt;/code&gt;è°ƒç”¨è§¦å‘&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬æ¥é€‰æ‹©å…¶ä¸­ä¸€è¡Œæ¥è§£é‡Šä¸€ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;gc 17 @0.149s 1%: 0.004+36+0.003 ms clock, 0.009+0/0.051/36+0.006 ms cpu, 181-&amp;gt;181-&amp;gt;101 MB, 182 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¯¥æ¡ä¿¡æ¯å«ä¹‰å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;gc 17&lt;/code&gt;: Gc è°ƒè¯•ç¼–å·ä¸º17&lt;/li&gt;
&lt;li&gt;&lt;code&gt;@0.149s&lt;/code&gt;: æ­¤æ—¶ç¨‹åºå·²ç»æ‰§è¡Œäº†0.149s&lt;/li&gt;
&lt;li&gt;&lt;code&gt;1%&lt;/code&gt;: 0.149sä¸­å…¶ä¸­gcæ¨¡å—å ç”¨äº†1%çš„æ—¶é—´&lt;/li&gt;
&lt;li&gt;&lt;code&gt;0.004+36+0.003 ms clock&lt;/code&gt;: åƒåœ¾å›æ”¶çš„æ—¶é—´ï¼Œåˆ†åˆ«ä¸ºSTWï¼ˆstop-the-worldï¼‰æ¸…æ‰«çš„æ—¶é—´+å¹¶å‘æ ‡è®°å’Œæ‰«æçš„æ—¶é—´+STWæ ‡è®°çš„æ—¶é—´&lt;/li&gt;
&lt;li&gt;&lt;code&gt;0.009+0/0.051/36+0.006 ms cpu&lt;/code&gt;: åƒåœ¾å›æ”¶å ç”¨cpuæ—¶é—´&lt;/li&gt;
&lt;li&gt;&lt;code&gt;181-&amp;gt;181-&amp;gt;101 MB&lt;/code&gt;: GCå¼€å§‹å‰å †å†…å­˜181Mï¼Œ GCç»“æŸåå †å†…å­˜181Mï¼Œå½“å‰æ´»è·ƒçš„å †å†…å­˜101M&lt;/li&gt;
&lt;li&gt;&lt;code&gt;182 MB goal&lt;/code&gt;: å…¨å±€å †å†…å­˜å¤§å°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;2 P&lt;/code&gt;: æœ¬æ¬¡GCä½¿ç”¨äº†2ä¸ªP(è°ƒåº¦å™¨ä¸­çš„Processer)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;äº†è§£äº†GCçš„è°ƒè¯•ä¿¡æ¯è¯»æ³•åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æœ¬æ¬¡GCçš„ç»“æœã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬è¿˜æ˜¯æ‰§è¡ŒGODEBUGè°ƒè¯•&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ GODEBUG=&lt;span class=&quot;string&quot;&gt;&#39;gctrace=1&#39;&lt;/span&gt; ./snippet_mem&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç»“æœå¦‚ä¸‹:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 11:22:37 Start.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 11:22:37  ===&amp;gt; loop begin.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 1 @0.002s 5%: 0.14+0.45+0.002 ms clock, 0.29+0/0.042/0.33+0.005 ms cpu, 4-&amp;gt;4-&amp;gt;0 MB, 5 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 2 @0.003s 4%: 0.13+3.7+0.019 ms clock, 0.27+0/0.037/2.8+0.038 ms cpu, 4-&amp;gt;4-&amp;gt;2 MB, 5 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 3 @0.008s 3%: 0.002+1.1+0.001 ms clock, 0.005+0/0.083/1.0+0.003 ms cpu, 6-&amp;gt;6-&amp;gt;2 MB, 7 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 4 @0.010s 3%: 0.003+0.99+0.002 ms clock, 0.006+0/0.041/0.82+0.004 ms cpu, 5-&amp;gt;5-&amp;gt;2 MB, 6 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 5 @0.011s 4%: 0.079+0.80+0.003 ms clock, 0.15+0/0.046/0.51+0.006 ms cpu, 6-&amp;gt;6-&amp;gt;3 MB, 7 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 6 @0.013s 4%: 0.15+3.7+0.002 ms clock, 0.31+0/0.061/3.3+0.005 ms cpu, 8-&amp;gt;8-&amp;gt;8 MB, 9 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 7 @0.019s 3%: 0.004+2.5+0.005 ms clock, 0.008+0/0.051/2.1+0.010 ms cpu, 20-&amp;gt;20-&amp;gt;6 MB, 21 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 8 @0.023s 5%: 0.014+3.7+0.002 ms clock, 0.029+0.040/1.2/0+0.005 ms cpu, 15-&amp;gt;15-&amp;gt;8 MB, 16 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 9 @0.031s 4%: 0.003+1.6+0.001 ms clock, 0.007+0.094/0/0+0.003 ms cpu, 19-&amp;gt;19-&amp;gt;10 MB, 20 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 10 @0.034s 3%: 0.006+5.2+0.004 ms clock, 0.013+0/0.045/5.0+0.008 ms cpu, 24-&amp;gt;24-&amp;gt;13 MB, 25 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 11 @0.040s 3%: 0.12+2.6+0.002 ms clock, 0.24+0/0.043/2.5+0.004 ms cpu, 30-&amp;gt;30-&amp;gt;16 MB, 31 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 12 @0.043s 3%: 0.11+4.4+0.002 ms clock, 0.23+0/0.044/4.1+0.005 ms cpu, 38-&amp;gt;38-&amp;gt;21 MB, 39 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 13 @0.049s 3%: 0.008+10+0.040 ms clock, 0.017+0/0.045/10+0.080 ms cpu, 47-&amp;gt;47-&amp;gt;47 MB, 48 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 14 @0.070s 2%: 0.004+12+0.002 ms clock, 0.008+0/0.062/12+0.005 ms cpu, 122-&amp;gt;122-&amp;gt;41 MB, 123 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 15 @0.084s 2%: 0.11+11+0.038 ms clock, 0.22+0/0.064/3.9+0.076 ms cpu, 93-&amp;gt;93-&amp;gt;93 MB, 94 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 16 @0.122s 1%: 0.005+25+0.010 ms clock, 0.011+0/0.12/24+0.021 ms cpu, 238-&amp;gt;238-&amp;gt;80 MB, 239 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 17 @0.149s 1%: 0.004+36+0.003 ms clock, 0.009+0/0.051/36+0.006 ms cpu, 181-&amp;gt;181-&amp;gt;101 MB, 182 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 18 @0.187s 1%: 0.12+19+0.004 ms clock, 0.25+0/0.049/19+0.008 ms cpu, 227-&amp;gt;227-&amp;gt;126 MB, 228 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 19 @0.207s 1%: 0.096+27+0.004 ms clock, 0.19+0/0.077/0.73+0.009 ms cpu, 284-&amp;gt;284-&amp;gt;284 MB, 285 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 20 @0.287s 0%: 0.005+944+0.040 ms clock, 0.011+0/0.048/1.3+0.081 ms cpu, 728-&amp;gt;728-&amp;gt;444 MB, 729 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 11:22:38  ===&amp;gt; loop end.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 11:22:38 force gc.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 21 @1.236s 0%: 0.004+0.099+0.001 ms clock, 0.008+0/0.018/0.071+0.003 ms cpu, 444-&amp;gt;444-&amp;gt;0 MB, 888 MB goal, 2 P (forced)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 11:22:38 Done.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GC forced&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 22 @122.455s 0%: 0.010+0.15+0.003 ms clock, 0.021+0/0.025/0.093+0.007 ms cpu, 0-&amp;gt;0-&amp;gt;0 MB, 4 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GC forced&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 23 @242.543s 0%: 0.007+0.075+0.002 ms clock, 0.014+0/0.022/0.085+0.004 ms cpu, 0-&amp;gt;0-&amp;gt;0 MB, 4 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GC forced&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 24 @362.545s 0%: 0.018+0.19+0.006 ms clock, 0.037+0/0.055/0.15+0.013 ms cpu, 0-&amp;gt;0-&amp;gt;0 MB, 4 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GC forced&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 25 @482.548s 0%: 0.012+0.25+0.005 ms clock, 0.025+0/0.025/0.11+0.010 ms cpu, 0-&amp;gt;0-&amp;gt;0 MB, 4 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GC forced&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 26 @602.551s 0%: 0.009+0.10+0.003 ms clock, 0.018+0/0.021/0.075+0.006 ms cpu, 0-&amp;gt;0-&amp;gt;0 MB, 4 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GC forced&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 27 @722.554s 0%: 0.012+0.30+0.005 ms clock, 0.025+0/0.15/0.22+0.011 ms cpu, 0-&amp;gt;0-&amp;gt;0 MB, 4 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GC forced&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gc 28 @842.556s 0%: 0.027+0.18+0.003 ms clock, 0.054+0/0.11/0.14+0.006 ms cpu, 0-&amp;gt;0-&amp;gt;0 MB, 4 MB goal, 2 P&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;åˆ†æ&quot;&gt;&lt;a href=&quot;#åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;åˆ†æ&quot;&gt;&lt;/a&gt;åˆ†æ&lt;/h4&gt;&lt;p&gt;å…ˆçœ‹åœ¨&lt;code&gt;test()&lt;/code&gt;å‡½æ•°æ‰§è¡Œå®Œåç«‹å³æ‰“å°çš„&lt;code&gt;gc 21&lt;/code&gt;é‚£è¡Œçš„ä¿¡æ¯ã€‚&lt;code&gt;444-&amp;gt;444-&amp;gt;0 MB, 888 MB goal&lt;/code&gt;è¡¨ç¤ºåƒåœ¾å›æ”¶å™¨å·²ç»æŠŠ&lt;code&gt;444M&lt;/code&gt;çš„å†…å­˜æ ‡è®°ä¸ºéæ´»è·ƒçš„å†…å­˜ã€‚&lt;/p&gt;
&lt;p&gt;å†çœ‹ä¸‹ä¸€ä¸ªè®°å½•&lt;code&gt;gc 22ã€‚0-&amp;gt;0-&amp;gt;0 MB, 4 MB goal&lt;/code&gt;è¡¨ç¤ºåƒåœ¾å›æ”¶å™¨ä¸­çš„å…¨å±€å †å†…å­˜å¤§å°ç”±&lt;code&gt;888M&lt;/code&gt;ä¸‹é™ä¸º&lt;code&gt;4M&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h4 id=&quot;ç»“è®º&quot;&gt;&lt;a href=&quot;#ç»“è®º&quot; class=&quot;headerlink&quot; title=&quot;ç»“è®º&quot;&gt;&lt;/a&gt;ç»“è®º&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;åœ¨test()å‡½æ•°æ‰§è¡Œå®Œåï¼Œdemoç¨‹åºä¸­çš„åˆ‡ç‰‡å®¹å™¨æ‰€ç”³è¯·çš„å †ç©ºé—´éƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶äº†&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœæ­¤æ—¶åœ¨&lt;code&gt;top&lt;/code&gt;æŒ‡ä»¤æŸ¥è¯¢å†…å­˜çš„æ—¶å€™ï¼Œå¦‚æœä¾ç„¶å…ˆæ­»800+MBï¼Œè¯´æ˜&lt;strong&gt;åƒåœ¾å›æ”¶å™¨å›æ”¶äº†åº”ç”¨å±‚çš„å†…å­˜åï¼Œï¼ˆå¯èƒ½ï¼‰å¹¶ä¸ä¼šç«‹å³å°†å†…å­˜å½’è¿˜ç»™ç³»ç»Ÿ&lt;/strong&gt;ã€‚å…·ä½“åˆ†æåŸå› å¯è§ï¼š&lt;a href=&quot;https://segmentfault.com/a/1190000022472459&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;è¸©å‘è®°ï¼šgoæœåŠ¡å†…å­˜æš´æ¶¨&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;runtime-ReadMemStats&quot;&gt;&lt;a href=&quot;#runtime-ReadMemStats&quot; class=&quot;headerlink&quot; title=&quot;runtime.ReadMemStats&quot;&gt;&lt;/a&gt;runtime.ReadMemStats&lt;/h3&gt;&lt;p&gt;æ¥ä¸‹æ¥æˆ‘ä¹ˆæ¢å¦ä¸€ç§æ–¹å¼æŸ¥çœ‹å†…å­˜çš„æ–¹å¼ åˆ©ç”¨ runtimeåº“é‡Œçš„&lt;code&gt;ReadMemStats()&lt;/code&gt;æ–¹æ³•&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// demo2.go&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;log&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;runtime&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;readMemStats&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; ms runtime.MemStats&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    runtime.ReadMemStats(&amp;amp;ms)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Printf(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; Alloc:%d(bytes) HeapIdle:%d(bytes) HeapReleased:%d(bytes)&quot;&lt;/span&gt;, ms.Alloc, ms.HeapIdle, ms.HeapReleased)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//slice ä¼šåŠ¨æ€æ‰©å®¹ï¼Œç”¨sliceæ¥åšå †å†…å­˜ç”³è¯·&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    container := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; loop begin.&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;32&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        container = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(container, i)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ( i == &lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            readMemStats()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; loop end.&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; [Start].&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    readMemStats()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    test()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    readMemStats()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; [force gc].&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    runtime.GC() &lt;span class=&quot;comment&quot;&gt;//å¼ºåˆ¶è°ƒç”¨gcå›æ”¶&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; [Done].&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    readMemStats()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            readMemStats()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            time.Sleep(&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt; * time.Second)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    time.Sleep(&lt;span class=&quot;number&quot;&gt;3600&lt;/span&gt; * time.Second) &lt;span class=&quot;comment&quot;&gt;//ç¡çœ ï¼Œä¿æŒç¨‹åºä¸é€€å‡º&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæˆ‘ä»¬ï¼Œ å°è£…äº†ä¸€ä¸ªå‡½æ•°&lt;code&gt;readMemStats()&lt;/code&gt;ï¼Œè¿™é‡Œé¢ä¸»è¦æ˜¯è°ƒç”¨&lt;code&gt;runtime&lt;/code&gt;ä¸­çš„&lt;code&gt;ReadMemStats()&lt;/code&gt;æ–¹æ³•è·å¾—å†…å­˜ä¿¡æ¯ï¼Œç„¶åé€šè¿‡&lt;code&gt;log&lt;/code&gt;æ‰“å°å‡ºæ¥ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹ä»£ç å¹¶è¿è¡Œ:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ go run demo2.go &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 18:21:17  ===&amp;gt; [Start].&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 18:21:17  ===&amp;gt; Alloc:71280(bytes) HeapIdle:66633728(bytes) HeapReleased:66600960(bytes)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 18:21:17  ===&amp;gt; loop begin.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 18:21:18  ===&amp;gt; Alloc:132535744(bytes) HeapIdle:336756736(bytes) HeapReleased:155721728(bytes)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 18:21:38  ===&amp;gt; loop end.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 18:21:38  ===&amp;gt; Alloc:598300600(bytes) HeapIdle:609181696(bytes) HeapReleased:434323456(bytes)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 18:21:38  ===&amp;gt; [force gc].&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 18:21:38  ===&amp;gt; [Done].&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 18:21:38  ===&amp;gt; Alloc:55840(bytes) HeapIdle:1207427072(bytes) HeapReleased:434266112(bytes)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 18:21:38  ===&amp;gt; Alloc:56656(bytes) HeapIdle:1207394304(bytes) HeapReleased:434266112(bytes)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 18:21:48  ===&amp;gt; Alloc:56912(bytes) HeapIdle:1207394304(bytes) HeapReleased:1206493184(bytes)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 18:21:58  ===&amp;gt; Alloc:57488(bytes) HeapIdle:1207394304(bytes) HeapReleased:1206493184(bytes)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2020/03/02 18:22:08  ===&amp;gt; Alloc:57616(bytes) HeapIdle:1207394304(bytes) HeapReleased:1206493184(bytes)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;c2020/03/02 18:22:18  ===&amp;gt; Alloc:57744(bytes) HeapIdle:1207394304(bytes) HeapReleased:1206493184(by&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œæ‰“å°&lt;code&gt;[Done].&lt;/code&gt;ä¹‹åé‚£æ¡traceä¿¡æ¯ï¼ŒAllocå·²ç»ä¸‹é™ï¼Œå³å†…å­˜å·²è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚åœ¨&lt;code&gt;2020/03/02 18:21:38&lt;/code&gt;å’Œ&lt;code&gt;2020/03/02 18:21:48&lt;/code&gt;çš„ä¸¤æ¡traceä¿¡æ¯ä¸­ï¼ŒHeapReleasedå¼€å§‹ä¸Šå‡ï¼Œå³åƒåœ¾å›æ”¶å™¨æŠŠå†…å­˜å½’è¿˜ç»™ç³»ç»Ÿã€‚&lt;/p&gt;
&lt;p&gt;å¦å¤–ï¼ŒMemStatsè¿˜å¯ä»¥è·å–å…¶å®ƒå“ªäº›ä¿¡æ¯ä»¥åŠå­—æ®µçš„å«ä¹‰å¯ä»¥å‚è§å®˜æ–¹æ–‡æ¡£ï¼š&lt;a href=&quot;http://golang.org/pkg/runtime/#MemStats&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://golang.org/pkg/runtime/#MemStats&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;pprofå·¥å…·&quot;&gt;&lt;a href=&quot;#pprofå·¥å…·&quot; class=&quot;headerlink&quot; title=&quot;pprofå·¥å…·&quot;&gt;&lt;/a&gt;pprofå·¥å…·&lt;/h3&gt;&lt;p&gt;pprofå·¥å…·æ”¯æŒç½‘é¡µä¸ŠæŸ¥çœ‹å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œéœ€è¦åœ¨ä»£ç ä¸­æ·»åŠ ä¸€ä¸ªåç¨‹å³å¯ã€‚&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;net/http&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _ &lt;span class=&quot;string&quot;&gt;&quot;net/http/pprof&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(http.ListenAndServe(&lt;span class=&quot;string&quot;&gt;&quot;0.0.0.0:10000&quot;&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å…·ä½“æ·»åŠ çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//demo3.go&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;log&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;runtime&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;net/http&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _ &lt;span class=&quot;string&quot;&gt;&quot;net/http/pprof&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;readMemStats&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; ms runtime.MemStats&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    runtime.ReadMemStats(&amp;amp;ms)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Printf(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; Alloc:%d(bytes) HeapIdle:%d(bytes) HeapReleased:%d(bytes)&quot;&lt;/span&gt;, ms.Alloc, ms.HeapIdle, ms.HeapReleased)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//slice ä¼šåŠ¨æ€æ‰©å®¹ï¼Œç”¨sliceæ¥åšå †å†…å­˜ç”³è¯·&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    container := &lt;span class=&quot;built_in&quot;&gt;make&lt;/span&gt;([]&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; loop begin.&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;32&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        container = &lt;span class=&quot;built_in&quot;&gt;append&lt;/span&gt;(container, i)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ( i == &lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            readMemStats()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; loop end.&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//å¯åŠ¨pprof&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        log.Println(http.ListenAndServe(&lt;span class=&quot;string&quot;&gt;&quot;0.0.0.0:10000&quot;&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; [Start].&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    readMemStats()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    test()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    readMemStats()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; [force gc].&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    runtime.GC() &lt;span class=&quot;comment&quot;&gt;//å¼ºåˆ¶è°ƒç”¨gcå›æ”¶&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; [Done].&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    readMemStats()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            readMemStats()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            time.Sleep(&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt; * time.Second)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    time.Sleep(&lt;span class=&quot;number&quot;&gt;3600&lt;/span&gt; * time.Second) &lt;span class=&quot;comment&quot;&gt;//ç¡çœ ï¼Œä¿æŒç¨‹åºä¸é€€å‡º&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬æ­£å¸¸è¿è¡Œç¨‹åºï¼Œç„¶ååŒæ—¶æ‰“å¼€æµè§ˆå™¨ï¼Œ&lt;/p&gt;
&lt;p&gt;è¾“å…¥åœ°å€ï¼š&lt;a href=&quot;http://127.0.0.1:10000/debug/pprof/heap?debug=1&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://127.0.0.1:10000/debug/pprof/heap?debug=1&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æµè§ˆå™¨çš„å†…å®¹å…¶ä¸­æœ‰ä¸€éƒ¨åˆ†å¦‚ä¸‹ï¼Œè®°å½•äº†ç›®å‰çš„å†…å­˜æƒ…å†µ&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# runtime.MemStats&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Alloc = 228248&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# TotalAlloc = 1293696976&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Sys = 834967896&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Lookups = 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Mallocs = 2018&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Frees = 671&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# HeapAlloc = 228248&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# HeapSys = 804913152&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# HeapIdle = 804102144&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# HeapInuse = 811008&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# HeapReleased = 108552192&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# HeapObjects = 1347&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Stack = 360448 / 360448&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# MSpan = 28288 / 32768&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# MCache = 3472 / 16384&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# BuckHashSys = 1449617&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# GCSys = 27418976&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# OtherSys = 776551&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# NextGC = 4194304&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# LastGC = 1583203571137891390&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;åœºæ™¯3-å¦‚ä½•åˆ†æGolangç¨‹åºçš„CPUæ€§èƒ½æƒ…å†µï¼Ÿ&quot;&gt;&lt;a href=&quot;#åœºæ™¯3-å¦‚ä½•åˆ†æGolangç¨‹åºçš„CPUæ€§èƒ½æƒ…å†µï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;åœºæ™¯3: å¦‚ä½•åˆ†æGolangç¨‹åºçš„CPUæ€§èƒ½æƒ…å†µï¼Ÿ&quot;&gt;&lt;/a&gt;åœºæ™¯3: å¦‚ä½•åˆ†æGolangç¨‹åºçš„CPUæ€§èƒ½æƒ…å†µï¼Ÿ&lt;/h2&gt;&lt;h3 id=&quot;æ€§èƒ½åˆ†ææ³¨æ„äº‹é¡¹&quot;&gt;&lt;a href=&quot;#æ€§èƒ½åˆ†ææ³¨æ„äº‹é¡¹&quot; class=&quot;headerlink&quot; title=&quot;æ€§èƒ½åˆ†ææ³¨æ„äº‹é¡¹&quot;&gt;&lt;/a&gt;æ€§èƒ½åˆ†ææ³¨æ„äº‹é¡¹&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;æ€§èƒ½åˆ†æå¿…é¡»åœ¨ä¸€ä¸ªå¯é‡å¤çš„ã€ç¨³å®šçš„ç¯å¢ƒä¸­æ¥è¿›è¡Œã€‚&lt;/li&gt;
&lt;li&gt;æœºå™¨å¿…é¡»é—²ç½®&lt;ul&gt;
&lt;li&gt;ä¸è¦åœ¨å…±äº«ç¡¬ä»¶ä¸Šè¿›è¡Œæ€§èƒ½åˆ†æ;&lt;/li&gt;
&lt;li&gt;ä¸è¦åœ¨æ€§èƒ½åˆ†ææœŸé—´ï¼Œåœ¨åŒä¸€ä¸ªæœºå™¨ä¸Šå»æµè§ˆç½‘é¡µ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;æ³¨æ„çœç”µæ¨¡å¼å’Œè¿‡çƒ­ä¿æŠ¤ï¼Œå¦‚æœçªç„¶è¿›å…¥è¿™äº›æ¨¡å¼ï¼Œä¼šå¯¼è‡´åˆ†ææ•°æ®ä¸¥é‡ä¸å‡†ç¡®&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ä¸è¦ä½¿ç”¨è™šæ‹Ÿæœºã€å…±äº«çš„äº‘ä¸»æœº&lt;/strong&gt;ï¼Œå¤ªå¤šå¹²æ‰°å› ç´ ï¼Œåˆ†ææ•°æ®ä¼šå¾ˆä¸ä¸€è‡´&lt;/li&gt;
&lt;li&gt;ä¸è¦åœ¨ macOS 10.11 åŠä»¥å‰çš„ç‰ˆæœ¬è¿è¡Œæ€§èƒ½åˆ†æï¼Œæœ‰ bugï¼Œä¹‹åçš„ç‰ˆæœ¬ä¿®å¤äº†&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¦‚æœæ‰¿å—å¾—èµ·ï¼Œè´­ä¹°ä¸“ç”¨çš„æ€§èƒ½æµ‹è¯•åˆ†æçš„ç¡¬ä»¶è®¾å¤‡ï¼Œä¸Šæ¶ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å…³é—­ç”µæºç®¡ç†ã€è¿‡çƒ­ç®¡ç†&lt;/li&gt;
&lt;li&gt;ç»ä¸è¦å‡çº§ï¼Œä»¥ä¿è¯æµ‹è¯•çš„ä¸€è‡´æ€§ï¼Œä»¥åŠå…·æœ‰å¯æ¯”æ€§&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¦‚æœæ²¡æœ‰è¿™æ ·çš„ç¯å¢ƒï¼Œé‚£å°±ä¸€å®šè¦åœ¨å¤šä¸ªç¯å¢ƒä¸­ï¼Œæ‰§è¡Œå¤šæ¬¡ï¼Œä»¥å–å¾—å¯å‚è€ƒçš„ã€å…·æœ‰ç›¸å¯¹ä¸€è‡´æ€§çš„æµ‹è¯•ç»“æœã€‚&lt;/p&gt;
&lt;h3 id=&quot;CPUæ€§èƒ½åˆ†æ&quot;&gt;&lt;a href=&quot;#CPUæ€§èƒ½åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;CPUæ€§èƒ½åˆ†æ&quot;&gt;&lt;/a&gt;CPUæ€§èƒ½åˆ†æ&lt;/h3&gt;&lt;p&gt;æˆ‘ä»¬æ¥ç”¨ä¸‹é¢çš„ä»£ç è¿›è¡Œæµ‹è¯•&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//demo4.go&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;bytes&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;math/rand&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;time&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;log&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;net/http&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _ &lt;span class=&quot;string&quot;&gt;&quot;net/http/pprof&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; loop begin.&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        log.Println(genSomeBytes())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    log.Println(&lt;span class=&quot;string&quot;&gt;&quot; ===&amp;gt; loop end.&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;genSomeBytes&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;bytes&lt;/span&gt;.&lt;span class=&quot;title&quot;&gt;Buffer&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; buff bytes.Buffer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i := &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;20000&lt;/span&gt;; i++ &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        buff.Write([]&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;&amp;#123;&lt;span class=&quot;string&quot;&gt;&#39;0&#39;&lt;/span&gt; + &lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;(rand.Intn(&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;))&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &amp;amp;buff&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            test()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            time.Sleep(time.Second * &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//å¯åŠ¨pprof&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    http.ListenAndServe(&lt;span class=&quot;string&quot;&gt;&quot;0.0.0.0:10000&quot;&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œé¢è¿˜æ˜¯å¯åŠ¨äº†pprofçš„åšæŒº,æœ‰å…³&lt;code&gt;pprof&lt;/code&gt;å¯åŠ¨çš„ä»£ç å¦‚ä¸‹:&lt;br&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;net/http&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _ &lt;span class=&quot;string&quot;&gt;&quot;net/http/pprof&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//å¯åŠ¨pprof&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  http.ListenAndServe(&lt;span class=&quot;string&quot;&gt;&quot;0.0.0.0:10000&quot;&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;main()&lt;/code&gt;é‡Œçš„æµç¨‹å¾ˆç®€å•,å¯åŠ¨ä¸€ä¸ªgoroutineå»æ— é™å¾ªç¯è°ƒç”¨&lt;code&gt;test()&lt;/code&gt;æ–¹æ³•,ä¼‘çœ 1s.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;test()&lt;/code&gt;çš„æµç¨‹æ˜¯ç”Ÿæˆ1000ä¸ª20000ä¸ªå­—ç¬¦çš„éšæœºå­—ç¬¦ä¸².å¹¶ä¸”æ‰“å°.&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å°†ä¸Šé¢çš„ä»£ç ç¼–è¯‘æˆå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ &lt;code&gt;demo4&lt;/code&gt;(è®°ä½è¿™ä¸ªåå­—,ç¨åæˆ‘ä»¬èƒ½ç”¨åˆ°)&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ go build demo4.go&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ¥ä¸‹æ¥æˆ‘ä»¬å¯åŠ¨ç¨‹åº,ç¨‹åºä¼šæ— é™å¾ªç¯çš„æ‰“å°å­—ç¬¦ä¸².&lt;/p&gt;
&lt;p&gt;æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡å‡ ç§æ–¹å¼æ¥æŸ¥çœ‹è¿›ç¨‹çš„cpuæ€§èƒ½æƒ…å†µ.&lt;/p&gt;
&lt;h4 id=&quot;A-Webç•Œé¢æŸ¥çœ‹&quot;&gt;&lt;a href=&quot;#A-Webç•Œé¢æŸ¥çœ‹&quot; class=&quot;headerlink&quot; title=&quot;A. Webç•Œé¢æŸ¥çœ‹&quot;&gt;&lt;/a&gt;A. Webç•Œé¢æŸ¥çœ‹&lt;/h4&gt;&lt;p&gt;æµè§ˆå™¨è®¿é—®: &lt;a href=&quot;http://127.0.0.1:10000/debug/pprof/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://127.0.0.1:10000/debug/pprof/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬ä¼šçœ‹åˆ°å¦‚ä¸‹ç”»é¢&lt;br&gt;&lt;img src=&quot;/images/go/godebug_2.png&quot; alt=&quot;go pprof web&quot;&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œé¢èƒ½å¤Ÿé€šè¿‡pprofæŸ¥çœ‹åŒ…æ‹¬(é˜»å¡ä¿¡æ¯ã€cpuä¿¡æ¯ã€å†…å­˜å †ä¿¡æ¯ã€é”ä¿¡æ¯ã€goroutineä¿¡æ¯ç­‰ç­‰), æˆ‘ä»¬è¿™é‡Œå…³å¿ƒçš„cpuçš„æ€§èƒ½çš„&lt;code&gt;profile&lt;/code&gt;ä¿¡æ¯.&lt;/p&gt;
&lt;p&gt;æœ‰å…³&lt;code&gt;profile&lt;/code&gt;ä¸‹é¢çš„è‹±æ–‡è§£é‡Šå¤§è‡´å¦‚ä¸‹:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;â€œCPUé…ç½®æ–‡ä»¶ã€‚æ‚¨å¯ä»¥åœ¨ç§’GETå‚æ•°ä¸­æŒ‡å®šæŒç»­æ—¶é—´ã€‚è·å–æ¦‚è¦æ–‡ä»¶åï¼Œè¯·ä½¿ç”¨go tool pprofå‘½ä»¤è°ƒæŸ¥æ¦‚è¦æ–‡ä»¶ã€‚â€&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æ‰€ä»¥æˆ‘ä»¬è¦æ˜¯æƒ³å¾—åˆ°cpuæ€§èƒ½,å°±æ˜¯è¦è·å–åˆ°å½“å‰è¿›ç¨‹çš„&lt;code&gt;profile&lt;/code&gt;æ–‡ä»¶,è¿™ä¸ªæ–‡ä»¶é»˜è®¤æ˜¯30sç”Ÿæˆä¸€ä¸ª,æ‰€ä»¥ä½ çš„ç¨‹åºè¦è‡³å°‘è¿è¡Œ30sä»¥ä¸Š(è¿™ä¸ªå‚æ•°ä¹Ÿå¯ä»¥ä¿®æ”¹,ç¨åæˆ‘ä»¬ä»‹ç»)&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å¯ä»¥ç›´æ¥ç‚¹å‡»ç½‘é¡µçš„&lt;code&gt;profile&lt;/code&gt;,æµè§ˆå™¨ä¼šç»™æˆ‘ä»¬ä¸‹è½½ä¸€ä¸ª&lt;code&gt;profile&lt;/code&gt;æ–‡ä»¶. è®°ä½è¿™ä¸ªæ–‡ä»¶çš„è·¯å¾„, å¯ä»¥æ‹·è´åˆ°ä¸&lt;code&gt;demo4&lt;/code&gt;æ‰€åœ¨çš„åŒä¸€æ–‡ä»¶å¤¹ä¸‹.&lt;/p&gt;
&lt;h4 id=&quot;B-ä½¿ç”¨pprofå·¥å…·æŸ¥çœ‹&quot;&gt;&lt;a href=&quot;#B-ä½¿ç”¨pprofå·¥å…·æŸ¥çœ‹&quot; class=&quot;headerlink&quot; title=&quot;B. ä½¿ç”¨pprofå·¥å…·æŸ¥çœ‹&quot;&gt;&lt;/a&gt;B. ä½¿ç”¨pprofå·¥å…·æŸ¥çœ‹&lt;/h4&gt;&lt;p&gt;pprof çš„æ ¼å¼å¦‚ä¸‹&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof [binary] [profile]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;binary&lt;/code&gt;: å¿…é¡»æŒ‡å‘ç”Ÿæˆè¿™ä¸ªæ€§èƒ½åˆ†ææ•°æ®çš„é‚£ä¸ªäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;profile&lt;/code&gt;: å¿…é¡»æ˜¯è¯¥äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶æ‰€ç”Ÿæˆçš„æ€§èƒ½åˆ†ææ•°æ®æ–‡ä»¶ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;binary&lt;/code&gt; å’Œ &lt;code&gt;profile&lt;/code&gt; &lt;strong&gt;å¿…é¡»ä¸¥æ ¼åŒ¹é…&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬æ¥æŸ¥çœ‹ä¸€ä¸‹:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ go tool pprof ./demo4 profile&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;File: demo4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Type: cpu&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Time: Mar 3, 2020 at 11:18pm (CST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Duration: 30.13s, Total samples = 6.27s (20.81%)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Entering interactive mode (&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;help&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; commands, &lt;span class=&quot;string&quot;&gt;&quot;o&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; options)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;help&lt;/strong&gt;å¯ä»¥æŸ¥çœ‹ä¸€äº›æŒ‡ä»¤,æˆ‘ä¹ˆå¯ä»¥é€šè¿‡&lt;strong&gt;top&lt;/strong&gt;æ¥æŸ¥çœ‹cpuçš„æ€§èƒ½æƒ…å†µ.&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(pprof) top&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Showing nodes accounting &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 5090ms, 81.18% of 6270ms total&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Dropped 80 nodes (cum &amp;lt;= 31.35ms)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Showing top 10 nodes out of 60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      flat  flat%   sum%        cum   cum%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    1060ms 16.91% 16.91%     2170ms 34.61%  math/rand.(*lockedSource).Int63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     850ms 13.56% 30.46%      850ms 13.56%  sync.(*Mutex).Unlock (inline)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     710ms 11.32% 41.79%     2950ms 47.05%  math/rand.(*Rand).Int31n&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     570ms  9.09% 50.88%      990ms 15.79%  bytes.(*Buffer).Write&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     530ms  8.45% 59.33%      540ms  8.61%  syscall.Syscall&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     370ms  5.90% 65.23%      370ms  5.90%  runtime.procyield&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     270ms  4.31% 69.54%     4490ms 71.61%  main.genSomeBytes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     250ms  3.99% 73.52%     3200ms 51.04%  math/rand.(*Rand).Intn&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     250ms  3.99% 77.51%      250ms  3.99%  runtime.memmove&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     230ms  3.67% 81.18%      690ms 11.00%  runtime.suspendG&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œé¢æœ‰å‡ åˆ—æ•°æ®,éœ€è¦è¯´æ˜ä¸€ä¸‹.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;flatï¼šå½“å‰å‡½æ•°å ç”¨CPUçš„è€—æ—¶&lt;/li&gt;
&lt;li&gt;flat%ï¼š:å½“å‰å‡½æ•°å ç”¨CPUçš„è€—æ—¶ç™¾åˆ†æ¯”&lt;/li&gt;
&lt;li&gt;sun%ï¼šå‡½æ•°å ç”¨CPUçš„è€—æ—¶ç´¯è®¡ç™¾åˆ†æ¯”&lt;/li&gt;
&lt;li&gt;cumï¼šå½“å‰å‡½æ•°åŠ ä¸Šè°ƒç”¨å½“å‰å‡½æ•°çš„å‡½æ•°å ç”¨CPUçš„æ€»è€—æ—¶&lt;/li&gt;
&lt;li&gt;cum%ï¼šå½“å‰å‡½æ•°åŠ ä¸Šè°ƒç”¨å½“å‰å‡½æ•°çš„å‡½æ•°å ç”¨CPUçš„æ€»è€—æ—¶ç™¾åˆ†æ¯”&lt;/li&gt;
&lt;li&gt;æœ€åä¸€åˆ—ï¼šå‡½æ•°åç§°&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;é€šè¿‡ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹å‡º, è¯¥ç¨‹åºçš„å¤§éƒ¨åˆ†cpuæ€§èƒ½æ¶ˆè€—åœ¨ &lt;code&gt;main.getSoneBytes()&lt;/code&gt;æ–¹æ³•ä¸­,å…¶ä¸­math/randå–éšæœºæ•°æ¶ˆè€—æ¯”è¾ƒå¤§.&lt;/p&gt;
&lt;h4 id=&quot;C-é€šè¿‡go-tool-pprofå¾—åˆ°profileæ–‡ä»¶&quot;&gt;&lt;a href=&quot;#C-é€šè¿‡go-tool-pprofå¾—åˆ°profileæ–‡ä»¶&quot; class=&quot;headerlink&quot; title=&quot;C. é€šè¿‡go tool pprofå¾—åˆ°profileæ–‡ä»¶&quot;&gt;&lt;/a&gt;C. é€šè¿‡go tool pprofå¾—åˆ°profileæ–‡ä»¶&lt;/h4&gt;&lt;p&gt;æˆ‘ä»¬ä¸Šé¢çš„profileæ–‡ä»¶æ˜¯é€šè¿‡webæµè§ˆå™¨ä¸‹è½½çš„,è¿™ä¸ªprofileçš„ç»è¿‡æ—¶é—´æ˜¯30sçš„,é»˜è®¤å€¼æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸Šä¿®æ”¹ä¸äº†,å¦‚æœä½ æƒ³å¾—åˆ°æ—¶é—´æ›´é•¿çš„cpuåˆ©ç”¨ç‡,å¯ä»¥é€šè¿‡&lt;code&gt;go tool pprof&lt;/code&gt;æŒ‡ä»¤ä¸ç¨‹åºäº¤äº’æ¥è·å–åˆ°&lt;/p&gt;
&lt;p&gt;é¦–å…ˆ,æˆ‘ä»¬å…ˆå¯åŠ¨ç¨‹åº&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ ./demo4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç„¶åå†æ‰“å¼€ä¸€ä¸ªç»ˆç«¯&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go tool pprof http://localhost:10000/debug/pprof/profile?seconds=60&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œåˆ¶å®šäº†ç”Ÿæˆprofileæ–‡ä»¶çš„æ—¶é—´é—´éš”60s&lt;/p&gt;
&lt;p&gt;ç­‰å¾…60sä¹‹å, ç»ˆç«¯å°±ä¼šæœ‰ç»“æœå‡ºæ¥,æˆ‘ä»¬ç»§ç»­ä½¿ç”¨topæ¥æŸ¥çœ‹.&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ go tool pprof http://localhost:10000/debug/pprof/profile?seconds=60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Fetching profile over HTTP from http://localhost:10000/debug/pprof/profile?seconds=60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Saved profile &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; /home/itheima/pprof/pprof.demo4.samples.cpu.005.pb.gz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;File: demo4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Type: cpu&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Time: Mar 3, 2020 at 11:59pm (CST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Duration: 1mins, Total samples = 12.13s (20.22%)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Entering interactive mode (&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;help&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; commands, &lt;span class=&quot;string&quot;&gt;&quot;o&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; options)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof) top&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Showing nodes accounting &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 9940ms, 81.95% of 12130ms total&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Dropped 110 nodes (cum &amp;lt;= 60.65ms)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Showing top 10 nodes out of 56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      flat  flat%   sum%        cum   cum%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    2350ms 19.37% 19.37%     4690ms 38.66%  math/rand.(*lockedSource).Int63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    1770ms 14.59% 33.97%     1770ms 14.59%  sync.(*Mutex).Unlock (inline)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    1290ms 10.63% 44.60%     6040ms 49.79%  math/rand.(*Rand).Int31n&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    1110ms  9.15% 53.75%     1130ms  9.32%  syscall.Syscall&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     810ms  6.68% 60.43%     1860ms 15.33%  bytes.(*Buffer).Write&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     620ms  5.11% 65.54%     6660ms 54.91%  math/rand.(*Rand).Intn&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     570ms  4.70% 70.24%      570ms  4.70%  runtime.procyield&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     500ms  4.12% 74.36%     9170ms 75.60%  main.genSomeBytes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     480ms  3.96% 78.32%      480ms  3.96%  runtime.memmove&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     440ms  3.63% 81.95%      440ms  3.63%  math/rand.(*rngSource).Uint64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä¾ç„¶ä¼šå¾—åˆ°cpuæ€§èƒ½çš„ç»“æœ, æˆ‘ä»¬å‘ç°è¿™æ¬¡çš„ç»“æœä¸ä¸Šæ¬¡30sçš„ç»“æœç™¾åˆ†æ¯”ç±»ä¼¼.&lt;/p&gt;
&lt;h4 id=&quot;D-å¯è§†åŒ–æŸ¥çœ‹&quot;&gt;&lt;a href=&quot;#D-å¯è§†åŒ–æŸ¥çœ‹&quot; class=&quot;headerlink&quot; title=&quot;D.å¯è§†åŒ–æŸ¥çœ‹&quot;&gt;&lt;/a&gt;D.å¯è§†åŒ–æŸ¥çœ‹&lt;/h4&gt;&lt;p&gt;æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ go tool pprof ./demo4 profile&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿›å…¥profileæ–‡ä»¶æŸ¥çœ‹,ç„¶åæˆ‘ä»¬è¾“å…¥&lt;code&gt;web&lt;/code&gt;æŒ‡ä»¤.&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ go tool pprof ./demo4 profileFile: demo4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Type: cpu&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Time: Mar 3, 2020 at 11:18pm (CST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Duration: 30.13s, Total samples = 6.27s (20.81%)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Entering interactive mode (&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;help&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; commands, &lt;span class=&quot;string&quot;&gt;&quot;o&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; options)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(pprof) web&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œå¦‚æœæŠ¥æ‰¾ä¸åˆ°&lt;code&gt;graphviz&lt;/code&gt;å·¥å…·ï¼Œéœ€è¦å®‰è£…ä¸€ä¸‹ã€‚è¿™é‡Œè‡ªè¡Œç™¾åº¦å¦‚ä½•å®‰è£…&lt;/p&gt;
&lt;p&gt;ç„¶åæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ª&lt;code&gt;svg&lt;/code&gt;çš„å¯è§†åŒ–æ–‡ä»¶åœ¨&lt;code&gt;/tmp&lt;/code&gt;è·¯å¾„ä¸‹&lt;br&gt;&lt;img src=&quot;/images/go/godebug_3.png&quot; alt=&quot;go pprof web&quot;&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ ·æˆ‘ä»¬å°±èƒ½æ¯”è¾ƒæ¸…æ™°çš„çœ‹åˆ°å‡½æ•°ä¹‹é—´çš„è°ƒç”¨å…³ç³»,æ–¹å—è¶Šå¤§çš„è¡¨ç¤ºcpuçš„å ç”¨è¶Šå¤§.&lt;/p&gt;
&lt;p&gt;æ¥æºï¼šåˆ˜ä¸¹å†°Aceld ç®€ä¹¦&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;å¾®ä¿¡è®¢é˜…å·&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;åœºæ™¯1ï¼š-å¦‚ä½•åˆ†æç¨‹åºçš„è¿è¡Œæ—¶é—´ä¸CPUåˆ©ç”¨ç‡æƒ…å†µï¼Ÿ&quot;&gt;&lt;a href=&quot;#åœºæ™¯1ï¼š-å¦‚ä½•åˆ†æç¨‹åºçš„è¿è¡Œæ—¶é—´ä¸CPUåˆ©ç”¨ç‡æƒ…å†µï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;åœºæ™¯1ï¼š å¦‚ä½•åˆ†æç¨‹åºçš„è¿è¡Œæ—¶é—´ä¸CPUåˆ©ç”¨ç‡æƒ…å†µï¼Ÿ&quot;&gt;&lt;/a&gt;åœºæ™¯1ï¼š å¦‚ä½•åˆ†æç¨‹åºçš„è¿è¡Œæ—¶é—´ä¸CPUåˆ©ç”¨ç‡æƒ…å†µï¼Ÿ&lt;/h2&gt;&lt;h3 id=&quot;shellå†…ç½®timeæŒ‡ä»¤&quot;&gt;&lt;a href=&quot;#shellå†…ç½®timeæŒ‡ä»¤&quot; class=&quot;headerlink&quot; title=&quot;shellå†…ç½®timeæŒ‡ä»¤&quot;&gt;&lt;/a&gt;shellå†…ç½®timeæŒ‡ä»¤&lt;/h3&gt;&lt;p&gt;è¿™ä¸ªæ–¹æ³•ä¸ç®—æ–°é¢–ï¼Œä½†æ˜¯ç¡®å¾ˆå®ç”¨ã€‚ timeæ˜¯Unix/Linuxå†…ç½®å¤šå‘½ä»¤ï¼Œä½¿ç”¨æ—¶ä¸€èˆ¬ä¸ç”¨ä¼ è¿‡å¤šå‚æ•°ï¼Œç›´æ¥è·Ÿä¸Šéœ€è¦è°ƒè¯•å¤šç¨‹åºå³å¯ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ time go run &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;2.go &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;amp;&amp;#123;&amp;#123;0 0&amp;#125; å¼ ä¸‰ 0&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;real    0m0.843s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;user    0m0.216s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sys 0m0.389s&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šé¢æ˜¯ä½¿ç”¨timeå¯¹ &lt;code&gt;go run test2.go&lt;/code&gt; å¯¹æ‰§è¡Œç¨‹åºåäº†æ€§èƒ½åˆ†æï¼Œå¾—åˆ°3ä¸ªæŒ‡æ ‡ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;real&lt;/code&gt;ï¼šä»ç¨‹åºå¼€å§‹åˆ°ç»“æŸï¼Œå®é™…åº¦è¿‡çš„æ—¶é—´ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;user&lt;/code&gt;ï¼šç¨‹åºåœ¨ç”¨æˆ·æ€åº¦è¿‡çš„æ—¶é—´ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sys&lt;/code&gt;ï¼šç¨‹åºåœ¨å†…æ ¸æ€åº¦è¿‡çš„æ—¶é—´&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸€èˆ¬æƒ…å†µä¸‹ &lt;code&gt;real&lt;/code&gt; &amp;gt;= &lt;code&gt;user&lt;/code&gt; + &lt;code&gt;sys&lt;/code&gt;ï¼Œå› ä¸ºç³»ç»Ÿè¿˜æœ‰å…¶å®ƒè¿›ç¨‹(åˆ‡æ¢å…¶ä»–è¿›ç¨‹ä¸­é—´å¯¹äºæœ¬è¿›ç¨‹å›æœ‰ç©ºç™½æœŸ)ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="golang" scheme="http://team.jiunile.com/categories/golang/"/>
    
      <category term="debug" scheme="http://team.jiunile.com/categories/golang/debug/"/>
    
    
      <category term="golang" scheme="http://team.jiunile.com/tags/golang/"/>
    
      <category term="pprof" scheme="http://team.jiunile.com/tags/pprof/"/>
    
      <category term="go" scheme="http://team.jiunile.com/tags/go/"/>
    
      <category term="godebug" scheme="http://team.jiunile.com/tags/godebug/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Etcd æ•°æ®å¤‡ä»½ä¸æ¢å¤</title>
    <link href="http://team.jiunile.com//blog/2020/05/k8s-etcd-backup-restore.html"/>
    <id>http://team.jiunile.com//blog/2020/05/k8s-etcd-backup-restore.html</id>
    <published>2020-05-09T11:00:00.000Z</published>
    <updated>2020-05-09T07:29:57.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;ç³»ç»Ÿç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#ç³»ç»Ÿç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;ç³»ç»Ÿç¯å¢ƒ&quot;&gt;&lt;/a&gt;ç³»ç»Ÿç¯å¢ƒ&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Etcd ç‰ˆæœ¬ï¼š3.4.3&lt;br&gt;Kubernetes ç‰ˆæœ¬ï¼š1.17.4&lt;br&gt;Kubernetes å®‰è£…æ–¹å¼ï¼šKubeadm&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;Kubernetes ä½¿ç”¨ Etcd æ•°æ®åº“å®æ—¶å­˜å‚¨é›†ç¾¤ä¸­çš„æ•°æ®ï¼Œå¯ä»¥è¯´ Etcd æ˜¯ Kubernetes çš„æ ¸å¿ƒç»„ä»¶ï¼ŒçŠ¹å¦‚äººç±»çš„å¤§è„‘ã€‚å¦‚æœ Etcd æ•°æ®æŸåå°†å¯¼è‡´ Kubernetes ä¸å¯ç”¨ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ Etcd æ•°æ®æ˜¯ä¸€å®šè¦åšå¥½é«˜å¯ç”¨ä¸æ•°æ®å¤‡ä»½ï¼Œè¿™é‡Œä»‹ç»ä¸‹å¦‚ä½•å¤‡ä»½ä¸æ¢å¤ Etcd æ•°æ®ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å¤‡ä»½-Etcd-æ•°æ®&quot;&gt;&lt;a href=&quot;#å¤‡ä»½-Etcd-æ•°æ®&quot; class=&quot;headerlink&quot; title=&quot;å¤‡ä»½ Etcd æ•°æ®&quot;&gt;&lt;/a&gt;å¤‡ä»½ Etcd æ•°æ®&lt;/h2&gt;&lt;p&gt;é‡‡ç”¨é•œåƒæ–¹å¼éƒ¨ç½²çš„ Etcdï¼Œæ‰€ä»¥æ“ä½œ Etcd éœ€è¦ä½¿ç”¨ Etcd é•œåƒæä¾›çš„ Etcdctl å·¥å…·ã€‚å¦‚æœä½ æ˜¯éé•œåƒæ–¹å¼éƒ¨ç½² Etcdï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ Etcdctl å‘½ä»¤å¤‡ä»½æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;è¿è¡Œ Etcd é•œåƒï¼Œå¹¶ä¸”ä½¿ç”¨é•œåƒå†…éƒ¨çš„ etcdctl å·¥å…·è¿æ¥ etcd é›†ç¾¤ï¼Œæ‰§è¡Œæ•°æ®å¿«ç…§å¤‡ä»½ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;/bin/sh -cï¼šæ‰§è¡Œ shell å‘½ä»¤&lt;/li&gt;
&lt;li&gt;â€“envï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®š etcdctl å·¥å…·ä½¿ç”¨çš„ API ç‰ˆæœ¬&lt;/li&gt;
&lt;li&gt;-vï¼šdocker æŒ‚è½½é€‰é¡¹ï¼Œç”¨äºæŒ‚è½½ Etcd è¯ä¹¦ç›¸å…³ç›®å½•ä»¥åŠå¤‡ä»½æ•°æ®å­˜æ”¾çš„ç›®å½•&lt;/li&gt;
&lt;li&gt;â€“cacertï¼šetcd CA è¯ä¹¦&lt;/li&gt;
&lt;li&gt;â€“keyï¼šetcd å®¢æˆ·ç«¯è¯ä¹¦ key&lt;/li&gt;
&lt;li&gt;â€“certï¼šetcd å®¢æˆ·ç«¯è¯ä¹¦ crt&lt;/li&gt;
&lt;li&gt;â€“endpointsï¼šæŒ‡å®š ETCD è¿æ¥åœ°å€&lt;/li&gt;
&lt;li&gt;etcdctl snapshot saveï¼šetcd æ•°æ®å¤‡ä»½&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ docker run --rm                                    \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-v /data/backup:/backup                              \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-v /etc/kubernetes/pki/etcd:/etc/kubernetes/pki/etcd \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--env ETCDCTL_API=3                                  \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;k8s.gcr.io/etcd:3.4.3-0                              \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/bin/sh -c &lt;span class=&quot;string&quot;&gt;&quot;etcdctl --endpoints=https://192.168.2.11:2379 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--cacert=/etc/kubernetes/pki/etcd/ca.crt                  \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--key=/etc/kubernetes/pki/etcd/healthcheck-client.key     \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt    \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;snapshot save /backup/etcd-snapshot.db&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;æ¢å¤-ETCD-æ•°æ®&quot;&gt;&lt;a href=&quot;#æ¢å¤-ETCD-æ•°æ®&quot; class=&quot;headerlink&quot; title=&quot;æ¢å¤ ETCD æ•°æ®&quot;&gt;&lt;/a&gt;æ¢å¤ ETCD æ•°æ®&lt;/h2&gt;&lt;p&gt;åœ¨ Etcd æ•°æ®æŸåæ—¶ï¼Œå¯ä»¥é€šè¿‡ Etcd å¤‡ä»½æ•°æ®è¿›è¡Œæ•°æ®æ¢å¤ï¼Œå…ˆæš‚åœ Kubernetes ç›¸å…³ç»„ä»¶ï¼Œç„¶åè¿›å…¥ Etcd é•œåƒä½¿ç”¨ etcdctl å·¥å…·æ‰§è¡Œæ¢å¤æ“ä½œã€‚&lt;/p&gt;
&lt;h3 id=&quot;æš‚åœ-Kube-Apiserver-ä¸-Etcd-é•œåƒ&quot;&gt;&lt;a href=&quot;#æš‚åœ-Kube-Apiserver-ä¸-Etcd-é•œåƒ&quot; class=&quot;headerlink&quot; title=&quot;æš‚åœ Kube-Apiserver ä¸ Etcd é•œåƒ&quot;&gt;&lt;/a&gt;æš‚åœ Kube-Apiserver ä¸ Etcd é•œåƒ&lt;/h3&gt;&lt;p&gt;åœ¨æ¢å¤ Etcd æ•°æ®å‰ï¼Œéœ€è¦åœæ­¢ &lt;code&gt;kube-apiserver&lt;/code&gt; ä¸ &lt;code&gt;etcd&lt;/code&gt; é•œåƒï¼Œå› ä¸ºå½“è¿™ä¿©é•œåƒåœæ­¢å Kubernetes ä¼šè‡ªåŠ¨é‡å¯è¿™ä¿©é•œåƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆæš‚æ—¶ç§»é™¤ &lt;code&gt;/etc/kubernetes/manifests&lt;/code&gt; ç›®å½•ï¼ŒKubernetes æ£€æµ‹è¿™ä¸ªç›®å½•æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä¼šåœæ­¢ Kubernetes ç³»ç»Ÿç›¸å…³é•œåƒï¼Œä½¿å…¶ä¸èƒ½é‡å¯ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œåç»­çš„æ“ä½œã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ç§»é™¤ä¸”å¤‡ä»½ /etc/kubernetes/manifests ç›®å½•&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ mv /etc/kubernetes/manifests /etc/kubernetes/manifests.bak&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# æŸ¥çœ‹ kube-apiserverã€etcd é•œåƒæ˜¯å¦åœæ­¢&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ docker ps|grep etcd &amp;amp;&amp;amp; docker ps|grep kube-apiserver&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# å¤‡ä»½ç°æœ‰ Etcd æ•°æ®&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ mv /var/lib/etcd /var/lib/etcd.bak&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;æ¢å¤-Etcd-æ•°æ®&quot;&gt;&lt;a href=&quot;#æ¢å¤-Etcd-æ•°æ®&quot; class=&quot;headerlink&quot; title=&quot;æ¢å¤ Etcd æ•°æ®&quot;&gt;&lt;/a&gt;æ¢å¤ Etcd æ•°æ®&lt;/h3&gt;&lt;p&gt;è¿è¡Œ Etcd é•œåƒï¼Œç„¶åæ‰§è¡Œæ•°æ®æ¢å¤ï¼Œé»˜è®¤ä¼šæ¢å¤åˆ° &lt;code&gt;/default.etcd/member/&lt;/code&gt; ç›®å½•ä¸‹ï¼Œè¿™é‡Œä½¿ç”¨ &lt;code&gt;mv&lt;/code&gt; å‘½ä»¤åœ¨ç§»åŠ¨åˆ°æŒ‚è½½ç›®å½• &lt;code&gt;/var/lib/etcd/&lt;/code&gt; ä¸‹ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;/bin/sh -cï¼šæ‰§è¡Œ shell å‘½ä»¤&lt;/li&gt;
&lt;li&gt;â€“envï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®š etcdctl å·¥å…·ä½¿ç”¨çš„ API ç‰ˆæœ¬&lt;/li&gt;
&lt;li&gt;-vï¼šdocker æŒ‚è½½é€‰é¡¹ï¼Œç”¨äºæŒ‚è½½ Etcd è¯ä¹¦ç›¸å…³ç›®å½•ä»¥åŠå¤‡ä»½æ•°æ®å­˜æ”¾çš„ç›®å½•&lt;/li&gt;
&lt;li&gt;etcdctl snapshot restoreï¼šetcd æ•°æ®æ¢å¤ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ docker run --rm              \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-v /data/backup:/backup        \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-v /var/lib/etcd:/var/lib/etcd \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--env ETCDCTL_API=3            \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;k8s.gcr.io/etcd:3.4.3-0        \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/bin/sh -c &lt;span class=&quot;string&quot;&gt;&quot;etcdctl snapshot restore /backup/etcd-snapshot.db; mv /default.etcd/member/ /var/lib/etcd/&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;æ¢å¤-Kube-Apiserver-ä¸-Etcd-é•œåƒ&quot;&gt;&lt;a href=&quot;#æ¢å¤-Kube-Apiserver-ä¸-Etcd-é•œåƒ&quot; class=&quot;headerlink&quot; title=&quot;æ¢å¤ Kube-Apiserver ä¸ Etcd é•œåƒ&quot;&gt;&lt;/a&gt;æ¢å¤ Kube-Apiserver ä¸ Etcd é•œåƒ&lt;/h3&gt;&lt;p&gt;å°† &lt;code&gt;/etc/kubernetes/manifests&lt;/code&gt; ç›®å½•æ¢å¤ï¼Œä½¿ Kubernetes é‡å¯ &lt;code&gt;Kube-Apiserver&lt;/code&gt; ä¸ &lt;code&gt;Etcd&lt;/code&gt; é•œåƒï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ mv /etc/kubernetes/manifests.bak /etc/kubernetes/manifests&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;æ‰§è¡Œ-Kubectl-å‘½ä»¤è¿›è¡Œæ£€æµ‹&quot;&gt;&lt;a href=&quot;#æ‰§è¡Œ-Kubectl-å‘½ä»¤è¿›è¡Œæ£€æµ‹&quot; class=&quot;headerlink&quot; title=&quot;æ‰§è¡Œ Kubectl å‘½ä»¤è¿›è¡Œæ£€æµ‹&quot;&gt;&lt;/a&gt;æ‰§è¡Œ Kubectl å‘½ä»¤è¿›è¡Œæ£€æµ‹&lt;/h3&gt;&lt;p&gt;æ‰§è¡Œ Kubectl å‘½ä»¤è¿›è¡Œæ£€æµ‹ï¼ŒæŸ¥çœ‹å‘½ä»¤æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl get node&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼šmydlq.club&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ç³»ç»Ÿç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#ç³»ç»Ÿç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;ç³»ç»Ÿç¯å¢ƒ&quot;&gt;&lt;/a&gt;ç³»ç»Ÿç¯å¢ƒ&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Etcd ç‰ˆæœ¬ï¼š3.4.3&lt;br&gt;Kubernetes ç‰ˆæœ¬ï¼š1.17.4&lt;br&gt;Kubernetes å®‰è£…æ–¹å¼ï¼šKubeadm&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;Kubernetes ä½¿ç”¨ Etcd æ•°æ®åº“å®æ—¶å­˜å‚¨é›†ç¾¤ä¸­çš„æ•°æ®ï¼Œå¯ä»¥è¯´ Etcd æ˜¯ Kubernetes çš„æ ¸å¿ƒç»„ä»¶ï¼ŒçŠ¹å¦‚äººç±»çš„å¤§è„‘ã€‚å¦‚æœ Etcd æ•°æ®æŸåå°†å¯¼è‡´ Kubernetes ä¸å¯ç”¨ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ Etcd æ•°æ®æ˜¯ä¸€å®šè¦åšå¥½é«˜å¯ç”¨ä¸æ•°æ®å¤‡ä»½ï¼Œè¿™é‡Œä»‹ç»ä¸‹å¦‚ä½•å¤‡ä»½ä¸æ¢å¤ Etcd æ•°æ®ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å¤‡ä»½-Etcd-æ•°æ®&quot;&gt;&lt;a href=&quot;#å¤‡ä»½-Etcd-æ•°æ®&quot; class=&quot;headerlink&quot; title=&quot;å¤‡ä»½ Etcd æ•°æ®&quot;&gt;&lt;/a&gt;å¤‡ä»½ Etcd æ•°æ®&lt;/h2&gt;&lt;p&gt;é‡‡ç”¨é•œåƒæ–¹å¼éƒ¨ç½²çš„ Etcdï¼Œæ‰€ä»¥æ“ä½œ Etcd éœ€è¦ä½¿ç”¨ Etcd é•œåƒæä¾›çš„ Etcdctl å·¥å…·ã€‚å¦‚æœä½ æ˜¯éé•œåƒæ–¹å¼éƒ¨ç½² Etcdï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ Etcdctl å‘½ä»¤å¤‡ä»½æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;è¿è¡Œ Etcd é•œåƒï¼Œå¹¶ä¸”ä½¿ç”¨é•œåƒå†…éƒ¨çš„ etcdctl å·¥å…·è¿æ¥ etcd é›†ç¾¤ï¼Œæ‰§è¡Œæ•°æ®å¿«ç…§å¤‡ä»½ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;/bin/sh -cï¼šæ‰§è¡Œ shell å‘½ä»¤&lt;/li&gt;
&lt;li&gt;â€“envï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®š etcdctl å·¥å…·ä½¿ç”¨çš„ API ç‰ˆæœ¬&lt;/li&gt;
&lt;li&gt;-vï¼šdocker æŒ‚è½½é€‰é¡¹ï¼Œç”¨äºæŒ‚è½½ Etcd è¯ä¹¦ç›¸å…³ç›®å½•ä»¥åŠå¤‡ä»½æ•°æ®å­˜æ”¾çš„ç›®å½•&lt;/li&gt;
&lt;li&gt;â€“cacertï¼šetcd CA è¯ä¹¦&lt;/li&gt;
&lt;li&gt;â€“keyï¼šetcd å®¢æˆ·ç«¯è¯ä¹¦ key&lt;/li&gt;
&lt;li&gt;â€“certï¼šetcd å®¢æˆ·ç«¯è¯ä¹¦ crt&lt;/li&gt;
&lt;li&gt;â€“endpointsï¼šæŒ‡å®š ETCD è¿æ¥åœ°å€&lt;/li&gt;
&lt;li&gt;etcdctl snapshot saveï¼šetcd æ•°æ®å¤‡ä»½&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ docker run --rm                                    \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-v /data/backup:/backup                              \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-v /etc/kubernetes/pki/etcd:/etc/kubernetes/pki/etcd \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--env ETCDCTL_API=3                                  \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;k8s.gcr.io/etcd:3.4.3-0                              \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/bin/sh -c &lt;span class=&quot;string&quot;&gt;&quot;etcdctl --endpoints=https://192.168.2.11:2379 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--cacert=/etc/kubernetes/pki/etcd/ca.crt                  \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--key=/etc/kubernetes/pki/etcd/healthcheck-client.key     \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt    \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;snapshot save /backup/etcd-snapshot.db&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/categories/kubernetes/"/>
    
      <category term="etcd" scheme="http://team.jiunile.com/categories/kubernetes/etcd/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/tags/kubernetes/"/>
    
      <category term="etcd" scheme="http://team.jiunile.com/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>Kubeadm æ·»åŠ æ–° Master èŠ‚ç‚¹åˆ°é›†ç¾¤å‡ºç° ETCD å¥åº·æ£€æŸ¥å¤±è´¥é”™è¯¯</title>
    <link href="http://team.jiunile.com//blog/2020/05/k8s-kubeadm-upgrade-master-problem.html"/>
    <id>http://team.jiunile.com//blog/2020/05/k8s-kubeadm-upgrade-master-problem.html</id>
    <published>2020-05-09T10:00:00.000Z</published>
    <updated>2020-05-09T06:51:09.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;ç³»ç»Ÿç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#ç³»ç»Ÿç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;ç³»ç»Ÿç¯å¢ƒ&quot;&gt;&lt;/a&gt;ç³»ç»Ÿç¯å¢ƒ&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Docker ç‰ˆæœ¬ï¼š18.06.3&lt;br&gt;Kubeadm ç‰ˆæœ¬ï¼š1.17.4&lt;br&gt;Kubernetes ç‰ˆæœ¬ï¼š1.17.4&lt;br&gt;Kubernetes Master æ•°é‡ï¼š3&lt;br&gt;Kubernetes å®‰è£…æ–¹å¼ï¼šKubeadm&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;a href=&quot;#é—®é¢˜æè¿°&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;/a&gt;é—®é¢˜æè¿°&lt;/h2&gt;&lt;p&gt;Kubernetes é›†ç¾¤ä¸­æ€»å…±æœ‰ä¸‰å° Masterï¼Œåˆ†åˆ«æ˜¯ï¼š&lt;/p&gt;
&lt;p&gt;k8s-master-2-11ã€k8s-master-2-12ã€k8s-master-2-13&lt;/p&gt;
&lt;p&gt;å¯¹å…¶ä¸­ k8s-master-2-11 Master èŠ‚ç‚¹æœåŠ¡å™¨è¿›è¡Œäº†å†…æ ¸å’Œè½¯ä»¶å‡çº§æ“ä½œï¼Œä»è€Œå…ˆå°†å…¶æš‚æ—¶å‰”å‡ºé›†ç¾¤ï¼Œç„¶åè¿›è¡Œå‡çº§ï¼Œå®Œæˆåå‡†å¤‡é‡æ–°åŠ å…¥åˆ° Kubernetes é›†ç¾¤ï¼Œé€šè¿‡ Kubeadm æ‰§è¡Œï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubeadm join mydlq.club:16443 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--token 6w0nwi.zag57qgfcdhi76vd \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--discovery-token-ca-cert-hash sha256:efa49231e4ffd836ff996921741c98ac4c5655dc729d7c32aa48c608232f0f08 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--control-plane --certificate-key a64e9da7346153bd64dba1e5126a644a97fdb63c878bb73de07911d1add8e26b&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¾“å‡ºä¸‹é¢æ—¥å¿—ï¼Œæç¤º etcd ç›‘æ§æ£€æŸ¥å¤±è´¥ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;......&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[control-plane] Creating static Pod manifest &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;kube-controller-manager&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;W0329 00:01:51.364121   19209 manifests.go:214] the default kube-apiserver authorization-mode is &lt;span class=&quot;string&quot;&gt;&quot;Node,RBAC&quot;&lt;/span&gt;; using &lt;span class=&quot;string&quot;&gt;&quot;Node,RBAC&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[control-plane] Creating static Pod manifest &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;kube-scheduler&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;W0329 00:01:51.373807   19209 manifests.go:214] the default kube-apiserver authorization-mode is &lt;span class=&quot;string&quot;&gt;&quot;Node,RBAC&quot;&lt;/span&gt;; using &lt;span class=&quot;string&quot;&gt;&quot;Node,RBAC&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[check-etcd] Checking that the etcd cluster is healthy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;error execution phase check-etcd: etcd cluster is not healthy: failed to dial endpoint https://10.8.18.105:2379 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;with maintenance client: context deadline exceeded&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;To see the stack trace of this error execute with --v=5 or higher&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ ¹æ®å…³é”®ä¿¡æ¯ &lt;code&gt;&amp;quot;error execution phase check-etcd&amp;quot;&lt;/code&gt; å¯çŸ¥ï¼Œå¯èƒ½æ˜¯åœ¨æ‰§è¡ŒåŠ å…¥ &lt;code&gt;etcd&lt;/code&gt; æ—¶å€™å‡ºç°çš„é”™è¯¯ï¼Œå¯¼è‡´ &lt;code&gt;master&lt;/code&gt; æ— æ³•åŠ å…¥åŸå…ˆçš„ &lt;code&gt;kubernetes&lt;/code&gt; é›†ç¾¤ã€‚&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;åˆ†æé—®é¢˜&quot;&gt;&lt;a href=&quot;#åˆ†æé—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;åˆ†æé—®é¢˜&quot;&gt;&lt;/a&gt;åˆ†æé—®é¢˜&lt;/h2&gt;&lt;h3 id=&quot;æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨&quot;&gt;&lt;a href=&quot;#æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨&quot; class=&quot;headerlink&quot; title=&quot;æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨&quot;&gt;&lt;/a&gt;æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get node&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME              STATUS    ROLES     VERSION&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;k8s-master-2-12    Ready    master    v1.17.4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;k8s-master-2-13    Ready    master    v1.17.4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;k8s-node-2-14      Ready    &amp;lt;none&amp;gt;    v1.17.4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;k8s-node-2-15      Ready    &amp;lt;none&amp;gt;    v1.17.4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;k8s-node-2-16      Ready    &amp;lt;none&amp;gt;    v1.17.4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œk8s-master-2-11 èŠ‚ç‚¹ç¡®å®ä¸åœ¨èŠ‚ç‚¹åˆ—è¡¨ä¸­&lt;/p&gt;
&lt;h3 id=&quot;æŸ¥çœ‹-Kubeadm-é…ç½®ä¿¡æ¯&quot;&gt;&lt;a href=&quot;#æŸ¥çœ‹-Kubeadm-é…ç½®ä¿¡æ¯&quot; class=&quot;headerlink&quot; title=&quot;æŸ¥çœ‹ Kubeadm é…ç½®ä¿¡æ¯&quot;&gt;&lt;/a&gt;æŸ¥çœ‹ Kubeadm é…ç½®ä¿¡æ¯&lt;/h3&gt;&lt;p&gt;åœ¨çœ‹çœ‹ Kubernetes é›†ç¾¤ä¸­çš„ kubeadm é…ç½®ä¿¡æ¯ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl describe configmaps kubeadm-config -n kube-system&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è·å–åˆ°çš„å†…å®¹å¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Name:         kubeadm-config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Namespace:    kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Labels:       &amp;lt;none&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Annotations:  &amp;lt;none&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ClusterStatus:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;----&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiEndpoints:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  k8s-master-2-11:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    advertiseAddress: 192.168.2.11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt;Port: 6443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  k8s-master-2-12:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    advertiseAddress: 192.168.2.12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt;Port: 6443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  k8s-master-2-13:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    advertiseAddress: 192.168.2.13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt;Port: 6443&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1beta2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: ClusterStatus&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯ä¹Ÿçœ‹åˆ° &lt;code&gt;k8s-master-2-11&lt;/code&gt; èŠ‚ç‚¹ä¿¡æ¯è¿˜å­˜åœ¨ä¸ &lt;code&gt;kubeadm&lt;/code&gt; é…ç½®ä¸­ï¼Œè¯´æ˜ &lt;code&gt;etcd&lt;/code&gt; ä¸­è¿˜å­˜å‚¨ç€ &lt;code&gt;k8s-master-2-11&lt;/code&gt; ç›¸å…³ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;h3 id=&quot;åˆ†æé—®é¢˜æ‰€åœ¨åŠè§£å†³æ–¹æ¡ˆ&quot;&gt;&lt;a href=&quot;#åˆ†æé—®é¢˜æ‰€åœ¨åŠè§£å†³æ–¹æ¡ˆ&quot; class=&quot;headerlink&quot; title=&quot;åˆ†æé—®é¢˜æ‰€åœ¨åŠè§£å†³æ–¹æ¡ˆ&quot;&gt;&lt;/a&gt;åˆ†æé—®é¢˜æ‰€åœ¨åŠè§£å†³æ–¹æ¡ˆ&lt;/h3&gt;&lt;p&gt;å› ä¸ºé›†ç¾¤æ˜¯é€šè¿‡ &lt;code&gt;kubeadm&lt;/code&gt; å·¥å…·æ­å»ºçš„ï¼Œä¸”ä½¿ç”¨äº† &lt;code&gt;etcd&lt;/code&gt; é•œåƒæ–¹å¼ä¸ &lt;code&gt;master&lt;/code&gt; èŠ‚ç‚¹ä¸€èµ·ï¼Œæ‰€ä»¥æ¯ä¸ª &lt;code&gt;Master&lt;/code&gt; èŠ‚ç‚¹ä¸Šéƒ½ä¼šå­˜åœ¨ä¸€ä¸ª &lt;code&gt;etcd&lt;/code&gt; å®¹å™¨å®ä¾‹ã€‚å½“å‰”é™¤ä¸€ä¸ª &lt;code&gt;master&lt;/code&gt; èŠ‚ç‚¹æ—¶ &lt;code&gt;etcd&lt;/code&gt; é›†ç¾¤æœªåˆ é™¤å‰”é™¤çš„èŠ‚ç‚¹çš„ &lt;code&gt;etcd&lt;/code&gt; æˆå‘˜ä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯è¿˜å­˜åœ¨ &lt;code&gt;etcd&lt;/code&gt; é›†ç¾¤åˆ—è¡¨ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ &lt;strong&gt;è¿›å…¥ etcd æ‰‹åŠ¨åˆ é™¤ etcd æˆå‘˜ä¿¡æ¯&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&quot;è§£å†³&quot;&gt;&lt;a href=&quot;#è§£å†³&quot; class=&quot;headerlink&quot; title=&quot;è§£å†³&quot;&gt;&lt;/a&gt;è§£å†³&lt;/h2&gt;&lt;h3 id=&quot;è·å–-Etcd-é•œåƒåˆ—è¡¨&quot;&gt;&lt;a href=&quot;#è·å–-Etcd-é•œåƒåˆ—è¡¨&quot; class=&quot;headerlink&quot; title=&quot;è·å– Etcd é•œåƒåˆ—è¡¨&quot;&gt;&lt;/a&gt;è·å– Etcd é•œåƒåˆ—è¡¨&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods -n kube-system | grep etcd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;etcd-k8s-master-2-12   1/1   Running   0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;etcd-k8s-master-2-13   1/1   Running   0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;è¿›å…¥-Etcd-å®¹å™¨å¹¶åˆ é™¤èŠ‚ç‚¹ä¿¡æ¯&quot;&gt;&lt;a href=&quot;#è¿›å…¥-Etcd-å®¹å™¨å¹¶åˆ é™¤èŠ‚ç‚¹ä¿¡æ¯&quot; class=&quot;headerlink&quot; title=&quot;è¿›å…¥ Etcd å®¹å™¨å¹¶åˆ é™¤èŠ‚ç‚¹ä¿¡æ¯&quot;&gt;&lt;/a&gt;è¿›å…¥ Etcd å®¹å™¨å¹¶åˆ é™¤èŠ‚ç‚¹ä¿¡æ¯&lt;/h3&gt;&lt;p&gt;é€‰æ‹©ä¸Šé¢ä¸¤ä¸ª etcd ä¸­ä»»æ„ä¸€ä¸ª podï¼Œé€šè¿‡ kubectl å·¥å…·è¿›å…¥ pod å†…éƒ¨ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; -it etcd-k8s-master-2-12 sh -n kube-system&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿›å…¥å®¹å™¨åï¼ŒæŒ‰ä¸‹é¢æ­¥æ‰§è¡Œ&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# é…ç½®ç¯å¢ƒ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt; ETCDCTL_API=3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;alias&lt;/span&gt; etcdctl=&lt;span class=&quot;string&quot;&gt;&#39;etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# æŸ¥çœ‹ etcd é›†ç¾¤æˆå‘˜åˆ—è¡¨&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ etcdctl member list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63bfe05c4646fb08, started, k8s-master-2-11, https://192.168.2.11:2380, https://192.168.2.11:2379, &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8e41efd8164c6e3d, started, k8s-master-2-12, https://192.168.2.12:2380, https://192.168.2.12:2379, &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;a61d0bd53c1cbcb6, started, k8s-master-2-13, https://192.168.2.13:2380, https://192.168.2.13:2379, &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# åˆ é™¤ etcd é›†ç¾¤æˆå‘˜ k8s-master-2-11&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ etcdctl member remove 63bfe05c4646fb08&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Member 63bfe05c4646fb08 removed from cluster ed984b9o8w35&lt;span class=&quot;built_in&quot;&gt;cap&lt;/span&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# å†æ¬¡æŸ¥çœ‹ etcd é›†ç¾¤æˆå‘˜åˆ—è¡¨&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ etcdctl member list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8e41efd8164c6e3d, started, k8s-master-2-12, https://192.168.2.12:2380, https://192.168.2.12:2379, &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;a61d0bd53c1cbcb6, started, k8s-master-2-13, https://192.168.2.13:2380, https://192.168.2.13:2379, &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# é€€å‡ºå®¹å™¨&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;é€šè¿‡-kubeadm-å‘½ä»¤å†æ¬¡å°è¯•åŠ å…¥é›†ç¾¤&quot;&gt;&lt;a href=&quot;#é€šè¿‡-kubeadm-å‘½ä»¤å†æ¬¡å°è¯•åŠ å…¥é›†ç¾¤&quot; class=&quot;headerlink&quot; title=&quot;é€šè¿‡ kubeadm å‘½ä»¤å†æ¬¡å°è¯•åŠ å…¥é›†ç¾¤&quot;&gt;&lt;/a&gt;é€šè¿‡ kubeadm å‘½ä»¤å†æ¬¡å°è¯•åŠ å…¥é›†ç¾¤&lt;/h3&gt;&lt;p&gt;é€šè¿‡ &lt;code&gt;kubeadm&lt;/code&gt; å‘½ä»¤å†æ¬¡å°è¯•å°† &lt;code&gt;k8s-master-2-11&lt;/code&gt; èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼Œåœ¨æ‰§è¡Œå‰é¦–å…ˆè¿›å…¥åˆ° &lt;code&gt;k8s-master-2-11&lt;/code&gt; èŠ‚ç‚¹æœåŠ¡å™¨ï¼Œæ‰§è¡Œ &lt;code&gt;kubeadm&lt;/code&gt; çš„æ¸…é™¤å‘½ä»¤ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubeadm reset&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç„¶åå°è¯•åŠ å…¥ kubernetes é›†ç¾¤ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubeadm join mydlq.club:16443 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--token 6w0nwi.zag57qgfcdhi76vd \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--discovery-token-ca-cert-hash sha256:efa49231e4ffd836ff996921741c98ac4c5655dc729d7c32aa48c608232f0f08 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--control-plane --certificate-key a64e9da7346153bd64dba1e5126a644a97fdb63c878bb73de07911d1add8e26b&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼šmydlq.club&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ç³»ç»Ÿç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#ç³»ç»Ÿç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;ç³»ç»Ÿç¯å¢ƒ&quot;&gt;&lt;/a&gt;ç³»ç»Ÿç¯å¢ƒ&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Docker ç‰ˆæœ¬ï¼š18.06.3&lt;br&gt;Kubeadm ç‰ˆæœ¬ï¼š1.17.4&lt;br&gt;Kubernetes ç‰ˆæœ¬ï¼š1.17.4&lt;br&gt;Kubernetes Master æ•°é‡ï¼š3&lt;br&gt;Kubernetes å®‰è£…æ–¹å¼ï¼šKubeadm&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;a href=&quot;#é—®é¢˜æè¿°&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;/a&gt;é—®é¢˜æè¿°&lt;/h2&gt;&lt;p&gt;Kubernetes é›†ç¾¤ä¸­æ€»å…±æœ‰ä¸‰å° Masterï¼Œåˆ†åˆ«æ˜¯ï¼š&lt;/p&gt;
&lt;p&gt;k8s-master-2-11ã€k8s-master-2-12ã€k8s-master-2-13&lt;/p&gt;
&lt;p&gt;å¯¹å…¶ä¸­ k8s-master-2-11 Master èŠ‚ç‚¹æœåŠ¡å™¨è¿›è¡Œäº†å†…æ ¸å’Œè½¯ä»¶å‡çº§æ“ä½œï¼Œä»è€Œå…ˆå°†å…¶æš‚æ—¶å‰”å‡ºé›†ç¾¤ï¼Œç„¶åè¿›è¡Œå‡çº§ï¼Œå®Œæˆåå‡†å¤‡é‡æ–°åŠ å…¥åˆ° Kubernetes é›†ç¾¤ï¼Œé€šè¿‡ Kubeadm æ‰§è¡Œï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubeadm join mydlq.club:16443 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--token 6w0nwi.zag57qgfcdhi76vd \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--discovery-token-ca-cert-hash sha256:efa49231e4ffd836ff996921741c98ac4c5655dc729d7c32aa48c608232f0f08 \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;--control-plane --certificate-key a64e9da7346153bd64dba1e5126a644a97fdb63c878bb73de07911d1add8e26b&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¾“å‡ºä¸‹é¢æ—¥å¿—ï¼Œæç¤º etcd ç›‘æ§æ£€æŸ¥å¤±è´¥ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;......&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[control-plane] Creating static Pod manifest &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;kube-controller-manager&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;W0329 00:01:51.364121   19209 manifests.go:214] the default kube-apiserver authorization-mode is &lt;span class=&quot;string&quot;&gt;&quot;Node,RBAC&quot;&lt;/span&gt;; using &lt;span class=&quot;string&quot;&gt;&quot;Node,RBAC&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[control-plane] Creating static Pod manifest &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;kube-scheduler&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;W0329 00:01:51.373807   19209 manifests.go:214] the default kube-apiserver authorization-mode is &lt;span class=&quot;string&quot;&gt;&quot;Node,RBAC&quot;&lt;/span&gt;; using &lt;span class=&quot;string&quot;&gt;&quot;Node,RBAC&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[check-etcd] Checking that the etcd cluster is healthy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;error execution phase check-etcd: etcd cluster is not healthy: failed to dial endpoint https://10.8.18.105:2379 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;with maintenance client: context deadline exceeded&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;To see the stack trace of this error execute with --v=5 or higher&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;æ ¹æ®å…³é”®ä¿¡æ¯ &lt;code&gt;&amp;quot;error execution phase check-etcd&amp;quot;&lt;/code&gt; å¯çŸ¥ï¼Œå¯èƒ½æ˜¯åœ¨æ‰§è¡ŒåŠ å…¥ &lt;code&gt;etcd&lt;/code&gt; æ—¶å€™å‡ºç°çš„é”™è¯¯ï¼Œå¯¼è‡´ &lt;code&gt;master&lt;/code&gt; æ— æ³•åŠ å…¥åŸå…ˆçš„ &lt;code&gt;kubernetes&lt;/code&gt; é›†ç¾¤ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/categories/kubernetes/"/>
    
      <category term="kubeadm" scheme="http://team.jiunile.com/categories/kubernetes/kubeadm/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/tags/kubernetes/"/>
    
      <category term="etcd" scheme="http://team.jiunile.com/tags/etcd/"/>
    
      <category term="kubeadm" scheme="http://team.jiunile.com/tags/kubeadm/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes 1.18+ ä½¿ç”¨ipvsåcorednsæ— æ³•è§£æåŸŸåé‡‡å‘è®°</title>
    <link href="http://team.jiunile.com//blog/2020/05/k8s-1-18-ipvs-problem.html"/>
    <id>http://team.jiunile.com//blog/2020/05/k8s-1-18-ipvs-problem.html</id>
    <published>2020-05-09T04:00:00.000Z</published>
    <updated>2020-09-02T03:29:58.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;ç¯å¢ƒç°è±¡&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒç°è±¡&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒç°è±¡&quot;&gt;&lt;/a&gt;ç¯å¢ƒç°è±¡&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;CoreDNS ç‰ˆæœ¬ï¼š1.6.7&lt;br&gt;Docker ç‰ˆæœ¬ï¼š18.06.3-ce&lt;br&gt;Kubernetes ç‰ˆæœ¬ï¼š1.18.1&lt;br&gt;æ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼šCentOS 7.x&lt;br&gt;CentOS å†…æ ¸ç‰ˆæœ¬ï¼š3.10.0-693.2.2.el7.x86_64&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;é—®é¢˜ç°è±¡&quot;&gt;&lt;a href=&quot;#é—®é¢˜ç°è±¡&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜ç°è±¡&quot;&gt;&lt;/a&gt;é—®é¢˜ç°è±¡&lt;/h2&gt;&lt;p&gt;ç”±äºæœ€è¿‘è¦å‘ç»„å†…æ¼”ç¤º Istio 1.5ï¼Œæ•…åœ¨äº‘æœåŠ¡å™¨ä¸Šå®‰è£…äº†kubernetes 1.18.1 (ä½¿ç”¨ipvs) æ¥é…åˆ Istio 1.5 çš„æ¼”ç¤ºï¼Œkubernetes ä¸ istio å®‰è£…å®Œåä¸€åˆ‡é¡ºåˆ©ï¼Œbookinfo demoè·‘çš„ä¹Ÿéå¸¸çš„é¡ºåˆ©ã€‚ä½†åœ¨ä¸€æ¬¡é‡å¯æ•´ä¸ªé›†ç¾¤åï¼Œä¸€åˆ‡éƒ½å˜çš„ä¸é‚£ä¹ˆç¾å¥½äº†ã€‚istio-proxyèµ·ä¸æ¥äº†ï¼Œæç¤ºpilot not readyï¼Œæ›´å¯æ‚²çš„æ˜¯service name æ— æ³•è§£æäº†ï¼Œå¯¼è‡´å¾ˆå¤šæœåŠ¡ä¹‹é—´çš„è°ƒç”¨éƒ½æ²¡æ³•æ­£å¸¸å·¥ä½œï¼Œæœ‰ä¾èµ–çš„æœåŠ¡éƒ½ä¸èƒ½æ­£å¸¸å¯åŠ¨äº†ï¼Œä¸ºäº†æ›´å¥½çš„å®šä½é—®é¢˜ï¼Œäºæ˜¯å¸è½½ Istio 1.5ï¼Œé‡æ–°å›åˆ°k8s 1.18.1ä¸Šï¼Œåœ¨ä¸€æ­¥æ­¥æ’æŸ¥ä¸­å‘ç°ï¼Œåœ¨podä¸­ä½¿ç”¨pod ipç›¸äº’è®¿é—®æ˜¯å¯ä»¥çš„ï¼Œç”±æ­¤åˆ¤æ–­ï¼Œåˆæ­¥æ€€ç–‘å¾ˆå¯èƒ½æ˜¯ DNS å‡ºç°äº†é—®é¢˜ï¼Œåæ¥æ…¢æ…¢å‘ç° kube-proxy ä¸­çš„é”™è¯¯ï¼Œå†å®šä½åˆ° IPVS parseIP Error é”™è¯¯ï¼Œå†åˆ°è§£å†³é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯æ•´ä¸ªé—®é¢˜å®šä½åˆ†æ&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;é—®é¢˜å®šä½&quot;&gt;&lt;a href=&quot;#é—®é¢˜å®šä½&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜å®šä½&quot;&gt;&lt;/a&gt;é—®é¢˜å®šä½&lt;/h2&gt;&lt;p&gt;ä¸ºäº†æ›´å¥½çš„é‡ç°é—®é¢˜ï¼Œæˆ‘é‡æ–°å®‰è£…äº†ä¸€å¥—æ–°çš„ kubernetes 1.18.1ï¼Œå®‰è£…å®ŒåéªŒè¯ä¸€åˆ‡éƒ½æ˜¯okï¼Œæ¥ä¸‹æ¥æˆ‘å°±é‡å¯æ•´ä¸ªé›†ç¾¤ï¼Œé—®é¢˜å°±äº§ç”Ÿäº†ï¼Œåœ¨podä¸­æ— æ³•è§£æservice nameäº†ï¼Œæ‰€æœ‰çš„podè¿è¡Œéƒ½æ˜¯okçš„ï¼Œä¸€åˆ‡éƒ½å˜çš„â€å¾ˆç¥å¥‡â€ï¼Œå¥½å§ï¼Œå¼€å¯å®šä½ä¹‹æ—…ã€‚&lt;/p&gt;
&lt;h3 id=&quot;éƒ¨ç½²DNSè°ƒè¯•å·¥å…·&quot;&gt;&lt;a href=&quot;#éƒ¨ç½²DNSè°ƒè¯•å·¥å…·&quot; class=&quot;headerlink&quot; title=&quot;éƒ¨ç½²DNSè°ƒè¯•å·¥å…·&quot;&gt;&lt;/a&gt;éƒ¨ç½²DNSè°ƒè¯•å·¥å…·&lt;/h3&gt;&lt;p&gt;ä¸ºäº†æ¢é’ˆæ˜¯å¦ä¸º DNS é—®é¢˜ï¼Œè¿™é‡Œéœ€è¦æå‰éƒ¨ç½²ç”¨äºæµ‹è¯• DNS é—®é¢˜çš„ dnsutils é•œåƒï¼Œè¯¥é•œåƒä¸­åŒ…å«äº†ç”¨äºæµ‹è¯• DNS é—®é¢˜çš„å·¥å…·åŒ…ï¼Œéå¸¸åˆ©äºæˆ‘ä»¬åˆ†æä¸å‘ç°é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;éƒ¨ç½² ndsutils.yaml&lt;br&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;/span&gt; v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;kind:&lt;/span&gt; Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;metadata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  name:&lt;/span&gt; dnsutils&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;spec:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  containers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;  - name:&lt;/span&gt; dnsutils&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    image:&lt;/span&gt; mydlqclub/dnsutils:&lt;span class=&quot;number&quot;&gt;1.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    imagePullPolicy:&lt;/span&gt; IfNotPresent&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;    command:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;sleep&quot;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&quot;3600&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;é—®é¢˜åˆ†æ&quot;&gt;&lt;a href=&quot;#é—®é¢˜åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜åˆ†æ&quot;&gt;&lt;/a&gt;é—®é¢˜åˆ†æ&lt;/h3&gt;&lt;h4 id=&quot;1-è¿›å…¥-DNS-å·¥å…·-Pod-çš„å‘½ä»¤è¡Œ&quot;&gt;&lt;a href=&quot;#1-è¿›å…¥-DNS-å·¥å…·-Pod-çš„å‘½ä»¤è¡Œ&quot; class=&quot;headerlink&quot; title=&quot;1. è¿›å…¥ DNS å·¥å…· Pod çš„å‘½ä»¤è¡Œ&quot;&gt;&lt;/a&gt;1. è¿›å…¥ DNS å·¥å…· Pod çš„å‘½ä»¤è¡Œ&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; -it dnsutils sh&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;2-é€šè¿‡-Ping-å’Œ-Nsloopup-å‘½ä»¤æµ‹è¯•&quot;&gt;&lt;a href=&quot;#2-é€šè¿‡-Ping-å’Œ-Nsloopup-å‘½ä»¤æµ‹è¯•&quot; class=&quot;headerlink&quot; title=&quot;2. é€šè¿‡ Ping å’Œ Nsloopup å‘½ä»¤æµ‹è¯•&quot;&gt;&lt;/a&gt;2. é€šè¿‡ Ping å’Œ Nsloopup å‘½ä»¤æµ‹è¯•&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Ping é›†ç¾¤å¤–éƒ¨ï¼Œä¾‹å¦‚è¿™é‡Œ ping ä¸€ä¸‹ç™¾åº¦&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ ping www.baidu.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ping: bad address &lt;span class=&quot;string&quot;&gt;&#39;www.baidu.com&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Ping é›†ç¾¤å†…éƒ¨ kube-apiserver çš„ Service åœ°å€&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ ping kubernetes.default&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ping: bad address &lt;span class=&quot;string&quot;&gt;&#39;kubernetes.default&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä½¿ç”¨ nslookup å‘½ä»¤æŸ¥è¯¢åŸŸåä¿¡æ¯&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ nslookup kubernetes.default&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;;; connection timed out; no servers could be reached&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ç›´æ¥ Ping é›†ç¾¤å†…éƒ¨ kube-apiserver çš„ IP åœ°å€&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ ping 10.96.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;PING 10.96.0.1 (10.96.0.1): 56 data bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64 bytes from 10.96.0.1: seq=0 ttl=64 time=0.096 ms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64 bytes from 10.96.0.1: seq=1 ttl=64 time=0.050 ms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64 bytes from 10.96.0.1: seq=2 ttl=64 time=0.068 ms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# é€€å‡º dnsutils Pod å‘½ä»¤è¡Œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å¯ä»¥è§‚å¯Ÿåˆ°ä¸¤æ¬¡ ping åŸŸåéƒ½ä¸èƒ½ ping é€šï¼Œä¸”ä½¿ç”¨ nsloopup åˆ†æåŸŸåä¿¡æ¯æ—¶è¶…æ—¶ã€‚ç„¶è€Œï¼Œä½¿ç”¨ ping kube-apiserver çš„ IP åœ°å€ â€œ10.96.0.1â€ åˆ™å¯ä»¥æ­£å¸¸é€šä¿¡ï¼Œæ‰€ä»¥ï¼Œæ’é™¤ç½‘ç»œæ’ä»¶ï¼ˆflannelã€calico ç­‰ï¼‰çš„é—®é¢˜ã€‚åˆæ­¥åˆ¤æ–­ï¼Œå¾ˆå¯èƒ½æ˜¯ CoreDNS ç»„ä»¶çš„é”™è¯¯å¼•èµ·çš„æŸäº›é—®é¢˜ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬æµ‹è¯• CoreDNS æ˜¯å¦æ­£å¸¸ã€‚&lt;/p&gt;
&lt;h4 id=&quot;3-æ£€æµ‹-CoreDNS-åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ&quot;&gt;&lt;a href=&quot;#3-æ£€æµ‹-CoreDNS-åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ&quot; class=&quot;headerlink&quot; title=&quot;3. æ£€æµ‹ CoreDNS åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ&quot;&gt;&lt;/a&gt;3. æ£€æµ‹ CoreDNS åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt; k8s-app=kube-dns -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                       READY   STATUS    RESTARTS   AGE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;coredns-669f77d7cc-8pkpw   1/1     Running   2          6h5m&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;coredns-669f77d7cc-jk9wk   1/1     Running   2          6h5m&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å¯ä¹Ÿçœ‹åˆ° CoreDNS ä¸¤ä¸ª Pod å‡æ­£å¸¸å¯åŠ¨ï¼Œæ‰€ä»¥å†æŸ¥çœ‹ä¸¤ä¸ª Pod ä¸­çš„æ—¥å¿—ä¿¡æ¯ï¼Œçœ‹çœ‹æœ‰æ— é”™è¯¯æ—¥å¿—ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; p &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; $(kubectl get pods --namespace=kube-system &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt; k8s-app=kube-dns -o name); \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; kubectl logs --namespace=kube-system &lt;span class=&quot;variable&quot;&gt;$p&lt;/span&gt;; &lt;span class=&quot;keyword&quot;&gt;done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.:53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = 4e235fcc3696966e76816bcd9034ebc7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CoreDNS-1.6.7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;linux/amd64, go1.13.6, da7f65b&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.:53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = 4e235fcc3696966e76816bcd9034ebc7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CoreDNS-1.6.7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;linux/amd64, go1.13.6, da7f65b&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;é€šè¿‡ä¸Šé¢ä¿¡æ¯å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œæ—¥å¿—ä¸­ä¿¡æ¯ä¹Ÿæ˜¯æ­£å¸¸å¯åŠ¨æ²¡æœ‰é—®é¢˜ã€‚å†æ¥ä¸‹æ¥ï¼ŒæŸ¥çœ‹ä¸‹ CoreDNS çš„å…¥å£ Service â€œkube-dnsâ€ æ˜¯å¦å­˜åœ¨ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;kube-dns çš„ IP ä¸º 10.96.0.10ï¼Œé›†ç¾¤å†…çš„ Pod éƒ½æ˜¯é€šè¿‡è¯¥ IP ä¸ DNS ç»„ä»¶è¿›è¡Œäº¤äº’ï¼ŒæŸ¥è¯¢ DNS ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get service -n kube-system | grep kube-dns&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)               &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kube-dns                    ClusterIP   10.96.0.10      &amp;lt;none&amp;gt;        53/UDP,53/TCP,9153/TCP&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ä¸Šé¢æ˜¾ç¤º Service â€œkube-dnsâ€ ä¹Ÿå­˜åœ¨ï¼Œä½†æ˜¯ Service æ˜¯é€šè¿‡ endpoints å’Œ Pod è¿›è¡Œç»‘å®šçš„ï¼Œæ‰€ä»¥çœ‹çœ‹è¿™ä¸ª CoreDNS çš„ endpoints æ˜¯å¦å­˜åœ¨ï¼ŒåŠä¿¡æ¯æ˜¯å¦æ­£ç¡®ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get endpoints kube-dns -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NAME       ENDPOINTS                                      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kube-dns   10.244.0.21:53,d10.244.2.82:53,10.244.0.21:9153&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ° endpoints é…ç½®ä¹Ÿæ˜¯æ­£å¸¸çš„ï¼Œæ­£ç¡®çš„ä¸ä¸¤ä¸ª CporeDNS Pod è¿›è¡Œäº†å…³è”ã€‚&lt;/p&gt;
&lt;p&gt;ç»è¿‡ä¸Šé¢ä¸€ç³»åˆ—æ£€æµ‹ CoreDNS ç»„ä»¶ç¡®å®æ˜¯æ­£å¸¸è¿è¡Œã€‚æ¥ä¸‹æ¥ï¼Œè§‚å¯Ÿ CoreDNS åŸŸåè§£ææ—¥å¿—ï¼Œè¿›è€Œç¡®å®š Pod ä¸­çš„åŸŸåè§£æè¯·æ±‚æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è¿›å…¥ CoreDNSã€‚&lt;/p&gt;
&lt;h4 id=&quot;4-è§‚å¯Ÿ-CoreDNS-åŸŸåè§£ææ—¥å¿—ä¿¡æ¯&quot;&gt;&lt;a href=&quot;#4-è§‚å¯Ÿ-CoreDNS-åŸŸåè§£ææ—¥å¿—ä¿¡æ¯&quot; class=&quot;headerlink&quot; title=&quot;4. è§‚å¯Ÿ CoreDNS åŸŸåè§£ææ—¥å¿—ä¿¡æ¯&quot;&gt;&lt;/a&gt;4. è§‚å¯Ÿ CoreDNS åŸŸåè§£ææ—¥å¿—ä¿¡æ¯&lt;/h4&gt;&lt;p&gt;ä½¿ç”¨ &lt;code&gt;kubectl edit&lt;/code&gt; å‘½ä»¤æ¥ä¿®æ”¹å­˜å‚¨äº Kubernetes &lt;code&gt;ConfigMap&lt;/code&gt; ä¸­çš„ CoreDNS é…ç½®å‚æ•°ä¿¡æ¯ï¼Œæ·»åŠ  &lt;code&gt;log&lt;/code&gt; å‚æ•°ï¼Œè®© CoreDNS æ—¥å¿—ä¸­æ˜¾ç¤ºåŸŸåè§£æä¿¡æ¯ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;CoreDNS é…ç½®å‚æ•°è¯´æ˜ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;errors: è¾“å‡ºé”™è¯¯ä¿¡æ¯åˆ°æ§åˆ¶å°ã€‚&lt;/li&gt;
&lt;li&gt;healthï¼šCoreDNS è¿›è¡Œç›‘æ§æ£€æµ‹ï¼Œæ£€æµ‹åœ°å€ä¸º &lt;a href=&quot;http://localhost:8080/health&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://localhost:8080/health&lt;/a&gt; å¦‚æœçŠ¶æ€ä¸ºä¸å¥åº·åˆ™è®© Pod è¿›è¡Œé‡å¯ã€‚&lt;/li&gt;
&lt;li&gt;ready: å…¨éƒ¨æ’ä»¶å·²ç»åŠ è½½å®Œæˆæ—¶ï¼Œå°†é€šè¿‡ endpoints åœ¨ 8081 ç«¯å£è¿”å› HTTP çŠ¶æ€ 200ã€‚&lt;/li&gt;
&lt;li&gt;kubernetesï¼šCoreDNS å°†æ ¹æ® Kubernetes æœåŠ¡å’Œ pod çš„ IP å›å¤ DNS æŸ¥è¯¢ã€‚&lt;/li&gt;
&lt;li&gt;prometheusï¼šæ˜¯å¦å¼€å¯ CoreDNS Metrics ä¿¡æ¯æ¥å£ï¼Œå¦‚æœé…ç½®åˆ™å¼€å¯ï¼Œæ¥å£åœ°å€ä¸º &lt;a href=&quot;http://localhost:9153/metrics&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://localhost:9153/metrics&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;forwardï¼šä»»ä½•ä¸åœ¨Kubernetes é›†ç¾¤å†…çš„åŸŸåæŸ¥è¯¢å°†è¢«è½¬å‘åˆ°é¢„å®šä¹‰çš„è§£æå™¨ (/etc/resolv.conf)ã€‚&lt;/li&gt;
&lt;li&gt;cacheï¼šå¯ç”¨ç¼“å­˜ï¼Œ30 ç§’ TTLã€‚&lt;/li&gt;
&lt;li&gt;loopï¼šæ£€æµ‹ç®€å•çš„è½¬å‘å¾ªç¯ï¼Œå¦‚æœæ‰¾åˆ°å¾ªç¯åˆ™åœæ­¢ CoreDNS è¿›ç¨‹ã€‚&lt;/li&gt;
&lt;li&gt;reloadï¼šç›‘å¬ CoreDNS é…ç½®ï¼Œå¦‚æœé…ç½®å‘ç”Ÿå˜åŒ–åˆ™é‡æ–°åŠ è½½é…ç½®ã€‚&lt;/li&gt;
&lt;li&gt;loadbalanceï¼šDNS è´Ÿè½½å‡è¡¡å™¨ï¼Œé»˜è®¤ round_robinã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ç¼–è¾‘ coredns é…ç½®&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl edit configmap coredns -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;data:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Corefile: |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .:53 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;            &lt;span class=&quot;comment&quot;&gt;#æ·»åŠ log&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        errors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        health &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           lameduck 5s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ready&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        kubernetes cluster.local &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt;-addr.arpa ip6.arpa &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           pods insecure&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           fallthrough &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt;-addr.arpa ip6.arpa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           ttl 30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        prometheus :9153&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        forward . /etc/resolv.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        cache 30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        loop&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        reload&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        loadbalance&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ä¿å­˜æ›´æ”¹å CoreDNS ä¼šè‡ªåŠ¨é‡æ–°åŠ è½½é…ç½®ä¿¡æ¯ï¼Œä¸è¿‡å¯èƒ½éœ€è¦ç­‰ä¸Šä¸€ä¸¤åˆ†é’Ÿæ‰èƒ½å°†è¿™äº›æ›´æ”¹ä¼ æ’­åˆ° CoreDNS Podã€‚ç­‰ä¸€æ®µæ—¶é—´åï¼Œå†æ¬¡æŸ¥çœ‹ CoreDNS æ—¥å¿—ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; p &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; $(kubectl get pods --namespace=kube-system &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt; k8s-app=kube-dns -o name); \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; kubectl logs --namespace=kube-system &lt;span class=&quot;variable&quot;&gt;$p&lt;/span&gt;; &lt;span class=&quot;keyword&quot;&gt;done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.:53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = 6434d0912b39645ed0707a3569fd69dc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CoreDNS-1.6.7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;linux/amd64, go1.13.6, da7f65b&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/health: Going into lameduck mode &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 5s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 127.0.0.1:47278 - 55171 &lt;span class=&quot;string&quot;&gt;&quot;HINFO IN 4940754309314083739.5160468069505858354. udp 57 false 512&quot;&lt;/span&gt; NXDOMAIN qr,rd,ra 57 0.040844011s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading complete&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.:53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = 6434d0912b39645ed0707a3569fd69dc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CoreDNS-1.6.7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;linux/amd64, go1.13.6, da7f65b&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/health: Going into lameduck mode &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 5s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading complete&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 127.0.0.1:32896 - 49064 &lt;span class=&quot;string&quot;&gt;&quot;HINFO IN 1027842207973621585.7098421666386159336. udp 57 false 512&quot;&lt;/span&gt; NXDOMAIN qr,rd,ra 57 0.044098742s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading complete&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ° CoreDNS å·²ç»é‡æ–°åŠ è½½äº†é…ç½®ï¼Œæˆ‘ä»¬å†æ¬¡è¿›å…¥ dnsuitls Pod ä¸­æ‰§è¡Œ ping å‘½ä»¤ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# è¿›å…¥ DNSutils Pod å‘½ä»¤è¡Œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; -it dnsutils sh &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# æ‰§è¡Œ ping å‘½ä»¤&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ ping www.baidu.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# é€€å‡º dnsutils Pod å‘½ä»¤è¡Œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç„¶åï¼Œå†æ¬¡æŸ¥çœ‹ CoreDNS çš„æ—¥å¿—ä¿¡æ¯ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; p &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; $(kubectl get pods --namespace=kube-system &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt; k8s-app=kube-dns -o name); \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; kubectl logs --namespace=kube-system &lt;span class=&quot;variable&quot;&gt;$p&lt;/span&gt;; &lt;span class=&quot;keyword&quot;&gt;done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.:53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = 6434d0912b39645ed0707a3569fd69dc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CoreDNS-1.6.7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;linux/amd64, go1.13.6, da7f65b&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/health: Going into lameduck mode &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 5s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 127.0.0.1:47278 - 55171 &lt;span class=&quot;string&quot;&gt;&quot;HINFO IN 4940754309314083739.5160468069505858354. udp 57 false 512&quot;&lt;/span&gt; NXDOMAIN qr,rd,ra 57 0.040844011s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading complete&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.:53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = 6434d0912b39645ed0707a3569fd69dc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CoreDNS-1.6.7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;linux/amd64, go1.13.6, da7f65b&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/health: Going into lameduck mode &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 5s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading complete&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 127.0.0.1:32896 - 49064 &lt;span class=&quot;string&quot;&gt;&quot;HINFO IN 1027842207973621585.7098421666386159336. udp 57 false 512&quot;&lt;/span&gt; NXDOMAIN qr,rd,ra 57 0.044098742s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading complete&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å‘ç°å’Œä¹‹å‰æ²¡æœ‰æ‰§è¡Œ ping å‘½ä»¤æ—¶å€™ä¸€æ ·ï¼Œæ²¡æœ‰ DNS åŸŸåè§£æçš„æ—¥å¿—ä¿¡æ¯ï¼Œè¯´æ˜ Pod æ‰§è¡ŒåŸŸåè§£ææ—¶ï¼Œè¯·æ±‚å¹¶æ²¡æœ‰è¿›å…¥ CoreDNS ä¸­ã€‚æ¥ä¸‹æ¥åœ¨æŸ¥çœ‹ Pod ä¸­ DNS é…ç½®ä¿¡æ¯ï¼Œè¿›è€Œåˆ†æé—®é¢˜ã€‚&lt;/p&gt;
&lt;h4 id=&quot;5-æŸ¥çœ‹-Pod-ä¸­çš„-DNS-é…ç½®ä¿¡æ¯&quot;&gt;&lt;a href=&quot;#5-æŸ¥çœ‹-Pod-ä¸­çš„-DNS-é…ç½®ä¿¡æ¯&quot; class=&quot;headerlink&quot; title=&quot;5. æŸ¥çœ‹ Pod ä¸­çš„ DNS é…ç½®ä¿¡æ¯&quot;&gt;&lt;/a&gt;5. æŸ¥çœ‹ Pod ä¸­çš„ DNS é…ç½®ä¿¡æ¯&lt;/h4&gt;&lt;p&gt;ä¸€èˆ¬ Pod ä¸­çš„ &lt;code&gt;DNS&lt;/code&gt; ç­–ç•¥é»˜è®¤ä¸º &lt;code&gt;ClusterFirst&lt;/code&gt;ï¼Œè¯¥å‚æ•°èµ·åˆ°çš„ä½œç”¨æ˜¯ï¼Œä¼˜å…ˆä» &lt;code&gt;Kubernetes DNS&lt;/code&gt; æ’ä»¶åœ°å€è¯»å– &lt;code&gt;DNS&lt;/code&gt; é…ç½®ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æ­£å¸¸åˆ›å»ºçš„ Pod ä¸­ï¼ŒDNS é…ç½® DNS æœåŠ¡å™¨åœ°å€åº”è¯¥æŒ‡å®šä¸º Kubernetes é›†ç¾¤çš„ DNS æ’ä»¶ Service æä¾›çš„è™šæ‹Ÿ IP åœ°å€ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æ³¨ï¼šå…¶ä¸­ DNS ç­–ç•¥ï¼ˆdnsPolicyï¼‰æ”¯æŒå››ç§ç±»å‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Defaultï¼š ä» DNS æ‰€åœ¨èŠ‚ç‚¹ç»§æ‰¿ DNS é…ç½®ï¼Œå³è¯¥ Pod çš„ DNS é…ç½®ä¸å®¿ä¸»æœºå®Œå…¨ä¸€è‡´ã€‚&lt;/li&gt;
&lt;li&gt;ClusterFirstï¼šé¢„å…ˆä» Kubenetes çš„ DNS æ’ä»¶ä¸­è¿›è¡Œ DNS è§£æï¼Œå¦‚æœè§£æä¸æˆåŠŸï¼Œæ‰ä¼šä½¿ç”¨å®¿ä¸»æœºçš„ DNS è¿›è¡Œè§£æã€‚&lt;/li&gt;
&lt;li&gt;ClusterFirstWithHostNetï¼šPod æ˜¯ç”¨ HOST æ¨¡å¼å¯åŠ¨çš„ï¼ˆhostnetworkï¼‰ï¼Œç”¨ HOST æ¨¡å¼è¡¨ç¤º Pod ä¸­çš„æ‰€æœ‰å®¹å™¨ï¼Œéƒ½ä½¿ç”¨å®¿ä¸»æœºçš„ /etc/resolv.conf é…ç½®è¿›è¡Œ DNS è§£æï¼Œä½†å¦‚æœä½¿ç”¨äº† HOST æ¨¡å¼ï¼Œè¿˜ç»§ç»­ä½¿ç”¨ Kubernetes çš„ DNS æœåŠ¡ï¼Œé‚£å°±å°† dnsPolicy è®¾ç½®ä¸º ClusterFirstWithHostNetã€‚&lt;/li&gt;
&lt;li&gt;Noneï¼šå®Œå…¨å¿½ç•¥ kubernetes ç³»ç»Ÿæä¾›çš„ DNSï¼Œä»¥ Pod Spec ä¸­ dnsConfig é…ç½®ä¸ºä¸»ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä¸ºäº†å†åˆ†æåŸå› ï¼Œæˆ‘ä»¬æ¥ç€è¿›å…¥ dnsutils Pod ä¸­ï¼ŒæŸ¥çœ‹ Pod ä¸­ DNS é…ç½®æ–‡ä»¶ &lt;code&gt;/etc/resolv.conf&lt;/code&gt; é…ç½®å‚æ•°æ˜¯å¦æ­£ç¡®ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;resolv.conf é…ç½®å‚æ•°è¯´æ˜ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;searchï¼š æŒ‡æ˜åŸŸåæŸ¥è¯¢é¡ºåºã€‚&lt;/li&gt;
&lt;li&gt;nameserverï¼š æŒ‡å®š DNS æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œå¯ä»¥é…ç½®å¤šä¸ª nameserverã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# è¿›å…¥ dnsutils Pod å†…éƒ¨ sh å‘½ä»¤è¡Œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; -it dnsutils sh &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# æŸ¥çœ‹ resolv.conf é…ç½®æ–‡ä»¶&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/resolv.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nameserver 10.96.0.10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;search kube-system.svc.cluster.local svc.cluster.local cluster.local&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;options ndots:5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# é€€å‡º DNSutils Pod å‘½ä»¤è¡Œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ° Pod å†…éƒ¨çš„ resolv.conf å†…å®¹ï¼Œå…¶ä¸­ nameserver æŒ‡å®š DNS è§£ææœåŠ¡å™¨ IP ä¸º â€œ10.96.0.10â€ ï¼Œè¿™ä¸ª IP åœ°å€æ­£æ˜¯æœ¬äºº Kubernetes é›†ç¾¤ CoreDNS çš„ Service â€œkube-dnsâ€ çš„ cluterIPï¼Œè¯´æ˜å½“ Pod å†…éƒ¨è¿›è¡ŒåŸŸåè§£ææ—¶ï¼Œç¡®å®æ˜¯å°†æŸ¥è¯¢è¯·æ±‚å‘é€åˆ° Service â€œkube-dnsâ€ æä¾›çš„è™šæ‹Ÿ IP è¿›è¡ŒåŸŸåè§£æã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆï¼Œæ—¢ç„¶ Pod ä¸­ DNS é…ç½®æ–‡ä»¶æ²¡é—®é¢˜ï¼Œä¸” CoreDNS ä¹Ÿæ²¡é—®é¢˜ï¼Œä¼šä¸ä¼šæ˜¯ Pod æœ¬èº«åŸŸåè§£æä¸æ­£å¸¸å‘¢ï¼Ÿæˆ–è€… Service â€œkube-dnsâ€ æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è½¬å‘åŸŸåè§£æè¯·æ±‚åˆ° CoreDNS Pod ä¸­ï¼Ÿ&lt;/p&gt;
&lt;p&gt;å½“ç„¶ï¼ŒçŒœæƒ³æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œè¿›è¡Œä¸€ä¸‹æµ‹è¯•æ¥è§‚å¯Ÿé—®é¢˜åˆ°åº•å‡ºåœ¨å“ªé‡Œã€‚&lt;/p&gt;
&lt;h4 id=&quot;6-è¿›è¡Œè§‚å¯Ÿæ¥å®šä½é—®é¢˜æ‰€åœ¨&quot;&gt;&lt;a href=&quot;#6-è¿›è¡Œè§‚å¯Ÿæ¥å®šä½é—®é¢˜æ‰€åœ¨&quot; class=&quot;headerlink&quot; title=&quot;6. è¿›è¡Œè§‚å¯Ÿæ¥å®šä½é—®é¢˜æ‰€åœ¨&quot;&gt;&lt;/a&gt;6. è¿›è¡Œè§‚å¯Ÿæ¥å®šä½é—®é¢˜æ‰€åœ¨&lt;/h4&gt;&lt;p&gt;ä¸Šé¢æ€€ç–‘æ˜¯ Pod æœ¬èº«è§£æåŸŸåæœ‰é—®é¢˜ï¼Œä¸èƒ½æ­£å¸¸è§£æåŸŸåã€‚æˆ–è€… Pod æ²¡é—®é¢˜ï¼Œä½†æ˜¯è¯·æ±‚åŸŸåè§£ææ—¶å°†è¯·æ±‚å‘é€åˆ° Service â€œkube-dnsâ€ åä¸èƒ½æ­£å¸¸è½¬å‘è¯·æ±‚åˆ° CoreDNS Podã€‚ ä¸ºäº†éªŒè¯è¿™ä¸¤ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ Pod ä¸­çš„ /etc/resolv.conf é…ç½®æ¥è¿›è¡Œæµ‹è¯•éªŒè¯ã€‚&lt;/p&gt;
&lt;p&gt;ä¿®æ”¹ &lt;code&gt;resolv.conf&lt;/code&gt; ä¸­ &lt;code&gt;DNS&lt;/code&gt; è§£æè¯·æ±‚åœ°å€ä¸º &lt;code&gt;é˜¿é‡Œäº‘ DNS&lt;/code&gt; æœåŠ¡å™¨åœ°å€ï¼Œç„¶åæ‰§è¡Œ &lt;code&gt;ping&lt;/code&gt; å‘½ä»¤éªŒè¯æ˜¯å¦ä¸º &lt;code&gt;Pod&lt;/code&gt; è§£æåŸŸåæ˜¯å¦æœ‰é—®é¢˜ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# è¿›å…¥ dnsutils Pod å†…éƒ¨ sh å‘½ä»¤è¡Œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; -it dnsutils /bin/sh -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;## ç¼–è¾‘ /etc/resolv.conf æ–‡ä»¶ï¼Œä¿®æ”¹ nameserver å‚æ•°ä¸ºé˜¿é‡Œäº‘æä¾›çš„ DNS æœåŠ¡å™¨åœ°å€&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ vi /etc/resolv.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nameserver 223.5.5.5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#nameserver 10.96.0.10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;search kube-system.svc.cluster.local svc.cluster.local cluster.local&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;options ndots:5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä¿®æ”¹å®Œåå†è¿›è¡Œ ping å‘½ä»¤æµ‹è¯•ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½å¤Ÿè§£æ www.baidu.com ç½‘å€&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ ping www.baidu.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;PING www.a.shifen.com (180.101.49.11) 56(84) bytes of data.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64 bytes from 180.101.49.11 (180.101.49.11): icmp_seq=1 ttl=48 time=14.0 ms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64 bytes from 180.101.49.11 (180.101.49.11): icmp_seq=2 ttl=48 time=14.0 ms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# é€€å‡º DNSutils Pod å‘½ä»¤è¡Œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šé¢å¯ä¹Ÿè§‚å¯Ÿåˆ° Pod ä¸­æ›´æ¢ DNS æœåŠ¡å™¨åœ°å€åï¼ŒåŸŸåè§£ææ­£å¸¸ï¼Œè¯´æ˜ Pod æœ¬èº«åŸŸåè§£ææ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚&lt;/p&gt;
&lt;p&gt;æ¥ä¸‹æ¥å†ä¿®æ”¹ &lt;code&gt;resolv.conf&lt;/code&gt; ä¸­ &lt;code&gt;DNS&lt;/code&gt; è§£æè¯·æ±‚åœ°å€ä¸º &lt;code&gt;CoreDNS Pod&lt;/code&gt; çš„ &lt;code&gt;IP&lt;/code&gt; åœ°å€ï¼Œè¿™æ ·è®© &lt;code&gt;Pod&lt;/code&gt; ç›´æ¥è¿æ¥ &lt;code&gt;CoreDNS Pod&lt;/code&gt; çš„ &lt;code&gt;IP&lt;/code&gt;ï¼Œè€Œä¸é€šè¿‡ &lt;code&gt;Service&lt;/code&gt; è¿›è¡Œè½¬å‘ï¼Œå†è¿›è¡Œ &lt;code&gt;ping&lt;/code&gt; å‘½ä»¤æµ‹è¯•ï¼Œè¿›è€Œåˆ¤æ–­ &lt;code&gt;Service kube-dns&lt;/code&gt; æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è½¬å‘è¯·æ±‚åˆ° &lt;code&gt;CoreDNS Pod&lt;/code&gt; çš„é—®é¢˜ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# æŸ¥çœ‹ CoreDNS Pod çš„ IP åœ°å€&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods -n kube-system -o wide | grep coredns&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;coredns-669f77d7cc-rss5f     1/1     Running   0     10.244.2.155   k8s-node-2-13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;coredns-669f77d7cc-rt8l6     1/1     Running   0     10.244.1.163   k8s-node-2-12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;## è¿›å…¥ dnsutils Pod å†…éƒ¨ sh å‘½ä»¤è¡Œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; -it dnsutils /bin/sh -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;## ç¼–è¾‘ /etc/resolv.conf æ–‡ä»¶ï¼Œä¿®æ”¹ nameserver å‚æ•°ä¸ºé˜¿é‡Œäº‘æä¾›çš„ DNS æœåŠ¡å™¨åœ°å€&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ vi /etc/resolv.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nameserver 10.244.2.155&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nameserver 10.244.1.163&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#nameserver 10.96.0.10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;search kube-system.svc.cluster.local svc.cluster.local cluster.local&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;options ndots:5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ä¿®æ”¹å®Œåå†è¿›è¡Œ ping å‘½ä»¤æµ‹è¯•ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½å¤Ÿè§£æ www.baidu.com ç½‘å€&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ ping www.baidu.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;PING www.baidu.com (39.156.66.18): 56 data bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64 bytes from 39.156.66.18: seq=0 ttl=127 time=6.054 ms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64 bytes from 39.156.66.18: seq=1 ttl=127 time=4.678 ms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# é€€å‡º DNSutils Pod å‘½ä»¤è¡Œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# è§‚å¯Ÿ CoreDNS æ—¥å¿—ä¿¡æ¯ï¼ŒæŸ¥çœ‹æœ‰æ— åŸŸåè§£æç›¸å…³æ—¥å¿—&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; p &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; $(kubectl get pods --namespace=kube-system &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt; k8s-app=kube-dns -o name); \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; kubectl logs --namespace=kube-system &lt;span class=&quot;variable&quot;&gt;$p&lt;/span&gt;; &lt;span class=&quot;keyword&quot;&gt;done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.:53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = 6434d0912b39645ed0707a3569fd69dc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CoreDNS-1.6.7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;linux/amd64, go1.13.6, da7f65b&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/health: Going into lameduck mode &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 5s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 127.0.0.1:47278 - 55171 &lt;span class=&quot;string&quot;&gt;&quot;HINFO IN 4940754309314083739.5160468069505858354. udp 57 false 512&quot;&lt;/span&gt; NXDOMAIN qr,rd,ra 57 0.040844011s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading complete&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 10.244.1.162:40261 - 21083 &lt;span class=&quot;string&quot;&gt;&quot;AAAA IN www.baidu.com.kube-system.svc.cluster.local. udp 62 false 512&quot;&lt;/span&gt; NXDOMAIN qr,aa,rd 155 0.000398875s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 10.244.1.162:40261 - 20812 &lt;span class=&quot;string&quot;&gt;&quot;A IN www.baidu.com.kube-system.svc.cluster.local. udp 62 false 512&quot;&lt;/span&gt; NXDOMAIN qr,aa,rd 155 0.000505793s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 10.244.1.162:55066 - 53460 &lt;span class=&quot;string&quot;&gt;&quot;AAAA IN www.baidu.com.svc.cluster.local. udp 50 false 512&quot;&lt;/span&gt; NXDOMAIN qr,aa,rd 143 0.000215384s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 10.244.1.162:55066 - 53239 &lt;span class=&quot;string&quot;&gt;&quot;A IN www.baidu.com.svc.cluster.local. udp 50 false 512&quot;&lt;/span&gt; NXDOMAIN qr,aa,rd 143 0.000267642s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.:53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = 6434d0912b39645ed0707a3569fd69dc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CoreDNS-1.6.7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;linux/amd64, go1.13.6, da7f65b&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/health: Going into lameduck mode &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; 5s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading complete&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 127.0.0.1:32896 - 49064 &lt;span class=&quot;string&quot;&gt;&quot;HINFO IN 1027842207973621585.7098421666386159336. udp 57 false 512&quot;&lt;/span&gt; NXDOMAIN qr,rd,ra 57 0.044098742s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Reloading complete&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 10.244.1.162:40261 - 21083 &lt;span class=&quot;string&quot;&gt;&quot;AAAA IN www.baidu.com.kube-system.svc.cluster.local. udp 62 false 512&quot;&lt;/span&gt; NXDOMAIN qr,aa,rd 155 0.000217299s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 10.244.1.162:40261 - 20812 &lt;span class=&quot;string&quot;&gt;&quot;A IN www.baidu.com.kube-system.svc.cluster.local. udp 62 false 512&quot;&lt;/span&gt; NXDOMAIN qr,aa,rd 155 0.000264552s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 10.244.1.162:55066 - 53460 &lt;span class=&quot;string&quot;&gt;&quot;AAAA IN www.baidu.com.svc.cluster.local. udp 50 false 512&quot;&lt;/span&gt; NXDOMAIN qr,aa,rd 143 0.000144795s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] 10.244.1.162:55066 - 53239 &lt;span class=&quot;string&quot;&gt;&quot;A IN www.baidu.com.svc.cluster.local. udp 50 false 512&quot;&lt;/span&gt; NXDOMAIN qr,aa,rd 143 0.000221163s&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç»è¿‡ä¸Šé¢ä¸¤ä¸ªæµ‹è¯•ï¼Œå·²ç»å¯ä»¥å¾—çŸ¥ï¼Œå¦‚æœ &lt;code&gt;Pod DNS&lt;/code&gt; é…ç½®ä¸­ç›´æ¥ä¿®æ”¹ &lt;code&gt;DNS&lt;/code&gt; æœåŠ¡å™¨åœ°å€ä¸º &lt;code&gt;CoreDNS Pod&lt;/code&gt; çš„ &lt;code&gt;IP&lt;/code&gt; åœ°å€ï¼Œ&lt;code&gt;DNS&lt;/code&gt; è§£æç¡®å®æ²¡æœ‰é—®é¢˜ï¼Œèƒ½å¤Ÿæ­£å¸¸è§£æã€‚ä¸è¿‡ï¼Œæ­£å¸¸çš„æƒ…å†µä¸‹ Pod ä¸­ DNS é…ç½®çš„æœåŠ¡å™¨åœ°å€ä¸€èˆ¬æ˜¯ CoreDNS çš„ Service åœ°å€ï¼Œä¸ç›´æ¥ç»‘å®š Pod IPï¼ˆå› ä¸º Pod æ¯æ¬¡é‡å¯ IP éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼‰ã€‚ æ‰€ä»¥é—®é¢˜æ‰¾åˆ°äº†ï¼Œæ­£æ˜¯åœ¨ Pod å‘ CoreDNS çš„ Service â€œkube-dnsâ€ è¿›è¡ŒåŸŸåè§£æè¯·æ±‚è½¬å‘æ—¶ï¼Œå‡ºç°äº†é—®é¢˜ï¼Œä¸€èˆ¬ &lt;code&gt;Service&lt;/code&gt; çš„é—®é¢˜éƒ½è·Ÿ &lt;code&gt;Kube-proxy&lt;/code&gt; ç»„ä»¶æœ‰å…³ï¼Œæ¥ä¸‹æ¥è§‚å¯Ÿè¯¥ç»„ä»¶æ˜¯å¦å­˜åœ¨é—®é¢˜ã€‚&lt;/p&gt;
&lt;h4 id=&quot;7-åˆ†æ-Kube-Proxy-æ˜¯å¦å­˜åœ¨é—®é¢˜&quot;&gt;&lt;a href=&quot;#7-åˆ†æ-Kube-Proxy-æ˜¯å¦å­˜åœ¨é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;7. åˆ†æ Kube-Proxy æ˜¯å¦å­˜åœ¨é—®é¢˜&quot;&gt;&lt;/a&gt;7. åˆ†æ Kube-Proxy æ˜¯å¦å­˜åœ¨é—®é¢˜&lt;/h4&gt;&lt;p&gt;è§‚å¯Ÿ Kube-proxy çš„æ—¥å¿—ï¼ŒæŸ¥çœ‹æ˜¯å¦å­˜åœ¨é—®é¢˜ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# æŸ¥çœ‹ kube-proxy Pod åˆ—è¡¨&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl get pods -n kube-system | grep kube-proxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kube-proxy-6kdj2          1/1     Running   3          9h&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kube-proxy-lw2q6          1/1     Running   3          9h&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kube-proxy-mftlt          1/1     Running   3          9h&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; é€‰æ‹©ä¸€ä¸ª kube-proxy Podï¼ŒæŸ¥çœ‹æœ€å 5 æ¡æ—¥å¿—å†…å®¹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl logs kube-proxy-6kdj2 --tail=5  -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;E0326 15:20:23.159364  1 proxier.go:1950] Failed to list IPVS destinations, error: parseIP Error ip=[10 96 0 10 0 0 0 0 0 0 0 0 0 0 0 0]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;E0326 15:20:23.159388  1 proxier.go:1192] Failed to sync endpoint &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; service: 10.8.0.10:53/UPD, err: parseIP Error ip=[10 96 0 16 0 0 0 0 0 0 0 0 0 0 0 0]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;E0326 15:20:23.159479  1 proxier.go:1950] Failed to list IPVS destinations, error: parseIP Error ip=[10 96 0 10 0 0 0 0 0 0 0 0 0 0 0 0]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;E0326 15:20:23.159501  1 proxier.go:1192] Failed to sync endpoint &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; service: 10.8.0.10:53/TCP, err: parseIP Error ip=[10 96 0 16 0 0 0 0 0 0 0 0 0 0 0 0]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;E0326 15:20:23.159595  1 proxier.go:1950] Failed to list IPVS destinations, error: parseIP Error ip=[10 96 0 10 0 0 0 0 0 0 0 0 0 0 0 0]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;é€šè¿‡ kube-proxy Pod çš„æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œé‡Œé¢æœ‰å¾ˆå¤š Error çº§åˆ«çš„æ—¥å¿—ä¿¡æ¯ï¼Œæ ¹æ®å…³é”®å­— &lt;code&gt;IPVS&lt;/code&gt;ã€&lt;code&gt;parseIP Error&lt;/code&gt; å¯çŸ¥ï¼Œå¯èƒ½æ˜¯ç”±äº IPVS æ¨¡å—å¯¹ IP è¿›è¡Œæ ¼å¼åŒ–å¯¼è‡´å‡ºç°é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;å› ä¸ºè¿™ä¸ªé—®é¢˜æ˜¯å‡çº§åˆ° kubernetes 1.18 ç‰ˆæœ¬æ‰å‡ºç°çš„ï¼Œæ‰€ä»¥å» Kubernetes Github æŸ¥çœ‹ç›¸å…³ issuesï¼Œå‘ç°æœ‰äººåœ¨å‡çº§ Kubernetes ç‰ˆæœ¬åˆ° 1.18 åï¼Œä¹Ÿé‡è§äº†ç›¸åŒçš„é—®é¢˜ï¼Œç»è¿‡ issue ä¸­ Kubernetes ç»´æŠ¤äººå‘˜è®¨è®ºï¼Œåˆ†æå‡ºåŸå› å¯èƒ½ä¸ºæ–°ç‰ˆ Kubernetes ä½¿ç”¨çš„ IPVS æ¨¡å—æ˜¯æ¯”è¾ƒæ–°çš„ï¼Œéœ€è¦ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬æ”¯æŒï¼Œæœ¬äººä½¿ç”¨çš„æ˜¯ CentOS ç³»ç»Ÿï¼Œå†…æ ¸ç‰ˆæœ¬ä¸º 3.10ï¼Œé‡Œé¢çš„ IPVS æ¨¡å—æ¯”è¾ƒè€æ—§ï¼Œç¼ºå°‘æ–°ç‰ˆ Kubernetes IPVS æ‰€éœ€çš„ä¾èµ–ã€‚&lt;/p&gt;
&lt;p&gt;æ ¹æ®è¯¥ issue è®¨è®ºç»“æœï¼Œè§£å†³è¯¥é—®é¢˜çš„åŠæ³•æ˜¯ï¼Œæ›´æ–°å†…æ ¸ä¸ºæ–°çš„ç‰ˆæœ¬ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æ³¨ï¼šè¯¥ issues åœ°å€ä¸º &lt;a href=&quot;https://github.com/kubernetes/kubernetes/issues/89520&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/kubernetes/kubernetes/issues/89520&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;è§£å†³é—®é¢˜&quot;&gt;&lt;a href=&quot;#è§£å†³é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;è§£å†³é—®é¢˜&quot;&gt;&lt;/a&gt;è§£å†³é—®é¢˜&lt;/h2&gt;&lt;h3 id=&quot;å‡çº§ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬&quot;&gt;&lt;a href=&quot;#å‡çº§ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬&quot; class=&quot;headerlink&quot; title=&quot;å‡çº§ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬&quot;&gt;&lt;/a&gt;å‡çº§ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬&lt;/h3&gt;&lt;p&gt;å‡çº§ Kubernetes é›†ç¾¤å„ä¸ªèŠ‚ç‚¹çš„ CentOS ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# è½½å…¥å…¬é’¥&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# å®‰è£… ELRepo æœ€æ–°ç‰ˆæœ¬&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ yum install -y https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# åˆ—å‡ºå¯ä»¥ä½¿ç”¨çš„ kernel åŒ…ç‰ˆæœ¬&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ yum list available --disablerepo=* --enablerepo=elrepo-kernel&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# å®‰è£…æŒ‡å®šçš„ kernel ç‰ˆæœ¬ï¼š&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ yum install -y kernel&lt;span class=&quot;_&quot;&gt;-lt&lt;/span&gt;-4.4.222-1.el7.elrepo --enablerepo=elrepo-kernel&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# æŸ¥çœ‹ç³»ç»Ÿå¯ç”¨å†…æ ¸&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ cat /boot/grub2/grub.cfg | grep menuentry&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;menuentry &lt;span class=&quot;string&quot;&gt;&#39;CentOS Linux (3.10.0-1062.el7.x86_64) 7 (Core)&#39;&lt;/span&gt; --class centos ï¼ˆç•¥ï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;menuentry &lt;span class=&quot;string&quot;&gt;&#39;CentOS Linux (4.4.222-1.el7.elrepo.x86_64) 7 (Core)&#39;&lt;/span&gt; --class centos ...ï¼ˆç•¥ï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# è®¾ç½®å¼€æœºä»æ–°å†…æ ¸å¯åŠ¨&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ grub2-set-default &lt;span class=&quot;string&quot;&gt;&quot;CentOS Linux (4.4.222-1.el7.elrepo.x86_64) 7 (Core)&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# æŸ¥çœ‹å†…æ ¸å¯åŠ¨é¡¹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ grub2-editenv list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;saved_entry=CentOS Linux (4.4.222-1.el7.elrepo.x86_64) 7 (Core)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;é‡å¯ç³»ç»Ÿä½¿å†…æ ¸ç”Ÿæ•ˆï¼Œå¯åŠ¨å®ŒæˆæŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬æ˜¯å¦æ›´æ–°ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ uname -r&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4.4.222-1.el7.elrepo.x86_64&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;æµ‹è¯•-Pod-ä¸­-DNS-æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è§£æ&quot;&gt;&lt;a href=&quot;#æµ‹è¯•-Pod-ä¸­-DNS-æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è§£æ&quot; class=&quot;headerlink&quot; title=&quot;æµ‹è¯• Pod ä¸­ DNS æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è§£æ&quot;&gt;&lt;/a&gt;æµ‹è¯• Pod ä¸­ DNS æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è§£æ&lt;/h3&gt;&lt;p&gt;è¿›å…¥ Pod å†…éƒ¨ä½¿ç”¨ ping å‘½ä»¤æµ‹è¯• DNS æ˜¯å¦èƒ½æ­£å¸¸è§£æï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# è¿›å…¥ dnsutils Pod å†…éƒ¨ sh å‘½ä»¤è¡Œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl &lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; -it dnsutils /bin/sh -n kube-system&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Ping é›†ç¾¤å¤–éƒ¨ï¼Œä¾‹å¦‚è¿™é‡Œ ping ä¸€ä¸‹ç™¾åº¦&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ ping www.baidu.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64 bytes from 39.156.66.14 (39.156.66.14): icmp_seq=1 ttl=127 time=7.20 ms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64 bytes from 39.156.66.14 (39.156.66.14): icmp_seq=2 ttl=127 time=6.60 ms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64 bytes from 39.156.66.14 (39.156.66.14): icmp_seq=3 ttl=127 time=6.38 ms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Ping é›†ç¾¤å†…éƒ¨ kube-api çš„ Service åœ°å€&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ ping kubernetes.default&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64 bytes from kubernetes.default.svc.cluster.local (10.96.0.1): icmp_seq=1 ttl=64 time=0.051 ms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64 bytes from kubernetes.default.svc.cluster.local (10.96.0.1): icmp_seq=2 ttl=64 time=0.051 ms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64 bytes from kubernetes.default.svc.cluster.local (10.96.0.1): icmp_seq=3 ttl=64 time=0.064 ms&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ° Pod ä¸­çš„åŸŸåè§£æå·²ç»æ¢å¤æ­£å¸¸ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒ: mydlq.club&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;å¾®ä¿¡è®¢é˜…å·&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ç¯å¢ƒç°è±¡&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒç°è±¡&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒç°è±¡&quot;&gt;&lt;/a&gt;ç¯å¢ƒç°è±¡&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;CoreDNS ç‰ˆæœ¬ï¼š1.6.7&lt;br&gt;Docker ç‰ˆæœ¬ï¼š18.06.3-ce&lt;br&gt;Kubernetes ç‰ˆæœ¬ï¼š1.18.1&lt;br&gt;æ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼šCentOS 7.x&lt;br&gt;CentOS å†…æ ¸ç‰ˆæœ¬ï¼š3.10.0-693.2.2.el7.x86_64&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;é—®é¢˜ç°è±¡&quot;&gt;&lt;a href=&quot;#é—®é¢˜ç°è±¡&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜ç°è±¡&quot;&gt;&lt;/a&gt;é—®é¢˜ç°è±¡&lt;/h2&gt;&lt;p&gt;ç”±äºæœ€è¿‘è¦å‘ç»„å†…æ¼”ç¤º Istio 1.5ï¼Œæ•…åœ¨äº‘æœåŠ¡å™¨ä¸Šå®‰è£…äº†kubernetes 1.18.1 (ä½¿ç”¨ipvs) æ¥é…åˆ Istio 1.5 çš„æ¼”ç¤ºï¼Œkubernetes ä¸ istio å®‰è£…å®Œåä¸€åˆ‡é¡ºåˆ©ï¼Œbookinfo demoè·‘çš„ä¹Ÿéå¸¸çš„é¡ºåˆ©ã€‚ä½†åœ¨ä¸€æ¬¡é‡å¯æ•´ä¸ªé›†ç¾¤åï¼Œä¸€åˆ‡éƒ½å˜çš„ä¸é‚£ä¹ˆç¾å¥½äº†ã€‚istio-proxyèµ·ä¸æ¥äº†ï¼Œæç¤ºpilot not readyï¼Œæ›´å¯æ‚²çš„æ˜¯service name æ— æ³•è§£æäº†ï¼Œå¯¼è‡´å¾ˆå¤šæœåŠ¡ä¹‹é—´çš„è°ƒç”¨éƒ½æ²¡æ³•æ­£å¸¸å·¥ä½œï¼Œæœ‰ä¾èµ–çš„æœåŠ¡éƒ½ä¸èƒ½æ­£å¸¸å¯åŠ¨äº†ï¼Œä¸ºäº†æ›´å¥½çš„å®šä½é—®é¢˜ï¼Œäºæ˜¯å¸è½½ Istio 1.5ï¼Œé‡æ–°å›åˆ°k8s 1.18.1ä¸Šï¼Œåœ¨ä¸€æ­¥æ­¥æ’æŸ¥ä¸­å‘ç°ï¼Œåœ¨podä¸­ä½¿ç”¨pod ipç›¸äº’è®¿é—®æ˜¯å¯ä»¥çš„ï¼Œç”±æ­¤åˆ¤æ–­ï¼Œåˆæ­¥æ€€ç–‘å¾ˆå¯èƒ½æ˜¯ DNS å‡ºç°äº†é—®é¢˜ï¼Œåæ¥æ…¢æ…¢å‘ç° kube-proxy ä¸­çš„é”™è¯¯ï¼Œå†å®šä½åˆ° IPVS parseIP Error é”™è¯¯ï¼Œå†åˆ°è§£å†³é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯æ•´ä¸ªé—®é¢˜å®šä½åˆ†æ&lt;/p&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/categories/kubernetes/"/>
    
      <category term="coredns" scheme="http://team.jiunile.com/categories/kubernetes/coredns/"/>
    
      <category term="ipvs" scheme="http://team.jiunile.com/categories/kubernetes/coredns/ipvs/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/tags/kubernetes/"/>
    
      <category term="coredns" scheme="http://team.jiunile.com/tags/coredns/"/>
    
      <category term="ipvs" scheme="http://team.jiunile.com/tags/ipvs/"/>
    
      <category term="kube-proxy" scheme="http://team.jiunile.com/tags/kube-proxy/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes åœ¨ aws ä¸Šçš„åº”ç”¨</title>
    <link href="http://team.jiunile.com//blog/2020/01/k8s-k8s-in-aws-arch.html"/>
    <id>http://team.jiunile.com//blog/2020/01/k8s-k8s-in-aws-arch.html</id>
    <published>2020-01-08T13:00:00.000Z</published>
    <updated>2020-09-02T02:03:50.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;kubernetes-in-aws-Overviewï¼ˆEKSï¼‰&quot;&gt;&lt;a href=&quot;#kubernetes-in-aws-Overviewï¼ˆEKSï¼‰&quot; class=&quot;headerlink&quot; title=&quot;kubernetes in aws Overviewï¼ˆEKSï¼‰&quot;&gt;&lt;/a&gt;kubernetes in aws Overviewï¼ˆEKSï¼‰&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/images/k8s/aws_eks_arch.png&quot; alt=&quot;eks_in_aws&quot;&gt;&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;ä¸Šå›¾æ˜¯ kubernetes(EKS) åœ¨ aws ä¸Šçš„æ•´ä½“æƒ…å†µï¼Œä¸‹é¢æˆ‘ä¼šå¯¹æ¯å—è¿›è¡Œå±•å¼€è¯´æ˜&lt;/p&gt;
&lt;h2 id=&quot;åˆ†è§£è¯´æ˜&quot;&gt;&lt;a href=&quot;#åˆ†è§£è¯´æ˜&quot; class=&quot;headerlink&quot; title=&quot;åˆ†è§£è¯´æ˜&quot;&gt;&lt;/a&gt;åˆ†è§£è¯´æ˜&lt;/h2&gt;&lt;h3 id=&quot;kubernetes-or-eks&quot;&gt;&lt;a href=&quot;#kubernetes-or-eks&quot; class=&quot;headerlink&quot; title=&quot;kubernetes or eks&quot;&gt;&lt;/a&gt;kubernetes or eks&lt;/h3&gt;&lt;p&gt;kubernetes åŸç”Ÿæ”¯æŒåœ¨ aws ä¸Šä½¿ç”¨ï¼Œå…·ä½“å¦‚ä½•å¯ç”¨å¯å‚è€ƒ&lt;a href=&quot;http://team.jiunile.com/blog/2019/03/k8s-cloud.html&quot;&gt;kuberenetes äº‘åº”ç”¨å®è·µ&lt;/a&gt;ï¼Œè¿™é‡Œä¸åœ¨ç´¯èµ˜è¯´æ˜ã€‚æ—¢ç„¶é€‰æ‹©åœ¨äº‘ä¸Šä½¿ç”¨ k8s ï¼Œé‚£å°±ç›´æ¥ä½¿ç”¨äº‘æœ¬èº«æä¾›çš„èƒ½åŠ›ï¼ˆ&lt;a href=&quot;https://eksworkshop.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;EKS&lt;/a&gt;ï¼‰ï¼Œå°±æ²¡å¿…è¦è‡ªå·±å†å»é€‚é…ä¸€éï¼Œæ¯•ç«Ÿäº‘å‚å•†å·²ç»æä¾›äº†è¿™æ ·çš„æœåŠ¡ï¼Œä¸ºä»€ä¹ˆä¸å»ä½¿ç”¨å‘¢ï¼Ÿä¸è¿‡è‡ªå·±ä¹Ÿå¯ä»¥å»äº†è§£EKSä¸ºæˆ‘ä»¬åšäº†ä»€ä¹ˆï¼Ÿæ€ä¹ˆå»ç®¡ç†å®ƒï¼Ÿ&lt;/p&gt;
&lt;h4 id=&quot;EKS&quot;&gt;&lt;a href=&quot;#EKS&quot; class=&quot;headerlink&quot; title=&quot;EKS&quot;&gt;&lt;/a&gt;EKS&lt;/h4&gt;&lt;p&gt;&lt;a href=&quot;https://eksworkshop.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;EKS&lt;/a&gt; å…¶å®å°±æ˜¯å¸®æˆ‘ä»¬æ‰˜ç®¡äº†masterèŠ‚ç‚¹ï¼ˆ3 masteré›†ç¾¤ï¼‰ï¼Œå…¶æ¬¡æ›´å¥½çš„ä¸awsèµ„æºè¿›è¡Œäº†é›†æˆï¼Œå¸®åŠ©æˆ‘ä»¬åœ¨ä¸Šå±‚æ›´è½»æ¾çš„ä½¿ç”¨ï¼Œ&lt;a href=&quot;https://eksworkshop.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;EKS&lt;/a&gt; é»˜è®¤ä¼šé›†æˆä»¥ä¸‹ç»„ä»¶:  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;kube-proxy&lt;/li&gt;
&lt;li&gt;coredns&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/aws/amazon-vpc-cni-k8s&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;amazon-k8s-cni&lt;/a&gt; (ç½‘ç»œæ’ä»¶-æ›¿ä»£calicoï¼Œä¸‹é¢ä¼šä»‹ç»ä¸ºä½•ä½¿ç”¨å®ƒ)&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;p&gt;ä½¿ç”¨ &lt;a href=&quot;https://eksworkshop.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;EKS&lt;/a&gt; åï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦åœ¨å…³æ³¨ k8s master çš„å®‰è£…ä»¥åŠé«˜å¯ç”¨ï¼Œä»¥åŠæ€ä¹ˆåœ¨äº‘ä¸Šï¼ˆawsï¼‰çš„é›†æˆï¼ŒåŒæ—¶åœ¨å¼€æºçš„ kubernetes ä¸Šåšäº†ä¼˜åŒ–ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥å¯ä»¥é€‰æ‹©è‡ªå»ºï¼Œæ¯•ç«Ÿè¿™äº›ä½ éƒ½å¯ä»¥æ­å»ºå‡ºæ¥ï¼Œæˆ‘ä»¬åœ¨ aws ä¸­å›½å°±æ˜¯è‡ªå»ºçš„ï¼Œæ¯•ç«Ÿ &lt;a href=&quot;https://eksworkshop.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;EKS&lt;/a&gt; åœ¨å›½å†…è¿˜æœªä¸Šçº¿ï¼Œä½†å¦‚æœæ˜¯åœ¨å›½å¤–æˆ–è€…å›½å†…ä¸Šçº¿çš„å‰æä¸‹éœ€è¡¡é‡ä»˜å‡ºçš„æ—¶é—´æˆæœ¬æ˜¯å¦åˆç®—ï¼Ÿ&lt;/p&gt;
&lt;h4 id=&quot;å¦‚ä½•ç®¡ç†&quot;&gt;&lt;a href=&quot;#å¦‚ä½•ç®¡ç†&quot; class=&quot;headerlink&quot; title=&quot;å¦‚ä½•ç®¡ç†&quot;&gt;&lt;/a&gt;å¦‚ä½•ç®¡ç†&lt;/h4&gt;&lt;p&gt;&lt;a href=&quot;https://www.terraform.io&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;terrafrom&lt;/a&gt; or &lt;a href=&quot;https://eksctl.io&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;eksctl&lt;/a&gt;ï¼Œæœ€ç»ˆæˆ‘é€‰æ‹©äº†åè€…ï¼Œç†ç”±ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨æˆ‘çœ‹æ¥ä¸€ä¸ªå°±å¥½æ¯”æ˜¯â€å­¦ç”Ÿâ€ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯â€äº²å„¿å­â€ï¼Œ&lt;a href=&quot;https://eksctl.io&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;eksctl&lt;/a&gt; ç”± aws å®˜æ–¹æä¾›ä¸“é—¨ä¸º &lt;a href=&quot;https://eksworkshop.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;EKS&lt;/a&gt; æä¾›çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒæä¾›äº†æ›´å¤šçš„å‚æ•°åŒæ—¶ç®¡ç†èµ·æ¥ä¹Ÿéå¸¸çš„æ–¹ä¾¿ï¼Œå¦‚æœä½ æ˜¯æ·±åº¦ç®¡ç†ï¼Œåˆ™ä½¿ç”¨å®ƒï¼Œ&lt;a href=&quot;https://www.terraform.io&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;terrafrom&lt;/a&gt; åˆ™æ˜¯å¤§ä¼—æ™®ç…§ä¸­çš„ä¸€ä¸ªï¼Œæä¾›çš„å‚æ•°ä¹Ÿæ˜¯æœ‰é™ï¼Œå¦‚æœç®€å•ç®¡ç†å¯ä»¥ä½¿ç”¨å®ƒã€‚&lt;/p&gt;
&lt;h3 id=&quot;è´Ÿè½½å‡è¡¡å™¨ELB&quot;&gt;&lt;a href=&quot;#è´Ÿè½½å‡è¡¡å™¨ELB&quot; class=&quot;headerlink&quot; title=&quot;è´Ÿè½½å‡è¡¡å™¨ELB&quot;&gt;&lt;/a&gt;è´Ÿè½½å‡è¡¡å™¨ELB&lt;/h3&gt;&lt;h4 id=&quot;ä»‹ç»&quot;&gt;&lt;a href=&quot;#ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä»‹ç»&quot;&gt;&lt;/a&gt;ä»‹ç»&lt;/h4&gt;&lt;p&gt;aws å®˜æ–¹æä¾›äº†ä¸‰ç§è´Ÿè½½å‡è¡¡å™¨ï¼Œæˆ‘ç®€å•æˆä¸º &lt;code&gt;clb&lt;/code&gt;ã€&lt;code&gt;alb&lt;/code&gt;ã€&lt;code&gt;nlb&lt;/code&gt;ï¼Œ&lt;code&gt;clb&lt;/code&gt; å³å°†æ·˜æ±°ä¹Ÿæ˜¯æœ€æ—©çš„ä¸€ä»£ï¼Œè¿™é‡Œä¸»è¦é˜è¿° &lt;code&gt;alb&lt;/code&gt; 7å±‚è´Ÿè½½  ä¸ &lt;code&gt;nlb&lt;/code&gt; 4å±‚è´Ÿè½½ ï¼Œè¯¥å¦‚ä½•é€‰æ‹©ï¼Œåˆ™å–å†³äºä½ çš„ä¸šåŠ¡ï¼Œä»–ä»¬ä¹‹é—´çš„ç‰¹å¾ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¦‚æœä½ æ˜¯éœ€è¦å…³æ³¨ &lt;code&gt;header&lt;/code&gt; å¤´ä¿¡æ¯çš„ï¼Œå¦‚ &lt;code&gt;x-forward-for&lt;/code&gt; æˆ– &lt;code&gt;x-forward-proto&lt;/code&gt; ç­‰ä¿¡æ¯çš„åˆ™ä½¿ç”¨ &lt;code&gt;alb&lt;/code&gt;ï¼Œå¦‚æœä¸éœ€è¦åˆ™ä½¿ç”¨ &lt;code&gt;nlb&lt;/code&gt; æ€§èƒ½é«˜ã€‚å…·ä½“æƒ³äº†è§£ï¼Œå¯å‚è€ƒawså®˜æ–¹æ–‡æ¡£ï¼š&lt;a href=&quot;https://aws.amazon.com/cn/elasticloadbalancing/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://aws.amazon.com/cn/elasticloadbalancing/&lt;/a&gt;&lt;/p&gt;
&lt;h4 id=&quot;ç®¡ç†&quot;&gt;&lt;a href=&quot;#ç®¡ç†&quot; class=&quot;headerlink&quot; title=&quot;ç®¡ç†&quot;&gt;&lt;/a&gt;ç®¡ç†&lt;/h4&gt;&lt;p&gt;åŒæ ·æˆ‘ä»¬ä¹Ÿé¢ä¸´ç€ç®¡ç†çš„é—®é¢˜ï¼Œæ˜¯ä½¿ç”¨ &lt;a href=&quot;https://www.terraform.io&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;terrafrom&lt;/a&gt; è¿˜æ˜¯åˆ«çš„å‘¢ï¼Ÿæ¯•ç«Ÿæˆ‘ä»¬ä½¿ç”¨äº† k8s ï¼Œå®ƒæœ‰å¾ˆå¥½çš„ &lt;code&gt;ingress&lt;/code&gt; å¸®æˆ‘ä»¬ç®¡ç†ç€å¯¹å¤–çš„è®¿é—®ä¸æ˜¯ä¹ˆï¼Ÿæœ€ç»ˆï¼Œæˆ‘é€‰æ‹©äº† &lt;a href=&quot;https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/config/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;alb-ingress-controller&lt;/a&gt;ï¼ŒåŒæ ·ä¹Ÿæ˜¯ aws å‡ºå“ï¼Œå®ƒå¾ˆå¥½çš„ä¸ ELB è¿›è¡Œäº†é›†æˆï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™ &lt;code&gt;ingress&lt;/code&gt; æ–‡ä»¶ï¼ŒåŠ ä¸Šå¯¹åº”çš„æ³¨è§£ï¼Œå°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨ ELBï¼Œç›®å‰æ”¯æŒ &lt;code&gt;alb&lt;/code&gt; ä¸ &lt;code&gt;nlb&lt;/code&gt; è¿™ä¸¤ä¸ªè´Ÿè½½å‡è¡¡å™¨çš„ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹ &lt;a href=&quot;https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/config/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;alb-ingress-controller&lt;/a&gt; çš„ä½¿ç”¨ä¹Ÿæœ‰ä¸€å®šçš„æ³¨æ„ï¼Œæ¨èæ˜¯ä¸€ä¸ªå¯¹å¤–æš´éœ²æœåŠ¡ä¸€ä¸ª &lt;code&gt;ingress&lt;/code&gt;, &lt;strong&gt;åŒæ—¶æ³¨æ„ä¸è¦äººä¸ºå» aws consol ç•Œé¢å»ä¿®æ”¹å·²æœ‰é€šè¿‡ &lt;a href=&quot;https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/config/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;alb-ingress-controller&lt;/a&gt;  åˆ›å»ºå‡ºæ¥çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œå¦‚æœä½ ä¿®æ”¹äº†ï¼Œä½ ä¼šå‘ç°è¿‡ä¸€ä¼šå°±ä¼šè¿˜åŸäº†&lt;/strong&gt;ï¼Œå› ä¸ºåœ¨ k8s ä¸­çš„ alb æ§åˆ¶å™¨ä¼šå¸®ä½ å¤åŸï¼Œæ‰€ä»¥ä¸€åˆ‡çš„å˜æ›´è¯·ä½¿ç”¨ &lt;code&gt;ingress&lt;/code&gt;, åŒæ—¶è¿˜æœ‰ä¸€ä¸ªä¸å¥½çš„å¼Šç«¯å°±æ˜¯åœ¨ alb/nlb ç›®æ ‡ç¾¤ç»„ä¸­ï¼Œåç«¯åè®®åªèƒ½äºŒé€‰ä¸€ï¼Œæ— æ³• http/https åŒæ—¶å­˜åœ¨ï¼Œå”¯ä¸€çš„æ–¹æ³•æ˜¯ä½¿ç”¨ä¸¤ä¸ª &lt;code&gt;ingress&lt;/code&gt; ï¼Œä¸è¿‡æˆ‘ä»¬å¤§å¤šæ•°åç«¯è®¿é—®éƒ½æ˜¯ http åè®®ã€‚&lt;/p&gt;
&lt;p&gt;è¯¦ç»†äº†è§£å¯å‚è€ƒï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/kubernetes-sigs/aws-alb-ingress-controller/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/kubernetes-sigs/aws-alb-ingress-controller/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/config/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/config/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/alb-ingress.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/alb-ingress.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://aws.amazon.com/cn/blogs/china/kubernetes-ingress-aws-alb-ingress-controller/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://aws.amazon.com/cn/blogs/china/kubernetes-ingress-aws-alb-ingress-controller/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;ç½‘ç»œæ’ä»¶&quot;&gt;&lt;a href=&quot;#ç½‘ç»œæ’ä»¶&quot; class=&quot;headerlink&quot; title=&quot;ç½‘ç»œæ’ä»¶&quot;&gt;&lt;/a&gt;ç½‘ç»œæ’ä»¶&lt;/h3&gt;&lt;p&gt;åŒæ ·ï¼Œåœ¨ç½‘ç»œæ’ä»¶ä¸Šï¼Œæˆ‘ä¹Ÿé¢ä¸´ç€é€‰æ‹©çš„é—®é¢˜ï¼Œä¸è¿‡ç°åœ¨å›æƒ³èµ·æ¥ï¼Œå±…ç„¶é€‰æ‹©äº†äº‘ï¼Œé‚£å°±åŸºæœ¬å¤§æ¦‚ç‡ä¸Šå»æ‹¥æŠ±äº‘åŸç”Ÿæä¾›çš„æ’ä»¶ï¼Œä¸æ˜¯ä¹ˆï¼Œæ¯•ç«Ÿå®ƒå’Œäº‘ç»“åˆçš„å¾ˆå¥½ï¼Œè¿™é‡Œæˆ‘ä»‹ç»ä¸‹ &lt;a href=&quot;https://github.com/aws/amazon-vpc-cni-k8s&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;amazon-k8s-cni&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/aws/amazon-vpc-cni-k8s&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;amazon-k8s-cni&lt;/a&gt; æˆ‘å°±è¯´ä¸€ä»¶äº‹ï¼Œ&lt;strong&gt;pod ä¸ä½ ç°æœ‰çš„ vpc æ‰“é€š&lt;/strong&gt;ï¼Œä½†åŠ£åŠ¿ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œ&lt;code&gt;å°±æ˜¯ pod çš„ ip ä¼šå æœ‰ä½ åˆ’åˆ†çš„ vpc ipæ± &lt;/code&gt;ï¼Œå¦‚æœä½ çš„ &lt;code&gt;subnet&lt;/code&gt; ç½‘æ®µè§„åˆ’çš„ä¸å¥½çš„è¯ï¼Œä½ çš„ ip å°†ä¼šå¾ˆå¿«ç”¨å…‰ï¼Œæ‰€æœ‰æˆ‘å»ºè®®ä½ çš„ &lt;code&gt;vpc&lt;/code&gt; ç½‘æ®µæ˜¯ &lt;code&gt;16&lt;/code&gt; ä½ï¼Œ&lt;code&gt;subnet&lt;/code&gt; ç½‘æ®µæ˜¯ &lt;code&gt;20&lt;/code&gt; ä½çš„ï¼Œå…·ä½“ä¸åŒçš„ç½‘æ®µå¯ä»¥æ”¾å¤šå°‘ä¸ª pod å¯ä»¥å‚è€ƒè¿™è¾¹æ–‡ç« äº†è§£ä¸‹ï¼š&lt;a href=&quot;https://www.yiibai.com/ipv4/ipv4_subnetting.htmlï¼Œ&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.yiibai.com/ipv4/ipv4_subnetting.htmlï¼Œ&lt;/a&gt; è¿™é‡Œä¹Ÿä¸åœ¨ç´¯èµ˜ã€‚ &lt;/p&gt;
&lt;p&gt;åŒæ—¶ &lt;a href=&quot;https://github.com/aws/amazon-vpc-cni-k8s&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;amazon-k8s-cni&lt;/a&gt; å¯¹ä¸»æœºç±»å‹ä¸Šèƒ½èµ·å¤šå°‘ pod ä¹Ÿæ˜¯æœ‰é™åˆ¶çš„ï¼Œä¸åŒçš„æœºå‹ä¸Šå¯åŠ¨çš„ pod æ•°é‡æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™é‡Œæˆ‘æ¨èå°½å¯èƒ½çš„ä½¿ç”¨ä¸­ç­‰è§„æ¨¡çš„æœºå‹æ¥å–ç¼”å¤šä¸ªå°æœºå‹ã€‚å…·ä½“å¯å‚è€ƒï¼š&lt;a href=&quot;https://github.com/aws/amazon-vpc-cni-k8s/blob/f7a7d53baf769846c20467cfa27f0172eca570c1/pkg/awsutils/vpc_ip_resource_limit.go&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;vpc_ip_resource_limit&lt;/a&gt; &lt;/p&gt;
&lt;p&gt;å½“ç„¶å¦‚æœä½ æ˜¯æœ¬åœ°æœºæˆ¿æˆ–è€…äº‘æœªç»™æä¾›ç½‘ç»œæ’ä»¶çš„è¯ï¼Œé‚£æˆ‘è¿˜æ˜¯æ¨èä½ ä½¿ç”¨ &lt;a href=&quot;https://www.projectcalico.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;calico&lt;/a&gt;ï¼Œæ¯•ç«Ÿå®ƒè¿˜æ˜¯éå¸¸çš„å¼ºå¤§ï¼æœ‰å…´è¶£çš„ä¼™ä¼´è¿˜æ˜¯å¯ä»¥å¥½å¥½äº†è§£ä¸‹ã€‚&lt;/p&gt;
&lt;h3 id=&quot;è®¿é—®å®‰å…¨&quot;&gt;&lt;a href=&quot;#è®¿é—®å®‰å…¨&quot; class=&quot;headerlink&quot; title=&quot;è®¿é—®å®‰å…¨&quot;&gt;&lt;/a&gt;è®¿é—®å®‰å…¨&lt;/h3&gt;&lt;p&gt;å®¹å™¨è®¿é—®å®‰å…¨ä¹Ÿæ˜¯ä»¤æˆ‘éå¸¸å›°æ‰°çš„ä¸€ä¸ªé—®é¢˜ï¼Œaws åœ¨èµ„æºè®¿é—®æ–¹é¢æœ‰ç€éå¸¸å¥½çš„æƒé™æ§åˆ¶ &lt;code&gt;iam role&lt;/code&gt; ï¼Œä½†æ”¾åˆ° k8s å®¹å™¨ä¸­ï¼Œä¸€åˆ‡éƒ½å˜çš„éå¸¸ä¸ç¾å¥½äº†ï¼Œ ç›´åˆ°æœ€è¿‘ aws eks æ¨å‡ºäº† &lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/iam-roles-for-service-accounts.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;service account for iam role&lt;/a&gt;ï¼Œ åœ¨ eks æ²¡æ­£å¼æ¨å‡º &lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/iam-roles-for-service-accounts.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;service account for iam role&lt;/a&gt; ä¹‹å‰ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è¿›è¡Œè®¿é—®æ§åˆ¶ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;access key/secret key&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/jtblin/kube2iam&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;kube2iam&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;p&gt;é’ˆå¯¹ä»¥ä¸Šä¸¤ä¸ªè®¿é—®ï¼Œéƒ½æœ‰ä¸€å®šçš„ç¼ºé™·ï¼Œç”¨keyæ¥æ§åˆ¶çš„é—®é¢˜åœ¨äºæœ¬èº«ç®¡ç†keyå°±æ˜¯ä¸€ä»¶å¤´ç—›çš„äº‹æƒ…ï¼Œkeyçš„æ³„æ¼å’Œå®šæœŸæ›´æ¢éå¸¸ç—›è‹¦ï¼Œä½¿ç”¨ &lt;a href=&quot;https://github.com/jtblin/kube2iam&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;kube2iam&lt;/a&gt; é—®é¢˜åœ¨äºä½ éœ€è¦ä¿è¯è¿™ä¸ªæ’ä»¶çš„ç¨³å®šæ€§å’Œæ€§èƒ½ï¼Œä¸€æ—¦å‡ºç°é—®é¢˜ï¼Œä½ ä¼šå‘ç°é‚£å°±æ˜¯ç¾éš¾æ€§çš„ï¼Œè€Œä¸”ä¹Ÿä¸æ˜“æ’æŸ¥ï¼Œæ¯•ç«Ÿå¤šå±‚ç»„ä»¶å°±å¤šæå‡äº†å‡ºé—®é¢˜çš„æ¦‚ç‡ï¼Œæ¯•ç«Ÿè¿˜æ˜¯å¦‚æ­¤é‡è¦çš„ç»„ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;æœ€åï¼Œæˆ‘éš†é‡æ¨èå¤§å®¶ä½¿ç”¨ &lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/iam-roles-for-service-accounts.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;service account for iam role&lt;/a&gt; ï¼Œå…·ä½“æ•™ç¨‹å¯ç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚ ä½†å¯¹äºè‡ªå»ºçš„å°ä¼™ä»¬åªèƒ½é€€è€Œæ±‚å…¶æ¬¡ ä½¿ç”¨ key æˆ–è€… &lt;a href=&quot;https://github.com/jtblin/kube2iam&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;kube2iam&lt;/a&gt; æ¥è¿›è¡Œç®¡ç†æ§åˆ¶äº†&lt;/p&gt;
&lt;h3 id=&quot;Why-kong&quot;&gt;&lt;a href=&quot;#Why-kong&quot; class=&quot;headerlink&quot; title=&quot;Why kong?&quot;&gt;&lt;/a&gt;Why kong?&lt;/h3&gt;&lt;p&gt;ä¸ºä»€ä¹ˆé€‰å‹ &lt;a href=&quot;http://getkong.org&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;kong&lt;/a&gt; ï¼Œæˆ‘æƒ³å®ƒçš„å®˜æ–¹æ–‡æ¡£èƒ½æ›´å¥½çš„ä¸ºä½ é˜è¿°ï¼Œæˆ‘ä»0.9å¼€å§‹å°±ä½¿ç”¨å®ƒäº†ï¼Œç›´åˆ°ç°åœ¨ç»´æŒåœ¨0.14.1ï¼Œå¾€åå¼•å…¥äº† &lt;code&gt;service mesh&lt;/code&gt; çš„æ¦‚å¿µï¼Œé€‰å‹ &lt;a href=&quot;http://getkong.org&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;kong&lt;/a&gt; çš„ç†ç”±ä¹Ÿå¾ˆç®€å•ï¼Œå¼€æºã€æ’ä»¶ä¸°å¯Œã€æ˜“äºäºŒæ¬¡å¼€å‘ã€‚åé¢å¯ä»¥ä¸“é—¨åˆ†äº«ä¸€ä¸‹æˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨  &lt;a href=&quot;http://getkong.org&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;kong&lt;/a&gt; ä½œä¸ºæˆ‘ä»¬çš„ä¸šåŠ¡ç½‘å…³ï¼ŒåŒæ—¶æˆ‘ä»¬æ˜¯å¦‚ä½•æ”¹é€  &lt;code&gt;JWT&lt;/code&gt; æ’ä»¶æ¥å®ç°é‰´æˆæƒï¼Œä»¥åŠé€šè¿‡ç½‘å…³å®¡è®¡æ—¥å¿—å®šä½é—®é¢˜ï¼Œå¯¹å¤–æ ¸å¿ƒæœåŠ¡è¿›è¡Œäº†é™æµç­‰æ§åˆ¶ã€‚å¦‚æœä½ çš„éœ€æ±‚ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œè®©ä¸šåŠ¡ä¿æŒè¶³å¤Ÿç®€å•ä¸“æ³¨äºä¸šåŠ¡çš„å®ç°ï¼Œè·¨è¯­è¨€ï¼Œå¾®æœåŠ¡åŒ–ï¼Œä½†åŒæ—¶éœ€è¦ä¸€äº›æœåŠ¡æ²»ç†ç›¸å…³çš„éœ€æ±‚ï¼Œè¿˜æ²¡æœ‰ä¸Š k8s æˆ–è€…è¿˜æ²¡åˆ° &lt;a href=&quot;https://istio.io&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;isito&lt;/a&gt; è¿™ç§é‡ &lt;code&gt;service mesh&lt;/code&gt; çš„åœ°æ­¥ï¼Œé‚£  &lt;a href=&quot;http://getkong.org&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;kong&lt;/a&gt; å°±æ˜¯ä½ æœ€å¥½çš„é€‰æ‹©ã€‚&lt;/p&gt;
&lt;h3 id=&quot;èµ„æºæ± åˆ’åˆ†&quot;&gt;&lt;a href=&quot;#èµ„æºæ± åˆ’åˆ†&quot; class=&quot;headerlink&quot; title=&quot;èµ„æºæ± åˆ’åˆ†&quot;&gt;&lt;/a&gt;èµ„æºæ± åˆ’åˆ†&lt;/h3&gt;&lt;p&gt;åœ¨èµ„æºæ± åˆ’åˆ†ä¸Šï¼Œæˆ‘å°†ç½‘å…³å’Œä¸šåŠ¡çš„æ± å­å•ç‹¬åˆ†å¼€ï¼ŒåŒæ—¶å¼€è¾Ÿäº†ä¸€å—ç«ä»·æ± ï¼ŒåŸå› å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ç½‘å…³æ± åˆ’åˆ†ï¼š ç½‘å…³ä½œä¸ºä¸šåŠ¡å¯¹å¤–æµé‡çš„ç»Ÿä¸€å…¥å£ï¼Œæç°å‡ºéå¸¸é‡è¦çš„åœ°æ­¥ï¼Œæ•…è€Œå•ç‹¬åˆ†é…äº†ä¸€å—èµ„æºæ± ï¼ŒåŒæ—¶éœ€è¦ä¸è´Ÿè½½å‡è¡¡å™¨çš„é…ç½®ï¼Œå¯¹æœºå™¨æƒé™çš„æ§åˆ¶åŠ›åº¦ä¹Ÿæ˜¯å’Œæ™®é€šä¸šåŠ¡æ± æ˜¯ä¸åŒçš„ã€‚&lt;/li&gt;
&lt;li&gt;ä¸šåŠ¡æ± åˆ’åˆ†ï¼šè¿™ä¸ªå°±ä»€ä¹ˆå¥½è¯´çš„ï¼Œç”¨äºæ‰¿è½½ä½ çš„ä¸šåŠ¡ï¼Œè·‘é•¿æœŸè¿è¡Œçš„æœåŠ¡ã€‚&lt;/li&gt;
&lt;li&gt;ç«ä»·æ± åˆ’åˆ†ï¼š è¿™é‡Œéœ€è¦é…åˆ &lt;a href=&quot;https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;cluster autoscaler&lt;/a&gt; ä¸€èµ·ä½¿ç”¨æ›´ä½³ï¼Œç”¨äºè·‘ä¸€äº›ç¦»çº¿ä»»åŠ¡ï¼Œéšç”¨éšèµ·ï¼Œç”¨å®Œå³æ¯ï¼Œæ–¹ä¾¿è‡³æã€‚å½“ç„¶å¦‚ä½•ä½ ä½¿ç”¨çš„æ˜¯ EKS ç›´æ¥å¯ä»¥é…åˆ &lt;a href=&quot;https://aws.amazon.com/cn/fargate/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;fargate&lt;/a&gt; æ¥ç›´æ¥ä½¿ç”¨ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;hr&gt;
&lt;p&gt;Cluster Autoscalerï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/cluster-autoscaler.html#ca-ng-considerations&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/cluster-autoscaler.html#ca-ng-considerations&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;æœªæ¥å±•æœ›&quot;&gt;&lt;a href=&quot;#æœªæ¥å±•æœ›&quot; class=&quot;headerlink&quot; title=&quot;æœªæ¥å±•æœ›&quot;&gt;&lt;/a&gt;æœªæ¥å±•æœ›&lt;/h3&gt;&lt;p&gt;ç›®å‰ï¼Œæˆ‘ä»¬é€šè¿‡ &lt;a href=&quot;http://getkong.org&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;kong&lt;/a&gt; æ¥å®ç°äº†å¯¹å¤–æµé‡çš„ç®¡ç†ä¸æ§åˆ¶ï¼Œä½†å¯¹å†…éƒ¨æœåŠ¡ä¹‹é—´çš„è®¿é—®æ§åˆ¶è¿˜æœªå¼€å§‹ï¼Œä¹Ÿç¼ºä¹ä¸€äº›æœåŠ¡æ²»ç†çš„æ‰‹æ®µï¼Œå½“ç„¶ï¼Œä½¿ç”¨ &lt;a href=&quot;http://getkong.org&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;kong&lt;/a&gt; ä¹Ÿå¯ä»¥è¾¾åˆ°ï¼Œä½†è¿™æ ·æˆ‘ä»¬å°±ä¼šè¿‡æ¸¡ä¾èµ–è¿™ä¸ªé›†ä¸­ç½‘å…³äº†ï¼Œä¸€æ—¦æ•…éšœï¼Œé‚£æ˜¯ç¾éš¾æ€§çš„ï¼Œ&lt;code&gt;service mesh&lt;/code&gt; çš„åˆ°æ¥æ­£å¼è§£å†³æ­¤ç±»é—®é¢˜ï¼Œè®©æœåŠ¡æ²»ç†å˜çš„æ›´æ¸¸åˆƒæœ‰ä½™ï¼Œåé¢æˆ‘ä»¬ä¼šä¸Š &lt;a href=&quot;https://istio.io&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;isito&lt;/a&gt; æ¥å®ç°è¯¸å¦‚ç°åº¦ã€è“ç»¿å‘å¸ƒä»¥åŠå¯¹å†…éƒ¨æœåŠ¡è°ƒç”¨é™æµã€ç›‘æ§ç­‰æ§åˆ¶èƒ½åŠ›çš„åŠ å¼ºã€‚&lt;/p&gt;
&lt;h2 id=&quot;æ–‡æ¡£&quot;&gt;&lt;a href=&quot;#æ–‡æ¡£&quot; class=&quot;headerlink&quot; title=&quot;æ–‡æ¡£&quot;&gt;&lt;/a&gt;æ–‡æ¡£&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.aws.amazon.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://docs.aws.amazon.com/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://getkong.org&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://getkong.org&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://eksctl.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://eksctl.io/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://eksworkshop.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://eksworkshop.com&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/images/wx_dyh.png&quot; alt=&quot;å¾®ä¿¡è®¢é˜…å·&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;kubernetes-in-aws-Overviewï¼ˆEKSï¼‰&quot;&gt;&lt;a href=&quot;#kubernetes-in-aws-Overviewï¼ˆEKSï¼‰&quot; class=&quot;headerlink&quot; title=&quot;kubernetes in aws Overviewï¼ˆEKSï¼‰&quot;&gt;&lt;/a&gt;kubernetes in aws Overviewï¼ˆEKSï¼‰&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/images/k8s/aws_eks_arch.png&quot; alt=&quot;eks_in_aws&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/categories/kubernetes/"/>
    
      <category term="cloud" scheme="http://team.jiunile.com/categories/kubernetes/cloud/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/tags/kubernetes/"/>
    
      <category term="aws" scheme="http://team.jiunile.com/tags/aws/"/>
    
      <category term="eks" scheme="http://team.jiunile.com/tags/eks/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†æå¹¶è§£å†³AWSæœåŠ¡ä»ec2è¿ç§»è‡³Kubernetesåå»¶è¿Ÿå¢åŠ çš„é—®é¢˜</title>
    <link href="http://team.jiunile.com//blog/2020/01/k8s-k8s-in-aws-latency.html"/>
    <id>http://team.jiunile.com//blog/2020/01/k8s-k8s-in-aws-latency.html</id>
    <published>2020-01-06T13:00:00.000Z</published>
    <updated>2020-01-07T07:30:48.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;é—®é¢˜æ¦‚è¦&quot;&gt;&lt;a href=&quot;#é—®é¢˜æ¦‚è¦&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æ¦‚è¦&quot;&gt;&lt;/a&gt;é—®é¢˜æ¦‚è¦&lt;/h2&gt;&lt;p&gt;ä¸Šå‘¨æˆ‘ä»¬å°†ä¸€ä¸ªå¾®æœåŠ¡è¿ç§»åˆ°ä¸­å¤®å¹³å°ä¸Šï¼ŒåŒ…æ‹¬CI/CDï¼ŒKubernetesè¿è¡Œæ—¶ï¼Œmetricå’Œå…¶ä»–ä¸€äº›ç¨‹åºã€‚è¿™æ¬¡å®éªŒæ˜¯ä¸ºäº†ä¹‹åä¸€ä¸ªæœˆé‡Œå¤§æ¦‚150ä¸ªå¾®æœåŠ¡çš„è¿ç§»ä½œå‡†å¤‡ï¼Œæ‰€æœ‰è¿™äº›æœåŠ¡æ”¯æ’‘ç€è¥¿ç­ç‰™åœ¨çº¿å¸‚åœºçš„è¿è¥ã€‚&lt;/p&gt;
&lt;p&gt;å½“æˆ‘ä»¬å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°Kubernetesä¸Šï¼Œå¹¶ä¸”å°†ä¸€äº›ç”Ÿäº§æµé‡å¯¼å…¥å…¶ä¸­ä¹‹åï¼Œäº‹æƒ…å¼€å§‹æœ‰äº›ä¸å¦™äº†ã€‚Kubernetesä¸Šçš„è¯·æ±‚å»¶è¿Ÿæ¯”EC2ä¸Šçš„é«˜10å€å·¦å³ã€‚é™¤éæˆ‘ä»¬èƒ½æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œä¸ç„¶è¿™ä¼šæ˜¯å¾®æœåŠ¡è¿ç§»çš„æœ€å¤§éšœç¢ï¼Œç”šè‡³å¯èƒ½å½»åº•æ‘§æ¯æ•´ä¸ªé¡¹ç›®ã€‚&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;ä¸ºä»€ä¹ˆKubernetesä¸Šçš„å»¶æ—¶æ¯”EC2é«˜é‚£ä¹ˆå¤šï¼Ÿ&quot;&gt;&lt;a href=&quot;#ä¸ºä»€ä¹ˆKubernetesä¸Šçš„å»¶æ—¶æ¯”EC2é«˜é‚£ä¹ˆå¤šï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;ä¸ºä»€ä¹ˆKubernetesä¸Šçš„å»¶æ—¶æ¯”EC2é«˜é‚£ä¹ˆå¤šï¼Ÿ&quot;&gt;&lt;/a&gt;ä¸ºä»€ä¹ˆKubernetesä¸Šçš„å»¶æ—¶æ¯”EC2é«˜é‚£ä¹ˆå¤šï¼Ÿ&lt;/h2&gt;&lt;p&gt;ä¸ºäº†æ‰¾åˆ°ç³»ç»Ÿç“¶é¢ˆï¼Œæˆ‘ä»¬æ”¶é›†äº†æ•´ä¸ªè¯·æ±‚è·¯å¾„çš„metricã€‚æ¶æ„å¾ˆç®€å•ï¼Œä¸€ä¸ªAPIç½‘å…³ï¼ˆZuulï¼‰å°†è¯·æ±‚è·¯ç”±åˆ°EC2æˆ–è€…Kubernetesçš„å¾®æœåŠ¡é‡Œã€‚åœ¨Kubernetesä¸Šï¼Œæˆ‘ä»¬ä½¿ç”¨NGINX Ingressæ§åˆ¶å™¨ï¼Œåå°æ˜¯å¸¸è§„çš„Deploymentè¿è¡Œä¸€ä¸ªåŸºäºSpringçš„JVMåº”ç”¨ç¨‹åºã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;                                  EC2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                            +---------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                            |  +---------+  |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                            |  |         |  |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       +-------&amp;gt; BACKEND |  |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       |    |  |         |  |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       |    |  +---------+  |                   &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       |    +---------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             +------+  |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Public       |      |  |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      -------&amp;gt; ZUUL +--+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;traffic      |      |  |              Kubernetes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             +------+  |    +-----------------------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       |    |  +-------+      +---------+ |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       |    |  |       |  xx  |         | |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       +-------&amp;gt; NGINX +------&amp;gt; BACKEND | |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                            |  |       |  xx  |         | |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                            |  +-------+      +---------+ |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                            +-----------------------------+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;é—®é¢˜çœ‹ä¸Šå»æ˜¯åå°çš„ä¸Šæ¸¸å»¶è¿Ÿï¼ˆä¸Šå›¾ç”¨xxè¡¨ç¤ºï¼‰ã€‚å½“åº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨EC2ä¸Šæ—¶ï¼Œå“åº”æ—¶é—´å¤§æ¦‚20msã€‚åœ¨Kubernetesä¸Šåˆ™éœ€è¦100ï½200msã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å¾ˆå¿«æ’é™¤äº†è¿è¡Œæ—¶å˜æ›´çš„å½±å“ã€‚JVMç‰ˆæœ¬æ˜¯ä¸€è‡´çš„ã€‚å®¹å™¨åŒ–çš„å½±å“ä¹Ÿè¢«æ’é™¤äº†ï¼Œå› ä¸ºEC2ä¸Šä¹Ÿæ˜¯è¿è¡Œåœ¨å®¹å™¨é‡Œã€‚ä¹Ÿå’Œå‹åŠ›æ— å…³ï¼Œå› ä¸ºå³ä½¿æ¯ç§’åªæœ‰1ä¸ªè¯·æ±‚ä»ç„¶èƒ½çœ‹åˆ°å¾ˆé«˜çš„å»¶æ—¶ã€‚ä¹Ÿä¸æ˜¯GCçš„å½±å“ã€‚&lt;/p&gt;
&lt;p&gt;ä¸€ä¸ªKubernetesç®¡ç†å‘˜é—®åº”ç”¨ç¨‹åºæ˜¯å¦æœ‰å¤–éƒ¨çš„ä¾èµ–ï¼Œæ¯”å¦‚ä»¥å‰DNSè§£ææ›¾ç»å¯¼è‡´è¿‡ç±»ä¼¼çš„é—®é¢˜ï¼Œè¿™æ˜¯ç›®å‰ä¸ºæ­¢æœ€å¯èƒ½çš„çŒœæƒ³ã€‚&lt;/p&gt;
&lt;h2 id=&quot;çŒœæƒ³1ï¼šDNSè§£æ&quot;&gt;&lt;a href=&quot;#çŒœæƒ³1ï¼šDNSè§£æ&quot; class=&quot;headerlink&quot; title=&quot;çŒœæƒ³1ï¼šDNSè§£æ&quot;&gt;&lt;/a&gt;çŒœæƒ³1ï¼šDNSè§£æ&lt;/h2&gt;&lt;p&gt;æ¯æ¬¡è¯·æ±‚é‡Œï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¼šå‘AWS ElasticSearchå®ä¾‹ï¼ˆåŸŸåç±»ä¼¼ elastic.spain.adevinta.comï¼‰å‘é€1ï½3æ¬¡è¯·æ±‚ã€‚æˆ‘ä»¬åœ¨å®¹å™¨å†…æ”¾ç½®äº†ä¸€ä¸ªshellè„šæœ¬å¯ä»¥éªŒè¯è¿™ä¸ªåŸŸåä»DNSè§£æéœ€è¦å¤šé•¿æ—¶é—´ã€‚&lt;/p&gt;
&lt;p&gt;å®¹å™¨å†…çš„DNSæŸ¥è¯¢ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@be-851c76f696-alf8z /]&lt;span class=&quot;comment&quot;&gt;# while true; do dig &quot;elastic.spain.adevinta.com&quot; | grep time; sleep 2; done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;;; Query time: 22 msec&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;;; Query time: 22 msec&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;;; Query time: 29 msec&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;;; Query time: 21 msec&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;;; Query time: 28 msec&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;;; Query time: 43 msec&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;;; Query time: 43 msec&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿è¡Œç€å¯¹åº”ç›¸åŒç”¨ç¨‹åºçš„EC2å®ä¾‹é‡Œçš„åŒæ ·çš„æŸ¥è¯¢ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;bash-4.4&lt;span class=&quot;comment&quot;&gt;# while true; do dig &quot;elastic.spain.adevinta.com&quot; | grep time; sleep 2; done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;;; Query time: 77 msec&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;;; Query time: 0 msec&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;;; Query time: 0 msec&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;;; Query time: 0 msec&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;;; Query time: 0 msec&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¤§æ¦‚30msçš„è§£ææ—¶é—´ï¼Œä¼¼ä¹æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåœ¨å’ŒElasticSearché€šä¿¡æ—¶å¢åŠ äº†DNSè§£æçš„é¢å¤–æ¶ˆè€—ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯è¿™é‡Œæœ‰ä¸¤ç‚¹å¾ˆå¥‡æ€ªï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åœ¨Kubernetesé‡Œå·²ç»æœ‰å¾ˆå¤šåº”ç”¨ç¨‹åºå’ŒAWSèµ„æºé€šä¿¡ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚&lt;/li&gt;
&lt;li&gt;æˆ‘ä»¬çŸ¥é“JVMå®ç°äº†å†…å­˜å†…çš„DNSç¼“å­˜ã€‚æŸ¥çœ‹è¿™äº›é•œåƒçš„é…ç½®ï¼Œåœ¨ $JAVA_HOME/jre/lib/security/java.securityé‡Œé…ç½®äº†TTLä¸º networkaddress.cache.ttl=10ã€‚JVMåº”è¯¥èƒ½å¤Ÿç¼“å­˜10ç§’å†…çš„æ‰€æœ‰DNSæŸ¥è¯¢ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸ºäº†ç¡®è®¤æ˜¯DNSçš„å½±å“ï¼Œæˆ‘ä»¬å†³å®šé¿å…DNSè§£æå¹¶ä¸”æŸ¥çœ‹é—®é¢˜æ˜¯å¦ä¼šæ¶ˆå¤±ã€‚é¦–å…ˆå°è¯•è®©åº”ç”¨ç¨‹åºç›´æ¥å’ŒElasticsearchçš„IPé€šä¿¡ï¼Œè€Œä¸æ˜¯åŸŸåã€‚è¿™è¦æ±‚ä»£ç å˜æ›´å¹¶ä¸”é‡æ–°éƒ¨ç½²ï¼Œå› æ­¤æˆ‘ä»¬åªæ˜¯ç®€å•åœ°åœ¨ /etc/hostsæ–‡ä»¶é‡Œæ·»åŠ äº†åŸŸåå’ŒIPçš„æ˜ å°„ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;34.55.5.111 elastic.spain.adevinta.com&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ ·å®¹å™¨å¯ä»¥ç«‹åˆ»è§£æIPã€‚æˆ‘ä»¬ç¡®å®è§‚å¯Ÿåˆ°äº†å»¶æ—¶çš„æ”¹å–„ï¼Œä½†æ˜¯ç¦»æˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡è¿˜æ˜¯å¾ˆè¿œã€‚å³ä½¿DNSè§£æè¶³å¤Ÿå¿«ï¼Œä½†æ˜¯çœŸå®åŸå› è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ç½‘ç»œplumbing&quot;&gt;&lt;a href=&quot;#ç½‘ç»œplumbing&quot; class=&quot;headerlink&quot; title=&quot;ç½‘ç»œplumbing&quot;&gt;&lt;/a&gt;ç½‘ç»œplumbing&lt;/h2&gt;&lt;p&gt;æˆ‘ä»¬å†³å®šåœ¨å®¹å™¨é‡Œæ‰§è¡Œ tcpdumpï¼Œè¿™æ ·å¯ä»¥çœ‹åˆ°ç½‘ç»œåˆ°åº•å¹²äº†äº›ä»€ä¹ˆã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@be-851c76f696-alf8z /]&lt;span class=&quot;comment&quot;&gt;# tcpdump -leni any -w capture.pcap&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç„¶åå‘é€äº†ä¸€äº›è¯·æ±‚å¹¶ä¸”ä¸‹è½½äº†captureæ–‡ä»¶ï¼ˆ &lt;code&gt;kubectl cpmy-service:/capture.pcap capture.pcap&lt;/code&gt;ï¼‰åœ¨&lt;a href=&quot;https://wiki.wireshark.org/FrontPage&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Wireshark&lt;/a&gt;é‡ŒæŸ¥çœ‹ã€‚&lt;/p&gt;
&lt;p&gt;DNSæŸ¥è¯¢çœ‹ä¸Šå»å¾ˆæ­£å¸¸ï¼ˆé™¤äº†ä¸€äº›ç»†èŠ‚ï¼Œä¹‹åä¼šæåˆ°ï¼‰ä½†æ˜¯æˆ‘ä»¬çš„æœåŠ¡å¤„ç†è¯·æ±‚çš„æ—¶å€™å¾ˆå¥‡æ€ªã€‚ä¸‹å›¾æ˜¯captureçš„æˆªå›¾ï¼Œæ˜¾ç¤ºä¸€ä¸ªè¯·æ±‚ä»å¼€å§‹åˆ°å“åº”çš„å…¨è¿‡ç¨‹ã€‚&lt;br&gt;&lt;img src=&quot;/images/wireshark.jpg&quot; alt=&quot;Wireshark&quot;&gt;&lt;/p&gt;
&lt;p&gt;ç¬¬ä¸€åˆ—æ˜¯packetåºå·ã€‚æˆ‘ç”¨ä¸åŒçš„é¢œè‰²æ ‡ç¤ºä¸åŒçš„TCPæµã€‚&lt;/p&gt;
&lt;p&gt;ç»¿è‰²çš„æµä»&lt;code&gt;packet 328&lt;/code&gt;å¼€å§‹ï¼Œæ˜¾ç¤ºå®¢æˆ·ç«¯ï¼ˆ172.17.22.150ï¼‰å¼€å¯äº†å®¹å™¨ï¼ˆ172.17.36.147ï¼‰çš„TCPè¿æ¥ã€‚æœ€åˆçš„æ¡æ‰‹ï¼ˆ328-330ï¼‰ä¹‹åï¼Œ&lt;code&gt;packet 331&lt;/code&gt;å¼€å§‹ &lt;code&gt;HTTP GET/v1/..&lt;/code&gt;ï¼Œè¿™æ˜¯å¯¹æˆ‘ä»¬è‡ªå·±æœåŠ¡çš„å…¥ç«™è¯·æ±‚ã€‚æ•´ä¸ªæµç¨‹èŠ±äº†&lt;strong&gt;1ms&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ç°è‰²æµä»&lt;code&gt;packet 339&lt;/code&gt;å¼€å§‹ï¼Œå±•ç¤ºäº†æˆ‘ä»¬çš„æœåŠ¡å‘é€ä¸€ä¸ªHTTPè¯·æ±‚ç»™Elasticsearchå®ä¾‹ï¼ˆè¿™é‡Œçœ‹ä¸åˆ°TCPæ¡æ‰‹è¿‡ç¨‹å› ä¸ºå®ƒä½¿ç”¨äº†ä¸€ä¸ªå·²æœ‰çš„TCPè¿æ¥ï¼‰ã€‚è¿™é‡ŒèŠ±äº†&lt;strong&gt;18ms&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;è‡³æ­¤éƒ½æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæ‰€èŠ±çš„æ—¶é—´å’Œé¢„è®¡å·®ä¸å¤šï¼ˆ&lt;strong&gt;ï½20-30ms&lt;/strong&gt;ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯åœ¨è¿™ä¸¤æ¬¡äº¤äº’ä¹‹é—´ï¼Œç´«è‰²éƒ¨åˆ†èŠ±äº†&lt;strong&gt;86ms&lt;/strong&gt;ã€‚è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿåœ¨&lt;code&gt;packet 333&lt;/code&gt;ï¼Œ æˆ‘ä»¬çš„æœåŠ¡å‘é€äº†HTTP GETåˆ° &lt;code&gt;/latest/meta-data/iam/security-credentials&lt;/code&gt;ï¼Œä¹‹åï¼Œåœ¨åŒä¸€ä¸ªTCPè¿æ¥é‡Œï¼Œå¦ä¸€ä¸ªGETå‘é€åˆ° &lt;code&gt;/latest/meta-data/iam/security-credentials/arn:..&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å‘ç°æ¯æ¬¡è¯·æ±‚é‡Œéƒ½ä¼šè¿™æ ·åšã€‚DNSè§£æåœ¨å®¹å™¨é‡Œç¡®å®æœ‰ä¸€ç‚¹æ…¢ï¼ˆè§£é‡Šå¾ˆæœ‰æ„æ€ï¼Œæˆ‘ä¼šåœ¨å¦ä¸€ç¯‡æ–‡ç« é‡Œä»‹ç»ï¼‰ã€‚ä½†æ˜¯é«˜å»¶è¿Ÿçš„å®é™…åŸå› æ˜¯æ¯æ¬¡è¯·æ±‚é‡Œå¯¹&lt;code&gt;AWS Instance Metadata&lt;/code&gt;çš„æŸ¥è¯¢ã€‚&lt;/p&gt;
&lt;h2 id=&quot;çŒœæƒ³2ï¼šAWSè°ƒç”¨&quot;&gt;&lt;a href=&quot;#çŒœæƒ³2ï¼šAWSè°ƒç”¨&quot; class=&quot;headerlink&quot; title=&quot;çŒœæƒ³2ï¼šAWSè°ƒç”¨&quot;&gt;&lt;/a&gt;çŒœæƒ³2ï¼šAWSè°ƒç”¨&lt;/h2&gt;&lt;p&gt;è¿™ä¸¤ä¸ªendpointéƒ½æ˜¯&lt;a href=&quot;https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html#instance-metadata-security-credentials&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;code&gt;AWS Instance Metadata API&lt;/code&gt;&lt;/a&gt;çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘ä»¬çš„å¾®æœåŠ¡ä»Elasticsearché‡Œè¯»å–æ—¶ä¼šç”¨åˆ°è¿™ä¸ªæœåŠ¡ã€‚è¿™ä¸¤ä¸ªè°ƒç”¨éƒ½æ˜¯åŸºç¡€çš„æˆæƒå·¥ä½œæµã€‚&lt;/p&gt;
&lt;p&gt;ç¬¬ä¸€ä¸ªè¯·æ±‚é‡ŒæŸ¥è¯¢çš„endpointå¾—åˆ°å’Œè¯¥å®ä¾‹ç›¸å…³è”çš„IAMè§’è‰²ã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;/ &lt;span class=&quot;comment&quot;&gt;# curl http://169.254.169.254/latest/meta-data/iam/security-credentials/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;arn:aws:iam::&amp;lt;account_id&amp;gt;:role/some_role&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ç¬¬äºŒä¸ªè¯·æ±‚æŸ¥è¯¢ç¬¬äºŒä¸ªendpointå¾—åˆ°è¯¥å®ä¾‹çš„ä¸´æ—¶credentialã€‚&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;/ &lt;span class=&quot;comment&quot;&gt;# curl http://169.254.169.254/latest/meta-data/iam/security-credentials/arn:aws:iam::&amp;lt;account_id&amp;gt;:role/some_role&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;&quot;Code&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;Success&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;&quot;LastUpdated&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;2012-04-26T16:39:16Z&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;&quot;Type&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;AWS-HMAC&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;AccessKeyId&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;ASIAIOSFODNN7EXAMPLE&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;SecretAccessKey&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;Token&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;token&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;Expiration&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;2017-05-17T15:09:54Z&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å®¢æˆ·ç«¯å¯ä»¥åœ¨çŸ­æ—¶é—´å†…ä½¿ç”¨å®ƒä»¬ï¼Œå¹¶ä¸”éœ€è¦å‘¨æœŸæ€§åœ°ï¼ˆåœ¨ Expirationä¹‹å‰ï¼‰å»è·å–æ–°çš„credencialã€‚æ¨¡å‹å¾ˆç®€å•ï¼šAWSä¸ºäº†å®‰å…¨è€ƒè™‘ç»å¸¸è½®è¯¢ä¸´æ—¶å¯†é’¥ï¼Œä½†æ˜¯å®¢æˆ·ç«¯å¯ä»¥å°†å¯†é’¥ç¼“å­˜å‡ åˆ†é’Ÿæ¥å¼¥è¡¥è·å¾—æ–°credencialæ‰€å¸¦æ¥çš„æ€§èƒ½å½±å“ã€‚&lt;/p&gt;
&lt;p&gt;AWS Java SDKåº”è¯¥å¤„ç†è¿™äº›ï¼Œä½†æ˜¯ï¼Œå› ä¸ºæŸç§åŸå› ï¼Œå®ƒæ²¡æœ‰è¿™ä¹ˆåšã€‚&lt;/p&gt;
&lt;p&gt;åœ¨GitHub issueé‡Œæœç´¢åæ‰¾åˆ°äº†&lt;a href=&quot;https://github.com/aws/aws-sdk-java/issues/1921&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;#1921&lt;/a&gt;ï¼Œé‡Œé¢æœ‰æˆ‘ä»¬éœ€è¦çš„çº¿ç´¢ã€‚&lt;/p&gt;
&lt;p&gt;AWS SDKåœ¨ä¸‹é¢ä¸¤ç§æƒ…å†µçš„æŸä¸€ç§æ»¡è¶³æ—¶å°±ä¼šåˆ·æ–°credentialï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Expirationåœ¨ EXPIRATION_THRESHOLDå†…ï¼Œç¡¬ç¼–ç ä¸º15åˆ†é’Ÿã€‚&lt;/li&gt;
&lt;li&gt;å‰ä¸€æ¬¡åˆ·æ–°credentialçš„å°è¯•æ‰€èŠ±æ—¶é—´å¤§äº REFRESH_THRESHOLDï¼Œç¡¬ç¼–ç ä¸º60åˆ†é’Ÿã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æˆ‘ä»¬éœ€è¦æŸ¥çœ‹å¾—åˆ°çš„è¯ä¹¦é‡Œçš„å®é™…è¿‡æœŸæ—¶é—´ï¼Œå› æ­¤è¿è¡Œäº†ä¸¤ä¸ª cURLå‘½ä»¤è°ƒç”¨AWS APIï¼Œä¸€æ¬¡ä»å®¹å™¨é‡Œï¼Œä¸€æ¬¡ä»EC2å®ä¾‹é‡Œã€‚ä»å®¹å™¨é‡Œè·å¾—çš„è¯ä¹¦è¿‡æœŸæ—¶é—´çŸ­å¾—å¤šï¼Œæ˜¯15åˆ†é’Ÿã€‚&lt;/p&gt;
&lt;p&gt;é—®é¢˜å˜å¾—æ¸…æ™°äº†ï¼šæˆ‘ä»¬çš„æœåŠ¡åœ¨ç¬¬ä¸€ä¸ªè¯·æ±‚é‡Œä¼šè·å–ä¸´æ—¶credentialã€‚å› ä¸ºå®ƒæœ‰15åˆ†é’Ÿçš„è¿‡æœŸæ—¶é—´ï¼Œåœ¨ä¸‹ä¸€æ¬¡è¯·æ±‚é‡Œï¼ŒAWS SDKä¼šé‡æ–°åˆ·æ–°credentialã€‚æ¯æ¬¡è¯·æ±‚éƒ½ä¼šè¿™æ ·ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ä¸ºä»€ä¹ˆcredentialè¿‡æœŸæ—¶é—´å˜çŸ­äº†ï¼Ÿ&quot;&gt;&lt;a href=&quot;#ä¸ºä»€ä¹ˆcredentialè¿‡æœŸæ—¶é—´å˜çŸ­äº†ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;ä¸ºä»€ä¹ˆcredentialè¿‡æœŸæ—¶é—´å˜çŸ­äº†ï¼Ÿ&quot;&gt;&lt;/a&gt;ä¸ºä»€ä¹ˆcredentialè¿‡æœŸæ—¶é—´å˜çŸ­äº†ï¼Ÿ&lt;/h2&gt;&lt;p&gt;AWS Intance Metadata Serviceè®¾è®¡ä¸Šæ˜¯åœ¨EC2å®ä¾‹é‡Œä½¿ç”¨ï¼Œè€Œä¸æ˜¯Kubernetesä¸Šã€‚æˆ‘ä»¬å¸Œæœ›åº”ç”¨ç¨‹åºä¿ç•™ç›¸åŒçš„æ¥å£ã€‚å› æ­¤ä½¿ç”¨äº†&lt;a href=&quot;https://github.com/uswitch/kiam&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kiam&lt;/a&gt;ï¼Œåœ¨æ¯ä¸ªKubernetesèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªagentï¼Œå…è®¸ç”¨æˆ·ï¼ˆéƒ¨ç½²åº”ç”¨ç¨‹åºåˆ°é›†ç¾¤é‡Œçš„å·¥ç¨‹å¸ˆï¼‰å°†IAMè§’è‰²å…³è”åˆ°Podå®¹å™¨ä¸Šï¼Œå°±åƒå®ƒæ˜¯ä¸ªEC2å®ä¾‹ä¸€æ ·ã€‚å®ƒä¼šæˆªè·å‘é€åˆ°AWS Instance MetadataæœåŠ¡çš„è°ƒç”¨ï¼Œå¹¶ä¸”ä½¿ç”¨agentæå‰ä»AWSè·å–å¹¶æ”¾åœ¨ç¼“å­˜é‡Œçš„å†…å®¹å“åº”ã€‚ä»åº”ç”¨ç¨‹åºçš„è§’åº¦æ¥çœ‹ï¼Œå’Œè¿è¡Œåœ¨EC2ä¸Šæ²¡ä»€ä¹ˆåŒºåˆ«ã€‚&lt;/p&gt;
&lt;p&gt;Kiamç»™Podæä¾›çš„æ­£æ˜¯çŸ­æœŸçš„credencialï¼Œè¿™æœ‰é“ç†ï¼Œå› ä¸ºå®ƒå‡å®šPodçš„å¹³å‡ç”Ÿå‘½å‘¨æœŸæ¯”EC2å®ä¾‹è¦çŸ­ã€‚é»˜è®¤å€¼å°±æ˜¯15åˆ†é’Ÿã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯å¦‚æœä¸¤å¤„éƒ½ä½¿ç”¨é»˜è®¤å€¼å°±æœ‰é—®é¢˜äº†ã€‚æä¾›ç»™åº”ç”¨ç¨‹åºçš„è¯ä¹¦è¿‡æœŸæ—¶é—´ä¸º15åˆ†é’Ÿã€‚AWS Java SDKä¼šå¼ºåˆ¶åˆ·æ–°ä»»ä½•è¿‡æœŸæ—¶é—´å°‘äº15åˆ†é’Ÿçš„è¯ä¹¦ã€‚&lt;/p&gt;
&lt;p&gt;ç»“æœå°±æ˜¯æ¯ä¸ªè¯·æ±‚éƒ½ä¼šå¼ºåˆ¶åˆ·æ–°ä¸´æ—¶è¯ä¹¦ï¼Œè¿™éœ€è¦ä¸¤æ¬¡è°ƒç”¨AWS APIï¼Œç»™æ¯æ¬¡è¯·æ±‚éƒ½å¸¦æ¥äº†å·¨å¤§çš„å»¶è¿Ÿã€‚ä¹‹åæˆ‘ä»¬æ‰¾åˆ°äº†&lt;a href=&quot;https://github.com/aws/aws-sdk-java/issues/1893&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AWS Java SDKçš„ä¸€ä¸ªåŠŸèƒ½è¯·æ±‚&lt;/a&gt;ï¼Œé‡Œé¢æåˆ°äº†åŒæ ·çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;è§£å†³åŠæ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬é‡æ–°é…ç½®äº†Kiamï¼Œè¯·æ±‚æ›´é•¿è¿‡æœŸæ—¶é—´çš„credencialã€‚å½“è¿™ä¸€å˜æ›´ç”Ÿæ•ˆåï¼Œè¯·æ±‚å°±ä¸ç”¨æ¯æ¬¡éƒ½è°ƒç”¨AWS MetadataæœåŠ¡äº†ï¼Œè€Œä¸”å»¶è¿Ÿæ¯”EC2è¿˜è¦å°ã€‚&lt;/p&gt;
&lt;h2 id=&quot;æ”¶è·&quot;&gt;&lt;a href=&quot;#æ”¶è·&quot; class=&quot;headerlink&quot; title=&quot;æ”¶è·&quot;&gt;&lt;/a&gt;æ”¶è·&lt;/h2&gt;&lt;p&gt;ä»æˆ‘ä»¬è¿ç§»çš„ç»éªŒé‡Œï¼Œæœ€ç»å¸¸é‡åˆ°çš„é—®é¢˜ä¸æ˜¯Kubernetesçš„bugæˆ–è€…å¹³å°çš„é—®é¢˜ã€‚ä¹Ÿä¸æ˜¯å¾®æœåŠ¡æœ¬èº«çš„é—®é¢˜ã€‚é—®é¢˜é€šå¸¸åªæ˜¯å› ä¸ºé›†æˆã€‚æˆ‘ä»¬å°†ä»¥å‰ä»æ¥æ²¡æœ‰ä¸€èµ·é›†æˆè¿‡çš„å¤æ‚ç³»ç»Ÿæ··åˆåœ¨ä¸€èµ·ï¼Œå¹¶ä¸”æœŸæœ›å®ƒä»¬ç»„æˆå•ä¸ªçš„å¤§ç³»ç»Ÿã€‚å¯ç§»åŠ¨ç»„ä»¶è¶Šå¤šï¼Œå¯èƒ½å‘ç”Ÿé—®é¢˜çš„åœ°æ–¹å°±è¶Šå¤šã€‚&lt;/p&gt;
&lt;p&gt;åœ¨è¿™ä¸ªé—®é¢˜é‡Œï¼Œé«˜å»¶è¿Ÿå¹¶ä¸æ˜¯å› ä¸ºbugæˆ–è€…Kubernetesã€Kiamã€AWS Java SDKæˆ–æˆ‘ä»¬è‡ªå·±å¾®æœåŠ¡æœ¬èº«æœ‰ä»€ä¹ˆé—®é¢˜ã€‚å®ƒæ˜¯Kiamå’ŒAWS Java SDKé‡Œä¸¤ä¸ªç‹¬ç«‹çš„é»˜è®¤å€¼ç»„åˆåœ¨ä¸€èµ·å¯¼è‡´çš„é—®é¢˜ã€‚ç‹¬ç«‹æ¥çœ‹ï¼Œä¸¤ä¸ªé»˜è®¤å€¼éƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼šAWS Java SDKå¼ºåˆ¶credentialåˆ·æ–°ç­–ç•¥å’ŒKiamæ¯”è¾ƒä½çš„é»˜è®¤è¿‡æœŸæ—¶é—´ã€‚ä½†æ˜¯ç»„åˆèµ·æ¥å°±å¯¼è‡´äº†é—®é¢˜ã€‚&lt;strong&gt;ä¸¤ä¸ªå•ç‹¬çœ‹éƒ½æ˜¯æ­£ç¡®çš„å†³å®šåˆåœ¨ä¸€èµ·å¹¶ä¸ä¸€å®šæ˜¯æ­£ç¡®çš„&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¦‚æœä½¿ç”¨çš„æ˜¯awsçš„eksï¼Œç°åœ¨å¯ä»¥ä¸ç”¨ä½¿ç”¨kiamè¿™ä¸ªæ’ä»¶æ¥å®ç°roleè®¿é—®awsæœåŠ¡ï¼Œaws eks å®ç°äº†service accounts ä¸ role ç»‘å®šï¼Œå…·ä½“å‚è€ƒï¼š&lt;a href=&quot;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/iam-roles-for-service-accounts.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/iam-roles-for-service-accounts.html&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æ¥æºï¼škubernetes-added-a-0-to-my-latency&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;é—®é¢˜æ¦‚è¦&quot;&gt;&lt;a href=&quot;#é—®é¢˜æ¦‚è¦&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æ¦‚è¦&quot;&gt;&lt;/a&gt;é—®é¢˜æ¦‚è¦&lt;/h2&gt;&lt;p&gt;ä¸Šå‘¨æˆ‘ä»¬å°†ä¸€ä¸ªå¾®æœåŠ¡è¿ç§»åˆ°ä¸­å¤®å¹³å°ä¸Šï¼ŒåŒ…æ‹¬CI/CDï¼ŒKubernetesè¿è¡Œæ—¶ï¼Œmetricå’Œå…¶ä»–ä¸€äº›ç¨‹åºã€‚è¿™æ¬¡å®éªŒæ˜¯ä¸ºäº†ä¹‹åä¸€ä¸ªæœˆé‡Œå¤§æ¦‚150ä¸ªå¾®æœåŠ¡çš„è¿ç§»ä½œå‡†å¤‡ï¼Œæ‰€æœ‰è¿™äº›æœåŠ¡æ”¯æ’‘ç€è¥¿ç­ç‰™åœ¨çº¿å¸‚åœºçš„è¿è¥ã€‚&lt;/p&gt;
&lt;p&gt;å½“æˆ‘ä»¬å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°Kubernetesä¸Šï¼Œå¹¶ä¸”å°†ä¸€äº›ç”Ÿäº§æµé‡å¯¼å…¥å…¶ä¸­ä¹‹åï¼Œäº‹æƒ…å¼€å§‹æœ‰äº›ä¸å¦™äº†ã€‚Kubernetesä¸Šçš„è¯·æ±‚å»¶è¿Ÿæ¯”EC2ä¸Šçš„é«˜10å€å·¦å³ã€‚é™¤éæˆ‘ä»¬èƒ½æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œä¸ç„¶è¿™ä¼šæ˜¯å¾®æœåŠ¡è¿ç§»çš„æœ€å¤§éšœç¢ï¼Œç”šè‡³å¯èƒ½å½»åº•æ‘§æ¯æ•´ä¸ªé¡¹ç›®ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/categories/kubernetes/"/>
    
    
      <category term="k8s" scheme="http://team.jiunile.com/tags/k8s/"/>
    
      <category term="kubernetes" scheme="http://team.jiunile.com/tags/kubernetes/"/>
    
      <category term="è¿ç§»" scheme="http://team.jiunile.com/tags/%E8%BF%81%E7%A7%BB/"/>
    
      <category term="å»¶è¿Ÿ" scheme="http://team.jiunile.com/tags/%E5%BB%B6%E8%BF%9F/"/>
    
  </entry>
  
  <entry>
    <title>LPRæ˜¯ä»€ä¹ˆï¼Œå¤®è¡Œç»™æœ‰æ”¾è´·çš„äººå¸¦æ¥ä»€ä¹ˆæ–°å¹´ç¤¼ç‰©</title>
    <link href="http://team.jiunile.com//blog/2020/01/lpr.html"/>
    <id>http://team.jiunile.com//blog/2020/01/lpr.html</id>
    <published>2020-01-06T12:00:00.000Z</published>
    <updated>2020-01-06T02:29:37.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;part-1&quot;&gt;&lt;a href=&quot;#part-1&quot; class=&quot;headerlink&quot; title=&quot;part 1&quot;&gt;&lt;/a&gt;part 1&lt;/h2&gt;&lt;p&gt;&lt;code&gt;æ¯ä¸€ä¸ªèƒŒè´Ÿäº†æˆ¿è´·çš„äººï¼Œç»å¯¹æƒ³ä¸åˆ°ï¼Œè¿›å…¥2020å¹´å¤´çš„æ—¶å€™ï¼Œå¤®è¡Œä¼šé€æ¥ä¸€ä»½å¤§ç¤¼ã€‚&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;2019å¹´12æœˆ28æ—¥ï¼Œä¸­å›½äººæ°‘é“¶è¡Œï¼ˆå¤®è¡Œï¼‰å‘å¸ƒå¹´å†…ç¬¬30å·å…¬å‘Šã€‚å…¬å‘Šä¸­çš„æ–‡å­—éå¸¸ä¸“ä¸šã€æ™¦æ¶©ï¼Œä¸æ˜¯é‡‘èä¸“ä¸šå‡ºèº«çš„äººï¼Œä¼šè§‰å¾—äº‘é‡Œé›¾é‡Œï¼Œä¹Ÿä½“ä¼šä¸åˆ°è¿™åˆ™å…¬å‘Šçš„å²è¯—çº§ä½œç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ç¬¬ä¸€ï¼š&lt;strong&gt;ä»2020å¹´1æœˆ1æ—¥å¼€å§‹ï¼Œå•†ä¸šé“¶è¡Œä¸å¾—å’Œä¹°æˆ¿äººï¼Œç­¾è®¢å‚è€ƒè´·æ¬¾åŸºå‡†åˆ©ç‡çš„æµ®åŠ¨åˆ©ç‡è´·æ¬¾åˆåŒã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ç¬¬äºŒï¼š&lt;strong&gt;ä»2020å¹´3æœˆ1æ—¥å¼€å§‹ï¼Œå•†ä¸šé“¶è¡Œå¿…é¡»å’Œå­˜é‡æˆ¿è´·çš„å€Ÿæ¬¾äººï¼ŒåºŸé™¤åŸæœ‰æˆ¿è´·åˆåŒï¼Œè®©å€Ÿæ¬¾äººé‡æ–°äºŒé€‰ä¸€ï¼Œè¦ä¹ˆï¼šå›ºå®šåˆ©ç‡ï¼›è¦ä¹ˆï¼šã€ŒLPRåˆ©ç‡+åŸºç‚¹åŠ æˆã€æ¨¡å¼ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;ä¹Ÿå°±æ˜¯è¯´ï¼Œä»ä»Šå¹´çš„3æœˆ1æ—¥å¼€å§‹è‡³8æœˆä»½çš„5ä¸ªæœˆæ—¶é—´é‡Œï¼Œå½“åˆå’Œä¹°æˆ¿äººç­¾è®¢äº†æˆ¿è´·åˆåŒçš„é“¶è¡Œï¼Œä¼šè”ç³»ä¹°æˆ¿äººï¼Œåå•†åºŸé™¤åŸæœ‰çš„ã€ŒåŸºå‡†åˆ©ç‡+æµ®åŠ¨æ¯”ä¾‹ã€åˆ©ç‡åˆåŒï¼Œå†äºŒé€‰ä¸€ã€‚&lt;/p&gt;
&lt;p&gt;ä¸€å®šè¦è®°ä½ï¼Œæ— è®ºé“¶è¡Œæ€ä¹ˆå·§èˆŒå¦‚ç°§ï¼Œå£åè²èŠ±ï¼š&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ä¸è¦é€‰æ‹©å›ºå®šåˆ©ç‡æ¨¡å¼ï¼Œé€‰æ‹©ã€ŒLPRåˆ©ç‡+åŸºç‚¹åŠ æˆã€æ¨¡å¼ï¼&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;å¤®è¡Œå…¬å‘Šä¸­è¯´å¾—å¾ˆæ¸…æ¥šï¼Œè¿™ç§å˜æ›´ï¼Œä¸€è¾ˆå­åªæœ‰ä¸€æ¬¡æœºä¼šï¼Œé€‰é”™äº†çš„è¯ï¼Œæ˜¯æ— æ³•æ›´æ”¹çš„ã€‚&lt;/p&gt;
&lt;p&gt;ä¸è¦å°çœ‹ä¸¤ç§åˆ©ç‡æ¨¡å¼çš„å·®åˆ«ï¼Œæˆ‘ä»¬å¯ä»¥å¤§è‡´ä¼°ç®—ä¸‹ï¼Œåœ¨æŸäº›å¹´ä»½ï¼Œåˆ©ç‡å·®è·å¯èƒ½è¾¾åˆ°1-5ä¸ªç™¾åˆ†ç‚¹ã€‚å¦‚æœæˆ¿è´·ä½™é¢æœ‰300ä¸‡å…ƒçš„è¯ï¼Œæ¯å¹´è¿˜æ¬¾å·®å¼‚å¯èƒ½è¾¾åˆ°3-15ä¸‡å…ƒã€‚&lt;/p&gt;
&lt;p&gt;åœ¨è¿‡å»å‡ å¹´ï¼Œæ•°ç™¾ä¸‡çš„å¹´è½»äººå¤«å¦»ï¼Œæç©ºäº†çˆ¶æ¯è¾ˆçš„é’±åŒ…ï¼ŒèƒŒè´Ÿäº†æˆ¿è´·ï¼Œä¸æ•¢è¾èŒå’Œè·³æ§½ï¼Œè¿‡ä¸Šäº†ä¸æ•¢æ¶ˆè´¹çš„ä½›ç³»ç”Ÿæ´»ã€‚&lt;/p&gt;
&lt;p&gt;ç¿»é˜…äº†å¤®è¡Œçš„å®šæœŸæŠ¥å‘Šï¼Œæˆªæ­¢2019å¹´8æœˆä»½ï¼Œä¸ªäººè´·æ¬¾ä½™é¢æ€»é‡åœ¨29ä¸‡äº¿å…ƒã€‚ä½ çš„æˆ¿è´·ï¼Œå°±åœ¨å…¶ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;ç°åœ¨ï¼Œå¤®è¡Œè¦ç»™ä½ æ¾ç»‘äº†ï¼Œå¸ä¸‹é‡æ‹…äº†ï¼Œå°±çœ‹ä½ 3ä¸ªæœˆä¹‹åï¼Œè¦ä¸è¦æ¥æ”¶è¿™ä»½å¤§ç¤¼ï¼Œæ”¹å˜ä¸€å®¶å­çš„å‘½è¿äº†ã€‚&lt;/p&gt;
&lt;h2 id=&quot;part-2&quot;&gt;&lt;a href=&quot;#part-2&quot; class=&quot;headerlink&quot; title=&quot;part 2&quot;&gt;&lt;/a&gt;part 2&lt;/h2&gt;&lt;p&gt;å¤®è¡Œåœ¨2019å¹´8æœˆä»½ï¼Œè¿›è¡Œæˆ¿è´·å˜é©çš„ç»†èŠ‚ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å˜é©å‰ï¼Œæˆ¿è´·åˆ©ç‡=å¤®è¡ŒåŸºå‡†åˆ©ç‡+æµ®åŠ¨æ¯”ä¾‹ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åŸºå‡†åˆ©ç‡ç”±å¤®è¡Œç»Ÿä¸€å…¬å¸ƒï¼Œå•†ä¸šé“¶è¡Œæ— æƒæ§åˆ¶ï¼Œåªèƒ½è¢«åŠ¨è·Ÿéšã€‚å¦‚æœå¤®è¡ŒåŠ æ¯äº†ï¼Œæˆ–è€…é™æ¯äº†ï¼Œé‚£ä¹ˆåœ¨æ¥å¹´çš„å›ºå®šæ—¥æœŸ1æœˆ1æ—¥ï¼Œè´­æˆ¿è€…çš„åŸºå‡†åˆ©ç‡å°±ç»Ÿä¸€æ”¹å˜ã€‚å½“å‰çš„åŸºå‡†åˆ©ç‡æ˜¯4.90%ã€‚&lt;/p&gt;
&lt;p&gt;å•†ä¸šé“¶è¡Œèƒ½å¤Ÿæ”¹å˜çš„å°±æ˜¯â€œæµ®åŠ¨æ¯”ä¾‹â€ã€‚æœ‰äº›åŸå¸‚çš„é“¶è¡Œè´§å¸å®½æ¾ï¼Œé¼“åŠ±é¦–å¥—æˆ¿ç½®ä¸šï¼Œåœ°æ–¹æ”¿åºœè´¢æºä¾èµ–äºåœŸåœ°å‡ºè®©é‡‘ï¼Œé‚£ä¹ˆå¯èƒ½åœ¨åŸºå‡†åˆ©ç‡çš„åŸºç¡€ä¸Šæ‰“æŠ˜æ‰£ï¼Œä½†æ˜¯å¤§å¤šæ•°åŸå¸‚ï¼Œæ˜¯æ²¡æœ‰æµ®åŠ¨æ¯”ä¾‹ï¼Œæˆ–è€…ä¸Šæµ®çš„ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹è´­æˆ¿è€…è€Œè¨€ï¼Œå’Œé“¶è¡Œç­¾è®¢çš„â€œæµ®åŠ¨æ¯”ä¾‹â€ä¸€æ—¦ç¡®è®¤ï¼Œæ˜¯æ— æ³•å˜æ›´çš„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å˜é©åï¼Œæˆ¿è´·åˆ©ç‡=è´·æ¬¾å¸‚åœºæŠ¥ä»·ï¼ˆLPRï¼‰åˆ©ç‡+åŸºç‚¹åŠ æˆã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;LPRåˆ©ç‡ï¼Œä¸“ä¸šè¯´æ³•æ˜¯â€œå…¨å›½é“¶è¡Œé—´åŒä¸šæ‹†å€Ÿä¸­å¿ƒâ€ï¼Œç»Ÿè®¡18å®¶é“¶è¡ŒæŠ¥å‡ºçš„å„è‡ªçš„1å¹´æœŸå’Œ5å¹´æœŸä»¥ä¸Šè´·æ¬¾åˆ©ç‡ï¼Œå‰”é™¤æœ€ä½ä»·ã€æœ€é«˜ä»·åï¼Œè®¡ç®—ç®—æœ¯å¹³å‡ä»·ã€‚&lt;/p&gt;
&lt;p&gt;è¯´å¾—æ›´åŠ ç›´ç™½ä¸€ç‚¹&lt;/p&gt;
&lt;p&gt;&lt;code&gt;LPRåˆ©ç‡æ›´åŠ å¸‚åœºåŒ–ï¼Œåœ¨åæ˜ å…¨ç¤¾ä¼šæ— é£é™©åˆ©ç‡çš„ç¨‹åº¦ä¸Šï¼Œæ›´åŠ é€¼çœŸã€‚&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;å½“ç»æµè¿‡çƒ­æ—¶ï¼Œé€šèƒ€æ—¶ï¼Œåˆ©ç‡é«˜ï¼›&lt;/p&gt;
&lt;p&gt;å½“ç»æµè¿‡å†·æ—¶ï¼Œé€šç¼©æ—¶ï¼Œåˆ©ç‡ä½ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ç§å¸‚åœºåŒ–çš„åˆ©ç‡ï¼Œå°†è´·æ¬¾äººå’Œå€Ÿæ¬¾äººä¹‹é—´çš„åˆ©ç›Šã€é£é™©ï¼Œå‡è¡¡äº†ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;å¤®è¡Œé«˜å±‹å»ºç“´ï¼Œå°†1å¹´æœŸLPRåˆ©ç‡ï¼Œç”¨äºå®ä½“ç»æµï¼›å°†5å¹´æœŸLPRåˆ©ç‡ï¼Œç”¨äºäº†æˆ¿åœ°äº§å¸‚åœºã€‚&lt;br&gt;&lt;img src=&quot;/images/other/1.jpg&quot; alt=&quot;1&quot;&gt;&lt;/p&gt;
&lt;p&gt;å½“éœ€è¦ç»™å®ä½“ç»æµé™æ¯æ—¶ï¼Œå°±è°ƒä½1å¹´æœŸLPRåˆ©ç‡ï¼Œä¸è®©æ¼«çŒçš„å¤§æ°´è¿›å…¥æˆ¿åœ°äº§è¡Œä¸šã€‚&lt;/p&gt;
&lt;p&gt;å½“éœ€è¦å•ç‹¬å¯¹æˆ¿åœ°äº§è°ƒæ§æ—¶ï¼Œåªéœ€è¦æé«˜5å¹´æœŸLPRçš„åˆ©ç‡ï¼Œå°±ä¸ä¼šå¯¹å®ä½“ç»æµäº§ç”Ÿæˆæœ¬å‹åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ä»é•¿æœŸæ¥çœ‹ï¼Œ&lt;strong&gt;5å¹´æœŸLPRåˆ©ç‡ï¼Œä¸€å®šä¼šå‘1å¹´æœŸLPRåˆ©ç‡è¿›è¡Œå›å½’å’Œé æ‹¢çš„ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;2019å¹´11æœˆ20æ—¥ï¼Œå¤®è¡Œæˆæƒå…¨å›½é“¶è¡Œé—´åŒä¸šæ‹†å€Ÿä¸­å¿ƒå…¬å¸ƒäº†æœ€æ–°ä¸€æœŸè´·æ¬¾å¸‚åœºæŠ¥ä»·åˆ©ç‡ï¼ˆLPRï¼‰ã€‚1å¹´æœŸLPRåˆ©ç‡ä¸º4.15%ï¼Œ5å¹´æœŸä»¥ä¸ŠLPRåˆ©ç‡ä¸º4.80%ã€‚åŒ10æœˆ21æ—¥å…¬å¸ƒçš„ä¸ŠæœŸæ•°å€¼ç›¸æ¯”ï¼Œå‡ä¸‹è°ƒäº†5ä¸ªåŸºç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;ç‰¹åˆ«åœ°ï¼Œ5å¹´æœŸLPRåˆ©ç‡4.80%ï¼Œæ¯”åŸæœ‰çš„è´·æ¬¾åŸºå‡†åˆ©ç‡4.90%ï¼Œä½äº†10ä¸ªåŸºç‚¹ï¼Œä¹Ÿå°±æ˜¯0.1ä¸ªç™¾åˆ†ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœ2020å¹´1æœˆä»¥åä¹°æˆ¿å­ï¼Œç­¾è®¢çš„æ˜¯å˜é©åçš„æˆ¿è´·åˆ©ç‡æ¨¡å¼ï¼Œæœªæ¥LPRåˆ©ç‡é•¿æœŸä¸‹è¡Œï¼Œé‚£ä¹ˆä¹°æˆ¿äººå’Œè´·æ¬¾æœºæ„çš„æˆ¿è´·åˆ©ç‡ï¼Œä¹Ÿå¿…ç„¶ä¸‹è¡Œï¼Œè¿™æ ·çš„è¯ï¼Œä¹°æˆ¿äººæ‰¿æ‹…çš„åˆ©ç‡æˆæœ¬ï¼Œå’Œå…¨ç¤¾ä¼šçš„åˆ©ç‡æˆæœ¬å¤§è‡´ç›¸å½“ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœæ˜¯2019å¹´8æœˆä»½ä¹‹å‰ä¹°çš„æˆ¿å­ï¼Œä¹°æˆ¿äººå’Œè´·æ¬¾æœºæ„ç­¾è®¢çš„æ˜¯åŸºå‡†åˆ©ç‡ï¼Œæˆ–è€…å›ºå®šåˆ©ç‡ï¼Œé‚£ä¹ˆæœªæ¥ç¤¾ä¼šæ— é£é™©åˆ©ç‡ä¸‹è¡Œåï¼Œä¹°æˆ¿äººæ‰¿æ‹…çš„å‹åŠ›ï¼Œå°†å‰æ‰€æœªæœ‰çš„å¤§ã€‚è¿™æ‰¹ä¹°æˆ¿äººï¼Œå®Œå…¨å°†è‡ªå·±çš„äººç”Ÿä¸Šè´¡ç»™äº†é“¶è¡Œå¸å›½ï¼Œå’Œåæ¥è½»è£…ä¸Šé˜µçš„ä¹°æˆ¿è€…ï¼Œæ³¾æ¸­åˆ†æ˜ï¼Œç¤¾ä¼šçš„ä¸å…¬å¹³æ€§å°±æ‹‰å¤§äº†ã€‚&lt;/p&gt;
&lt;p&gt;æœ‰äº›äººå¯èƒ½ä¼šè¯´ï¼Œå˜é©å‰åï¼ŒäºŒç§åˆ©ç‡çš„å·®å¼‚ï¼Œå°±åœ¨10ä¸ªåŸºç‚¹ï¼Œ0.1ä¸ªç™¾åˆ†ç‚¹ï¼Œå·®å¼‚ä¸å¤§ã€‚&lt;/p&gt;
&lt;p&gt;ä½ è¦è¿™ä¹ˆè¯´ï¼Œåªèƒ½è¯æ˜ï¼Œ&lt;code&gt;å¯¹æˆ‘ä»¬å›½å®¶æœªæ¥åˆ©ç‡ä¸‹è¡Œè¶‹åŠ¿çš„åŠ›é‡ï¼Œä¸€æ— æ‰€çŸ¥ï¼&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;part-3&quot;&gt;&lt;a href=&quot;#part-3&quot; class=&quot;headerlink&quot; title=&quot;part 3&quot;&gt;&lt;/a&gt;part 3&lt;/h2&gt;&lt;p&gt;ä½ ä¹Ÿè®¸ä¼šé—®ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å¤®è¡Œå’Œæ”¾è´·é“¶è¡Œï¼Œå±…ç„¶ç»™æˆ‘ä»¬ä¹°æˆ¿è€…è¿™ä¹ˆå¥½çš„ç¦åˆ©ï¼Œä¼šæŠŠåƒè¿›è‚šå­é‡Œçš„è‚‰ï¼Œåäº†å‡ºæ¥ï¼Œå®ƒä»¬å›¾ä»€ä¹ˆå‘¢ï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;å‘µå‘µã€‚å…ˆè®©æ˜å“¥ç¬‘å‡ å£°ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœä½ èƒ½è¿™ä¹ˆæƒ³ï¼Œè¯´æ˜ä½ çœŸçš„å¤ªå¤©çœŸäº†ã€‚&lt;/p&gt;
&lt;p&gt;å¤®è¡Œå’Œæ”¾è´·é“¶è¡Œï¼Œç»™å€Ÿæ¬¾äººæ¾ç»‘ï¼Œç»å¯¹ä¸æ˜¯ä¸ºäº†æŠŠåƒè¿›è‚šå­é‡Œçš„è‚‰åå‡ºæ¥ï¼Œè€Œæ˜¯æ‹…å¿ƒæœªæ¥è¿›å…¥ä½åˆ©ç‡æ—¶ä»£ä»¥åï¼Œå€Ÿæ¬¾äººå¼ƒæˆ¿è€Œå»ï¼Œé‚£æ ·ä¼šå¼•å‘å…¨ç¤¾ä¼šç³»ç»Ÿæ€§çš„å¤§é£é™©ã€‚&lt;/p&gt;
&lt;p&gt;å› ä¸ºï¼Œå®ƒä»¬æ˜¯æå…¶ä¸“ä¸šå’Œå‰ç»çš„æœºæ„ï¼Œå·²ç»æå‰é¢„æµ‹åˆ°äº†ï¼š&lt;/p&gt;
&lt;p&gt;&lt;code&gt;åœ¨æœªæ¥5-20å¹´çš„æ—¶é—´é•¿åº¦å†…ï¼Œä¸­å›½ä¸€å®šä¼šæ­¥å‘è¾¾å›½å®¶çš„åå°˜ï¼Œè¿›å…¥ä½åˆ©ç‡ï¼Œç”šè‡³æ˜¯è´Ÿåˆ©ç‡æ—¶ä»£ã€‚&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ˜¯åäº‹å—ï¼Ÿç»å¯¹ä¸æ˜¯ï¼Œè¿™æ˜¯ä»»ä½•ç»æµä½“å‘å±•åˆ°ä¸€å®šæ°´å¹³åï¼Œå¿…ç„¶è¦è¿›å…¥çš„å¸¸æ€ã€‚&lt;/p&gt;
&lt;p&gt;å½“ç»æµä½“çš„ç”Ÿäº§åŠ›å·²ç»å……åˆ†å‘è¾¾ï¼Œäººå£ä¸å†ç»§ç»­å¢é•¿ï¼Œç‰©è´¨å……åˆ†ä¸°å¯Œä»¥åï¼Œä¸€ä¸ªå¸‚åœºçš„æ¶ˆè´¹èƒ½åŠ›æ˜¯æœ‰é™çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¼ä¸šç”Ÿäº§å‡ºæ¥çš„å®ä½“å•†å“ã€æä¾›çš„æœåŠ¡å’Œè™šæ‹Ÿå•†å“ï¼Œç»ˆå°†è¶…è¿‡è¯¥å›½æˆ–è€…å…¨çƒæ‰€æœ‰äººå£çš„æ¶ˆè´¹æ½œåŠ›ã€‚&lt;/p&gt;
&lt;p&gt;å‡å¦‚æ²¡æœ‰çªç ´æ€§çš„ç§‘æŠ€è¿›å±•ï¼Œé‚£ä¹ˆä¼ä¸šå®¶æ²¡æœ‰å¤šä½™åˆ©æ¶¦å¯å›¾ï¼Œå°†ä¸å†æ‰©å¤§ç”Ÿäº§ï¼Œä¸å°†åˆ©æ¶¦å†æŠ•èµ„ï¼Œä¸å‘é“¶è¡Œé—´æ¥è´·æ¬¾èèµ„ï¼Œä¸å‘è‚¡ç¥¨å¸‚åœºç›´æ¥è‚¡æƒèèµ„ï¼Œç¤¾ä¼šçš„GDPåŸåœ°è¸æ­¥ï¼Œå¹´è½»äººè–ªèµ„20å¹´ä¸ä¸Šæ¶¨ã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ ·å°†å¯¼è‡´ï¼Œç¤¾ä¼šä¸Šçš„å­˜æ¬¾èµ„é‡‘å’Œå¯æŠ•èµ„èµ„é‡‘ï¼Œå°†æ— å¤„å¯å»ã€‚å•†ä¸šé“¶è¡Œæ”¶å‚¨äº†æµ·é‡çš„å±…æ°‘å­˜æ¬¾ï¼Œæ‰¾ä¸åˆ°é€‚æ ¼çš„ä¼ä¸šå»å‘æ”¾è´·æ¬¾ï¼Œè‡ªç„¶ä¹Ÿèµšå–ä¸äº†æ¯å·®ã€‚&lt;/p&gt;
&lt;p&gt;æ•´ä½“ç¤¾ä¼šçš„åˆ©ç‡ï¼Œå°†æ˜¾è‘—ä¸‹è¡Œã€‚&lt;/p&gt;
&lt;p&gt;ç»Ÿè®¡è¿‡ï¼Œ2020å¹´åˆï¼Œå…¨çƒ26ä¸ªå›½å®¶æˆ–ç»æµä½“å½“ä¸­ï¼Œæœ‰20ä¸ªå›½å®¶æˆ–ç»æµä½“åˆ©ç‡å¤„äºä¸‹é™è¶‹åŠ¿ã€‚&lt;/p&gt;
&lt;p&gt;æ¬§ç›Ÿå¤®è¡Œï¼š-0.5%ï¼›&lt;/p&gt;
&lt;p&gt;æ—¥æœ¬å¤®è¡Œï¼š-0.1%ï¼›&lt;/p&gt;
&lt;p&gt;å¾·å›½10å¹´æœŸå›½å€ºï¼š-0.675%ã€‚&lt;/p&gt;
&lt;p&gt;2019å¹´8æœˆ5å·ï¼Œä¸¹éº¦çš„ç¬¬ä¸‰å¤§é“¶è¡Œæ—¥å¾·å…°é“¶è¡Œï¼Œæ¨å‡ºäº†äººç±»å†å²ä¸Šé¦–ç¬”è´Ÿåˆ©ç‡æŒ‰æ­è´·æ¬¾ä¸šåŠ¡ï¼Œæˆ¿è´·åˆ©ç‡ä¸º-0.5%ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;å¦‚æœä½ å€Ÿä¸¹éº¦è¿™å®¶é“¶è¡Œ100ä¸‡å…ƒå»ä¹°æˆ¿ï¼Œä¸€å¹´åä½ åªéœ€è¿˜99.5ä¸‡å…ƒå°±å¯ä»¥äº†ã€‚&lt;/p&gt;
&lt;p&gt;è¿™å®¶é“¶è¡Œå‘ä¹°æˆ¿äººå‘æ”¾è´·æ¬¾ï¼Œè´·æ¬¾ä¹°æˆ¿äººï¼Œæœ€ç»ˆè¿˜çš„é’±ï¼Œæ¯”å½“åˆé“¶è¡Œå€Ÿå‡ºçš„é’±ï¼Œè¿˜è¦å°‘ï¼&lt;/p&gt;
&lt;p&gt;å¬èµ·æ¥ï¼Œåƒä¸åƒå¤©æ–¹å¤œè°­ï¼Ÿç»å¯¹ä¸æ˜¯ï¼Œè¿™åœ¨è¥¿æ–¹å‘è¾¾ç»æµä½“ä¹‹ä¸­ï¼Œå·²ç»æˆä¸ºäº†å¸¸è¯†ã€‚&lt;/p&gt;
&lt;p&gt;2019å¹´8æœˆ6å·ï¼Œç‘å£«é“¶è¡Œå®£å¸ƒå¯¹50ä¸‡æ¬§å…ƒä»¥ä¸‹çš„å­˜æ¬¾è´¦æˆ·æ”¶å–å¹´è´¹ï¼Œå¹¶ä¸”ä¸æ”¯ä»˜åˆ©æ¯ã€‚&lt;/p&gt;
&lt;p&gt;åŒæ ·åœ°ï¼Œç”±äºæ¬§ç›Ÿç»„ç»‡é‡‘èä½“ç³»çš„åˆ©ç‡æ˜¯-0.5%ï¼Œè¿™æ„å‘³ç€ï¼Œä¸€ä¸ªäººåœ¨æ¬§ç›Ÿæ‰€å±çš„é“¶è¡Œå­˜æ¬¾1ä¸‡æ¬§å…ƒï¼Œä¸€å¹´åï¼Œåªèƒ½å–å›9950æ¬§å…ƒã€‚&lt;br&gt;&lt;img src=&quot;/images/other/2.jpg&quot; alt=&quot;2&quot;&gt;&lt;/p&gt;
&lt;p&gt;2019å¹´11æœˆ21æ—¥ï¼Œå·²ç»å¸ä»»äº†ä¸­å›½äººæ°‘é“¶è¡Œè¡Œé•¿èŒä½çš„å‘¨å°å·ï¼Œåœ¨åˆ›æ–°ç»æµè®ºå›ä¸Šè¡¨ç¤ºï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¸­å›½å¯ä»¥å°½é‡é¿å…å¿«é€Ÿåœ°è¿›å…¥åˆ°è´Ÿåˆ©ç‡æ—¶ä»£ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;è¨€ä¸‹ä¹‹æ„ï¼Œæˆ‘ä»¬ç¤¾ä¼šå¯ä»¥æ¨è¿Ÿè¿›å…¥åˆ°è´Ÿåˆ©ç‡æ—¶ä»£çš„æ—¶é—´é•¿åº¦ï¼Œå»¶è¿Ÿå®ƒçš„åˆ°æ¥ï¼Œä½†æ˜¯æ”¹å˜ä¸äº†å†å²å½’é€”ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨2017å¹´ä¹‹å‰çš„20å¹´æ—¶é—´é‡Œï¼Œæˆ‘ä»¬å·²ç»ä¹ æƒ¯äº†æˆ¿ä»·çš„ä¸Šæ¶¨ã€ç‰©ä»·çš„ä¸Šæ¶¨ï¼Œäººæ°‘å¸è´­ä¹°åŠ›çš„è´¬å€¼ã€‚å…¶æ ¹æœ¬åŸå› åœ¨äºï¼Œæˆ‘ä»¬å›½å®¶ä¾ç„¶å¤„äºå‘å±•é˜¶æ®µï¼Œå„è¡Œå„ä¸šçš„å•†å“å’ŒæœåŠ¡ï¼Œè¿˜æœ‰ç€å·¨å¤§çš„ç©ºç™½å¸‚åœºå»ç­‰ç€å‘æ˜ã€‚&lt;/p&gt;
&lt;p&gt;æˆ¿è´·åˆ©ç‡5.53%ã€æ°‘é—´å€Ÿè´·åˆ©ç‡10-30%ã€P2Pç½‘è´·åˆ©ç‡20-50%ã€‚é“¶è¡Œç†è´¢äº§å“æ”¶ç›Šç‡ä½äº6%ï¼Œéƒ½æ²¡æœ‰å¤§å¦ˆå¤§çˆ·çœ‹å¾—ä¸Šã€‚&lt;/p&gt;
&lt;p&gt;ä»2017å¹´å¼€å§‹ï¼Œé«˜æ”¶ç›Šçš„å¹»è±¡ï¼Œé€ä¸€ç ´ç­äº†ã€‚æˆ¿ä»·ä¸‹è·Œã€P2På¹³å°çˆ†é›·ã€ä¸Šå¸‚å…¬å¸å¤šå…ƒåŒ–æ‰©å¼ ä¸€åœ°é¸¡æ¯›ã€‚é‚£äº›è¿½é€é«˜æ”¶ç›Šçš„äººï¼Œä¸ä»…æ²¡æœ‰å¾—åˆ°é«˜åˆ©ç‡ï¼Œè¿è‡ªå·±çš„æœ¬é‡‘éƒ½æŸå¤±æ‰äº†ã€‚&lt;/p&gt;
&lt;p&gt;è‚¡å¸‚æ”¶ç›Šç‡é¢„æœŸé™ä½ã€å¹´è½»äººå°±ä¸šå¿ƒæ€æ”¾å¹³ã€ä¸­å¹´äººåªæ±‚ä¿ä½é¥­ç¢—ï¼Œè¿™æ‰æ˜¯æœªæ¥æˆ‘å›½ç»æµçš„ã€Œæ–°å¸¸æ€ã€ã€‚&lt;/p&gt;
&lt;p&gt;è¿›å…¥ä½åˆ©ç‡æ—¶ä»£åï¼Œæˆ‘ä»¬å»é“¶è¡Œå­˜é’±ï¼Œä¸ä»…æ²¡æœ‰åˆ©æ¯ï¼Œè¿˜è¦å€’ä»˜è´¹ç”¨ç»™é“¶è¡Œæ¥è´Ÿè´£ä¿ç®¡æˆ‘ä»¬çš„èµ„äº§æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;å› ä¸ºé“¶è¡Œæ”¶å‚¨ä¹‹åï¼Œå°†å±…æ°‘èµ„äº§ä¿ç®¡åœ¨é“¶è¡Œå†…éƒ¨ï¼Œå®ƒæ”¾è´·ä¸å‡ºå»ï¼Œæ²¡æœ‰äººæ¥å€Ÿæ¬¾ï¼Œè‡ªç„¶èµšå–ä¸äº†åˆ©æ¯å·®å¸¦æ¥çš„åˆ©æ¶¦ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ï¼Œè´Ÿåˆ©ç‡æ—¶ä»£åˆ°æ¥ä»¥åï¼Œè°æ”¾é’±åœ¨é“¶è¡Œï¼Œè°å°±è¦æ”¯ä»˜ç»™é“¶è¡Œä¸€å®šçš„è´¹ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœå€Ÿæ¬¾äººå‘ç°ï¼Œè‡ªå·±çš„å­˜æ¬¾æ²¡æœ‰åˆ©æ¯ï¼Œå…¨ç¤¾ä¼šçš„æ— é£é™©åˆ©ç‡éƒ½æ¥è¿‘äºé›¶ï¼Œä¼ä¸šä¸æ„¿æ„å»æŠ•èµ„ï¼Œç¤¾ä¼šGDPå¢é€ŸåŸåœ°è¸æ­¥ï¼Œè‡ªå·±åè€Œè¦æ‰¿æ‹…4.9%çš„åˆ©ç‡ï¼Œé‚£è¿™ç§è´Ÿæ‹…ï¼Œç»å¯¹æ˜¯å‹åŠ›å±±å¤§ï¼Œä¸å¯æ‰¿å—çš„ã€‚&lt;/p&gt;
&lt;p&gt;ç­‰åˆ°é‚£ä¸ªæ—¶å€™ï¼Œåˆ«è¯´å¥¢æœ›æˆ¿ä»·ä¸Šæ¶¨æˆä¸ºäº†ç™½æ—¥æ¢¦ï¼Œæ¯å¹´ä¸‹è·Œ2-10%ï¼Œéƒ½æ˜¯å¾ˆæœ‰å¯èƒ½çš„ï¼Œç»“æœè¿˜è¦å‡­ç©ºæ‰¿æ‹…-4.9%çš„åˆ©ç‡äºæŸï¼Œå‚»å­éƒ½çŸ¥é“ï¼Œåº”è¯¥æŠ›å¼ƒæˆ¿å­ï¼Œç›´æ¥æ–­ä¾›ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœå¤§æ‰¹é‡çš„ä¹°æˆ¿äººï¼Œé›†ä½“æ–­ä¾›ï¼Œæœ€ç»ˆä¼šå¼•å‘ä»€ä¹ˆåæœå‘¢ï¼Ÿé‚£å°±æ˜¯2008å¹´ç¾å›½æ¬¡è´·å±æœºçš„ç¿»ç‰ˆï¼Œé“¶è¡Œå°†å€’é—­ï¼Œç»æµç»§ç»­è§æ¡ï¼Œå¹´è½»äººå¤±ä¸šã€‚é‚£ç§åæœä¸æ˜¯æ¯ä¸ªç¤¾ä¼šéƒ½èƒ½æ‰¿å—çš„ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äºé‚£äº›åœ¨2020å¹´ï¼Œå°±é€‰æ‹©äº†ã€ŒLPRåˆ©ç‡+åŸºç‚¹åŠ æˆã€æ¨¡å¼çš„ä¹°æˆ¿äººè€Œè¨€ï¼Œä¼šå¼ ç¯ç»“å½©ã€æ•²é”£æ‰“é¼“åœ°è¿æ¥ä½åˆ©ç‡æ—¶ä»£ã€ç”šè‡³æ˜¯è´Ÿåˆ©ç‡æ—¶ä»£çš„åˆ°æ¥ã€‚&lt;/p&gt;
&lt;p&gt;ç†æƒ³æƒ…å†µä¸‹ï¼Œå‡å¦‚5å¹´æœŸLPRåˆ©ç‡é™ä½åˆ°äº†é›¶ï¼Œé‚£ä¹ˆå½“åˆçš„ä¹°æˆ¿äººæ‰¿æ‹…çš„åˆ©ç‡å°±åªæ˜¯å½“åˆçš„ã€ŒåŸºç‚¹åŠ æˆã€ï¼Œæ— è®ºæ˜¯ä¸Šæµ®è¿˜æ˜¯ä¸‹æµ®ï¼Œéƒ½å¯ä»¥è®¤ä¸ºè½»å¦‚é¸¿æ¯›ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªæ—¶å€™ï¼ŒåŸæœ‰ä¼ ç»Ÿæ¨¡å¼ä¹°æˆ¿äººï¼Œæ‰¿æ‹…çš„åˆ©ç‡æ˜¯4.90%ï¼Œæ¥å—äº†æ–°æ¨¡å¼çš„ä¹°æˆ¿äººï¼Œå‡ ä¹æ²¡æœ‰æˆ¿è´·åˆ©ç‡ï¼&lt;/p&gt;
&lt;p&gt;å¹´åŒ–4.90%åˆ©ç‡çš„å·®åˆ«ï¼Œå¦‚æœæˆ¿è´·ä½™é¢è¿˜å‰©ä¸‹200ä¸‡ï¼Œé‚£å°±æ˜¯å¹´åŒ–9.8ä¸‡å…ƒçš„å·®è·ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é’±ä¸é¦™å—ï¼Ÿä¸ºä»€ä¹ˆè¦å‡­ç©ºè´¡çŒ®ç»™é“¶è¡Œå‘¢ï¼Ÿ&lt;/p&gt;
&lt;h2 id=&quot;part-4&quot;&gt;&lt;a href=&quot;#part-4&quot; class=&quot;headerlink&quot; title=&quot;part 4&quot;&gt;&lt;/a&gt;part 4&lt;/h2&gt;&lt;p&gt;ç«™åœ¨2020å¹´çš„é—¨æ§›ä¸Šï¼Œå¤®è¡Œä¸€çœ¼æ´ç©¿äº†æœªæ¥20å¹´çš„ç»æµè½¨è¿¹ï¼Œå‚è€ƒäº†è¥¿æ–¹å‘è¾¾å›½å®¶çš„æˆç†Ÿç»éªŒï¼Œå¼•å¯¼å„å¤§å•†ä¸šé“¶è¡Œè´·æ¬¾äººï¼Œå’Œå€Ÿæ¬¾äººï¼Œé‡æ–°ç­¾è®¢é”šå®šäºLPRåˆ©ç‡çš„è´·æ¬¾åˆåŒã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸ä»…æ˜¯ç»™äºˆå€Ÿæ¬¾äººçš„å¤§çº¢åŒ…ï¼Œä¹Ÿæ˜¯ç«™åœ¨å…¨ç¤¾ä¼šçš„è§’åº¦ï¼Œæœªé›¨ç»¸ç¼ªï¼Œå°†æ”¶ç›Šå’Œé£é™©ï¼Œåœ¨å€Ÿæ¬¾äººå’Œè´·æ¬¾æœºæ„ä¹‹é—´åˆ†æ‘Šï¼Œä¿ƒè¿›æ•´ä¸ªç¤¾ä¼šçš„ç¨³å®šè¿è¡Œã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ï¼Œå¤®è¡Œå‡ºå°çš„æˆ¿è´·æ”¹é©æ–°æ”¿ï¼Œè®©è´·æ¬¾äººå’Œå€Ÿæ¬¾äººé‡æ–°ç­¾è®¢åˆ©ç‡åˆåŒï¼Œå……æ»¡ç€å¤§é‡çš„é‡‘èæœ¯è¯­å’Œæ™¦æ¶©çš„æ¦‚å¿µã€‚&lt;/p&gt;
&lt;p&gt;å•†ä¸šé“¶è¡Œçš„ç›®çš„æ˜¯ä¸ºäº†é€åˆ©ã€‚å®ƒä»¬ä½œä¸ºè´·æ¬¾äººï¼Œèµšå–åˆ©æ¯å·®ï¼Œè®©å€Ÿæ¬¾äººæ‰¿æ‹…çš„åˆ©ç‡è¶Šé«˜ï¼Œé“¶è¡Œçš„åˆ©æ¶¦å°±è¶Šé«˜ã€‚&lt;br&gt;&lt;img src=&quot;/images/other/3.jpg&quot; alt=&quot;3&quot;&gt;&lt;/p&gt;
&lt;p&gt;æ”¶å–æ™ºå•†ç¨çš„æœ€ä½³æ–¹å¼æ˜¯ï¼Œåˆ¶é€ ä¿¡æ¯ä¸å¯¹ç§°ï¼Œåˆ©ç”¨è‡ªå·±çš„ä¿¡æ¯ä¼˜åŠ¿ï¼Œæ¥æ”¶å‰²å¯¹æ–¹ã€‚&lt;/p&gt;
&lt;p&gt;å•†ä¸šé“¶è¡Œä¸€å®šä¼šå·§èˆŒå¦‚ç°§ã€å£åè²èŠ±ä¸€èˆ¬ï¼Œæ•…æ„å°†ä¸¤ç§åˆ©ç‡æ¨¡å¼ï¼Œè¯´å¾—å€Ÿæ¬¾äººå¦‚äº‘å±±é›¾é‡Œï¼Œçœ¼å†’é‡‘æ˜Ÿã€‚&lt;/p&gt;
&lt;p&gt;ç«™åœ¨é“¶è¡Œçš„è§’åº¦æ¥è¯´ï¼Œå®ƒä»¬å¸Œæœ›å€Ÿæ¬¾äººåƒæ— å¤´è‹è‡ä¸€æ ·ï¼Œè·Ÿç€ä»–ä»¬çš„èŠ‚å¥èµ°ï¼Œä¸çŸ¥ä¸è§‰å°±èººåœ¨ç §æ¿ä¸Šï¼Œæ‘†å¥½äº†å¾…å®°çš„ä½“ä½ã€‚&lt;/p&gt;
&lt;p&gt;åªæœ‰æ˜å“¥ï¼Œæƒ¦è®°ç€ä½ çš„é’±åŒ…ã€‚&lt;/p&gt;
&lt;p&gt;åƒè¨€ä¸‡è¯­ï¼Œæ±‡æˆä¸€å¥è¯ï¼&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ä»2020å¹´3æœˆ1æ—¥å¼€å§‹çš„5ä¸ªæœˆæ—¶é—´é‡Œï¼Œå½“é“¶è¡Œè”ç³»ä½ é‡æ–°åå•†æˆ¿è´·åˆ©ç‡æ—¶ï¼Œä¸€å®šè¦åšæŒã€ŒLPRåˆ©ç‡+åŸºç‚¹åŠ æˆã€æ¨¡å¼ï¼Œå¹¶ä¸”åˆ©ç‡ä¸€å¹´è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ã€‚&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªæœºä¼šï¼Œæ¶‰åŠåˆ°ä½ å®¶åº­æ•°åä¸‡ï¼Œç”šè‡³ä¸Šç™¾ä¸‡çš„èµ„é‡‘ï¼Œæ˜¯ç”¨äºè‡ªå·±ï¼Œè¿˜æ˜¯è´¡çŒ®ç»™é“¶è¡Œã€‚&lt;/p&gt;
&lt;p&gt;å¯åƒä¸‡åˆ«é€‰é”™äº†ï¼Œå› ä¸ºå¤®è¡Œåªç»™äº†ä¸€æ¬¡æœºä¼šï¼Œæ²¡æœ‰åæ‚”è¯å¯åƒï¼&lt;/p&gt;
&lt;p&gt;æ¥æºï¼šæ˜å“¥åœ¨è·¯ä¸Š&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;part-1&quot;&gt;&lt;a href=&quot;#part-1&quot; class=&quot;headerlink&quot; title=&quot;part 1&quot;&gt;&lt;/a&gt;part 1&lt;/h2&gt;&lt;p&gt;&lt;code&gt;æ¯ä¸€ä¸ªèƒŒè´Ÿäº†æˆ¿è´·çš„äººï¼Œç»å¯¹æƒ³ä¸åˆ°ï¼Œè¿›å…¥2020å¹´å¤´çš„æ—¶å€™ï¼Œå¤®è¡Œä¼šé€æ¥ä¸€ä»½å¤§ç¤¼ã€‚&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;2019å¹´12æœˆ28æ—¥ï¼Œä¸­å›½äººæ°‘é“¶è¡Œï¼ˆå¤®è¡Œï¼‰å‘å¸ƒå¹´å†…ç¬¬30å·å…¬å‘Šã€‚å…¬å‘Šä¸­çš„æ–‡å­—éå¸¸ä¸“ä¸šã€æ™¦æ¶©ï¼Œä¸æ˜¯é‡‘èä¸“ä¸šå‡ºèº«çš„äººï¼Œä¼šè§‰å¾—äº‘é‡Œé›¾é‡Œï¼Œä¹Ÿä½“ä¼šä¸åˆ°è¿™åˆ™å…¬å‘Šçš„å²è¯—çº§ä½œç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ç¬¬ä¸€ï¼š&lt;strong&gt;ä»2020å¹´1æœˆ1æ—¥å¼€å§‹ï¼Œå•†ä¸šé“¶è¡Œä¸å¾—å’Œä¹°æˆ¿äººï¼Œç­¾è®¢å‚è€ƒè´·æ¬¾åŸºå‡†åˆ©ç‡çš„æµ®åŠ¨åˆ©ç‡è´·æ¬¾åˆåŒã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ç¬¬äºŒï¼š&lt;strong&gt;ä»2020å¹´3æœˆ1æ—¥å¼€å§‹ï¼Œå•†ä¸šé“¶è¡Œå¿…é¡»å’Œå­˜é‡æˆ¿è´·çš„å€Ÿæ¬¾äººï¼ŒåºŸé™¤åŸæœ‰æˆ¿è´·åˆåŒï¼Œè®©å€Ÿæ¬¾äººé‡æ–°äºŒé€‰ä¸€ï¼Œè¦ä¹ˆï¼šå›ºå®šåˆ©ç‡ï¼›è¦ä¹ˆï¼šã€ŒLPRåˆ©ç‡+åŸºç‚¹åŠ æˆã€æ¨¡å¼ã€‚&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="LPR" scheme="http://team.jiunile.com/categories/LPR/"/>
    
      <category term="æˆ¿è´·" scheme="http://team.jiunile.com/categories/LPR/%E6%88%BF%E8%B4%B7/"/>
    
    
      <category term="lpr" scheme="http://team.jiunile.com/tags/lpr/"/>
    
      <category term="æˆ¿è´·" scheme="http://team.jiunile.com/tags/%E6%88%BF%E8%B4%B7/"/>
    
      <category term="æ‚è°ˆ" scheme="http://team.jiunile.com/tags/%E6%9D%82%E8%B0%88/"/>
    
      <category term="å¸‚åœºç»æµ" scheme="http://team.jiunile.com/tags/%E5%B8%82%E5%9C%BA%E7%BB%8F%E6%B5%8E/"/>
    
  </entry>
  
</feed>

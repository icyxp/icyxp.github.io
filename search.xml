<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[Kubernetes in Kuberntes]]></title>
      <url>http://team.jiunile.com/blog/2020/06/k8s-k8s-in-k8s.html</url>
      <content type="html"><![CDATA[<p><code>KinD</code> æ˜¯ä¸€ä¸ªéå¸¸è½»é‡çº§çš„ Kubernetes å®‰è£…å·¥å…·ï¼Œä»–å°† Docker å®¹å™¨å½“æˆ Kubernetes çš„èŠ‚ç‚¹ï¼Œä½¿ç”¨éå¸¸æ–¹ä¾¿ã€‚æ—¢ç„¶åœ¨ Docker å®¹å™¨ä¸­å¯ä»¥è¿è¡Œ Kubernetes é›†ç¾¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶å°±ä¼šæƒ³åˆ°æ˜¯å¦å¯ä»¥åœ¨ Pod ä¸­æ¥è¿è¡Œå‘¢ï¼Ÿåœ¨ Pod ä¸­è¿è¡Œä¼šé‡åˆ°å“ªäº›é—®é¢˜å‘¢ï¼Ÿ</p>
<h2 id="åœ¨-Pod-ä¸­å®‰è£…-Docker-Daemon"><a href="#åœ¨-Pod-ä¸­å®‰è£…-Docker-Daemon" class="headerlink" title="åœ¨ Pod ä¸­å®‰è£… Docker Daemon"></a>åœ¨ Pod ä¸­å®‰è£… Docker Daemon</h2><p><code>KIND</code> å½“å‰ä¾èµ–äº Dockerï¼ˆå°½ç®¡ä»–ä»¬è®¡åˆ’å¾ˆå¿«æ”¯æŒå…¶ä»–å®¹å™¨è¿è¡Œæ—¶ï¼Œä¾‹å¦‚<code>podman</code>ï¼‰ã€‚å› æ­¤ï¼Œç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ªå®¹å™¨æ˜ åƒï¼Œè¯¥æ˜ åƒå…è®¸æ‚¨åœ¨ Pod å†…è¿è¡Œ Dockerå®ˆæŠ¤ç¨‹åºï¼Œä»¥ä¾¿ä½¿è¯¸å¦‚<code>docker run</code>ä¹‹ç±»çš„å‘½ä»¤åœ¨Podå†…è¿è¡Œï¼ˆåˆå Docker-in-Docker æˆ– DIND ï¼‰ã€‚</p>
<p>Docker-in-Docker æ˜¯ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„é—®é¢˜ï¼Œå¹¶ä¸”å·²ç»è§£å†³äº†ç›¸å½“ä¸€æ®µæ—¶é—´ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå½“å°è¯•åœ¨ç”Ÿäº§ Kubernetes é›†ç¾¤ä¸­æ­£ç¡®è®¾ç½® Docker-in-Docker æ—¶ï¼Œæˆ‘ä»¬ä»ç„¶é‡åˆ°å¾ˆå¤šé—®é¢˜ã€‚<br><a id="more"></a></p>
<h3 id="MTUé—®é¢˜"><a href="#MTUé—®é¢˜" class="headerlink" title="MTUé—®é¢˜"></a>MTUé—®é¢˜</h3><p>MTU é—®é¢˜çš„æ€§è´¨å®é™…ä¸Šå–å†³äºç”Ÿäº§ Kubernetes é›†ç¾¤çš„ç½‘ç»œæä¾›å•†ã€‚æˆ‘ä»¬ç”¨äº CI çš„Kubernetes å‘è¡Œç‰ˆæ˜¯ <a href="https://d2iq.com/solutions/ksphere/konvoy" target="_blank" rel="external">Konvoy</a>ã€‚Konvoy ä½¿ç”¨<code>Calico</code>ä½œä¸ºå…¶é»˜è®¤ç½‘ç»œæä¾›å•†ï¼Œå¹¶ä¸”é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨<code>IPIP</code>å°è£…ã€‚<code>IPIP</code>å°è£…äº§ç”Ÿ20å­—èŠ‚çš„å¼€é”€ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœç¾¤é›†ä¸­ä¸»æœºç½‘ç»œçš„ä¸»ç½‘ç»œæ¥å£çš„<code>MTU</code>ä¸º1500ï¼Œåˆ™Podä¸­ç½‘ç»œæ¥å£çš„<code>MTU</code>å°†ä¸º1480ã€‚å¦‚æœæ‚¨çš„ç”Ÿäº§ç¾¤é›†åœ¨æŸäº›äº‘æä¾›å•†ï¼ˆä¾‹å¦‚GCEï¼‰ä¸Šè¿è¡Œï¼Œåˆ™<code>MTU Pod</code>çš„æœ€å¤§å€¼ç”šè‡³æ›´ä½ï¼ˆ1460-20 = 1440ï¼‰ã€‚</p>
<p>é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨ Pod å†…é…ç½®é»˜è®¤ Docker ç½‘ç»œçš„<code>MTU</code>ï¼ˆ<code>dockerd</code> çš„ <code>--mtu</code>æ ‡å¿—ï¼‰ï¼Œä½¿å…¶ç­‰äºæˆ–å°äº Pod çš„ç½‘ç»œæ¥å£çš„<code>MTU</code>ã€‚å¦åˆ™ï¼Œæ‚¨å°†æ— æ³•ä¸å¤–ç•Œå»ºç«‹è¿æ¥ï¼ˆä¾‹å¦‚ï¼Œä»äº’è”ç½‘ä¸Šè·å–å®¹å™¨å›¾åƒæ—¶ï¼‰ã€‚</p>
<h3 id="PID-1-çš„é—®é¢˜"><a href="#PID-1-çš„é—®é¢˜" class="headerlink" title="PID 1 çš„é—®é¢˜"></a>PID 1 çš„é—®é¢˜</h3><p>æ¯”å¦‚æˆ‘ä»¬éœ€è¦åœ¨ä¸€ä¸ªå®¹å™¨ä¸­å»è¿è¡Œ <code>Docker Daemon</code> ä»¥åŠä¸€äº› Kubernetes çš„é›†ç¾¤æµ‹è¯•ï¼Œè€Œè¿™äº›æµ‹è¯•ä¾èµ–äº <code>KinD</code> å’Œ <code>Docker Damon</code>ï¼Œåœ¨ä¸€ä¸ªå®¹å™¨ä¸­è¿è¡Œå¤šä¸ªæœåŠ¡æˆ‘ä»¬å¯èƒ½ä¼šå»ä½¿ç”¨ <code>systemd</code>ï¼Œä½†æ˜¯ä½¿ç”¨ <code>systemd</code> ä¹Ÿä¼šæœ‰ä¸€äº›é—®é¢˜ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬éœ€è¦ä¿ç•™æµ‹è¯•çš„é€€å‡ºçŠ¶æ€ï¼ŒKubernetes ä¸­ä½¿ç”¨çš„å®¹å™¨è¿è¡Œæ—¶å¯ä»¥ watch åˆ°å®¹å™¨ä¸­çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ˆPID 1ï¼‰çš„é€€å‡ºçŠ¶æ€ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨ <code>systemd</code> çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬æµ‹è¯•çš„è¿›ç¨‹é€€å‡ºçŠ¶æ€ä¸ä¼šè¢«è½¬å‘åˆ° Kubernetesã€‚</p>
<p>æ­¤å¤–è·å–æµ‹è¯•çš„æ—¥å¿—ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ï¼Œåœ¨ Kubernetes ä¸­ä¼šè‡ªåŠ¨è·å–å†™å…¥åˆ° stdout å’Œ stderr çš„å®¹å™¨æ—¥å¿—ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨ <code>systemd</code> çš„è¯ï¼Œè¦æƒ³è·å–åº”ç”¨çš„æ—¥å¿—å°±æ¯”è¾ƒéº»çƒ¦çš„ã€‚</p>
<p>ä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å®¹å™¨é•œåƒä¸­ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„å¯åŠ¨è„šæœ¬ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dockerd &amp;</span><br><span class="line"><span class="comment"># Wait until dockerd is ready.</span></span><br><span class="line">until docker ps &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Waiting for dockerd..."</span></span><br><span class="line">  sleep 1</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬ä¸èƒ½å°†ä¸Šé¢çš„è„šæœ¬ä½œä¸ºå®¹å™¨çš„ entrypointï¼Œåœ¨é•œåƒä¸­å®šä¹‰çš„ entrypoint ä¼šåœ¨å®¹å™¨ä¸­ä»¥ PID 1 çš„å½¢å¼è¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„ <code>pid namespace</code> ä¸­ã€‚PID 1 æ˜¯ä¸€ä¸ªå†…æ ¸ä¸­çš„ä¸€ä¸ªç‰¹æ®Šè¿›ç¨‹ï¼Œå®ƒçš„è¡Œä¸ºå’Œå…¶ä»–è¿›ç¨‹ä¸åŒã€‚</p>
<p>æœ¬è´¨ä¸Šï¼Œæ¥æ”¶ä¿¡å·çš„è¿›ç¨‹æ˜¯ PID 1ï¼šå®ƒä¼šè¢«å†…æ ¸åšç‰¹æ®Šå¤„ç†ï¼›å¦‚æœå®ƒæ²¡æœ‰ä¸ºä¿¡å·æ³¨å†Œä¸€ä¸ªå¤„ç†å™¨ï¼Œå†…æ ¸å°±ä¸ä¼šå›åˆ°é»˜è®¤è¡Œä¸ºï¼ˆå³æ€æ­»è¿›ç¨‹ï¼‰ã€‚ç”±äºå½“æ”¶åˆ° SIGTERM ä¿¡å·æ—¶ï¼Œå†…æ ¸ä¼šé»˜è®¤æ€æ­»è¿™ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥ä¸€äº›è¿›ç¨‹ä¹Ÿè®¸ä¸ä¼šä¸º SIGTERM ä¿¡å·æ³¨å†Œä¿¡å·å¤„ç†ç¨‹åºã€‚å¦‚æœå‡ºç°äº†è¿™ç§æƒ…å†µï¼Œå½“ Kubernetes å°è¯•ç»ˆæ­¢ Pod æ—¶ï¼ŒSIGTERM å°†è¢«åå™¬ï¼Œä½ ä¼šæ³¨æ„åˆ° Pod ä¼šè¢«å¡åœ¨ Terminating çš„çŠ¶æ€ä¸‹ã€‚</p>
<p>è¿™å…¶å®ä¸æ˜¯ä¸€ä¸ªä»€ä¹ˆæ–°é²œçš„é—®é¢˜ï¼Œä½†æ˜¯äº†è§£è¿™ä¸ªé—®é¢˜çš„äººå´å¹¶ä¸å¤šï¼Œè€Œä¸”è¿˜ä¸€ç›´åœ¨æ„å»ºæœ‰è¿™æ ·é—®é¢˜çš„å®¹å™¨ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ tini è¿™ä¸ªåº”ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°†å…¶ä½œä¸ºé•œåƒçš„å…¥å£ç‚¹ï¼Œå¦‚åœ¨ <code>Dockerfile</code> ä¸­æ‰€ç¤ºï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENTRYPOINT [<span class="string">"/usr/bin/tini"</span>, <span class="string">"--"</span>, <span class="string">"/entrypoint.sh"</span>]</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªç¨‹åºä¼šæ­£ç¡®æ³¨å†Œä¿¡å·å¤„ç†ç¨‹åºå’Œè½¬å‘ä¿¡å·ã€‚å®ƒè¿˜ä¼šæ‰§è¡Œä¸€äº›å…¶ä»– PID 1 çš„äº‹æƒ…ï¼Œæ¯”å¦‚å›æ”¶å®¹å™¨ä¸­çš„åƒµå°¸è¿›ç¨‹ã€‚</p>
<h3 id="æŒ‚è½½-cgroups"><a href="#æŒ‚è½½-cgroups" class="headerlink" title="æŒ‚è½½ cgroups"></a>æŒ‚è½½ cgroups</h3><p>ç”±äº <code>Docker Daemon</code> éœ€è¦æ§åˆ¶ cgroupsï¼Œæ‰€ä»¥éœ€è¦å°† cgroup æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°å®¹å™¨ä¸­å»ã€‚ä½†æ˜¯ç”±äº cgroups å’Œå®¿ä¸»æœºæ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¡®ä¿ <code>Docker Daemon</code> æ§åˆ¶çš„ cgroups ä¸ä¼šå½±å“åˆ°å…¶ä»–å®¹å™¨æˆ–è€…å®¿ä¸»æœºè¿›ç¨‹ä½¿ç”¨çš„å…¶ä»– cgroupsï¼Œè¿˜éœ€è¦ç¡®ä¿ <code>Docker Daemon</code> åœ¨å®¹å™¨ä¸­åˆ›å»ºçš„ cgroups åœ¨å®¹å™¨é€€å‡ºåä¸ä¼šè¢«æ³„éœ²ã€‚</p>
<p><code>Docker Daemon</code> ä¸­æœ‰ä¸€ä¸ª <code>--cgroupâ€”parent</code> å‚æ•°æ¥å‘Šè¯‰ Daemon å°†æ‰€æœ‰å®¹å™¨çš„ cgroups åµŒå¥—åœ¨æŒ‡å®šçš„ cgroup ä¸‹é¢ã€‚å½“å®¹å™¨è¿è¡Œåœ¨ Kubernetes é›†ç¾¤ä¸‹é¢æ—¶ï¼Œæˆ‘ä»¬åœ¨å®¹å™¨ä¸­è®¾ç½® <code>Docker Daemon</code> çš„ <code>--cgroupâ€”parent</code> å‚æ•°ï¼Œè¿™æ ·å®ƒçš„æ‰€æœ‰ cgroups å°±ä¼šè¢«åµŒå¥—åœ¨ Kubernetes ä¸ºå®¹å™¨åˆ›å»ºçš„ cgroup ä¸‹é¢äº†ã€‚</p>
<p>åœ¨ä»¥å‰ä¸ºäº†è®© cgroup æ–‡ä»¶ç³»ç»Ÿåœ¨å®¹å™¨ä¸­å¯ç”¨ï¼Œä¸€äº›ç”¨æˆ·ä¼šå°†å®¿ä¸»æœºä¸­çš„ <code>/sys/fs/cgroup</code> æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„è¿™ä¸ªä½ç½®ï¼Œå¦‚æœè¿™æ ·ä½¿ç”¨çš„è¯ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨å®¹å™¨å¯åŠ¨è„šæœ¬ä¸­æŠŠ <code>--cgroupâ€”parent</code> è®¾ç½®ä¸ºä¸‹é¢çš„å†…å®¹ï¼Œè¿™æ · <code>Docker Daemon</code> åˆ›å»ºçš„ cgroups å°±å¯ä»¥æ­£ç¡®è¢«åµŒå¥—äº†ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGROUP_PARENT=<span class="string">"<span class="variable">$(grep systemd /proc/self/cgroup | cut -d: -f3)</span>/docker"</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>æ³¨æ„ï¼š<code>/proc/self/cgroup</code> æ˜¾ç¤ºçš„æ˜¯è°ƒç”¨è¿›ç¨‹çš„ cgroup è·¯å¾„ã€‚</p>
</blockquote>
<p>ä½†æ˜¯æˆ‘ä»¬è¦çŸ¥é“ï¼ŒæŒ‚è½½å®¿ä¸»æœºçš„ <code>/sys/fs/cgroup</code> æ–‡ä»¶æ˜¯éå¸¸å±é™©çš„äº‹æƒ…ï¼Œå› ä¸ºä»–æŠŠæ•´ä¸ªå®¿ä¸»æœºçš„ cgroup å±‚æ¬¡ç»“æ„éƒ½æš´éœ²ç»™äº†å®¹å™¨ã€‚ä»¥å‰ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒDocker ç”¨äº†ä¸€ä¸ªå°æŠ€å·§æŠŠä¸ç›¸å…³çš„ cgroups éšè—èµ·æ¥ï¼Œä¸è®©å®¹å™¨çœ‹åˆ°ã€‚Docker ä»å®¹å™¨çš„ cgroups å¯¹æ¯ä¸ª cgroup ç³»ç»Ÿçš„ cgroup å±‚æ¬¡ç»“æ„çš„æ ¹éƒ¨è¿›è¡Œç»‘å®šæŒ‚è½½ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm debian findmnt -lo <span class="built_in">source</span>,target -t cgroup</span><br><span class="line">SOURCE                                                                               TARGET</span><br><span class="line">cpuset[/docker/451b803b3<span class="built_in">cd</span>7<span class="built_in">cd</span>2b69dde64<span class="built_in">cd</span>833fdd799ae16f9d2d942386ec382f6d55bffac]     /sys/fs/cgroup/cpuset</span><br><span class="line">cpu[/docker/451b803b3<span class="built_in">cd</span>7<span class="built_in">cd</span>2b69dde64<span class="built_in">cd</span>833fdd799ae16f9d2d942386ec382f6d55bffac]        /sys/fs/cgroup/cpu</span><br><span class="line">cpuacct[/docker/451b803b3<span class="built_in">cd</span>7<span class="built_in">cd</span>2b69dde64<span class="built_in">cd</span>833fdd799ae16f9d2d942386ec382f6d55bffac]    /sys/fs/cgroup/cpuacct</span><br><span class="line">blkio[/docker/451b803b3<span class="built_in">cd</span>7<span class="built_in">cd</span>2b69dde64<span class="built_in">cd</span>833fdd799ae16f9d2d942386ec382f6d55bffac]     /sys/fs/cgroup/blkio</span><br><span class="line">memory[/docker/451b803b3<span class="built_in">cd</span>7<span class="built_in">cd</span>2b69dde64<span class="built_in">cd</span>833fdd799ae16f9d2d942386ec382f6d55bffac]     /sys/fs/cgroup/memory</span><br><span class="line"> </span><br><span class="line">cgroup[/docker/451b803b3<span class="built_in">cd</span>7<span class="built_in">cd</span>2b69dde64<span class="built_in">cd</span>833fdd799ae16f9d2d942386ec382f6d55bffac]     /sys/fs/cgroup/systemd</span><br></pre></td></tr></table></figure></p>
<p>ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡º cgroups é€šè¿‡å°†å®¿ä¸»æœº cgroup æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ <code>/sys/fs/cgroup/memory/memory.limit_in_bytes</code> æ–‡ä»¶æ˜ å°„åˆ° <code>/sys/fs/cgroup/memory/docker/&lt;CONTAINER_ID&gt;/memory.limit_in_bytes</code> æ¥æ§åˆ¶å®¹å™¨å†… cgroup å±‚æ¬¡ç»“æ„æ ¹éƒ¨çš„æ–‡ä»¶ï¼Œè¿™ç§æ–¹å¼å¯ä»¥é˜²æ­¢å®¹å™¨è¿›ç¨‹æ„å¤–åœ°ä¿®æ”¹å®¿ä¸»æœºçš„ cgroupã€‚</p>
<p>ä½†æ˜¯è¿™ç§æ–¹å¼æœ‰æ—¶å€™ä¼šè®© cadvisor å’Œ kubelet è¿™æ ·çš„åº”ç”¨æ„ŸåŠ¨å›°æƒ‘ï¼Œå› ä¸ºç»‘å®šæŒ‚è½½å¹¶ä¸ä¼šæ”¹å˜ <code>/proc/&lt;PID&gt;/cgroup</code> é‡Œé¢çš„å†…å®¹ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm debian cat /proc/1/cgroup</span><br><span class="line">14:name=systemd:/docker/512f6b62e3963f85f5abc09b69c370d27ab1dc56549fa8afcbb86eec8663a141</span><br><span class="line"> </span><br><span class="line">5:memory:/docker/512f6b62e3963f85f5abc09b69c370d27ab1dc56549fa8afcbb86eec8663a141</span><br><span class="line">4:blkio:/docker/512f6b62e3963f85f5abc09b69c370d27ab1dc56549fa8afcbb86eec8663a141</span><br><span class="line">3:cpuacct:/docker/512f6b62e3963f85f5abc09b69c370d27ab1dc56549fa8afcbb86eec8663a141</span><br><span class="line">2:cpu:/docker/512f6b62e3963f85f5abc09b69c370d27ab1dc56549fa8afcbb86eec8663a141</span><br><span class="line">1:cpuset:/docker/512f6b62e3963f85f5abc09b69c370d27ab1dc56549fa8afcbb86eec8663a141</span><br><span class="line">0::/</span><br></pre></td></tr></table></figure></p>
<p>cadvisor ä¼šé€šè¿‡æŸ¥çœ‹ <code>/proc/&lt;PID&gt;/cgroup</code> æ¥è·å–ç»™å®šè¿›ç¨‹çš„ cgroupï¼Œå¹¶å°è¯•ä»å¯¹åº”çš„ cgroup ä¸­è·å– CPU æˆ–å†…å­˜ç»Ÿè®¡æ•°æ®ã€‚ä½†æ˜¯ç”±äº <code>Docker Daemon</code> è¿›ç¨‹åšäº†ç»‘å®šæŒ‚è½½ï¼Œcadvisor å°±æ— æ³•æ‰¾åˆ°å®¹å™¨è¿›ç¨‹å¯¹åº”çš„ cgroupã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åœ¨å®¹å™¨å†…éƒ¨åˆåšäº†ä¸€æ¬¡æŒ‚è½½ï¼Œä» <code>/sys/fs/cgroup/memory</code> æŒ‚è½½åˆ° <code>/sys/fs/cgroup/memory/docker/&lt;CONTAINER_ID&gt;/</code>ï¼ˆé’ˆå¯¹æ‰€æœ‰çš„ cgroup å­ç³»ç»Ÿï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>ç°åœ¨æ–°çš„è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨ <code>cgroup namespace</code>ï¼Œå¦‚æœä½ è¿è¡Œåœ¨ä¸€ä¸ªå†…æ ¸ç‰ˆæœ¬ 4.6+ çš„ Linux ç³»ç»Ÿä¸‹é¢ï¼Œrunc å’Œ docker éƒ½åŠ å…¥äº† cgroup å‘½åç©ºé—´çš„æ”¯æŒã€‚ä½†æ˜¯ç›®å‰ Kubernetes æš‚æ—¶è¿˜ä¸æ”¯æŒ cgroup å‘½åç©ºé—´ï¼Œä½†æ˜¯å¾ˆå¿«ä¼šä½œä¸º <code>cgroups v2</code> æ”¯æŒçš„ä¸€éƒ¨åˆ†ã€‚</p>
<h3 id="IPtables"><a href="#IPtables" class="headerlink" title="IPtables"></a>IPtables</h3><p>åœ¨ä½¿ç”¨çš„æ—¶å€™æˆ‘ä»¬å‘ç°åœ¨çº¿ä¸Šçš„ Kubernetes é›†ç¾¤è¿è¡Œæ—¶ï¼Œæœ‰æ—¶å€™å®¹å™¨å†…çš„ <code>Docker Daemon</code> å¯åŠ¨çš„åµŒå¥—å®¹å™¨æ— æ³•è®¿é—®å¤–ç½‘ï¼Œä½†æ˜¯åœ¨æœ¬åœ°å¼€å‘ç”µè„‘ä¸Šå´å¯ä»¥å¾ˆæ­£å¸¸çš„å·¥ä½œï¼Œå¤§éƒ¨åˆ†å¼€å‘è€…åº”è¯¥éƒ½ä¼šç»å¸¸é‡åˆ°è¿™ç§æƒ…å†µã€‚</p>
<p>æœ€åå‘ç°å½“å‡ºç°è¿™ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œæ¥è‡ªåµŒå¥—çš„ Docker å®¹å™¨çš„æ•°æ®åŒ…å¹¶æ²¡æœ‰æ‰“åˆ° iptables çš„ POSTROUTING é“¾ï¼Œæ‰€ä»¥æ²¡æœ‰åš masqueradedã€‚</p>
<p>è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºåŒ…å« <code>Docker Daemon</code> çš„é•œåƒæ˜¯åŸºäº Debian buster çš„ï¼Œè€Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒDebian buster ä½¿ç”¨çš„æ˜¯ nftables ä½œä¸º iptables çš„é»˜è®¤åç«¯ï¼Œç„¶è€Œ Docker æœ¬èº«è¿˜ä¸æ”¯æŒ nftablesã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜åªéœ€è¦åœ¨å®¹å™¨é•œåƒä¸­åˆ‡æ¢åˆ° iptables å‘½ä»¤å³å¯ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RUN update-alternatives --set iptables  /usr/sbin/iptables-legacy || <span class="literal">true</span> &amp;&amp; \</span><br><span class="line">    update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy || <span class="literal">true</span> &amp;&amp; \</span><br><span class="line">    update-alternatives --set arptables /usr/sbin/arptables-legacy || <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p>å®Œæ•´çš„ Dockerfile æ–‡ä»¶å’Œå¯åŠ¨è„šæœ¬å¯ä»¥åœ¨ <a href="https://github.com/jieyu/docker-images/tree/master/dind" target="_blank" rel="external">GitHub</a> ä¸Šé¢è·å–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>jieyu/dind-buster:v0.1.8</code> è¿™ä¸ªé•œåƒæ¥æµ‹è¯•ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm --privileged jieyu/dind-buster:v0.1.8 docker run alpine wget baidu.com</span><br></pre></td></tr></table></figure></p>
<p>åœ¨ Kubernetes é›†ç¾¤ä¸‹ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ Pod èµ„æºæ¸…å•éƒ¨ç½²å³å¯ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Pod</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> dind</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - image:</span> jieyu/dind-buster:v0<span class="number">.1</span><span class="number">.8</span></span><br><span class="line"><span class="attr">    name:</span> dind</span><br><span class="line"><span class="attr">    stdin:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    tty:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">    -</span> /bin/bash</span><br><span class="line"><span class="attr">    volumeMounts:</span></span><br><span class="line"><span class="attr">    - mountPath:</span> /var/lib/docker</span><br><span class="line"><span class="attr">      name:</span> varlibdocker</span><br><span class="line"><span class="attr">    securityContext:</span></span><br><span class="line"><span class="attr">      privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">  - name:</span> varlibdocker</span><br><span class="line"><span class="attr">    emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="åœ¨-Pod-ä¸­è¿è¡Œ-KinD"><a href="#åœ¨-Pod-ä¸­è¿è¡Œ-KinD" class="headerlink" title="åœ¨ Pod ä¸­è¿è¡Œ KinD"></a>åœ¨ Pod ä¸­è¿è¡Œ KinD</h2><p>ä¸Šé¢æˆ‘ä»¬æˆåŠŸé…ç½®äº† Docker-in-Docker(DinD)ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥åœ¨è¯¥å®¹å™¨ä¸­ä½¿ç”¨ KinD å¯åŠ¨ Kubernetes é›†ç¾¤ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -ti --rm --privileged jieyu/dind-buster:v0.1.8 /bin/bash</span><br><span class="line">Waiting <span class="keyword">for</span> dockerd...</span><br><span class="line">[root@257b543a91a5 /]<span class="comment"># curl -Lso ./kind https://kind.sigs.k8s.io/dl/v0.8.1/kind-$(uname)-amd64</span></span><br><span class="line">[root@257b543a91a5 /]<span class="comment"># chmod +x ./kind</span></span><br><span class="line">[root@257b543a91a5 /]<span class="comment"># mv ./kind /usr/bin/</span></span><br><span class="line">[root@257b543a91a5 /]<span class="comment"># kind create cluster</span></span><br><span class="line">Creating cluster <span class="string">"kind"</span> ...</span><br><span class="line"> âœ“ Ensuring node image (kindest/node:v1.18.2) ğŸ–¼</span><br><span class="line"> âœ“ Preparing nodes ğŸ“¦</span><br><span class="line"> âœ“ Writing configuration ğŸ“œ</span><br><span class="line"> âœ“ Starting control-plane ğŸ•¹ï¸</span><br><span class="line"> âœ“ Installing CNI ğŸ”Œ</span><br><span class="line"> âœ“ Installing StorageClass ğŸ’¾</span><br><span class="line">Set kubectl context to <span class="string">"kind-kind"</span></span><br><span class="line">You can now use your cluster with:</span><br><span class="line">kubectl cluster-info --context kind-kind</span><br><span class="line">Have a nice day! ğŸ‘‹</span><br><span class="line">[root@257b543a91a5 /]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME                 STATUS   ROLES    AGE   VERSION</span><br><span class="line">kind-control-plane   Ready    master   11m   v1.18.2</span><br></pre></td></tr></table></figure></p>
<p>ç”±äºæŸäº›åŸå› å¯èƒ½ä½ ç”¨ä¸Šé¢çš„å‘½ä»¤ä¸‹è½½ä¸äº† kindï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åŠæ³•æå‰ä¸‹è½½åˆ°å®¿ä¸»æœºä¸Šé¢ï¼Œç„¶åç›´æ¥æŒ‚è½½åˆ°å®¹å™¨ä¸­å»ä¹Ÿå¯ä»¥ï¼Œæˆ‘è¿™é‡Œå°† kind å’Œ kubectl å‘½ä»¤éƒ½æŒ‚è½½åˆ°å®¹å™¨ä¸­å»ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨å®¹å™¨å³å¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --rm --privileged -v /usr/<span class="built_in">local</span>/bin/kind:/usr/bin/kind -v /usr/<span class="built_in">local</span>/bin/kubectl:/usr/bin/kubectl jieyu/dind-buster:v0.1.8 /bin/bash</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/k8s/k8s_in_k8s_1.png" alt="k8s-in-k8s"><br>å¯ä»¥çœ‹åˆ°åœ¨å®¹å™¨ä¸­å¯ä»¥å¾ˆå¥½çš„ä½¿ç”¨ KinD æ¥åˆ›å»º Kubernetes é›†ç¾¤ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç›´æ¥åœ¨ Kubernetes ä¸­æ¥æµ‹è¯•ä¸€æ¬¡ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply <span class="_">-f</span> dind.yaml</span><br><span class="line">$ kubectl <span class="built_in">exec</span> -ti dind /bin/bash</span><br><span class="line">root@dind:/<span class="comment"># curl -Lso ./kind https://kind.sigs.k8s.io/dl/v0.7.0/kind-$(uname)-amd64</span></span><br><span class="line">root@dind:/<span class="comment"># chmod +x ./kind</span></span><br><span class="line">root@dind:/<span class="comment"># mv ./kind /usr/bin/</span></span><br><span class="line">root@dind:/<span class="comment"># kind create cluster</span></span><br><span class="line">Creating cluster <span class="string">"kind"</span> ...</span><br><span class="line"> âœ“ Ensuring node image (kindest/node:v1.17.0) ğŸ–¼</span><br><span class="line"> âœ“ Preparing nodes ğŸ“¦</span><br><span class="line"> âœ“ Writing configuration ğŸ“œ</span><br><span class="line"> âœ— Starting control-plane ğŸ•¹ï¸</span><br><span class="line">ERROR: failed to create cluster: failed to init node with kubeadm: <span class="built_in">command</span> <span class="string">"docker exec --privileged kind-control-plane kubeadm init --ignore-preflight-errors=all --config=/kind/kubeadm.conf --skip-token-print --v=6"</span> failed with error: <span class="built_in">exit</span> status 137</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ Pod ä¸­ä½¿ç”¨ KinD æ¥åˆ›å»ºé›†ç¾¤å¤±è´¥äº†ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ KinD èŠ‚ç‚¹åµŒå¥—å®¹å™¨å†…è¿è¡Œçš„ kubelet ä¼šéšæœºæ€æ­»é¡¶å±‚å®¹å™¨å†…çš„è¿›ç¨‹ï¼Œè¿™å…¶å®è¿˜æ˜¯å’Œä¸Šé¢è®¨è®ºçš„ cgroups çš„æŒ‚è½½æœ‰å…³ã€‚</p>
<p>ä½†å…¶å®æˆ‘è‡ªå·±åœ¨ä½¿ç”¨ v0.8.1 ç‰ˆæœ¬çš„ KinD çš„æ—¶å€™ï¼Œåœ¨ä¸Šé¢çš„ Pod ä¸­æ˜¯å¯ä»¥æ­£å¸¸åˆ›å»ºé›†ç¾¤çš„ï¼Œä¸çŸ¥é“æ˜¯å¦æ˜¯ KinD æ­å»ºçš„é›†ç¾¤æœ‰ä»€ä¹ˆç‰¹æ®Šå¤„ç†ï¼Œè¿™é‡Œéœ€è¦å†æ·±å…¥ç ”ç©¶ï¼š<br><img src="/images/k8s/k8s_in_k8s_2.png" alt="k8s-in-k8s"></p>
<p>å¦‚æœä½ åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº†ä¸Šè¿°çš„é—®é¢˜ï¼Œåˆ™å¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹è§£å†³æ–¹æ¡ˆã€‚</p>
<p>å½“é¡¶å±‚å®¹å™¨ï¼ˆDINDï¼‰åœ¨ Kubernetes  Pod ä¸­è¿è¡Œçš„æ—¶å€™ï¼Œå¯¹äºæ¯ä¸ª cgroup å­ç³»ç»Ÿï¼ˆæ¯”å¦‚å†…å­˜ï¼‰ï¼Œä»å®¿ä¸»æœºçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒçš„ cgroup è·¯å¾„æ˜¯ <code>/kubepods/burstable/&lt;POD_ID&gt;/&lt;DIND_CID&gt;</code>ã€‚</p>
<p>å½“ KinD åœ¨ DIND å®¹å™¨å†…çš„åµŒå¥—èŠ‚ç‚¹å®¹å™¨å†…å¯åŠ¨ kubelet çš„æ—¶å€™ï¼Œkubelet å°†åœ¨ <code>/kubepods/burstable/</code> ä¸‹ç›¸å¯¹äºåµŒå¥— KIND èŠ‚ç‚¹å®¹å™¨çš„æ ¹ cgroup ä¸ºå…¶ Pods æ¥æ“ä½œ cgroupã€‚ä»å®¿ä¸»æœºçš„è§’åº¦æ¥çœ‹ï¼Œcgroup è·¯å¾„å°±æ˜¯ <code>/kubepods/burstable/&lt;POD_ID&gt;/&lt;DIND_CID&gt;/docker/&lt;KIND_CID&gt;/kubepods/burstable/</code>ã€‚</p>
<p>è¿™äº›éƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯åœ¨åµŒå¥—çš„ KinD èŠ‚ç‚¹å®¹å™¨ä¸­ï¼Œæœ‰å¦ä¸€ä¸ª cgroup å­˜åœ¨äº <code>/kubepods/burstable/&lt;POD_ID&gt;/&lt;DIND_CID&gt;/docker/&lt;DIND_CID&gt;</code> ä¸‹é¢ï¼Œç›¸å¯¹äºåµŒå¥—çš„ KinD èŠ‚ç‚¹å®¹å™¨çš„æ ¹ cgroupï¼Œåœ¨ kubelet å¯åŠ¨ä¹‹å‰å°±å­˜åœ¨äº†ï¼Œè¿™æ˜¯ä¸Šé¢æˆ‘ä»¬è®¨è®ºè¿‡çš„ cgroups æŒ‚è½½é€ æˆçš„ï¼Œé€šè¿‡ KinD entrypoint è„šæœ¬è®¾ç½®ã€‚è€Œå¦‚æœä½ åœ¨ KinD èŠ‚ç‚¹å®¹å™¨é‡Œé¢åšä¸€ä¸ª <code>cat /kubepods/burstable/&lt;POD_ID&gt;/docker/&lt;DIND_CID&gt;/tasks</code>ï¼Œä½ ä¼šçœ‹åˆ° DinD å®¹å™¨çš„è¿›ç¨‹ã€‚<br><img src="/images/k8s/k8s_in_k8s_3.png" alt="k8s-in-k8s"></p>
<p>è¿™å°±æ˜¯æœ€æ ¹æœ¬çš„åŸå› ï¼ŒKinD èŠ‚ç‚¹å®¹å™¨é‡Œé¢çš„ kubelet çœ‹åˆ°äº†è¿™ä¸ª cgroupï¼Œä»¥ä¸ºåº”è¯¥ç”±å®ƒæ¥ç®¡ç†ï¼Œä½†æ˜¯å´æ‰¾ä¸åˆ°å’Œè¿™ä¸ª cgroup ç›¸å…³è”çš„ Podï¼Œæ‰€ä»¥å°±ä¼šå°è¯•æ¥æ€æ­»å±äºè¿™ä¸ª cgroup çš„è¿›ç¨‹æ¥åˆ é™¤è¿™ä¸ª cgroupã€‚è¿™ä¸ªæ“ä½œçš„ç»“æœå°±æ˜¯éšæœºè¿›ç¨‹è¢«æ€æ­»ã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•å¯ä»¥é€šè¿‡è®¾ç½® kubelet çš„ <code>--cgroup-root</code> å‚æ•°ï¼Œé€šè¿‡è¯¥æ ‡å¿—æ¥æŒ‡ç¤º KinD èŠ‚ç‚¹å®¹å™¨å†…çš„ kubelet ä¸ºå…¶ Pods ä½¿ç”¨ä¸åŒçš„ cgroup æ ¹è·¯å¾„ï¼ˆæ¯”å¦‚ /kubeletï¼‰ã€‚è¿™æ ·å°±å¯ä»¥åœ¨ Kubernetes é›†ç¾¤ä¸­æ¥å¯åŠ¨ KinD é›†ç¾¤äº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„ YAML èµ„æºæ¸…å•æ–‡ä»¶æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Pod</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> kind-cluster</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - image:</span> jieyu/kind-cluster-buster:v0<span class="number">.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">    name:</span> kind-cluster</span><br><span class="line"><span class="attr">    stdin:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    tty:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">    -</span> /bin/bash</span><br><span class="line"><span class="attr">    env:</span></span><br><span class="line"><span class="attr">    - name:</span> API_SERVER_ADDRESS</span><br><span class="line"><span class="attr">      valueFrom:</span></span><br><span class="line"><span class="attr">        fieldRef:</span></span><br><span class="line"><span class="attr">          fieldPath:</span> status.podIP</span><br><span class="line"><span class="attr">    volumeMounts:</span></span><br><span class="line"><span class="attr">    - mountPath:</span> /var/lib/docker</span><br><span class="line"><span class="attr">      name:</span> varlibdocker</span><br><span class="line"><span class="attr">    - mountPath:</span> /lib/modules</span><br><span class="line"><span class="attr">      name:</span> libmodules</span><br><span class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    securityContext:</span></span><br><span class="line"><span class="attr">      privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">    - containerPort:</span> <span class="number">30001</span></span><br><span class="line"><span class="attr">      name:</span> api-server-port</span><br><span class="line"><span class="attr">      protocol:</span> TCP</span><br><span class="line"><span class="attr">    readinessProbe:</span></span><br><span class="line"><span class="attr">      failureThreshold:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">      httpGet:</span></span><br><span class="line"><span class="attr">        path:</span> /healthz</span><br><span class="line"><span class="attr">        port:</span> api-server-port</span><br><span class="line"><span class="attr">        scheme:</span> HTTPS</span><br><span class="line"><span class="attr">      initialDelaySeconds:</span> <span class="number">120</span></span><br><span class="line"><span class="attr">      periodSeconds:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">      successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">  - name:</span> varlibdocker</span><br><span class="line"><span class="attr">    emptyDir:</span> &#123;&#125;</span><br><span class="line"><span class="attr">  - name:</span> libmodules</span><br><span class="line"><span class="attr">    hostPath:</span></span><br><span class="line"><span class="attr">      path:</span> /lib/modules</span><br></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨ä¸Šé¢çš„èµ„æºæ¸…å•æ–‡ä»¶åˆ›å»ºå®Œæˆåï¼Œç¨ç­‰ä¸€ä¼šå„¿æˆ‘ä»¬å°±å¯ä»¥è¿›å…¥ Pod ä¸­æ¥éªŒè¯ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -ti kind-cluster /bin/bash</span><br><span class="line">root@kind-cluster:/<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME                 STATUS   ROLES    AGE   VERSION</span><br><span class="line">kind-control-plane   Ready    master   72s   v1.17.0</span><br></pre></td></tr></table></figure></p>
<p>åŒæ ·ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ Docker CLI æ¥è¿›è¡Œæµ‹è¯•ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -ti --rm --privileged jieyu/kind-cluster-buster:v0.1.0 /bin/bash</span><br><span class="line">Waiting <span class="keyword">for</span> dockerd...</span><br><span class="line">Setting up KIND cluster</span><br><span class="line">Creating cluster <span class="string">"kind"</span> ...</span><br><span class="line"> âœ“ Ensuring node image (jieyu/kind-node:v1.17.0) ğŸ–¼</span><br><span class="line"> âœ“ Preparing nodes ğŸ“¦</span><br><span class="line"> âœ“ Writing configuration ğŸ“œ</span><br><span class="line"> âœ“ Starting control-plane ğŸ•¹ï¸</span><br><span class="line"> âœ“ Installing CNI ğŸ”Œ</span><br><span class="line"> âœ“ Installing StorageClass ğŸ’¾</span><br><span class="line"> âœ“ Waiting â‰¤ 15m0s <span class="keyword">for</span> control-plane = Ready â³</span><br><span class="line"> â€¢ Ready after 31s ğŸ’š</span><br><span class="line">Set kubectl context to <span class="string">"kind-kind"</span></span><br><span class="line">You can now use your cluster with:</span><br><span class="line">kubectl cluster-info --context kind-kind</span><br><span class="line">Have a nice day! ğŸ‘‹</span><br><span class="line">root@d95fa1302557:/<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME                 STATUS   ROLES    AGE   VERSION</span><br><span class="line">kind-control-plane   Ready    master   71s   v1.17.0</span><br><span class="line">root@d95fa1302557:/<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>ä¸Šé¢é•œåƒå¯¹åº”çš„ Dockerfile å’Œå¯åŠ¨è„šæœ¬åœ°å€ï¼š<a href="https://github.com/jieyu/docker-images/tree/master/kind-cluster" target="_blank" rel="external">https://github.com/jieyu/docker-images/tree/master/kind-cluster</a></p>
</blockquote>
<p>ä¸‹å›¾æ˜¯æˆ‘åœ¨ KinD æ­å»ºçš„ Kubernetes é›†ç¾¤ä¸­ï¼Œåˆ›å»ºçš„ä¸€ä¸ª Podï¼Œç„¶ååœ¨ Pod ä¸­åˆ›å»ºçš„ä¸€ä¸ªç‹¬ç«‹çš„ Kubernetes é›†ç¾¤æœ€ç»ˆæ•ˆæœï¼š<br><img src="/images/k8s/k8s_in_k8s_4.png" alt="k8s-in-k8s"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨å®ç°ä¸Šé¢åŠŸèƒ½çš„æ—¶å€™ï¼Œè¿‡ç¨‹ä¸­è¿˜æ˜¯é‡åˆ°äº†ä¸å°‘çš„éšœç¢ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†éƒ½æ˜¯å› ä¸º Docker å®¹å™¨æ²¡æœ‰æä¾›å’Œå®¿ä¸»æœºå®Œå…¨éš”ç¦»çš„åŠŸèƒ½é€ æˆçš„ï¼ŒæŸäº›å†…æ ¸èµ„æºæ¯”å¦‚ cgroups æ˜¯åœ¨å†…æ ¸ä¸­å…±äº«çš„ï¼Œå¦‚æœå¾ˆå¤šå®¹å™¨åŒæ—¶æ“ä½œå®ƒä»¬ï¼Œä¹Ÿå¯èƒ½ä¼šé€ æˆæ½œåœ¨çš„å†²çªã€‚ä½†æ˜¯ä¸€æ—¦è§£å†³äº†è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥éå¸¸æ–¹ä¾¿çš„åœ¨ Kubernetes é›†ç¾¤ Pod ä¸­è½»æ¾åœ°è¿è¡Œä¸€ä¸ªç‹¬ç«‹çš„ Kubernetes é›†ç¾¤äº†ï¼Œè¿™åº”è¯¥ç®—çœŸæ­£çš„ Kubernetes IN Kubernetes äº†å§~</p>
<p>å‚è€ƒï¼š<a href="https://d2iq.com/blog/running-kind-inside-a-kubernetes-cluster-for-continuous-integration" target="_blank" rel="external">https://d2iq.com/blog/running-kind-inside-a-kubernetes-cluster-for-continuous-integration</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[å¤šé›†ç¾¤kubernetes dashboard é€šè¿‡ldapç»Ÿä¸€ç™»å½•ä¸æˆæƒ]]></title>
      <url>http://team.jiunile.com/blog/2020/06/k8s-mutiboard-ldap.html</url>
      <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/icyxp/kubernetes-dashboard-ldap/master/assets/images/logo.png" alt="logo.png"></p>
<h1 id="å·¥å…·ç”±æ¥"><a href="#å·¥å…·ç”±æ¥" class="headerlink" title="å·¥å…·ç”±æ¥"></a>å·¥å…·ç”±æ¥</h1><p>ä¸ºä»€ä¹ˆè¦å†™è¿™æ ·çš„ä¸€ä¸ªå·¥å…·å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºæˆ‘å¸æœ‰å¤šä¸ª <code>kubernetes</code> é›†ç¾¤(8+)ï¼Œä¸”éƒ½æ˜¯äº‘æ‰˜ç®¡æœåŠ¡æ— æ³•æ¥è§¦åˆ°Apiserveré…ç½®ï¼Œè¿™å°±ç»™æˆ‘ä»¬å¸¦æ¥ä¸€ä¸ªç—›ç‚¹ï¼Œ<strong>å¼€å‘ã€sreéœ€è¦ç™»å½•k8s dashbaordä¸”ä¸åŒéƒ¨é—¨å’Œè§’è‰²é—´éœ€è¦ä¸åŒçš„æˆæƒ</strong>ï¼ŒåŸå…ˆéƒ½æ˜¯é€šè¿‡ <code>sa token</code> è¿›è¡Œç™»å½•dashboardï¼Œä½†éšç€k8sé›†ç¾¤çš„å¢é•¿ï¼Œæ¯å¢åŠ ä¸€ä¸ªé›†ç¾¤ï¼Œå°±éœ€è¦å‘ŠçŸ¥ä½¿ç”¨æ–¹å¯¹åº”dashboardè®¿é—®åœ°å€ä»¥åŠå¯¹åº”çš„tokenï¼Œè¿™ä¸ç®¡æ˜¯æä¾›æ–¹è¿˜æ˜¯ä½¿ç”¨æ–¹éƒ½è®©äººæ„Ÿè§‰éå¸¸çš„ç—›è‹¦ã€‚é‚£æ˜¯å¦æœ‰ä¸€æ¬¾å·¥å…·èƒ½<strong>æä¾›ç»Ÿä¸€åœ°å€ç»Ÿä¸€ç™»å½•å¤šé›†ç¾¤dashboardçš„æ–¹æ¡ˆ</strong>å‘¢ï¼Ÿç»è¿‡ä¸€ç•ªæœç´¢åï¼Œå‘ç°å¹¶æ²¡æœ‰ï¼Œå¸‚é¢ä¸Šå¤§å¤šæ•°æ˜¯å•é›†ç¾¤é›†æˆ <code>LDAP</code> çš„æ–¹æ¡ˆï¼Œä¸»è¦æ˜¯ä»¥ <code>DEX</code> ä¸ºä¸»ï¼Œä½†å…‰å•é›†ç¾¤çš„ç»Ÿä¸€ç™»å½•æˆæƒæ–¹æ¡ˆå°±è®©äººæ„Ÿè§‰éå¸¸çš„å›°éš¾ã€‚éš¾é“å°±æ²¡æœ‰ç®€å•æ–¹ä¾¿çš„å·¥å…·ä¾›æˆ‘ä»¬ä½¿ç”¨å—ï¼Ÿå¥½å§ï¼Œé‚£æˆ‘å°±æ¥æ‰“é€ è¿™æ ·ä¸€æ¬¾å·¥å…·å§ã€‚</p>
<p>Dashboard LDAPé›†æˆæ–¹æ¡ˆï¼š</p>
<ul>
<li><a href="https://k2r2bai.com/2019/09/29/ironman2020/day14/" target="_blank" rel="external">https://k2r2bai.com/2019/09/29/ironman2020/day14/</a></li>
<li><a href="https://blog.inkubate.io/access-your-kubernetes-cluster-with-your-active-directory-credentials" target="_blank" rel="external">https://blog.inkubate.io/access-your-kubernetes-cluster-with-your-active-directory-credentials</a></li>
</ul>
<p>ä»¥ä¸Šä¸¤ç¯‡æ–‡æ¡£æ˜¯æˆLDAPçš„æ–¹æ¡ˆï¼Œä¸ªäººæ„Ÿè§‰è¿˜ä¸é”™ï¼Œä¾›æœ‰éœ€è¦çš„äººå‚è€ƒï¼<br><a id="more"></a></p>
<h1 id="å¦‚ä½•æ‰“é€ "><a href="#å¦‚ä½•æ‰“é€ " class="headerlink" title="å¦‚ä½•æ‰“é€ "></a>å¦‚ä½•æ‰“é€ </h1><p>å¥½å§æ—¢ç„¶æ²¡æœ‰ï¼Œé‚£å°±è‡ªåŠ¨åŠ¨æ‰‹æ‰“é€ ä¸€ä¸ªï¼</p>
<blockquote>
<p>ç›®æ ‡ï¼š <strong>ç®€å•ä½¿ç”¨</strong>ï¼ï¼ï¼é€šè¿‡è®¿é—®åŒä¸€åœ°å€ï¼Œä½¿ç”¨LDAPç™»å½•ä¸”å¯åˆ‡æ¢ä¸åŒé›†ç¾¤çš„dashboardï¼ŒåŒæ—¶å¯¹åº”ä¸åŒçš„é›†ç¾¤æƒé™å¯å•ç‹¬é…ç½®ï¼</p>
</blockquote>
<p>æœ‰äº†ä¸Šé¢çš„ç›®æ ‡ï¼Œé‚£å¦‚ä½•æ¥å®ç°å‘¢ï¼Ÿ</p>
<p>å®ç°æ–¹å¼å…¶å®å¾ˆç®€å•ï¼Œé¦–å…ˆå†™ä¸€ä¸ªç™»å½•ç•Œé¢ä¸å…¬å¸çš„ADè¿›è¡Œæ‰“é€šè·å–ç”¨æˆ·ä¸ç»„ï¼Œç„¶åå°†ç”¨æˆ·æˆ–è€…ç»„ä¸k8sé›†ç¾¤ä¸­çš„ <code>service account</code> è¿›è¡Œå…³è”å°±å®ç°äº†å¯¹åº”çš„rbacä¸ç™»å½•tokenï¼Œæœ€ååœ¨ç™»å½•åå®ç°ä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å³å¯å®Œæˆã€‚</p>
<p>æ˜¯ä¸æ˜¯éå¸¸çš„ç®€å•ï¼ï¼ï¼</p>
<p>å®ç°æŠ€æœ¯æ ˆï¼šgolang(ginã€client-goã€viperã€ldap) + Kubernetes Dashboard</p>
<h1 id="å¦‚ä½•éƒ¨ç½²"><a href="#å¦‚ä½•éƒ¨ç½²" class="headerlink" title="å¦‚ä½•éƒ¨ç½²"></a>å¦‚ä½•éƒ¨ç½²</h1><h2 id="å‰ææ¡ä»¶"><a href="#å‰ææ¡ä»¶" class="headerlink" title="å‰ææ¡ä»¶"></a>å‰ææ¡ä»¶</h2><p>åœ¨ä½¿ç”¨æ­¤å·¥å…·å‰ï¼Œéœ€è¦æœ‰ä»¥ä¸‹ä¸€äº›æ¡ä»¶çº¦æŸï¼š</p>
<ol>
<li>å·²åœ¨å„k8sé›†ç¾¤éƒ¨ç½² <code>dashboard</code> ä¸”èƒ½è¢«æ­¤å·¥å…·è®¿é—®åˆ°</li>
<li>å·²æœ‰ <code>ldap</code> ä¸”æœ‰ç®¡ç†æƒé™èƒ½è¿›è¡Œè®¿é—®æ“ä½œ</li>
<li>å„é›†ç¾¤ä¸­æœ‰å¯¹åº”çš„ <code>service account</code> å¯è¿›è¡Œæ˜ å°„ï¼Œå¦‚éœ€å¯¹ä¸åŒç”¨æˆ·å’Œç»„éœ€è¦æœ‰ä¸åŒçš„æ“ä½œæƒé™ï¼Œåˆ™å¯¹saè¿›è¡Œrbacæˆæƒå³å¯ï¼Œä¸‹é¢ä¼šè¯¦ç»†è¯´æ˜ã€‚</li>
<li>æ­¤å·¥å…·éœ€è¦æ“ä½œå„é›†ç¾¤çš„apiï¼Œæ•…éœ€è¦è·å–æ¯ä¸ªé›†ç¾¤çš„ <code>apiserveråœ°å€</code>ã€<code>ca.crt</code> ä»¥åŠ <code>token</code> è¿›è¡Œé…ç½®ï¼Œè‡³äºæ¯ä¸ªé›†ç¾¤çš„ <code>ca.crt</code> å’Œ <code>token</code> å¦‚æœè·å–ï¼Œåé¢ä¼šè¿›è¡Œè¯´æ˜</li>
</ol>
<h2 id="å¦‚ä½•è·å–-ca-crt-åŠ-token"><a href="#å¦‚ä½•è·å–-ca-crt-åŠ-token" class="headerlink" title="å¦‚ä½•è·å– ca.crt åŠ token"></a>å¦‚ä½•è·å– ca.crt åŠ token</h2><p>æ­¤å·¥å…·éœ€è¦æ“ä½œæ¯ä¸ªé›†ç¾¤çš„apiæ¥è·å–å¯¹åº”çš„ sa ä»¥åŠ tokenï¼Œæ•…éœ€è¦æœ‰å¯¹å„é›†ç¾¤æ“ä½œçš„æƒé™ã€‚é‚£å¦‚ä½•åœ¨å„é›†ç¾¤ç”Ÿæˆå¯¹åº”çš„ caè¯ä¹¦ åŠ token å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯åˆ›å»ºä¸€ä¸ª sa å¹¶ç»™äºˆä¸€å®šçš„æƒé™ã€‚</p>
<p>åœ¨æ¯ä¸ªk8sé›†ç¾¤ä¸­æ‰§è¡Œå¦‚ä¸‹yamlæ–‡ä»¶:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> ServiceAccount</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> mutiboard-ldap</span><br><span class="line"><span class="attr">  namespace:</span> default</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="attr">kind:</span> ClusterRoleBinding</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> mutiboard-ldap-crb</span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="attr">  kind:</span> ClusterRole</span><br><span class="line"><span class="attr">  name:</span> mutiboard-ldap-view</span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> ServiceAccount</span><br><span class="line"><span class="attr">  name:</span> mutiboard-ldap</span><br><span class="line"><span class="attr">  namespace:</span> default</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="attr">kind:</span> ClusterRole</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> mutiboard-ldap-view</span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> serviceaccounts</span><br><span class="line"><span class="bullet">  -</span> secrets</span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> get</span><br><span class="line"><span class="bullet">  -</span> list</span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> namespaces</span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> get</span><br><span class="line"><span class="bullet">  -</span> list</span><br><span class="line"><span class="bullet">  -</span> watch</span><br></pre></td></tr></table></figure></p>
<p>æ­¤yamlæ–‡ä»¶çš„å«ä¹‰ï¼šåˆ›å»ºä¸€ä¸ªåä¸º<code>mutiboard-ldap</code>çš„ saï¼Œå¹¶ä¸”ç»™äºˆ<code>serviceaccounts</code>å’Œ<code>secrets</code>çš„getå’Œlistçš„æƒé™ã€‚</p>
<p>è·å– <code>mutiboard-ldap</code> çš„ ca.crtï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(âˆ|aws-local:default)â¯ <span class="built_in">echo</span> $(kubectl get secret $(kubectl get secret | grep mutiboard-ldap | awk <span class="string">'&#123;print $1&#125;'</span>) -o go-template=<span class="string">'&#123;&#123;index .data "ca.crt"&#125;&#125;'</span>) | base64 <span class="_">-d</span></span><br><span class="line"></span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIICyDCCAbCgAwIBAgIBADANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwprdWJl</span><br><span class="line">cm5ldGVzMB4XDTE5MDEyNTEwMTgzNFoXDTI5MDEyMjEwMTgzNFowFTETMBEGA1UE</span><br><span class="line">AxMKa3ViZXJuZXRlczCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMmc</span><br><span class="line">TW0stLLP+M6Pc9wpRgZufg6eQ7puBfbYgik20QlO4LFtocgNUDa0y+aSXjxheA2C</span><br><span class="line">A+o9wW0IC3GHQHKgeFY8KXIJu6wM0TO+JNQy5XZAWfbsLeXU/sLhKuWET/KJzVWT</span><br><span class="line">0uBE+GCADAAQIec1oQXMbQ551hU5gBFcr67NXHpa2qwEGA1mGtZ7ztmW4+IFUD74</span><br><span class="line">G166z4AOgmR4YWxBs/+8NhfWudFD32xevBfSKuHRxRGG5dtffY8QnRbnrmy70HE5</span><br><span class="line">yzLtBvAGfCwtHLTP2ngCAnn2Fb6IeMdIYGpI1544ZjRbzT1YIWsG1v3dlu6tvK1q</span><br><span class="line">X5Pj+UTDmJuf2SW52A0CAwEAAaMjMCEwDgYDVR0PAQH/BAQDAgKkMA8GA1UdEwEB</span><br><span class="line">/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAKE2hV0DIG8fSf4/eOi5R2sPRfBW</span><br><span class="line">qTwgZDDT9dxZNhbxEInALdruwRUbKRpwaUBOGVpIlaK3/rZkAfjUwoDJ+J4fmmCX</span><br><span class="line">w3ySrYFjx6tqVFqCPjDkBHh4xpMwUlvsvryRuCEQUQgjqBvj6sWm9GERF2n3VYBF</span><br><span class="line">S8bjsQQAZJoE4W+OKchlEoSFlKhxAoeZx9CD3Rxnhj2og6<span class="keyword">do</span>VoGCUqAMh4WZWX+w</span><br><span class="line">pENnui6M96SysH3SkrA02RXWTGeKzK4E6Av3IG+2a2hauHorbqVfaM6HeL3hkU/B</span><br><span class="line">JCWpOgN3T4Fw7E359CBQxnSHPasmZ5VBoyIk/HUU6ZlMK6Xo6JlbS7ZvVl4=</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure></p>
<p>è·å– <code>mutiboard-ldap</code> çš„ tokenï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(âˆ|aws-local:default)â¯ <span class="built_in">echo</span> $(kubectl get secret $(kubectl get secret | grep mutiboard-ldap | awk <span class="string">'&#123;print $1&#125;'</span>) -o go-template=<span class="string">'&#123;&#123;.data.token&#125;&#125;'</span>) | base64 <span class="_">-d</span></span><br><span class="line"></span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6Im11dGlib2FyZC1sZGFwLXRva2VuLWJ3NWdmIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6Im11dGlib2FyZC1sZGFwIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMjVmZjI4MGQtYWJhMi0xMWVhLWFlOGEtMDIzOTBjMzcyNzhlIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6bXV0aWJvYXJkLWxkYXA<span class="keyword">if</span>Q.q14hqEu2p70_YczDviR6c8McDM5vfnKPzjO9usCsC-uQUxciBbuJU_PK9j3uawppUNlrs3rAPrZIGUS7Jv14rifEXpGxIIfGR6n8-le0b-9YvMZCgs9-jhf-1r01EAnZFh6gcXfxESFguFQI0vYOsX4P2LQvZ9XTMzsqXbW3KGYao5elAjCE4e8Rg4--9e_zU8NGTEycsvUMxP-9p0SaAzn9Iak3saZtAnzJq5hkSf1t7l2_CgEsYN-3b7uGpHupK_zdgAeOflj9ze4Cz2YScv5eixwVXJ-RcI4lgSFCgt5yzSbnIuHgxRZyN3NcYLrSBYKftezZysWm3jELgLPogQ</span><br></pre></td></tr></table></figure></p>
<p>è‡³æ­¤ï¼Œå„é›†ç¾¤çš„ <code>ca.crt</code> å’Œ <code>token</code> éƒ½å·²è·å–ï¼Œä¸‹é¢ä¼šå‘ŠçŸ¥å¦‚ä½•è¿›è¡Œé…ç½®ä½¿ç”¨è¿™äº› <code>ca.crt</code> å’Œ <code>token</code></p>
<h2 id="SA-RBACåˆ—å­"><a href="#SA-RBACåˆ—å­" class="headerlink" title="SA RBACåˆ—å­"></a>SA RBACåˆ—å­</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> ServiceAccount</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> ops-admin</span><br><span class="line"><span class="attr">  namespace:</span> default</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="attr">kind:</span> ClusterRole</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> ops-role</span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span> [<span class="string">""</span>]</span><br><span class="line"><span class="attr">  resources:</span> [<span class="string">"namespaces"</span>]</span><br><span class="line"><span class="attr">  verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> ClusterRoleBinding</span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> ops-listnamespace</span><br><span class="line"><span class="attr">roleRef:</span> <span class="comment">#å¼•ç”¨çš„è§’è‰²</span></span><br><span class="line"><span class="attr">  kind:</span> ClusterRole</span><br><span class="line"><span class="attr">  name:</span> ops-role</span><br><span class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="attr">subjects:</span> <span class="comment">#ä¸»ä½“</span></span><br><span class="line"><span class="attr">- kind:</span> ServiceAccount</span><br><span class="line"><span class="attr">  name:</span> ops-admin</span><br><span class="line"><span class="attr">  namespace:</span> default</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> RoleBinding</span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> ops-ci-admin</span><br><span class="line"><span class="attr">  namespace:</span> ops-ci</span><br><span class="line"><span class="attr">roleRef:</span> <span class="comment">#å¼•ç”¨çš„è§’è‰²</span></span><br><span class="line"><span class="attr">  kind:</span> ClusterRole</span><br><span class="line"><span class="attr">  name:</span> admin</span><br><span class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="attr">subjects:</span> <span class="comment">#ä¸»ä½“</span></span><br><span class="line"><span class="attr">- kind:</span> ServiceAccount</span><br><span class="line"><span class="attr">  name:</span> ops-admin</span><br><span class="line"><span class="attr">  namespace:</span> default</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> RoleBinding</span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> ops-qa-admin</span><br><span class="line"><span class="attr">  namespace:</span> ops-qa</span><br><span class="line"><span class="attr">roleRef:</span> <span class="comment">#å¼•ç”¨çš„è§’è‰²</span></span><br><span class="line"><span class="attr">  kind:</span> ClusterRole</span><br><span class="line"><span class="attr">  name:</span> admin</span><br><span class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="attr">subjects:</span> <span class="comment">#ä¸»ä½“</span></span><br><span class="line"><span class="attr">- kind:</span> ServiceAccount</span><br><span class="line"><span class="attr">  name:</span> ops-admin</span><br><span class="line"><span class="attr">  namespace:</span> default</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µYAMLçš„æ„æ€ä¸ºï¼šåˆ›å»ºäº†ä¸€ä¸ªops-adminçš„saï¼Œå¹¶ä¸ºè¿™ä¸ªsaèµ‹äºˆäº†ä¸¤ä¸ªå‘½åç©ºé—´(ops-ciã€ops-qa) admin çš„æƒé™ã€‚</p>
<p>å…·ä½“æƒ³äº†è§£æ›´å¤šrbacç›¸å…³çš„è¯´æ˜ï¼Œå¯å‚è€ƒï¼š<a href="https://www.cnblogs.com/wlbl/p/10694364.html" target="_blank" rel="external">https://www.cnblogs.com/wlbl/p/10694364.html</a></p>
<h2 id="ldapè¯´æ˜"><a href="#ldapè¯´æ˜" class="headerlink" title="ldapè¯´æ˜"></a>ldapè¯´æ˜</h2><p>æˆ‘å¸<code>ldap</code>ç›®å½•è§„åˆ™å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|--åŸŸ</span><br><span class="line">|--|---å…¬å¸</span><br><span class="line">|--|----|----åˆ†å…¬å¸</span><br><span class="line">|--|----|-----|----éƒ¨é—¨</span><br><span class="line">|--|----|-----|-----|-----ç”¨æˆ·</span><br></pre></td></tr></table></figure></p>
<p>å¯¹åº”çš„<code>Distinguished Name</code>æ˜¾ç¤ºå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CN=Peng Xu,OU=éƒ¨é—¨,OU=åˆ†å…¬å¸,OU=å…¬å¸,DC=corp,DC=xxx,DC=com</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œæˆ‘ä¼šè·å–ç¬¬ä¸€ä¸ª<code>OU</code>ä½œä¸º<code>group</code>ï¼Œå¦‚æœä½ çš„éœ€æ±‚å’Œæˆ‘ä¸ä¸€æ ·ï¼Œå¯ä»¥ç»™æˆ‘æ issue è¿›è¡Œé€‚é…</p>
<p>ldap è¯¦ç»†è¯´æ˜è¯·å‚è€ƒï¼š<a href="https://blog.poychang.net/ldap-introduction" target="_blank" rel="external">https://blog.poychang.net/ldap-introduction</a></p>
<h2 id="configmap-yaml-é…ç½®è¯´æ˜"><a href="#configmap-yaml-é…ç½®è¯´æ˜" class="headerlink" title="configmap.yaml é…ç½®è¯´æ˜"></a>configmap.yaml é…ç½®è¯´æ˜</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ldap:</span></span><br><span class="line"><span class="attr">  addr:</span> ldap://<span class="number">192.168</span><span class="number">.3</span><span class="number">.81</span>:<span class="number">389</span></span><br><span class="line"><span class="attr">  adminUser:</span> xxxxx</span><br><span class="line"><span class="attr">  adminPwd:</span> xxxxxx</span><br><span class="line"><span class="attr">  baseDN:</span> dc=corp,dc=patsnap,dc=com</span><br><span class="line"><span class="attr">  filter:</span> (&amp;(objectClass=person)(sAMAccountName=%s))</span><br><span class="line"><span class="attr">  attributes:</span> user_dn</span><br><span class="line"><span class="attr">  orgUnitName:</span> OU=</span><br><span class="line"><span class="comment">#å…¨å±€ç”¨æˆ·/ç”¨æˆ·ç»„ä¸SAçš„æ˜ å°„</span></span><br><span class="line"><span class="attr">rbac:</span></span><br><span class="line">  DevOps team:</span><br><span class="line"><span class="attr">    sa:</span> ops-admin</span><br><span class="line"><span class="attr">    ns:</span> kube-system</span><br><span class="line"><span class="attr">  xupeng:</span></span><br><span class="line"><span class="attr">    sa:</span> inno-admin</span><br><span class="line"><span class="attr">    ns:</span> default</span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line">  <span class="comment">#é›†ç¾¤åˆ«åï¼Œåœ¨ç™»å½•ä¸‹æ‹‰æ¡†ä¸­æ˜¾ç¤ºçš„keyï¼Œè¿™ä¸ªåˆ«åéœ€è¦å’Œsecret.shä¸­çš„ca.crtå’Œtokençš„é”®åä¸€ä¸€å¯¹åº”</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line">    <span class="comment">#apiserveråœ°å€ï¼Œèƒ½å¤Ÿè¢«å½“å‰å·¥å…·è®¿é—®åˆ°</span></span><br><span class="line"><span class="attr">    apiServer:</span> apiserver-dev.jiunile.com</span><br><span class="line"><span class="attr">    port:</span> <span class="number">6443</span></span><br><span class="line">    <span class="comment">#kubernetes dashboardåœ°å€ï¼Œèƒ½å¤Ÿè¢«å½“å‰å·¥å…·è®¿é—®åˆ°</span></span><br><span class="line"><span class="attr">    dashboard:</span> dashboard-dev.jiunile.com</span><br><span class="line">    <span class="comment">#é›†ç¾¤è¯´æ˜ï¼Œåœ¨ç™»å½•ä¸‹æ‹‰æ¡†ä¸­æ˜¾ç¤ºçš„åç§°</span></span><br><span class="line"><span class="attr">    desc:</span> Dev Cluster</span><br><span class="line">    <span class="comment">#é’ˆå¯¹å•ç‹¬é›†ç¾¤ç»†åˆ†</span></span><br><span class="line">    <span class="comment">#rbac:</span></span><br><span class="line">    <span class="comment">#  DevOps team:</span></span><br><span class="line">    <span class="comment">#    sa: admin</span></span><br><span class="line">    <span class="comment">#    ns: kube-system</span></span><br><span class="line">    <span class="comment">#  xupeng:</span></span><br><span class="line">    <span class="comment">#    sa: ops-admin</span></span><br><span class="line">    <span class="comment">#    ns: default</span></span><br><span class="line"><span class="attr">  cnrelease:</span></span><br><span class="line"><span class="attr">    apiServer:</span> apiserver-cn-release.jiunile.com</span><br><span class="line"><span class="attr">    port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    dashboard:</span> dashboard-cn-release.jiunile.com</span><br><span class="line"><span class="attr">    desc:</span> CN Release Cluster</span><br><span class="line"><span class="attr">  usrelease:</span></span><br><span class="line"><span class="attr">    apiServer:</span> apiserver-us-release.jiunile.com</span><br><span class="line"><span class="attr">    port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    dashboard:</span> dashboard-us-release.jiunile.com</span><br><span class="line"><span class="attr">    desc:</span> US Release Cluster</span><br><span class="line"><span class="attr">  euprod:</span></span><br><span class="line"><span class="attr">    apiServer:</span> apiserver-eu-prod.jiunile.com</span><br><span class="line"><span class="attr">    port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">    dashboard:</span> dashboard-eu-prod.jiunile.com</span><br><span class="line"><span class="attr">    desc:</span> EU Prod Cluster</span><br></pre></td></tr></table></figure>
<h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><ol>
<li>ä¿®æ”¹å¹¶éƒ¨ç½²<code>deploy/configmap.yaml</code></li>
<li>å°†å„é›†ç¾¤è·å–çš„ <code>ca.crt</code> å’Œ <code>token</code> å†™å…¥åˆ°å¯¹åº”çš„deploy/tokenä¸‹</li>
<li><p>æ‰§è¡Œ deploy ä¸‹çš„ secret.sh è„šæœ¬ <code>sh deploy/secret.sh</code></p>
<blockquote>
<p>æ³¨æ„: secret.sh ä¸­çš„<code>xx_token/xxx_ca.crt</code>ä¸­çš„ <code>xx</code> å¯¹åº”äº<code>configmap.yaml</code> ä¸­çš„<strong>é›†ç¾¤åˆ«åï¼Œå¿…é¡»è¦ä¸€ä¸€å¯¹åº”</strong></p>
</blockquote>
</li>
<li><p>éƒ¨ç½²<code>deploy/deployment.yaml</code></p>
</li>
</ol>
<h2 id="è®¿é—®"><a href="#è®¿é—®" class="headerlink" title="è®¿é—®"></a>è®¿é—®</h2><p><a href="http://{nodeip}:31000" target="_blank" rel="external">http://{nodeip}:31000</a></p>
<p>è§†é¢‘åœ°å€ï¼š<a href="http://www.youtube.com/watch?v=ILiviSLbSq8" target="_blank" rel="external">http://www.youtube.com/watch?v=ILiviSLbSq8</a></p>
<p>gitåœ°å€ï¼š<a href="https://github.com/icyxp/kubernetes-dashboard-ldap" target="_blank" rel="external">https://github.com/icyxp/kubernetes-dashboard-ldap</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è‡ªå®šä¹‰ Kubernetes è°ƒåº¦å™¨]]></title>
      <url>http://team.jiunile.com/blog/2020/06/k8s-custom-scheduler.html</url>
      <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><code>kube-scheduler</code> æ˜¯ kubernetes çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œä¸»è¦è´Ÿè´£æ•´ä¸ªé›†ç¾¤èµ„æºçš„è°ƒåº¦åŠŸèƒ½ï¼Œæ ¹æ®ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œç­–ç•¥ï¼Œå°† Pod è°ƒåº¦åˆ°æœ€ä¼˜çš„å·¥ä½œèŠ‚ç‚¹ä¸Šé¢å»ï¼Œä»è€Œæ›´åŠ åˆç†ã€æ›´åŠ å……åˆ†çš„åˆ©ç”¨é›†ç¾¤çš„èµ„æºï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ kubernetes ä¸€ä¸ªéå¸¸é‡è¦çš„ç†ç”±ã€‚å¦‚æœä¸€é—¨æ–°çš„æŠ€æœ¯ä¸èƒ½å¸®åŠ©ä¼ä¸šèŠ‚çº¦æˆæœ¬ã€æä¾›æ•ˆç‡ï¼Œæˆ‘ç›¸ä¿¡æ˜¯å¾ˆéš¾æ¨è¿›çš„ã€‚</p>
<h2 id="è°ƒåº¦æµç¨‹"><a href="#è°ƒåº¦æµç¨‹" class="headerlink" title="è°ƒåº¦æµç¨‹"></a>è°ƒåº¦æµç¨‹</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>kube-scheduler</code> æä¾›çš„é»˜è®¤è°ƒåº¦å™¨èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬ç»å¤§å¤šæ•°çš„è¦æ±‚ï¼Œæˆ‘ä»¬å‰é¢å’Œå¤§å®¶æ¥è§¦çš„ç¤ºä¾‹ä¹ŸåŸºæœ¬ä¸Šç”¨çš„é»˜è®¤çš„ç­–ç•¥ï¼Œéƒ½å¯ä»¥ä¿è¯æˆ‘ä»¬çš„ Pod å¯ä»¥è¢«åˆ†é…åˆ°èµ„æºå……è¶³çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ä½†æ˜¯åœ¨å®é™…çš„çº¿ä¸Šé¡¹ç›®ä¸­ï¼Œå¯èƒ½æˆ‘ä»¬è‡ªå·±ä¼šæ¯” kubernetes æ›´åŠ äº†è§£æˆ‘ä»¬è‡ªå·±çš„åº”ç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸Œæœ›ä¸€ä¸ª Pod åªèƒ½è¿è¡Œåœ¨ç‰¹å®šçš„å‡ ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…è¿™å‡ ä¸ªèŠ‚ç‚¹åªèƒ½ç”¨æ¥è¿è¡Œç‰¹å®šç±»å‹çš„åº”ç”¨ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬çš„è°ƒåº¦å™¨èƒ½å¤Ÿå¯æ§ã€‚</p>
<p><code>kube-scheduler</code> çš„ä¸»è¦ä½œç”¨å°±æ˜¯æ ¹æ®ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œè°ƒåº¦ç­–ç•¥å°† Pod è°ƒåº¦åˆ°åˆé€‚çš„ Node èŠ‚ç‚¹ä¸Šå»ï¼Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äºŒè¿›åˆ¶ç¨‹åºï¼Œå¯åŠ¨ä¹‹åä¼šä¸€ç›´ç›‘å¬ API Serverï¼Œè·å–åˆ° <code>PodSpec.NodeName</code> ä¸ºç©ºçš„ Podï¼Œå¯¹æ¯ä¸ª Pod éƒ½ä¼šåˆ›å»ºä¸€ä¸ª bindingã€‚<br><img src="/images/k8s/kube-scheduler-overview.png" alt="kube-scheduler-overview"><br><a id="more"></a><br>è¿™ä¸ªè¿‡ç¨‹åœ¨æˆ‘ä»¬çœ‹æ¥å¥½åƒæ¯”è¾ƒç®€å•ï¼Œä½†åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéœ€è¦è€ƒè™‘çš„é—®é¢˜å°±æœ‰å¾ˆå¤šäº†ï¼š</p>
<ul>
<li>å¦‚ä½•ä¿è¯å…¨éƒ¨çš„èŠ‚ç‚¹è°ƒåº¦çš„å…¬å¹³æ€§ï¼Ÿè¦çŸ¥é“å¹¶ä¸æ˜¯æ‰€æœ‰èŠ‚ç‚¹èµ„æºé…ç½®ä¸€å®šéƒ½æ˜¯ä¸€æ ·çš„</li>
<li>å¦‚ä½•ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½è¢«åˆ†é…èµ„æºï¼Ÿ</li>
<li>é›†ç¾¤èµ„æºå¦‚ä½•èƒ½å¤Ÿè¢«é«˜æ•ˆåˆ©ç”¨ï¼Ÿ</li>
<li>é›†ç¾¤èµ„æºå¦‚ä½•æ‰èƒ½è¢«æœ€å¤§åŒ–ä½¿ç”¨ï¼Ÿ</li>
<li>å¦‚ä½•ä¿è¯ Pod è°ƒåº¦çš„æ€§èƒ½å’Œæ•ˆç‡ï¼Ÿ</li>
<li>ç”¨æˆ·æ˜¯å¦å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚å®šåˆ¶è‡ªå·±çš„è°ƒåº¦ç­–ç•¥ï¼Ÿ</li>
</ul>
<p>è€ƒè™‘åˆ°å®é™…ç¯å¢ƒä¸­çš„å„ç§å¤æ‚æƒ…å†µï¼Œkubernetes çš„è°ƒåº¦å™¨é‡‡ç”¨æ’ä»¶åŒ–çš„å½¢å¼å®ç°ï¼Œå¯ä»¥æ–¹ä¾¿ç”¨æˆ·è¿›è¡Œå®šåˆ¶æˆ–è€…äºŒæ¬¡å¼€å‘ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªè°ƒåº¦å™¨å¹¶ä»¥æ’ä»¶å½¢å¼å’Œ kubernetes è¿›è¡Œé›†æˆã€‚</p>
<p>kubernetes è°ƒåº¦å™¨çš„æºç ä½äº <code>kubernetes/pkg/scheduler</code> ä¸­ï¼Œå¤§ä½“çš„ä»£ç ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š(ä¸åŒçš„ç‰ˆæœ¬ç›®å½•ç»“æ„å¯èƒ½ä¸å¤ªä¸€æ ·)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubernetes/pkg/scheduler</span><br><span class="line">-- scheduler.go         //è°ƒåº¦ç›¸å…³çš„å…·ä½“å®ç°</span><br><span class="line">|-- algorithm</span><br><span class="line">|   |-- predicates      //èŠ‚ç‚¹ç­›é€‰ç­–ç•¥</span><br><span class="line">|   |-- priorities      //èŠ‚ç‚¹æ‰“åˆ†ç­–ç•¥</span><br><span class="line">|-- algorithmprovider</span><br><span class="line">|   |-- defaults         //å®šä¹‰é»˜è®¤çš„è°ƒåº¦å™¨</span><br></pre></td></tr></table></figure></p>
<p>å…¶ä¸­ Scheduler åˆ›å»ºå’Œè¿è¡Œçš„æ ¸å¿ƒç¨‹åºï¼Œå¯¹åº”çš„ä»£ç åœ¨ <code>pkg/scheduler/scheduler.go</code>ï¼Œå¦‚æœè¦æŸ¥çœ‹ <code>kube-scheduler</code> çš„å…¥å£ç¨‹åºï¼Œå¯¹åº”çš„ä»£ç åœ¨ <code>cmd/kube-scheduler/scheduler.go</code>ã€‚</p>
<h2 id="è‡ªå®šä¹‰è°ƒåº¦å™¨"><a href="#è‡ªå®šä¹‰è°ƒåº¦å™¨" class="headerlink" title="è‡ªå®šä¹‰è°ƒåº¦å™¨"></a>è‡ªå®šä¹‰è°ƒåº¦å™¨</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æœ‰4ç§æ‰©å±• Kubernetes è°ƒåº¦å™¨çš„æ–¹æ³•ã€‚</p>
<ul>
<li>ä¸€ç§æ–¹æ³•å°±æ˜¯ç›´æ¥ clone å®˜æ–¹çš„ kube-scheduler æºä»£ç ï¼Œåœ¨åˆé€‚çš„ä½ç½®ç›´æ¥ä¿®æ”¹ä»£ç ï¼Œç„¶åé‡æ–°ç¼–è¯‘è¿è¡Œä¿®æ”¹åçš„ç¨‹åºï¼Œå½“ç„¶è¿™ç§æ–¹æ³•æ˜¯æœ€ä¸å»ºè®®ä½¿ç”¨çš„ï¼Œä¹Ÿä¸å®ç”¨ï¼Œå› ä¸ºéœ€è¦èŠ±è´¹å¤§é‡é¢å¤–çš„ç²¾åŠ›æ¥å’Œä¸Šæ¸¸çš„è°ƒåº¦ç¨‹åºæ›´æ”¹ä¿æŒä¸€è‡´ã€‚</li>
<li>ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯å’Œé»˜è®¤çš„è°ƒåº¦ç¨‹åºä¸€èµ·è¿è¡Œç‹¬ç«‹çš„è°ƒåº¦ç¨‹åºï¼Œé»˜è®¤çš„è°ƒåº¦å™¨å’Œæˆ‘ä»¬è‡ªå®šä¹‰çš„è°ƒåº¦å™¨å¯ä»¥é€šè¿‡ Pod çš„ <code>spec.schedulerName</code> æ¥è¦†ç›–å„è‡ªçš„ Podï¼Œé»˜è®¤æ˜¯ä½¿ç”¨ default é»˜è®¤çš„è°ƒåº¦å™¨ï¼Œä½†æ˜¯å¤šä¸ªè°ƒåº¦ç¨‹åºå…±å­˜çš„æƒ…å†µä¸‹ä¹Ÿæ¯”è¾ƒéº»çƒ¦ï¼Œæ¯”å¦‚å½“å¤šä¸ªè°ƒåº¦å™¨å°† Pod è°ƒåº¦åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼Œå› ä¸ºå¾ˆæœ‰å¯èƒ½ä¸¤ä¸ªè°ƒåº¦å™¨éƒ½åŒæ—¶å°†ä¸¤ä¸ª Pod è°ƒåº¦åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šå»ï¼Œä½†æ˜¯å¾ˆæœ‰å¯èƒ½å…¶ä¸­ä¸€ä¸ª Pod è¿è¡Œåå…¶å®èµ„æºå°±æ¶ˆè€—å®Œäº†ï¼Œå¹¶ä¸”ç»´æŠ¤ä¸€ä¸ªé«˜è´¨é‡çš„è‡ªå®šä¹‰è°ƒåº¦ç¨‹åºä¹Ÿä¸æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å…¨é¢äº†è§£é»˜è®¤çš„è°ƒåº¦ç¨‹åºï¼Œæ•´ä½“ Kubernetes çš„æ¶æ„çŸ¥è¯†ä»¥åŠå„ç§ Kubernetes API å¯¹è±¡çš„å„ç§å…³ç³»æˆ–é™åˆ¶ã€‚</li>
<li>ç¬¬ä¸‰ç§æ–¹æ³•æ˜¯<a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/scheduler_extender.md" target="_blank" rel="external">è°ƒåº¦å™¨æ‰©å±•ç¨‹åº</a>ï¼Œè¿™ä¸ªæ–¹æ¡ˆç›®å‰æ˜¯ä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆï¼Œå¯ä»¥å’Œä¸Šæ¸¸è°ƒåº¦ç¨‹åºå…¼å®¹ï¼Œæ‰€è°“çš„è°ƒåº¦å™¨æ‰©å±•ç¨‹åºå…¶å®å°±æ˜¯ä¸€ä¸ªå¯é…ç½®çš„ Webhook è€Œå·²ï¼Œé‡Œé¢åŒ…å« <code>è¿‡æ»¤å™¨</code> å’Œ <code>ä¼˜å…ˆçº§</code> ä¸¤ä¸ªç«¯ç‚¹ï¼Œåˆ†åˆ«å¯¹åº”è°ƒåº¦å‘¨æœŸä¸­çš„ä¸¤ä¸ªä¸»è¦é˜¶æ®µï¼ˆè¿‡æ»¤å’Œæ‰“åˆ†ï¼‰ã€‚</li>
<li>ç¬¬å››ç§æ–¹æ³•æ˜¯é€šè¿‡è°ƒåº¦æ¡†æ¶ï¼ˆScheduling Frameworkï¼‰ï¼ŒKubernetes v1.15 ç‰ˆæœ¬ä¸­å¼•å…¥äº†å¯æ’æ‹”æ¶æ„çš„è°ƒåº¦æ¡†æ¶ï¼Œä½¿å¾—å®šåˆ¶è°ƒåº¦å™¨è¿™ä¸ªä»»åŠ¡å˜å¾—æ›´åŠ çš„å®¹æ˜“ã€‚è°ƒåº“æ¡†æ¶å‘ç°æœ‰çš„è°ƒåº¦å™¨ä¸­æ·»åŠ äº†ä¸€ç»„æ’ä»¶åŒ–çš„ APIï¼Œè¯¥ API åœ¨ä¿æŒè°ƒåº¦ç¨‹åºâ€œæ ¸å¿ƒâ€ç®€å•ä¸”æ˜“äºç»´æŠ¤çš„åŒæ—¶ï¼Œä½¿å¾—å¤§éƒ¨åˆ†çš„è°ƒåº¦åŠŸèƒ½ä»¥æ’ä»¶çš„å½¢å¼å­˜åœ¨ï¼Œè€Œä¸”åœ¨æˆ‘ä»¬ç°åœ¨çš„ v1.16 ç‰ˆæœ¬ä¸­ä¸Šé¢çš„ <code>è°ƒåº¦å™¨æ‰©å±•ç¨‹åº</code> ä¹Ÿå·²ç»è¢«åºŸå¼ƒäº†ï¼Œæ‰€ä»¥ä»¥åè°ƒåº¦æ¡†æ¶æ‰æ˜¯è‡ªå®šä¹‰è°ƒåº¦å™¨çš„æ ¸å¿ƒæ–¹å¼ã€‚</li>
</ul>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç®€å•ä»‹ç»ä¸‹åé¢ä¸¤ç§æ–¹å¼çš„å®ç°ã€‚</p>
<h3 id="è°ƒåº¦å™¨æ‰©å±•ç¨‹åº"><a href="#è°ƒåº¦å™¨æ‰©å±•ç¨‹åº" class="headerlink" title="è°ƒåº¦å™¨æ‰©å±•ç¨‹åº"></a>è°ƒåº¦å™¨æ‰©å±•ç¨‹åº</h3><p>åœ¨è¿›å…¥è°ƒåº¦å™¨æ‰©å±•ç¨‹åºä¹‹å‰ï¼Œæˆ‘ä»¬å†æ¥äº†è§£ä¸‹ Kubernetes è°ƒåº¦ç¨‹åºæ˜¯å¦‚ä½•å·¥ä½œçš„:</p>
<ol>
<li>é»˜è®¤è°ƒåº¦å™¨æ ¹æ®æŒ‡å®šçš„å‚æ•°å¯åŠ¨ï¼ˆæˆ‘ä»¬ä½¿ç”¨ kubeadm æ­å»ºçš„é›†ç¾¤ï¼Œå¯åŠ¨é…ç½®æ–‡ä»¶ä½äº <code>/etc/kubernetes/manifests/kube-schdueler.yaml</code>ï¼‰</li>
<li>watch apiserverï¼Œå°† <code>spec.nodeName</code> ä¸ºç©ºçš„ Pod æ”¾å…¥è°ƒåº¦å™¨å†…éƒ¨çš„è°ƒåº¦é˜Ÿåˆ—ä¸­</li>
<li>ä»è°ƒåº¦é˜Ÿåˆ—ä¸­ Pop å‡ºä¸€ä¸ª Podï¼Œå¼€å§‹ä¸€ä¸ªæ ‡å‡†çš„è°ƒåº¦å‘¨æœŸ</li>
<li>ä» Pod å±æ€§ä¸­æ£€ç´¢â€œç¡¬æ€§è¦æ±‚â€ï¼ˆæ¯”å¦‚ CPU/å†…å­˜è¯·æ±‚å€¼ï¼ŒnodeSelector/nodeAffinityï¼‰ï¼Œç„¶åè¿‡æ»¤é˜¶æ®µå‘ç”Ÿï¼Œåœ¨è¯¥é˜¶æ®µè®¡ç®—å‡ºæ»¡è¶³è¦æ±‚çš„èŠ‚ç‚¹å€™é€‰åˆ—è¡¨</li>
<li>ä» Pod å±æ€§ä¸­æ£€ç´¢â€œè½¯éœ€æ±‚â€ï¼Œå¹¶åº”ç”¨ä¸€äº›é»˜è®¤çš„â€œè½¯ç­–ç•¥â€ï¼ˆæ¯”å¦‚ Pod å€¾å‘äºåœ¨èŠ‚ç‚¹ä¸Šæ›´åŠ èšæ‹¢æˆ–åˆ†æ•£ï¼‰ï¼Œæœ€åï¼Œå®ƒä¸ºæ¯ä¸ªå€™é€‰èŠ‚ç‚¹ç»™å‡ºä¸€ä¸ªåˆ†æ•°ï¼Œå¹¶æŒ‘é€‰å‡ºå¾—åˆ†æœ€é«˜çš„æœ€ç»ˆè·èƒœè€…</li>
<li>å’Œ apiserver é€šä¿¡ï¼ˆå‘é€ç»‘å®šè°ƒç”¨ï¼‰ï¼Œç„¶åè®¾ç½® Pod çš„ <code>spec.nodeName</code> å±æ€§ä»¥è¡¨ç¤ºå°†è¯¥ Pod è°ƒåº¦åˆ°çš„èŠ‚ç‚¹ã€‚</li>
</ol>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a>ï¼Œå¯ä»¥é€šè¿‡ <code>--config</code> å‚æ•°æŒ‡å®šè°ƒåº¦å™¨å°†ä½¿ç”¨å“ªäº›å‚æ•°ï¼Œè¯¥é…ç½®æ–‡ä»¶åº”è¯¥åŒ…å«ä¸€ä¸ª <a href="https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#KubeSchedulerConfiguration" target="_blank" rel="external">KubeSchedulerConfiguration</a> å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºæ ¼å¼ï¼šï¼ˆ/etc/kubernetes/scheduler-extender.yaml)<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># é€šè¿‡"--config" ä¼ é€’æ–‡ä»¶å†…å®¹</span></span><br><span class="line"><span class="attr">apiVersion:</span> kubescheduler.config.k8s.io/v1alpha1</span><br><span class="line"><span class="attr">kind:</span> KubeSchedulerConfiguration</span><br><span class="line"><span class="attr">clientConnection:</span></span><br><span class="line"><span class="attr">  kubeconfig:</span> <span class="string">"/etc/kubernetes/scheduler.conf"</span></span><br><span class="line"><span class="attr">algorithmSource:</span></span><br><span class="line"><span class="attr">  policy:</span></span><br><span class="line"><span class="attr">    file:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">"/etc/kubernetes/scheduler-extender-policy.yaml"</span>  <span class="comment"># æŒ‡å®šè‡ªå®šä¹‰è°ƒåº¦ç­–ç•¥æ–‡ä»¶</span></span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬åœ¨è¿™é‡Œåº”è¯¥è¾“å…¥çš„å…³é”®å‚æ•°æ˜¯ <code>algorithmSource.policy</code>ï¼Œè¿™ä¸ªç­–ç•¥æ–‡ä»¶å¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ä¹Ÿå¯ä»¥æ˜¯ ConfigMap èµ„æºå¯¹è±¡ï¼Œè¿™å–å†³äºè°ƒåº¦ç¨‹åºçš„éƒ¨ç½²æ–¹å¼ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œé»˜è®¤çš„è°ƒåº¦å™¨æ˜¯é™æ€ Pod æ–¹å¼å¯åŠ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨æœ¬åœ°æ–‡ä»¶çš„å½¢å¼æ¥é…ç½®ã€‚</p>
<p>è¯¥ç­–ç•¥æ–‡ä»¶ <code>/etc/kubernetes/scheduler-extender-policy.yaml</code> åº”è¯¥éµå¾ª <a href="https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#Policy" target="_blank" rel="external">kubernetes/pkg/scheduler/apis/config/legacy_types.go#L28</a> çš„è¦æ±‚ï¼Œåœ¨æˆ‘ä»¬è¿™é‡Œçš„ v1.16.2 ç‰ˆæœ¬ä¸­å·²ç»æ”¯æŒ JSON å’Œ YAML ä¸¤ç§æ ¼å¼çš„ç­–ç•¥æ–‡ä»¶ï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬å®šä¹‰çš„ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå¯ä»¥æŸ¥çœ‹ <a href="https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#Extender" target="_blank" rel="external">Extender</a> æè¿°äº†è§£ç­–ç•¥æ–‡ä»¶çš„å®šä¹‰è§„èŒƒï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Policy</span><br><span class="line"><span class="attr">extenders:</span></span><br><span class="line"><span class="attr">- urlPrefix:</span> <span class="string">"http://127.0.0.1:8888/"</span></span><br><span class="line"><span class="attr">  filterVerb:</span> <span class="string">"filter"</span></span><br><span class="line"><span class="attr">  prioritizeVerb:</span> <span class="string">"prioritize"</span></span><br><span class="line"><span class="attr">  weight:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  enableHttps:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬è¿™é‡Œçš„ Policy ç­–ç•¥æ–‡ä»¶æ˜¯é€šè¿‡å®šä¹‰ <code>extenders</code> æ¥æ‰©å±•è°ƒåº¦å™¨çš„ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¸éœ€è¦å»ç¼–å†™ä»£ç ï¼Œå¯ä»¥ç›´æ¥åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­é€šè¿‡æŒ‡å®š <code>predicates</code> å’Œ <code>priorities</code> æ¥è¿›è¡Œè‡ªå®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šåˆ™ä¼šä½¿ç”¨é»˜è®¤çš„ <code>DefaultProvier</code>ï¼š<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"kind"</span>: <span class="string">"Policy"</span>,</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"v1"</span>,</span><br><span class="line">    <span class="attr">"predicates"</span>: [&#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"MatchNodeSelector"</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"PodFitsResources"</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"PodFitsHostPorts"</span></span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"HostName"</span></span><br><span class="line">    &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"priorities"</span>: [&#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"EqualPriority"</span>,</span><br><span class="line">        <span class="attr">"weight"</span>: <span class="number">2</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"ImageLocalityPriority"</span>,</span><br><span class="line">        <span class="attr">"weight"</span>: <span class="number">4</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"LeastRequestedPriority"</span>,</span><br><span class="line">        <span class="attr">"weight"</span>: <span class="number">2</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"BalancedResourceAllocation"</span>,</span><br><span class="line">        <span class="attr">"weight"</span>: <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"extenders"</span>: [&#123;</span><br><span class="line">        <span class="attr">"urlPrefix"</span>: <span class="string">"/prefix"</span>,</span><br><span class="line">        <span class="attr">"filterVerb"</span>: <span class="string">"filter"</span>,</span><br><span class="line">        <span class="attr">"prioritizeVerb"</span>: <span class="string">"prioritize"</span>,</span><br><span class="line">        <span class="attr">"weight"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"bindVerb"</span>: <span class="string">"bind"</span>,</span><br><span class="line">        <span class="attr">"enableHttps"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ”¹ç­–ç•¥æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ª HTTP çš„æ‰©å±•ç¨‹åºæœåŠ¡ï¼Œè¯¥æœåŠ¡è¿è¡Œåœ¨ <code>127.0.0.1:8888</code> ä¸‹é¢ï¼Œå¹¶ä¸”å·²ç»å°†è¯¥ç­–ç•¥æ³¨å†Œåˆ°äº†é»˜è®¤çš„è°ƒåº¦å™¨ä¸­ï¼Œè¿™æ ·åœ¨è¿‡æ»¤å’Œæ‰“åˆ†é˜¶æ®µç»“æŸåï¼Œå¯ä»¥å°†ç»“æœåˆ†åˆ«ä¼ é€’ç»™è¯¥æ‰©å±•ç¨‹åºçš„ç«¯ç‚¹ <code>&lt;urlPrefix&gt;/&lt;filterVerb&gt;</code> å’Œ <code>&lt;urlPrefix&gt;/&lt;prioritizeVerb&gt;</code>ï¼Œåœ¨æ‰©å±•ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥è¿‡æ»¤å¹¶ç¡®å®šä¼˜å…ˆçº§ï¼Œä»¥é€‚åº”æˆ‘ä»¬çš„ç‰¹å®šä¸šåŠ¡éœ€æ±‚ã€‚</p>
<h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><p>æˆ‘ä»¬ç›´æ¥ç”¨ golang æ¥å®ç°ä¸€ä¸ªç®€å•çš„è°ƒåº¦å™¨æ‰©å±•ç¨‹åºï¼Œå½“ç„¶ä½ å¯ä»¥ä½¿ç”¨å…¶ä»–ä»»ä½•ç¼–ç¨‹è¯­è¨€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    router := httprouter.New()</span><br><span class="line">    router.GET(<span class="string">"/"</span>, Index)</span><br><span class="line">    router.POST(<span class="string">"/filter"</span>, Filter)</span><br><span class="line">    router.POST(<span class="string">"/prioritize"</span>, Prioritize)</span><br><span class="line"></span><br><span class="line">    log.Fatal(http.ListenAndServe(<span class="string">":8888"</span>, router))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç° <code>/filter</code> å’Œ <code>/prioritize</code> ä¸¤ä¸ªç«¯ç‚¹çš„å¤„ç†ç¨‹åºã€‚</p>
<p>å…¶ä¸­ <code>Filter</code> è¿™ä¸ªæ‰©å±•å‡½æ•°æ¥æ”¶ä¸€ä¸ªè¾“å…¥ç±»å‹ä¸º <code>schedulerapi.ExtenderArgs</code> çš„å‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªç±»å‹ä¸º <code>*schedulerapi.ExtenderFilterResult</code> çš„å€¼ã€‚åœ¨å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥è¿‡æ»¤è¾“å…¥çš„èŠ‚ç‚¹ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// filter æ ¹æ®æ‰©å±•ç¨‹åºå®šä¹‰çš„é¢„é€‰è§„åˆ™æ¥è¿‡æ»¤èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">filter</span><span class="params">(args schedulerapi.ExtenderArgs)</span> *<span class="title">schedulerapi</span>.<span class="title">ExtenderFilterResult</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> filteredNodes []v1.Node</span><br><span class="line">	failedNodes := <span class="built_in">make</span>(schedulerapi.FailedNodesMap)</span><br><span class="line">	pod := args.Pod</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, node := <span class="keyword">range</span> args.Nodes.Items &#123;</span><br><span class="line">		fits, failReasons, _ := podFitsOnNode(pod, node)</span><br><span class="line">		<span class="keyword">if</span> fits &#123;</span><br><span class="line">			filteredNodes = <span class="built_in">append</span>(filteredNodes, node)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			failedNodes[node.Name] = strings.Join(failReasons, <span class="string">","</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	result := schedulerapi.ExtenderFilterResult&#123;</span><br><span class="line">		Nodes: &amp;v1.NodeList&#123;</span><br><span class="line">			Items: filteredNodes,</span><br><span class="line">		&#125;,</span><br><span class="line">		FailedNodes: failedNodes,</span><br><span class="line">		Error:       <span class="string">""</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨è¿‡æ»¤å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¾ªç¯æ¯ä¸ªèŠ‚ç‚¹ç„¶åç”¨æˆ‘ä»¬è‡ªå·±å®ç°çš„ä¸šåŠ¡é€»è¾‘æ¥åˆ¤æ–­æ˜¯å¦åº”è¯¥æ‰¹å‡†è¯¥èŠ‚ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬å®ç°æ¯”è¾ƒç®€å•ï¼Œåœ¨ <code>podFitsOnNode()</code> å‡½æ•°ä¸­æˆ‘ä»¬åªæ˜¯ç®€å•çš„æ£€æŸ¥éšæœºæ•°æ˜¯å¦ä¸ºå¶æ•°æ¥åˆ¤æ–­å³å¯ï¼Œå¦‚æœæ˜¯çš„è¯æˆ‘ä»¬å°±è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå¹¸è¿çš„èŠ‚ç‚¹ï¼Œå¦åˆ™æ‹’ç»æ‰¹å‡†è¯¥èŠ‚ç‚¹ã€‚<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> predicatesSorted = []<span class="keyword">string</span>&#123;LuckyPred&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> predicatesFuncs = <span class="keyword">map</span>[<span class="keyword">string</span>]FitPredicate&#123;</span><br><span class="line">    LuckyPred: LuckyPredicate,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> FitPredicate <span class="function"><span class="keyword">func</span><span class="params">(pod *v1.Pod, node v1.Node)</span> <span class="params">(<span class="keyword">bool</span>, []<span class="keyword">string</span>, error)</span></span><br><span class="line"></span><br><span class="line"><span class="title">func</span> <span class="title">podFitsOnNode</span><span class="params">(pod *v1.Pod, node v1.Node)</span> <span class="params">(<span class="keyword">bool</span>, []<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">    fits := <span class="literal">true</span></span><br><span class="line">    <span class="keyword">var</span> failReasons []<span class="keyword">string</span></span><br><span class="line">    <span class="keyword">for</span> _, predicateKey := <span class="keyword">range</span> predicatesSorted &#123;</span><br><span class="line">        fit, failures, err := predicatesFuncs[predicateKey](pod, node)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">        fits = fits &amp;&amp; fit</span><br><span class="line">        failReasons = <span class="built_in">append</span>(failReasons, failures...)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fits, failReasons, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LuckyPredicate</span><span class="params">(pod *v1.Pod, node v1.Node)</span> <span class="params">(<span class="keyword">bool</span>, []<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">    lucky := rand.Intn(<span class="number">2</span>) == <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> lucky &#123;</span><br><span class="line">        log.Printf(<span class="string">"pod %v/%v is lucky to fit on node %v\n"</span>, pod.Name, pod.Namespace, node.Name)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    log.Printf(<span class="string">"pod %v/%v is unlucky to fit on node %v\n"</span>, pod.Name, pod.Namespace, node.Name)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>, []<span class="keyword">string</span>&#123;LuckyPredFailMsg&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åŒæ ·çš„æ‰“åˆ†åŠŸèƒ½ç”¨åŒæ ·çš„æ–¹å¼æ¥å®ç°ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéšæœºç»™å‡ºä¸€ä¸ªåˆ†æ•°ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// it's webhooked to pkg/scheduler/core/generic_scheduler.go#PrioritizeNodes()</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªå‡½æ•°è¾“å‡ºçš„åˆ†æ•°ä¼šè¢«æ·»åŠ ä¼šé»˜è®¤çš„è°ƒåº¦å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prioritize</span><span class="params">(args schedulerapi.ExtenderArgs)</span> *<span class="title">schedulerapi</span>.<span class="title">HostPriorityList</span></span> &#123;</span><br><span class="line">	pod := args.Pod</span><br><span class="line">	nodes := args.Nodes.Items</span><br><span class="line"></span><br><span class="line">	hostPriorityList := <span class="built_in">make</span>(schedulerapi.HostPriorityList, <span class="built_in">len</span>(nodes))</span><br><span class="line">	<span class="keyword">for</span> i, node := <span class="keyword">range</span> nodes &#123;</span><br><span class="line">		score := rand.Intn(schedulerapi.MaxPriority + <span class="number">1</span>)  <span class="comment">// åœ¨æœ€å¤§ä¼˜å…ˆçº§å†…éšæœºå–ä¸€ä¸ªå€¼</span></span><br><span class="line">		log.Printf(luckyPrioMsg, pod.Name, pod.Namespace, score)</span><br><span class="line">		hostPriorityList[i] = schedulerapi.HostPriority&#123;</span><br><span class="line">			Host:  node.Name,</span><br><span class="line">			Score: score,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;hostPriorityList</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥ç¼–è¯‘æ‰“åŒ…æˆ‘ä»¬çš„åº”ç”¨ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ GOOS=linux GOARCH=amd64 go build -o app</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>æœ¬èŠ‚è°ƒåº¦å™¨æ‰©å±•ç¨‹åºå®Œæ•´çš„ä»£ç è·å–åœ°å€ï¼š<a href="https://github.com/icyxp/sample-scheduler-extender" target="_blank" rel="external">https://github.com/icyxp/sample-scheduler-extender</a>ã€‚</p>
</blockquote>
<p>æ„å»ºå®Œæˆåï¼Œå°†åº”ç”¨ <code>app</code> æ‹·è´åˆ° <code>kube-scheduler</code> æ‰€åœ¨çš„èŠ‚ç‚¹ç›´æ¥è¿è¡Œå³å¯ã€‚ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥å°†ä¸Šé¢çš„ç­–ç•¥æ–‡ä»¶é…ç½®åˆ° <code>kube-scheduler</code> ç»„ä»¶ä¸­å»äº†ï¼Œæˆ‘ä»¬è¿™é‡Œé›†ç¾¤æ˜¯ kubeadm æ­å»ºçš„ï¼Œæ‰€ä»¥ç›´æ¥ä¿®æ”¹æ–‡ä»¶ <code>/etc/kubernetes/manifests/kube-schduler.yaml</code> æ–‡ä»¶å³å¯ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Pod</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    component:</span> kube-scheduler</span><br><span class="line"><span class="attr">    tier:</span> control-plane</span><br><span class="line"><span class="attr">  name:</span> kube-scheduler</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - command:</span></span><br><span class="line"><span class="bullet">    -</span> kube-scheduler</span><br><span class="line"><span class="bullet">    -</span> --authentication-kubeconfig=/etc/kubernetes/scheduler.conf</span><br><span class="line"><span class="bullet">    -</span> --authorization-kubeconfig=/etc/kubernetes/scheduler.conf</span><br><span class="line"><span class="bullet">    -</span> --bind-address=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="bullet">    -</span> --kubeconfig=/etc/kubernetes/scheduler.conf</span><br><span class="line"><span class="bullet">    -</span> --leader-elect=<span class="literal">true</span></span><br><span class="line"><span class="bullet">    -</span> --config=/etc/kubernetes/scheduler-extender.yaml</span><br><span class="line"><span class="bullet">    -</span> --v=<span class="number">9</span></span><br><span class="line"><span class="attr">    image:</span> gcr.azk8s.cn/google_containers/kube-scheduler:v1<span class="number">.16</span><span class="number">.2</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="attr">    livenessProbe:</span></span><br><span class="line"><span class="attr">      failureThreshold:</span> <span class="number">8</span></span><br><span class="line"><span class="attr">      httpGet:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">        path:</span> /healthz</span><br><span class="line"><span class="attr">        port:</span> <span class="number">10251</span></span><br><span class="line"><span class="attr">        scheme:</span> HTTP</span><br><span class="line"><span class="attr">      initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">      timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">    name:</span> kube-scheduler</span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">100</span>m</span><br><span class="line"><span class="attr">    volumeMounts:</span></span><br><span class="line"><span class="attr">    - mountPath:</span> /etc/kubernetes/scheduler.conf</span><br><span class="line"><span class="attr">      name:</span> kubeconfig</span><br><span class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    - mountPath:</span> /etc/kubernetes/scheduler-extender.yaml</span><br><span class="line"><span class="attr">      name:</span> extender</span><br><span class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    - mountPath:</span> /etc/kubernetes/scheduler-extender-policy.yaml</span><br><span class="line"><span class="attr">      name:</span> extender-policy</span><br><span class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  priorityClassName:</span> system-cluster-critical</span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">  - hostPath:</span></span><br><span class="line"><span class="attr">      path:</span> /etc/kubernetes/scheduler.conf</span><br><span class="line"><span class="attr">      type:</span> FileOrCreate</span><br><span class="line"><span class="attr">    name:</span> kubeconfig</span><br><span class="line"><span class="attr">  - hostPath:</span></span><br><span class="line"><span class="attr">      path:</span> /etc/kubernetes/scheduler-extender.yaml</span><br><span class="line"><span class="attr">      type:</span> FileOrCreate</span><br><span class="line"><span class="attr">    name:</span> extender</span><br><span class="line"><span class="attr">  - hostPath:</span></span><br><span class="line"><span class="attr">      path:</span> /etc/kubernetes/scheduler-extender-policy.yaml</span><br><span class="line"><span class="attr">      type:</span> FileOrCreate</span><br><span class="line"><span class="attr">    name:</span> extender-policy</span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>å½“ç„¶æˆ‘ä»¬è¿™ä¸ªåœ°æ–¹æ˜¯ç›´æ¥åœ¨ç³»ç»Ÿé»˜è®¤çš„ <code>kube-scheduler</code> ä¸Šé¢é…ç½®çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¤åˆ¶ä¸€ä¸ªè°ƒåº¦å™¨çš„ YAML æ–‡ä»¶ç„¶åæ›´æ”¹ä¸‹ schedulerName æ¥éƒ¨ç½²ï¼Œè¿™æ ·å°±ä¸ä¼šå½±å“é»˜è®¤çš„è°ƒåº¦å™¨äº†ï¼Œç„¶ååœ¨éœ€è¦ä½¿ç”¨è¿™ä¸ªæµ‹è¯•çš„è°ƒåº¦å™¨çš„ Pod ä¸Šé¢æŒ‡å®š <code>spec.schedulerName</code> å³å¯ã€‚å¯¹äºå¤šè°ƒåº¦å™¨çš„ä½¿ç”¨å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ <a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/configure-multiple-schedulers/" target="_blank" rel="external">é…ç½®å¤šä¸ªè°ƒåº¦å™¨</a>ã€‚</p>
</blockquote>
<p><code>kube-scheduler</code> é‡æ–°é…ç½®åå¯ä»¥æŸ¥çœ‹æ—¥å¿—æ¥éªŒè¯æ˜¯å¦é‡å¯æˆåŠŸï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸€å®šéœ€è¦å°† <code>/etc/kubernetes/scheduler-extender.yaml</code> å’Œ <code>/etc/kubernetes/scheduler-extender-policy.yaml</code> ä¸¤ä¸ªæ–‡ä»¶æŒ‚è½½åˆ° Pod ä¸­å»ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs <span class="_">-f</span> kube-scheduler-ydzs-master -n kube-system</span><br><span class="line">I0102 15:17:38.824657       1 serving.go:319] Generated self-signed cert <span class="keyword">in</span>-memory</span><br><span class="line">I0102 15:17:39.472276       1 server.go:143] Version: v1.16.2</span><br><span class="line">I0102 15:17:39.472674       1 defaults.go:91] TaintNodesByCondition is enabled, PodToleratesNodeTaints predicate is mandatory</span><br><span class="line">W0102 15:17:39.479704       1 authorization.go:47] Authorization is disabled</span><br><span class="line">W0102 15:17:39.479733       1 authentication.go:79] Authentication is disabled</span><br><span class="line">I0102 15:17:39.479777       1 deprecated_insecure_serving.go:51] Serving healthz insecurely on [::]:10251</span><br><span class="line">I0102 15:17:39.480559       1 secure_serving.go:123] Serving securely on 127.0.0.1:10259</span><br><span class="line">I0102 15:17:39.682180       1 leaderelection.go:241] attempting to acquire leader lease  kube-system/kube-scheduler...</span><br><span class="line">I0102 15:17:56.500505       1 leaderelection.go:251] successfully acquired lease kube-system/kube-scheduler</span><br></pre></td></tr></table></figure></p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±åˆ›å»ºå¹¶é…ç½®äº†ä¸€ä¸ªéå¸¸ç®€å•çš„è°ƒåº¦æ‰©å±•ç¨‹åºï¼Œç°åœ¨æˆ‘ä»¬æ¥è¿è¡Œä¸€ä¸ª Deployment æŸ¥çœ‹å…¶å·¥ä½œåŸç†ï¼Œæˆ‘ä»¬å‡†å¤‡ä¸€ä¸ªåŒ…å«20ä¸ªå‰¯æœ¬çš„éƒ¨ç½² Yamlï¼š(test-scheduler.yaml)<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> apps/v1</span><br><span class="line"><span class="attr">kind:</span> Deployment</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> pause</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> pause</span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> pause</span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> pause</span><br><span class="line"><span class="attr">        image:</span> gcr.azk8s.cn/google_containers/pause:<span class="number">3.1</span></span><br></pre></td></tr></table></figure></p>
<p>ç›´æ¥åˆ›å»ºä¸Šé¢çš„èµ„æºå¯¹è±¡ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kuectl apply <span class="_">-f</span> <span class="built_in">test</span>-scheduler.yaml</span><br><span class="line">deployment.apps/pause created</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å»æŸ¥çœ‹ä¸‹æˆ‘ä»¬ç¼–å†™çš„è°ƒåº¦å™¨æ‰©å±•ç¨‹åºæ—¥å¿—ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ./app</span><br><span class="line">......</span><br><span class="line">2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is unlucky to fit on node ydzs-node1</span><br><span class="line">2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is lucky to get score 7</span><br><span class="line">2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is lucky to get score 9</span><br><span class="line">2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is unlucky to fit on node ydzs-node3</span><br><span class="line">2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is unlucky to fit on node ydzs-node4</span><br><span class="line">2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to fit on node ydzs-node1</span><br><span class="line">2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to fit on node ydzs-node2</span><br><span class="line">2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to get score 4</span><br><span class="line">2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to get score 8</span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Pod è°ƒåº¦çš„è¿‡ç¨‹ï¼Œå¦å¤–é»˜è®¤è°ƒåº¦ç¨‹åºä¼šå®šæœŸé‡è¯•å¤±è´¥çš„ Podï¼Œå› æ­¤å®ƒä»¬å°†ä¸€æ¬¡åˆä¸€æ¬¡åœ°é‡æ–°ä¼ é€’åˆ°æˆ‘ä»¬çš„è°ƒåº¦æ‰©å±•ç¨‹åºä¸Šï¼Œæˆ‘ä»¬çš„é€»è¾‘æ˜¯æ£€æŸ¥éšæœºæ•°æ˜¯å¦ä¸ºå¶æ•°ï¼Œæ‰€ä»¥æœ€ç»ˆæ‰€æœ‰ Pod éƒ½å°†å¤„äºè¿è¡ŒçŠ¶æ€ã€‚</p>
<p>è°ƒåº¦å™¨æ‰©å±•ç¨‹åºå¯èƒ½æ˜¯åœ¨ä¸€äº›æƒ…å†µä¸‹å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†æ˜¯ä»–ä»ç„¶æœ‰ä¸€äº›é™åˆ¶å’Œç¼ºç‚¹ï¼š</p>
<ul>
<li>é€šä¿¡æˆæœ¬ï¼šæ•°æ®åœ¨é»˜è®¤è°ƒåº¦ç¨‹åºå’Œè°ƒåº¦å™¨æ‰©å±•ç¨‹åºä¹‹é—´ä»¥ <code>httpï¼ˆsï¼‰</code> ä¼ è¾“ï¼Œåœ¨æ‰§è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ—¶å€™æœ‰ä¸€å®šæˆæœ¬</li>
<li>æœ‰é™çš„æ‰©å±•ç‚¹ï¼šæ‰©å±•ç¨‹åºåªèƒ½åœ¨æŸäº›é˜¶æ®µçš„æœ«å°¾å‚ä¸ï¼Œä¾‹å¦‚ <code>â€œFilterâ€</code> å’Œ <code>â€œPrioritizeâ€</code> ï¼Œå®ƒä»¬ä¸èƒ½åœ¨ä»»ä½•é˜¶æ®µçš„å¼€å§‹æˆ–ä¸­é—´è¢«è°ƒç”¨</li>
<li>å‡æ³•ä¼˜äºåŠ æ³•ï¼šä¸é»˜è®¤è°ƒåº¦ç¨‹åºä¼ é€’çš„èŠ‚ç‚¹å€™é€‰åˆ—è¡¨ç›¸æ¯”ï¼Œæˆ‘ä»¬å¯èƒ½æœ‰ä¸€äº›éœ€æ±‚éœ€è¦æ·»åŠ æ–°çš„å€™é€‰èŠ‚ç‚¹åˆ—è¡¨ï¼Œä½†è¿™æ˜¯æ¯”è¾ƒå†’é™©çš„æ“ä½œï¼Œå› ä¸ºä¸èƒ½ä¿è¯æ–°èŠ‚ç‚¹å¯ä»¥é€šè¿‡å…¶ä»–è¦æ±‚ï¼Œæ‰€ä»¥ï¼Œè°ƒåº¦å™¨æ‰©å±•ç¨‹åºæœ€å¥½æ‰§è¡Œ <code>â€œå‡æ³•â€</code>ï¼ˆè¿›ä¸€æ­¥è¿‡æ»¤ï¼‰ï¼Œè€Œä¸æ˜¯ <code>â€œåŠ æ³•â€</code>ï¼ˆæ·»åŠ èŠ‚ç‚¹ï¼‰</li>
<li>ç¼“å­˜å…±äº«ï¼šä¸Šé¢åªæ˜¯ä¸€ä¸ªç®€å•çš„æµ‹è¯•ç¤ºä¾‹ï¼Œä½†åœ¨çœŸå®çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬æ˜¯éœ€è¦é€šè¿‡æŸ¥çœ‹æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€æ¥åšå‡ºè°ƒåº¦å†³ç­–çš„ï¼Œé»˜è®¤è°ƒåº¦ç¨‹åºå¯ä»¥å¾ˆå¥½åœ°è°ƒåº¦å†³ç­–ï¼Œä½†æ˜¯æ— æ³•å…±äº«å…¶ç¼“å­˜ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¿…é¡»æ„å»ºå’Œç»´æŠ¤è‡ªå·±çš„ç¼“å­˜</li>
</ul>
<p>ç”±äºè¿™äº›å±€é™æ€§ï¼ŒKubernetes è°ƒåº¦å°ç»„å°±æå‡ºäº†ä¸Šé¢ç¬¬å››ç§æ–¹æ³•æ¥è¿›è¡Œæ›´å¥½çš„æ‰©å±•ï¼Œä¹Ÿå°±æ˜¯<code>è°ƒåº¦æ¡†æ¶ï¼ˆScheduler Frameworkï¼‰</code>ï¼Œå®ƒåŸºæœ¬ä¸Šå¯ä»¥è§£å†³æˆ‘ä»¬é‡åˆ°çš„æ‰€æœ‰éš¾é¢˜ï¼Œç°åœ¨ä¹Ÿå·²ç»æˆå®˜æ–¹æ¨èçš„æ‰©å±•æ–¹å¼ï¼Œæ‰€ä»¥è¿™å°†æ˜¯ä»¥åæ‰©å±•è°ƒåº¦å™¨çš„æœ€ä¸»æµçš„æ–¹å¼ã€‚</p>
<h2 id="è°ƒåº¦æ¡†æ¶"><a href="#è°ƒåº¦æ¡†æ¶" class="headerlink" title="è°ƒåº¦æ¡†æ¶"></a>è°ƒåº¦æ¡†æ¶</h2><p>è°ƒåº¦æ¡†æ¶å®šä¹‰äº†ä¸€ç»„æ‰©å±•ç‚¹ï¼Œç”¨æˆ·å¯ä»¥å®ç°æ‰©å±•ç‚¹å®šä¹‰çš„æ¥å£æ¥å®šä¹‰è‡ªå·±çš„è°ƒåº¦é€»è¾‘ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºæ‰©å±•ï¼‰ï¼Œå¹¶å°†æ‰©å±•æ³¨å†Œåˆ°æ‰©å±•ç‚¹ä¸Šï¼Œè°ƒåº¦æ¡†æ¶åœ¨æ‰§è¡Œè°ƒåº¦å·¥ä½œæµæ—¶ï¼Œé‡åˆ°å¯¹åº”çš„æ‰©å±•ç‚¹æ—¶ï¼Œå°†è°ƒç”¨ç”¨æˆ·æ³¨å†Œçš„æ‰©å±•ã€‚è°ƒåº¦æ¡†æ¶åœ¨é¢„ç•™æ‰©å±•ç‚¹æ—¶ï¼Œéƒ½æ˜¯æœ‰ç‰¹å®šçš„ç›®çš„ï¼Œæœ‰äº›æ‰©å±•ç‚¹ä¸Šçš„æ‰©å±•å¯ä»¥æ”¹å˜è°ƒåº¦ç¨‹åºçš„å†³ç­–æ–¹æ³•ï¼Œæœ‰äº›æ‰©å±•ç‚¹ä¸Šçš„æ‰©å±•åªæ˜¯å‘é€ä¸€ä¸ªé€šçŸ¥ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“æ¯å½“è°ƒåº¦ä¸€ä¸ª Pod æ—¶ï¼Œéƒ½ä¼šæŒ‰ç…§ä¸¤ä¸ªè¿‡ç¨‹æ¥æ‰§è¡Œï¼šè°ƒåº¦è¿‡ç¨‹å’Œç»‘å®šè¿‡ç¨‹ã€‚</p>
<p>è°ƒåº¦è¿‡ç¨‹ä¸º Pod é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„èŠ‚ç‚¹ï¼Œç»‘å®šè¿‡ç¨‹åˆ™å°†è°ƒåº¦è¿‡ç¨‹çš„å†³ç­–åº”ç”¨åˆ°é›†ç¾¤ä¸­ï¼ˆä¹Ÿå°±æ˜¯åœ¨è¢«é€‰å®šçš„èŠ‚ç‚¹ä¸Šè¿è¡Œ Podï¼‰ï¼Œå°†è°ƒåº¦è¿‡ç¨‹å’Œç»‘å®šè¿‡ç¨‹åˆåœ¨ä¸€èµ·ï¼Œç§°ä¹‹ä¸ºè°ƒåº¦ä¸Šä¸‹æ–‡ï¼ˆ<strong>scheduling context</strong>ï¼‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è°ƒåº¦è¿‡ç¨‹æ˜¯<code>åŒæ­¥</code>è¿è¡Œçš„ï¼ˆåŒä¸€æ—¶é—´ç‚¹åªä¸ºä¸€ä¸ª Pod è¿›è¡Œè°ƒåº¦ï¼‰ï¼Œç»‘å®šè¿‡ç¨‹å¯å¼‚æ­¥è¿è¡Œï¼ˆåŒä¸€æ—¶é—´ç‚¹å¯å¹¶å‘ä¸ºå¤šä¸ª Pod æ‰§è¡Œç»‘å®šï¼‰ã€‚</p>
<p>è°ƒåº¦è¿‡ç¨‹å’Œç»‘å®šè¿‡ç¨‹é‡åˆ°å¦‚ä¸‹æƒ…å†µæ—¶ä¼šä¸­é€”é€€å‡ºï¼š</p>
<ul>
<li>è°ƒåº¦ç¨‹åºè®¤ä¸ºå½“å‰æ²¡æœ‰è¯¥ Pod çš„å¯é€‰èŠ‚ç‚¹</li>
<li>å†…éƒ¨é”™è¯¯</li>
</ul>
<p>è¿™ä¸ªæ—¶å€™ï¼Œè¯¥ Pod å°†è¢«æ”¾å›åˆ° å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œå¹¶ç­‰å¾…ä¸‹æ¬¡é‡è¯•ã€‚</p>
<h3 id="æ‰©å±•ç‚¹ï¼ˆExtension-Pointsï¼‰"><a href="#æ‰©å±•ç‚¹ï¼ˆExtension-Pointsï¼‰" class="headerlink" title="æ‰©å±•ç‚¹ï¼ˆExtension Pointsï¼‰"></a>æ‰©å±•ç‚¹ï¼ˆExtension Pointsï¼‰</h3><p>ä¸‹å›¾å±•ç¤ºäº†è°ƒåº¦æ¡†æ¶ä¸­çš„è°ƒåº¦ä¸Šä¸‹æ–‡åŠå…¶ä¸­çš„æ‰©å±•ç‚¹ï¼Œä¸€ä¸ªæ‰©å±•å¯ä»¥æ³¨å†Œå¤šä¸ªæ‰©å±•ç‚¹ï¼Œä»¥ä¾¿å¯ä»¥æ‰§è¡Œæ›´å¤æ‚çš„æœ‰çŠ¶æ€çš„ä»»åŠ¡ã€‚<br><img src="/images/k8s/scheduling-framework-extensions.png" alt="scheduling-framework-extensions"></p>
<ol>
<li><code>QueueSort</code> æ‰©å±•ç”¨äºå¯¹ Pod çš„å¾…è°ƒåº¦é˜Ÿåˆ—è¿›è¡Œæ’åºï¼Œä»¥å†³å®šå…ˆè°ƒåº¦å“ªä¸ª Podï¼Œ<code>QueueSort</code> æ‰©å±•æœ¬è´¨ä¸Šåªéœ€è¦å®ç°ä¸€ä¸ªæ–¹æ³• <code>Less(Pod1, Pod2)</code> ç”¨äºæ¯”è¾ƒä¸¤ä¸ª Pod è°æ›´ä¼˜å…ˆè·å¾—è°ƒåº¦å³å¯ï¼ŒåŒä¸€æ—¶é—´ç‚¹åªèƒ½æœ‰ä¸€ä¸ª <code>QueueSort</code> æ’ä»¶ç”Ÿæ•ˆã€‚</li>
<li><code>Pre-filter</code> æ‰©å±•ç”¨äºå¯¹ Pod çš„ä¿¡æ¯è¿›è¡Œé¢„å¤„ç†ï¼Œæˆ–è€…æ£€æŸ¥ä¸€äº›é›†ç¾¤æˆ– Pod å¿…é¡»æ»¡è¶³çš„å‰ææ¡ä»¶ï¼Œå¦‚æœ <code>pre-filter</code> è¿”å›äº† errorï¼Œåˆ™è°ƒåº¦è¿‡ç¨‹ç»ˆæ­¢ã€‚</li>
<li><code>Filter</code> æ‰©å±•ç”¨äºæ’é™¤é‚£äº›ä¸èƒ½è¿è¡Œè¯¥ Pod çš„èŠ‚ç‚¹ï¼Œå¯¹äºæ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè°ƒåº¦å™¨å°†æŒ‰é¡ºåºæ‰§è¡Œ <code>filter</code> æ‰©å±•ï¼›å¦‚æœä»»ä½•ä¸€ä¸ª <code>filter</code> å°†èŠ‚ç‚¹æ ‡è®°ä¸ºä¸å¯é€‰ï¼Œåˆ™ä½™ä¸‹çš„ <code>filter</code> æ‰©å±•å°†ä¸ä¼šè¢«æ‰§è¡Œã€‚è°ƒåº¦å™¨å¯ä»¥åŒæ—¶å¯¹å¤šä¸ªèŠ‚ç‚¹æ‰§è¡Œ <code>filter</code> æ‰©å±•ã€‚</li>
<li><code>Post-filter</code> æ˜¯ä¸€ä¸ªé€šçŸ¥ç±»å‹çš„æ‰©å±•ç‚¹ï¼Œè°ƒç”¨è¯¥æ‰©å±•çš„å‚æ•°æ˜¯ <code>filter</code> é˜¶æ®µç»“æŸåè¢«ç­›é€‰ä¸ºå¯é€‰èŠ‚ç‚¹çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¯ä»¥åœ¨æ‰©å±•ä¸­ä½¿ç”¨è¿™äº›ä¿¡æ¯æ›´æ–°å†…éƒ¨çŠ¶æ€ï¼Œæˆ–è€…äº§ç”Ÿæ—¥å¿—æˆ– metrics ä¿¡æ¯ã€‚</li>
<li><code>Scoring</code> æ‰©å±•ç”¨äºä¸ºæ‰€æœ‰å¯é€‰èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†ï¼Œè°ƒåº¦å™¨å°†é’ˆå¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹è°ƒç”¨ <code>Soring</code> æ‰©å±•ï¼Œè¯„åˆ†ç»“æœæ˜¯ä¸€ä¸ªèŒƒå›´å†…çš„æ•´æ•°ã€‚åœ¨ <code>normalize scoring</code> é˜¶æ®µï¼Œè°ƒåº¦å™¨å°†ä¼šæŠŠæ¯ä¸ª <code>scoring</code> æ‰©å±•å¯¹å…·ä½“æŸä¸ªèŠ‚ç‚¹çš„è¯„åˆ†ç»“æœå’Œè¯¥æ‰©å±•çš„æƒé‡åˆå¹¶èµ·æ¥ï¼Œä½œä¸ºæœ€ç»ˆè¯„åˆ†ç»“æœã€‚</li>
<li><code>Normalize scoring</code> æ‰©å±•åœ¨è°ƒåº¦å™¨å¯¹èŠ‚ç‚¹è¿›è¡Œæœ€ç»ˆæ’åºä¹‹å‰ä¿®æ”¹æ¯ä¸ªèŠ‚ç‚¹çš„è¯„åˆ†ç»“æœï¼Œæ³¨å†Œåˆ°è¯¥æ‰©å±•ç‚¹çš„æ‰©å±•åœ¨è¢«è°ƒç”¨æ—¶ï¼Œå°†è·å¾—åŒä¸€ä¸ªæ’ä»¶ä¸­çš„ <code>scoring</code> æ‰©å±•çš„è¯„åˆ†ç»“æœä½œä¸ºå‚æ•°ï¼Œè°ƒåº¦æ¡†æ¶æ¯æ‰§è¡Œä¸€æ¬¡è°ƒåº¦ï¼Œéƒ½å°†è°ƒç”¨æ‰€æœ‰æ’ä»¶ä¸­çš„ä¸€ä¸ª <code>normalize scoring</code> æ‰©å±•ä¸€æ¬¡ã€‚</li>
<li><code>Reserve</code> æ˜¯ä¸€ä¸ªé€šçŸ¥æ€§è´¨çš„æ‰©å±•ç‚¹ï¼Œæœ‰çŠ¶æ€çš„æ’ä»¶å¯ä»¥ä½¿ç”¨è¯¥æ‰©å±•ç‚¹æ¥è·å¾—èŠ‚ç‚¹ä¸Šä¸º Pod é¢„ç•™çš„èµ„æºï¼Œè¯¥äº‹ä»¶å‘ç”Ÿåœ¨è°ƒåº¦å™¨å°† Pod ç»‘å®šåˆ°èŠ‚ç‚¹ä¹‹å‰ï¼Œç›®çš„æ˜¯é¿å…è°ƒåº¦å™¨åœ¨ç­‰å¾… Pod ä¸èŠ‚ç‚¹ç»‘å®šçš„è¿‡ç¨‹ä¸­è°ƒåº¦æ–°çš„ Pod åˆ°èŠ‚ç‚¹ä¸Šæ—¶ï¼Œå‘ç”Ÿå®é™…ä½¿ç”¨èµ„æºè¶…å‡ºå¯ç”¨èµ„æºçš„æƒ…å†µã€‚ï¼ˆå› ä¸ºç»‘å®š Pod åˆ°èŠ‚ç‚¹ä¸Šæ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼‰ã€‚è¿™æ˜¯è°ƒåº¦è¿‡ç¨‹çš„æœ€åä¸€ä¸ªæ­¥éª¤ï¼ŒPod è¿›å…¥ <code>reserved</code> çŠ¶æ€ä»¥åï¼Œè¦ä¹ˆåœ¨ç»‘å®šå¤±è´¥æ—¶è§¦å‘ <code>Unreserve</code> æ‰©å±•ï¼Œè¦ä¹ˆåœ¨ç»‘å®šæˆåŠŸæ—¶ï¼Œç”± <code>Post-bind</code> æ‰©å±•ç»“æŸç»‘å®šè¿‡ç¨‹ã€‚</li>
<li><code>Permit</code> æ‰©å±•ç”¨äºé˜»æ­¢æˆ–è€…å»¶è¿Ÿ Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šã€‚Permit æ‰©å±•å¯ä»¥åšä¸‹é¢ä¸‰ä»¶äº‹ä¸­çš„ä¸€é¡¹ï¼š<ul>
<li><code>approve</code>ï¼ˆæ‰¹å‡†ï¼‰ï¼šå½“æ‰€æœ‰çš„ <code>permit</code> æ‰©å±•éƒ½ <code>approve</code> äº† Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šï¼Œè°ƒåº¦å™¨å°†ç»§ç»­æ‰§è¡Œç»‘å®šè¿‡ç¨‹</li>
<li><code>deny</code>ï¼ˆæ‹’ç»ï¼‰ï¼šå¦‚æœä»»ä½•ä¸€ä¸ª <code>permit</code> æ‰©å±• <code>deny</code> äº† Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šï¼ŒPod å°†è¢«æ”¾å›åˆ°å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œæ­¤æ—¶å°†è§¦å‘ <code>Unreserve</code> æ‰©å±•</li>
<li><code>wait</code>ï¼ˆç­‰å¾…ï¼‰ï¼šå¦‚æœä¸€ä¸ª <code>permit</code> æ‰©å±•è¿”å›äº† <code>wait</code>ï¼Œåˆ™ Pod å°†ä¿æŒåœ¨ <code>permit</code> é˜¶æ®µï¼Œç›´åˆ°è¢«å…¶ä»–æ‰©å±• <code>approve</code>ï¼Œå¦‚æœè¶…æ—¶äº‹ä»¶å‘ç”Ÿï¼Œ<code>wait</code> çŠ¶æ€å˜æˆ <code>deny</code>ï¼ŒPod å°†è¢«æ”¾å›åˆ°å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œæ­¤æ—¶å°†è§¦å‘ <code>Unreserve</code> æ‰©å±•</li>
</ul>
</li>
<li><code>Pre-bind</code> æ‰©å±•ç”¨äºåœ¨ Pod ç»‘å®šä¹‹å‰æ‰§è¡ŒæŸäº›é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œ<code>pre-bind</code> æ‰©å±•å¯ä»¥å°†ä¸€ä¸ªåŸºäºç½‘ç»œçš„æ•°æ®å·æŒ‚è½½åˆ°èŠ‚ç‚¹ä¸Šï¼Œä»¥ä¾¿ Pod å¯ä»¥ä½¿ç”¨ã€‚å¦‚æœä»»ä½•ä¸€ä¸ª <code>pre-bind</code> æ‰©å±•è¿”å›é”™è¯¯ï¼ŒPod å°†è¢«æ”¾å›åˆ°å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œæ­¤æ—¶å°†è§¦å‘ <code>Unreserve</code> æ‰©å±•ã€‚</li>
<li><code>Bind</code> æ‰©å±•ç”¨äºå°† Pod ç»‘å®šåˆ°èŠ‚ç‚¹ä¸Šï¼š<ul>
<li>åªæœ‰æ‰€æœ‰çš„ <code>pre-bind</code> æ‰©å±•éƒ½æˆåŠŸæ‰§è¡Œäº†ï¼Œ<code>bind</code> æ‰©å±•æ‰ä¼šæ‰§è¡Œ</li>
<li>è°ƒåº¦æ¡†æ¶æŒ‰ç…§ <code>bind</code> æ‰©å±•æ³¨å†Œçš„é¡ºåºé€ä¸ªè°ƒç”¨ <code>bind</code> æ‰©å±•</li>
<li>å…·ä½“æŸä¸ª <code>bind</code> æ‰©å±•å¯ä»¥é€‰æ‹©å¤„ç†æˆ–è€…ä¸å¤„ç†è¯¥ Pod</li>
<li>å¦‚æœæŸä¸ª <code>` æ‰©å±•å¤„ç†äº†è¯¥ Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šï¼Œä½™ä¸‹çš„</code>bind` æ‰©å±•å°†è¢«å¿½ç•¥</li>
</ul>
</li>
<li><code>Post-bind</code> æ˜¯ä¸€ä¸ªé€šçŸ¥æ€§è´¨çš„æ‰©å±•ï¼š<ul>
<li><code>Post-bind</code> æ‰©å±•åœ¨ Pod æˆåŠŸç»‘å®šåˆ°èŠ‚ç‚¹ä¸Šä¹‹åè¢«åŠ¨è°ƒç”¨</li>
<li><code>Post-bind</code> æ‰©å±•æ˜¯ç»‘å®šè¿‡ç¨‹çš„æœ€åä¸€ä¸ªæ­¥éª¤ï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡Œèµ„æºæ¸…ç†çš„åŠ¨ä½œ</li>
</ul>
</li>
<li><code>Unreserve</code> æ˜¯ä¸€ä¸ªé€šçŸ¥æ€§è´¨çš„æ‰©å±•ï¼Œå¦‚æœä¸º Pod é¢„ç•™äº†èµ„æºï¼ŒPod åˆåœ¨è¢«ç»‘å®šè¿‡ç¨‹ä¸­è¢«æ‹’ç»ç»‘å®šï¼Œåˆ™ <code>unreserve</code> æ‰©å±•å°†è¢«è°ƒç”¨ã€‚<code>Unreserve</code> æ‰©å±•åº”è¯¥é‡Šæ”¾å·²ç»ä¸º Pod é¢„ç•™çš„èŠ‚ç‚¹ä¸Šçš„è®¡ç®—èµ„æºã€‚åœ¨ä¸€ä¸ªæ’ä»¶ä¸­ï¼Œ<code>reserve</code> æ‰©å±•å’Œ <code>unreserve</code> æ‰©å±•åº”è¯¥æˆå¯¹å‡ºç°ã€‚</li>
</ol>
<p>å¦‚æœæˆ‘ä»¬è¦å®ç°è‡ªå·±çš„æ’ä»¶ï¼Œå¿…é¡»å‘è°ƒåº¦æ¡†æ¶æ³¨å†Œæ’ä»¶å¹¶å®Œæˆé…ç½®ï¼Œå¦å¤–è¿˜å¿…é¡»å®ç°æ‰©å±•ç‚¹æ¥å£ï¼Œå¯¹åº”çš„æ‰©å±•ç‚¹æ¥å£æˆ‘ä»¬å¯ä»¥åœ¨æºç  <code>pkg/scheduler/framework/v1alpha1/interface.go</code> æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Plugin is the parent type for all the scheduling framework plugins.</span></span><br><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	Name() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> QueueSortPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	Plugin</span><br><span class="line">	Less(*PodInfo, *PodInfo) <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PreFilterPlugin is an interface that must be implemented by "prefilter" plugins.</span></span><br><span class="line"><span class="comment">// These plugins are called at the beginning of the scheduling cycle.</span></span><br><span class="line"><span class="keyword">type</span> PreFilterPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	Plugin</span><br><span class="line">	PreFilter(pc *PluginContext, p *v1.Pod) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FilterPlugin is an interface for Filter plugins. These plugins are called at the</span></span><br><span class="line"><span class="comment">// filter extension point for filtering out hosts that cannot run a pod.</span></span><br><span class="line"><span class="comment">// This concept used to be called 'predicate' in the original scheduler.</span></span><br><span class="line"><span class="comment">// These plugins should return "Success", "Unschedulable" or "Error" in Status.code.</span></span><br><span class="line"><span class="comment">// However, the scheduler accepts other valid codes as well.</span></span><br><span class="line"><span class="comment">// Anything other than "Success" will lead to exclusion of the given host from</span></span><br><span class="line"><span class="comment">// running the pod.</span></span><br><span class="line"><span class="keyword">type</span> FilterPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	Plugin</span><br><span class="line">	Filter(pc *PluginContext, pod *v1.Pod, nodeName <span class="keyword">string</span>) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PostFilterPlugin is an interface for Post-filter plugin. Post-filter is an</span></span><br><span class="line"><span class="comment">// informational extension point. Plugins will be called with a list of nodes</span></span><br><span class="line"><span class="comment">// that passed the filtering phase. A plugin may use this data to update internal</span></span><br><span class="line"><span class="comment">// state or to generate logs/metrics.</span></span><br><span class="line"><span class="keyword">type</span> PostFilterPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	Plugin</span><br><span class="line">	PostFilter(pc *PluginContext, pod *v1.Pod, nodes []*v1.Node, filteredNodesStatuses NodeToStatusMap) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ScorePlugin is an interface that must be implemented by "score" plugins to rank</span></span><br><span class="line"><span class="comment">// nodes that passed the filtering phase.</span></span><br><span class="line"><span class="keyword">type</span> ScorePlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	Plugin</span><br><span class="line">	Score(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) (<span class="keyword">int</span>, *Status)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ScoreWithNormalizePlugin is an interface that must be implemented by "score"</span></span><br><span class="line"><span class="comment">// plugins that also need to normalize the node scoring results produced by the same</span></span><br><span class="line"><span class="comment">// plugin's "Score" method.</span></span><br><span class="line"><span class="keyword">type</span> ScoreWithNormalizePlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	ScorePlugin</span><br><span class="line">	NormalizeScore(pc *PluginContext, p *v1.Pod, scores NodeScoreList) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ReservePlugin is an interface for Reserve plugins. These plugins are called</span></span><br><span class="line"><span class="comment">// at the reservation point. These are meant to update the state of the plugin.</span></span><br><span class="line"><span class="comment">// This concept used to be called 'assume' in the original scheduler.</span></span><br><span class="line"><span class="comment">// These plugins should return only Success or Error in Status.code. However,</span></span><br><span class="line"><span class="comment">// the scheduler accepts other valid codes as well. Anything other than Success</span></span><br><span class="line"><span class="comment">// will lead to rejection of the pod.</span></span><br><span class="line"><span class="keyword">type</span> ReservePlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	Plugin</span><br><span class="line">	Reserve(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PreBindPlugin is an interface that must be implemented by "prebind" plugins.</span></span><br><span class="line"><span class="comment">// These plugins are called before a pod being scheduled.</span></span><br><span class="line"><span class="keyword">type</span> PreBindPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	Plugin</span><br><span class="line">	PreBind(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PostBindPlugin is an interface that must be implemented by "postbind" plugins.</span></span><br><span class="line"><span class="comment">// These plugins are called after a pod is successfully bound to a node.</span></span><br><span class="line"><span class="keyword">type</span> PostBindPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	Plugin</span><br><span class="line">	PostBind(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnreservePlugin is an interface for Unreserve plugins. This is an informational</span></span><br><span class="line"><span class="comment">// extension point. If a pod was reserved and then rejected in a later phase, then</span></span><br><span class="line"><span class="comment">// un-reserve plugins will be notified. Un-reserve plugins should clean up state</span></span><br><span class="line"><span class="comment">// associated with the reserved Pod.</span></span><br><span class="line"><span class="keyword">type</span> UnreservePlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	Plugin</span><br><span class="line">	Unreserve(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PermitPlugin is an interface that must be implemented by "permit" plugins.</span></span><br><span class="line"><span class="comment">// These plugins are called before a pod is bound to a node.</span></span><br><span class="line"><span class="keyword">type</span> PermitPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	Plugin</span><br><span class="line">	Permit(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) (*Status, time.Duration)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BindPlugin is an interface that must be implemented by "bind" plugins. Bind</span></span><br><span class="line"><span class="comment">// plugins are used to bind a pod to a Node.</span></span><br><span class="line"><span class="keyword">type</span> BindPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">	Plugin</span><br><span class="line">	Bind(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) *Status</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯¹äºè°ƒåº¦æ¡†æ¶æ’ä»¶çš„å¯ç”¨æˆ–è€…ç¦ç”¨ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„ <a href="https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#KubeSchedulerConfiguration" target="_blank" rel="external">KubeSchedulerConfiguration</a> èµ„æºå¯¹è±¡æ¥è¿›è¡Œé…ç½®ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­çš„é…ç½®å¯ç”¨äº†ä¸€ä¸ªå®ç°äº† <code>reserve</code> å’Œ <code>preBind</code> æ‰©å±•ç‚¹çš„æ’ä»¶ï¼Œå¹¶ä¸”ç¦ç”¨äº†å¦å¤–ä¸€ä¸ªæ’ä»¶ï¼ŒåŒæ—¶ä¸ºæ’ä»¶ foo æä¾›äº†ä¸€äº›é…ç½®ä¿¡æ¯ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> kubescheduler.config.k8s.io/v1alpha1</span><br><span class="line"><span class="attr">kind:</span> KubeSchedulerConfiguration</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line"><span class="attr">  reserve:</span></span><br><span class="line"><span class="attr">    enabled:</span></span><br><span class="line"><span class="attr">    - name:</span> foo</span><br><span class="line"><span class="attr">    - name:</span> bar</span><br><span class="line"><span class="attr">    disabled:</span></span><br><span class="line"><span class="attr">    - name:</span> baz</span><br><span class="line"><span class="attr">  preBind:</span></span><br><span class="line"><span class="attr">    enabled:</span></span><br><span class="line"><span class="attr">    - name:</span> foo</span><br><span class="line"><span class="attr">    disabled:</span></span><br><span class="line"><span class="attr">    - name:</span> baz</span><br><span class="line"></span><br><span class="line"><span class="attr">pluginConfig:</span></span><br><span class="line"><span class="attr">- name:</span> foo</span><br><span class="line"><span class="attr">  args:</span> <span class="string">&gt;</span><br><span class="line">    fooæ’ä»¶å¯ä»¥è§£æçš„ä»»æ„å†…å®¹</span></span><br></pre></td></tr></table></figure></p>
<p>æ‰©å±•çš„è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼š</p>
<ul>
<li>å¦‚æœæŸä¸ªæ‰©å±•ç‚¹æ²¡æœ‰é…ç½®å¯¹åº”çš„æ‰©å±•ï¼Œè°ƒåº¦æ¡†æ¶å°†ä½¿ç”¨é»˜è®¤æ’ä»¶ä¸­çš„æ‰©å±•</li>
<li>å¦‚æœä¸ºæŸä¸ªæ‰©å±•ç‚¹é…ç½®ä¸”æ¿€æ´»äº†æ‰©å±•ï¼Œåˆ™è°ƒåº¦æ¡†æ¶å°†å…ˆè°ƒç”¨é»˜è®¤æ’ä»¶çš„æ‰©å±•ï¼Œå†è°ƒç”¨é…ç½®ä¸­çš„æ‰©å±•</li>
<li>é»˜è®¤æ’ä»¶çš„æ‰©å±•å§‹ç»ˆè¢«æœ€å…ˆè°ƒç”¨ï¼Œç„¶åæŒ‰ç…§ <code>KubeSchedulerConfiguration</code> ä¸­æ‰©å±•çš„æ¿€æ´» <code>enabled</code> é¡ºåºé€ä¸ªè°ƒç”¨æ‰©å±•ç‚¹çš„æ‰©å±•</li>
<li>å¯ä»¥å…ˆç¦ç”¨é»˜è®¤æ’ä»¶çš„æ‰©å±•ï¼Œç„¶ååœ¨ <code>enabled</code> åˆ—è¡¨ä¸­çš„æŸä¸ªä½ç½®æ¿€æ´»é»˜è®¤æ’ä»¶çš„æ‰©å±•ï¼Œè¿™ç§åšæ³•å¯ä»¥æ”¹å˜é»˜è®¤æ’ä»¶çš„æ‰©å±•è¢«è°ƒç”¨æ—¶çš„é¡ºåº</li>
</ul>
<p>å‡è®¾é»˜è®¤æ’ä»¶ foo å®ç°äº† <code>reserve</code> æ‰©å±•ç‚¹ï¼Œæ­¤æ—¶æˆ‘ä»¬è¦æ·»åŠ ä¸€ä¸ªæ’ä»¶ barï¼Œæƒ³è¦åœ¨ foo ä¹‹å‰è¢«è°ƒç”¨ï¼Œåˆ™åº”è¯¥å…ˆç¦ç”¨ foo å†æŒ‰ç…§ bar foo çš„é¡ºåºæ¿€æ´»ã€‚ç¤ºä¾‹é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> kubescheduler.config.k8s.io/v1alpha1</span><br><span class="line"><span class="attr">kind:</span> KubeSchedulerConfiguration</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line"><span class="attr">  reserve:</span></span><br><span class="line"><span class="attr">    enabled:</span></span><br><span class="line"><span class="attr">    - name:</span> bar</span><br><span class="line"><span class="attr">    - name:</span> foo</span><br><span class="line"><span class="attr">    disabled:</span></span><br><span class="line"><span class="attr">    - name:</span> foo</span><br></pre></td></tr></table></figure></p>
<p>åœ¨æºç ç›®å½• <code>pkg/scheduler/framework/plugins/examples</code> ä¸­æœ‰å‡ ä¸ªç¤ºèŒƒæ’ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å‚ç…§å…¶å®ç°æ–¹å¼ã€‚</p>
<h3 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>å…¶å®è¦å®ç°ä¸€ä¸ªè°ƒåº¦æ¡†æ¶çš„æ’ä»¶ï¼Œå¹¶ä¸éš¾ï¼Œæˆ‘ä»¬åªè¦å®ç°å¯¹åº”çš„æ‰©å±•ç‚¹ï¼Œç„¶åå°†æ’ä»¶æ³¨å†Œåˆ°è°ƒåº¦å™¨ä¸­å³å¯ï¼Œä¸‹é¢æ˜¯é»˜è®¤è°ƒåº¦å™¨åœ¨åˆå§‹åŒ–çš„æ—¶å€™æ³¨å†Œçš„æ’ä»¶ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRegistry</span><span class="params">()</span> <span class="title">Registry</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Registry&#123;</span><br><span class="line">		<span class="comment">// FactoryMap:</span></span><br><span class="line">		<span class="comment">// New plugins are registered here.</span></span><br><span class="line">		<span class="comment">// example:</span></span><br><span class="line">		<span class="comment">// &#123;</span></span><br><span class="line">		<span class="comment">//  stateful_plugin.Name: stateful.NewStatefulMultipointExample,</span></span><br><span class="line">		<span class="comment">//  fooplugin.Name: fooplugin.New,</span></span><br><span class="line">		<span class="comment">// &#125;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯å¯ä»¥çœ‹åˆ°é»˜è®¤å¹¶æ²¡æœ‰æ³¨å†Œä¸€äº›æ’ä»¶ï¼Œæ‰€ä»¥è¦æƒ³è®©è°ƒåº¦å™¨èƒ½å¤Ÿè¯†åˆ«æˆ‘ä»¬çš„æ’ä»¶ä»£ç ï¼Œå°±éœ€è¦è‡ªå·±æ¥å®ç°ä¸€ä¸ªè°ƒåº¦å™¨äº†ï¼Œå½“ç„¶è¿™ä¸ªè°ƒåº¦å™¨æˆ‘ä»¬å®Œå…¨æ²¡å¿…è¦å®Œå…¨è‡ªå·±å®ç°ï¼Œç›´æ¥è°ƒç”¨é»˜è®¤çš„è°ƒåº¦å™¨ï¼Œç„¶ååœ¨ä¸Šé¢çš„ <code>NewRegistry()</code> å‡½æ•°ä¸­å°†æˆ‘ä»¬çš„æ’ä»¶æ³¨å†Œè¿›å»å³å¯ã€‚åœ¨ <code>kube-scheduler</code> çš„æºç æ–‡ä»¶ <code>kubernetes/cmd/kube-scheduler/app/server.go</code> ä¸­æœ‰ä¸€ä¸ª <code>NewSchedulerCommand</code> å…¥å£å‡½æ•°ï¼Œå…¶ä¸­çš„å‚æ•°æ˜¯ä¸€ä¸ªç±»å‹ä¸º <code>Option</code> çš„åˆ—è¡¨ï¼Œè€Œè¿™ä¸ª <code>Option</code> æ°å¥½å°±æ˜¯ä¸€ä¸ªæ’ä»¶é…ç½®çš„å®šä¹‰ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Option configures a framework.Registry.</span></span><br><span class="line"><span class="keyword">type</span> Option <span class="function"><span class="keyword">func</span><span class="params">(framework.Registry)</span> <span class="title">error</span></span><br><span class="line"></span><br><span class="line">// <span class="title">NewSchedulerCommand</span> <span class="title">creates</span> <span class="title">a</span> *<span class="title">cobra</span>.<span class="title">Command</span> <span class="title">object</span> <span class="title">with</span> <span class="title">default</span> <span class="title">parameters</span> <span class="title">and</span> <span class="title">registryOptions</span></span><br><span class="line"><span class="title">func</span> <span class="title">NewSchedulerCommand</span><span class="params">(registryOptions ...Option)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥æˆ‘ä»¬å®Œå…¨å°±å¯ä»¥ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥ä½œä¸ºæˆ‘ä»¬çš„å‡½æ•°å…¥å£ï¼Œå¹¶ä¸”ä¼ å…¥æˆ‘ä»¬è‡ªå·±å®ç°çš„æ’ä»¶ä½œä¸ºå‚æ•°å³å¯ï¼Œè€Œä¸”è¯¥æ–‡ä»¶ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªåä¸º <code>WithPlugin</code> çš„å‡½æ•°å¯ä»¥æ¥åˆ›å»ºä¸€ä¸ª <code>Option</code> å®ä¾‹ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WithPlugin creates an Option based on plugin name and factory.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithPlugin</span><span class="params">(name <span class="keyword">string</span>, factory framework.PluginFactory)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(registry framework.Registry)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> registry.Register(name, factory)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬çš„å…¥å£å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	rand.Seed(time.Now().UTC().UnixNano())</span><br><span class="line"></span><br><span class="line">	command := app.NewSchedulerCommand(</span><br><span class="line">		app.WithPlugin(sample.Name, sample.New), </span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	logs.InitLogs()</span><br><span class="line">	<span class="keyword">defer</span> logs.FlushLogs()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := command.Execute(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		_, _ = fmt.Fprintf(os.Stderr, <span class="string">"%v\n"</span>, err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å…¶ä¸­ <code>app.WithPlugin(sample.Name, sample.New)</code> å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦å®ç°çš„æ’ä»¶ï¼Œä» <code>WithPlugin</code> å‡½æ•°çš„å‚æ•°ä¹Ÿå¯ä»¥çœ‹å‡ºæˆ‘ä»¬è¿™é‡Œçš„ <code>sample.New</code> å¿…é¡»æ˜¯ä¸€ä¸ª <code>framework.PluginFactory</code> ç±»å‹çš„å€¼ï¼Œè€Œ <code>PluginFactory</code> çš„å®šä¹‰å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PluginFactory = <span class="function"><span class="keyword">func</span><span class="params">(configuration *runtime.Unknown, f FrameworkHandle)</span> <span class="params">(Plugin, error)</span></span></span><br></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥ <code>sample.New</code> å®é™…ä¸Šå°±æ˜¯ä¸Šé¢çš„è¿™ä¸ªå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥è·å–åˆ°æ’ä»¶ä¸­çš„ä¸€äº›æ•°æ®ç„¶åè¿›è¡Œé€»è¾‘å¤„ç†å³å¯ï¼Œæ’ä»¶å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯ç®€å•è·å–ä¸‹æ•°æ®æ‰“å°æ—¥å¿—ï¼Œå¦‚æœä½ æœ‰å®é™…éœ€æ±‚çš„å¯ä»¥æ ¹æ®è·å–çš„æ•°æ®å°±è¡Œå¤„ç†å³å¯ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯å®ç°äº† <code>PreFilter</code>ã€<code>Filter</code>ã€<code>PreBind</code> ä¸‰ä¸ªæ‰©å±•ç‚¹ï¼Œå…¶ä»–çš„å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼æ¥æ‰©å±•å³å¯ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ’ä»¶åç§°</span></span><br><span class="line"><span class="keyword">const</span> Name = <span class="string">"sample-plugin"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Args <span class="keyword">struct</span> &#123;</span><br><span class="line">	FavoriteColor  <span class="keyword">string</span> <span class="string">`json:"favorite_color,omitempty"`</span></span><br><span class="line">	FavoriteNumber <span class="keyword">int</span>    <span class="string">`json:"favorite_number,omitempty"`</span></span><br><span class="line">	ThanksTo       <span class="keyword">string</span> <span class="string">`json:"thanks_to,omitempty"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Sample <span class="keyword">struct</span> &#123;</span><br><span class="line">	args   *Args</span><br><span class="line">	handle framework.FrameworkHandle</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Sample)</span> <span class="title">Name</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Sample)</span> <span class="title">PreFilter</span><span class="params">(pc *framework.PluginContext, pod *v1.Pod)</span> *<span class="title">framework</span>.<span class="title">Status</span></span> &#123;</span><br><span class="line">	klog.V(<span class="number">3</span>).Infof(<span class="string">"prefilter pod: %v"</span>, pod.Name)</span><br><span class="line">	<span class="keyword">return</span> framework.NewStatus(framework.Success, <span class="string">""</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Sample)</span> <span class="title">Filter</span><span class="params">(pc *framework.PluginContext, pod *v1.Pod, nodeName <span class="keyword">string</span>)</span> *<span class="title">framework</span>.<span class="title">Status</span></span> &#123;</span><br><span class="line">	klog.V(<span class="number">3</span>).Infof(<span class="string">"filter pod: %v, node: %v"</span>, pod.Name, nodeName)</span><br><span class="line">	<span class="keyword">return</span> framework.NewStatus(framework.Success, <span class="string">""</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Sample)</span> <span class="title">PreBind</span><span class="params">(pc *framework.PluginContext, pod *v1.Pod, nodeName <span class="keyword">string</span>)</span> *<span class="title">framework</span>.<span class="title">Status</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> nodeInfo, ok := s.handle.NodeInfoSnapshot().NodeInfoMap[nodeName]; !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> framework.NewStatus(framework.Error, fmt.Sprintf(<span class="string">"prebind get node info error: %+v"</span>, nodeName))</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		klog.V(<span class="number">3</span>).Infof(<span class="string">"prebind node info: %+v"</span>, nodeInfo.Node())</span><br><span class="line">		<span class="keyword">return</span> framework.NewStatus(framework.Success, <span class="string">""</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//type PluginFactory = func(configuration *runtime.Unknown, f FrameworkHandle) (Plugin, error)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(configuration *runtime.Unknown, f framework.FrameworkHandle)</span> <span class="params">(framework.Plugin, error)</span></span> &#123;</span><br><span class="line">	args := &amp;Args&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> err := framework.DecodeInto(configuration, args); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	klog.V(<span class="number">3</span>).Infof(<span class="string">"get plugin config args: %+v"</span>, args)</span><br><span class="line">	<span class="keyword">return</span> &amp;Sample&#123;</span><br><span class="line">		args: args,</span><br><span class="line">		handle: f,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>å®Œæ•´ä»£ç å¯ä»¥å‰å¾€ä»“åº“ <a href="https://github.com/icyxp/sample-scheduler-framework" target="_blank" rel="external">https://github.com/icyxp/sample-scheduler-framework</a> è·å–ã€‚</p>
</blockquote>
<p>å®ç°å®Œæˆåï¼Œç¼–è¯‘æ‰“åŒ…æˆé•œåƒå³å¯ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥å½“æˆæ™®é€šçš„åº”ç”¨ç”¨ä¸€ä¸ª <code>Deployment</code> æ§åˆ¶å™¨æ¥éƒ¨ç½²å³å¯ï¼Œç”±äºæˆ‘ä»¬éœ€è¦å»è·å–é›†ç¾¤ä¸­çš„ä¸€äº›èµ„æºå¯¹è±¡ï¼Œæ‰€ä»¥å½“ç„¶éœ€è¦ç”³è¯· RBAC æƒé™ï¼Œç„¶ååŒæ ·é€šè¿‡ <code>--config</code> å‚æ•°æ¥é…ç½®æˆ‘ä»¬çš„è°ƒåº¦å™¨ï¼ŒåŒæ ·è¿˜æ˜¯ä½¿ç”¨ä¸€ä¸ª <code>KubeSchedulerConfiguration</code> èµ„æºå¯¹è±¡é…ç½®ï¼Œå¯ä»¥é€šè¿‡ <code>plugins</code> æ¥å¯ç”¨æˆ–è€…ç¦ç”¨æˆ‘ä»¬å®ç°çš„æ’ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <code>pluginConfig</code> æ¥ä¼ é€’ä¸€äº›å‚æ•°å€¼ç»™æ’ä»¶ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> ClusterRole</span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> sample-scheduler-clusterrole</span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> endpoints</span><br><span class="line"><span class="bullet">      -</span> events</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> create</span><br><span class="line"><span class="bullet">      -</span> get</span><br><span class="line"><span class="bullet">      -</span> update</span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> nodes</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> get</span><br><span class="line"><span class="bullet">      -</span> list</span><br><span class="line"><span class="bullet">      -</span> watch</span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> pods</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> delete</span><br><span class="line"><span class="bullet">      -</span> get</span><br><span class="line"><span class="bullet">      -</span> list</span><br><span class="line"><span class="bullet">      -</span> watch</span><br><span class="line"><span class="bullet">      -</span> update</span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> bindings</span><br><span class="line"><span class="bullet">      -</span> pods/binding</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> create</span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> pods/status</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> patch</span><br><span class="line"><span class="bullet">      -</span> update</span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> replicationcontrollers</span><br><span class="line"><span class="bullet">      -</span> services</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> get</span><br><span class="line"><span class="bullet">      -</span> list</span><br><span class="line"><span class="bullet">      -</span> watch</span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> apps</span><br><span class="line"><span class="bullet">      -</span> extensions</span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> replicasets</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> get</span><br><span class="line"><span class="bullet">      -</span> list</span><br><span class="line"><span class="bullet">      -</span> watch</span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> apps</span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> statefulsets</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> get</span><br><span class="line"><span class="bullet">      -</span> list</span><br><span class="line"><span class="bullet">      -</span> watch</span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> policy</span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> poddisruptionbudgets</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> get</span><br><span class="line"><span class="bullet">      -</span> list</span><br><span class="line"><span class="bullet">      -</span> watch</span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> persistentvolumeclaims</span><br><span class="line"><span class="bullet">      -</span> persistentvolumes</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> get</span><br><span class="line"><span class="bullet">      -</span> list</span><br><span class="line"><span class="bullet">      -</span> watch</span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> configmaps</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> get</span><br><span class="line"><span class="bullet">      -</span> list</span><br><span class="line"><span class="bullet">      -</span> watch</span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"storage.k8s.io"</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> storageclasses</span><br><span class="line"><span class="bullet">      -</span> csinodes</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> get</span><br><span class="line"><span class="bullet">      -</span> list</span><br><span class="line"><span class="bullet">      -</span> watch</span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"coordination.k8s.io"</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> leases</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> create</span><br><span class="line"><span class="bullet">      -</span> get</span><br><span class="line"><span class="bullet">      -</span> list</span><br><span class="line"><span class="bullet">      -</span> update</span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"events.k8s.io"</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> events</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> create</span><br><span class="line"><span class="bullet">      -</span> patch</span><br><span class="line"><span class="bullet">      -</span> update</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> ServiceAccount</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> sample-scheduler-sa</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> ClusterRoleBinding</span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> sample-scheduler-clusterrolebinding</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="attr">  kind:</span> ClusterRole</span><br><span class="line"><span class="attr">  name:</span> sample-scheduler-clusterrole</span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> ServiceAccount</span><br><span class="line"><span class="attr">  name:</span> sample-scheduler-sa</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> ConfigMap</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> scheduler-config</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  scheduler-config.yaml: <span class="string">|</span><br><span class="line"></span><span class="attr">    apiVersion:</span> kubescheduler.config.k8s.io/v1alpha1</span><br><span class="line"><span class="attr">    kind:</span> KubeSchedulerConfiguration</span><br><span class="line"><span class="attr">    schedulerName:</span> sample-scheduler</span><br><span class="line"><span class="attr">    leaderElection:</span></span><br><span class="line"><span class="attr">      leaderElect:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      lockObjectName:</span> sample-scheduler</span><br><span class="line"><span class="attr">      lockObjectNamespace:</span> kube-system</span><br><span class="line"><span class="attr">    plugins:</span></span><br><span class="line"><span class="attr">      preFilter:</span></span><br><span class="line"><span class="attr">        enabled:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">"sample-plugin"</span></span><br><span class="line"><span class="attr">      filter:</span></span><br><span class="line"><span class="attr">        enabled:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">"sample-plugin"</span></span><br><span class="line"><span class="attr">      preBind:</span></span><br><span class="line"><span class="attr">        enabled:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">"sample-plugin"</span></span><br><span class="line"><span class="attr">    pluginConfig:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">"sample-plugin"</span></span><br><span class="line"><span class="attr">      args:</span></span><br><span class="line"><span class="attr">        favorite_color:</span> <span class="string">"#326CE5"</span></span><br><span class="line"><span class="attr">        favorite_number:</span> <span class="number">7</span></span><br><span class="line"><span class="attr">        thanks_to:</span> <span class="string">"thockin"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> apps/v1</span><br><span class="line"><span class="attr">kind:</span> Deployment</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> sample-scheduler</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    component:</span> sample-scheduler</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      component:</span> sample-scheduler</span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        component:</span> sample-scheduler</span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccount:</span> sample-scheduler-sa</span><br><span class="line"><span class="attr">      priorityClassName:</span> system-cluster-critical</span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> scheduler-config</span><br><span class="line"><span class="attr">          configMap:</span></span><br><span class="line"><span class="attr">            name:</span> scheduler-config</span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> scheduler-ctrl</span><br><span class="line"><span class="attr">          image:</span> cnych/sample-scheduler:v0<span class="number">.1</span><span class="number">.6</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="bullet">            -</span> sample-scheduler-framework</span><br><span class="line"><span class="bullet">            -</span> --config=/etc/kubernetes/scheduler-config.yaml</span><br><span class="line"><span class="bullet">            -</span> --v=<span class="number">3</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="string">"50m"</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> scheduler-config</span><br><span class="line"><span class="attr">              mountPath:</span> /etc/kubernetes</span><br></pre></td></tr></table></figure></p>
<p>ç›´æ¥éƒ¨ç½²ä¸Šé¢çš„èµ„æºå¯¹è±¡å³å¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±éƒ¨ç½²äº†ä¸€ä¸ªåä¸º <code>sample-scheduler</code> çš„è°ƒåº¦å™¨äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥éƒ¨ç½²ä¸€ä¸ªåº”ç”¨æ¥ä½¿ç”¨è¿™ä¸ªè°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> apps/v1</span><br><span class="line"><span class="attr">kind:</span> Deployment</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> test-scheduler</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> test-scheduler</span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> test-scheduler</span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      schedulerName:</span> sample-scheduler</span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - image:</span> nginx</span><br><span class="line"><span class="attr">        imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="attr">        name:</span> nginx</span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬ç°åœ¨æ‰‹åŠ¨æŒ‡å®šäº†ä¸€ä¸ª <code>schedulerName</code> çš„å­—æ®µï¼Œå°†å…¶è®¾ç½®æˆä¸Šé¢æˆ‘ä»¬è‡ªå®šä¹‰çš„è°ƒåº¦å™¨åç§° <code>sample-scheduler</code>ã€‚</p>
<p>æˆ‘ä»¬ç›´æ¥åˆ›å»ºè¿™ä¸ªèµ„æºå¯¹è±¡ï¼Œåˆ›å»ºå®ŒæˆåæŸ¥çœ‹æˆ‘ä»¬è‡ªå®šä¹‰è°ƒåº¦å™¨çš„æ—¥å¿—ä¿¡æ¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system <span class="_">-l</span> component=sample-scheduler</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">sample-scheduler-7c469787f-rwhhd   1/1     Running   0          13m</span><br><span class="line">$ kubectl logs <span class="_">-f</span> sample-scheduler-7c469787f-rwhhd -n kube-system</span><br><span class="line">I0104 08:24:22.087881       1 scheduler.go:530] Attempting to schedule pod: default/<span class="built_in">test</span>-scheduler-6d779d9465-rq2bb</span><br><span class="line">I0104 08:24:22.087992       1 plugins.go:23] prefilter pod: <span class="built_in">test</span>-scheduler-6d779d9465-rq2bb</span><br><span class="line">I0104 08:24:22.088657       1 plugins.go:28] filter pod: <span class="built_in">test</span>-scheduler-6d779d9465-rq2bb, node: ydzs-node1</span><br><span class="line">I0104 08:24:22.088797       1 plugins.go:28] filter pod: <span class="built_in">test</span>-scheduler-6d779d9465-rq2bb, node: ydzs-node2</span><br><span class="line">I0104 08:24:22.088871       1 plugins.go:28] filter pod: <span class="built_in">test</span>-scheduler-6d779d9465-rq2bb, node: ydzs-node3</span><br><span class="line">I0104 08:24:22.088946       1 plugins.go:28] filter pod: <span class="built_in">test</span>-scheduler-6d779d9465-rq2bb, node: ydzs-node4</span><br><span class="line">I0104 08:24:22.088992       1 plugins.go:28] filter pod: <span class="built_in">test</span>-scheduler-6d779d9465-rq2bb, node: ydzs-master</span><br><span class="line">I0104 08:24:22.090653       1 plugins.go:36] prebind node info: &amp;Node&#123;ObjectMeta:&#123;ydzs-node3   /api/v1/nodes/ydzs-node3 1ff6e228-4d98-4737-b6d3-30a5d55ccdc2 15466372 0 2019-11-10 09:05:09 +0000 UTC &lt;nil&gt; &lt;nil&gt; ......&#125;</span><br><span class="line">I0104 08:24:22.091761       1 factory.go:610] Attempting to <span class="built_in">bind</span> <span class="built_in">test</span>-scheduler-6d779d9465-rq2bb to ydzs-node3</span><br><span class="line">I0104 08:24:22.104994       1 scheduler.go:667] pod default/<span class="built_in">test</span>-scheduler-6d779d9465-rq2bb is bound successfully on node <span class="string">"ydzs-node3"</span>, 5 nodes evaluated, 4 nodes were found feasible. Bound node resource: <span class="string">"Capacity: CPU&lt;4&gt;|Memory&lt;8008820Ki&gt;|Pods&lt;110&gt;|StorageEphemeral&lt;17921Mi&gt;; Allocatable: CPU&lt;4&gt;|Memory&lt;7906420Ki&gt;|Pods&lt;110&gt;|StorageEphemeral&lt;16912377419&gt;."</span>.</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°å½“æˆ‘ä»¬åˆ›å»ºå®Œ Pod åï¼Œåœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„è°ƒåº¦å™¨ä¸­å°±å‡ºç°äº†å¯¹åº”çš„æ—¥å¿—ï¼Œå¹¶ä¸”åœ¨æˆ‘ä»¬å®šä¹‰çš„æ‰©å±•ç‚¹ä¸Šé¢éƒ½å‡ºç°äº†å¯¹åº”çš„æ—¥å¿—ï¼Œè¯æ˜æˆ‘ä»¬çš„ç¤ºä¾‹æˆåŠŸäº†ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŸ¥çœ‹ Pod çš„ <code>schedulerName</code> æ¥éªŒè¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line"><span class="built_in">test</span>-scheduler-6d779d9465-rq2bb           1/1     Running   0          22m</span><br><span class="line">$ kubectl get pod <span class="built_in">test</span>-scheduler-6d779d9465-rq2bb -o yaml</span><br><span class="line">......</span><br><span class="line">restartPolicy: Always</span><br><span class="line">schedulerName: sample-scheduler</span><br><span class="line">securityContext: &#123;&#125;</span><br><span class="line">serviceAccount: default</span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<p>åœ¨æœ€æ–°çš„ Kubernetes v1.17 ç‰ˆæœ¬ä¸­ï¼Œ<code>Scheduler Framework</code> å†…ç½®çš„é¢„é€‰å’Œä¼˜é€‰å‡½æ•°å·²ç»å…¨éƒ¨æ’ä»¶åŒ–ï¼Œæ‰€ä»¥è¦æ‰©å±•è°ƒåº¦å™¨æˆ‘ä»¬åº”è¯¥æŒæ¡å¹¶ç†è§£è°ƒåº¦æ¡†æ¶è¿™ç§æ–¹å¼ã€‚</p>
<p>å‚è€ƒï¼šæ˜é˜³çš„åšå®¢</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[k8s v1.17 æ–°å¢æ‹“æ‰‘æ„ŸçŸ¥æœåŠ¡è·¯ç”±]]></title>
      <url>http://team.jiunile.com/blog/2020/05/k8s-service-topology.html</url>
      <content type="html"><![CDATA[<h2 id="åè¯è§£é‡Š"><a href="#åè¯è§£é‡Š" class="headerlink" title="åè¯è§£é‡Š"></a>åè¯è§£é‡Š</h2><ul>
<li><code>æ‹“æ‰‘åŸŸ</code>: è¡¨ç¤ºåœ¨é›†ç¾¤ä¸­çš„æŸä¸€ç±» â€œåœ°æ–¹â€ï¼Œæ¯”å¦‚æŸèŠ‚ç‚¹ã€æŸæœºæ¶ã€æŸå¯ç”¨åŒºæˆ–æŸåœ°åŸŸç­‰ï¼Œè¿™äº›éƒ½å¯ä»¥ä½œä¸ºæŸç§æ‹“æ‰‘åŸŸã€‚</li>
<li><code>endpoint</code>: k8s æŸä¸ªæœåŠ¡çš„æŸä¸ª ip+portï¼Œé€šå¸¸æ˜¯ pod çš„ ip+portã€‚</li>
<li><code>service</code>: k8s çš„ service èµ„æº(æœåŠ¡)ï¼Œå…³è”ä¸€ç»„ endpoint ï¼Œè®¿é—® service ä¼šè¢«è½¬å‘åˆ°å…³è”çš„æŸä¸ª endpoint ä¸Šã€‚</li>
</ul>
<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>æ‹“æ‰‘æ„ŸçŸ¥æœåŠ¡è·¯ç”±ï¼Œæ­¤ç‰¹æ€§æœ€åˆç”±æœå†›å¤§ä½¬æå‡ºå¹¶è®¾è®¡ã€‚ä¸ºä»€ä¹ˆè¦è®¾è®¡æ­¤ç‰¹æ€§å‘¢ï¼Ÿæƒ³è±¡ä¸€ä¸‹ï¼Œk8s é›†ç¾¤èŠ‚ç‚¹åˆ†å¸ƒåœ¨ä¸åŒçš„åœ°æ–¹ï¼Œservice å¯¹åº”çš„ endpoints åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ï¼Œä¼ ç»Ÿè½¬å‘ç­–ç•¥ä¼šå¯¹æ‰€æœ‰ endpoint åšè´Ÿè½½å‡è¡¡ï¼Œé€šå¸¸ä¼šç­‰æ¦‚ç‡è½¬å‘ï¼Œå½“è®¿é—® service æ—¶ï¼Œæµé‡å°±å¯èƒ½è¢«åˆ†æ•£æ‰“åˆ°è¿™äº›ä¸åŒçš„åœ°æ–¹ã€‚è™½ç„¶ service è½¬å‘åšäº†è´Ÿè½½å‡è¡¡ï¼Œä½†å¦‚æœ endpoint è·ç¦»æ¯”è¾ƒè¿œï¼Œæµé‡è½¬å‘è¿‡å»ç½‘ç»œæ—¶å»¶å°±ç›¸å¯¹æ¯”è¾ƒé«˜ï¼Œä¼šå½±å“ç½‘ç»œæ€§èƒ½ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ç”šè‡³è¿˜å¯èƒ½ä¼šä»˜å‡ºé¢å¤–çš„æµé‡è´¹ç”¨ã€‚è¦æ˜¯å¦‚èƒ½å®ç° service å°±è¿‘è½¬å‘ endpointï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥å®ç°é™ä½ç½‘ç»œæ—¶å»¶ï¼Œæå‡ç½‘ç»œæ€§èƒ½äº†å‘¢ï¼Ÿæ˜¯çš„ï¼è¿™ä¹Ÿæ­£æ˜¯è¯¥ç‰¹æ€§æ‰€æå‡ºçš„ç›®çš„å’Œæ„ä¹‰ã€‚<br><a id="more"></a></p>
<h2 id="k8s-äº²å’Œæ€§"><a href="#k8s-äº²å’Œæ€§" class="headerlink" title="k8s äº²å’Œæ€§"></a>k8s äº²å’Œæ€§</h2><p>service çš„å°±è¿‘è½¬å‘å®é™…å°±æ˜¯ä¸€ç§ç½‘ç»œçš„äº²å’Œæ€§ï¼Œå€¾å‘äºè½¬å‘åˆ°ç¦»è‡ªå·±æ¯”è¾ƒè¿‘çš„ endpointã€‚åœ¨æ­¤ç‰¹æ€§ä¹‹å‰ï¼Œå·²ç»åœ¨è°ƒåº¦å’Œå­˜å‚¨æ–¹é¢æœ‰ä¸€äº›äº²å’Œæ€§çš„è®¾è®¡ä¸å®ç°:</p>
<ul>
<li><code>èŠ‚ç‚¹äº²å’Œæ€§ (Node Affinity)</code>: è®© Pod è¢«è°ƒåº¦åˆ°ç¬¦åˆä¸€äº›æœŸæœ›æ¡ä»¶çš„ Node ä¸Šï¼Œæ¯”å¦‚é™åˆ¶è°ƒåº¦åˆ°æŸä¸€å¯ç”¨åŒºï¼Œæˆ–è€…è¦æ±‚èŠ‚ç‚¹æ”¯æŒ GPUï¼Œè¿™ç®—æ˜¯è°ƒåº¦äº²å’Œï¼Œè°ƒåº¦ç»“æœå–å†³äºèŠ‚ç‚¹å±æ€§ã€‚</li>
<li><code>Pod äº²å’Œæ€§ä¸åäº²å’Œæ€§ (Pod Affinity/AntiAffinity)</code>: è®©ä¸€ç»„ Pod è°ƒåº¦åˆ°åŒä¸€æ‹“æ‰‘åŸŸçš„èŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…æ‰“æ•£åˆ°ä¸åŒæ‹“æ‰‘åŸŸçš„èŠ‚ç‚¹ï¼Œ è¿™ä¹Ÿç®—æ˜¯è°ƒåº¦äº²å’Œï¼Œè°ƒåº¦ç»“æœå–å†³äºå…¶å®ƒ Podã€‚</li>
<li><code>æ•°æ®å·æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦ (Volume Topology-aware Scheduling)</code>: è®© Pod åªè¢«è°ƒåº¦åˆ°ç¬¦åˆå…¶ç»‘å®šçš„å­˜å‚¨æ‰€åœ¨æ‹“æ‰‘åŸŸçš„èŠ‚ç‚¹ä¸Šï¼Œè¿™ç®—æ˜¯è°ƒåº¦ä¸å­˜å‚¨çš„äº²å’Œï¼Œè°ƒåº¦ç»“æœå–å†³äºå­˜å‚¨çš„æ‹“æ‰‘åŸŸã€‚</li>
<li><code>æœ¬åœ°æ•°æ®å· (Local Persistent Volume)</code>: è®© Pod ä½¿ç”¨æœ¬åœ°æ•°æ®å·ï¼Œæ¯”å¦‚é«˜æ€§èƒ½ SSDï¼Œåœ¨æŸäº›éœ€è¦é«˜ IOPS ä½æ—¶å»¶çš„åœºæ™¯å¾ˆæœ‰ç”¨ï¼Œå®ƒè¿˜ä¼šä¿è¯ Pod å§‹ç»ˆè¢«è°ƒåº¦åˆ°åŒä¸€èŠ‚ç‚¹ï¼Œæ•°æ®å°±ä¸ä¼šä¸ä¸¢å¤±ï¼Œè¿™ä¹Ÿç®—æ˜¯è°ƒåº¦ä¸å­˜å‚¨çš„äº²å’Œï¼Œè°ƒåº¦ç»“æœå–å†³äºå­˜å‚¨æ‰€åœ¨èŠ‚ç‚¹ã€‚</li>
<li><code>æ•°æ®å·æ‹“æ‰‘æ„ŸçŸ¥åŠ¨æ€åˆ›å»º (Topology-Aware Volume Dynamic Provisioning)</code>: å…ˆè°ƒåº¦ Podï¼Œå†æ ¹æ® Pod æ‰€åœ¨èŠ‚ç‚¹çš„æ‹“æ‰‘åŸŸæ¥åˆ›å»ºå­˜å‚¨ï¼Œè¿™ç®—æ˜¯å­˜å‚¨ä¸è°ƒåº¦çš„äº²å’Œï¼Œå­˜å‚¨çš„åˆ›å»ºå–å†³äºè°ƒåº¦çš„ç»“æœã€‚</li>
</ul>
<p>è€Œ k8s ç›®å‰åœ¨ç½‘ç»œæ–¹é¢è¿˜æ²¡æœ‰äº²å’Œæ€§èƒ½åŠ›ï¼Œæ‹“æ‰‘æ„ŸçŸ¥æœåŠ¡è·¯ç”±è¿™ä¸ªæ–°ç‰¹æ€§æ°å¥½å¯ä»¥è¡¥é½è¿™ä¸ªçš„ç©ºç¼ºï¼Œæ­¤ç‰¹æ€§ä½¿å¾— service å¯ä»¥å®ç°å°±è¿‘è½¬å‘è€Œä¸æ˜¯æ‰€æœ‰ endpoint ç­‰æ¦‚ç‡è½¬å‘ã€‚</p>
<h2 id="å¦‚ä½•å®ç°"><a href="#å¦‚ä½•å®ç°" class="headerlink" title="å¦‚ä½•å®ç°"></a>å¦‚ä½•å®ç°</h2><p>æˆ‘ä»¬çŸ¥é“ï¼Œservice è½¬å‘ä¸»è¦æ˜¯ node ä¸Šçš„ kube-proxy è¿›ç¨‹é€šè¿‡ watch apiserver è·å– service å¯¹åº”çš„ endpointï¼Œå†å†™å…¥ iptables æˆ– ipvs è§„åˆ™æ¥å®ç°çš„; å¯¹äº headless serviceï¼Œä¸»è¦æ˜¯é€šè¿‡ kube-dns æˆ– coredns åŠ¨æ€è§£æåˆ°ä¸åŒ endpoint ip æ¥å®ç°çš„ã€‚å®ç° service å°±è¿‘è½¬å‘çš„å…³é”®ç‚¹å°±åœ¨äºå¦‚ä½•å°†æµé‡è½¬å‘åˆ°è·Ÿå½“å‰èŠ‚ç‚¹åœ¨åŒä¸€æ‹“æ‰‘åŸŸçš„ endpoint ä¸Šï¼Œä¹Ÿå°±æ˜¯ä¼šè¿›è¡Œä¸€æ¬¡ endpoint ç­›é€‰ï¼Œé€‰å‡ºä¸€éƒ¨åˆ†ç¬¦åˆå½“å‰èŠ‚ç‚¹æ‹“æ‰‘åŸŸçš„ endpoint è¿›è¡Œè½¬å‘ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ endpoint è·Ÿå½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨åŒä¸€æ‹“æ‰‘åŸŸé‡Œå‘¢ï¼Ÿåªè¦èƒ½è·å–åˆ° endpoint çš„æ‹“æ‰‘ä¿¡æ¯ï¼Œç”¨å®ƒè·Ÿå½“å‰èŠ‚ç‚¹æ‹“æ‰‘å¯¹æ¯”ä¸‹å°±å¯ä»¥çŸ¥é“äº†ã€‚é‚£åˆå¦‚ä½•è·å– endpoint çš„æ‹“æ‰‘ä¿¡æ¯å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡ endpoint æ‰€åœ¨èŠ‚ç‚¹çš„ labelï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ node label æ¥æè¿°æ‹“æ‰‘åŸŸã€‚</p>
<p>é€šå¸¸åœ¨èŠ‚ç‚¹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œcontroller-manager å°±ä¼šä¸ºèŠ‚ç‚¹æ‰“ä¸Šè®¸å¤š labelï¼Œæ¯”å¦‚ <code>kubernetes.io/hostname</code> è¡¨ç¤ºèŠ‚ç‚¹çš„ hostname æ¥åŒºåˆ†èŠ‚ç‚¹ï¼›å¦å¤–ï¼Œåœ¨äº‘å‚å•†æä¾›çš„ k8s æœåŠ¡ï¼Œæˆ–è€…ä½¿ç”¨ cloud-controller-manager çš„è‡ªå»ºé›†ç¾¤ï¼Œé€šå¸¸è¿˜ä¼šç»™èŠ‚ç‚¹æ‰“ä¸Š <code>failure-domain.beta.kubernetes.io/zone</code> å’Œ <code>failure-domain.beta.kubernetes.io/region</code> ä»¥åŒºåˆ†èŠ‚ç‚¹æ‰€åœ¨å¯ç”¨åŒºå’Œæ‰€åœ¨åœ°åŸŸï¼Œä½†è‡ª v1.17 å¼€å§‹å°†ä¼šæ”¹åæˆ <code>topology.kubernetes.io/zone</code> å’Œ <code>topology.kubernetes.io/region</code>ï¼Œå‚è§ <a href="https://github.com/kubernetes/kubernetes/pull/81431" target="_blank" rel="external">PR #81431</a>ã€‚</p>
<p>å¦‚ä½•æ ¹æ® endpoint æŸ¥åˆ°å®ƒæ‰€åœ¨èŠ‚ç‚¹çš„è¿™äº› label å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡ <code>Endpoint Slice</code>ï¼Œè¯¥ç‰¹æ€§åœ¨ v1.16 å‘å¸ƒäº† alphaï¼Œåœ¨ v1.17 å°†ä¼šè¿›å…¥ betaï¼Œå®ƒç›¸å½“äº Endpoint API å¢å¼ºç‰ˆï¼Œé€šè¿‡å°† endpoint åšæ•°æ®åˆ†ç‰‡æ¥è§£å†³å¤§è§„æ¨¡ endpoint çš„æ€§èƒ½é—®é¢˜ï¼Œå¹¶ä¸”å¯ä»¥æºå¸¦æ›´å¤šçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ endpoint æ‰€åœ¨èŠ‚ç‚¹çš„æ‹“æ‰‘ä¿¡æ¯ï¼Œæ‹“æ‰‘æ„ŸçŸ¥æœåŠ¡è·¯ç”±ç‰¹æ€§ä¼šé€šè¿‡ <code>Endpoint Slice</code> è·å–è¿™äº›æ‹“æ‰‘ä¿¡æ¯å®ç° endpoint ç­›é€‰ (è¿‡æ»¤å‡ºåœ¨åŒä¸€æ‹“æ‰‘åŸŸçš„ endpoint)ï¼Œç„¶åå†è½¬æ¢ä¸º iptables æˆ– ipvs è§„åˆ™å†™å…¥èŠ‚ç‚¹ä»¥å®ç°æ‹“æ‰‘æ„ŸçŸ¥çš„è·¯ç”±è½¬å‘ã€‚</p>
<p>ç»†å¿ƒçš„ä½ å¯èƒ½å·²ç»å‘ç°ï¼Œä¹‹å‰æ¯ä¸ªèŠ‚ç‚¹ä¸Šè½¬å‘ service çš„ iptables/ipvs è§„åˆ™åŸºæœ¬æ˜¯ä¸€æ ·çš„ï¼Œä½†å¯ç”¨äº†æ‹“æ‰‘æ„ŸçŸ¥æœåŠ¡è·¯ç”±ç‰¹æ€§ä¹‹åï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„è½¬å‘è§„åˆ™å°±å¯èƒ½ä¸ä¸€æ ·äº†ï¼Œå› ä¸ºä¸åŒèŠ‚ç‚¹çš„æ‹“æ‰‘ä¿¡æ¯ä¸ä¸€æ ·ï¼Œå¯¼è‡´è¿‡æ»¤å‡ºçš„ endpoint å°±ä¸ä¸€æ ·ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºè¿™æ ·ï¼Œservice è½¬å‘å˜å¾—ä¸å†ç­‰æ¦‚ç‡ï¼Œçµæ´»çš„å°±è¿‘è½¬å‘æ‰å¾—ä»¥å®ç°ã€‚</p>
<p>å½“å‰è¿˜ä¸æ”¯æŒ headless service çš„æ‹“æ‰‘è·¯ç”±ï¼Œè®¡åˆ’åœ¨ beta é˜¶æ®µæ”¯æŒã€‚ç”±äº <a href="https://zhuanlan.zhihu.com/p/54153164" target="_blank" rel="external">headless service</a> ä¸æ˜¯é€šè¿‡ kube-proxy ç”Ÿæˆè½¬å‘è§„åˆ™ï¼Œè€Œæ˜¯é€šè¿‡ dns åŠ¨æ€è§£æå®ç°çš„ï¼Œæ‰€ä»¥éœ€è¦æ”¹ kube-dns/coredns æ¥æ”¯æŒè¿™ä¸ªç‰¹æ€§ã€‚</p>
<h2 id="å‰ææ¡ä»¶"><a href="#å‰ææ¡ä»¶" class="headerlink" title="å‰ææ¡ä»¶"></a>å‰ææ¡ä»¶</h2><p>å¯ç”¨å½“å‰ alpha å®ç°çš„æ‹“æ‰‘æ„ŸçŸ¥æœåŠ¡è·¯ç”±ç‰¹æ€§éœ€è¦æ»¡è¶³ä»¥ä¸‹å‰ææ¡ä»¶:</p>
<ul>
<li>é›†ç¾¤ç‰ˆæœ¬åœ¨ v1.17 åŠå…¶ä»¥ä¸Šã€‚</li>
<li>Kube-proxy ä»¥ iptables æˆ– IPVS æ¨¡å¼è¿è¡Œ (alpha é˜¶æ®µæš‚æ—¶åªå®ç°äº†è¿™ä¸¤ç§æ¨¡å¼)ã€‚</li>
<li>å¯ç”¨äº† <a href="https://kubernetes.io/docs/concepts/services-networking/endpoint-slices/" target="_blank" rel="external">Endpoint Slices</a> (æ­¤ç‰¹æ€§è™½ç„¶åœ¨ v1.17 è¿›å…¥ betaï¼Œä½†æ²¡æœ‰é»˜è®¤å¼€å¯)ã€‚</li>
</ul>
<h2 id="å¦‚ä½•å¯ç”¨æ­¤ç‰¹æ€§"><a href="#å¦‚ä½•å¯ç”¨æ­¤ç‰¹æ€§" class="headerlink" title="å¦‚ä½•å¯ç”¨æ­¤ç‰¹æ€§"></a>å¦‚ä½•å¯ç”¨æ­¤ç‰¹æ€§</h2><p>ç»™æ‰€æœ‰ k8s ç»„ä»¶æ‰“å¼€ <code>ServiceTopology</code> å’Œ <code>EndpointSlice</code> è¿™ä¸¤ä¸ª feature:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--feature-gates=<span class="string">"ServiceTopology=true,EndpointSlice=true"</span></span><br></pre></td></tr></table></figure></p>
<h2 id="å¦‚ä½•ä½¿ç”¨"><a href="#å¦‚ä½•ä½¿ç”¨" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h2><p>åœ¨ Service spec é‡ŒåŠ ä¸Š <code>topologyKeys</code> å­—æ®µï¼Œè¡¨ç¤ºè¯¥ Service ä¼˜å…ˆé¡ºåºé€‰ç”¨çš„æ‹“æ‰‘åŸŸåˆ—è¡¨ï¼Œå¯¹åº”èŠ‚ç‚¹æ ‡ç­¾çš„ keyï¼›å½“è®¿é—®æ­¤ Service æ—¶ï¼Œä¼šæ‰¾æ˜¯å¦æœ‰ endpoint æœ‰å¯¹åº” topology key çš„æ‹“æ‰‘ä¿¡æ¯å¹¶ä¸” value è·Ÿå½“å‰èŠ‚ç‚¹ä¹Ÿä¸€æ ·ï¼Œå¦‚æœæ˜¯ï¼Œé‚£å°±é€‰å®šæ­¤ topology key ä½œä¸ºå½“å‰è½¬å‘çš„æ‹“æ‰‘åŸŸï¼Œå¹¶ä¸”ç­›é€‰å‡ºå…¶ä½™æ‰€æœ‰åœ¨è¿™ä¸ªæ‹“æ‰‘åŸŸçš„ endpoint æ¥è¿›è¡Œè½¬å‘ï¼›å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½• endpoint åœ¨å½“å‰ topology key å¯¹åº”æ‹“æ‰‘åŸŸï¼Œå°±ä¼šå°è¯•ç¬¬äºŒä¸ª topology keyï¼Œä¾æ­¤ç±»æ¨ï¼›å¦‚æœéå†å®Œæ‰€æœ‰ topology key ä¹Ÿæ²¡æœ‰åŒ¹é…åˆ° endpoint å°±ä¼šæ‹’ç»è½¬å‘ï¼Œå°±åƒæ­¤ service æ²¡æœ‰åç«¯ endpoint ä¸€æ ·ã€‚</p>
<p>æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ topology key â€œ<code>*</code>â€ï¼Œå®ƒå¯ä»¥åŒ¹é…æ‰€æœ‰ endpointï¼Œå¦‚æœ <code>topologyKeys</code> åŒ…å«äº† <code>*</code>ï¼Œå®ƒå¿…é¡»åœ¨åˆ—è¡¨æœ«å°¾ï¼Œé€šå¸¸æ˜¯åœ¨æ²¡æœ‰åŒ¹é…åˆ°åˆé€‚çš„æ‹“æ‰‘åŸŸæ¥å®ç°å°±è¿‘è½¬å‘æ—¶ï¼Œå°±æ‰“æ¶ˆå°±è¿‘è½¬å‘çš„å¿µå¤´ï¼Œå¯ä»¥è½¬å‘åˆ°ä»»æ„ endpoint ä¸Šã€‚</p>
<p>å½“å‰ topology key æ”¯æŒä»¥ä¸‹å¯èƒ½çš„å€¼ï¼ˆæœªæ¥ä¼šå¢åŠ æ›´å¤šï¼‰:</p>
<ul>
<li><code>kubernetes.io/hostname</code>: èŠ‚ç‚¹çš„ hostnameï¼Œé€šå¸¸å°†å®ƒæ”¾åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªï¼Œè¡¨ç¤ºå¦‚æœæœ¬æœºæœ‰ endpoint å°±ç›´æ¥è½¬å‘åˆ°æœ¬æœºçš„ endpointã€‚</li>
<li><code>topology.kubernetes.io/zone</code>: èŠ‚ç‚¹æ‰€åœ¨çš„å¯ç”¨åŒºï¼Œé€šå¸¸å°†å®ƒæ”¾åœ¨ <code>kubernetes.io/hostname</code> åé¢ï¼Œè¡¨ç¤ºå¦‚æœæœ¬æœºæ²¡æœ‰å¯¹åº” endpointï¼Œå°±è½¬å‘åˆ°å½“å‰å¯ç”¨åŒºå…¶å®ƒèŠ‚ç‚¹ä¸Šçš„ endpointï¼ˆéƒ¨åˆ†äº‘å‚å•†è·¨å¯ç”¨åŒºé€šä¿¡ä¼šæ”¶å–é¢å¤–çš„æµé‡è´¹ç”¨ï¼‰ã€‚</li>
<li><code>topology.kubernetes.io/region</code>: è¡¨ç¤ºèŠ‚ç‚¹æ‰€åœ¨çš„åœ°åŸŸï¼Œè¡¨ç¤ºè½¬å‘åˆ°å½“å‰åœ°åŸŸçš„ endpointï¼Œè¿™ä¸ªç”¨çš„åº”è¯¥ä¼šæ¯”è¾ƒå°‘ï¼Œå› ä¸ºé€šå¸¸é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹éƒ½åªä¼šåœ¨åŒä¸€ä¸ªåœ°åŸŸï¼Œå¦‚æœèŠ‚ç‚¹è·¨åœ°åŸŸäº†ï¼ŒèŠ‚ç‚¹ä¹‹é—´é€šä¿¡å»¶æ—¶å°†ä¼šå¾ˆé«˜ã€‚</li>
<li><code>*</code>: å¿½ç•¥æ‹“æ‰‘åŸŸï¼ŒåŒ¹é…æ‰€æœ‰ endpointï¼Œç›¸å½“äºä¸€ä¸ªä¿åº•ç­–ç•¥ï¼Œé¿å…ä¸¢åŒ…ï¼Œåªèƒ½æ”¾åœ¨åˆ—è¡¨æœ«å°¾ã€‚</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹çº¦æŸ:</p>
<ul>
<li><code>topologyKeys</code> ä¸ <code>externalTrafficPolicy=Local</code> ä¸å…¼å®¹ï¼Œæ˜¯äº’æ–¥çš„ï¼Œå¦‚æœ <code>externalTrafficPolicy</code> ä¸º <code>Local</code>ï¼Œå°±ä¸èƒ½å®šä¹‰ <code>topologyKeys</code>ï¼Œåä¹‹äº¦ç„¶ã€‚</li>
<li>topology key å¿…é¡»æ˜¯åˆæ³•çš„ label æ ¼å¼ï¼Œå¹¶ä¸”æœ€å¤šå®šä¹‰ 16 ä¸ª keyã€‚</li>
</ul>
<p>è¿™é‡Œç»™å‡ºä¸€ä¸ªç®€å•çš„ Service ç¤ºä¾‹:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Service</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> nginx</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> ClusterIP</span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> http</span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    protocol:</span> TCP</span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> nginx</span><br><span class="line"><span class="attr">  topologyKeys:</span> [<span class="string">"kubernetes.io/hostname"</span>, <span class="string">"topology.kubernetes.io/zone"</span>, <span class="string">"*"</span>]</span><br></pre></td></tr></table></figure></p>
<p>è§£é‡Š: å½“è®¿é—® nginx æœåŠ¡æ—¶ï¼Œé¦–å…ˆçœ‹æœ¬æœºæ˜¯å¦æœ‰è¿™ä¸ªæœåŠ¡çš„ endpointï¼Œå¦‚æœæœ‰å°±ç›´æ¥æœ¬æœºè·¯ç”±è¿‡å»ï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±çœ‹æ˜¯å¦æœ‰ endpoint ä½äºå½“å‰èŠ‚ç‚¹æ‰€åœ¨å¯ç”¨åŒºï¼Œå¦‚æœæœ‰ï¼Œå°±è½¬å‘è¿‡å»ï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œå°±è½¬å‘ç»™ä»»æ„ endpointã€‚<br><img src="/images/k8s/service-topology.png" alt="service-topology"></p>
<p>ä¸Šå›¾å°±æ˜¯å…¶ä¸­ä¸€æ¬¡è½¬å‘çš„ä¾‹å­ï¼šPod è®¿é—® nginx è¿™ä¸ª service æ—¶ï¼Œå‘ç°æœ¬æœºæ²¡æœ‰ endpointï¼Œå°±æ‰¾å½“å‰å¯ç”¨åŒºçš„ï¼Œæ‰¾åˆ°äº†å°±è½¬å‘è¿‡å»ï¼Œä¹Ÿå°±ä¸ä¼šè€ƒè™‘è½¬å‘ç»™å¦ä¸€å¯ç”¨åŒºçš„ endpointã€‚</p>
<p>å‚è€ƒï¼šimroc</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ä½¿ç”¨NodeLocal DNSCacheæ¥æå‡CoreDNSçš„æ€§èƒ½åŠå‹åŠ›]]></title>
      <url>http://team.jiunile.com/blog/2020/05/k8s-nodelocal-dnscache.html</url>
      <content type="html"><![CDATA[<h2 id="æ¦‚å†µ"><a href="#æ¦‚å†µ" class="headerlink" title="æ¦‚å†µ"></a>æ¦‚å†µ</h2><p>ä¹‹å‰åœ¨è§£å†³ CoreDNS çš„5ç§’è¶…æ—¶é—®é¢˜çš„æ—¶å€™ï¼Œé™¤äº†é€šè¿‡ <code>dnsConfig</code> å»å¼ºåˆ¶ä½¿ç”¨ tcp æ–¹å¼è§£æä¹‹å¤–ï¼Œæˆ‘ä»¬æåˆ°è¿‡ä½¿ç”¨ <code>NodeLocal DNSCache</code> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚<code>NodeLocal DNSCache</code> é€šè¿‡åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª DaemonSet æ¥æé«˜ clusterDNS æ€§èƒ½å’Œå¯é æ€§ã€‚å¤„äº <code>ClusterFirst</code> çš„ DNS æ¨¡å¼ä¸‹çš„ Pod å¯ä»¥è¿æ¥åˆ° <code>kube-dns</code> çš„ serviceIP è¿›è¡Œ DNS æŸ¥è¯¢ã€‚é€šè¿‡ <code>kube-proxy</code> ç»„ä»¶æ·»åŠ çš„ <code>iptables</code> è§„åˆ™å°†å…¶è½¬æ¢ä¸º <code>CoreDNS</code> ç«¯ç‚¹ã€‚é€šè¿‡åœ¨æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šè¿è¡Œ DNS ç¼“å­˜ï¼Œ<code>NodeLocal DNSCache</code> å¯ä»¥ç¼©çŸ­ DNS æŸ¥æ‰¾çš„å»¶è¿Ÿæ—¶é—´ã€ä½¿ DNS æŸ¥æ‰¾æ—¶é—´æ›´åŠ ä¸€è‡´ï¼Œä»¥åŠå‡å°‘å‘é€åˆ° <code>kube-dns</code> çš„ DNS æŸ¥è¯¢æ¬¡æ•°ã€‚</p>
<p>åœ¨é›†ç¾¤ä¸­è¿è¡Œ NodeLocal DNSCache æœ‰å¦‚ä¸‹å‡ ä¸ªå¥½å¤„ï¼š</p>
<ul>
<li>å¦‚æœæœ¬åœ°æ²¡æœ‰ CoreDNS å®ä¾‹ï¼Œåˆ™å…·æœ‰æœ€é«˜ DNS QPS çš„ Pod å¯èƒ½å¿…é¡»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œè§£æï¼Œä½¿ç”¨ NodeLocal DNSCache åï¼Œæ‹¥æœ‰æœ¬åœ°ç¼“å­˜å°†æœ‰åŠ©äºæ”¹å–„å»¶è¿Ÿ</li>
<li>è·³è¿‡ iptables DNAT å’Œè¿æ¥è·Ÿè¸ªå°†æœ‰åŠ©äºå‡å°‘ <code>conntrack</code> ç«äº‰å¹¶é¿å… UDP DNS æ¡ç›®å¡«æ»¡ <code>conntrack</code> è¡¨ï¼ˆå¸¸è§çš„5sè¶…æ—¶é—®é¢˜å°±æ˜¯è¿™ä¸ªåŸå› é€ æˆçš„ï¼‰</li>
<li>ä»æœ¬åœ°ç¼“å­˜ä»£ç†åˆ° kube-dns æœåŠ¡çš„è¿æ¥å¯ä»¥å‡çº§åˆ° TCPï¼ŒTCP conntrack æ¡ç›®å°†åœ¨è¿æ¥å…³é—­æ—¶è¢«åˆ é™¤ï¼Œè€Œ UDP æ¡ç›®å¿…é¡»è¶…æ—¶(<a href="https://www.kernel.org/doc/Documentation/networking/nf_conntrack-sysctl.txt" target="_blank" rel="external">é»˜è®¤ nf_conntrack_udp_timeout æ˜¯ 30 ç§’</a>)</li>
<li>å°† DNS æŸ¥è¯¢ä» UDP å‡çº§åˆ° TCP å°†å‡å°‘å½’å› äºä¸¢å¼ƒçš„ UDP æ•°æ®åŒ…å’Œ DNS è¶…æ—¶çš„å°¾éƒ¨ç­‰å¾…æ—¶é—´ï¼Œé€šå¸¸é•¿è¾¾ 30 ç§’ï¼ˆ3 æ¬¡é‡è¯•+ 10 ç§’è¶…æ—¶ï¼‰</li>
</ul>
<a id="more"></a>
<p><img src="/images/k8s/dnscache.png" alt="NodeLocal DNSCache"></p>
<h2 id="å®‰è£…ä½¿ç”¨"><a href="#å®‰è£…ä½¿ç”¨" class="headerlink" title="å®‰è£…ä½¿ç”¨"></a>å®‰è£…ä½¿ç”¨</h2><p>è¦å®‰è£… NodeLocal DNSCache ä¹Ÿéå¸¸ç®€å•ï¼Œç›´æ¥è·å–å®˜æ–¹çš„èµ„æºæ¸…å•å³å¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/kubernetes/kubernetes/raw/master/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml</span><br></pre></td></tr></table></figure></p>
<p>è¯¥èµ„æºæ¸…å•æ–‡ä»¶ä¸­åŒ…å«å‡ ä¸ªå˜é‡ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li><code>__PILLAR__DNS__SERVER__</code> ï¼šè¡¨ç¤º <code>kube-dns</code> è¿™ä¸ª Service çš„ ClusterIPï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ <code>kubectl get svc -n kube-system | grep kube-dns | awk &#39;{ print $3 }&#39;</code> è·å–ã€‚</li>
<li><code>__PILLAR__LOCAL__DNS__</code>ï¼šè¡¨ç¤º DNSCache æœ¬åœ°çš„ IPï¼Œé»˜è®¤ä¸º 169.254.20.10</li>
<li><code>__PILLAR__DNS__DOMAIN__</code>ï¼šè¡¨ç¤ºé›†ç¾¤åŸŸï¼Œé»˜è®¤å°±æ˜¯ cluster.local</li>
</ul>
<p>å¦å¤–è¿˜æœ‰ä¸¤ä¸ªå‚æ•° <code>__PILLAR__CLUSTER__DNS__</code> å’Œ <code>__PILLAR__UPSTREAM__SERVERS__</code>ï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä¼šé€šè¿‡é•œåƒ 1.15.6 ç‰ˆæœ¬ä»¥ä¸Šçš„å»è¿›è¡Œé…ç½®ï¼Œå¯¹åº”çš„å€¼æ¥æºäº kube-dns çš„ ConfigMap å’Œå®šåˆ¶çš„ Upstream Server é…ç½®ã€‚ç›´æ¥æ‰§è¡Œå¦‚ä¸‹æ‰€ç¤ºçš„å‘½ä»¤å³å¯å®‰è£…ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="string">'s/k8s.gcr.io/cnych/g</span><br><span class="line">s/__PILLAR__DNS__SERVER__/10.96.0.10/g</span><br><span class="line">s/__PILLAR__LOCAL__DNS__/169.254.20.10/g</span><br><span class="line">s/__PILLAR__DNS__DOMAIN__/cluster.local/g'</span> nodelocaldns.yaml |</span><br><span class="line">kubectl apply <span class="_">-f</span> -</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹å¯¹åº”çš„ Pod æ˜¯å¦å·²ç»å¯åŠ¨æˆåŠŸï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system | grep node-local-dns</span><br><span class="line">node-local-dns-8zm2f                    1/1     Running     0          9m54s</span><br><span class="line">node-local-dns-dd4xg                    1/1     Running     0          9m54s</span><br><span class="line">node-local-dns-hs8qq                    1/1     Running     0          9m54s</span><br><span class="line">node-local-dns-pxfxn                    1/1     Running     0          9m54s</span><br><span class="line">node-local-dns-stjm9                    1/1     Running     0          9m54s</span><br><span class="line">node-local-dns-wjxvz                    1/1     Running     0          9m54s</span><br><span class="line">node-local-dns-wn5wc                    1/1     Running     0          7m49s</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œä½¿ç”¨ DaemonSet éƒ¨ç½² node-local-dns ä½¿ç”¨äº† <code>hostNetwork=true</code>ï¼Œä¼šå ç”¨å®¿ä¸»æœºçš„ 8080 ç«¯å£ï¼Œæ‰€ä»¥éœ€è¦ä¿è¯è¯¥ç«¯å£æœªè¢«å ç”¨ã€‚</p>
</blockquote>
<p>ä½†æ˜¯åˆ°è¿™é‡Œè¿˜æ²¡æœ‰å®Œï¼Œå¦‚æœ kube-proxy ç»„ä»¶ä½¿ç”¨çš„æ˜¯ ipvs æ¨¡å¼çš„è¯æˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ kubelet çš„ <code>--cluster-dns</code> å‚æ•°ï¼Œå°†å…¶æŒ‡å‘ <code>169.254.20.10</code>ï¼ŒDaemonset ä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªç½‘å¡æ¥ç»‘è¿™ä¸ª IPï¼ŒPod å‘æœ¬èŠ‚ç‚¹è¿™ä¸ª IP å‘ DNS è¯·æ±‚ï¼Œç¼“å­˜æ²¡æœ‰å‘½ä¸­çš„æ—¶å€™æ‰ä¼šå†ä»£ç†åˆ°ä¸Šæ¸¸é›†ç¾¤ DNS è¿›è¡ŒæŸ¥è¯¢ã€‚ <code>iptables</code> æ¨¡å¼ä¸‹ Pod è¿˜æ˜¯å‘åŸæ¥çš„é›†ç¾¤ DNS è¯·æ±‚ï¼ŒèŠ‚ç‚¹ä¸Šæœ‰è¿™ä¸ª IP ç›‘å¬ï¼Œä¼šè¢«æœ¬æœºæ‹¦æˆªï¼Œå†è¯·æ±‚é›†ç¾¤ä¸Šæ¸¸ DNSï¼Œæ‰€ä»¥ä¸éœ€è¦æ›´æ”¹ <code>--cluster-dns</code> å‚æ•°ã€‚</p>
<h3 id="ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼ä¸€"><a href="#ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼ä¸€" class="headerlink" title="ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼ä¸€"></a>ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼ä¸€</h3><p>ç”±äºæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ kubeadm å®‰è£…çš„ 1.16 ç‰ˆæœ¬çš„é›†ç¾¤ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ›¿æ¢èŠ‚ç‚¹ä¸Š <code>/var/lib/kubelet/config.yaml</code> æ–‡ä»¶ä¸­çš„ <code>clusterDNS</code> è¿™ä¸ªå‚æ•°å€¼ï¼Œç„¶åé‡å¯å³å¯ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i <span class="string">'s/10.96.0.10/169.254.20.10/g'</span> /var/lib/kubelet/config.yaml</span><br><span class="line">$ systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure></p>
<h3 id="ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼äºŒ-ï¼ˆä¸æ¨èï¼‰"><a href="#ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼äºŒ-ï¼ˆä¸æ¨èï¼‰" class="headerlink" title="ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼äºŒ ï¼ˆä¸æ¨èï¼‰"></a>ipvsä½¿ç”¨localDNSä¿®æ”¹æ–¹å¼äºŒ ï¼ˆä¸æ¨èï¼‰</h3><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å®Œå…¨åœ¨å®˜æ–¹çš„ DaemonSet èµ„æºå¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ª initContainer æ¥å®Œæˆè¿™ä¸ªå·¥ä½œã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">initContainers:  <span class="comment"># ipvsæ¨¡å¼ä¸‹éœ€è¦ä¿®æ”¹dnsé…ç½®ï¼Œé‡å¯kubelet</span></span><br><span class="line">  - name: setup</span><br><span class="line">    image: alpine</span><br><span class="line">    tty: <span class="literal">true</span></span><br><span class="line">    stdin: <span class="literal">true</span></span><br><span class="line">    securityContext:</span><br><span class="line">      privileged: <span class="literal">true</span></span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    - nsenter</span><br><span class="line">    - --target</span><br><span class="line">    - <span class="string">"1"</span></span><br><span class="line">    - --mount</span><br><span class="line">    - --uts</span><br><span class="line">    - --ipc</span><br><span class="line">    - --net</span><br><span class="line">    - --pid</span><br><span class="line">    - --</span><br><span class="line">    - bash</span><br><span class="line">    - -c</span><br><span class="line">    - |</span><br><span class="line">      <span class="comment"># ç¡®ä¿ kubelet --cluster-dns è¢«è®¾ç½®ä¸º 169.254.20.10</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"Configuring kubelet --cluster-dns=169.254.20.10"</span></span><br><span class="line">      sed -i <span class="string">'s/10.96.0.10/169.254.20.10/g'</span> /var/lib/kubelet/config.yaml</span><br><span class="line">      systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºçº¿ä¸Šç¯å¢ƒè¿˜æ˜¯ä¸æ¨èç”¨ä¸Šé¢çš„æ–¹å¼ï¼Œå› ä¸ºå®ƒä¼šä¼˜å…ˆå°† kubelet çš„ <code>cluster-dns</code> å‚æ•°è¿›è¡Œä¿®æ”¹ï¼Œç„¶åå†å»å®‰è£… NodeLocalï¼Œè¿™ä¸­é—´æ¯•ç«Ÿæœ‰ä¸€æ®µçœŸç©ºæœŸã€‚</p>
<h2 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h2><p>å¾… <code>node-local-dns</code> å®‰è£…é…ç½®å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥éƒ¨ç½²ä¸€ä¸ªæ–°çš„ Pod æ¥éªŒè¯ä¸‹ï¼š(test-node-local-dns.yaml)<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Pod</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> test-node-local-dns</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> local-dns</span><br><span class="line"><span class="attr">    image:</span> busybox</span><br><span class="line"><span class="attr">    command:</span> [<span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"sleep 60m"</span>]</span><br></pre></td></tr></table></figure></p>
<p>ç›´æ¥éƒ¨ç½²ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply <span class="_">-f</span> <span class="built_in">test</span>-node-local-dns.yaml</span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it <span class="built_in">test</span>-node-local-dns /bin/sh</span><br><span class="line">/ <span class="comment"># cat /etc/resolv.conf</span></span><br><span class="line">nameserver 169.254.20.10</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>nameserver</code> å·²ç»å˜æˆ <code>169.254.20.10</code> äº†ï¼Œå½“ç„¶å¯¹äºä¹‹å‰çš„å†å² Pod è¦æƒ³ä½¿ç”¨ <code>node-local-dns</code> åˆ™éœ€è¦é‡å»ºï¼Œå½“ç„¶å¦‚æœè¦æƒ³å»è·Ÿè¸ª DNS çš„è§£æè¿‡ç¨‹çš„è¯å¯ä»¥å»é€šè¿‡æŠ“åŒ…æ¥è§‚å¯Ÿã€‚</p>
<h2 id="ç•ªå¤–ç¯‡"><a href="#ç•ªå¤–ç¯‡" class="headerlink" title="ç•ªå¤–ç¯‡"></a>ç•ªå¤–ç¯‡</h2><p>åœ¨ä½¿ç”¨äº†<code>NodeLocal DNSCache</code>åï¼Œå¦‚æœåœ¨é…ç½®è‡ªå®šä¹‰åŸŸåï¼Ÿ</p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨ CoreDNS çš„ ConfigMap ä¸­æ·»åŠ  hosts æ’ä»¶ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hosts &#123;</span><br><span class="line">  <span class="number">192.168</span><span class="number">.3</span><span class="number">.211</span> git.k8s.local</span><br><span class="line">  fallthrough</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å…¶æ¬¡æˆ‘ä»¬éœ€è¦ä¿®æ”¹ <code>NodeLocal DNSCache</code> çš„ ConfigMapï¼Œå½“å‰é…ç½®å¦‚ä¸‹ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cluster.local:<span class="number">53</span> &#123;</span><br><span class="line">    errors</span><br><span class="line">    cache &#123;</span><br><span class="line">            success <span class="number">9984</span> <span class="number">30</span></span><br><span class="line">            denial <span class="number">9984</span> <span class="number">5</span></span><br><span class="line">    &#125;</span><br><span class="line">    reload</span><br><span class="line">    loop</span><br><span class="line">    bind <span class="number">169.254</span><span class="number">.20</span><span class="number">.10</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line">    forward . <span class="number">10.96</span><span class="number">.207</span><span class="number">.156</span> &#123;</span><br><span class="line">            force_tcp</span><br><span class="line">    &#125;</span><br><span class="line">    prometheus :<span class="number">9253</span></span><br><span class="line">    health <span class="number">169.254</span><span class="number">.20</span><span class="number">.10</span>:<span class="number">8080</span></span><br><span class="line">    &#125;</span><br><span class="line">in-addr.arpa:<span class="number">53</span> &#123;</span><br><span class="line">    errors</span><br><span class="line">    cache <span class="number">30</span></span><br><span class="line">    reload</span><br><span class="line">    loop</span><br><span class="line">    bind <span class="number">169.254</span><span class="number">.20</span><span class="number">.10</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line">    forward . <span class="number">10.96</span><span class="number">.207</span><span class="number">.156</span> &#123;</span><br><span class="line">            force_tcp</span><br><span class="line">    &#125;</span><br><span class="line">    prometheus :<span class="number">9253</span></span><br><span class="line">    &#125;</span><br><span class="line">ip6.arpa:<span class="number">53</span> &#123;</span><br><span class="line">    errors</span><br><span class="line">    cache <span class="number">30</span></span><br><span class="line">    reload</span><br><span class="line">    loop</span><br><span class="line">    bind <span class="number">169.254</span><span class="number">.20</span><span class="number">.10</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line">    forward . <span class="number">10.96</span><span class="number">.207</span><span class="number">.156</span> &#123;</span><br><span class="line">            force_tcp</span><br><span class="line">    &#125;</span><br><span class="line">    prometheus :<span class="number">9253</span></span><br><span class="line">    &#125;</span><br><span class="line">.:<span class="number">53</span> &#123;</span><br><span class="line">    errors</span><br><span class="line">    cache <span class="number">30</span></span><br><span class="line">    reload</span><br><span class="line">    loop</span><br><span class="line">    bind <span class="number">169.254</span><span class="number">.20</span><span class="number">.10</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line">    forward . /etc/resolv.conf &#123;</span><br><span class="line">            force_tcp</span><br><span class="line">    &#125;</span><br><span class="line">    prometheus :<span class="number">9253</span></span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>åˆ†æä¸Šé¢çš„ LocalDNS çš„é…ç½®ä¿¡æ¯ï¼Œå…¶ä¸­ <code>10.96.0.10</code> ä¸º CoreDNS çš„ Service ClusterIPï¼Œ<code>169.254.20.10</code> ä¸º LocalDNS çš„ IP åœ°å€ï¼Œ<code>10.96.207.156</code> æ˜¯ LocalDNS æ–°å»ºçš„ä¸€ä¸ª Service ClusterIPï¼Œè¯¥ Service å’Œ CoreDNS ä¸€æ ·éƒ½æ˜¯å…³è”ä»¥å‰çš„ CoreDNS çš„ Endpoints åˆ—è¡¨ã€‚</p>
<p>ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç° <code>cluster.local</code>ã€<code>in-addr.arpa</code> ä»¥åŠ <code>ip6.arpa</code> éƒ½ä¼šé€šè¿‡ forward è½¬å‘åˆ° <code>10.96.207.156</code>ï¼Œä¹Ÿå°±æ˜¯å» CoreDNS è§£æï¼Œå…¶ä»–çš„åˆ™æ˜¯ <strong><code>forward . /etc/resolv.conf</code></strong> é€šè¿‡ <code>resolv.conf</code> æ–‡ä»¶å»è§£æï¼Œè¯¥æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver 169.254.20.10</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥å½“æˆ‘ä»¬è§£æåŸŸå <code>git.k8s.local</code> çš„æ—¶å€™éœ€è¦èµ°ä¸€éæœç´¢åŸŸï¼Œè€Œ <code>k8s.local</code> ä¸åœ¨ <code>cluster.local</code>ã€<code>in-addr.arpa</code> ä»¥åŠ <code>ip6.arpa</code> è¿™äº›åŸŸä¸­ï¼Œæ‰€ä»¥å°±ä¼šèµ°åˆ° <code>/etc/resolv.conf</code> å»è§£æã€‚è¿™æ ·å°±ä¼šå¯¼è‡´ <code>git.k8s.local</code> æ— æ³•è¿›è¡Œè§£æã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦æŠŠ <code>forward . /etc/resolv.conf</code> æ›´æ”¹æˆ <code>forward . 10.96.207.156</code>ï¼Œè¿™æ ·å°±ä¼šå» CoreDNS è§£æäº†ï¼Œåœ¨ NodeLocalDNS çš„ ConfigMap ä¸­åšå¦‚ä¸‹çš„ä¿®æ”¹å³å¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit cm node-local-dns -n kube-system</span><br><span class="line">......</span><br><span class="line">.:53 &#123;</span><br><span class="line">    errors</span><br><span class="line">    cache 30</span><br><span class="line">    reload</span><br><span class="line">    loop</span><br><span class="line">    <span class="built_in">bind</span> 169.254.20.10 10.96.0.10</span><br><span class="line">    forward . __PILLAR__CLUSTER__DNS__ &#123;</span><br><span class="line">            force_tcp</span><br><span class="line">    &#125;</span><br><span class="line">    prometheus :9253</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<p>åŒæ ·ä¿®æ”¹å®Œæˆåï¼Œéœ€è¦é‡å»º NodeLocalDNS çš„ Pod æ‰ä¼šç”Ÿæ•ˆã€‚</p>
<blockquote>
<p><code>__PILLAR__CLUSTER__DNS__</code> å’Œ <code>__PILLAR__UPSTREAM__SERVERS__</code> è¿™ä¸¤ä¸ªå‚æ•°åœ¨é•œåƒ 1.15.6 ç‰ˆæœ¬ä»¥ä¸Šä¸­ä¼šè‡ªåŠ¨è¿›è¡Œé…ç½®ï¼Œå¯¹åº”çš„å€¼æ¥æºäº kube-dns çš„ ConfigMap å’Œå®šåˆ¶çš„ Upstream Server åœ°å€ã€‚</p>
</blockquote>
<p>å‚è€ƒï¼šæ˜é˜³çš„åšå®¢</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Go æ€§èƒ½ä¼˜åŒ–å®æˆ˜]]></title>
      <url>http://team.jiunile.com/blog/2020/05/go-performance.html</url>
      <content type="html"><![CDATA[<h2 id="é¡¹ç›®èƒŒæ™¯"><a href="#é¡¹ç›®èƒŒæ™¯" class="headerlink" title="é¡¹ç›®èƒŒæ™¯"></a>é¡¹ç›®èƒŒæ™¯</h2><p>ç½‘å…³æœåŠ¡ä½œä¸ºç»Ÿä¸€æ¥å…¥æœåŠ¡ï¼Œæ˜¯å¤§éƒ¨åˆ†æœåŠ¡çš„ç»Ÿä¸€å…¥å£ã€‚ä¸ºäº†é¿å…æˆåŠŸç“¶é¢ˆï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œå°½å¯èƒ½åœ°ä¼˜åŒ–ã€‚å› æ­¤ï¼Œç‰¹åˆ«æ€»ç»“ä¸€ä¸‹ golang åå°æœåŠ¡æ€§èƒ½ä¼˜åŒ–çš„æ–¹å¼ï¼Œå¹¶å¯¹ç½‘å…³æœåŠ¡è¿›è¡Œä¼˜åŒ–ã€‚</p>
<p>æŠ€æœ¯èƒŒæ™¯ï¼š</p>
<ul>
<li>åŸºäº tarsgo æ¡†æ¶çš„ http æ¥å…¥æœåŠ¡ï¼Œä¸‹æ¸¸æœåŠ¡ä½¿ç”¨ tarsgo åè®®è¿›è¡Œäº¤äº’</li>
</ul>
<h2 id="æ€§èƒ½æŒ‡æ ‡"><a href="#æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="æ€§èƒ½æŒ‡æ ‡"></a>æ€§èƒ½æŒ‡æ ‡</h2><p>ç½‘å…³æœåŠ¡æœ¬èº«æ²¡æœ‰ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œä»…ä½œä¸ºç»Ÿä¸€å…¥å£è¿›è¡Œè¯·æ±‚è½¬å‘ï¼Œå› æ­¤æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸‹åˆ—æŒ‡æ ‡</p>
<ul>
<li>ååé‡ï¼šæ¯ç§’é’Ÿå¯ä»¥å¤„ç†çš„è¯·æ±‚æ•°</li>
<li>å“åº”æ—¶é—´ï¼šä»å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼Œåˆ°æ”¶åˆ°å›åŒ…çš„æ€»è€—æ—¶</li>
</ul>
<h2 id="å®šä½ç“¶é¢ˆ"><a href="#å®šä½ç“¶é¢ˆ" class="headerlink" title="å®šä½ç“¶é¢ˆ"></a>å®šä½ç“¶é¢ˆ</h2><p>ä¸€èˆ¬åå°æœåŠ¡çš„ç“¶é¢ˆä¸»è¦ä¸º CPUï¼Œå†…å­˜ï¼ŒIO æ“ä½œä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªã€‚è‹¥è¿™ä¸‰è€…çš„è´Ÿè½½éƒ½ä¸é«˜ï¼Œä½†ç³»ç»Ÿååé‡ä½ï¼ŒåŸºæœ¬å°±æ˜¯ä»£ç é€»è¾‘å‡ºé—®é¢˜äº†ã€‚</p>
<p>åœ¨ä»£ç æ­£å¸¸è¿è¡Œçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦é’ˆå¯¹æŸä¸ªæ–¹é¢çš„é«˜è´Ÿè½½è¿›è¡Œä¼˜åŒ–ï¼Œæ‰èƒ½æé«˜ç³»ç»Ÿçš„æ€§èƒ½ã€‚golang å¯é€šè¿‡ benchmark åŠ  pprof æ¥å®šä½å…·ä½“çš„æ€§èƒ½ç“¶é¢ˆã€‚</p>
<a id="more"></a>
<h3 id="benchmark-ç®€ä»‹"><a href="#benchmark-ç®€ä»‹" class="headerlink" title="benchmark ç®€ä»‹"></a>benchmark ç®€ä»‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go <span class="built_in">test</span> -v gate_test.go -run=none -bench=. -benchtime=3s -cpuprofile cpu.prof -memprofile mem.prof</span><br></pre></td></tr></table></figure>
<ul>
<li>-run çŸ¥é“å•æ¬¡æµ‹è¯•ï¼Œä¸€èˆ¬ç”¨äºä»£ç é€»è¾‘éªŒè¯</li>
<li>-bench=. æ‰§è¡Œæ‰€æœ‰ Benchmarkï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç”¨ä¾‹å‡½æ•°åæ¥æŒ‡å®šéƒ¨åˆ†æµ‹è¯•ç”¨ä¾‹</li>
<li>-benchtime æŒ‡å®šæµ‹è¯•æ‰§è¡Œæ—¶é•¿</li>
<li>-cpuprofile è¾“å‡º cpu çš„ pprof ä¿¡æ¯æ–‡ä»¶</li>
<li>-memprofile è¾“å‡º heap çš„ pprof ä¿¡æ¯æ–‡ä»¶ã€‚</li>
<li>-blockprofile é˜»å¡åˆ†æï¼Œè®°å½• goroutine é˜»å¡ç­‰å¾…åŒæ­¥ï¼ˆåŒ…æ‹¬å®šæ—¶å™¨é€šé“ï¼‰çš„ä½ç½®</li>
<li>-mutexprofile äº’æ–¥é”åˆ†æï¼ŒæŠ¥å‘Šäº’æ–¥é”çš„ç«äº‰æƒ…å†µ</li>
</ul>
<p><strong>benchmark æµ‹è¯•ç”¨ä¾‹å¸¸ç”¨å‡½æ•°</strong></p>
<ul>
<li>b.ReportAllocs() è¾“å‡ºå•æ¬¡å¾ªç¯ä½¿ç”¨çš„å†…å­˜æ•°é‡å’Œå¯¹è±¡ allocs ä¿¡æ¯</li>
<li>b.RunParallel() ä½¿ç”¨åç¨‹å¹¶å‘æµ‹è¯•</li>
<li>b.SetBytes(n int64) è®¾ç½®å•æ¬¡å¾ªç¯ä½¿ç”¨çš„å†…å­˜æ•°é‡</li>
</ul>
<h3 id="pprof-ç®€ä»‹"><a href="#pprof-ç®€ä»‹" class="headerlink" title="pprof ç®€ä»‹"></a>pprof ç®€ä»‹</h3><p><strong>ç”Ÿæˆæ–¹å¼</strong></p>
<ul>
<li><code>runtime/pprof</code>: æ‰‹åŠ¨è°ƒç”¨å¦‚<code>runtime.StartCPUProfile</code>æˆ–è€…<code>runtime.StopCPUProfile</code>ç­‰ API æ¥ç”Ÿæˆå’Œå†™å…¥é‡‡æ ·æ–‡ä»¶ï¼Œçµæ´»æ€§é«˜ã€‚ä¸»è¦ç”¨äºæœ¬åœ°æµ‹è¯•ã€‚</li>
<li><code>net/http/pprof</code>: é€šè¿‡ http æœåŠ¡è·å– Profile é‡‡æ ·æ–‡ä»¶ï¼Œç®€å•æ˜“ç”¨ï¼Œé€‚ç”¨äºå¯¹åº”ç”¨ç¨‹åºçš„æ•´ä½“ç›‘æ§ã€‚é€šè¿‡ runtime/pprof å®ç°ã€‚ä¸»è¦ç”¨äºæœåŠ¡å™¨ç«¯æµ‹è¯•ã€‚</li>
<li><code>go test</code>: é€šè¿‡ <code>go test -bench . -cpuprofile cpuprofile.out</code> ç”Ÿæˆé‡‡æ ·æ–‡ä»¶ï¼Œä¸»è¦ç”¨äºæœ¬åœ°åŸºå‡†æµ‹è¯•ã€‚å¯ç”¨äºé‡ç‚¹æµ‹è¯•æŸäº›å‡½æ•°ã€‚</li>
</ul>
<p><strong>æŸ¥çœ‹æ–¹å¼</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof [options][binary] ...</span><br></pre></td></tr></table></figure></p>
<ul>
<li>â€“text çº¯æ–‡æœ¬</li>
<li>â€“web ç”Ÿæˆ svg å¹¶ç”¨æµè§ˆå™¨æ‰“å¼€ï¼ˆå¦‚æœ svg çš„é»˜è®¤æ‰“å¼€æ–¹å¼æ˜¯æµè§ˆå™¨)</li>
<li>â€“svg åªç”Ÿæˆ svg</li>
<li>â€“list funcname ç­›é€‰å‡ºæ­£åˆ™åŒ¹é… funcname çš„å‡½æ•°çš„ä¿¡æ¯</li>
<li>-http=â€:portâ€ ç›´æ¥æœ¬åœ°æµè§ˆå™¨æ‰“å¼€ profile æŸ¥çœ‹ï¼ˆåŒ…æ‹¬ topï¼Œgraphï¼Œç«ç„°å›¾ç­‰ï¼‰</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof -base profile1 profile2</span><br></pre></td></tr></table></figure>
<p>å¯¹æ¯”æŸ¥çœ‹ 2 ä¸ª profileï¼Œä¸€èˆ¬ç”¨äºä»£ç ä¿®æ”¹å‰åå¯¹æ¯”ï¼Œå®šä½å·®å¼‚ç‚¹ã€‚</p>
<p>é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼æŸ¥çœ‹ profile æ—¶ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œå¯¹è¯ä¸­ï¼Œä½¿ç”¨ä¸‹åˆ—å‘½ä»¤ï¼ŒæŸ¥çœ‹ç›¸å…³ä¿¡æ¯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">flat flat%   sum%        cum   cum%</span><br><span class="line">5.95s 27.56% 27.56%      5.95s 27.56%  runtime.usleep</span><br><span class="line">4.97s 23.02% 50.58%      5.08s 23.53%  sync.(*RWMutex).RLock</span><br><span class="line">4.46s 20.66% 71.24%      4.46s 20.66%  sync.(*RWMutex).RUnlock</span><br><span class="line">2.69s 12.46% 83.70%      2.69s 12.46%  runtime.pthread_cond_<span class="built_in">wait</span></span><br><span class="line">1.50s  6.95% 90.64%      1.50s  6.95%  runtime.pthread_cond_signal</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>lat</code>: é‡‡æ ·æ—¶ï¼Œè¯¥å‡½æ•°æ­£åœ¨è¿è¡Œçš„æ¬¡æ•°*é‡‡æ ·é¢‘ç‡(10ms)ï¼Œå³å¾—åˆ°ä¼°ç®—çš„å‡½æ•°è¿è¡Œâ€é‡‡æ ·æ—¶é—´â€ã€‚è¿™é‡Œä¸åŒ…æ‹¬å‡½æ•°ç­‰å¾…å­å‡½æ•°è¿”å›ã€‚</li>
<li><code>flat%</code>: flat / æ€»é‡‡æ ·æ—¶é—´å€¼</li>
<li><code>sum%</code>: å‰é¢æ‰€æœ‰è¡Œçš„ flat% çš„ç´¯åŠ å€¼ï¼Œå¦‚ç¬¬ä¸‰è¡Œ sum% = 71.24% = 27.56% + 50.58%</li>
<li><code>cum</code>: é‡‡æ ·æ—¶ï¼Œè¯¥å‡½æ•°å‡ºç°åœ¨è°ƒç”¨å †æ ˆçš„é‡‡æ ·æ—¶é—´ï¼ŒåŒ…æ‹¬å‡½æ•°ç­‰å¾…å­å‡½æ•°è¿”å›ã€‚å› æ­¤ flat &lt;= cum</li>
<li><code>cum%</code>: cum / æ€»é‡‡æ ·æ—¶é—´å€¼</li>
</ul>
<p><code>topN [-cum]</code> æŸ¥çœ‹å‰ N ä¸ªæ•°æ®ï¼š</p>
<p><code>list ncname</code> æŸ¥çœ‹æŸä¸ªå‡½æ•°çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥æ˜ç¡®å…·ä½“çš„èµ„æºï¼ˆcpuï¼Œå†…å­˜ç­‰ï¼‰æ˜¯ç”±å“ªä¸€è¡Œè§¦å‘çš„ã€‚</p>
<h3 id="pprof-æ¥å…¥"><a href="#pprof-æ¥å…¥" class="headerlink" title="pprof æ¥å…¥"></a>pprof æ¥å…¥</h3><p>æœåŠ¡ä¸­ main æ–¹æ³•æ’å…¥ä»£ç <br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cfg := tars.GetServerConfig()</span><br><span class="line">profMux := &amp;tars.TarsHttpMux&#123;&#125;</span><br><span class="line">profMux.HandleFunc(<span class="string">"/debug/pprof/"</span>, pprof.Index)</span><br><span class="line">profMux.HandleFunc(<span class="string">"/debug/pprof/cmdline"</span>, pprof.Cmdline)</span><br><span class="line">profMux.HandleFunc(<span class="string">"/debug/pprof/profile"</span>, pprof.Profile)</span><br><span class="line">profMux.HandleFunc(<span class="string">"/debug/pprof/symbol"</span>, pprof.Symbol)</span><br><span class="line">profMux.HandleFunc(<span class="string">"/debug/pprof/trace"</span>, pprof.Trace)</span><br><span class="line">tars.AddHttpServant(profMux, cfg.App+<span class="string">"."</span>+cfg.Server+<span class="string">".ProfObj"</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="æŸ¥çœ‹æœåŠ¡çš„-pprof"><a href="#æŸ¥çœ‹æœåŠ¡çš„-pprof" class="headerlink" title="æŸ¥çœ‹æœåŠ¡çš„ pprof"></a>æŸ¥çœ‹æœåŠ¡çš„ pprof</h3><ul>
<li>ä¿è¯å¼€å‘æœºèƒ½ç›´æ¥è®¿é—®åˆ°èŠ‚ç‚¹éƒ¨ç½²çš„ ip å’Œ portã€‚</li>
<li>æŸ¥çœ‹ profile(http åœ°å€ä¸­çš„ ip,port ä¸º ProfObj çš„ ip å’Œ port)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½cpu profile</span></span><br><span class="line">go tool pprof http://ip:port/debug/pprof/profile?seconds=120 <span class="comment"># ç­‰å¾…120sï¼Œä¸å¸¦æ­¤å‚æ•°æ—¶ç­‰å¾…30s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½heap profile</span></span><br><span class="line">go tool pprof http://ip:port/debug/pprof/heap</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½goroutine profile</span></span><br><span class="line">go tool pprof http://ip:port/debug/pprof/goroutine</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½block profile</span></span><br><span class="line">go tool pprof http://ip:port/debug/pprof/block</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½mutex profile</span></span><br><span class="line">go tool pprof http://ip:port/debug/pprof/mutex</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½20ç§’çš„traceè®°å½•ï¼ˆé‡åˆ°æ£˜æ‰‹é—®é¢˜æ—¶ï¼ŒæŸ¥çœ‹traceä¼šæ¯”è¾ƒå®¹æ˜“å®šä½)</span></span><br><span class="line"> curl http://100.97.1.35:10078/debug/pprof/trace?seconds=20 &gt; trace.out</span><br><span class="line"> go tool trace trace.out æŸ¥çœ‹</span><br></pre></td></tr></table></figure>
<ul>
<li>ç›´æ¥åœ¨ç»ˆç«¯ä¸­é€šè¿‡ pprof å‘½ä»¤æŸ¥çœ‹</li>
<li>sz ä¸Šé¢å‘½ä»¤æ‰§è¡Œæ—¶å‡ºç°çš„<code>Saved profile in /root/pprof/pprof.binary.alloc_objects.xxxxxxx.xxxx.pb.gz</code>åˆ°æœ¬åœ° </li>
<li>åœ¨æœ¬åœ°ç¯å¢ƒï¼Œæ‰§è¡Œ<code>go tool pprof -http=&quot;:8081&quot; pprof.binary.alloc_objects.xxxxxxx.xxxx.pb.gz</code> å³å¯ç›´æ¥é€šè¿‡<code>http://localhost:8081</code>é¡µé¢æŸ¥çœ‹ã€‚åŒ…æ‹¬topNï¼Œç«ç„°å›¾ä¿¡æ¯ç­‰,ä¼šæ›´æ–¹ä¾¿ä¸€ç‚¹ã€‚</li>
</ul>
<h3 id="GC-Trace"><a href="#GC-Trace" class="headerlink" title="GC Trace"></a>GC Trace</h3><p>golang å…·å¤‡ GC åŠŸèƒ½ï¼Œè€Œ GC æ˜¯æœ€å®¹æ˜“è¢«å¿½è§†çš„æ€§èƒ½å½±å“å› ç´ ã€‚å°¤å…¶æ˜¯åœ¨æœ¬åœ°ä½¿ç”¨ benchmark æµ‹è¯•æ—¶ï¼Œç”±äºæ—¶é—´è¾ƒçŸ­ï¼Œå ç”¨å†…å­˜è¾ƒå°‘ã€‚å¾€å¾€ä¸ä¼šè§¦å‘ GCã€‚è€Œä¸€æ—¦çº¿ä¸Šå‡ºç° GC é—®é¢˜ï¼Œåˆä¸å¤ªå¥½å®šä½ã€‚ç›®å‰å¸¸ç”¨çš„å®šä½æ–¹å¼æœ‰ä¸¤ç§ï¼š</p>
<h4 id="æœ¬åœ°-gctrace"><a href="#æœ¬åœ°-gctrace" class="headerlink" title="æœ¬åœ° gctrace"></a>æœ¬åœ° gctrace</h4><p>åœ¨æ‰§è¡Œç¨‹åºå‰åŠ  <code>GODEBUG=gctrace=1</code>ï¼Œæ¯æ¬¡ gc æ—¶ä¼šè¾“å‡ºä¸€è¡Œå¦‚ä¸‹å†…å®¹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gc 1 @0.001s 11%: 0.007+1.5+0.004 ms clock, 0.089+1.5/2.8/0.27+0.054 ms cpu, 4-&gt;4-&gt;3 MB, 5 MB goal, 12 P</span><br><span class="line">scvg: inuse: 4, idle: 57, sys: 62, released: 57, consumed: 4 (MB)</span><br></pre></td></tr></table></figure></p>
<p>ä¹Ÿé€šè¿‡æ—¥å¿—è½¬ä¸ºå›¾å½¢åŒ–ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GODEBUG=gctrace=1 godoc -index -http=:6060 2&gt; stderr.log</span><br><span class="line">cat stderr.log | gcvis</span><br></pre></td></tr></table></figure></p>
<ul>
<li>inuseï¼šä½¿ç”¨äº†å¤šå°‘ M å†…å­˜</li>
<li>idleï¼šå‰©ä¸‹è¦æ¸…é™¤çš„å†…å­˜</li>
<li>sysï¼šç³»ç»Ÿæ˜ å°„çš„å†…å­˜</li>
<li>releasedï¼šé‡Šæ”¾çš„ç³»ç»Ÿå†…å­˜</li>
<li>consumedï¼šç”³è¯·çš„ç³»ç»Ÿå†…å­˜</li>
<li>gc 1 è¡¨ç¤ºç¬¬ 1 æ¬¡ gc</li>
<li>@0.001s è¡¨ç¤ºç¨‹åºæ‰§è¡Œçš„æ€»æ—¶é—´</li>
<li>11% è¡¨ç¤ºåƒåœ¾å›æ”¶æ—¶é—´å ç”¨æ€»çš„è¿è¡Œæ—¶é—´ç™¾åˆ†æ¯”</li>
<li>0.007+1.5+0.004 ms clock è¡¨ç¤ºå·¥ä½œçº¿ç¨‹å®Œæˆ GC çš„ stop-the-world,sweeping,marking å’Œ waiting çš„æ—¶é—´</li>
<li>0.089+1.5/2.8/0.27+0.054 ms cpu åƒåœ¾å›æ”¶å ç”¨ cpu æ—¶é—´</li>
<li>4-&gt;4-&gt;3 MB è¡¨ç¤ºå †çš„å¤§å°ï¼Œgc åå †çš„å¤§å°ï¼Œå­˜æ´»å †çš„å¤§å°</li>
<li>5 MB goal æ•´ä½“å †çš„å¤§å°</li>
<li>12 P ä½¿ç”¨çš„å¤„ç†å™¨æ•°é‡</li>
<li>scvg: inuse: 4, idle: 57, sys: 62, released: 57, consumed: 4 (MB) è¡¨ç¤ºç³»ç»Ÿå†…å­˜å›æ”¶ä¿¡æ¯</li>
<li>é‡‡ç”¨å›¾å½¢åŒ–çš„æ–¹å¼æŸ¥çœ‹ï¼š<a href="https://github.com/davecheney/gcvis" target="_blank" rel="external">https://github.com/davecheney/gcvis</a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GODEBUG=gctrace=1 go <span class="built_in">test</span> -v *.go -bench=. -run=none -benchtime 3m |&amp; gcvis</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="çº¿ä¸Š-trace"><a href="#çº¿ä¸Š-trace" class="headerlink" title="çº¿ä¸Š trace"></a>çº¿ä¸Š trace</h4><p>åœ¨çº¿ä¸Šä¸šåŠ¡ä¸­æ·»åŠ <strong>net/http/pprof</strong>åï¼Œå¯é€šè¿‡ä¸‹åˆ—å‘½ä»¤é‡‡é›† 20 ç§’çš„ trace ä¿¡æ¯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://ip:port/debug/pprof/trace?seconds=20 &gt; trace.out</span><br></pre></td></tr></table></figure></p>
<p>å†é€šè¿‡<code>go tool trace trace.out</code> å³å¯åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­æŸ¥çœ‹ trace ä¿¡æ¯ã€‚<br><img src="/images/go/performance_1.png" alt="go performance analysis"></p>
<ul>
<li>View traceï¼šæŸ¥çœ‹è·Ÿè¸ª</li>
<li>Goroutine analysisï¼šGoroutine åˆ†æ</li>
<li>Network blocking profileï¼šç½‘ç»œé˜»å¡æ¦‚å†µ</li>
<li>Synchronization blocking profileï¼šåŒæ­¥é˜»å¡æ¦‚å†µ</li>
<li>Syscall blocking profileï¼šç³»ç»Ÿè°ƒç”¨é˜»å¡æ¦‚å†µ</li>
<li>Scheduler latency profileï¼šè°ƒåº¦å»¶è¿Ÿæ¦‚å†µ</li>
<li>User defined tasksï¼šç”¨æˆ·è‡ªå®šä¹‰ä»»åŠ¡</li>
<li>User defined regionsï¼šç”¨æˆ·è‡ªå®šä¹‰åŒºåŸŸ</li>
<li>Minimum mutator utilizationï¼šæœ€ä½ Mutator åˆ©ç”¨ç‡</li>
</ul>
<p>GC ç›¸å…³çš„ä¿¡æ¯å¯ä»¥åœ¨ View trace ä¸­çœ‹åˆ°<br><img src="/images/go/performance_2.png" alt="go performance analysis"></p>
<p>å¯é€šè¿‡ç‚¹å‡» heap çš„è‰²å—åŒºåŸŸï¼ŒæŸ¥çœ‹ heap ä¿¡æ¯ã€‚<br><img src="/images/go/performance_3.png" alt="go performance analysis"></p>
<p>ç‚¹å‡» GC å¯¹åº”è¡Œçš„è“è‰²è‰²å—ï¼ŒæŸ¥çœ‹ GC è€—æ—¶åŠç›¸å…³å›æ”¶ä¿¡æ¯ã€‚<br><img src="/images/go/performance_4.png" alt="go performance analysis"></p>
<p>é€šè¿‡è¿™ä¸¤ä¸ªä¿¡æ¯å°±å¯ä»¥ç¡®è®¤æ˜¯å¦å­˜åœ¨ GC é—®é¢˜ï¼Œä»¥åŠé€ æˆé«˜ GC çš„å¯èƒ½åŸå› ã€‚</p>
<h4 id="ä½¿ç”¨é—®é¢˜"><a href="#ä½¿ç”¨é—®é¢˜" class="headerlink" title="ä½¿ç”¨é—®é¢˜"></a>ä½¿ç”¨é—®é¢˜</h4><p>trace çš„å±•ç¤ºä»…æ”¯æŒ chrome æµè§ˆå™¨ã€‚ä½†æ˜¯ç›®å‰å¸¸ç”¨çš„ chrome æµè§ˆå™¨å±è”½äº† go tool trace ä½¿ç”¨çš„ HTML import åŠŸèƒ½ã€‚å³æ‰“å¼€â€œview traceâ€æ—¶ï¼Œä¼šå‡ºç°ä¸€ç‰‡ç©ºç™½ã€‚å¹¶å¯ä»¥åœ¨ console ä¸­çœ‹åˆ°è­¦å‘Šä¿¡æ¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTML Imports is deprecated and has now been removed as of M80. See https://www.chromestatus.com/features/5144752345317376 and https://developers.google.com/web/updates/2019/07/web-components-time-to-upgrade <span class="keyword">for</span> more details.</span><br></pre></td></tr></table></figure></p>
<h4 id="è§£å†³åŠæ³•"><a href="#è§£å†³åŠæ³•" class="headerlink" title="è§£å†³åŠæ³•"></a>è§£å†³åŠæ³•</h4><p><strong>ç”³è¯· token</strong></p>
<ul>
<li><a href="https://developers.chrome.com/origintrials/#/register_trial/2431943798780067841" target="_blank" rel="external">https://developers.chrome.com/origintrials/#/register_trial/2431943798780067841</a> ç„¶åç™»å½•</li>
<li>web origin å¤„å¡«å†™ <a href="http://localhost:8001" target="_blank" rel="external">http://localhost:8001</a> ç«¯å£åªèƒ½æ˜¯ 8000 - 8003ï¼Œæ”¯æŒ http å’Œ httpsã€‚ï¼ˆä¹Ÿå¯ä»¥å¡«å†™ 127.0.0.1:8001,ä¾èµ–äºä½ æµè§ˆå™¨ä¸­æ˜¾ç¤ºçš„åœ°å€ï¼Œå¦åˆ™å¯¹ä¸ä¸Šçš„è¯ï¼Œè¿˜è¦æ‰‹åŠ¨æ”¹ä¸€ä¸‹)<br><img src="/images/go/performance_5.png" alt="go performance analysis"></li>
<li>ç‚¹å‡»æ³¨å†Œåå³å¯çœ‹åˆ° token</li>
</ul>
<p><strong>ä¿®æ”¹ trace.go</strong><br>ç¼–è¾‘<code>${GOROOT}/src/cmd/trace/trace.go</code> æ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶ä¸­æ‰¾åˆ° templTrace ç„¶ååœ¨  æ ‡ç­¾çš„ä¸‹ä¸€è¡Œæ·»åŠ <code>&lt;meta http-equiv=&quot;origin-trial&quot; content=&quot;ä½ å¤åˆ¶çš„token&quot;&gt;</code></p>
<p><strong>é‡æ–°ç¼–è¯‘ go</strong></p>
<ul>
<li>${GOROOT}/src ç›®å½•ï¼Œæ‰§è¡Œ ./all.bash</li>
<li>è‹¥æç¤ºï¼š<code>ERROR: Cannot find go1.4\bin\go Set GOROOT_BOOTSTRAP to a working Go tree &gt;= Go 1.4</code> åˆ™éœ€è¦å…ˆå®‰è£…ä¸€ä¸ª go1.4 çš„ç‰ˆæœ¬ï¼Œå†é€šè¿‡å®ƒæ¥ç¼–è¯‘ goã€‚ï¼ˆä¸‹è½½é“¾æ¥<a href="https://dl.google.com/go/go1.4-bootstrap-20171003.tar.gzï¼‰" target="_blank" rel="external">https://dl.google.com/go/go1.4-bootstrap-20171003.tar.gzï¼‰</a> åœ¨ <code>go1.4/src</code> ä¸‹æ‰§è¡Œ <code>./make.bash</code> . æŒ‡å®š GOROOT_BOOTSTRAP ä¸º go1.4 çš„æ ¹ç›®å½•ã€‚ç„¶åå°±å¯ä»¥é‡æ–°ç¼–è¯‘ go</li>
</ul>
<p><strong>æŸ¥çœ‹ trace</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go tool trace -http=localhost:8001 trace.out</span><br></pre></td></tr></table></figure></p>
<p>è‹¥æ‰“å¼€ view trace è¿˜æ˜¯ç©ºç™½,åˆ™æ£€æŸ¥ä¸€ä¸‹æµè§ˆå™¨åœ°å€æ ä¸­çš„åœ°å€ï¼Œæ˜¯å¦ä¸æ³¨å†Œæ—¶çš„ä¸€æ ·ã€‚å³æ³¨å†Œç”¨çš„ localhost æˆ– 127.0.0.1 åˆ™åœ°å€æ ä¸­ä¹Ÿè¦ä¸€æ ·ã€‚</p>
<h2 id="å¸¸è§æ€§èƒ½ç“¶é¢ˆ"><a href="#å¸¸è§æ€§èƒ½ç“¶é¢ˆ" class="headerlink" title="å¸¸è§æ€§èƒ½ç“¶é¢ˆ"></a>å¸¸è§æ€§èƒ½ç“¶é¢ˆ</h2><h3 id="ä¸šåŠ¡é€»è¾‘"><a href="#ä¸šåŠ¡é€»è¾‘" class="headerlink" title="ä¸šåŠ¡é€»è¾‘"></a>ä¸šåŠ¡é€»è¾‘</h3><p>å‡ºç°æ— æ•ˆç”šè‡³é™ä½æ€§èƒ½çš„é€»è¾‘ã€‚å¸¸è§çš„æœ‰ï¼š</p>
<ul>
<li>é€»è¾‘é‡å¤ï¼šç›¸åŒçš„æ“ä½œåœ¨ä¸åŒçš„ä½ç½®åšäº†å¤šæ¬¡æˆ–å¾ªç¯è·³å‡ºçš„æ¡ä»¶è®¾ç½®ä¸å½“ã€‚</li>
<li>èµ„æºæœªå¤ç”¨ï¼šå†…å­˜é¢‘ç¹ç”³è¯·å’Œé‡Šæ”¾ï¼Œæ•°æ®åº“é“¾æ¥é¢‘ç¹å»ºç«‹å’Œé”€æ¯ç­‰ã€‚</li>
<li>æ— æ•ˆä»£ç ã€‚</li>
</ul>
<h3 id="å­˜å‚¨"><a href="#å­˜å‚¨" class="headerlink" title="å­˜å‚¨"></a>å­˜å‚¨</h3><p>æœªé€‰æ‹©æ°å½“çš„å­˜å‚¨æ–¹å¼ï¼Œå¸¸è§çš„æœ‰ï¼š</p>
<ul>
<li>ä¸´æ—¶æ•°æ®å­˜æ”¾åˆ°æ•°æ®åº“ä¸­ï¼Œå¯¼è‡´é¢‘ç¹è¯»å†™æ•°æ®åº“ã€‚</li>
<li>å°†å¤æ‚çš„æ ‘çŠ¶ç»“æ„çš„æ•°æ®ç”¨ SQL æ•°æ®åº“å­˜å‚¨ï¼Œå‡ºç°å¤§é‡å†—ä½™åˆ—ï¼Œå¹¶ä¸”åœ¨è¯»å†™æ—¶è¦è¿›è¡Œæ‹†è§£å’Œæ‹¼æ¥ã€‚</li>
<li>æ•°æ®åº“è¡¨è®¾è®¡ä¸å½“ï¼Œæ— æ³•æœ‰æ•ˆåˆ©ç”¨ç´¢å¼•æŸ¥è¯¢ï¼Œå¯¼è‡´æŸ¥è¯¢æ“ä½œè€—æ—¶é«˜ç”šè‡³å‡ºç°å¤§é‡æ…¢æŸ¥è¯¢ã€‚</li>
<li>çƒ­ç‚¹æ•°æ®æœªä½¿ç”¨ç¼“å­˜ï¼Œå¯¼è‡´æ•°æ®åº“è´Ÿè½½è¿‡é«˜ï¼Œå“åº”é€Ÿåº¦ä¸‹é™ã€‚</li>
</ul>
<h3 id="å¹¶å‘å¤„ç†"><a href="#å¹¶å‘å¤„ç†" class="headerlink" title="å¹¶å‘å¤„ç†"></a>å¹¶å‘å¤„ç†</h3><p>å¹¶å‘æ“ä½œçš„é—®é¢˜ä¸»è¦å‡ºç°åœ¨èµ„æºç«äº‰ä¸Šï¼Œå¸¸è§çš„æœ‰ï¼š</p>
<ul>
<li>æ­»é”/æ´»é”å¯¼è‡´å¤§é‡é˜»å¡ï¼Œæ€§èƒ½ä¸¥é‡ä¸‹é™ã€‚</li>
<li>èµ„æºç«äº‰æ¿€çƒˆï¼šå¤§é‡çš„çº¿ç¨‹æˆ–åç¨‹æŠ¢å¤ºä¸€ä¸ªé”ã€‚</li>
<li>ä¸´ç•ŒåŒºè¿‡å¤§ï¼šå°†ä¸å¿…è¦çš„æ“ä½œä¹Ÿæ”¾å…¥ä¸´ç•ŒåŒºï¼Œå¯¼è‡´é”çš„é‡Šæ”¾é€Ÿåº¦è¿‡æ…¢ï¼Œå¼•èµ·å…¶ä»–çº¿ç¨‹æˆ–åç¨‹é˜»å¡ã€‚</li>
</ul>
<h2 id="golang-éƒ¨åˆ†ç»†èŠ‚ç®€ä»‹"><a href="#golang-éƒ¨åˆ†ç»†èŠ‚ç®€ä»‹" class="headerlink" title="golang éƒ¨åˆ†ç»†èŠ‚ç®€ä»‹"></a>golang éƒ¨åˆ†ç»†èŠ‚ç®€ä»‹</h2><p>åœ¨ä¼˜åŒ–ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ golang çš„å®ç°ç»†èŠ‚æœ‰ä¸€ä¸ªç®€å•çš„äº†è§£ï¼Œæ‰èƒ½æ˜ç™½å“ªäº›åœ°æ–¹æœ‰é—®é¢˜ï¼Œå“ªäº›åœ°æ–¹å¯ä»¥ä¼˜åŒ–ï¼Œä»¥åŠæ€ä¹ˆä¼˜åŒ–ã€‚ä»¥ä¸‹å†…å®¹çš„è¯¦ç»†è®²è§£å»ºè®®æŸ¥é˜…ç½‘ä¸Šä¼˜ç§€çš„ blogã€‚å¯¹è¯­è¨€çš„åº•å±‚å®ç°æœºåˆ¶æœ€å¥½æœ‰ä¸ªåŸºæœ¬çš„äº†è§£ï¼Œå¦åˆ™æœ‰æ—¶å€™æ‰åˆ°å‘é‡Œéƒ½ä¸çŸ¥é“ä¸ºå•¥ã€‚</p>
<h3 id="åç¨‹è°ƒåº¦"><a href="#åç¨‹è°ƒåº¦" class="headerlink" title="åç¨‹è°ƒåº¦"></a>åç¨‹è°ƒåº¦</h3><p>Golang è°ƒåº¦æ˜¯éæŠ¢å å¼å¤šä»»åŠ¡å¤„ç†ï¼Œç”±åç¨‹ä¸»åŠ¨äº¤å‡ºæ§åˆ¶æƒã€‚é‡åˆ°å¦‚ä¸‹æ¡ä»¶æ—¶ï¼Œæ‰æœ‰å¯èƒ½äº¤å‡ºæ§åˆ¶æƒ</p>
<ul>
<li>I/O,select</li>
<li>channel</li>
<li>ç­‰å¾…é”</li>
<li>å‡½æ•°è°ƒç”¨ï¼ˆæ˜¯ä¸€ä¸ªåˆ‡æ¢çš„æœºä¼šï¼Œæ˜¯å¦ä¼šåˆ‡æ¢ç”±è°ƒåº¦å™¨å†³å®šï¼‰</li>
<li>runtime.Gosched()</li>
</ul>
<p>å› æ­¤ï¼Œè‹¥å­˜åœ¨è¾ƒé•¿æ—¶é—´çš„ for å¾ªç¯å¤„ç†ï¼Œå¹¶ä¸”å¾ªç¯å†…æ²¡æœ‰ä¸Šè¿°é€»è¾‘æ—¶ï¼Œä¼šé˜»å¡ä½å…¶ä»–çš„åç¨‹è°ƒåº¦ã€‚åœ¨å®é™…ç¼–ç ä¸­ä¸€å®šè¦æ³¨æ„ã€‚</p>
<h3 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h3><p>Go ä¸ºæ¯ä¸ªé€»è¾‘å¤„ç†å™¨ï¼ˆPï¼‰æä¾›äº†ä¸€ä¸ªç§°ä¸ºmcacheçš„æœ¬åœ°å†…å­˜çº¿ç¨‹ç¼“å­˜ã€‚æ¯ä¸ª mcache ä¸­æŒæœ‰ 67 ä¸ªçº§åˆ«çš„ mspanã€‚æ¯ä¸ª msapn åˆåŒ…å«ä¸¤ç§ï¼šscanï¼ˆåŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ï¼‰å’Œ noscanï¼ˆä¸åŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ï¼‰ã€‚<strong>åœ¨è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼ŒGC æ— éœ€éå† noscan å¯¹è±¡</strong>ã€‚<br><img src="/images/go/performance_6.png" alt="go performance analysis"></p>
<h3 id="GC-å¤„ç†"><a href="#GC-å¤„ç†" class="headerlink" title="GC å¤„ç†"></a>GC å¤„ç†</h3><p>GC çš„å·¥ä½œå°±æ˜¯ç¡®å®šå“ªäº›å†…å­˜å¯ä»¥é‡Šæ”¾ï¼Œå®ƒæ˜¯é€šè¿‡æ‰«æå†…å­˜æŸ¥æ‰¾å†…å­˜åˆ†é…çš„æŒ‡é’ˆæ¥å®Œæˆè¿™ä¸ªå·¥ä½œçš„ã€‚GC è§¦å‘æ—¶æœºï¼š</p>
<ul>
<li>åˆ°è¾¾å †é˜ˆå€¼ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå°†åœ¨å †å¤§å°åŠ å€æ—¶è¿è¡Œï¼Œå¯é€šè¿‡ GOGC æ¥è®¾å®šæ›´é«˜é˜ˆå€¼ï¼ˆä¸å»ºè®®å˜æ›´æ­¤é…ç½®ï¼‰</li>
<li>åˆ°è¾¾æ—¶é—´é˜ˆå€¼ï¼šæ¯ä¸¤åˆ†é’Ÿä¼šå¼ºåˆ¶å¯åŠ¨ä¸€æ¬¡ GC å¾ªç¯</li>
</ul>
<p>ä¸ºå•¥è¦æ³¨æ„ GCï¼Œæ˜¯å› ä¸º GC æ—¶å‡ºç° 2 æ¬¡ Stop the worldï¼Œå³åœæ­¢æ‰€æœ‰åç¨‹ï¼Œè¿›è¡Œæ‰«ææ“ä½œã€‚è‹¥æ˜¯ GC è€—æ—¶é«˜ï¼Œåˆ™ä¼šä¸¥é‡å½±å“æœåŠ¡å™¨æ€§èƒ½ã€‚<br><img src="/images/go/performance_7.png" alt="go performance analysis"></p>
<h3 id="å˜é‡é€ƒé€¸"><a href="#å˜é‡é€ƒé€¸" class="headerlink" title="å˜é‡é€ƒé€¸"></a>å˜é‡é€ƒé€¸</h3><blockquote>
<p>æ³¨æ„ï¼Œgolang ä¸­çš„æ ˆæ˜¯è·Ÿå‡½æ•°ç»‘å®šçš„ï¼Œå‡½æ•°ç»“æŸæ—¶æ ˆè¢«å›æ”¶ã€‚</p>
</blockquote>
<p><strong>å˜é‡å†…å­˜å›æ”¶ï¼š</strong></p>
<ul>
<li>å¦‚æœåˆ†é…åœ¨æ ˆä¸­ï¼Œåˆ™å‡½æ•°æ‰§è¡Œç»“æŸå¯è‡ªåŠ¨å°†å†…å­˜å›æ”¶ï¼›</li>
<li>å¦‚æœåˆ†é…åœ¨å †ä¸­ï¼Œåˆ™å‡½æ•°æ‰§è¡Œç»“æŸå¯äº¤ç»™ GCï¼ˆåƒåœ¾å›æ”¶ï¼‰å¤„ç†ï¼›</li>
</ul>
<p>è€Œå˜é‡é€ƒé€¸å°±æ„å‘³ç€å¢åŠ äº†å †ä¸­çš„å¯¹è±¡ä¸ªæ•°ï¼Œå½±å“ GC è€—æ—¶ã€‚ä¸€èˆ¬è¦å°½é‡é¿å…é€ƒé€¸ã€‚</p>
<p><strong>é€ƒé€¸åˆ†æä¸å˜æ€§ï¼š</strong></p>
<ul>
<li>æŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½å­˜åœ¨äºå †ä¸­ï¼›</li>
<li>æŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½åœ¨æ ˆå¯¹è±¡å›æ”¶åå­˜æ´»ï¼›</li>
</ul>
<p>åœ¨é€ƒé€¸åˆ†æè¿‡ç¨‹ä¸­ï¼Œå‡¡æ˜¯å‘ç°å‡ºç°è¿åä¸Šè¿°çº¦å®šçš„å˜é‡ï¼Œå°±å°†å…¶ç§»åˆ°å †ä¸­ã€‚</p>
<p><strong>é€ƒé€¸å¸¸è§çš„æƒ…å†µï¼š</strong></p>
<ul>
<li>æŒ‡é’ˆé€ƒé€¸ï¼šè¿”å›å±€éƒ¨å˜é‡çš„åœ°å€ï¼ˆä¸å˜æ€§ 2ï¼‰</li>
<li>æ ˆç©ºé—´ä¸è¶³</li>
<li>åŠ¨æ€ç±»å‹é€ƒé€¸ï¼šå¦‚ fmt.Sprintf,json.Marshel ç­‰æ¥å—å˜é‡ä¸ºâ€¦interface{}å‡½æ•°çš„è°ƒç”¨ï¼Œä¼šå¯¼è‡´ä¼ å…¥çš„å˜é‡é€ƒé€¸ã€‚</li>
<li>é—­åŒ…å¼•ç”¨</li>
</ul>
<h3 id="åŒ…å«æŒ‡é’ˆç±»å‹çš„åº•å±‚ç»“æ„"><a href="#åŒ…å«æŒ‡é’ˆç±»å‹çš„åº•å±‚ç»“æ„" class="headerlink" title="åŒ…å«æŒ‡é’ˆç±»å‹çš„åº•å±‚ç»“æ„"></a>åŒ…å«æŒ‡é’ˆç±»å‹çš„åº•å±‚ç»“æ„</h3><p><strong>string</strong><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StringHeader <span class="keyword">struct</span> &#123;</span><br><span class="line"> Data <span class="keyword">uintptr</span></span><br><span class="line"> Len  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>slice</strong><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SliceHeader <span class="keyword">struct</span> &#123;</span><br><span class="line"> Data <span class="keyword">uintptr</span></span><br><span class="line"> Len  <span class="keyword">int</span></span><br><span class="line"> Cap  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>map</strong><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hmap <span class="keyword">struct</span> &#123;</span><br><span class="line"> count     <span class="keyword">int</span></span><br><span class="line"> flags     <span class="keyword">uint8</span></span><br><span class="line"> B         <span class="keyword">uint8</span></span><br><span class="line"> noverflow <span class="keyword">uint16</span></span><br><span class="line"> hash0     <span class="keyword">uint32</span></span><br><span class="line"> buckets    unsafe.Pointer</span><br><span class="line"> oldbuckets unsafe.Pointer</span><br><span class="line"> nevacuate  <span class="keyword">uintptr</span></span><br><span class="line"> extra *mapextra</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™äº›æ˜¯å¸¸è§ä¼šåŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ã€‚å°¤å…¶æ˜¯ stringï¼Œåœ¨åå°åº”ç”¨ä¸­å¤§é‡å‡ºç°ã€‚å¹¶ç»å¸¸ä¼šä½œä¸º map çš„ key æˆ– valueã€‚è‹¥æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå°±ä¼šå¼•å‘ GC è€—æ—¶ä¸Šå‡ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ° string å’Œ slice éå¸¸ç›¸ä¼¼ï¼Œä»æŸç§æ„ä¹‰ä¸Šè¯´å®ƒä»¬ä¹‹é—´æ˜¯å¯ä»¥ç›´æ¥äº’ç›¸è½¬æ¢çš„ã€‚è¿™å°±å¯ä»¥é¿å… string å’Œ[]byte ä¹‹é—´ç±»å‹è½¬æ¢æ—¶ï¼Œè¿›è¡Œå†…å­˜æ‹·è´</p>
<p><strong>ç±»å‹è½¬æ¢ä¼˜åŒ–</strong><br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">String</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"> <span class="keyword">return</span> *(*<span class="keyword">string</span>)(unsafe.Pointer(&amp;b))</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Str2Bytes</span><span class="params">(s <span class="keyword">string</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line"> x := (*[<span class="number">2</span>]<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s))</span><br><span class="line"> h := [<span class="number">3</span>]<span class="keyword">uintptr</span>&#123;x[<span class="number">0</span>], x[<span class="number">1</span>], x[<span class="number">1</span>]&#125;</span><br><span class="line"> <span class="keyword">return</span> *(*[]<span class="keyword">byte</span>)(unsafe.Pointer(&amp;h))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="æ€§èƒ½æµ‹è¯•æ–¹å¼"><a href="#æ€§èƒ½æµ‹è¯•æ–¹å¼" class="headerlink" title="æ€§èƒ½æµ‹è¯•æ–¹å¼"></a>æ€§èƒ½æµ‹è¯•æ–¹å¼</h2><h3 id="æœ¬åœ°æµ‹è¯•"><a href="#æœ¬åœ°æµ‹è¯•" class="headerlink" title="æœ¬åœ°æµ‹è¯•"></a>æœ¬åœ°æµ‹è¯•</h3><p>å°†æœåŠ¡å¤„ç†çš„æ ¸å¿ƒé€»è¾‘ï¼Œä½¿ç”¨ go test çš„ benchmark åŠ  pprof æ¥æµ‹è¯•ã€‚å»ºè®®ä¸Šçº¿å‰ï¼Œå°±å¯¹æ•´ä¸ªä¸šåŠ¡é€»è¾‘çš„æ€§èƒ½è¿›è¡Œæµ‹è¯•ï¼Œæå‰ä¼˜åŒ–ç“¶é¢ˆã€‚</p>
<h3 id="çº¿ä¸Šæµ‹è¯•"><a href="#çº¿ä¸Šæµ‹è¯•" class="headerlink" title="çº¿ä¸Šæµ‹è¯•"></a>çº¿ä¸Šæµ‹è¯•</h3><p>ä¸€èˆ¬ http æœåŠ¡å¯ä»¥é€šè¿‡å¸¸è§çš„æµ‹è¯•å·¥å…·è¿›è¡Œå‹æµ‹ï¼Œå¦‚ wrkï¼Œlocust ç­‰ã€‚taf æœåŠ¡åˆ™éœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–å†™ä¸€äº›æµ‹è¯•è„šæœ¬ã€‚åŒæ—¶ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œå‹æµ‹çš„ç›®çš„æ˜¯å®šä½å‡ºæœåŠ¡çš„æœ€ä½³æ€§èƒ½ï¼Œè€Œä¸æ˜¯ç›²ç›®çš„é«˜å¹¶å‘è¯·æ±‚æµ‹è¯•ã€‚å› æ­¤ï¼Œä¸€èˆ¬éœ€è¦é€æ­¥æå‡å¹¶å‘è¯·æ±‚æ•°é‡ï¼Œæ¥å®šä½å‡ºæœåŠ¡çš„æœ€ä½³æ€§èƒ½ç‚¹ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šç”±äº taf å¹³å°å…·å¤‡æ‰©å®¹åŠŸèƒ½ï¼Œå› æ­¤ä¸ºäº†æ›´å‡†ç¡®çš„æµ‹è¯•ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨æµ‹è¯•å‰å…³é—­è¦æµ‹è¯•èŠ‚ç‚¹çš„è‡ªåŠ¨æ‰©å®¹ã€‚</p>
</blockquote>
<h2 id="å®é™…é¡¹ç›®ä¼˜åŒ–"><a href="#å®é™…é¡¹ç›®ä¼˜åŒ–" class="headerlink" title="å®é™…é¡¹ç›®ä¼˜åŒ–"></a>å®é™…é¡¹ç›®ä¼˜åŒ–</h2><p>ä¸ºäº†é¿å…å½±å“åç«¯æœåŠ¡ï¼Œä¹Ÿä¸ºäº†é¿å…åç«¯æœåŠ¡å½±å“ç½‘å…³è‡ªèº«ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å‹æµ‹å‰ï¼Œå°†å¯¹åç«¯æœåŠ¡çš„è°ƒç”¨å±è”½ã€‚</p>
<ul>
<li>æµ‹è¯•å‡†å¤‡ï¼šå±è”½è¿œç¨‹è°ƒç”¨ï¼šä¸‹æ¸¸æœåŠ¡è°ƒç”¨ï¼Œå¥åº·åº¦ä¸ŠæŠ¥ï¼Œç»Ÿè®¡ä¸ŠæŠ¥ï¼Œè¿œç¨‹æ—¥å¿—ã€‚ä»¥ä¾¿å…³æ³¨ç½‘å…³è‡ªèº«æ€§èƒ½ã€‚<h3 id="QPS-ç°çŠ¶"><a href="#QPS-ç°çŠ¶" class="headerlink" title="QPS ç°çŠ¶"></a>QPS ç°çŠ¶</h3>é¦–å…ˆçœ‹ä¸‹å½“å‰ä¸šåŠ¡çš„æ€§èƒ½æŒ‡æ ‡ï¼Œä½¿ç”¨ wrk å‹æµ‹ç½‘å…³æœåŠ¡<br><img src="/images/go/performance_8.png" alt="go performance analysis"><br>å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ€»é“¾æ¥æ•°ä¸º 70 çš„æ—¶å€™ï¼ŒQPS æœ€é«˜ï¼Œä¸º 13245ã€‚<h3 id="ç«ç„°å›¾"><a href="#ç«ç„°å›¾" class="headerlink" title="ç«ç„°å›¾"></a>ç«ç„°å›¾</h3><img src="/images/go/performance_9.png" alt="go performance analysis"><br>æ ¹æ®ç«ç„°å›¾æˆ‘ä»¬å®šä½å‡º cpu å æ¯”è¾ƒé«˜çš„å‡ ä¸ªæ–¹æ³•ä¸ºï¼š</li>
<li>json.Marshal</li>
<li>json.Unmarshal</li>
<li>rogger.Infof</li>
</ul>
<p>ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œå°†ä»£ç æ”¹ä¸ºæœ¬åœ°è¿è¡Œï¼Œå¹¶é€šè¿‡ benchmark çš„æ–¹å¼æ¥å¯¹æ¯”ä¿®æ”¹å‰åçš„å·®å¼‚ã€‚</p>
<blockquote>
<p>ç”±äºæ­£å¼ç¯å¢ƒä½¿ç”¨çš„ golang ç‰ˆæœ¬ä¸º 1.12ï¼Œå› æ­¤æœ¬åœ°æµ‹è¯•æ—¶ï¼Œä¹Ÿè¦ä½¿ç”¨åŒæ ·çš„ç‰ˆæœ¬ã€‚</p>
</blockquote>
<h3 id="benchmark"><a href="#benchmark" class="headerlink" title="benchmark"></a>benchmark</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Benchmark   	50000000	      3669 ns/op	    4601 B/op	      73 allocs/op</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹ cpu å’Œ memory çš„ profileï¼Œå‘ç°å¥åº·åº¦ä¸ŠæŠ¥çš„æ•°æ®ç»“æ„å¡«å……å æ¯”è¾ƒé«˜ã€‚è¿™éƒ¨åˆ†é€»è¾‘åŸºäº tars æ¡†æ¶å®ç°ã€‚æš‚æ—¶å¿½ç•¥ï¼Œä¸ºé¿å…å½±å“å…¶ä»–æµ‹è¯•ï¼Œå…ˆæ³¨é‡Šæ‰ã€‚å†çœ‹çœ‹ benchmarkã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Benchmark   	  500000	      3146 ns/op	    2069 B/op	      55 allocs/op</span><br></pre></td></tr></table></figure></p>
<h2 id="ä¼˜åŒ–ç­–ç•¥"><a href="#ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="ä¼˜åŒ–ç­–ç•¥"></a>ä¼˜åŒ–ç­–ç•¥</h2><h3 id="JSON-ä¼˜åŒ–"><a href="#JSON-ä¼˜åŒ–" class="headerlink" title="JSON ä¼˜åŒ–"></a>JSON ä¼˜åŒ–</h3><p>å…ˆæŸ¥çœ‹ json è§£æçš„éƒ¨åˆ†ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ä¼˜åŒ–ç©ºé—´</p>
<h4 id="è¯·æ±‚å¤„ç†"><a href="#è¯·æ±‚å¤„ç†" class="headerlink" title="è¯·æ±‚å¤„ç†"></a>è¯·æ±‚å¤„ç†</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RootHandle view.ReadReq2Json readJsonReq ä¸­è¿›è¡Œjsonè§£æ</span></span><br><span class="line"><span class="keyword">type</span> GatewayReqBody <span class="keyword">struct</span> &#123;</span><br><span class="line"> Header  GatewayReqBodyHeader   <span class="string">`json:"header"`</span></span><br><span class="line"> Payload <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="string">`json:"payload"`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readJsonReq</span><span class="params">(data []<span class="keyword">byte</span>, req *model.GatewayReqBody)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"> dataMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"> err := jsoniter.Unmarshal(data, &amp;dataMap)</span><br><span class="line"> ...</span><br><span class="line">  headerMap, ok := header.(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">  businessName, ok := headerMap[<span class="string">"businessName"</span>]</span><br><span class="line">  qua, ok := headerMap[<span class="string">"qua"</span>]</span><br><span class="line">  sessionId, ok := headerMap[<span class="string">"sessionId"</span>]</span><br><span class="line">  ...</span><br><span class="line">  payload, ok := dataMap[<span class="string">"payload"</span>]</span><br><span class="line">  req.Payload, ok = payload.(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°æœ¬è´¨ä¸Šå°† data è§£æä¸º model.GatewayReqBody ç±»å‹çš„ç»“æ„ä½“ã€‚ä½†æ˜¯è¿™é‡Œå´å­˜åœ¨ 2 ä¸ªé—®é¢˜</p>
<ol>
<li>ä½¿ç”¨äº†å¤æ‚çš„è§£ææ–¹å¼ï¼Œå…ˆå°† data è§£æä¸º mapï¼Œå†é€šè¿‡æ¯ä¸ªå­—æ®µçš„åå­—æ¥å–å€¼ï¼Œå¹¶è¿›è¡Œç±»å‹è½¬æ¢ã€‚</li>
<li>Req.Playload è§£æä¸ºä¸€ä¸ª mapã€‚ä½†åˆæœªä½¿ç”¨ã€‚æˆ‘ä»¬çœ‹çœ‹åé¢è¿™ä¸ª payload æ˜¯ç”¨æ¥åšå•¥ã€‚ç¡®è®¤æ˜¯å¦ä¸ºæ— æ•ˆä»£ç ã€‚</li>
</ol>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">invokeTafServant</span><span class="params">(resp http.ResponseWriter, gatewayHttpReq *model.GatewayHttpReq)</span></span> &#123;</span><br><span class="line"> ...</span><br><span class="line">  payloadBytes, err := json.Marshal(gatewayHttpReq.ReqBody.Payload)</span><br><span class="line"> <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">  commonReq.Payload = <span class="keyword">string</span>(payloadBytes)</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  responseData(gatewayHttpReq, StatusInternalServerError, <span class="string">"å°è£…jsonå¼‚å¸¸"</span>, <span class="string">""</span>, resp)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"> &#125;</span><br><span class="line">  ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>åç»­çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåˆå°†è¿™ä¸ª payload è½¬ä¸º stringã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šï¼Œä¸Šé¢çš„ json è§£ææ˜¯æ²¡æœ‰æ„ä¹‰ï¼ŒåŒæ—¶ä¹Ÿä¼šæµªè´¹èµ„æºï¼ˆpayload æ•°æ®é‡ä¸€èˆ¬ä¸å°ï¼‰ã€‚</p>
<h4 id="ä¼˜åŒ–æ–¹æ³•"><a href="#ä¼˜åŒ–æ–¹æ³•" class="headerlink" title="ä¼˜åŒ–æ–¹æ³•"></a>ä¼˜åŒ–æ–¹æ³•</h4><ul>
<li>golang è‡ªå¸¦çš„ json è§£ææ€§èƒ½è¾ƒä½ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥æ›¿æ¢ä¸ºgithub.com/json-iteratoræ¥æå‡æ€§èƒ½</li>
<li>åœ¨ golang ä¸­ï¼Œé‡åˆ°ä¸éœ€è¦è§£æçš„ json æ•°æ®ï¼Œå¯ä»¥å°†å…¶ç±»å‹å£°æ˜ä¸ºjson.RawMessage. å³ï¼Œå¯ä»¥å°†ä¸Šè¿° 2 ä¸ªæ–¹æ³•ä¼˜åŒ–ä¸º</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GatewayReqBody <span class="keyword">struct</span> &#123;</span><br><span class="line"> Header  GatewayReqBodyHeader <span class="string">`json:"header"`</span></span><br><span class="line"> Payload json.RawMessage      <span class="string">`json:"payload"`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readJsonReq</span><span class="params">(data []<span class="keyword">byte</span>, req *model.GatewayReqBody)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"> err := jsoniter.Unmarshal(data, req)</span><br><span class="line"> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> jsonParseErr</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">for</span> k, v := <span class="keyword">range</span> req.Header.Qua &#123;</span><br><span class="line">  req.Header.Qua[k] = v</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(req.Header.QuaStr) == <span class="number">0</span> &#123;</span><br><span class="line">   req.Header.QuaStr = k + <span class="string">"="</span> + v</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   req.Header.QuaStr += <span class="string">"&amp;"</span> + k + <span class="string">"="</span> + v</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">invokeTafServant</span><span class="params">(resp http.ResponseWriter, gatewayHttpReq *model.GatewayHttpReq)</span></span> &#123;</span><br><span class="line"> commonReq.Payload = <span class="keyword">string</span>(gatewayHttpReq.ReqBody.Payload)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™é‡Œæ³¨æ„ï¼å‡ºç°äº† string å’Œ[]byte ä¹‹é—´çš„ç±»å‹è½¬æ¢.ä¸ºäº†é¿å…å†…å­˜æ‹·è´ï¼Œè¿™é‡Œå°† string()æ”¹ä¸ºä¸Šé¢çš„ç±»å‹è½¬æ¢ä¼˜åŒ–ä¸­æ‰€å®šä¹‰çš„è½¬æ¢å‡½æ•°ï¼Œå³ <code>commonReq.Payload = encode.String(gatewayHttpReq.ReqBody.Payload)</code></li>
</ul>
<h4 id="å›åŒ…å¤„ç†"><a href="#å›åŒ…å¤„ç†" class="headerlink" title="å›åŒ…å¤„ç†"></a>å›åŒ…å¤„ç†</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GatewayRespBody <span class="keyword">struct</span> &#123;</span><br><span class="line"> Header  GatewayRespBodyHeader  <span class="string">`json:"header"`</span></span><br><span class="line"> Payload <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="string">`json:"payload"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">responseData</span><span class="params">(gatewayReq *model.GatewayHttpReq, code <span class="keyword">int32</span>, message <span class="keyword">string</span>, payload <span class="keyword">string</span>, resp http.ResponseWriter)</span></span> &#123;</span><br><span class="line"> jsonPayload := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> <span class="built_in">len</span>(payload) != <span class="number">0</span> &#123;</span><br><span class="line">  err := json.Unmarshal([]<span class="keyword">byte</span>(payload), &amp;jsonPayload)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">   ...</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> body := model.GatewayRespBody&#123;</span><br><span class="line">  Header: model.GatewayRespBodyHeader&#123;</span><br><span class="line">   Code:    code,</span><br><span class="line">   Message: message,</span><br><span class="line">  &#125;,</span><br><span class="line">  Payload: jsonPayload,</span><br><span class="line"> &#125;</span><br><span class="line">  data, err := view.RenderResp(<span class="string">"json"</span>, &amp;body)</span><br><span class="line">  ...</span><br><span class="line">  resp.WriteHeader(http.StatusOK)</span><br><span class="line"> resp.Write(data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ ·çš„ï¼Œè¿™é‡Œçš„ jsonPayloadï¼Œä¹Ÿæ˜¯å‡ºç°äº†ä¸å¿…è¦çš„ json è§£æã€‚æˆ‘ä»¬å¯ä»¥æ”¹ä¸º<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GatewayRespBody <span class="keyword">struct</span> &#123;</span><br><span class="line"> Header  GatewayRespBodyHeader  <span class="string">`json:"header"`</span></span><br><span class="line"> Payload json.RawMessage <span class="string">`json:"payload"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body := model.GatewayRespBody&#123;</span><br><span class="line">  Header: model.GatewayRespBodyHeader&#123;</span><br><span class="line">   Code:    code,</span><br><span class="line">   Message: message,</span><br><span class="line">  &#125;,</span><br><span class="line">  Payload: encode.Str2Bytes(payload),</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>ç„¶ååœ¨ view.RenderResp æ–¹æ³•ä¸­<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RenderResp</span><span class="params">(format <span class="keyword">string</span>, resp <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line"> <span class="keyword">if</span> <span class="string">"json"</span> == format &#123;</span><br><span class="line">  <span class="keyword">return</span> jsoniter.Marshal(resp)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"format error"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="benchmark-1"><a href="#benchmark-1" class="headerlink" title="benchmark"></a>benchmark</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Benchmark   	  500000	      3326 ns/op	    2842 B/op	      50 allocs/op</span><br></pre></td></tr></table></figure>
<p>è™½ç„¶å¯¹è±¡ alloc å‡å°‘äº†ï¼Œä½†å•æ¬¡æ“ä½œå†…å­˜ä½¿ç”¨å¢åŠ äº†ï¼Œä¸”æ€§èƒ½ä¸‹é™äº†ã€‚è¿™å°±æœ‰ç‚¹å¥‡æ€ªäº†ã€‚æˆ‘ä»¬æ¥å¯¹æ¯”ä¸€ä¸‹ 2 ä¸ªæƒ…å†µä¸‹çš„ pprofã€‚</p>
<h3 id="é€ƒé€¸åˆ†æåŠå¤„ç†"><a href="#é€ƒé€¸åˆ†æåŠå¤„ç†" class="headerlink" title="é€ƒé€¸åˆ†æåŠå¤„ç†"></a>é€ƒé€¸åˆ†æåŠå¤„ç†</h3><h4 id="go-tool-pprof-base"><a href="#go-tool-pprof-base" class="headerlink" title="go tool pprof -base"></a>go tool pprof -base</h4><ul>
<li>cpu å·®å¼‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flat  flat%   sum%        cum   cum%</span><br><span class="line"> 0.09s  1.17%  1.17%      0.40s  5.20%  runtime.mallocgc</span><br><span class="line"> 0.01s  0.13%  1.30%      0.35s  4.55%  /vendor/github.com/json-iterator/go.(*Iterator).readObjectStart</span><br><span class="line"> 0      0%     1.30%      0.35s  4.55%  /vendor/github.com/json-iterator/go.(*twoFieldsStructDecoder).Decode</span><br></pre></td></tr></table></figure>
<ul>
<li>mem å·®å¼‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    flat  flat%   sum%        cum   cum%</span><br><span class="line">478.96MB 20.33% 20.33%   279.94MB 11.88%  gateway.RootHandle</span><br><span class="line">       0     0% 20.33%   279.94MB 11.88%  <span class="built_in">command</span>-line-arguments.BenchmarkTestHttp.func1</span><br><span class="line">       0     0% 20.33%   279.94MB 11.88%  testing.(*B).RunParallel.func1</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡º RootHandle å¤šäº† 478.96M çš„å†…å­˜ä½¿ç”¨ã€‚é€šè¿‡ list RootHandle å¯¹æ¯” 2 ä¸ªæƒ…å†µä¸‹çš„å†…å­˜ä½¿ç”¨ã€‚å‘ç°ä¿®æ”¹åçš„ RootHandle ä¸­å¤šå‡ºäº†è¿™ä¸€è¡Œï¼š<code>475.46MB 475.46MB 158: gatewayHttpReq := model.GatewayHttpReq{}</code> è¿™ä¸€èˆ¬æ„å‘³ç€å˜é‡ gatewayHttpReq å‡ºç°äº†é€ƒé€¸ã€‚</p>
<ul>
<li>go build -gcflags â€œ-m -mâ€ gateway/*.go</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gateway/logic.go:270:26: &amp;gatewayHttpReq escapes to heap</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ç¡®å®å‡ºç°äº†é€ƒé€¸ã€‚è¿™ä¸ªå¯¹åº”çš„ä»£ç ä¸º<code>err = view.ReadReq2Json(&amp;gatewayHttpReq)</code>,è€Œé€ æˆé€ƒé€¸çš„æœ¬è´¨æ˜¯å› ä¸ºä¸Šé¢æ”¹åŠ¨äº†å‡½æ•° readJsonReqï¼ˆåŠ¨æ€ç±»å‹é€ƒé€¸ï¼Œå³å‡½æ•°å‚æ•°ä¸º interface ç±»å‹ï¼Œæ— æ³•åœ¨ç¼–è¯‘æ—¶ç¡®å®šå…·ä½“ç±»å‹çš„ï¼‰<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readJsonReq</span><span class="params">(data []<span class="keyword">byte</span>, req *model.GatewayReqBody)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"> err := jsoniter.Unmarshal(data, req)</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å› æ­¤ï¼Œè¿™é‡Œéœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹ï¼Œæ”¹ä¸º<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readJsonReq</span><span class="params">(data []<span class="keyword">byte</span>, req *model.GatewayReqBody)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> tmp model.GatewayReqBody</span><br><span class="line">	err := jsoniter.Unmarshal(data, &amp;tmp)</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="benchmark-2"><a href="#benchmark-2" class="headerlink" title="benchmark"></a>benchmark</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Benchmark   	  500000	      2994 ns/op	    1892 B/op	      50 allocs/op</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å †å†…å­˜ä½¿ç”¨æ˜æ˜¾ä¸‹é™ã€‚æ€§èƒ½ä¹Ÿæå‡äº†ã€‚å†çœ‹ä¸€ä¸‹ pprofï¼Œå¯»æ‰¾ä¸‹ä¸ªç“¶é¢ˆã€‚</p>
<h4 id="cpu-profile"><a href="#cpu-profile" class="headerlink" title="cpu profile"></a>cpu profile</h4><p><img src="/images/go/performance_10.png" alt="go performance analysis"><br>æŠ›å¼€ responeseData(ä»–å†…éƒ¨ä¸»è¦æ˜¯æ—¥å¿—æ‰“å°å æ¯”é«˜ï¼‰ï¼Œå æ¯”è¾ƒé«˜çš„ä¸º util.GenerateSessionIdï¼Œå…ˆæ¥çœ‹çœ‹è¿™ä¸ªæ€ä¹ˆä¼˜åŒ–ã€‚</p>
<h3 id="éšæœºå­—ç¬¦ä¸²ç”Ÿæˆ"><a href="#éšæœºå­—ç¬¦ä¸²ç”Ÿæˆ" class="headerlink" title="éšæœºå­—ç¬¦ä¸²ç”Ÿæˆ"></a>éšæœºå­—ç¬¦ä¸²ç”Ÿæˆ</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> letterRunes = []<span class="keyword">rune</span>(<span class="string">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RandStringRunes</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"> b := <span class="built_in">make</span>([]<span class="keyword">rune</span>, n)</span><br><span class="line"> <span class="keyword">for</span> i := <span class="keyword">range</span> b &#123;</span><br><span class="line">  b[i] = letterRunes[rand.Intn(<span class="built_in">len</span>(letterRunes))]</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">string</span>(b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›®å‰çš„ç”Ÿæˆæ–¹å¼ä½¿ç”¨çš„ç±»å‹æ˜¯ runeï¼Œä½†å…¶å®ç”¨ byte å°±å¤Ÿäº†ã€‚å¦å¤–ï¼ŒletterRunes æ˜¯ 62 ä¸ªå­—ç¬¦ï¼Œå³æœ€å¤§éœ€è¦ 6 ä½çš„ index å°±å¯ä»¥éå†å®Œæˆäº†ã€‚è€Œéšæœºæ•°è·å–çš„æ˜¯ 63 ä½ã€‚å³æ¯ä¸ªéšæœºæ•°ï¼Œå…¶å®å¯ä»¥äº§ç”Ÿ 10 ä¸ªéšæœºå­—ç¬¦ã€‚è€Œä¸ç”¨æ¯ä¸ªå­—ç¬¦éƒ½è·å–ä¸€æ¬¡éšæœºæ•°ã€‚æ‰€ä»¥æˆ‘ä»¬æ”¹ä¸º<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line"> letterBytes   = <span class="string">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span></span><br><span class="line"> letterIdxBits = <span class="number">6</span></span><br><span class="line"> letterIdxMask = <span class="number">1</span>&lt;&lt;letterIdxBits - <span class="number">1</span></span><br><span class="line"> letterIdxMax  = <span class="number">63</span> / letterIdxBits</span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RandStringRunes</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"> b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, n)</span><br><span class="line"> <span class="keyword">for</span> i, cache, remain := n<span class="number">-1</span>, rand.Int63(), letterIdxMax; i &gt;= <span class="number">0</span>; &#123;</span><br><span class="line">  <span class="keyword">if</span> remain == <span class="number">0</span> &#123;</span><br><span class="line">   cache, remain = rand.Int63(), letterIdxMax</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> idx := <span class="keyword">int</span>(cache &amp; letterIdxMask); idx &lt; <span class="built_in">len</span>(letterBytes) &#123;</span><br><span class="line">   b[i] = letterBytes[idx]</span><br><span class="line">   i--</span><br><span class="line">  &#125;</span><br><span class="line">  cache &gt;&gt;= letterIdxBits</span><br><span class="line">  remain--</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">string</span>(b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="benchmark-3"><a href="#benchmark-3" class="headerlink" title="benchmark"></a>benchmark</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Benchmark   	 1000000	      1487 ns/op	    1843 B/op	      50 allocs/op</span><br></pre></td></tr></table></figure>
<h3 id="ç±»å‹è½¬æ¢åŠå­—ç¬¦ä¸²æ‹¼æ¥"><a href="#ç±»å‹è½¬æ¢åŠå­—ç¬¦ä¸²æ‹¼æ¥" class="headerlink" title="ç±»å‹è½¬æ¢åŠå­—ç¬¦ä¸²æ‹¼æ¥"></a>ç±»å‹è½¬æ¢åŠå­—ç¬¦ä¸²æ‹¼æ¥</h3><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéƒ½ä¼šè¯´å°† string å’Œ[]byte çš„è½¬æ¢æ”¹ä¸º unsafeï¼›ä»¥åŠåœ¨å­—ç¬¦ä¸²æ‹¼æ¥æ—¶ï¼Œç”¨ byte.Buffer ä»£æ›¿ fmt.Sprintfã€‚ä½†æ˜¯ç½‘å…³è¿™é‡Œçš„æƒ…å†µæ¯”è¾ƒç‰¹æ®Šï¼Œå­—ç¬¦ä¸²çš„æ“ä½œåŸºæœ¬é›†ä¸­åœ¨æ‰“å°æ—¥å¿—çš„æ“ä½œã€‚è€Œ tars çš„æ—¥å¿—æ‰“å°æœ¬èº«å°±æ˜¯é€šè¿‡ byte.Buffer æ‹¼æ¥çš„ã€‚æ‰€ä»¥è¿™å¯ä»¥é¿å…ã€‚å¦å¤–ï¼Œç”±äºæ—¥å¿—æ‰“å°é‡å¤§ï¼Œä½¿ç”¨ unsafe è½¬æ¢[]byte ä¸º string å¸¦æ¥çš„æ”¶ç›Šï¼Œå¾€å¾€ä¼šå› ä¸ºé€ƒé€¸ä»è€Œå½±å“ GCï¼Œåæ­£ä¼šå½±å“æ€§èƒ½ã€‚å› æ­¤ï¼Œä¸åŒçš„åœºæ™¯ä¸‹ï¼Œä¸èƒ½ç®€å•çš„å¥—ç”¨ä¸€äº›ä¼˜åŒ–æ–¹æ³•ã€‚éœ€è¦é€šè¿‡å‹æµ‹åŠç»“æœåˆ†ææ¥åˆ¤æ–­å…·ä½“çš„ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<h2 id="ä¼˜åŒ–ç»“æœ"><a href="#ä¼˜åŒ–ç»“æœ" class="headerlink" title="ä¼˜åŒ–ç»“æœ"></a>ä¼˜åŒ–ç»“æœ</h2><p><img src="/images/go/performance_11.png" alt="go performance analysis"><br>å¯ä»¥çœ‹åˆ°ä¼˜åŒ–åï¼Œæœ€å¤§é“¾æ¥æ•°ä¸º 110ï¼Œæœ€é«˜ QPS ä¸º<strong>21153.35</strong>ã€‚å¯¹æ¯”ä¹‹å‰çš„<strong>13245</strong>ï¼Œå¤§çº¦æå‡ 60%ã€‚</p>
<h2 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h2><p>ä» pprof ä¸­å¯ä»¥çœ‹åˆ°æ—¥å¿—æ‰“å°ï¼Œè¿œç¨‹æ—¥å¿—ï¼Œå¥åº·ä¸ŠæŠ¥ç­‰ä¿¡æ¯å ç”¨è¾ƒå¤š cpu èµ„æºï¼Œä¸”å¯¼è‡´å¤šä¸ªæ•°æ®é€ƒé€¸ï¼ˆå°¤å…¶æ˜¯æ—¥å¿—æ‰“å°ï¼‰ã€‚è¿‡å¤šçš„æ—¥å¿—åŸºæœ¬ç­‰äºæ²¡æœ‰æ—¥å¿—ã€‚åç»­å¯è€ƒè™‘è£å‰ªæ—¥å¿—ï¼Œä»…ä¿ç•™å‡ºé”™æ—¶çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li>æ€§èƒ½æŸ¥çœ‹å·¥å…· pprof,trace åŠå‹æµ‹å·¥å…· wrk æˆ–å…¶ä»–å‹æµ‹å·¥å…·çš„ä½¿ç”¨è¦æ¯”è¾ƒäº†è§£ã€‚</li>
<li>ä»£ç é€»è¾‘å±‚é¢çš„èµ°è¯»éå¸¸é‡è¦ï¼Œè¦å°½é‡é¿å…æ— æ•ˆé€»è¾‘ã€‚</li>
<li>å¯¹äº golang è‡ªèº«åº“å­˜åœ¨ç¼ºé™·çš„ï¼Œå¯ä»¥å¯»æ‰¾ç¬¬ä¸‰æ–¹åº“æˆ–è‡ªå·±æ”¹é€ ã€‚</li>
<li>golang ç‰ˆæœ¬å°½é‡æ›´æ–°ï¼Œè¿™æ¬¡çš„æµ‹è¯•æ˜¯åœ¨ golang1.12 ä¸‹è¿›è¡Œçš„ã€‚è€Œ go1.13 ç”šè‡³ go1.14 åœ¨å¾ˆå¤šåœ°æ–¹è¿›è¡Œäº†æ”¹è¿›ã€‚æ¯”å¦‚ fmt.Sprintfï¼Œsync.Pool ç­‰ã€‚æ›¿æ¢æˆæ–°ç‰ˆæœ¬åº”è¯¥èƒ½è¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚</li>
<li>æœ¬åœ° benchmark ç»“æœä¸ç­‰äºçº¿ä¸Šè¿è¡Œç»“æœã€‚å°¤å…¶æ˜¯åœ¨ä½¿ç”¨ç¼“å­˜æ¥æé«˜å¤„ç†é€Ÿåº¦æ—¶ï¼Œè¦è€ƒè™‘ GC çš„å½±å“ã€‚</li>
<li>ä¼ å‚æ•°æˆ–è¿”å›å€¼æ—¶ï¼Œå°½é‡æŒ‰ golang çš„è®¾è®¡å“²å­¦ï¼Œå°‘ç”¨æŒ‡é’ˆï¼Œå¤šç”¨å€¼å¯¹è±¡ï¼Œé¿å…å¼•èµ·è¿‡å¤šçš„å˜é‡é€ƒé€¸ï¼Œå¯¼è‡´ GC è€—æ—¶æš´æ¶¨ã€‚struct çš„å¤§å°ä¸€èˆ¬åœ¨ 2K ä»¥ä¸‹çš„æ‹·è´ä¼ å€¼ï¼Œæ¯”ä½¿ç”¨æŒ‡é’ˆè¦å¿«ï¼ˆå¯é’ˆå¯¹ä¸åŒçš„æœºå™¨å‹æµ‹ï¼Œåˆ¤æ–­å„è‡ªçš„é˜ˆå€¼)ã€‚</li>
<li>å€¼ç±»å‹åœ¨æ»¡è¶³éœ€è¦çš„æƒ…å†µä¸‹ï¼Œè¶Šå°è¶Šå¥½ã€‚èƒ½ç”¨ int8ï¼Œå°±ä¸è¦ç”¨ int64ã€‚</li>
<li>èµ„æºå°½é‡å¤ç”¨,åœ¨ golang1.13 ä»¥ä¸Šï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ sync.Pool ç¼“å­˜ä¼šé‡å¤ç”³è¯·çš„å†…å­˜æˆ–å¯¹è±¡ã€‚æˆ–è€…è‡ªå·±ä½¿ç”¨å¹¶ç®¡ç†å¤§å—å†…å­˜ï¼Œç”¨æ¥å­˜å‚¨å°å¯¹è±¡ï¼Œé¿å… GC å½±å“ï¼ˆå¦‚æœ¬åœ°ç¼“å­˜çš„åœºæ™¯)ã€‚</li>
</ul>
<p>æ¨èé˜…è¯»: <a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651439020&amp;idx=1&amp;sn=c2094f4dccb53385dc207958e7f42f9e&amp;chksm=80bb615eb7cce8481eb7a8f09d4a13e2974b3785c241dd31245647cd7540dde414d64f2b3719&amp;scene=21#wechat_redirect" target="_blank" rel="external">æ»´æ»´å®æˆ˜åˆ†äº«ï¼šé€šè¿‡ profiling å®šä½ golang æ€§èƒ½é—®é¢˜ - å†…å­˜ç¯‡</a></p>
<p>æ¥æºï¼štrumanyan</p>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è°ƒè¯•golangçš„bugä»¥åŠæ€§èƒ½é—®é¢˜çš„å®è·µæ–¹æ³•]]></title>
      <url>http://team.jiunile.com/blog/2020/05/go-debug-practice.html</url>
      <content type="html"><![CDATA[<h2 id="åœºæ™¯1ï¼š-å¦‚ä½•åˆ†æç¨‹åºçš„è¿è¡Œæ—¶é—´ä¸CPUåˆ©ç”¨ç‡æƒ…å†µï¼Ÿ"><a href="#åœºæ™¯1ï¼š-å¦‚ä½•åˆ†æç¨‹åºçš„è¿è¡Œæ—¶é—´ä¸CPUåˆ©ç”¨ç‡æƒ…å†µï¼Ÿ" class="headerlink" title="åœºæ™¯1ï¼š å¦‚ä½•åˆ†æç¨‹åºçš„è¿è¡Œæ—¶é—´ä¸CPUåˆ©ç”¨ç‡æƒ…å†µï¼Ÿ"></a>åœºæ™¯1ï¼š å¦‚ä½•åˆ†æç¨‹åºçš„è¿è¡Œæ—¶é—´ä¸CPUåˆ©ç”¨ç‡æƒ…å†µï¼Ÿ</h2><h3 id="shellå†…ç½®timeæŒ‡ä»¤"><a href="#shellå†…ç½®timeæŒ‡ä»¤" class="headerlink" title="shellå†…ç½®timeæŒ‡ä»¤"></a>shellå†…ç½®timeæŒ‡ä»¤</h3><p>è¿™ä¸ªæ–¹æ³•ä¸ç®—æ–°é¢–ï¼Œä½†æ˜¯ç¡®å¾ˆå®ç”¨ã€‚ timeæ˜¯Unix/Linuxå†…ç½®å¤šå‘½ä»¤ï¼Œä½¿ç”¨æ—¶ä¸€èˆ¬ä¸ç”¨ä¼ è¿‡å¤šå‚æ•°ï¼Œç›´æ¥è·Ÿä¸Šéœ€è¦è°ƒè¯•å¤šç¨‹åºå³å¯ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ time go run <span class="built_in">test</span>2.go </span><br><span class="line">&amp;&#123;&#123;0 0&#125; å¼ ä¸‰ 0&#125;</span><br><span class="line"></span><br><span class="line">real    0m0.843s</span><br><span class="line">user    0m0.216s</span><br><span class="line">sys 0m0.389s</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢æ˜¯ä½¿ç”¨timeå¯¹ <code>go run test2.go</code> å¯¹æ‰§è¡Œç¨‹åºåäº†æ€§èƒ½åˆ†æï¼Œå¾—åˆ°3ä¸ªæŒ‡æ ‡ã€‚</p>
<ul>
<li><code>real</code>ï¼šä»ç¨‹åºå¼€å§‹åˆ°ç»“æŸï¼Œå®é™…åº¦è¿‡çš„æ—¶é—´ï¼›</li>
<li><code>user</code>ï¼šç¨‹åºåœ¨ç”¨æˆ·æ€åº¦è¿‡çš„æ—¶é—´ï¼›</li>
<li><code>sys</code>ï¼šç¨‹åºåœ¨å†…æ ¸æ€åº¦è¿‡çš„æ—¶é—´</li>
</ul>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ <code>real</code> &gt;= <code>user</code> + <code>sys</code>ï¼Œå› ä¸ºç³»ç»Ÿè¿˜æœ‰å…¶å®ƒè¿›ç¨‹(åˆ‡æ¢å…¶ä»–è¿›ç¨‹ä¸­é—´å¯¹äºæœ¬è¿›ç¨‹å›æœ‰ç©ºç™½æœŸ)ã€‚</p>
<a id="more"></a>
<h3 id="usr-bin-timeæŒ‡ä»¤"><a href="#usr-bin-timeæŒ‡ä»¤" class="headerlink" title="/usr/bin/timeæŒ‡ä»¤"></a>/usr/bin/timeæŒ‡ä»¤</h3><p>è¿™ä¸ªæŒ‡ä»¤æ¯”å†…ç½®çš„timeæ›´åŠ è¯¦ç»†ä¸€äº›ï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦ç”¨ç»å¯¹è·¯å¾„ï¼Œè€Œä¸”è¦åŠ ä¸Šå‚æ•° <code>-v</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/bin/time -v go run <span class="built_in">test</span>2.go  </span><br><span class="line"></span><br><span class="line">    Command being timed: <span class="string">"go run test2.go"</span></span><br><span class="line">    User time (seconds): 0.12</span><br><span class="line">    System time (seconds): 0.06</span><br><span class="line">    Percent of CPU this job got: 115%</span><br><span class="line">    Elapsed (wall clock) time (h:mm:ss or m:ss): 0:00.16</span><br><span class="line">    Average shared text size (kbytes): 0</span><br><span class="line">    Average unshared data size (kbytes): 0</span><br><span class="line">    Average stack size (kbytes): 0</span><br><span class="line">    Average total size (kbytes): 0</span><br><span class="line">    Maximum resident <span class="built_in">set</span> size (kbytes): 41172</span><br><span class="line">    Average resident <span class="built_in">set</span> size (kbytes): 0</span><br><span class="line">    Major (requiring I/O) page faults: 1</span><br><span class="line">    Minor (reclaiming a frame) page faults: 15880</span><br><span class="line">    Voluntary context switches: 897</span><br><span class="line">    Involuntary context switches: 183</span><br><span class="line">    Swaps: 0</span><br><span class="line">    File system inputs: 256</span><br><span class="line">    File system outputs: 2664</span><br><span class="line">    Socket messages sent: 0</span><br><span class="line">    Socket messages received: 0</span><br><span class="line">    Signals delivered: 0</span><br><span class="line">    Page size (bytes): 4096</span><br><span class="line">    Exit status: 0</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„åŠŸèƒ½è¦å¼ºå¤§å¤šäº†ï¼Œé™¤äº†ä¹‹å‰çš„ä¿¡æ¯å¤–ï¼Œè¿˜åŒ…æ‹¬äº†ï¼š</p>
<ul>
<li>CPUå ç”¨ç‡ï¼›</li>
<li>å†…å­˜ä½¿ç”¨æƒ…å†µï¼›</li>
<li>Page Fault æƒ…å†µï¼›</li>
<li>è¿›ç¨‹åˆ‡æ¢æƒ…å†µï¼›</li>
<li>æ–‡ä»¶ç³»ç»ŸIOï¼›</li>
<li>Socket ä½¿ç”¨æƒ…å†µï¼›</li>
<li>â€¦â€¦</li>
</ul>
<h2 id="åœºæ™¯2ï¼š-å¦‚ä½•åˆ†ægolangç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Ÿ"><a href="#åœºæ™¯2ï¼š-å¦‚ä½•åˆ†ægolangç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Ÿ" class="headerlink" title="åœºæ™¯2ï¼š å¦‚ä½•åˆ†ægolangç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Ÿ"></a>åœºæ™¯2ï¼š å¦‚ä½•åˆ†ægolangç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Ÿ</h2><h3 id="å†…å­˜å ç”¨æƒ…å†µæŸ¥çœ‹"><a href="#å†…å­˜å ç”¨æƒ…å†µæŸ¥çœ‹" class="headerlink" title="å†…å­˜å ç”¨æƒ…å†µæŸ¥çœ‹"></a>å†…å­˜å ç”¨æƒ…å†µæŸ¥çœ‹</h3><p>æˆ‘ä»¬å…ˆå†™ä¸€æ®µdemoä¾‹å­ä»£ç <br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"runtime"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//slice ä¼šåŠ¨æ€æ‰©å®¹ï¼Œç”¨sliceæ¥åšå †å†…å­˜ç”³è¯·</span></span><br><span class="line">    container := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">" ===&gt; loop begin."</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">32</span>*<span class="number">1000</span>*<span class="number">1000</span>; i++ &#123;</span><br><span class="line">        container = <span class="built_in">append</span>(container, i)</span><br><span class="line">    &#125;</span><br><span class="line">    log.Println(<span class="string">" ===&gt; loop end."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    log.Println(<span class="string">"Start."</span>)</span><br><span class="line"></span><br><span class="line">    test()</span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">"force gc."</span>)</span><br><span class="line">    runtime.GC() <span class="comment">//å¼ºåˆ¶è°ƒç”¨gcå›æ”¶</span></span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">"Done."</span>)</span><br><span class="line"></span><br><span class="line">    time.Sleep(<span class="number">3600</span> * time.Second) <span class="comment">//ç¡çœ ï¼Œä¿æŒç¨‹åºä¸é€€å‡º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç¼–è¯‘<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$go</span> build -o snippet_mem &amp;&amp; ./snippet_mem</span><br></pre></td></tr></table></figure></p>
<p>ç„¶ååœ¨./snippet_memè¿›ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œï¼Œæˆ‘ä»¬å†å¼€ä¸€ä¸ªçª—å£ï¼Œé€šè¿‡ <code>top</code> å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜å ç”¨æƒ…å†µ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$top</span> -p $(pidof snippet_mem)</span><br></pre></td></tr></table></figure></p>
<p>å¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š<br><img src="/images/go/godebug_1.png" alt="go debug top"></p>
<p>æˆ‘ä»¬çœ‹å‡ºæ¥ï¼Œæ²¡æœ‰é€€å‡ºçš„snippet_memè¿›ç¨‹æœ‰çº¦830mçš„å†…å­˜è¢«å ç”¨ã€‚</p>
<p>ç›´è§‚ä¸Šæ¥è¯´ï¼Œè¿™ä¸ªç¨‹åºåœ¨ <code>test()</code> å‡½æ•°æ‰§è¡Œå®Œåï¼Œåˆ‡ç‰‡ <code>contaner</code> çš„å†…å­˜åº”è¯¥è¢«é‡Šæ”¾ï¼Œä¸åº”è¯¥å ç”¨830Mé‚£ä¹ˆå¤§ã€‚</p>
<p>ä¸‹é¢è®©æˆ‘ä»¬ä½¿ç”¨GODEBUGæ¥åˆ†æç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚</p>
<h3 id="GODEBUGä¸gctrace"><a href="#GODEBUGä¸gctrace" class="headerlink" title="GODEBUGä¸gctrace"></a>GODEBUGä¸gctrace</h3><h4 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h4><p>æ‰§è¡Œ<code>snippet_mem</code>ç¨‹åºä¹‹å‰æ·»åŠ ç¯å¢ƒå˜é‡<code>GODEBUG=&#39;gctrace=1&#39;</code>æ¥è·Ÿè¸ªæ‰“å°åƒåœ¾å›æ”¶å™¨ä¿¡æ¯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ GODEBUG=<span class="string">'gctrace=1'</span> ./snippet_mem</span><br></pre></td></tr></table></figure></p>
<p>è®¾ç½®<code>gctrace=1</code>ä¼šä½¿å¾—åƒåœ¾å›æ”¶å™¨åœ¨æ¯æ¬¡å›æ”¶æ—¶æ±‡æ€»æ‰€å›æ”¶å†…å­˜çš„å¤§å°ä»¥åŠè€—æ—¶ï¼Œ<br>å¹¶å°†è¿™äº›å†…å®¹æ±‡æ€»æˆå•è¡Œå†…å®¹æ‰“å°åˆ°æ ‡å‡†é”™è¯¯è¾“å‡ºä¸­ã€‚</p>
<h4 id="æ ¼å¼"><a href="#æ ¼å¼" class="headerlink" title="æ ¼å¼"></a>æ ¼å¼</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gc <span class="comment"># @#s #%: #+#+# ms clock, #+#/#/#+# ms cpu, #-&gt;#-&gt;# MB, # MB goal, # P</span></span><br></pre></td></tr></table></figure>
<p>å«ä¹‰<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gc <span class="comment">#        GCæ¬¡æ•°çš„ç¼–å·ï¼Œæ¯æ¬¡GCæ—¶é€’å¢</span></span><br><span class="line">@<span class="comment">#s         è·ç¦»ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶çš„æ—¶é—´</span></span><br><span class="line"><span class="comment">#%          GCå ç”¨çš„æ‰§è¡Œæ—¶é—´ç™¾åˆ†æ¯”</span></span><br><span class="line"><span class="comment">#+...+#     GCä½¿ç”¨çš„æ—¶é—´</span></span><br><span class="line"><span class="comment">#-&gt;#-&gt;# MB  GCå¼€å§‹ï¼Œç»“æŸï¼Œä»¥åŠå½“å‰æ´»è·ƒå †å†…å­˜çš„å¤§å°ï¼Œå•ä½M</span></span><br><span class="line"><span class="comment"># MB goal   å…¨å±€å †å†…å­˜å¤§å°</span></span><br><span class="line"><span class="comment"># P         ä½¿ç”¨processorçš„æ•°é‡</span></span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœæ¯æ¡ä¿¡æ¯æœ€åï¼Œä»¥<code>(forced)</code>ç»“å°¾ï¼Œé‚£ä¹ˆè¯¥ä¿¡æ¯æ˜¯ç”±<code>runtime.GC()</code>è°ƒç”¨è§¦å‘</p>
<p>æˆ‘ä»¬æ¥é€‰æ‹©å…¶ä¸­ä¸€è¡Œæ¥è§£é‡Šä¸€ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gc 17 @0.149s 1%: 0.004+36+0.003 ms clock, 0.009+0/0.051/36+0.006 ms cpu, 181-&gt;181-&gt;101 MB, 182 MB goal, 2 P</span><br></pre></td></tr></table></figure></p>
<p>è¯¥æ¡ä¿¡æ¯å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>gc 17</code>: Gc è°ƒè¯•ç¼–å·ä¸º17</li>
<li><code>@0.149s</code>: æ­¤æ—¶ç¨‹åºå·²ç»æ‰§è¡Œäº†0.149s</li>
<li><code>1%</code>: 0.149sä¸­å…¶ä¸­gcæ¨¡å—å ç”¨äº†1%çš„æ—¶é—´</li>
<li><code>0.004+36+0.003 ms clock</code>: åƒåœ¾å›æ”¶çš„æ—¶é—´ï¼Œåˆ†åˆ«ä¸ºSTWï¼ˆstop-the-worldï¼‰æ¸…æ‰«çš„æ—¶é—´+å¹¶å‘æ ‡è®°å’Œæ‰«æçš„æ—¶é—´+STWæ ‡è®°çš„æ—¶é—´</li>
<li><code>0.009+0/0.051/36+0.006 ms cpu</code>: åƒåœ¾å›æ”¶å ç”¨cpuæ—¶é—´</li>
<li><code>181-&gt;181-&gt;101 MB</code>: GCå¼€å§‹å‰å †å†…å­˜181Mï¼Œ GCç»“æŸåå †å†…å­˜181Mï¼Œå½“å‰æ´»è·ƒçš„å †å†…å­˜101M</li>
<li><code>182 MB goal</code>: å…¨å±€å †å†…å­˜å¤§å°</li>
<li><code>2 P</code>: æœ¬æ¬¡GCä½¿ç”¨äº†2ä¸ªP(è°ƒåº¦å™¨ä¸­çš„Processer)</li>
</ul>
<p>äº†è§£äº†GCçš„è°ƒè¯•ä¿¡æ¯è¯»æ³•åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æœ¬æ¬¡GCçš„ç»“æœã€‚</p>
<p>æˆ‘ä»¬è¿˜æ˜¯æ‰§è¡ŒGODEBUGè°ƒè¯•<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ GODEBUG=<span class="string">'gctrace=1'</span> ./snippet_mem</span><br></pre></td></tr></table></figure></p>
<p>ç»“æœå¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">2020/03/02 11:22:37 Start.</span><br><span class="line">2020/03/02 11:22:37  ===&gt; loop begin.</span><br><span class="line">gc 1 @0.002s 5%: 0.14+0.45+0.002 ms clock, 0.29+0/0.042/0.33+0.005 ms cpu, 4-&gt;4-&gt;0 MB, 5 MB goal, 2 P</span><br><span class="line">gc 2 @0.003s 4%: 0.13+3.7+0.019 ms clock, 0.27+0/0.037/2.8+0.038 ms cpu, 4-&gt;4-&gt;2 MB, 5 MB goal, 2 P</span><br><span class="line">gc 3 @0.008s 3%: 0.002+1.1+0.001 ms clock, 0.005+0/0.083/1.0+0.003 ms cpu, 6-&gt;6-&gt;2 MB, 7 MB goal, 2 P</span><br><span class="line">gc 4 @0.010s 3%: 0.003+0.99+0.002 ms clock, 0.006+0/0.041/0.82+0.004 ms cpu, 5-&gt;5-&gt;2 MB, 6 MB goal, 2 P</span><br><span class="line">gc 5 @0.011s 4%: 0.079+0.80+0.003 ms clock, 0.15+0/0.046/0.51+0.006 ms cpu, 6-&gt;6-&gt;3 MB, 7 MB goal, 2 P</span><br><span class="line">gc 6 @0.013s 4%: 0.15+3.7+0.002 ms clock, 0.31+0/0.061/3.3+0.005 ms cpu, 8-&gt;8-&gt;8 MB, 9 MB goal, 2 P</span><br><span class="line">gc 7 @0.019s 3%: 0.004+2.5+0.005 ms clock, 0.008+0/0.051/2.1+0.010 ms cpu, 20-&gt;20-&gt;6 MB, 21 MB goal, 2 P</span><br><span class="line">gc 8 @0.023s 5%: 0.014+3.7+0.002 ms clock, 0.029+0.040/1.2/0+0.005 ms cpu, 15-&gt;15-&gt;8 MB, 16 MB goal, 2 P</span><br><span class="line">gc 9 @0.031s 4%: 0.003+1.6+0.001 ms clock, 0.007+0.094/0/0+0.003 ms cpu, 19-&gt;19-&gt;10 MB, 20 MB goal, 2 P</span><br><span class="line">gc 10 @0.034s 3%: 0.006+5.2+0.004 ms clock, 0.013+0/0.045/5.0+0.008 ms cpu, 24-&gt;24-&gt;13 MB, 25 MB goal, 2 P</span><br><span class="line">gc 11 @0.040s 3%: 0.12+2.6+0.002 ms clock, 0.24+0/0.043/2.5+0.004 ms cpu, 30-&gt;30-&gt;16 MB, 31 MB goal, 2 P</span><br><span class="line">gc 12 @0.043s 3%: 0.11+4.4+0.002 ms clock, 0.23+0/0.044/4.1+0.005 ms cpu, 38-&gt;38-&gt;21 MB, 39 MB goal, 2 P</span><br><span class="line">gc 13 @0.049s 3%: 0.008+10+0.040 ms clock, 0.017+0/0.045/10+0.080 ms cpu, 47-&gt;47-&gt;47 MB, 48 MB goal, 2 P</span><br><span class="line">gc 14 @0.070s 2%: 0.004+12+0.002 ms clock, 0.008+0/0.062/12+0.005 ms cpu, 122-&gt;122-&gt;41 MB, 123 MB goal, 2 P</span><br><span class="line">gc 15 @0.084s 2%: 0.11+11+0.038 ms clock, 0.22+0/0.064/3.9+0.076 ms cpu, 93-&gt;93-&gt;93 MB, 94 MB goal, 2 P</span><br><span class="line">gc 16 @0.122s 1%: 0.005+25+0.010 ms clock, 0.011+0/0.12/24+0.021 ms cpu, 238-&gt;238-&gt;80 MB, 239 MB goal, 2 P</span><br><span class="line">gc 17 @0.149s 1%: 0.004+36+0.003 ms clock, 0.009+0/0.051/36+0.006 ms cpu, 181-&gt;181-&gt;101 MB, 182 MB goal, 2 P</span><br><span class="line">gc 18 @0.187s 1%: 0.12+19+0.004 ms clock, 0.25+0/0.049/19+0.008 ms cpu, 227-&gt;227-&gt;126 MB, 228 MB goal, 2 P</span><br><span class="line">gc 19 @0.207s 1%: 0.096+27+0.004 ms clock, 0.19+0/0.077/0.73+0.009 ms cpu, 284-&gt;284-&gt;284 MB, 285 MB goal, 2 P</span><br><span class="line">gc 20 @0.287s 0%: 0.005+944+0.040 ms clock, 0.011+0/0.048/1.3+0.081 ms cpu, 728-&gt;728-&gt;444 MB, 729 MB goal, 2 P</span><br><span class="line">2020/03/02 11:22:38  ===&gt; loop end.</span><br><span class="line">2020/03/02 11:22:38 force gc.</span><br><span class="line">gc 21 @1.236s 0%: 0.004+0.099+0.001 ms clock, 0.008+0/0.018/0.071+0.003 ms cpu, 444-&gt;444-&gt;0 MB, 888 MB goal, 2 P (forced)</span><br><span class="line">2020/03/02 11:22:38 Done.</span><br><span class="line">GC forced</span><br><span class="line">gc 22 @122.455s 0%: 0.010+0.15+0.003 ms clock, 0.021+0/0.025/0.093+0.007 ms cpu, 0-&gt;0-&gt;0 MB, 4 MB goal, 2 P</span><br><span class="line">GC forced</span><br><span class="line">gc 23 @242.543s 0%: 0.007+0.075+0.002 ms clock, 0.014+0/0.022/0.085+0.004 ms cpu, 0-&gt;0-&gt;0 MB, 4 MB goal, 2 P</span><br><span class="line">GC forced</span><br><span class="line">gc 24 @362.545s 0%: 0.018+0.19+0.006 ms clock, 0.037+0/0.055/0.15+0.013 ms cpu, 0-&gt;0-&gt;0 MB, 4 MB goal, 2 P</span><br><span class="line">GC forced</span><br><span class="line">gc 25 @482.548s 0%: 0.012+0.25+0.005 ms clock, 0.025+0/0.025/0.11+0.010 ms cpu, 0-&gt;0-&gt;0 MB, 4 MB goal, 2 P</span><br><span class="line">GC forced</span><br><span class="line">gc 26 @602.551s 0%: 0.009+0.10+0.003 ms clock, 0.018+0/0.021/0.075+0.006 ms cpu, 0-&gt;0-&gt;0 MB, 4 MB goal, 2 P</span><br><span class="line">GC forced</span><br><span class="line">gc 27 @722.554s 0%: 0.012+0.30+0.005 ms clock, 0.025+0/0.15/0.22+0.011 ms cpu, 0-&gt;0-&gt;0 MB, 4 MB goal, 2 P</span><br><span class="line">GC forced</span><br><span class="line">gc 28 @842.556s 0%: 0.027+0.18+0.003 ms clock, 0.054+0/0.11/0.14+0.006 ms cpu, 0-&gt;0-&gt;0 MB, 4 MB goal, 2 P</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>å…ˆçœ‹åœ¨<code>test()</code>å‡½æ•°æ‰§è¡Œå®Œåç«‹å³æ‰“å°çš„<code>gc 21</code>é‚£è¡Œçš„ä¿¡æ¯ã€‚<code>444-&gt;444-&gt;0 MB, 888 MB goal</code>è¡¨ç¤ºåƒåœ¾å›æ”¶å™¨å·²ç»æŠŠ<code>444M</code>çš„å†…å­˜æ ‡è®°ä¸ºéæ´»è·ƒçš„å†…å­˜ã€‚</p>
<p>å†çœ‹ä¸‹ä¸€ä¸ªè®°å½•<code>gc 22ã€‚0-&gt;0-&gt;0 MB, 4 MB goal</code>è¡¨ç¤ºåƒåœ¾å›æ”¶å™¨ä¸­çš„å…¨å±€å †å†…å­˜å¤§å°ç”±<code>888M</code>ä¸‹é™ä¸º<code>4M</code>ã€‚</p>
<h4 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h4><ol>
<li><strong>åœ¨test()å‡½æ•°æ‰§è¡Œå®Œåï¼Œdemoç¨‹åºä¸­çš„åˆ‡ç‰‡å®¹å™¨æ‰€ç”³è¯·çš„å †ç©ºé—´éƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶äº†</strong>ã€‚</li>
<li>å¦‚æœæ­¤æ—¶åœ¨<code>top</code>æŒ‡ä»¤æŸ¥è¯¢å†…å­˜çš„æ—¶å€™ï¼Œå¦‚æœä¾ç„¶å…ˆæ­»800+MBï¼Œè¯´æ˜<strong>åƒåœ¾å›æ”¶å™¨å›æ”¶äº†åº”ç”¨å±‚çš„å†…å­˜åï¼Œï¼ˆå¯èƒ½ï¼‰å¹¶ä¸ä¼šç«‹å³å°†å†…å­˜å½’è¿˜ç»™ç³»ç»Ÿ</strong>ã€‚å…·ä½“åˆ†æåŸå› å¯è§ï¼š<a href="https://segmentfault.com/a/1190000022472459" target="_blank" rel="external">è¸©å‘è®°ï¼šgoæœåŠ¡å†…å­˜æš´æ¶¨</a></li>
</ol>
<h3 id="runtime-ReadMemStats"><a href="#runtime-ReadMemStats" class="headerlink" title="runtime.ReadMemStats"></a>runtime.ReadMemStats</h3><p>æ¥ä¸‹æ¥æˆ‘ä¹ˆæ¢å¦ä¸€ç§æ–¹å¼æŸ¥çœ‹å†…å­˜çš„æ–¹å¼ åˆ©ç”¨ runtimeåº“é‡Œçš„<code>ReadMemStats()</code>æ–¹æ³•<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo2.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"runtime"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readMemStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ms runtime.MemStats</span><br><span class="line">    runtime.ReadMemStats(&amp;ms)</span><br><span class="line">    log.Printf(<span class="string">" ===&gt; Alloc:%d(bytes) HeapIdle:%d(bytes) HeapReleased:%d(bytes)"</span>, ms.Alloc, ms.HeapIdle, ms.HeapReleased)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//slice ä¼šåŠ¨æ€æ‰©å®¹ï¼Œç”¨sliceæ¥åšå †å†…å­˜ç”³è¯·</span></span><br><span class="line">    container := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">" ===&gt; loop begin."</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">32</span>*<span class="number">1000</span>*<span class="number">1000</span>; i++ &#123;</span><br><span class="line">        container = <span class="built_in">append</span>(container, i)</span><br><span class="line">        <span class="keyword">if</span> ( i == <span class="number">16</span>*<span class="number">1000</span>*<span class="number">1000</span>) &#123;</span><br><span class="line">            readMemStats()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">" ===&gt; loop end."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    log.Println(<span class="string">" ===&gt; [Start]."</span>)</span><br><span class="line"></span><br><span class="line">    readMemStats()</span><br><span class="line">    test()</span><br><span class="line">    readMemStats()</span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">" ===&gt; [force gc]."</span>)</span><br><span class="line">    runtime.GC() <span class="comment">//å¼ºåˆ¶è°ƒç”¨gcå›æ”¶</span></span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">" ===&gt; [Done]."</span>)</span><br><span class="line">    readMemStats()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            readMemStats()</span><br><span class="line">            time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    time.Sleep(<span class="number">3600</span> * time.Second) <span class="comment">//ç¡çœ ï¼Œä¿æŒç¨‹åºä¸é€€å‡º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œæˆ‘ä»¬ï¼Œ å°è£…äº†ä¸€ä¸ªå‡½æ•°<code>readMemStats()</code>ï¼Œè¿™é‡Œé¢ä¸»è¦æ˜¯è°ƒç”¨<code>runtime</code>ä¸­çš„<code>ReadMemStats()</code>æ–¹æ³•è·å¾—å†…å­˜ä¿¡æ¯ï¼Œç„¶åé€šè¿‡<code>log</code>æ‰“å°å‡ºæ¥ã€‚</p>
<p>æˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹ä»£ç å¹¶è¿è¡Œ:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ go run demo2.go </span><br><span class="line">2020/03/02 18:21:17  ===&gt; [Start].</span><br><span class="line">2020/03/02 18:21:17  ===&gt; Alloc:71280(bytes) HeapIdle:66633728(bytes) HeapReleased:66600960(bytes)</span><br><span class="line">2020/03/02 18:21:17  ===&gt; loop begin.</span><br><span class="line">2020/03/02 18:21:18  ===&gt; Alloc:132535744(bytes) HeapIdle:336756736(bytes) HeapReleased:155721728(bytes)</span><br><span class="line">2020/03/02 18:21:38  ===&gt; loop end.</span><br><span class="line">2020/03/02 18:21:38  ===&gt; Alloc:598300600(bytes) HeapIdle:609181696(bytes) HeapReleased:434323456(bytes)</span><br><span class="line">2020/03/02 18:21:38  ===&gt; [force gc].</span><br><span class="line">2020/03/02 18:21:38  ===&gt; [Done].</span><br><span class="line">2020/03/02 18:21:38  ===&gt; Alloc:55840(bytes) HeapIdle:1207427072(bytes) HeapReleased:434266112(bytes)</span><br><span class="line">2020/03/02 18:21:38  ===&gt; Alloc:56656(bytes) HeapIdle:1207394304(bytes) HeapReleased:434266112(bytes)</span><br><span class="line">2020/03/02 18:21:48  ===&gt; Alloc:56912(bytes) HeapIdle:1207394304(bytes) HeapReleased:1206493184(bytes)</span><br><span class="line">2020/03/02 18:21:58  ===&gt; Alloc:57488(bytes) HeapIdle:1207394304(bytes) HeapReleased:1206493184(bytes)</span><br><span class="line">2020/03/02 18:22:08  ===&gt; Alloc:57616(bytes) HeapIdle:1207394304(bytes) HeapReleased:1206493184(bytes)</span><br><span class="line">c2020/03/02 18:22:18  ===&gt; Alloc:57744(bytes) HeapIdle:1207394304(bytes) HeapReleased:1206493184(by</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ‰“å°<code>[Done].</code>ä¹‹åé‚£æ¡traceä¿¡æ¯ï¼ŒAllocå·²ç»ä¸‹é™ï¼Œå³å†…å­˜å·²è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚åœ¨<code>2020/03/02 18:21:38</code>å’Œ<code>2020/03/02 18:21:48</code>çš„ä¸¤æ¡traceä¿¡æ¯ä¸­ï¼ŒHeapReleasedå¼€å§‹ä¸Šå‡ï¼Œå³åƒåœ¾å›æ”¶å™¨æŠŠå†…å­˜å½’è¿˜ç»™ç³»ç»Ÿã€‚</p>
<p>å¦å¤–ï¼ŒMemStatsè¿˜å¯ä»¥è·å–å…¶å®ƒå“ªäº›ä¿¡æ¯ä»¥åŠå­—æ®µçš„å«ä¹‰å¯ä»¥å‚è§å®˜æ–¹æ–‡æ¡£ï¼š<a href="http://golang.org/pkg/runtime/#MemStats" target="_blank" rel="external">http://golang.org/pkg/runtime/#MemStats</a></p>
<h3 id="pprofå·¥å…·"><a href="#pprofå·¥å…·" class="headerlink" title="pprofå·¥å…·"></a>pprofå·¥å…·</h3><p>pprofå·¥å…·æ”¯æŒç½‘é¡µä¸ŠæŸ¥çœ‹å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œéœ€è¦åœ¨ä»£ç ä¸­æ·»åŠ ä¸€ä¸ªåç¨‹å³å¯ã€‚<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(</span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    _ <span class="string">"net/http/pprof"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    log.Println(http.ListenAndServe(<span class="string">"0.0.0.0:10000"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure></p>
<p>å…·ä½“æ·»åŠ çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//demo3.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"runtime"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    _ <span class="string">"net/http/pprof"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readMemStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ms runtime.MemStats</span><br><span class="line">    runtime.ReadMemStats(&amp;ms)</span><br><span class="line">    log.Printf(<span class="string">" ===&gt; Alloc:%d(bytes) HeapIdle:%d(bytes) HeapReleased:%d(bytes)"</span>, ms.Alloc, ms.HeapIdle, ms.HeapReleased)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//slice ä¼šåŠ¨æ€æ‰©å®¹ï¼Œç”¨sliceæ¥åšå †å†…å­˜ç”³è¯·</span></span><br><span class="line">    container := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">" ===&gt; loop begin."</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">32</span>*<span class="number">1000</span>*<span class="number">1000</span>; i++ &#123;</span><br><span class="line">        container = <span class="built_in">append</span>(container, i)</span><br><span class="line">        <span class="keyword">if</span> ( i == <span class="number">16</span>*<span class="number">1000</span>*<span class="number">1000</span>) &#123;</span><br><span class="line">            readMemStats()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">" ===&gt; loop end."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//å¯åŠ¨pprof</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        log.Println(http.ListenAndServe(<span class="string">"0.0.0.0:10000"</span>, <span class="literal">nil</span>))</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">" ===&gt; [Start]."</span>)</span><br><span class="line"></span><br><span class="line">    readMemStats()</span><br><span class="line">    test()</span><br><span class="line">    readMemStats()</span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">" ===&gt; [force gc]."</span>)</span><br><span class="line">    runtime.GC() <span class="comment">//å¼ºåˆ¶è°ƒç”¨gcå›æ”¶</span></span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">" ===&gt; [Done]."</span>)</span><br><span class="line">    readMemStats()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            readMemStats()</span><br><span class="line">            time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    time.Sleep(<span class="number">3600</span> * time.Second) <span class="comment">//ç¡çœ ï¼Œä¿æŒç¨‹åºä¸é€€å‡º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬æ­£å¸¸è¿è¡Œç¨‹åºï¼Œç„¶ååŒæ—¶æ‰“å¼€æµè§ˆå™¨ï¼Œ</p>
<p>è¾“å…¥åœ°å€ï¼š<a href="http://127.0.0.1:10000/debug/pprof/heap?debug=1" target="_blank" rel="external">http://127.0.0.1:10000/debug/pprof/heap?debug=1</a></p>
<p>æµè§ˆå™¨çš„å†…å®¹å…¶ä¸­æœ‰ä¸€éƒ¨åˆ†å¦‚ä¸‹ï¼Œè®°å½•äº†ç›®å‰çš„å†…å­˜æƒ…å†µ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># runtime.MemStats</span></span><br><span class="line"><span class="comment"># Alloc = 228248</span></span><br><span class="line"><span class="comment"># TotalAlloc = 1293696976</span></span><br><span class="line"><span class="comment"># Sys = 834967896</span></span><br><span class="line"><span class="comment"># Lookups = 0</span></span><br><span class="line"><span class="comment"># Mallocs = 2018</span></span><br><span class="line"><span class="comment"># Frees = 671</span></span><br><span class="line"><span class="comment"># HeapAlloc = 228248</span></span><br><span class="line"><span class="comment"># HeapSys = 804913152</span></span><br><span class="line"><span class="comment"># HeapIdle = 804102144</span></span><br><span class="line"><span class="comment"># HeapInuse = 811008</span></span><br><span class="line"><span class="comment"># HeapReleased = 108552192</span></span><br><span class="line"><span class="comment"># HeapObjects = 1347</span></span><br><span class="line"><span class="comment"># Stack = 360448 / 360448</span></span><br><span class="line"><span class="comment"># MSpan = 28288 / 32768</span></span><br><span class="line"><span class="comment"># MCache = 3472 / 16384</span></span><br><span class="line"><span class="comment"># BuckHashSys = 1449617</span></span><br><span class="line"><span class="comment"># GCSys = 27418976</span></span><br><span class="line"><span class="comment"># OtherSys = 776551</span></span><br><span class="line"><span class="comment"># NextGC = 4194304</span></span><br><span class="line"><span class="comment"># LastGC = 1583203571137891390</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure></p>
<h2 id="åœºæ™¯3-å¦‚ä½•åˆ†æGolangç¨‹åºçš„CPUæ€§èƒ½æƒ…å†µï¼Ÿ"><a href="#åœºæ™¯3-å¦‚ä½•åˆ†æGolangç¨‹åºçš„CPUæ€§èƒ½æƒ…å†µï¼Ÿ" class="headerlink" title="åœºæ™¯3: å¦‚ä½•åˆ†æGolangç¨‹åºçš„CPUæ€§èƒ½æƒ…å†µï¼Ÿ"></a>åœºæ™¯3: å¦‚ä½•åˆ†æGolangç¨‹åºçš„CPUæ€§èƒ½æƒ…å†µï¼Ÿ</h2><h3 id="æ€§èƒ½åˆ†ææ³¨æ„äº‹é¡¹"><a href="#æ€§èƒ½åˆ†ææ³¨æ„äº‹é¡¹" class="headerlink" title="æ€§èƒ½åˆ†ææ³¨æ„äº‹é¡¹"></a>æ€§èƒ½åˆ†ææ³¨æ„äº‹é¡¹</h3><ul>
<li>æ€§èƒ½åˆ†æå¿…é¡»åœ¨ä¸€ä¸ªå¯é‡å¤çš„ã€ç¨³å®šçš„ç¯å¢ƒä¸­æ¥è¿›è¡Œã€‚</li>
<li>æœºå™¨å¿…é¡»é—²ç½®<ul>
<li>ä¸è¦åœ¨å…±äº«ç¡¬ä»¶ä¸Šè¿›è¡Œæ€§èƒ½åˆ†æ;</li>
<li>ä¸è¦åœ¨æ€§èƒ½åˆ†ææœŸé—´ï¼Œåœ¨åŒä¸€ä¸ªæœºå™¨ä¸Šå»æµè§ˆç½‘é¡µ</li>
</ul>
</li>
<li>æ³¨æ„çœç”µæ¨¡å¼å’Œè¿‡çƒ­ä¿æŠ¤ï¼Œå¦‚æœçªç„¶è¿›å…¥è¿™äº›æ¨¡å¼ï¼Œä¼šå¯¼è‡´åˆ†ææ•°æ®ä¸¥é‡ä¸å‡†ç¡®</li>
<li><strong>ä¸è¦ä½¿ç”¨è™šæ‹Ÿæœºã€å…±äº«çš„äº‘ä¸»æœº</strong>ï¼Œå¤ªå¤šå¹²æ‰°å› ç´ ï¼Œåˆ†ææ•°æ®ä¼šå¾ˆä¸ä¸€è‡´</li>
<li>ä¸è¦åœ¨ macOS 10.11 åŠä»¥å‰çš„ç‰ˆæœ¬è¿è¡Œæ€§èƒ½åˆ†æï¼Œæœ‰ bugï¼Œä¹‹åçš„ç‰ˆæœ¬ä¿®å¤äº†</li>
</ul>
<p>å¦‚æœæ‰¿å—å¾—èµ·ï¼Œè´­ä¹°ä¸“ç”¨çš„æ€§èƒ½æµ‹è¯•åˆ†æçš„ç¡¬ä»¶è®¾å¤‡ï¼Œä¸Šæ¶ã€‚</p>
<ul>
<li>å…³é—­ç”µæºç®¡ç†ã€è¿‡çƒ­ç®¡ç†</li>
<li>ç»ä¸è¦å‡çº§ï¼Œä»¥ä¿è¯æµ‹è¯•çš„ä¸€è‡´æ€§ï¼Œä»¥åŠå…·æœ‰å¯æ¯”æ€§</li>
</ul>
<p>å¦‚æœæ²¡æœ‰è¿™æ ·çš„ç¯å¢ƒï¼Œé‚£å°±ä¸€å®šè¦åœ¨å¤šä¸ªç¯å¢ƒä¸­ï¼Œæ‰§è¡Œå¤šæ¬¡ï¼Œä»¥å–å¾—å¯å‚è€ƒçš„ã€å…·æœ‰ç›¸å¯¹ä¸€è‡´æ€§çš„æµ‹è¯•ç»“æœã€‚</p>
<h3 id="CPUæ€§èƒ½åˆ†æ"><a href="#CPUæ€§èƒ½åˆ†æ" class="headerlink" title="CPUæ€§èƒ½åˆ†æ"></a>CPUæ€§èƒ½åˆ†æ</h3><p>æˆ‘ä»¬æ¥ç”¨ä¸‹é¢çš„ä»£ç è¿›è¡Œæµ‹è¯•<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//demo4.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"bytes"</span></span><br><span class="line">    <span class="string">"math/rand"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    _ <span class="string">"net/http/pprof"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    log.Println(<span class="string">" ===&gt; loop begin."</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">        log.Println(genSomeBytes())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">" ===&gt; loop end."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">genSomeBytes</span><span class="params">()</span> *<span class="title">bytes</span>.<span class="title">Buffer</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> buff bytes.Buffer</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="number">20000</span>; i++ &#123;</span><br><span class="line">        buff.Write([]<span class="keyword">byte</span>&#123;<span class="string">'0'</span> + <span class="keyword">byte</span>(rand.Intn(<span class="number">10</span>))&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;buff</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            test()</span><br><span class="line">            time.Sleep(time.Second * <span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨pprof</span></span><br><span class="line">    http.ListenAndServe(<span class="string">"0.0.0.0:10000"</span>, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œé¢è¿˜æ˜¯å¯åŠ¨äº†pprofçš„åšæŒº,æœ‰å…³<code>pprof</code>å¯åŠ¨çš„ä»£ç å¦‚ä¸‹:<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    _ <span class="string">"net/http/pprof"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//å¯åŠ¨pprof</span></span><br><span class="line">  http.ListenAndServe(<span class="string">"0.0.0.0:10000"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>main()</code>é‡Œçš„æµç¨‹å¾ˆç®€å•,å¯åŠ¨ä¸€ä¸ªgoroutineå»æ— é™å¾ªç¯è°ƒç”¨<code>test()</code>æ–¹æ³•,ä¼‘çœ 1s.</p>
<p><code>test()</code>çš„æµç¨‹æ˜¯ç”Ÿæˆ1000ä¸ª20000ä¸ªå­—ç¬¦çš„éšæœºå­—ç¬¦ä¸².å¹¶ä¸”æ‰“å°.</p>
<p>æˆ‘ä»¬å°†ä¸Šé¢çš„ä»£ç ç¼–è¯‘æˆå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ <code>demo4</code>(è®°ä½è¿™ä¸ªåå­—,ç¨åæˆ‘ä»¬èƒ½ç”¨åˆ°)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ go build demo4.go</span><br></pre></td></tr></table></figure></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å¯åŠ¨ç¨‹åº,ç¨‹åºä¼šæ— é™å¾ªç¯çš„æ‰“å°å­—ç¬¦ä¸².</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡å‡ ç§æ–¹å¼æ¥æŸ¥çœ‹è¿›ç¨‹çš„cpuæ€§èƒ½æƒ…å†µ.</p>
<h4 id="A-Webç•Œé¢æŸ¥çœ‹"><a href="#A-Webç•Œé¢æŸ¥çœ‹" class="headerlink" title="A. Webç•Œé¢æŸ¥çœ‹"></a>A. Webç•Œé¢æŸ¥çœ‹</h4><p>æµè§ˆå™¨è®¿é—®: <a href="http://127.0.0.1:10000/debug/pprof/" target="_blank" rel="external">http://127.0.0.1:10000/debug/pprof/</a></p>
<p>æˆ‘ä»¬ä¼šçœ‹åˆ°å¦‚ä¸‹ç”»é¢<br><img src="/images/go/godebug_2.png" alt="go pprof web"></p>
<p>è¿™é‡Œé¢èƒ½å¤Ÿé€šè¿‡pprofæŸ¥çœ‹åŒ…æ‹¬(é˜»å¡ä¿¡æ¯ã€cpuä¿¡æ¯ã€å†…å­˜å †ä¿¡æ¯ã€é”ä¿¡æ¯ã€goroutineä¿¡æ¯ç­‰ç­‰), æˆ‘ä»¬è¿™é‡Œå…³å¿ƒçš„cpuçš„æ€§èƒ½çš„<code>profile</code>ä¿¡æ¯.</p>
<p>æœ‰å…³<code>profile</code>ä¸‹é¢çš„è‹±æ–‡è§£é‡Šå¤§è‡´å¦‚ä¸‹:</p>
<blockquote>
<p>â€œCPUé…ç½®æ–‡ä»¶ã€‚æ‚¨å¯ä»¥åœ¨ç§’GETå‚æ•°ä¸­æŒ‡å®šæŒç»­æ—¶é—´ã€‚è·å–æ¦‚è¦æ–‡ä»¶åï¼Œè¯·ä½¿ç”¨go tool pprofå‘½ä»¤è°ƒæŸ¥æ¦‚è¦æ–‡ä»¶ã€‚â€</p>
</blockquote>
<p>æ‰€ä»¥æˆ‘ä»¬è¦æ˜¯æƒ³å¾—åˆ°cpuæ€§èƒ½,å°±æ˜¯è¦è·å–åˆ°å½“å‰è¿›ç¨‹çš„<code>profile</code>æ–‡ä»¶,è¿™ä¸ªæ–‡ä»¶é»˜è®¤æ˜¯30sç”Ÿæˆä¸€ä¸ª,æ‰€ä»¥ä½ çš„ç¨‹åºè¦è‡³å°‘è¿è¡Œ30sä»¥ä¸Š(è¿™ä¸ªå‚æ•°ä¹Ÿå¯ä»¥ä¿®æ”¹,ç¨åæˆ‘ä»¬ä»‹ç»)</p>
<p>æˆ‘ä»¬å¯ä»¥ç›´æ¥ç‚¹å‡»ç½‘é¡µçš„<code>profile</code>,æµè§ˆå™¨ä¼šç»™æˆ‘ä»¬ä¸‹è½½ä¸€ä¸ª<code>profile</code>æ–‡ä»¶. è®°ä½è¿™ä¸ªæ–‡ä»¶çš„è·¯å¾„, å¯ä»¥æ‹·è´åˆ°ä¸<code>demo4</code>æ‰€åœ¨çš„åŒä¸€æ–‡ä»¶å¤¹ä¸‹.</p>
<h4 id="B-ä½¿ç”¨pprofå·¥å…·æŸ¥çœ‹"><a href="#B-ä½¿ç”¨pprofå·¥å…·æŸ¥çœ‹" class="headerlink" title="B. ä½¿ç”¨pprofå·¥å…·æŸ¥çœ‹"></a>B. ä½¿ç”¨pprofå·¥å…·æŸ¥çœ‹</h4><p>pprof çš„æ ¼å¼å¦‚ä¸‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof [binary] [profile]</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>binary</code>: å¿…é¡»æŒ‡å‘ç”Ÿæˆè¿™ä¸ªæ€§èƒ½åˆ†ææ•°æ®çš„é‚£ä¸ªäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼›</li>
<li><code>profile</code>: å¿…é¡»æ˜¯è¯¥äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶æ‰€ç”Ÿæˆçš„æ€§èƒ½åˆ†ææ•°æ®æ–‡ä»¶ã€‚</li>
</ul>
<p><code>binary</code> å’Œ <code>profile</code> <strong>å¿…é¡»ä¸¥æ ¼åŒ¹é…</strong>ã€‚</p>
<p>æˆ‘ä»¬æ¥æŸ¥çœ‹ä¸€ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ go tool pprof ./demo4 profile</span><br><span class="line"></span><br><span class="line">File: demo4</span><br><span class="line">Type: cpu</span><br><span class="line">Time: Mar 3, 2020 at 11:18pm (CST)</span><br><span class="line">Duration: 30.13s, Total samples = 6.27s (20.81%)</span><br><span class="line">Entering interactive mode (<span class="built_in">type</span> <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof)</span><br></pre></td></tr></table></figure></p>
<p><strong>help</strong>å¯ä»¥æŸ¥çœ‹ä¸€äº›æŒ‡ä»¤,æˆ‘ä¹ˆå¯ä»¥é€šè¿‡<strong>top</strong>æ¥æŸ¥çœ‹cpuçš„æ€§èƒ½æƒ…å†µ.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> 5090ms, 81.18% of 6270ms total</span><br><span class="line">Dropped 80 nodes (cum &lt;= 31.35ms)</span><br><span class="line">Showing top 10 nodes out of 60</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">    1060ms 16.91% 16.91%     2170ms 34.61%  math/rand.(*lockedSource).Int63</span><br><span class="line">     850ms 13.56% 30.46%      850ms 13.56%  sync.(*Mutex).Unlock (inline)</span><br><span class="line">     710ms 11.32% 41.79%     2950ms 47.05%  math/rand.(*Rand).Int31n</span><br><span class="line">     570ms  9.09% 50.88%      990ms 15.79%  bytes.(*Buffer).Write</span><br><span class="line">     530ms  8.45% 59.33%      540ms  8.61%  syscall.Syscall</span><br><span class="line">     370ms  5.90% 65.23%      370ms  5.90%  runtime.procyield</span><br><span class="line">     270ms  4.31% 69.54%     4490ms 71.61%  main.genSomeBytes</span><br><span class="line">     250ms  3.99% 73.52%     3200ms 51.04%  math/rand.(*Rand).Intn</span><br><span class="line">     250ms  3.99% 77.51%      250ms  3.99%  runtime.memmove</span><br><span class="line">     230ms  3.67% 81.18%      690ms 11.00%  runtime.suspendG</span><br><span class="line">(pprof)</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œé¢æœ‰å‡ åˆ—æ•°æ®,éœ€è¦è¯´æ˜ä¸€ä¸‹.</p>
<ul>
<li>flatï¼šå½“å‰å‡½æ•°å ç”¨CPUçš„è€—æ—¶</li>
<li>flat%ï¼š:å½“å‰å‡½æ•°å ç”¨CPUçš„è€—æ—¶ç™¾åˆ†æ¯”</li>
<li>sun%ï¼šå‡½æ•°å ç”¨CPUçš„è€—æ—¶ç´¯è®¡ç™¾åˆ†æ¯”</li>
<li>cumï¼šå½“å‰å‡½æ•°åŠ ä¸Šè°ƒç”¨å½“å‰å‡½æ•°çš„å‡½æ•°å ç”¨CPUçš„æ€»è€—æ—¶</li>
<li>cum%ï¼šå½“å‰å‡½æ•°åŠ ä¸Šè°ƒç”¨å½“å‰å‡½æ•°çš„å‡½æ•°å ç”¨CPUçš„æ€»è€—æ—¶ç™¾åˆ†æ¯”</li>
<li>æœ€åä¸€åˆ—ï¼šå‡½æ•°åç§°</li>
</ul>
<p>é€šè¿‡ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹å‡º, è¯¥ç¨‹åºçš„å¤§éƒ¨åˆ†cpuæ€§èƒ½æ¶ˆè€—åœ¨ <code>main.getSoneBytes()</code>æ–¹æ³•ä¸­,å…¶ä¸­math/randå–éšæœºæ•°æ¶ˆè€—æ¯”è¾ƒå¤§.</p>
<h4 id="C-é€šè¿‡go-tool-pprofå¾—åˆ°profileæ–‡ä»¶"><a href="#C-é€šè¿‡go-tool-pprofå¾—åˆ°profileæ–‡ä»¶" class="headerlink" title="C. é€šè¿‡go tool pprofå¾—åˆ°profileæ–‡ä»¶"></a>C. é€šè¿‡go tool pprofå¾—åˆ°profileæ–‡ä»¶</h4><p>æˆ‘ä»¬ä¸Šé¢çš„profileæ–‡ä»¶æ˜¯é€šè¿‡webæµè§ˆå™¨ä¸‹è½½çš„,è¿™ä¸ªprofileçš„ç»è¿‡æ—¶é—´æ˜¯30sçš„,é»˜è®¤å€¼æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸Šä¿®æ”¹ä¸äº†,å¦‚æœä½ æƒ³å¾—åˆ°æ—¶é—´æ›´é•¿çš„cpuåˆ©ç”¨ç‡,å¯ä»¥é€šè¿‡<code>go tool pprof</code>æŒ‡ä»¤ä¸ç¨‹åºäº¤äº’æ¥è·å–åˆ°</p>
<p>é¦–å…ˆ,æˆ‘ä»¬å…ˆå¯åŠ¨ç¨‹åº<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./demo4</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åå†æ‰“å¼€ä¸€ä¸ªç»ˆç«¯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof http://localhost:10000/debug/pprof/profile?seconds=60</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œåˆ¶å®šäº†ç”Ÿæˆprofileæ–‡ä»¶çš„æ—¶é—´é—´éš”60s</p>
<p>ç­‰å¾…60sä¹‹å, ç»ˆç«¯å°±ä¼šæœ‰ç»“æœå‡ºæ¥,æˆ‘ä»¬ç»§ç»­ä½¿ç”¨topæ¥æŸ¥çœ‹.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ go tool pprof http://localhost:10000/debug/pprof/profile?seconds=60</span><br><span class="line">Fetching profile over HTTP from http://localhost:10000/debug/pprof/profile?seconds=60</span><br><span class="line">Saved profile <span class="keyword">in</span> /home/itheima/pprof/pprof.demo4.samples.cpu.005.pb.gz</span><br><span class="line">File: demo4</span><br><span class="line">Type: cpu</span><br><span class="line">Time: Mar 3, 2020 at 11:59pm (CST)</span><br><span class="line">Duration: 1mins, Total samples = 12.13s (20.22%)</span><br><span class="line">Entering interactive mode (<span class="built_in">type</span> <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> 9940ms, 81.95% of 12130ms total</span><br><span class="line">Dropped 110 nodes (cum &lt;= 60.65ms)</span><br><span class="line">Showing top 10 nodes out of 56</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">    2350ms 19.37% 19.37%     4690ms 38.66%  math/rand.(*lockedSource).Int63</span><br><span class="line">    1770ms 14.59% 33.97%     1770ms 14.59%  sync.(*Mutex).Unlock (inline)</span><br><span class="line">    1290ms 10.63% 44.60%     6040ms 49.79%  math/rand.(*Rand).Int31n</span><br><span class="line">    1110ms  9.15% 53.75%     1130ms  9.32%  syscall.Syscall</span><br><span class="line">     810ms  6.68% 60.43%     1860ms 15.33%  bytes.(*Buffer).Write</span><br><span class="line">     620ms  5.11% 65.54%     6660ms 54.91%  math/rand.(*Rand).Intn</span><br><span class="line">     570ms  4.70% 70.24%      570ms  4.70%  runtime.procyield</span><br><span class="line">     500ms  4.12% 74.36%     9170ms 75.60%  main.genSomeBytes</span><br><span class="line">     480ms  3.96% 78.32%      480ms  3.96%  runtime.memmove</span><br><span class="line">     440ms  3.63% 81.95%      440ms  3.63%  math/rand.(*rngSource).Uint64</span><br><span class="line">(pprof)</span><br></pre></td></tr></table></figure></p>
<p>ä¾ç„¶ä¼šå¾—åˆ°cpuæ€§èƒ½çš„ç»“æœ, æˆ‘ä»¬å‘ç°è¿™æ¬¡çš„ç»“æœä¸ä¸Šæ¬¡30sçš„ç»“æœç™¾åˆ†æ¯”ç±»ä¼¼.</p>
<h4 id="D-å¯è§†åŒ–æŸ¥çœ‹"><a href="#D-å¯è§†åŒ–æŸ¥çœ‹" class="headerlink" title="D.å¯è§†åŒ–æŸ¥çœ‹"></a>D.å¯è§†åŒ–æŸ¥çœ‹</h4><p>æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ go tool pprof ./demo4 profile</span><br></pre></td></tr></table></figure></p>
<p>è¿›å…¥profileæ–‡ä»¶æŸ¥çœ‹,ç„¶åæˆ‘ä»¬è¾“å…¥<code>web</code>æŒ‡ä»¤.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ go tool pprof ./demo4 profileFile: demo4</span><br><span class="line">Type: cpu</span><br><span class="line">Time: Mar 3, 2020 at 11:18pm (CST)</span><br><span class="line">Duration: 30.13s, Total samples = 6.27s (20.81%)</span><br><span class="line">Entering interactive mode (<span class="built_in">type</span> <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) web</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œå¦‚æœæŠ¥æ‰¾ä¸åˆ°<code>graphviz</code>å·¥å…·ï¼Œéœ€è¦å®‰è£…ä¸€ä¸‹ã€‚è¿™é‡Œè‡ªè¡Œç™¾åº¦å¦‚ä½•å®‰è£…</p>
<p>ç„¶åæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ª<code>svg</code>çš„å¯è§†åŒ–æ–‡ä»¶åœ¨<code>/tmp</code>è·¯å¾„ä¸‹<br><img src="/images/go/godebug_3.png" alt="go pprof web"></p>
<p>è¿™æ ·æˆ‘ä»¬å°±èƒ½æ¯”è¾ƒæ¸…æ™°çš„çœ‹åˆ°å‡½æ•°ä¹‹é—´çš„è°ƒç”¨å…³ç³»,æ–¹å—è¶Šå¤§çš„è¡¨ç¤ºcpuçš„å ç”¨è¶Šå¤§.</p>
<p>æ¥æºï¼šåˆ˜ä¸¹å†°Aceld ç®€ä¹¦</p>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Kubernetes Etcd æ•°æ®å¤‡ä»½ä¸æ¢å¤]]></title>
      <url>http://team.jiunile.com/blog/2020/05/k8s-etcd-backup-restore.html</url>
      <content type="html"><![CDATA[<h2 id="ç³»ç»Ÿç¯å¢ƒ"><a href="#ç³»ç»Ÿç¯å¢ƒ" class="headerlink" title="ç³»ç»Ÿç¯å¢ƒ"></a>ç³»ç»Ÿç¯å¢ƒ</h2><blockquote>
<p>Etcd ç‰ˆæœ¬ï¼š3.4.3<br>Kubernetes ç‰ˆæœ¬ï¼š1.17.4<br>Kubernetes å®‰è£…æ–¹å¼ï¼šKubeadm</p>
</blockquote>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Kubernetes ä½¿ç”¨ Etcd æ•°æ®åº“å®æ—¶å­˜å‚¨é›†ç¾¤ä¸­çš„æ•°æ®ï¼Œå¯ä»¥è¯´ Etcd æ˜¯ Kubernetes çš„æ ¸å¿ƒç»„ä»¶ï¼ŒçŠ¹å¦‚äººç±»çš„å¤§è„‘ã€‚å¦‚æœ Etcd æ•°æ®æŸåå°†å¯¼è‡´ Kubernetes ä¸å¯ç”¨ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ Etcd æ•°æ®æ˜¯ä¸€å®šè¦åšå¥½é«˜å¯ç”¨ä¸æ•°æ®å¤‡ä»½ï¼Œè¿™é‡Œä»‹ç»ä¸‹å¦‚ä½•å¤‡ä»½ä¸æ¢å¤ Etcd æ•°æ®ã€‚</p>
<h2 id="å¤‡ä»½-Etcd-æ•°æ®"><a href="#å¤‡ä»½-Etcd-æ•°æ®" class="headerlink" title="å¤‡ä»½ Etcd æ•°æ®"></a>å¤‡ä»½ Etcd æ•°æ®</h2><p>é‡‡ç”¨é•œåƒæ–¹å¼éƒ¨ç½²çš„ Etcdï¼Œæ‰€ä»¥æ“ä½œ Etcd éœ€è¦ä½¿ç”¨ Etcd é•œåƒæä¾›çš„ Etcdctl å·¥å…·ã€‚å¦‚æœä½ æ˜¯éé•œåƒæ–¹å¼éƒ¨ç½² Etcdï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ Etcdctl å‘½ä»¤å¤‡ä»½æ•°æ®ã€‚</p>
<p>è¿è¡Œ Etcd é•œåƒï¼Œå¹¶ä¸”ä½¿ç”¨é•œåƒå†…éƒ¨çš„ etcdctl å·¥å…·è¿æ¥ etcd é›†ç¾¤ï¼Œæ‰§è¡Œæ•°æ®å¿«ç…§å¤‡ä»½ï¼š</p>
<ul>
<li>/bin/sh -cï¼šæ‰§è¡Œ shell å‘½ä»¤</li>
<li>â€“envï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®š etcdctl å·¥å…·ä½¿ç”¨çš„ API ç‰ˆæœ¬</li>
<li>-vï¼šdocker æŒ‚è½½é€‰é¡¹ï¼Œç”¨äºæŒ‚è½½ Etcd è¯ä¹¦ç›¸å…³ç›®å½•ä»¥åŠå¤‡ä»½æ•°æ®å­˜æ”¾çš„ç›®å½•</li>
<li>â€“cacertï¼šetcd CA è¯ä¹¦</li>
<li>â€“keyï¼šetcd å®¢æˆ·ç«¯è¯ä¹¦ key</li>
<li>â€“certï¼šetcd å®¢æˆ·ç«¯è¯ä¹¦ crt</li>
<li>â€“endpointsï¼šæŒ‡å®š ETCD è¿æ¥åœ°å€</li>
<li>etcdctl snapshot saveï¼šetcd æ•°æ®å¤‡ä»½</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm                                    \</span><br><span class="line">-v /data/backup:/backup                              \</span><br><span class="line">-v /etc/kubernetes/pki/etcd:/etc/kubernetes/pki/etcd \</span><br><span class="line">--env ETCDCTL_API=3                                  \</span><br><span class="line">k8s.gcr.io/etcd:3.4.3-0                              \</span><br><span class="line">/bin/sh -c <span class="string">"etcdctl --endpoints=https://192.168.2.11:2379 \</span><br><span class="line">--cacert=/etc/kubernetes/pki/etcd/ca.crt                  \</span><br><span class="line">--key=/etc/kubernetes/pki/etcd/healthcheck-client.key     \</span><br><span class="line">--cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt    \</span><br><span class="line">snapshot save /backup/etcd-snapshot.db"</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="æ¢å¤-ETCD-æ•°æ®"><a href="#æ¢å¤-ETCD-æ•°æ®" class="headerlink" title="æ¢å¤ ETCD æ•°æ®"></a>æ¢å¤ ETCD æ•°æ®</h2><p>åœ¨ Etcd æ•°æ®æŸåæ—¶ï¼Œå¯ä»¥é€šè¿‡ Etcd å¤‡ä»½æ•°æ®è¿›è¡Œæ•°æ®æ¢å¤ï¼Œå…ˆæš‚åœ Kubernetes ç›¸å…³ç»„ä»¶ï¼Œç„¶åè¿›å…¥ Etcd é•œåƒä½¿ç”¨ etcdctl å·¥å…·æ‰§è¡Œæ¢å¤æ“ä½œã€‚</p>
<h3 id="æš‚åœ-Kube-Apiserver-ä¸-Etcd-é•œåƒ"><a href="#æš‚åœ-Kube-Apiserver-ä¸-Etcd-é•œåƒ" class="headerlink" title="æš‚åœ Kube-Apiserver ä¸ Etcd é•œåƒ"></a>æš‚åœ Kube-Apiserver ä¸ Etcd é•œåƒ</h3><p>åœ¨æ¢å¤ Etcd æ•°æ®å‰ï¼Œéœ€è¦åœæ­¢ <code>kube-apiserver</code> ä¸ <code>etcd</code> é•œåƒï¼Œå› ä¸ºå½“è¿™ä¿©é•œåƒåœæ­¢å Kubernetes ä¼šè‡ªåŠ¨é‡å¯è¿™ä¿©é•œåƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆæš‚æ—¶ç§»é™¤ <code>/etc/kubernetes/manifests</code> ç›®å½•ï¼ŒKubernetes æ£€æµ‹è¿™ä¸ªç›®å½•æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä¼šåœæ­¢ Kubernetes ç³»ç»Ÿç›¸å…³é•œåƒï¼Œä½¿å…¶ä¸èƒ½é‡å¯ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œåç»­çš„æ“ä½œã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç§»é™¤ä¸”å¤‡ä»½ /etc/kubernetes/manifests ç›®å½•</span></span><br><span class="line">$ mv /etc/kubernetes/manifests /etc/kubernetes/manifests.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ kube-apiserverã€etcd é•œåƒæ˜¯å¦åœæ­¢</span></span><br><span class="line">$ docker ps|grep etcd &amp;&amp; docker ps|grep kube-apiserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤‡ä»½ç°æœ‰ Etcd æ•°æ®</span></span><br><span class="line">$ mv /var/lib/etcd /var/lib/etcd.bak</span><br></pre></td></tr></table></figure></p>
<h3 id="æ¢å¤-Etcd-æ•°æ®"><a href="#æ¢å¤-Etcd-æ•°æ®" class="headerlink" title="æ¢å¤ Etcd æ•°æ®"></a>æ¢å¤ Etcd æ•°æ®</h3><p>è¿è¡Œ Etcd é•œåƒï¼Œç„¶åæ‰§è¡Œæ•°æ®æ¢å¤ï¼Œé»˜è®¤ä¼šæ¢å¤åˆ° <code>/default.etcd/member/</code> ç›®å½•ä¸‹ï¼Œè¿™é‡Œä½¿ç”¨ <code>mv</code> å‘½ä»¤åœ¨ç§»åŠ¨åˆ°æŒ‚è½½ç›®å½• <code>/var/lib/etcd/</code> ä¸‹ã€‚</p>
<ul>
<li>/bin/sh -cï¼šæ‰§è¡Œ shell å‘½ä»¤</li>
<li>â€“envï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®š etcdctl å·¥å…·ä½¿ç”¨çš„ API ç‰ˆæœ¬</li>
<li>-vï¼šdocker æŒ‚è½½é€‰é¡¹ï¼Œç”¨äºæŒ‚è½½ Etcd è¯ä¹¦ç›¸å…³ç›®å½•ä»¥åŠå¤‡ä»½æ•°æ®å­˜æ”¾çš„ç›®å½•</li>
<li>etcdctl snapshot restoreï¼šetcd æ•°æ®æ¢å¤ã€‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm              \</span><br><span class="line">-v /data/backup:/backup        \</span><br><span class="line">-v /var/lib/etcd:/var/lib/etcd \</span><br><span class="line">--env ETCDCTL_API=3            \</span><br><span class="line">k8s.gcr.io/etcd:3.4.3-0        \</span><br><span class="line">/bin/sh -c <span class="string">"etcdctl snapshot restore /backup/etcd-snapshot.db; mv /default.etcd/member/ /var/lib/etcd/"</span></span><br></pre></td></tr></table></figure>
<h3 id="æ¢å¤-Kube-Apiserver-ä¸-Etcd-é•œåƒ"><a href="#æ¢å¤-Kube-Apiserver-ä¸-Etcd-é•œåƒ" class="headerlink" title="æ¢å¤ Kube-Apiserver ä¸ Etcd é•œåƒ"></a>æ¢å¤ Kube-Apiserver ä¸ Etcd é•œåƒ</h3><p>å°† <code>/etc/kubernetes/manifests</code> ç›®å½•æ¢å¤ï¼Œä½¿ Kubernetes é‡å¯ <code>Kube-Apiserver</code> ä¸ <code>Etcd</code> é•œåƒï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mv /etc/kubernetes/manifests.bak /etc/kubernetes/manifests</span><br></pre></td></tr></table></figure></p>
<h3 id="æ‰§è¡Œ-Kubectl-å‘½ä»¤è¿›è¡Œæ£€æµ‹"><a href="#æ‰§è¡Œ-Kubectl-å‘½ä»¤è¿›è¡Œæ£€æµ‹" class="headerlink" title="æ‰§è¡Œ Kubectl å‘½ä»¤è¿›è¡Œæ£€æµ‹"></a>æ‰§è¡Œ Kubectl å‘½ä»¤è¿›è¡Œæ£€æµ‹</h3><p>æ‰§è¡Œ Kubectl å‘½ä»¤è¿›è¡Œæ£€æµ‹ï¼ŒæŸ¥çœ‹å‘½ä»¤æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></figure></p>
<p>å‚è€ƒï¼šmydlq.club</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Kubeadm æ·»åŠ æ–° Master èŠ‚ç‚¹åˆ°é›†ç¾¤å‡ºç° ETCD å¥åº·æ£€æŸ¥å¤±è´¥é”™è¯¯]]></title>
      <url>http://team.jiunile.com/blog/2020/05/k8s-kubeadm-upgrade-master-problem.html</url>
      <content type="html"><![CDATA[<h2 id="ç³»ç»Ÿç¯å¢ƒ"><a href="#ç³»ç»Ÿç¯å¢ƒ" class="headerlink" title="ç³»ç»Ÿç¯å¢ƒ"></a>ç³»ç»Ÿç¯å¢ƒ</h2><blockquote>
<p>Docker ç‰ˆæœ¬ï¼š18.06.3<br>Kubeadm ç‰ˆæœ¬ï¼š1.17.4<br>Kubernetes ç‰ˆæœ¬ï¼š1.17.4<br>Kubernetes Master æ•°é‡ï¼š3<br>Kubernetes å®‰è£…æ–¹å¼ï¼šKubeadm</p>
</blockquote>
<h2 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h2><p>Kubernetes é›†ç¾¤ä¸­æ€»å…±æœ‰ä¸‰å° Masterï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<p>k8s-master-2-11ã€k8s-master-2-12ã€k8s-master-2-13</p>
<p>å¯¹å…¶ä¸­ k8s-master-2-11 Master èŠ‚ç‚¹æœåŠ¡å™¨è¿›è¡Œäº†å†…æ ¸å’Œè½¯ä»¶å‡çº§æ“ä½œï¼Œä»è€Œå…ˆå°†å…¶æš‚æ—¶å‰”å‡ºé›†ç¾¤ï¼Œç„¶åè¿›è¡Œå‡çº§ï¼Œå®Œæˆåå‡†å¤‡é‡æ–°åŠ å…¥åˆ° Kubernetes é›†ç¾¤ï¼Œé€šè¿‡ Kubeadm æ‰§è¡Œï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm join mydlq.club:16443 \</span><br><span class="line">--token 6w0nwi.zag57qgfcdhi76vd \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:efa49231e4ffd836ff996921741c98ac4c5655dc729d7c32aa48c608232f0f08 \</span><br><span class="line">--control-plane --certificate-key a64e9da7346153bd64dba1e5126a644a97fdb63c878bb73de07911d1add8e26b</span><br></pre></td></tr></table></figure></p>
<p>åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¾“å‡ºä¸‹é¢æ—¥å¿—ï¼Œæç¤º etcd ç›‘æ§æ£€æŸ¥å¤±è´¥ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">"kube-controller-manager"</span></span><br><span class="line">W0329 00:01:51.364121   19209 manifests.go:214] the default kube-apiserver authorization-mode is <span class="string">"Node,RBAC"</span>; using <span class="string">"Node,RBAC"</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">"kube-scheduler"</span></span><br><span class="line">W0329 00:01:51.373807   19209 manifests.go:214] the default kube-apiserver authorization-mode is <span class="string">"Node,RBAC"</span>; using <span class="string">"Node,RBAC"</span></span><br><span class="line">[check-etcd] Checking that the etcd cluster is healthy</span><br><span class="line"></span><br><span class="line">error execution phase check-etcd: etcd cluster is not healthy: failed to dial endpoint https://10.8.18.105:2379 </span><br><span class="line">with maintenance client: context deadline exceeded</span><br><span class="line">To see the stack trace of this error execute with --v=5 or higher</span><br></pre></td></tr></table></figure></p>
<p>æ ¹æ®å…³é”®ä¿¡æ¯ <code>&quot;error execution phase check-etcd&quot;</code> å¯çŸ¥ï¼Œå¯èƒ½æ˜¯åœ¨æ‰§è¡ŒåŠ å…¥ <code>etcd</code> æ—¶å€™å‡ºç°çš„é”™è¯¯ï¼Œå¯¼è‡´ <code>master</code> æ— æ³•åŠ å…¥åŸå…ˆçš„ <code>kubernetes</code> é›†ç¾¤ã€‚</p>
<a id="more"></a>
<h2 id="åˆ†æé—®é¢˜"><a href="#åˆ†æé—®é¢˜" class="headerlink" title="åˆ†æé—®é¢˜"></a>åˆ†æé—®é¢˜</h2><h3 id="æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨"><a href="#æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨" class="headerlink" title="æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨"></a>æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get node</span><br><span class="line"></span><br><span class="line">NAME              STATUS    ROLES     VERSION</span><br><span class="line">k8s-master-2-12    Ready    master    v1.17.4</span><br><span class="line">k8s-master-2-13    Ready    master    v1.17.4</span><br><span class="line">k8s-node-2-14      Ready    &lt;none&gt;    v1.17.4</span><br><span class="line">k8s-node-2-15      Ready    &lt;none&gt;    v1.17.4</span><br><span class="line">k8s-node-2-16      Ready    &lt;none&gt;    v1.17.4</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œk8s-master-2-11 èŠ‚ç‚¹ç¡®å®ä¸åœ¨èŠ‚ç‚¹åˆ—è¡¨ä¸­</p>
<h3 id="æŸ¥çœ‹-Kubeadm-é…ç½®ä¿¡æ¯"><a href="#æŸ¥çœ‹-Kubeadm-é…ç½®ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹ Kubeadm é…ç½®ä¿¡æ¯"></a>æŸ¥çœ‹ Kubeadm é…ç½®ä¿¡æ¯</h3><p>åœ¨çœ‹çœ‹ Kubernetes é›†ç¾¤ä¸­çš„ kubeadm é…ç½®ä¿¡æ¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe configmaps kubeadm-config -n kube-system</span><br></pre></td></tr></table></figure></p>
<p>è·å–åˆ°çš„å†…å®¹å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Name:         kubeadm-config</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">...</span><br><span class="line">ClusterStatus:</span><br><span class="line">----</span><br><span class="line">apiEndpoints:</span><br><span class="line">  k8s-master-2-11:</span><br><span class="line">    advertiseAddress: 192.168.2.11</span><br><span class="line">    <span class="built_in">bind</span>Port: 6443</span><br><span class="line">  k8s-master-2-12:</span><br><span class="line">    advertiseAddress: 192.168.2.12</span><br><span class="line">    <span class="built_in">bind</span>Port: 6443</span><br><span class="line">  k8s-master-2-13:</span><br><span class="line">    advertiseAddress: 192.168.2.13</span><br><span class="line">    <span class="built_in">bind</span>Port: 6443</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterStatus</span><br></pre></td></tr></table></figure></p>
<p>å¯ä¹Ÿçœ‹åˆ° <code>k8s-master-2-11</code> èŠ‚ç‚¹ä¿¡æ¯è¿˜å­˜åœ¨ä¸ <code>kubeadm</code> é…ç½®ä¸­ï¼Œè¯´æ˜ <code>etcd</code> ä¸­è¿˜å­˜å‚¨ç€ <code>k8s-master-2-11</code> ç›¸å…³ä¿¡æ¯ã€‚</p>
<h3 id="åˆ†æé—®é¢˜æ‰€åœ¨åŠè§£å†³æ–¹æ¡ˆ"><a href="#åˆ†æé—®é¢˜æ‰€åœ¨åŠè§£å†³æ–¹æ¡ˆ" class="headerlink" title="åˆ†æé—®é¢˜æ‰€åœ¨åŠè§£å†³æ–¹æ¡ˆ"></a>åˆ†æé—®é¢˜æ‰€åœ¨åŠè§£å†³æ–¹æ¡ˆ</h3><p>å› ä¸ºé›†ç¾¤æ˜¯é€šè¿‡ <code>kubeadm</code> å·¥å…·æ­å»ºçš„ï¼Œä¸”ä½¿ç”¨äº† <code>etcd</code> é•œåƒæ–¹å¼ä¸ <code>master</code> èŠ‚ç‚¹ä¸€èµ·ï¼Œæ‰€ä»¥æ¯ä¸ª <code>Master</code> èŠ‚ç‚¹ä¸Šéƒ½ä¼šå­˜åœ¨ä¸€ä¸ª <code>etcd</code> å®¹å™¨å®ä¾‹ã€‚å½“å‰”é™¤ä¸€ä¸ª <code>master</code> èŠ‚ç‚¹æ—¶ <code>etcd</code> é›†ç¾¤æœªåˆ é™¤å‰”é™¤çš„èŠ‚ç‚¹çš„ <code>etcd</code> æˆå‘˜ä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯è¿˜å­˜åœ¨ <code>etcd</code> é›†ç¾¤åˆ—è¡¨ä¸­ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ <strong>è¿›å…¥ etcd æ‰‹åŠ¨åˆ é™¤ etcd æˆå‘˜ä¿¡æ¯</strong>ã€‚</p>
<h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><h3 id="è·å–-Etcd-é•œåƒåˆ—è¡¨"><a href="#è·å–-Etcd-é•œåƒåˆ—è¡¨" class="headerlink" title="è·å– Etcd é•œåƒåˆ—è¡¨"></a>è·å– Etcd é•œåƒåˆ—è¡¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system | grep etcd</span><br><span class="line"></span><br><span class="line">etcd-k8s-master-2-12   1/1   Running   0</span><br><span class="line">etcd-k8s-master-2-13   1/1   Running   0</span><br></pre></td></tr></table></figure>
<h3 id="è¿›å…¥-Etcd-å®¹å™¨å¹¶åˆ é™¤èŠ‚ç‚¹ä¿¡æ¯"><a href="#è¿›å…¥-Etcd-å®¹å™¨å¹¶åˆ é™¤èŠ‚ç‚¹ä¿¡æ¯" class="headerlink" title="è¿›å…¥ Etcd å®¹å™¨å¹¶åˆ é™¤èŠ‚ç‚¹ä¿¡æ¯"></a>è¿›å…¥ Etcd å®¹å™¨å¹¶åˆ é™¤èŠ‚ç‚¹ä¿¡æ¯</h3><p>é€‰æ‹©ä¸Šé¢ä¸¤ä¸ª etcd ä¸­ä»»æ„ä¸€ä¸ª podï¼Œé€šè¿‡ kubectl å·¥å…·è¿›å…¥ pod å†…éƒ¨ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it etcd-k8s-master-2-12 sh -n kube-system</span><br></pre></td></tr></table></figure></p>
<p>è¿›å…¥å®¹å™¨åï¼ŒæŒ‰ä¸‹é¢æ­¥æ‰§è¡Œ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é…ç½®ç¯å¢ƒ</span></span><br><span class="line">$ <span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">$ <span class="built_in">alias</span> etcdctl=<span class="string">'etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ etcd é›†ç¾¤æˆå‘˜åˆ—è¡¨</span></span><br><span class="line">$ etcdctl member list</span><br><span class="line"></span><br><span class="line">63bfe05c4646fb08, started, k8s-master-2-11, https://192.168.2.11:2380, https://192.168.2.11:2379, <span class="literal">false</span></span><br><span class="line">8e41efd8164c6e3d, started, k8s-master-2-12, https://192.168.2.12:2380, https://192.168.2.12:2379, <span class="literal">false</span></span><br><span class="line">a61d0bd53c1cbcb6, started, k8s-master-2-13, https://192.168.2.13:2380, https://192.168.2.13:2379, <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ etcd é›†ç¾¤æˆå‘˜ k8s-master-2-11</span></span><br><span class="line">$ etcdctl member remove 63bfe05c4646fb08</span><br><span class="line"></span><br><span class="line">Member 63bfe05c4646fb08 removed from cluster ed984b9o8w35<span class="built_in">cap</span>2</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†æ¬¡æŸ¥çœ‹ etcd é›†ç¾¤æˆå‘˜åˆ—è¡¨</span></span><br><span class="line">$ etcdctl member list</span><br><span class="line"></span><br><span class="line">8e41efd8164c6e3d, started, k8s-master-2-12, https://192.168.2.12:2380, https://192.168.2.12:2379, <span class="literal">false</span></span><br><span class="line">a61d0bd53c1cbcb6, started, k8s-master-2-13, https://192.168.2.13:2380, https://192.168.2.13:2379, <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é€€å‡ºå®¹å™¨</span></span><br><span class="line">$ <span class="built_in">exit</span></span><br></pre></td></tr></table></figure></p>
<h3 id="é€šè¿‡-kubeadm-å‘½ä»¤å†æ¬¡å°è¯•åŠ å…¥é›†ç¾¤"><a href="#é€šè¿‡-kubeadm-å‘½ä»¤å†æ¬¡å°è¯•åŠ å…¥é›†ç¾¤" class="headerlink" title="é€šè¿‡ kubeadm å‘½ä»¤å†æ¬¡å°è¯•åŠ å…¥é›†ç¾¤"></a>é€šè¿‡ kubeadm å‘½ä»¤å†æ¬¡å°è¯•åŠ å…¥é›†ç¾¤</h3><p>é€šè¿‡ <code>kubeadm</code> å‘½ä»¤å†æ¬¡å°è¯•å°† <code>k8s-master-2-11</code> èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼Œåœ¨æ‰§è¡Œå‰é¦–å…ˆè¿›å…¥åˆ° <code>k8s-master-2-11</code> èŠ‚ç‚¹æœåŠ¡å™¨ï¼Œæ‰§è¡Œ <code>kubeadm</code> çš„æ¸…é™¤å‘½ä»¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm reset</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åå°è¯•åŠ å…¥ kubernetes é›†ç¾¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm join mydlq.club:16443 \</span><br><span class="line">--token 6w0nwi.zag57qgfcdhi76vd \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:efa49231e4ffd836ff996921741c98ac4c5655dc729d7c32aa48c608232f0f08 \</span><br><span class="line">--control-plane --certificate-key a64e9da7346153bd64dba1e5126a644a97fdb63c878bb73de07911d1add8e26b</span><br></pre></td></tr></table></figure></p>
<p>å‚è€ƒï¼šmydlq.club</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[kubernetes 1.18+ ä½¿ç”¨ipvsåcorednsæ— æ³•è§£æåŸŸåé‡‡å‘è®°]]></title>
      <url>http://team.jiunile.com/blog/2020/05/k8s-1-18-ipvs-problem.html</url>
      <content type="html"><![CDATA[<h2 id="ç¯å¢ƒç°è±¡"><a href="#ç¯å¢ƒç°è±¡" class="headerlink" title="ç¯å¢ƒç°è±¡"></a>ç¯å¢ƒç°è±¡</h2><blockquote>
<p>CoreDNS ç‰ˆæœ¬ï¼š1.6.7<br>Docker ç‰ˆæœ¬ï¼š18.06.3-ce<br>Kubernetes ç‰ˆæœ¬ï¼š1.18.1<br>æ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼šCentOS 7.x<br>CentOS å†…æ ¸ç‰ˆæœ¬ï¼š3.10.0-693.2.2.el7.x86_64</p>
</blockquote>
<h2 id="é—®é¢˜ç°è±¡"><a href="#é—®é¢˜ç°è±¡" class="headerlink" title="é—®é¢˜ç°è±¡"></a>é—®é¢˜ç°è±¡</h2><p>ç”±äºæœ€è¿‘è¦å‘ç»„å†…æ¼”ç¤º Istio 1.5ï¼Œæ•…åœ¨äº‘æœåŠ¡å™¨ä¸Šå®‰è£…äº†kubernetes 1.18.1 (ä½¿ç”¨ipvs) æ¥é…åˆ Istio 1.5 çš„æ¼”ç¤ºï¼Œkubernetes ä¸ istio å®‰è£…å®Œåä¸€åˆ‡é¡ºåˆ©ï¼Œbookinfo demoè·‘çš„ä¹Ÿéå¸¸çš„é¡ºåˆ©ã€‚ä½†åœ¨ä¸€æ¬¡é‡å¯æ•´ä¸ªé›†ç¾¤åï¼Œä¸€åˆ‡éƒ½å˜çš„ä¸é‚£ä¹ˆç¾å¥½äº†ã€‚istio-proxyèµ·ä¸æ¥äº†ï¼Œæç¤ºpilot not readyï¼Œæ›´å¯æ‚²çš„æ˜¯service name æ— æ³•è§£æäº†ï¼Œå¯¼è‡´å¾ˆå¤šæœåŠ¡ä¹‹é—´çš„è°ƒç”¨éƒ½æ²¡æ³•æ­£å¸¸å·¥ä½œï¼Œæœ‰ä¾èµ–çš„æœåŠ¡éƒ½ä¸èƒ½æ­£å¸¸å¯åŠ¨äº†ï¼Œä¸ºäº†æ›´å¥½çš„å®šä½é—®é¢˜ï¼Œäºæ˜¯å¸è½½ Istio 1.5ï¼Œé‡æ–°å›åˆ°k8s 1.18.1ä¸Šï¼Œåœ¨ä¸€æ­¥æ­¥æ’æŸ¥ä¸­å‘ç°ï¼Œåœ¨podä¸­ä½¿ç”¨pod ipç›¸äº’è®¿é—®æ˜¯å¯ä»¥çš„ï¼Œç”±æ­¤åˆ¤æ–­ï¼Œåˆæ­¥æ€€ç–‘å¾ˆå¯èƒ½æ˜¯ DNS å‡ºç°äº†é—®é¢˜ï¼Œåæ¥æ…¢æ…¢å‘ç° kube-proxy ä¸­çš„é”™è¯¯ï¼Œå†å®šä½åˆ° IPVS parseIP Error é”™è¯¯ï¼Œå†åˆ°è§£å†³é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯æ•´ä¸ªé—®é¢˜å®šä½åˆ†æ</p>
<a id="more"></a>
<h2 id="é—®é¢˜å®šä½"><a href="#é—®é¢˜å®šä½" class="headerlink" title="é—®é¢˜å®šä½"></a>é—®é¢˜å®šä½</h2><p>ä¸ºäº†æ›´å¥½çš„é‡ç°é—®é¢˜ï¼Œæˆ‘é‡æ–°å®‰è£…äº†ä¸€å¥—æ–°çš„ kubernetes 1.18.1ï¼Œå®‰è£…å®ŒåéªŒè¯ä¸€åˆ‡éƒ½æ˜¯okï¼Œæ¥ä¸‹æ¥æˆ‘å°±é‡å¯æ•´ä¸ªé›†ç¾¤ï¼Œé—®é¢˜å°±äº§ç”Ÿäº†ï¼Œåœ¨podä¸­æ— æ³•è§£æservice nameäº†ï¼Œæ‰€æœ‰çš„podè¿è¡Œéƒ½æ˜¯okçš„ï¼Œä¸€åˆ‡éƒ½å˜çš„â€å¾ˆç¥å¥‡â€ï¼Œå¥½å§ï¼Œå¼€å¯å®šä½ä¹‹æ—…ã€‚</p>
<h3 id="éƒ¨ç½²DNSè°ƒè¯•å·¥å…·"><a href="#éƒ¨ç½²DNSè°ƒè¯•å·¥å…·" class="headerlink" title="éƒ¨ç½²DNSè°ƒè¯•å·¥å…·"></a>éƒ¨ç½²DNSè°ƒè¯•å·¥å…·</h3><p>ä¸ºäº†æ¢é’ˆæ˜¯å¦ä¸º DNS é—®é¢˜ï¼Œè¿™é‡Œéœ€è¦æå‰éƒ¨ç½²ç”¨äºæµ‹è¯• DNS é—®é¢˜çš„ dnsutils é•œåƒï¼Œè¯¥é•œåƒä¸­åŒ…å«äº†ç”¨äºæµ‹è¯• DNS é—®é¢˜çš„å·¥å…·åŒ…ï¼Œéå¸¸åˆ©äºæˆ‘ä»¬åˆ†æä¸å‘ç°é—®é¢˜ã€‚</p>
<p>éƒ¨ç½² ndsutils.yaml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Pod</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> dnsutils</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> dnsutils</span><br><span class="line"><span class="attr">    image:</span> mydlqclub/dnsutils:<span class="number">1.3</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="attr">    command:</span> [<span class="string">"sleep"</span>,<span class="string">"3600"</span>]</span><br></pre></td></tr></table></figure></p>
<h3 id="é—®é¢˜åˆ†æ"><a href="#é—®é¢˜åˆ†æ" class="headerlink" title="é—®é¢˜åˆ†æ"></a>é—®é¢˜åˆ†æ</h3><h4 id="1-è¿›å…¥-DNS-å·¥å…·-Pod-çš„å‘½ä»¤è¡Œ"><a href="#1-è¿›å…¥-DNS-å·¥å…·-Pod-çš„å‘½ä»¤è¡Œ" class="headerlink" title="1. è¿›å…¥ DNS å·¥å…· Pod çš„å‘½ä»¤è¡Œ"></a>1. è¿›å…¥ DNS å·¥å…· Pod çš„å‘½ä»¤è¡Œ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it dnsutils sh</span><br></pre></td></tr></table></figure>
<h4 id="2-é€šè¿‡-Ping-å’Œ-Nsloopup-å‘½ä»¤æµ‹è¯•"><a href="#2-é€šè¿‡-Ping-å’Œ-Nsloopup-å‘½ä»¤æµ‹è¯•" class="headerlink" title="2. é€šè¿‡ Ping å’Œ Nsloopup å‘½ä»¤æµ‹è¯•"></a>2. é€šè¿‡ Ping å’Œ Nsloopup å‘½ä»¤æµ‹è¯•</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ping é›†ç¾¤å¤–éƒ¨ï¼Œä¾‹å¦‚è¿™é‡Œ ping ä¸€ä¸‹ç™¾åº¦</span></span><br><span class="line">$ ping www.baidu.com</span><br><span class="line">ping: bad address <span class="string">'www.baidu.com'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ping é›†ç¾¤å†…éƒ¨ kube-apiserver çš„ Service åœ°å€</span></span><br><span class="line">$ ping kubernetes.default</span><br><span class="line">ping: bad address <span class="string">'kubernetes.default'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ nslookup å‘½ä»¤æŸ¥è¯¢åŸŸåä¿¡æ¯</span></span><br><span class="line">$ nslookup kubernetes.default</span><br><span class="line">;; connection timed out; no servers could be reached</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›´æ¥ Ping é›†ç¾¤å†…éƒ¨ kube-apiserver çš„ IP åœ°å€</span></span><br><span class="line">$ ping 10.96.0.1</span><br><span class="line">PING 10.96.0.1 (10.96.0.1): 56 data bytes</span><br><span class="line">64 bytes from 10.96.0.1: seq=0 ttl=64 time=0.096 ms</span><br><span class="line">64 bytes from 10.96.0.1: seq=1 ttl=64 time=0.050 ms</span><br><span class="line">64 bytes from 10.96.0.1: seq=2 ttl=64 time=0.068 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€€å‡º dnsutils Pod å‘½ä»¤è¡Œ</span></span><br><span class="line">$ <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥è§‚å¯Ÿåˆ°ä¸¤æ¬¡ ping åŸŸåéƒ½ä¸èƒ½ ping é€šï¼Œä¸”ä½¿ç”¨ nsloopup åˆ†æåŸŸåä¿¡æ¯æ—¶è¶…æ—¶ã€‚ç„¶è€Œï¼Œä½¿ç”¨ ping kube-apiserver çš„ IP åœ°å€ â€œ10.96.0.1â€ åˆ™å¯ä»¥æ­£å¸¸é€šä¿¡ï¼Œæ‰€ä»¥ï¼Œæ’é™¤ç½‘ç»œæ’ä»¶ï¼ˆflannelã€calico ç­‰ï¼‰çš„é—®é¢˜ã€‚åˆæ­¥åˆ¤æ–­ï¼Œå¾ˆå¯èƒ½æ˜¯ CoreDNS ç»„ä»¶çš„é”™è¯¯å¼•èµ·çš„æŸäº›é—®é¢˜ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬æµ‹è¯• CoreDNS æ˜¯å¦æ­£å¸¸ã€‚</p>
<h4 id="3-æ£€æµ‹-CoreDNS-åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ"><a href="#3-æ£€æµ‹-CoreDNS-åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ" class="headerlink" title="3. æ£€æµ‹ CoreDNS åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ"></a>3. æ£€æµ‹ CoreDNS åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods <span class="_">-l</span> k8s-app=kube-dns -n kube-system</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-669f77d7cc-8pkpw   1/1     Running   2          6h5m</span><br><span class="line">coredns-669f77d7cc-jk9wk   1/1     Running   2          6h5m</span><br></pre></td></tr></table></figure>
<p>å¯ä¹Ÿçœ‹åˆ° CoreDNS ä¸¤ä¸ª Pod å‡æ­£å¸¸å¯åŠ¨ï¼Œæ‰€ä»¥å†æŸ¥çœ‹ä¸¤ä¸ª Pod ä¸­çš„æ—¥å¿—ä¿¡æ¯ï¼Œçœ‹çœ‹æœ‰æ— é”™è¯¯æ—¥å¿—ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> p <span class="keyword">in</span> $(kubectl get pods --namespace=kube-system <span class="_">-l</span> k8s-app=kube-dns -o name); \</span><br><span class="line">  <span class="keyword">do</span> kubectl logs --namespace=kube-system <span class="variable">$p</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">.:53</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = 4e235fcc3696966e76816bcd9034ebc7</span><br><span class="line">CoreDNS-1.6.7</span><br><span class="line">linux/amd64, go1.13.6, da7f65b</span><br><span class="line">.:53</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = 4e235fcc3696966e76816bcd9034ebc7</span><br><span class="line">CoreDNS-1.6.7</span><br><span class="line">linux/amd64, go1.13.6, da7f65b</span><br></pre></td></tr></table></figure></p>
<p>é€šè¿‡ä¸Šé¢ä¿¡æ¯å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œæ—¥å¿—ä¸­ä¿¡æ¯ä¹Ÿæ˜¯æ­£å¸¸å¯åŠ¨æ²¡æœ‰é—®é¢˜ã€‚å†æ¥ä¸‹æ¥ï¼ŒæŸ¥çœ‹ä¸‹ CoreDNS çš„å…¥å£ Service â€œkube-dnsâ€ æ˜¯å¦å­˜åœ¨ï¼š</p>
<blockquote>
<p>kube-dns çš„ IP ä¸º 10.96.0.10ï¼Œé›†ç¾¤å†…çš„ Pod éƒ½æ˜¯é€šè¿‡è¯¥ IP ä¸ DNS ç»„ä»¶è¿›è¡Œäº¤äº’ï¼ŒæŸ¥è¯¢ DNS ä¿¡æ¯ã€‚</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get service -n kube-system | grep kube-dns</span><br><span class="line">NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)               </span><br><span class="line">kube-dns                    ClusterIP   10.96.0.10      &lt;none&gt;        53/UDP,53/TCP,9153/TCP</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æ˜¾ç¤º Service â€œkube-dnsâ€ ä¹Ÿå­˜åœ¨ï¼Œä½†æ˜¯ Service æ˜¯é€šè¿‡ endpoints å’Œ Pod è¿›è¡Œç»‘å®šçš„ï¼Œæ‰€ä»¥çœ‹çœ‹è¿™ä¸ª CoreDNS çš„ endpoints æ˜¯å¦å­˜åœ¨ï¼ŒåŠä¿¡æ¯æ˜¯å¦æ­£ç¡®ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get endpoints kube-dns -n kube-system</span><br><span class="line">NAME       ENDPOINTS                                      </span><br><span class="line">kube-dns   10.244.0.21:53,d10.244.2.82:53,10.244.0.21:9153</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ° endpoints é…ç½®ä¹Ÿæ˜¯æ­£å¸¸çš„ï¼Œæ­£ç¡®çš„ä¸ä¸¤ä¸ª CporeDNS Pod è¿›è¡Œäº†å…³è”ã€‚</p>
<p>ç»è¿‡ä¸Šé¢ä¸€ç³»åˆ—æ£€æµ‹ CoreDNS ç»„ä»¶ç¡®å®æ˜¯æ­£å¸¸è¿è¡Œã€‚æ¥ä¸‹æ¥ï¼Œè§‚å¯Ÿ CoreDNS åŸŸåè§£ææ—¥å¿—ï¼Œè¿›è€Œç¡®å®š Pod ä¸­çš„åŸŸåè§£æè¯·æ±‚æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è¿›å…¥ CoreDNSã€‚</p>
<h4 id="4-è§‚å¯Ÿ-CoreDNS-åŸŸåè§£ææ—¥å¿—ä¿¡æ¯"><a href="#4-è§‚å¯Ÿ-CoreDNS-åŸŸåè§£ææ—¥å¿—ä¿¡æ¯" class="headerlink" title="4. è§‚å¯Ÿ CoreDNS åŸŸåè§£ææ—¥å¿—ä¿¡æ¯"></a>4. è§‚å¯Ÿ CoreDNS åŸŸåè§£ææ—¥å¿—ä¿¡æ¯</h4><p>ä½¿ç”¨ <code>kubectl edit</code> å‘½ä»¤æ¥ä¿®æ”¹å­˜å‚¨äº Kubernetes <code>ConfigMap</code> ä¸­çš„ CoreDNS é…ç½®å‚æ•°ä¿¡æ¯ï¼Œæ·»åŠ  <code>log</code> å‚æ•°ï¼Œè®© CoreDNS æ—¥å¿—ä¸­æ˜¾ç¤ºåŸŸåè§£æä¿¡æ¯ï¼š</p>
<blockquote>
<p>CoreDNS é…ç½®å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li>errors: è¾“å‡ºé”™è¯¯ä¿¡æ¯åˆ°æ§åˆ¶å°ã€‚</li>
<li>healthï¼šCoreDNS è¿›è¡Œç›‘æ§æ£€æµ‹ï¼Œæ£€æµ‹åœ°å€ä¸º <a href="http://localhost:8080/health" target="_blank" rel="external">http://localhost:8080/health</a> å¦‚æœçŠ¶æ€ä¸ºä¸å¥åº·åˆ™è®© Pod è¿›è¡Œé‡å¯ã€‚</li>
<li>ready: å…¨éƒ¨æ’ä»¶å·²ç»åŠ è½½å®Œæˆæ—¶ï¼Œå°†é€šè¿‡ endpoints åœ¨ 8081 ç«¯å£è¿”å› HTTP çŠ¶æ€ 200ã€‚</li>
<li>kubernetesï¼šCoreDNS å°†æ ¹æ® Kubernetes æœåŠ¡å’Œ pod çš„ IP å›å¤ DNS æŸ¥è¯¢ã€‚</li>
<li>prometheusï¼šæ˜¯å¦å¼€å¯ CoreDNS Metrics ä¿¡æ¯æ¥å£ï¼Œå¦‚æœé…ç½®åˆ™å¼€å¯ï¼Œæ¥å£åœ°å€ä¸º <a href="http://localhost:9153/metrics" target="_blank" rel="external">http://localhost:9153/metrics</a></li>
<li>forwardï¼šä»»ä½•ä¸åœ¨Kubernetes é›†ç¾¤å†…çš„åŸŸåæŸ¥è¯¢å°†è¢«è½¬å‘åˆ°é¢„å®šä¹‰çš„è§£æå™¨ (/etc/resolv.conf)ã€‚</li>
<li>cacheï¼šå¯ç”¨ç¼“å­˜ï¼Œ30 ç§’ TTLã€‚</li>
<li>loopï¼šæ£€æµ‹ç®€å•çš„è½¬å‘å¾ªç¯ï¼Œå¦‚æœæ‰¾åˆ°å¾ªç¯åˆ™åœæ­¢ CoreDNS è¿›ç¨‹ã€‚</li>
<li>reloadï¼šç›‘å¬ CoreDNS é…ç½®ï¼Œå¦‚æœé…ç½®å‘ç”Ÿå˜åŒ–åˆ™é‡æ–°åŠ è½½é…ç½®ã€‚</li>
<li>loadbalanceï¼šDNS è´Ÿè½½å‡è¡¡å™¨ï¼Œé»˜è®¤ round_robinã€‚</li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¾‘ coredns é…ç½®</span></span><br><span class="line">$ kubectl edit configmap coredns -n kube-system</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        <span class="built_in">log</span>            <span class="comment">#æ·»åŠ log</span></span><br><span class="line">        errors</span><br><span class="line">        health &#123;</span><br><span class="line">           lameduck 5s</span><br><span class="line">        &#125;</span><br><span class="line">        ready</span><br><span class="line">        kubernetes cluster.local <span class="keyword">in</span>-addr.arpa ip6.arpa &#123;</span><br><span class="line">           pods insecure</span><br><span class="line">           fallthrough <span class="keyword">in</span>-addr.arpa ip6.arpa</span><br><span class="line">           ttl 30</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9153</span><br><span class="line">        forward . /etc/resolv.conf</span><br><span class="line">        cache 30</span><br><span class="line">        loop</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ä¿å­˜æ›´æ”¹å CoreDNS ä¼šè‡ªåŠ¨é‡æ–°åŠ è½½é…ç½®ä¿¡æ¯ï¼Œä¸è¿‡å¯èƒ½éœ€è¦ç­‰ä¸Šä¸€ä¸¤åˆ†é’Ÿæ‰èƒ½å°†è¿™äº›æ›´æ”¹ä¼ æ’­åˆ° CoreDNS Podã€‚ç­‰ä¸€æ®µæ—¶é—´åï¼Œå†æ¬¡æŸ¥çœ‹ CoreDNS æ—¥å¿—ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> p <span class="keyword">in</span> $(kubectl get pods --namespace=kube-system <span class="_">-l</span> k8s-app=kube-dns -o name); \</span><br><span class="line">  <span class="keyword">do</span> kubectl logs --namespace=kube-system <span class="variable">$p</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">.:53</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = 6434d0912b39645ed0707a3569fd69dc</span><br><span class="line">CoreDNS-1.6.7</span><br><span class="line">linux/amd64, go1.13.6, da7f65b</span><br><span class="line">[INFO] Reloading</span><br><span class="line">[INFO] plugin/health: Going into lameduck mode <span class="keyword">for</span> 5s</span><br><span class="line">[INFO] 127.0.0.1:47278 - 55171 <span class="string">"HINFO IN 4940754309314083739.5160468069505858354. udp 57 false 512"</span> NXDOMAIN qr,rd,ra 57 0.040844011s</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac</span><br><span class="line">[INFO] Reloading complete</span><br><span class="line"></span><br><span class="line">.:53</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = 6434d0912b39645ed0707a3569fd69dc</span><br><span class="line">CoreDNS-1.6.7</span><br><span class="line">linux/amd64, go1.13.6, da7f65b</span><br><span class="line">[INFO] Reloading</span><br><span class="line">[INFO] plugin/health: Going into lameduck mode <span class="keyword">for</span> 5s</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac</span><br><span class="line">[INFO] Reloading complete</span><br><span class="line">[INFO] 127.0.0.1:32896 - 49064 <span class="string">"HINFO IN 1027842207973621585.7098421666386159336. udp 57 false 512"</span> NXDOMAIN qr,rd,ra 57 0.044098742s</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac</span><br><span class="line">[INFO] Reloading complete</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ° CoreDNS å·²ç»é‡æ–°åŠ è½½äº†é…ç½®ï¼Œæˆ‘ä»¬å†æ¬¡è¿›å…¥ dnsuitls Pod ä¸­æ‰§è¡Œ ping å‘½ä»¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ DNSutils Pod å‘½ä»¤è¡Œ</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it dnsutils sh </span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œ ping å‘½ä»¤</span></span><br><span class="line">$ ping www.baidu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€€å‡º dnsutils Pod å‘½ä»¤è¡Œ</span></span><br><span class="line">$ <span class="built_in">exit</span></span><br></pre></td></tr></table></figure></p>
<p>ç„¶åï¼Œå†æ¬¡æŸ¥çœ‹ CoreDNS çš„æ—¥å¿—ä¿¡æ¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> p <span class="keyword">in</span> $(kubectl get pods --namespace=kube-system <span class="_">-l</span> k8s-app=kube-dns -o name); \</span><br><span class="line">  <span class="keyword">do</span> kubectl logs --namespace=kube-system <span class="variable">$p</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">.:53</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = 6434d0912b39645ed0707a3569fd69dc</span><br><span class="line">CoreDNS-1.6.7</span><br><span class="line">linux/amd64, go1.13.6, da7f65b</span><br><span class="line">[INFO] Reloading</span><br><span class="line">[INFO] plugin/health: Going into lameduck mode <span class="keyword">for</span> 5s</span><br><span class="line">[INFO] 127.0.0.1:47278 - 55171 <span class="string">"HINFO IN 4940754309314083739.5160468069505858354. udp 57 false 512"</span> NXDOMAIN qr,rd,ra 57 0.040844011s</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac</span><br><span class="line">[INFO] Reloading complete</span><br><span class="line"></span><br><span class="line">.:53</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = 6434d0912b39645ed0707a3569fd69dc</span><br><span class="line">CoreDNS-1.6.7</span><br><span class="line">linux/amd64, go1.13.6, da7f65b</span><br><span class="line">[INFO] Reloading</span><br><span class="line">[INFO] plugin/health: Going into lameduck mode <span class="keyword">for</span> 5s</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac</span><br><span class="line">[INFO] Reloading complete</span><br><span class="line">[INFO] 127.0.0.1:32896 - 49064 <span class="string">"HINFO IN 1027842207973621585.7098421666386159336. udp 57 false 512"</span> NXDOMAIN qr,rd,ra 57 0.044098742s</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac</span><br><span class="line">[INFO] Reloading complete</span><br></pre></td></tr></table></figure></p>
<p>å‘ç°å’Œä¹‹å‰æ²¡æœ‰æ‰§è¡Œ ping å‘½ä»¤æ—¶å€™ä¸€æ ·ï¼Œæ²¡æœ‰ DNS åŸŸåè§£æçš„æ—¥å¿—ä¿¡æ¯ï¼Œè¯´æ˜ Pod æ‰§è¡ŒåŸŸåè§£ææ—¶ï¼Œè¯·æ±‚å¹¶æ²¡æœ‰è¿›å…¥ CoreDNS ä¸­ã€‚æ¥ä¸‹æ¥åœ¨æŸ¥çœ‹ Pod ä¸­ DNS é…ç½®ä¿¡æ¯ï¼Œè¿›è€Œåˆ†æé—®é¢˜ã€‚</p>
<h4 id="5-æŸ¥çœ‹-Pod-ä¸­çš„-DNS-é…ç½®ä¿¡æ¯"><a href="#5-æŸ¥çœ‹-Pod-ä¸­çš„-DNS-é…ç½®ä¿¡æ¯" class="headerlink" title="5. æŸ¥çœ‹ Pod ä¸­çš„ DNS é…ç½®ä¿¡æ¯"></a>5. æŸ¥çœ‹ Pod ä¸­çš„ DNS é…ç½®ä¿¡æ¯</h4><p>ä¸€èˆ¬ Pod ä¸­çš„ <code>DNS</code> ç­–ç•¥é»˜è®¤ä¸º <code>ClusterFirst</code>ï¼Œè¯¥å‚æ•°èµ·åˆ°çš„ä½œç”¨æ˜¯ï¼Œä¼˜å…ˆä» <code>Kubernetes DNS</code> æ’ä»¶åœ°å€è¯»å– <code>DNS</code> é…ç½®ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æ­£å¸¸åˆ›å»ºçš„ Pod ä¸­ï¼ŒDNS é…ç½® DNS æœåŠ¡å™¨åœ°å€åº”è¯¥æŒ‡å®šä¸º Kubernetes é›†ç¾¤çš„ DNS æ’ä»¶ Service æä¾›çš„è™šæ‹Ÿ IP åœ°å€ã€‚</p>
<blockquote>
<p>æ³¨ï¼šå…¶ä¸­ DNS ç­–ç•¥ï¼ˆdnsPolicyï¼‰æ”¯æŒå››ç§ç±»å‹ï¼š</p>
<ul>
<li>Defaultï¼š ä» DNS æ‰€åœ¨èŠ‚ç‚¹ç»§æ‰¿ DNS é…ç½®ï¼Œå³è¯¥ Pod çš„ DNS é…ç½®ä¸å®¿ä¸»æœºå®Œå…¨ä¸€è‡´ã€‚</li>
<li>ClusterFirstï¼šé¢„å…ˆä» Kubenetes çš„ DNS æ’ä»¶ä¸­è¿›è¡Œ DNS è§£æï¼Œå¦‚æœè§£æä¸æˆåŠŸï¼Œæ‰ä¼šä½¿ç”¨å®¿ä¸»æœºçš„ DNS è¿›è¡Œè§£æã€‚</li>
<li>ClusterFirstWithHostNetï¼šPod æ˜¯ç”¨ HOST æ¨¡å¼å¯åŠ¨çš„ï¼ˆhostnetworkï¼‰ï¼Œç”¨ HOST æ¨¡å¼è¡¨ç¤º Pod ä¸­çš„æ‰€æœ‰å®¹å™¨ï¼Œéƒ½ä½¿ç”¨å®¿ä¸»æœºçš„ /etc/resolv.conf é…ç½®è¿›è¡Œ DNS è§£æï¼Œä½†å¦‚æœä½¿ç”¨äº† HOST æ¨¡å¼ï¼Œè¿˜ç»§ç»­ä½¿ç”¨ Kubernetes çš„ DNS æœåŠ¡ï¼Œé‚£å°±å°† dnsPolicy è®¾ç½®ä¸º ClusterFirstWithHostNetã€‚</li>
<li>Noneï¼šå®Œå…¨å¿½ç•¥ kubernetes ç³»ç»Ÿæä¾›çš„ DNSï¼Œä»¥ Pod Spec ä¸­ dnsConfig é…ç½®ä¸ºä¸»ã€‚</li>
</ul>
</blockquote>
<p>ä¸ºäº†å†åˆ†æåŸå› ï¼Œæˆ‘ä»¬æ¥ç€è¿›å…¥ dnsutils Pod ä¸­ï¼ŒæŸ¥çœ‹ Pod ä¸­ DNS é…ç½®æ–‡ä»¶ <code>/etc/resolv.conf</code> é…ç½®å‚æ•°æ˜¯å¦æ­£ç¡®ï¼š</p>
<blockquote>
<p>resolv.conf é…ç½®å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li>searchï¼š æŒ‡æ˜åŸŸåæŸ¥è¯¢é¡ºåºã€‚</li>
<li>nameserverï¼š æŒ‡å®š DNS æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œå¯ä»¥é…ç½®å¤šä¸ª nameserverã€‚</li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ dnsutils Pod å†…éƒ¨ sh å‘½ä»¤è¡Œ</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it dnsutils sh </span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ resolv.conf é…ç½®æ–‡ä»¶</span></span><br><span class="line">$ cat /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">nameserver 10.96.0.10</span><br><span class="line">search kube-system.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€€å‡º DNSutils Pod å‘½ä»¤è¡Œ</span></span><br><span class="line">$ <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° Pod å†…éƒ¨çš„ resolv.conf å†…å®¹ï¼Œå…¶ä¸­ nameserver æŒ‡å®š DNS è§£ææœåŠ¡å™¨ IP ä¸º â€œ10.96.0.10â€ ï¼Œè¿™ä¸ª IP åœ°å€æ­£æ˜¯æœ¬äºº Kubernetes é›†ç¾¤ CoreDNS çš„ Service â€œkube-dnsâ€ çš„ cluterIPï¼Œè¯´æ˜å½“ Pod å†…éƒ¨è¿›è¡ŒåŸŸåè§£ææ—¶ï¼Œç¡®å®æ˜¯å°†æŸ¥è¯¢è¯·æ±‚å‘é€åˆ° Service â€œkube-dnsâ€ æä¾›çš„è™šæ‹Ÿ IP è¿›è¡ŒåŸŸåè§£æã€‚</p>
<p>é‚£ä¹ˆï¼Œæ—¢ç„¶ Pod ä¸­ DNS é…ç½®æ–‡ä»¶æ²¡é—®é¢˜ï¼Œä¸” CoreDNS ä¹Ÿæ²¡é—®é¢˜ï¼Œä¼šä¸ä¼šæ˜¯ Pod æœ¬èº«åŸŸåè§£æä¸æ­£å¸¸å‘¢ï¼Ÿæˆ–è€… Service â€œkube-dnsâ€ æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è½¬å‘åŸŸåè§£æè¯·æ±‚åˆ° CoreDNS Pod ä¸­ï¼Ÿ</p>
<p>å½“ç„¶ï¼ŒçŒœæƒ³æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œè¿›è¡Œä¸€ä¸‹æµ‹è¯•æ¥è§‚å¯Ÿé—®é¢˜åˆ°åº•å‡ºåœ¨å“ªé‡Œã€‚</p>
<h4 id="6-è¿›è¡Œè§‚å¯Ÿæ¥å®šä½é—®é¢˜æ‰€åœ¨"><a href="#6-è¿›è¡Œè§‚å¯Ÿæ¥å®šä½é—®é¢˜æ‰€åœ¨" class="headerlink" title="6. è¿›è¡Œè§‚å¯Ÿæ¥å®šä½é—®é¢˜æ‰€åœ¨"></a>6. è¿›è¡Œè§‚å¯Ÿæ¥å®šä½é—®é¢˜æ‰€åœ¨</h4><p>ä¸Šé¢æ€€ç–‘æ˜¯ Pod æœ¬èº«è§£æåŸŸåæœ‰é—®é¢˜ï¼Œä¸èƒ½æ­£å¸¸è§£æåŸŸåã€‚æˆ–è€… Pod æ²¡é—®é¢˜ï¼Œä½†æ˜¯è¯·æ±‚åŸŸåè§£ææ—¶å°†è¯·æ±‚å‘é€åˆ° Service â€œkube-dnsâ€ åä¸èƒ½æ­£å¸¸è½¬å‘è¯·æ±‚åˆ° CoreDNS Podã€‚ ä¸ºäº†éªŒè¯è¿™ä¸¤ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ Pod ä¸­çš„ /etc/resolv.conf é…ç½®æ¥è¿›è¡Œæµ‹è¯•éªŒè¯ã€‚</p>
<p>ä¿®æ”¹ <code>resolv.conf</code> ä¸­ <code>DNS</code> è§£æè¯·æ±‚åœ°å€ä¸º <code>é˜¿é‡Œäº‘ DNS</code> æœåŠ¡å™¨åœ°å€ï¼Œç„¶åæ‰§è¡Œ <code>ping</code> å‘½ä»¤éªŒè¯æ˜¯å¦ä¸º <code>Pod</code> è§£æåŸŸåæ˜¯å¦æœ‰é—®é¢˜ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ dnsutils Pod å†…éƒ¨ sh å‘½ä»¤è¡Œ</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it dnsutils /bin/sh -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment">## ç¼–è¾‘ /etc/resolv.conf æ–‡ä»¶ï¼Œä¿®æ”¹ nameserver å‚æ•°ä¸ºé˜¿é‡Œäº‘æä¾›çš„ DNS æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">$ vi /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">nameserver 223.5.5.5</span><br><span class="line"><span class="comment">#nameserver 10.96.0.10</span></span><br><span class="line">search kube-system.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å®Œåå†è¿›è¡Œ ping å‘½ä»¤æµ‹è¯•ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½å¤Ÿè§£æ www.baidu.com ç½‘å€</span></span><br><span class="line">$ ping www.baidu.com</span><br><span class="line"></span><br><span class="line">PING www.a.shifen.com (180.101.49.11) 56(84) bytes of data.</span><br><span class="line">64 bytes from 180.101.49.11 (180.101.49.11): icmp_seq=1 ttl=48 time=14.0 ms</span><br><span class="line">64 bytes from 180.101.49.11 (180.101.49.11): icmp_seq=2 ttl=48 time=14.0 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€€å‡º DNSutils Pod å‘½ä»¤è¡Œ</span></span><br><span class="line">$ <span class="built_in">exit</span></span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢å¯ä¹Ÿè§‚å¯Ÿåˆ° Pod ä¸­æ›´æ¢ DNS æœåŠ¡å™¨åœ°å€åï¼ŒåŸŸåè§£ææ­£å¸¸ï¼Œè¯´æ˜ Pod æœ¬èº«åŸŸåè§£ææ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p>
<p>æ¥ä¸‹æ¥å†ä¿®æ”¹ <code>resolv.conf</code> ä¸­ <code>DNS</code> è§£æè¯·æ±‚åœ°å€ä¸º <code>CoreDNS Pod</code> çš„ <code>IP</code> åœ°å€ï¼Œè¿™æ ·è®© <code>Pod</code> ç›´æ¥è¿æ¥ <code>CoreDNS Pod</code> çš„ <code>IP</code>ï¼Œè€Œä¸é€šè¿‡ <code>Service</code> è¿›è¡Œè½¬å‘ï¼Œå†è¿›è¡Œ <code>ping</code> å‘½ä»¤æµ‹è¯•ï¼Œè¿›è€Œåˆ¤æ–­ <code>Service kube-dns</code> æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è½¬å‘è¯·æ±‚åˆ° <code>CoreDNS Pod</code> çš„é—®é¢˜ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ CoreDNS Pod çš„ IP åœ°å€</span></span><br><span class="line">$ kubectl get pods -n kube-system -o wide | grep coredns</span><br><span class="line"></span><br><span class="line">coredns-669f77d7cc-rss5f     1/1     Running   0     10.244.2.155   k8s-node-2-13</span><br><span class="line">coredns-669f77d7cc-rt8l6     1/1     Running   0     10.244.1.163   k8s-node-2-12</span><br><span class="line"></span><br><span class="line"><span class="comment">## è¿›å…¥ dnsutils Pod å†…éƒ¨ sh å‘½ä»¤è¡Œ</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it dnsutils /bin/sh -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment">## ç¼–è¾‘ /etc/resolv.conf æ–‡ä»¶ï¼Œä¿®æ”¹ nameserver å‚æ•°ä¸ºé˜¿é‡Œäº‘æä¾›çš„ DNS æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">$ vi /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">nameserver 10.244.2.155</span><br><span class="line">nameserver 10.244.1.163</span><br><span class="line"><span class="comment">#nameserver 10.96.0.10</span></span><br><span class="line">search kube-system.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å®Œåå†è¿›è¡Œ ping å‘½ä»¤æµ‹è¯•ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½å¤Ÿè§£æ www.baidu.com ç½‘å€</span></span><br><span class="line">$ ping www.baidu.com</span><br><span class="line"></span><br><span class="line">PING www.baidu.com (39.156.66.18): 56 data bytes</span><br><span class="line">64 bytes from 39.156.66.18: seq=0 ttl=127 time=6.054 ms</span><br><span class="line">64 bytes from 39.156.66.18: seq=1 ttl=127 time=4.678 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€€å‡º DNSutils Pod å‘½ä»¤è¡Œ</span></span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è§‚å¯Ÿ CoreDNS æ—¥å¿—ä¿¡æ¯ï¼ŒæŸ¥çœ‹æœ‰æ— åŸŸåè§£æç›¸å…³æ—¥å¿—</span></span><br><span class="line">$ <span class="keyword">for</span> p <span class="keyword">in</span> $(kubectl get pods --namespace=kube-system <span class="_">-l</span> k8s-app=kube-dns -o name); \</span><br><span class="line">  <span class="keyword">do</span> kubectl logs --namespace=kube-system <span class="variable">$p</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">.:53</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = 6434d0912b39645ed0707a3569fd69dc</span><br><span class="line">CoreDNS-1.6.7</span><br><span class="line">linux/amd64, go1.13.6, da7f65b</span><br><span class="line">[INFO] Reloading</span><br><span class="line">[INFO] plugin/health: Going into lameduck mode <span class="keyword">for</span> 5s</span><br><span class="line">[INFO] 127.0.0.1:47278 - 55171 <span class="string">"HINFO IN 4940754309314083739.5160468069505858354. udp 57 false 512"</span> NXDOMAIN qr,rd,ra 57 0.040844011s</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac</span><br><span class="line">[INFO] Reloading complete</span><br><span class="line">[INFO] 10.244.1.162:40261 - 21083 <span class="string">"AAAA IN www.baidu.com.kube-system.svc.cluster.local. udp 62 false 512"</span> NXDOMAIN qr,aa,rd 155 0.000398875s</span><br><span class="line">[INFO] 10.244.1.162:40261 - 20812 <span class="string">"A IN www.baidu.com.kube-system.svc.cluster.local. udp 62 false 512"</span> NXDOMAIN qr,aa,rd 155 0.000505793s</span><br><span class="line">[INFO] 10.244.1.162:55066 - 53460 <span class="string">"AAAA IN www.baidu.com.svc.cluster.local. udp 50 false 512"</span> NXDOMAIN qr,aa,rd 143 0.000215384s</span><br><span class="line">[INFO] 10.244.1.162:55066 - 53239 <span class="string">"A IN www.baidu.com.svc.cluster.local. udp 50 false 512"</span> NXDOMAIN qr,aa,rd 143 0.000267642s</span><br><span class="line"></span><br><span class="line">.:53</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = 6434d0912b39645ed0707a3569fd69dc</span><br><span class="line">CoreDNS-1.6.7</span><br><span class="line">linux/amd64, go1.13.6, da7f65b</span><br><span class="line">[INFO] Reloading</span><br><span class="line">[INFO] plugin/health: Going into lameduck mode <span class="keyword">for</span> 5s</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac</span><br><span class="line">[INFO] Reloading complete</span><br><span class="line">[INFO] 127.0.0.1:32896 - 49064 <span class="string">"HINFO IN 1027842207973621585.7098421666386159336. udp 57 false 512"</span> NXDOMAIN qr,rd,ra 57 0.044098742s</span><br><span class="line">[INFO] plugin/reload: Running configuration MD5 = a4809ab99f6713c362194263016e6fac</span><br><span class="line">[INFO] Reloading complete</span><br><span class="line">[INFO] 10.244.1.162:40261 - 21083 <span class="string">"AAAA IN www.baidu.com.kube-system.svc.cluster.local. udp 62 false 512"</span> NXDOMAIN qr,aa,rd 155 0.000217299s</span><br><span class="line">[INFO] 10.244.1.162:40261 - 20812 <span class="string">"A IN www.baidu.com.kube-system.svc.cluster.local. udp 62 false 512"</span> NXDOMAIN qr,aa,rd 155 0.000264552s</span><br><span class="line">[INFO] 10.244.1.162:55066 - 53460 <span class="string">"AAAA IN www.baidu.com.svc.cluster.local. udp 50 false 512"</span> NXDOMAIN qr,aa,rd 143 0.000144795s</span><br><span class="line">[INFO] 10.244.1.162:55066 - 53239 <span class="string">"A IN www.baidu.com.svc.cluster.local. udp 50 false 512"</span> NXDOMAIN qr,aa,rd 143 0.000221163s</span><br></pre></td></tr></table></figure></p>
<p>ç»è¿‡ä¸Šé¢ä¸¤ä¸ªæµ‹è¯•ï¼Œå·²ç»å¯ä»¥å¾—çŸ¥ï¼Œå¦‚æœ <code>Pod DNS</code> é…ç½®ä¸­ç›´æ¥ä¿®æ”¹ <code>DNS</code> æœåŠ¡å™¨åœ°å€ä¸º <code>CoreDNS Pod</code> çš„ <code>IP</code> åœ°å€ï¼Œ<code>DNS</code> è§£æç¡®å®æ²¡æœ‰é—®é¢˜ï¼Œèƒ½å¤Ÿæ­£å¸¸è§£æã€‚ä¸è¿‡ï¼Œæ­£å¸¸çš„æƒ…å†µä¸‹ Pod ä¸­ DNS é…ç½®çš„æœåŠ¡å™¨åœ°å€ä¸€èˆ¬æ˜¯ CoreDNS çš„ Service åœ°å€ï¼Œä¸ç›´æ¥ç»‘å®š Pod IPï¼ˆå› ä¸º Pod æ¯æ¬¡é‡å¯ IP éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼‰ã€‚ æ‰€ä»¥é—®é¢˜æ‰¾åˆ°äº†ï¼Œæ­£æ˜¯åœ¨ Pod å‘ CoreDNS çš„ Service â€œkube-dnsâ€ è¿›è¡ŒåŸŸåè§£æè¯·æ±‚è½¬å‘æ—¶ï¼Œå‡ºç°äº†é—®é¢˜ï¼Œä¸€èˆ¬ <code>Service</code> çš„é—®é¢˜éƒ½è·Ÿ <code>Kube-proxy</code> ç»„ä»¶æœ‰å…³ï¼Œæ¥ä¸‹æ¥è§‚å¯Ÿè¯¥ç»„ä»¶æ˜¯å¦å­˜åœ¨é—®é¢˜ã€‚</p>
<h4 id="7-åˆ†æ-Kube-Proxy-æ˜¯å¦å­˜åœ¨é—®é¢˜"><a href="#7-åˆ†æ-Kube-Proxy-æ˜¯å¦å­˜åœ¨é—®é¢˜" class="headerlink" title="7. åˆ†æ Kube-Proxy æ˜¯å¦å­˜åœ¨é—®é¢˜"></a>7. åˆ†æ Kube-Proxy æ˜¯å¦å­˜åœ¨é—®é¢˜</h4><p>è§‚å¯Ÿ Kube-proxy çš„æ—¥å¿—ï¼ŒæŸ¥çœ‹æ˜¯å¦å­˜åœ¨é—®é¢˜ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ kube-proxy Pod åˆ—è¡¨</span></span><br><span class="line">$ kubectl get pods -n kube-system | grep kube-proxy</span><br><span class="line"></span><br><span class="line">kube-proxy-6kdj2          1/1     Running   3          9h</span><br><span class="line">kube-proxy-lw2q6          1/1     Running   3          9h</span><br><span class="line">kube-proxy-mftlt          1/1     Running   3          9h</span><br><span class="line"> é€‰æ‹©ä¸€ä¸ª kube-proxy Podï¼ŒæŸ¥çœ‹æœ€å 5 æ¡æ—¥å¿—å†…å®¹</span><br><span class="line">$ kubectl logs kube-proxy-6kdj2 --tail=5  -n kube-system</span><br><span class="line"></span><br><span class="line">E0326 15:20:23.159364  1 proxier.go:1950] Failed to list IPVS destinations, error: parseIP Error ip=[10 96 0 10 0 0 0 0 0 0 0 0 0 0 0 0]</span><br><span class="line">E0326 15:20:23.159388  1 proxier.go:1192] Failed to sync endpoint <span class="keyword">for</span> service: 10.8.0.10:53/UPD, err: parseIP Error ip=[10 96 0 16 0 0 0 0 0 0 0 0 0 0 0 0]</span><br><span class="line">E0326 15:20:23.159479  1 proxier.go:1950] Failed to list IPVS destinations, error: parseIP Error ip=[10 96 0 10 0 0 0 0 0 0 0 0 0 0 0 0]</span><br><span class="line">E0326 15:20:23.159501  1 proxier.go:1192] Failed to sync endpoint <span class="keyword">for</span> service: 10.8.0.10:53/TCP, err: parseIP Error ip=[10 96 0 16 0 0 0 0 0 0 0 0 0 0 0 0]</span><br><span class="line">E0326 15:20:23.159595  1 proxier.go:1950] Failed to list IPVS destinations, error: parseIP Error ip=[10 96 0 10 0 0 0 0 0 0 0 0 0 0 0 0]</span><br></pre></td></tr></table></figure></p>
<p>é€šè¿‡ kube-proxy Pod çš„æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œé‡Œé¢æœ‰å¾ˆå¤š Error çº§åˆ«çš„æ—¥å¿—ä¿¡æ¯ï¼Œæ ¹æ®å…³é”®å­— <code>IPVS</code>ã€<code>parseIP Error</code> å¯çŸ¥ï¼Œå¯èƒ½æ˜¯ç”±äº IPVS æ¨¡å—å¯¹ IP è¿›è¡Œæ ¼å¼åŒ–å¯¼è‡´å‡ºç°é—®é¢˜ã€‚</p>
<p>å› ä¸ºè¿™ä¸ªé—®é¢˜æ˜¯å‡çº§åˆ° kubernetes 1.18 ç‰ˆæœ¬æ‰å‡ºç°çš„ï¼Œæ‰€ä»¥å» Kubernetes Github æŸ¥çœ‹ç›¸å…³ issuesï¼Œå‘ç°æœ‰äººåœ¨å‡çº§ Kubernetes ç‰ˆæœ¬åˆ° 1.18 åï¼Œä¹Ÿé‡è§äº†ç›¸åŒçš„é—®é¢˜ï¼Œç»è¿‡ issue ä¸­ Kubernetes ç»´æŠ¤äººå‘˜è®¨è®ºï¼Œåˆ†æå‡ºåŸå› å¯èƒ½ä¸ºæ–°ç‰ˆ Kubernetes ä½¿ç”¨çš„ IPVS æ¨¡å—æ˜¯æ¯”è¾ƒæ–°çš„ï¼Œéœ€è¦ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬æ”¯æŒï¼Œæœ¬äººä½¿ç”¨çš„æ˜¯ CentOS ç³»ç»Ÿï¼Œå†…æ ¸ç‰ˆæœ¬ä¸º 3.10ï¼Œé‡Œé¢çš„ IPVS æ¨¡å—æ¯”è¾ƒè€æ—§ï¼Œç¼ºå°‘æ–°ç‰ˆ Kubernetes IPVS æ‰€éœ€çš„ä¾èµ–ã€‚</p>
<p>æ ¹æ®è¯¥ issue è®¨è®ºç»“æœï¼Œè§£å†³è¯¥é—®é¢˜çš„åŠæ³•æ˜¯ï¼Œæ›´æ–°å†…æ ¸ä¸ºæ–°çš„ç‰ˆæœ¬ã€‚</p>
<blockquote>
<p>æ³¨ï¼šè¯¥ issues åœ°å€ä¸º <a href="https://github.com/kubernetes/kubernetes/issues/89520" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/issues/89520</a></p>
</blockquote>
<h2 id="è§£å†³é—®é¢˜"><a href="#è§£å†³é—®é¢˜" class="headerlink" title="è§£å†³é—®é¢˜"></a>è§£å†³é—®é¢˜</h2><h3 id="å‡çº§ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬"><a href="#å‡çº§ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬" class="headerlink" title="å‡çº§ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬"></a>å‡çº§ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬</h3><p>å‡çº§ Kubernetes é›†ç¾¤å„ä¸ªèŠ‚ç‚¹çš„ CentOS ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è½½å…¥å…¬é’¥</span></span><br><span class="line">$ rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… ELRepo æœ€æ–°ç‰ˆæœ¬</span></span><br><span class="line">$ yum install -y https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºå¯ä»¥ä½¿ç”¨çš„ kernel åŒ…ç‰ˆæœ¬</span></span><br><span class="line">$ yum list available --disablerepo=* --enablerepo=elrepo-kernel</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…æŒ‡å®šçš„ kernel ç‰ˆæœ¬ï¼š</span></span><br><span class="line">$ yum install -y kernel<span class="_">-lt</span>-4.4.222-1.el7.elrepo --enablerepo=elrepo-kernel</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿå¯ç”¨å†…æ ¸</span></span><br><span class="line">$ cat /boot/grub2/grub.cfg | grep menuentry</span><br><span class="line"></span><br><span class="line">menuentry <span class="string">'CentOS Linux (3.10.0-1062.el7.x86_64) 7 (Core)'</span> --class centos ï¼ˆç•¥ï¼‰</span><br><span class="line">menuentry <span class="string">'CentOS Linux (4.4.222-1.el7.elrepo.x86_64) 7 (Core)'</span> --class centos ...ï¼ˆç•¥ï¼‰</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å¼€æœºä»æ–°å†…æ ¸å¯åŠ¨</span></span><br><span class="line">$ grub2-set-default <span class="string">"CentOS Linux (4.4.222-1.el7.elrepo.x86_64) 7 (Core)"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å†…æ ¸å¯åŠ¨é¡¹</span></span><br><span class="line">$ grub2-editenv list</span><br><span class="line">saved_entry=CentOS Linux (4.4.222-1.el7.elrepo.x86_64) 7 (Core)</span><br></pre></td></tr></table></figure></p>
<p>é‡å¯ç³»ç»Ÿä½¿å†…æ ¸ç”Ÿæ•ˆï¼Œå¯åŠ¨å®ŒæˆæŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬æ˜¯å¦æ›´æ–°ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ uname -r</span><br><span class="line">4.4.222-1.el7.elrepo.x86_64</span><br></pre></td></tr></table></figure></p>
<h3 id="æµ‹è¯•-Pod-ä¸­-DNS-æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è§£æ"><a href="#æµ‹è¯•-Pod-ä¸­-DNS-æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è§£æ" class="headerlink" title="æµ‹è¯• Pod ä¸­ DNS æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è§£æ"></a>æµ‹è¯• Pod ä¸­ DNS æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è§£æ</h3><p>è¿›å…¥ Pod å†…éƒ¨ä½¿ç”¨ ping å‘½ä»¤æµ‹è¯• DNS æ˜¯å¦èƒ½æ­£å¸¸è§£æï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ dnsutils Pod å†…éƒ¨ sh å‘½ä»¤è¡Œ</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it dnsutils /bin/sh -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ping é›†ç¾¤å¤–éƒ¨ï¼Œä¾‹å¦‚è¿™é‡Œ ping ä¸€ä¸‹ç™¾åº¦</span></span><br><span class="line">$ ping www.baidu.com</span><br><span class="line">64 bytes from 39.156.66.14 (39.156.66.14): icmp_seq=1 ttl=127 time=7.20 ms</span><br><span class="line">64 bytes from 39.156.66.14 (39.156.66.14): icmp_seq=2 ttl=127 time=6.60 ms</span><br><span class="line">64 bytes from 39.156.66.14 (39.156.66.14): icmp_seq=3 ttl=127 time=6.38 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ping é›†ç¾¤å†…éƒ¨ kube-api çš„ Service åœ°å€</span></span><br><span class="line">$ ping kubernetes.default</span><br><span class="line">64 bytes from kubernetes.default.svc.cluster.local (10.96.0.1): icmp_seq=1 ttl=64 time=0.051 ms</span><br><span class="line">64 bytes from kubernetes.default.svc.cluster.local (10.96.0.1): icmp_seq=2 ttl=64 time=0.051 ms</span><br><span class="line">64 bytes from kubernetes.default.svc.cluster.local (10.96.0.1): icmp_seq=3 ttl=64 time=0.064 ms</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ° Pod ä¸­çš„åŸŸåè§£æå·²ç»æ¢å¤æ­£å¸¸ã€‚</p>
<p>å‚è€ƒ: mydlq.club</p>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[kubernetes åœ¨ aws ä¸Šçš„åº”ç”¨]]></title>
      <url>http://team.jiunile.com/blog/2020/01/k8s-k8s-in-aws-arch.html</url>
      <content type="html"><![CDATA[<h2 id="kubernetes-in-aws-Overviewï¼ˆEKSï¼‰"><a href="#kubernetes-in-aws-Overviewï¼ˆEKSï¼‰" class="headerlink" title="kubernetes in aws Overviewï¼ˆEKSï¼‰"></a>kubernetes in aws Overviewï¼ˆEKSï¼‰</h2><p><img src="/images/k8s/aws_eks_arch.png" alt="eks_in_aws"><br><a id="more"></a><br>ä¸Šå›¾æ˜¯ kubernetes(EKS) åœ¨ aws ä¸Šçš„æ•´ä½“æƒ…å†µï¼Œä¸‹é¢æˆ‘ä¼šå¯¹æ¯å—è¿›è¡Œå±•å¼€è¯´æ˜</p>
<h2 id="åˆ†è§£è¯´æ˜"><a href="#åˆ†è§£è¯´æ˜" class="headerlink" title="åˆ†è§£è¯´æ˜"></a>åˆ†è§£è¯´æ˜</h2><h3 id="kubernetes-or-eks"><a href="#kubernetes-or-eks" class="headerlink" title="kubernetes or eks"></a>kubernetes or eks</h3><p>kubernetes åŸç”Ÿæ”¯æŒåœ¨ aws ä¸Šä½¿ç”¨ï¼Œå…·ä½“å¦‚ä½•å¯ç”¨å¯å‚è€ƒ<a href="http://team.jiunile.com/blog/2019/03/k8s-cloud.html">kuberenetes äº‘åº”ç”¨å®è·µ</a>ï¼Œè¿™é‡Œä¸åœ¨ç´¯èµ˜è¯´æ˜ã€‚æ—¢ç„¶é€‰æ‹©åœ¨äº‘ä¸Šä½¿ç”¨ k8s ï¼Œé‚£å°±ç›´æ¥ä½¿ç”¨äº‘æœ¬èº«æä¾›çš„èƒ½åŠ›ï¼ˆ<a href="https://eksworkshop.com/" target="_blank" rel="external">EKS</a>ï¼‰ï¼Œå°±æ²¡å¿…è¦è‡ªå·±å†å»é€‚é…ä¸€éï¼Œæ¯•ç«Ÿäº‘å‚å•†å·²ç»æä¾›äº†è¿™æ ·çš„æœåŠ¡ï¼Œä¸ºä»€ä¹ˆä¸å»ä½¿ç”¨å‘¢ï¼Ÿä¸è¿‡è‡ªå·±ä¹Ÿå¯ä»¥å»äº†è§£EKSä¸ºæˆ‘ä»¬åšäº†ä»€ä¹ˆï¼Ÿæ€ä¹ˆå»ç®¡ç†å®ƒï¼Ÿ</p>
<h4 id="EKS"><a href="#EKS" class="headerlink" title="EKS"></a>EKS</h4><p><a href="https://eksworkshop.com/" target="_blank" rel="external">EKS</a> å…¶å®å°±æ˜¯å¸®æˆ‘ä»¬æ‰˜ç®¡äº†masterèŠ‚ç‚¹ï¼ˆ3 masteré›†ç¾¤ï¼‰ï¼Œå…¶æ¬¡æ›´å¥½çš„ä¸awsèµ„æºè¿›è¡Œäº†é›†æˆï¼Œå¸®åŠ©æˆ‘ä»¬åœ¨ä¸Šå±‚æ›´è½»æ¾çš„ä½¿ç”¨ï¼Œ<a href="https://eksworkshop.com/" target="_blank" rel="external">EKS</a> é»˜è®¤ä¼šé›†æˆä»¥ä¸‹ç»„ä»¶:  </p>
<ul>
<li>kube-proxy</li>
<li>coredns</li>
<li><a href="https://github.com/aws/amazon-vpc-cni-k8s" target="_blank" rel="external">amazon-k8s-cni</a> (ç½‘ç»œæ’ä»¶-æ›¿ä»£calicoï¼Œä¸‹é¢ä¼šä»‹ç»ä¸ºä½•ä½¿ç”¨å®ƒ)</li>
</ul>
<hr>
<p>ä½¿ç”¨ <a href="https://eksworkshop.com/" target="_blank" rel="external">EKS</a> åï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦åœ¨å…³æ³¨ k8s master çš„å®‰è£…ä»¥åŠé«˜å¯ç”¨ï¼Œä»¥åŠæ€ä¹ˆåœ¨äº‘ä¸Šï¼ˆawsï¼‰çš„é›†æˆï¼ŒåŒæ—¶åœ¨å¼€æºçš„ kubernetes ä¸Šåšäº†ä¼˜åŒ–ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥å¯ä»¥é€‰æ‹©è‡ªå»ºï¼Œæ¯•ç«Ÿè¿™äº›ä½ éƒ½å¯ä»¥æ­å»ºå‡ºæ¥ï¼Œæˆ‘ä»¬åœ¨ aws ä¸­å›½å°±æ˜¯è‡ªå»ºçš„ï¼Œæ¯•ç«Ÿ <a href="https://eksworkshop.com/" target="_blank" rel="external">EKS</a> åœ¨å›½å†…è¿˜æœªä¸Šçº¿ï¼Œä½†å¦‚æœæ˜¯åœ¨å›½å¤–æˆ–è€…å›½å†…ä¸Šçº¿çš„å‰æä¸‹éœ€è¡¡é‡ä»˜å‡ºçš„æ—¶é—´æˆæœ¬æ˜¯å¦åˆç®—ï¼Ÿ</p>
<h4 id="å¦‚ä½•ç®¡ç†"><a href="#å¦‚ä½•ç®¡ç†" class="headerlink" title="å¦‚ä½•ç®¡ç†"></a>å¦‚ä½•ç®¡ç†</h4><p><a href="https://www.terraform.io" target="_blank" rel="external">terrafrom</a> or <a href="https://eksctl.io" target="_blank" rel="external">eksctl</a>ï¼Œæœ€ç»ˆæˆ‘é€‰æ‹©äº†åè€…ï¼Œç†ç”±ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨æˆ‘çœ‹æ¥ä¸€ä¸ªå°±å¥½æ¯”æ˜¯â€å­¦ç”Ÿâ€ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯â€äº²å„¿å­â€ï¼Œ<a href="https://eksctl.io" target="_blank" rel="external">eksctl</a> ç”± aws å®˜æ–¹æä¾›ä¸“é—¨ä¸º <a href="https://eksworkshop.com/" target="_blank" rel="external">EKS</a> æä¾›çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒæä¾›äº†æ›´å¤šçš„å‚æ•°åŒæ—¶ç®¡ç†èµ·æ¥ä¹Ÿéå¸¸çš„æ–¹ä¾¿ï¼Œå¦‚æœä½ æ˜¯æ·±åº¦ç®¡ç†ï¼Œåˆ™ä½¿ç”¨å®ƒï¼Œ<a href="https://www.terraform.io" target="_blank" rel="external">terrafrom</a> åˆ™æ˜¯å¤§ä¼—æ™®ç…§ä¸­çš„ä¸€ä¸ªï¼Œæä¾›çš„å‚æ•°ä¹Ÿæ˜¯æœ‰é™ï¼Œå¦‚æœç®€å•ç®¡ç†å¯ä»¥ä½¿ç”¨å®ƒã€‚</p>
<h3 id="è´Ÿè½½å‡è¡¡å™¨ELB"><a href="#è´Ÿè½½å‡è¡¡å™¨ELB" class="headerlink" title="è´Ÿè½½å‡è¡¡å™¨ELB"></a>è´Ÿè½½å‡è¡¡å™¨ELB</h3><h4 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>aws å®˜æ–¹æä¾›äº†ä¸‰ç§è´Ÿè½½å‡è¡¡å™¨ï¼Œæˆ‘ç®€å•æˆä¸º <code>clb</code>ã€<code>alb</code>ã€<code>nlb</code>ï¼Œ<code>clb</code> å³å°†æ·˜æ±°ä¹Ÿæ˜¯æœ€æ—©çš„ä¸€ä»£ï¼Œè¿™é‡Œä¸»è¦é˜è¿° <code>alb</code> 7å±‚è´Ÿè½½  ä¸ <code>nlb</code> 4å±‚è´Ÿè½½ ï¼Œè¯¥å¦‚ä½•é€‰æ‹©ï¼Œåˆ™å–å†³äºä½ çš„ä¸šåŠ¡ï¼Œä»–ä»¬ä¹‹é—´çš„ç‰¹å¾ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¦‚æœä½ æ˜¯éœ€è¦å…³æ³¨ <code>header</code> å¤´ä¿¡æ¯çš„ï¼Œå¦‚ <code>x-forward-for</code> æˆ– <code>x-forward-proto</code> ç­‰ä¿¡æ¯çš„åˆ™ä½¿ç”¨ <code>alb</code>ï¼Œå¦‚æœä¸éœ€è¦åˆ™ä½¿ç”¨ <code>nlb</code> æ€§èƒ½é«˜ã€‚å…·ä½“æƒ³äº†è§£ï¼Œå¯å‚è€ƒawså®˜æ–¹æ–‡æ¡£ï¼š<a href="https://aws.amazon.com/cn/elasticloadbalancing/" target="_blank" rel="external">https://aws.amazon.com/cn/elasticloadbalancing/</a></p>
<h4 id="ç®¡ç†"><a href="#ç®¡ç†" class="headerlink" title="ç®¡ç†"></a>ç®¡ç†</h4><p>åŒæ ·æˆ‘ä»¬ä¹Ÿé¢ä¸´ç€ç®¡ç†çš„é—®é¢˜ï¼Œæ˜¯ä½¿ç”¨ <a href="https://www.terraform.io" target="_blank" rel="external">terrafrom</a> è¿˜æ˜¯åˆ«çš„å‘¢ï¼Ÿæ¯•ç«Ÿæˆ‘ä»¬ä½¿ç”¨äº† k8s ï¼Œå®ƒæœ‰å¾ˆå¥½çš„ <code>ingress</code> å¸®æˆ‘ä»¬ç®¡ç†ç€å¯¹å¤–çš„è®¿é—®ä¸æ˜¯ä¹ˆï¼Ÿæœ€ç»ˆï¼Œæˆ‘é€‰æ‹©äº† <a href="https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/config/" target="_blank" rel="external">alb-ingress-controller</a>ï¼ŒåŒæ ·ä¹Ÿæ˜¯ aws å‡ºå“ï¼Œå®ƒå¾ˆå¥½çš„ä¸ ELB è¿›è¡Œäº†é›†æˆï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™ <code>ingress</code> æ–‡ä»¶ï¼ŒåŠ ä¸Šå¯¹åº”çš„æ³¨è§£ï¼Œå°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨ ELBï¼Œç›®å‰æ”¯æŒ <code>alb</code> ä¸ <code>nlb</code> è¿™ä¸¤ä¸ªè´Ÿè½½å‡è¡¡å™¨çš„ä½¿ç”¨ã€‚</p>
<p>å¯¹ <a href="https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/config/" target="_blank" rel="external">alb-ingress-controller</a> çš„ä½¿ç”¨ä¹Ÿæœ‰ä¸€å®šçš„æ³¨æ„ï¼Œæ¨èæ˜¯ä¸€ä¸ªå¯¹å¤–æš´éœ²æœåŠ¡ä¸€ä¸ª <code>ingress</code>, <strong>åŒæ—¶æ³¨æ„ä¸è¦äººä¸ºå» aws consol ç•Œé¢å»ä¿®æ”¹å·²æœ‰é€šè¿‡ <a href="https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/config/" target="_blank" rel="external">alb-ingress-controller</a>  åˆ›å»ºå‡ºæ¥çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œå¦‚æœä½ ä¿®æ”¹äº†ï¼Œä½ ä¼šå‘ç°è¿‡ä¸€ä¼šå°±ä¼šè¿˜åŸäº†</strong>ï¼Œå› ä¸ºåœ¨ k8s ä¸­çš„ alb æ§åˆ¶å™¨ä¼šå¸®ä½ å¤åŸï¼Œæ‰€ä»¥ä¸€åˆ‡çš„å˜æ›´è¯·ä½¿ç”¨ <code>ingress</code>, åŒæ—¶è¿˜æœ‰ä¸€ä¸ªä¸å¥½çš„å¼Šç«¯å°±æ˜¯åœ¨ alb/nlb ç›®æ ‡ç¾¤ç»„ä¸­ï¼Œåç«¯åè®®åªèƒ½äºŒé€‰ä¸€ï¼Œæ— æ³• http/https åŒæ—¶å­˜åœ¨ï¼Œå”¯ä¸€çš„æ–¹æ³•æ˜¯ä½¿ç”¨ä¸¤ä¸ª <code>ingress</code> ï¼Œä¸è¿‡æˆ‘ä»¬å¤§å¤šæ•°åç«¯è®¿é—®éƒ½æ˜¯ http åè®®ã€‚</p>
<p>è¯¦ç»†äº†è§£å¯å‚è€ƒï¼š</p>
<ul>
<li><a href="https://github.com/kubernetes-sigs/aws-alb-ingress-controller/" target="_blank" rel="external">https://github.com/kubernetes-sigs/aws-alb-ingress-controller/</a></li>
<li><a href="https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/config/" target="_blank" rel="external">https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/config/</a></li>
<li><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/alb-ingress.html" target="_blank" rel="external">https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/alb-ingress.html</a></li>
<li><a href="https://aws.amazon.com/cn/blogs/china/kubernetes-ingress-aws-alb-ingress-controller/" target="_blank" rel="external">https://aws.amazon.com/cn/blogs/china/kubernetes-ingress-aws-alb-ingress-controller/</a></li>
</ul>
<h3 id="ç½‘ç»œæ’ä»¶"><a href="#ç½‘ç»œæ’ä»¶" class="headerlink" title="ç½‘ç»œæ’ä»¶"></a>ç½‘ç»œæ’ä»¶</h3><p>åŒæ ·ï¼Œåœ¨ç½‘ç»œæ’ä»¶ä¸Šï¼Œæˆ‘ä¹Ÿé¢ä¸´ç€é€‰æ‹©çš„é—®é¢˜ï¼Œä¸è¿‡ç°åœ¨å›æƒ³èµ·æ¥ï¼Œå±…ç„¶é€‰æ‹©äº†äº‘ï¼Œé‚£å°±åŸºæœ¬å¤§æ¦‚ç‡ä¸Šå»æ‹¥æŠ±äº‘åŸç”Ÿæä¾›çš„æ’ä»¶ï¼Œä¸æ˜¯ä¹ˆï¼Œæ¯•ç«Ÿå®ƒå’Œäº‘ç»“åˆçš„å¾ˆå¥½ï¼Œè¿™é‡Œæˆ‘ä»‹ç»ä¸‹ <a href="https://github.com/aws/amazon-vpc-cni-k8s" target="_blank" rel="external">amazon-k8s-cni</a>ã€‚</p>
<p><a href="https://github.com/aws/amazon-vpc-cni-k8s" target="_blank" rel="external">amazon-k8s-cni</a> æˆ‘å°±è¯´ä¸€ä»¶äº‹ï¼Œ<strong>pod ä¸ä½ ç°æœ‰çš„ vpc æ‰“é€š</strong>ï¼Œä½†åŠ£åŠ¿ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œ<code>å°±æ˜¯ pod çš„ ip ä¼šå æœ‰ä½ åˆ’åˆ†çš„ vpc ipæ± </code>ï¼Œå¦‚æœä½ çš„ <code>subnet</code> ç½‘æ®µè§„åˆ’çš„ä¸å¥½çš„è¯ï¼Œä½ çš„ ip å°†ä¼šå¾ˆå¿«ç”¨å…‰ï¼Œæ‰€æœ‰æˆ‘å»ºè®®ä½ çš„ <code>vpc</code> ç½‘æ®µæ˜¯ <code>16</code> ä½ï¼Œ<code>subnet</code> ç½‘æ®µæ˜¯ <code>20</code> ä½çš„ï¼Œå…·ä½“ä¸åŒçš„ç½‘æ®µå¯ä»¥æ”¾å¤šå°‘ä¸ª pod å¯ä»¥å‚è€ƒè¿™è¾¹æ–‡ç« äº†è§£ä¸‹ï¼š<a href="https://www.yiibai.com/ipv4/ipv4_subnetting.htmlï¼Œ" target="_blank" rel="external">https://www.yiibai.com/ipv4/ipv4_subnetting.htmlï¼Œ</a> è¿™é‡Œä¹Ÿä¸åœ¨ç´¯èµ˜ã€‚ </p>
<p>åŒæ—¶ <a href="https://github.com/aws/amazon-vpc-cni-k8s" target="_blank" rel="external">amazon-k8s-cni</a> å¯¹ä¸»æœºç±»å‹ä¸Šèƒ½èµ·å¤šå°‘ pod ä¹Ÿæ˜¯æœ‰é™åˆ¶çš„ï¼Œä¸åŒçš„æœºå‹ä¸Šå¯åŠ¨çš„ pod æ•°é‡æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™é‡Œæˆ‘æ¨èå°½å¯èƒ½çš„ä½¿ç”¨ä¸­ç­‰è§„æ¨¡çš„æœºå‹æ¥å–ç¼”å¤šä¸ªå°æœºå‹ã€‚å…·ä½“å¯å‚è€ƒï¼š<a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/f7a7d53baf769846c20467cfa27f0172eca570c1/pkg/awsutils/vpc_ip_resource_limit.go" target="_blank" rel="external">vpc_ip_resource_limit</a> </p>
<p>å½“ç„¶å¦‚æœä½ æ˜¯æœ¬åœ°æœºæˆ¿æˆ–è€…äº‘æœªç»™æä¾›ç½‘ç»œæ’ä»¶çš„è¯ï¼Œé‚£æˆ‘è¿˜æ˜¯æ¨èä½ ä½¿ç”¨ <a href="https://www.projectcalico.org/" target="_blank" rel="external">calico</a>ï¼Œæ¯•ç«Ÿå®ƒè¿˜æ˜¯éå¸¸çš„å¼ºå¤§ï¼æœ‰å…´è¶£çš„ä¼™ä¼´è¿˜æ˜¯å¯ä»¥å¥½å¥½äº†è§£ä¸‹ã€‚</p>
<h3 id="è®¿é—®å®‰å…¨"><a href="#è®¿é—®å®‰å…¨" class="headerlink" title="è®¿é—®å®‰å…¨"></a>è®¿é—®å®‰å…¨</h3><p>å®¹å™¨è®¿é—®å®‰å…¨ä¹Ÿæ˜¯ä»¤æˆ‘éå¸¸å›°æ‰°çš„ä¸€ä¸ªé—®é¢˜ï¼Œaws åœ¨èµ„æºè®¿é—®æ–¹é¢æœ‰ç€éå¸¸å¥½çš„æƒé™æ§åˆ¶ <code>iam role</code> ï¼Œä½†æ”¾åˆ° k8s å®¹å™¨ä¸­ï¼Œä¸€åˆ‡éƒ½å˜çš„éå¸¸ä¸ç¾å¥½äº†ï¼Œ ç›´åˆ°æœ€è¿‘ aws eks æ¨å‡ºäº† <a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/iam-roles-for-service-accounts.html" target="_blank" rel="external">service account for iam role</a>ï¼Œ åœ¨ eks æ²¡æ­£å¼æ¨å‡º <a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/iam-roles-for-service-accounts.html" target="_blank" rel="external">service account for iam role</a> ä¹‹å‰ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è¿›è¡Œè®¿é—®æ§åˆ¶ï¼š</p>
<ul>
<li>access key/secret key</li>
<li><a href="https://github.com/jtblin/kube2iam" target="_blank" rel="external">kube2iam</a></li>
</ul>
<hr>
<p>é’ˆå¯¹ä»¥ä¸Šä¸¤ä¸ªè®¿é—®ï¼Œéƒ½æœ‰ä¸€å®šçš„ç¼ºé™·ï¼Œç”¨keyæ¥æ§åˆ¶çš„é—®é¢˜åœ¨äºæœ¬èº«ç®¡ç†keyå°±æ˜¯ä¸€ä»¶å¤´ç—›çš„äº‹æƒ…ï¼Œkeyçš„æ³„æ¼å’Œå®šæœŸæ›´æ¢éå¸¸ç—›è‹¦ï¼Œä½¿ç”¨ <a href="https://github.com/jtblin/kube2iam" target="_blank" rel="external">kube2iam</a> é—®é¢˜åœ¨äºä½ éœ€è¦ä¿è¯è¿™ä¸ªæ’ä»¶çš„ç¨³å®šæ€§å’Œæ€§èƒ½ï¼Œä¸€æ—¦å‡ºç°é—®é¢˜ï¼Œä½ ä¼šå‘ç°é‚£å°±æ˜¯ç¾éš¾æ€§çš„ï¼Œè€Œä¸”ä¹Ÿä¸æ˜“æ’æŸ¥ï¼Œæ¯•ç«Ÿå¤šå±‚ç»„ä»¶å°±å¤šæå‡äº†å‡ºé—®é¢˜çš„æ¦‚ç‡ï¼Œæ¯•ç«Ÿè¿˜æ˜¯å¦‚æ­¤é‡è¦çš„ç»„ä»¶ã€‚</p>
<p>æœ€åï¼Œæˆ‘éš†é‡æ¨èå¤§å®¶ä½¿ç”¨ <a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/iam-roles-for-service-accounts.html" target="_blank" rel="external">service account for iam role</a> ï¼Œå…·ä½“æ•™ç¨‹å¯ç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚ ä½†å¯¹äºè‡ªå»ºçš„å°ä¼™ä»¬åªèƒ½é€€è€Œæ±‚å…¶æ¬¡ ä½¿ç”¨ key æˆ–è€… <a href="https://github.com/jtblin/kube2iam" target="_blank" rel="external">kube2iam</a> æ¥è¿›è¡Œç®¡ç†æ§åˆ¶äº†</p>
<h3 id="Why-kong"><a href="#Why-kong" class="headerlink" title="Why kong?"></a>Why kong?</h3><p>ä¸ºä»€ä¹ˆé€‰å‹ <a href="http://getkong.org" target="_blank" rel="external">kong</a> ï¼Œæˆ‘æƒ³å®ƒçš„å®˜æ–¹æ–‡æ¡£èƒ½æ›´å¥½çš„ä¸ºä½ é˜è¿°ï¼Œæˆ‘ä»0.9å¼€å§‹å°±ä½¿ç”¨å®ƒäº†ï¼Œç›´åˆ°ç°åœ¨ç»´æŒåœ¨0.14.1ï¼Œå¾€åå¼•å…¥äº† <code>service mesh</code> çš„æ¦‚å¿µï¼Œé€‰å‹ <a href="http://getkong.org" target="_blank" rel="external">kong</a> çš„ç†ç”±ä¹Ÿå¾ˆç®€å•ï¼Œå¼€æºã€æ’ä»¶ä¸°å¯Œã€æ˜“äºäºŒæ¬¡å¼€å‘ã€‚åé¢å¯ä»¥ä¸“é—¨åˆ†äº«ä¸€ä¸‹æˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨  <a href="http://getkong.org" target="_blank" rel="external">kong</a> ä½œä¸ºæˆ‘ä»¬çš„ä¸šåŠ¡ç½‘å…³ï¼ŒåŒæ—¶æˆ‘ä»¬æ˜¯å¦‚ä½•æ”¹é€  <code>JWT</code> æ’ä»¶æ¥å®ç°é‰´æˆæƒï¼Œä»¥åŠé€šè¿‡ç½‘å…³å®¡è®¡æ—¥å¿—å®šä½é—®é¢˜ï¼Œå¯¹å¤–æ ¸å¿ƒæœåŠ¡è¿›è¡Œäº†é™æµç­‰æ§åˆ¶ã€‚å¦‚æœä½ çš„éœ€æ±‚ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œè®©ä¸šåŠ¡ä¿æŒè¶³å¤Ÿç®€å•ä¸“æ³¨äºä¸šåŠ¡çš„å®ç°ï¼Œè·¨è¯­è¨€ï¼Œå¾®æœåŠ¡åŒ–ï¼Œä½†åŒæ—¶éœ€è¦ä¸€äº›æœåŠ¡æ²»ç†ç›¸å…³çš„éœ€æ±‚ï¼Œè¿˜æ²¡æœ‰ä¸Š k8s æˆ–è€…è¿˜æ²¡åˆ° <a href="https://istio.io" target="_blank" rel="external">isito</a> è¿™ç§é‡ <code>service mesh</code> çš„åœ°æ­¥ï¼Œé‚£  <a href="http://getkong.org" target="_blank" rel="external">kong</a> å°±æ˜¯ä½ æœ€å¥½çš„é€‰æ‹©ã€‚</p>
<h3 id="èµ„æºæ± åˆ’åˆ†"><a href="#èµ„æºæ± åˆ’åˆ†" class="headerlink" title="èµ„æºæ± åˆ’åˆ†"></a>èµ„æºæ± åˆ’åˆ†</h3><p>åœ¨èµ„æºæ± åˆ’åˆ†ä¸Šï¼Œæˆ‘å°†ç½‘å…³å’Œä¸šåŠ¡çš„æ± å­å•ç‹¬åˆ†å¼€ï¼ŒåŒæ—¶å¼€è¾Ÿäº†ä¸€å—ç«ä»·æ± ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç½‘å…³æ± åˆ’åˆ†ï¼š ç½‘å…³ä½œä¸ºä¸šåŠ¡å¯¹å¤–æµé‡çš„ç»Ÿä¸€å…¥å£ï¼Œæç°å‡ºéå¸¸é‡è¦çš„åœ°æ­¥ï¼Œæ•…è€Œå•ç‹¬åˆ†é…äº†ä¸€å—èµ„æºæ± ï¼ŒåŒæ—¶éœ€è¦ä¸è´Ÿè½½å‡è¡¡å™¨çš„é…ç½®ï¼Œå¯¹æœºå™¨æƒé™çš„æ§åˆ¶åŠ›åº¦ä¹Ÿæ˜¯å’Œæ™®é€šä¸šåŠ¡æ± æ˜¯ä¸åŒçš„ã€‚</li>
<li>ä¸šåŠ¡æ± åˆ’åˆ†ï¼šè¿™ä¸ªå°±ä»€ä¹ˆå¥½è¯´çš„ï¼Œç”¨äºæ‰¿è½½ä½ çš„ä¸šåŠ¡ï¼Œè·‘é•¿æœŸè¿è¡Œçš„æœåŠ¡ã€‚</li>
<li>ç«ä»·æ± åˆ’åˆ†ï¼š è¿™é‡Œéœ€è¦é…åˆ <a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md" target="_blank" rel="external">cluster autoscaler</a> ä¸€èµ·ä½¿ç”¨æ›´ä½³ï¼Œç”¨äºè·‘ä¸€äº›ç¦»çº¿ä»»åŠ¡ï¼Œéšç”¨éšèµ·ï¼Œç”¨å®Œå³æ¯ï¼Œæ–¹ä¾¿è‡³æã€‚å½“ç„¶å¦‚ä½•ä½ ä½¿ç”¨çš„æ˜¯ EKS ç›´æ¥å¯ä»¥é…åˆ <a href="https://aws.amazon.com/cn/fargate/" target="_blank" rel="external">fargate</a> æ¥ç›´æ¥ä½¿ç”¨ã€‚</li>
</ol>
<hr>
<p>Cluster Autoscalerï¼š</p>
<ul>
<li><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/cluster-autoscaler.html#ca-ng-considerations" target="_blank" rel="external">https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/cluster-autoscaler.html#ca-ng-considerations</a></li>
<li><a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md" target="_blank" rel="external">https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md</a></li>
</ul>
<h3 id="æœªæ¥å±•æœ›"><a href="#æœªæ¥å±•æœ›" class="headerlink" title="æœªæ¥å±•æœ›"></a>æœªæ¥å±•æœ›</h3><p>ç›®å‰ï¼Œæˆ‘ä»¬é€šè¿‡ <a href="http://getkong.org" target="_blank" rel="external">kong</a> æ¥å®ç°äº†å¯¹å¤–æµé‡çš„ç®¡ç†ä¸æ§åˆ¶ï¼Œä½†å¯¹å†…éƒ¨æœåŠ¡ä¹‹é—´çš„è®¿é—®æ§åˆ¶è¿˜æœªå¼€å§‹ï¼Œä¹Ÿç¼ºä¹ä¸€äº›æœåŠ¡æ²»ç†çš„æ‰‹æ®µï¼Œå½“ç„¶ï¼Œä½¿ç”¨ <a href="http://getkong.org" target="_blank" rel="external">kong</a> ä¹Ÿå¯ä»¥è¾¾åˆ°ï¼Œä½†è¿™æ ·æˆ‘ä»¬å°±ä¼šè¿‡æ¸¡ä¾èµ–è¿™ä¸ªé›†ä¸­ç½‘å…³äº†ï¼Œä¸€æ—¦æ•…éšœï¼Œé‚£æ˜¯ç¾éš¾æ€§çš„ï¼Œ<code>service mesh</code> çš„åˆ°æ¥æ­£å¼è§£å†³æ­¤ç±»é—®é¢˜ï¼Œè®©æœåŠ¡æ²»ç†å˜çš„æ›´æ¸¸åˆƒæœ‰ä½™ï¼Œåé¢æˆ‘ä»¬ä¼šä¸Š <a href="https://istio.io" target="_blank" rel="external">isito</a> æ¥å®ç°è¯¸å¦‚ç°åº¦ã€è“ç»¿å‘å¸ƒä»¥åŠå¯¹å†…éƒ¨æœåŠ¡è°ƒç”¨é™æµã€ç›‘æ§ç­‰æ§åˆ¶èƒ½åŠ›çš„åŠ å¼ºã€‚</p>
<h2 id="æ–‡æ¡£"><a href="#æ–‡æ¡£" class="headerlink" title="æ–‡æ¡£"></a>æ–‡æ¡£</h2><ul>
<li><a href="https://docs.aws.amazon.com/" target="_blank" rel="external">https://docs.aws.amazon.com/</a></li>
<li><a href="http://getkong.org" target="_blank" rel="external">http://getkong.org</a></li>
<li><a href="https://eksctl.io/" target="_blank" rel="external">https://eksctl.io/</a></li>
<li><a href="https://eksworkshop.com" target="_blank" rel="external">https://eksworkshop.com</a></li>
</ul>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[åˆ†æå¹¶è§£å†³AWSæœåŠ¡ä»ec2è¿ç§»è‡³Kubernetesåå»¶è¿Ÿå¢åŠ çš„é—®é¢˜]]></title>
      <url>http://team.jiunile.com/blog/2020/01/k8s-k8s-in-aws-latency.html</url>
      <content type="html"><![CDATA[<h2 id="é—®é¢˜æ¦‚è¦"><a href="#é—®é¢˜æ¦‚è¦" class="headerlink" title="é—®é¢˜æ¦‚è¦"></a>é—®é¢˜æ¦‚è¦</h2><p>ä¸Šå‘¨æˆ‘ä»¬å°†ä¸€ä¸ªå¾®æœåŠ¡è¿ç§»åˆ°ä¸­å¤®å¹³å°ä¸Šï¼ŒåŒ…æ‹¬CI/CDï¼ŒKubernetesè¿è¡Œæ—¶ï¼Œmetricå’Œå…¶ä»–ä¸€äº›ç¨‹åºã€‚è¿™æ¬¡å®éªŒæ˜¯ä¸ºäº†ä¹‹åä¸€ä¸ªæœˆé‡Œå¤§æ¦‚150ä¸ªå¾®æœåŠ¡çš„è¿ç§»ä½œå‡†å¤‡ï¼Œæ‰€æœ‰è¿™äº›æœåŠ¡æ”¯æ’‘ç€è¥¿ç­ç‰™åœ¨çº¿å¸‚åœºçš„è¿è¥ã€‚</p>
<p>å½“æˆ‘ä»¬å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°Kubernetesä¸Šï¼Œå¹¶ä¸”å°†ä¸€äº›ç”Ÿäº§æµé‡å¯¼å…¥å…¶ä¸­ä¹‹åï¼Œäº‹æƒ…å¼€å§‹æœ‰äº›ä¸å¦™äº†ã€‚Kubernetesä¸Šçš„è¯·æ±‚å»¶è¿Ÿæ¯”EC2ä¸Šçš„é«˜10å€å·¦å³ã€‚é™¤éæˆ‘ä»¬èƒ½æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œä¸ç„¶è¿™ä¼šæ˜¯å¾®æœåŠ¡è¿ç§»çš„æœ€å¤§éšœç¢ï¼Œç”šè‡³å¯èƒ½å½»åº•æ‘§æ¯æ•´ä¸ªé¡¹ç›®ã€‚<br><a id="more"></a></p>
<h2 id="ä¸ºä»€ä¹ˆKubernetesä¸Šçš„å»¶æ—¶æ¯”EC2é«˜é‚£ä¹ˆå¤šï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆKubernetesä¸Šçš„å»¶æ—¶æ¯”EC2é«˜é‚£ä¹ˆå¤šï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆKubernetesä¸Šçš„å»¶æ—¶æ¯”EC2é«˜é‚£ä¹ˆå¤šï¼Ÿ"></a>ä¸ºä»€ä¹ˆKubernetesä¸Šçš„å»¶æ—¶æ¯”EC2é«˜é‚£ä¹ˆå¤šï¼Ÿ</h2><p>ä¸ºäº†æ‰¾åˆ°ç³»ç»Ÿç“¶é¢ˆï¼Œæˆ‘ä»¬æ”¶é›†äº†æ•´ä¸ªè¯·æ±‚è·¯å¾„çš„metricã€‚æ¶æ„å¾ˆç®€å•ï¼Œä¸€ä¸ªAPIç½‘å…³ï¼ˆZuulï¼‰å°†è¯·æ±‚è·¯ç”±åˆ°EC2æˆ–è€…Kubernetesçš„å¾®æœåŠ¡é‡Œã€‚åœ¨Kubernetesä¸Šï¼Œæˆ‘ä»¬ä½¿ç”¨NGINX Ingressæ§åˆ¶å™¨ï¼Œåå°æ˜¯å¸¸è§„çš„Deploymentè¿è¡Œä¸€ä¸ªåŸºäºSpringçš„JVMåº”ç”¨ç¨‹åºã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">                                  EC2</span><br><span class="line">                            +---------------+</span><br><span class="line">                            |  +---------+  |</span><br><span class="line">                            |  |         |  |</span><br><span class="line">                       +-------&gt; BACKEND |  |</span><br><span class="line">                       |    |  |         |  |</span><br><span class="line">                       |    |  +---------+  |                   </span><br><span class="line">                       |    +---------------+</span><br><span class="line">             +------+  |</span><br><span class="line">Public       |      |  |</span><br><span class="line">      -------&gt; ZUUL +--+</span><br><span class="line">traffic      |      |  |              Kubernetes</span><br><span class="line">             +------+  |    +-----------------------------+</span><br><span class="line">                       |    |  +-------+      +---------+ |</span><br><span class="line">                       |    |  |       |  xx  |         | |</span><br><span class="line">                       +-------&gt; NGINX +------&gt; BACKEND | |</span><br><span class="line">                            |  |       |  xx  |         | |</span><br><span class="line">                            |  +-------+      +---------+ |</span><br><span class="line">                            +-----------------------------+</span><br></pre></td></tr></table></figure></p>
<p>é—®é¢˜çœ‹ä¸Šå»æ˜¯åå°çš„ä¸Šæ¸¸å»¶è¿Ÿï¼ˆä¸Šå›¾ç”¨xxè¡¨ç¤ºï¼‰ã€‚å½“åº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨EC2ä¸Šæ—¶ï¼Œå“åº”æ—¶é—´å¤§æ¦‚20msã€‚åœ¨Kubernetesä¸Šåˆ™éœ€è¦100ï½200msã€‚</p>
<p>æˆ‘ä»¬å¾ˆå¿«æ’é™¤äº†è¿è¡Œæ—¶å˜æ›´çš„å½±å“ã€‚JVMç‰ˆæœ¬æ˜¯ä¸€è‡´çš„ã€‚å®¹å™¨åŒ–çš„å½±å“ä¹Ÿè¢«æ’é™¤äº†ï¼Œå› ä¸ºEC2ä¸Šä¹Ÿæ˜¯è¿è¡Œåœ¨å®¹å™¨é‡Œã€‚ä¹Ÿå’Œå‹åŠ›æ— å…³ï¼Œå› ä¸ºå³ä½¿æ¯ç§’åªæœ‰1ä¸ªè¯·æ±‚ä»ç„¶èƒ½çœ‹åˆ°å¾ˆé«˜çš„å»¶æ—¶ã€‚ä¹Ÿä¸æ˜¯GCçš„å½±å“ã€‚</p>
<p>ä¸€ä¸ªKubernetesç®¡ç†å‘˜é—®åº”ç”¨ç¨‹åºæ˜¯å¦æœ‰å¤–éƒ¨çš„ä¾èµ–ï¼Œæ¯”å¦‚ä»¥å‰DNSè§£ææ›¾ç»å¯¼è‡´è¿‡ç±»ä¼¼çš„é—®é¢˜ï¼Œè¿™æ˜¯ç›®å‰ä¸ºæ­¢æœ€å¯èƒ½çš„çŒœæƒ³ã€‚</p>
<h2 id="çŒœæƒ³1ï¼šDNSè§£æ"><a href="#çŒœæƒ³1ï¼šDNSè§£æ" class="headerlink" title="çŒœæƒ³1ï¼šDNSè§£æ"></a>çŒœæƒ³1ï¼šDNSè§£æ</h2><p>æ¯æ¬¡è¯·æ±‚é‡Œï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¼šå‘AWS ElasticSearchå®ä¾‹ï¼ˆåŸŸåç±»ä¼¼ elastic.spain.adevinta.comï¼‰å‘é€1ï½3æ¬¡è¯·æ±‚ã€‚æˆ‘ä»¬åœ¨å®¹å™¨å†…æ”¾ç½®äº†ä¸€ä¸ªshellè„šæœ¬å¯ä»¥éªŒè¯è¿™ä¸ªåŸŸåä»DNSè§£æéœ€è¦å¤šé•¿æ—¶é—´ã€‚</p>
<p>å®¹å™¨å†…çš„DNSæŸ¥è¯¢ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@be-851c76f696-alf8z /]<span class="comment"># while true; do dig "elastic.spain.adevinta.com" | grep time; sleep 2; done</span></span><br><span class="line">;; Query time: 22 msec</span><br><span class="line">;; Query time: 22 msec</span><br><span class="line">;; Query time: 29 msec</span><br><span class="line">;; Query time: 21 msec</span><br><span class="line">;; Query time: 28 msec</span><br><span class="line">;; Query time: 43 msec</span><br><span class="line">;; Query time: 43 msec</span><br></pre></td></tr></table></figure></p>
<p>è¿è¡Œç€å¯¹åº”ç›¸åŒç”¨ç¨‹åºçš„EC2å®ä¾‹é‡Œçš„åŒæ ·çš„æŸ¥è¯¢ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bash-4.4<span class="comment"># while true; do dig "elastic.spain.adevinta.com" | grep time; sleep 2; done</span></span><br><span class="line">;; Query time: 77 msec</span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; Query time: 0 msec</span><br></pre></td></tr></table></figure></p>
<p>å¤§æ¦‚30msçš„è§£ææ—¶é—´ï¼Œä¼¼ä¹æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåœ¨å’ŒElasticSearché€šä¿¡æ—¶å¢åŠ äº†DNSè§£æçš„é¢å¤–æ¶ˆè€—ã€‚</p>
<p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸¤ç‚¹å¾ˆå¥‡æ€ªï¼š</p>
<ul>
<li>åœ¨Kubernetesé‡Œå·²ç»æœ‰å¾ˆå¤šåº”ç”¨ç¨‹åºå’ŒAWSèµ„æºé€šä¿¡ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚</li>
<li>æˆ‘ä»¬çŸ¥é“JVMå®ç°äº†å†…å­˜å†…çš„DNSç¼“å­˜ã€‚æŸ¥çœ‹è¿™äº›é•œåƒçš„é…ç½®ï¼Œåœ¨ $JAVA_HOME/jre/lib/security/java.securityé‡Œé…ç½®äº†TTLä¸º networkaddress.cache.ttl=10ã€‚JVMåº”è¯¥èƒ½å¤Ÿç¼“å­˜10ç§’å†…çš„æ‰€æœ‰DNSæŸ¥è¯¢ã€‚</li>
</ul>
<p>ä¸ºäº†ç¡®è®¤æ˜¯DNSçš„å½±å“ï¼Œæˆ‘ä»¬å†³å®šé¿å…DNSè§£æå¹¶ä¸”æŸ¥çœ‹é—®é¢˜æ˜¯å¦ä¼šæ¶ˆå¤±ã€‚é¦–å…ˆå°è¯•è®©åº”ç”¨ç¨‹åºç›´æ¥å’ŒElasticsearchçš„IPé€šä¿¡ï¼Œè€Œä¸æ˜¯åŸŸåã€‚è¿™è¦æ±‚ä»£ç å˜æ›´å¹¶ä¸”é‡æ–°éƒ¨ç½²ï¼Œå› æ­¤æˆ‘ä»¬åªæ˜¯ç®€å•åœ°åœ¨ /etc/hostsæ–‡ä»¶é‡Œæ·»åŠ äº†åŸŸåå’ŒIPçš„æ˜ å°„ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">34.55.5.111 elastic.spain.adevinta.com</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ ·å®¹å™¨å¯ä»¥ç«‹åˆ»è§£æIPã€‚æˆ‘ä»¬ç¡®å®è§‚å¯Ÿåˆ°äº†å»¶æ—¶çš„æ”¹å–„ï¼Œä½†æ˜¯ç¦»æˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡è¿˜æ˜¯å¾ˆè¿œã€‚å³ä½¿DNSè§£æè¶³å¤Ÿå¿«ï¼Œä½†æ˜¯çœŸå®åŸå› è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ã€‚</p>
<h2 id="ç½‘ç»œplumbing"><a href="#ç½‘ç»œplumbing" class="headerlink" title="ç½‘ç»œplumbing"></a>ç½‘ç»œplumbing</h2><p>æˆ‘ä»¬å†³å®šåœ¨å®¹å™¨é‡Œæ‰§è¡Œ tcpdumpï¼Œè¿™æ ·å¯ä»¥çœ‹åˆ°ç½‘ç»œåˆ°åº•å¹²äº†äº›ä»€ä¹ˆã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@be-851c76f696-alf8z /]<span class="comment"># tcpdump -leni any -w capture.pcap</span></span><br></pre></td></tr></table></figure></p>
<p>ç„¶åå‘é€äº†ä¸€äº›è¯·æ±‚å¹¶ä¸”ä¸‹è½½äº†captureæ–‡ä»¶ï¼ˆ <code>kubectl cpmy-service:/capture.pcap capture.pcap</code>ï¼‰åœ¨<a href="https://wiki.wireshark.org/FrontPage" target="_blank" rel="external">Wireshark</a>é‡ŒæŸ¥çœ‹ã€‚</p>
<p>DNSæŸ¥è¯¢çœ‹ä¸Šå»å¾ˆæ­£å¸¸ï¼ˆé™¤äº†ä¸€äº›ç»†èŠ‚ï¼Œä¹‹åä¼šæåˆ°ï¼‰ä½†æ˜¯æˆ‘ä»¬çš„æœåŠ¡å¤„ç†è¯·æ±‚çš„æ—¶å€™å¾ˆå¥‡æ€ªã€‚ä¸‹å›¾æ˜¯captureçš„æˆªå›¾ï¼Œæ˜¾ç¤ºä¸€ä¸ªè¯·æ±‚ä»å¼€å§‹åˆ°å“åº”çš„å…¨è¿‡ç¨‹ã€‚<br><img src="/images/wireshark.jpg" alt="Wireshark"></p>
<p>ç¬¬ä¸€åˆ—æ˜¯packetåºå·ã€‚æˆ‘ç”¨ä¸åŒçš„é¢œè‰²æ ‡ç¤ºä¸åŒçš„TCPæµã€‚</p>
<p>ç»¿è‰²çš„æµä»<code>packet 328</code>å¼€å§‹ï¼Œæ˜¾ç¤ºå®¢æˆ·ç«¯ï¼ˆ172.17.22.150ï¼‰å¼€å¯äº†å®¹å™¨ï¼ˆ172.17.36.147ï¼‰çš„TCPè¿æ¥ã€‚æœ€åˆçš„æ¡æ‰‹ï¼ˆ328-330ï¼‰ä¹‹åï¼Œ<code>packet 331</code>å¼€å§‹ <code>HTTP GET/v1/..</code>ï¼Œè¿™æ˜¯å¯¹æˆ‘ä»¬è‡ªå·±æœåŠ¡çš„å…¥ç«™è¯·æ±‚ã€‚æ•´ä¸ªæµç¨‹èŠ±äº†<strong>1ms</strong>ã€‚</p>
<p>ç°è‰²æµä»<code>packet 339</code>å¼€å§‹ï¼Œå±•ç¤ºäº†æˆ‘ä»¬çš„æœåŠ¡å‘é€ä¸€ä¸ªHTTPè¯·æ±‚ç»™Elasticsearchå®ä¾‹ï¼ˆè¿™é‡Œçœ‹ä¸åˆ°TCPæ¡æ‰‹è¿‡ç¨‹å› ä¸ºå®ƒä½¿ç”¨äº†ä¸€ä¸ªå·²æœ‰çš„TCPè¿æ¥ï¼‰ã€‚è¿™é‡ŒèŠ±äº†<strong>18ms</strong>ã€‚</p>
<p>è‡³æ­¤éƒ½æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæ‰€èŠ±çš„æ—¶é—´å’Œé¢„è®¡å·®ä¸å¤šï¼ˆ<strong>ï½20-30ms</strong>ï¼‰ã€‚</p>
<p>ä½†æ˜¯åœ¨è¿™ä¸¤æ¬¡äº¤äº’ä¹‹é—´ï¼Œç´«è‰²éƒ¨åˆ†èŠ±äº†<strong>86ms</strong>ã€‚è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿåœ¨<code>packet 333</code>ï¼Œ æˆ‘ä»¬çš„æœåŠ¡å‘é€äº†HTTP GETåˆ° <code>/latest/meta-data/iam/security-credentials</code>ï¼Œä¹‹åï¼Œåœ¨åŒä¸€ä¸ªTCPè¿æ¥é‡Œï¼Œå¦ä¸€ä¸ªGETå‘é€åˆ° <code>/latest/meta-data/iam/security-credentials/arn:..</code>ã€‚</p>
<p>æˆ‘ä»¬å‘ç°æ¯æ¬¡è¯·æ±‚é‡Œéƒ½ä¼šè¿™æ ·åšã€‚DNSè§£æåœ¨å®¹å™¨é‡Œç¡®å®æœ‰ä¸€ç‚¹æ…¢ï¼ˆè§£é‡Šå¾ˆæœ‰æ„æ€ï¼Œæˆ‘ä¼šåœ¨å¦ä¸€ç¯‡æ–‡ç« é‡Œä»‹ç»ï¼‰ã€‚ä½†æ˜¯é«˜å»¶è¿Ÿçš„å®é™…åŸå› æ˜¯æ¯æ¬¡è¯·æ±‚é‡Œå¯¹<code>AWS Instance Metadata</code>çš„æŸ¥è¯¢ã€‚</p>
<h2 id="çŒœæƒ³2ï¼šAWSè°ƒç”¨"><a href="#çŒœæƒ³2ï¼šAWSè°ƒç”¨" class="headerlink" title="çŒœæƒ³2ï¼šAWSè°ƒç”¨"></a>çŒœæƒ³2ï¼šAWSè°ƒç”¨</h2><p>è¿™ä¸¤ä¸ªendpointéƒ½æ˜¯<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html#instance-metadata-security-credentials" target="_blank" rel="external"><code>AWS Instance Metadata API</code></a>çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘ä»¬çš„å¾®æœåŠ¡ä»Elasticsearché‡Œè¯»å–æ—¶ä¼šç”¨åˆ°è¿™ä¸ªæœåŠ¡ã€‚è¿™ä¸¤ä¸ªè°ƒç”¨éƒ½æ˜¯åŸºç¡€çš„æˆæƒå·¥ä½œæµã€‚</p>
<p>ç¬¬ä¸€ä¸ªè¯·æ±‚é‡ŒæŸ¥è¯¢çš„endpointå¾—åˆ°å’Œè¯¥å®ä¾‹ç›¸å…³è”çš„IAMè§’è‰²ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># curl http://169.254.169.254/latest/meta-data/iam/security-credentials/</span></span><br><span class="line">arn:aws:iam::&lt;account_id&gt;:role/some_role</span><br></pre></td></tr></table></figure></p>
<p>ç¬¬äºŒä¸ªè¯·æ±‚æŸ¥è¯¢ç¬¬äºŒä¸ªendpointå¾—åˆ°è¯¥å®ä¾‹çš„ä¸´æ—¶credentialã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># curl http://169.254.169.254/latest/meta-data/iam/security-credentials/arn:aws:iam::&lt;account_id&gt;:role/some_role</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"Code"</span>: <span class="string">"Success"</span>,</span><br><span class="line">	<span class="string">"LastUpdated"</span>: <span class="string">"2012-04-26T16:39:16Z"</span>,</span><br><span class="line">	<span class="string">"Type"</span>: <span class="string">"AWS-HMAC"</span>,</span><br><span class="line">    <span class="string">"AccessKeyId"</span>: <span class="string">"ASIAIOSFODNN7EXAMPLE"</span>,</span><br><span class="line">    <span class="string">"SecretAccessKey"</span>: <span class="string">"wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"</span>,</span><br><span class="line">    <span class="string">"Token"</span>: <span class="string">"token"</span>,</span><br><span class="line">    <span class="string">"Expiration"</span>: <span class="string">"2017-05-17T15:09:54Z"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å®¢æˆ·ç«¯å¯ä»¥åœ¨çŸ­æ—¶é—´å†…ä½¿ç”¨å®ƒä»¬ï¼Œå¹¶ä¸”éœ€è¦å‘¨æœŸæ€§åœ°ï¼ˆåœ¨ Expirationä¹‹å‰ï¼‰å»è·å–æ–°çš„credencialã€‚æ¨¡å‹å¾ˆç®€å•ï¼šAWSä¸ºäº†å®‰å…¨è€ƒè™‘ç»å¸¸è½®è¯¢ä¸´æ—¶å¯†é’¥ï¼Œä½†æ˜¯å®¢æˆ·ç«¯å¯ä»¥å°†å¯†é’¥ç¼“å­˜å‡ åˆ†é’Ÿæ¥å¼¥è¡¥è·å¾—æ–°credencialæ‰€å¸¦æ¥çš„æ€§èƒ½å½±å“ã€‚</p>
<p>AWS Java SDKåº”è¯¥å¤„ç†è¿™äº›ï¼Œä½†æ˜¯ï¼Œå› ä¸ºæŸç§åŸå› ï¼Œå®ƒæ²¡æœ‰è¿™ä¹ˆåšã€‚</p>
<p>åœ¨GitHub issueé‡Œæœç´¢åæ‰¾åˆ°äº†<a href="https://github.com/aws/aws-sdk-java/issues/1921" target="_blank" rel="external">#1921</a>ï¼Œé‡Œé¢æœ‰æˆ‘ä»¬éœ€è¦çš„çº¿ç´¢ã€‚</p>
<p>AWS SDKåœ¨ä¸‹é¢ä¸¤ç§æƒ…å†µçš„æŸä¸€ç§æ»¡è¶³æ—¶å°±ä¼šåˆ·æ–°credentialï¼š</p>
<ul>
<li>Expirationåœ¨ EXPIRATION_THRESHOLDå†…ï¼Œç¡¬ç¼–ç ä¸º15åˆ†é’Ÿã€‚</li>
<li>å‰ä¸€æ¬¡åˆ·æ–°credentialçš„å°è¯•æ‰€èŠ±æ—¶é—´å¤§äº REFRESH_THRESHOLDï¼Œç¡¬ç¼–ç ä¸º60åˆ†é’Ÿã€‚</li>
</ul>
<p>æˆ‘ä»¬éœ€è¦æŸ¥çœ‹å¾—åˆ°çš„è¯ä¹¦é‡Œçš„å®é™…è¿‡æœŸæ—¶é—´ï¼Œå› æ­¤è¿è¡Œäº†ä¸¤ä¸ª cURLå‘½ä»¤è°ƒç”¨AWS APIï¼Œä¸€æ¬¡ä»å®¹å™¨é‡Œï¼Œä¸€æ¬¡ä»EC2å®ä¾‹é‡Œã€‚ä»å®¹å™¨é‡Œè·å¾—çš„è¯ä¹¦è¿‡æœŸæ—¶é—´çŸ­å¾—å¤šï¼Œæ˜¯15åˆ†é’Ÿã€‚</p>
<p>é—®é¢˜å˜å¾—æ¸…æ™°äº†ï¼šæˆ‘ä»¬çš„æœåŠ¡åœ¨ç¬¬ä¸€ä¸ªè¯·æ±‚é‡Œä¼šè·å–ä¸´æ—¶credentialã€‚å› ä¸ºå®ƒæœ‰15åˆ†é’Ÿçš„è¿‡æœŸæ—¶é—´ï¼Œåœ¨ä¸‹ä¸€æ¬¡è¯·æ±‚é‡Œï¼ŒAWS SDKä¼šé‡æ–°åˆ·æ–°credentialã€‚æ¯æ¬¡è¯·æ±‚éƒ½ä¼šè¿™æ ·ã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆcredentialè¿‡æœŸæ—¶é—´å˜çŸ­äº†ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆcredentialè¿‡æœŸæ—¶é—´å˜çŸ­äº†ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆcredentialè¿‡æœŸæ—¶é—´å˜çŸ­äº†ï¼Ÿ"></a>ä¸ºä»€ä¹ˆcredentialè¿‡æœŸæ—¶é—´å˜çŸ­äº†ï¼Ÿ</h2><p>AWS Intance Metadata Serviceè®¾è®¡ä¸Šæ˜¯åœ¨EC2å®ä¾‹é‡Œä½¿ç”¨ï¼Œè€Œä¸æ˜¯Kubernetesä¸Šã€‚æˆ‘ä»¬å¸Œæœ›åº”ç”¨ç¨‹åºä¿ç•™ç›¸åŒçš„æ¥å£ã€‚å› æ­¤ä½¿ç”¨äº†<a href="https://github.com/uswitch/kiam" target="_blank" rel="external">Kiam</a>ï¼Œåœ¨æ¯ä¸ªKubernetesèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªagentï¼Œå…è®¸ç”¨æˆ·ï¼ˆéƒ¨ç½²åº”ç”¨ç¨‹åºåˆ°é›†ç¾¤é‡Œçš„å·¥ç¨‹å¸ˆï¼‰å°†IAMè§’è‰²å…³è”åˆ°Podå®¹å™¨ä¸Šï¼Œå°±åƒå®ƒæ˜¯ä¸ªEC2å®ä¾‹ä¸€æ ·ã€‚å®ƒä¼šæˆªè·å‘é€åˆ°AWS Instance MetadataæœåŠ¡çš„è°ƒç”¨ï¼Œå¹¶ä¸”ä½¿ç”¨agentæå‰ä»AWSè·å–å¹¶æ”¾åœ¨ç¼“å­˜é‡Œçš„å†…å®¹å“åº”ã€‚ä»åº”ç”¨ç¨‹åºçš„è§’åº¦æ¥çœ‹ï¼Œå’Œè¿è¡Œåœ¨EC2ä¸Šæ²¡ä»€ä¹ˆåŒºåˆ«ã€‚</p>
<p>Kiamç»™Podæä¾›çš„æ­£æ˜¯çŸ­æœŸçš„credencialï¼Œè¿™æœ‰é“ç†ï¼Œå› ä¸ºå®ƒå‡å®šPodçš„å¹³å‡ç”Ÿå‘½å‘¨æœŸæ¯”EC2å®ä¾‹è¦çŸ­ã€‚é»˜è®¤å€¼å°±æ˜¯15åˆ†é’Ÿã€‚</p>
<p>ä½†æ˜¯å¦‚æœä¸¤å¤„éƒ½ä½¿ç”¨é»˜è®¤å€¼å°±æœ‰é—®é¢˜äº†ã€‚æä¾›ç»™åº”ç”¨ç¨‹åºçš„è¯ä¹¦è¿‡æœŸæ—¶é—´ä¸º15åˆ†é’Ÿã€‚AWS Java SDKä¼šå¼ºåˆ¶åˆ·æ–°ä»»ä½•è¿‡æœŸæ—¶é—´å°‘äº15åˆ†é’Ÿçš„è¯ä¹¦ã€‚</p>
<p>ç»“æœå°±æ˜¯æ¯ä¸ªè¯·æ±‚éƒ½ä¼šå¼ºåˆ¶åˆ·æ–°ä¸´æ—¶è¯ä¹¦ï¼Œè¿™éœ€è¦ä¸¤æ¬¡è°ƒç”¨AWS APIï¼Œç»™æ¯æ¬¡è¯·æ±‚éƒ½å¸¦æ¥äº†å·¨å¤§çš„å»¶è¿Ÿã€‚ä¹‹åæˆ‘ä»¬æ‰¾åˆ°äº†<a href="https://github.com/aws/aws-sdk-java/issues/1893" target="_blank" rel="external">AWS Java SDKçš„ä¸€ä¸ªåŠŸèƒ½è¯·æ±‚</a>ï¼Œé‡Œé¢æåˆ°äº†åŒæ ·çš„é—®é¢˜ã€‚</p>
<p>è§£å†³åŠæ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬é‡æ–°é…ç½®äº†Kiamï¼Œè¯·æ±‚æ›´é•¿è¿‡æœŸæ—¶é—´çš„credencialã€‚å½“è¿™ä¸€å˜æ›´ç”Ÿæ•ˆåï¼Œè¯·æ±‚å°±ä¸ç”¨æ¯æ¬¡éƒ½è°ƒç”¨AWS MetadataæœåŠ¡äº†ï¼Œè€Œä¸”å»¶è¿Ÿæ¯”EC2è¿˜è¦å°ã€‚</p>
<h2 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h2><p>ä»æˆ‘ä»¬è¿ç§»çš„ç»éªŒé‡Œï¼Œæœ€ç»å¸¸é‡åˆ°çš„é—®é¢˜ä¸æ˜¯Kubernetesçš„bugæˆ–è€…å¹³å°çš„é—®é¢˜ã€‚ä¹Ÿä¸æ˜¯å¾®æœåŠ¡æœ¬èº«çš„é—®é¢˜ã€‚é—®é¢˜é€šå¸¸åªæ˜¯å› ä¸ºé›†æˆã€‚æˆ‘ä»¬å°†ä»¥å‰ä»æ¥æ²¡æœ‰ä¸€èµ·é›†æˆè¿‡çš„å¤æ‚ç³»ç»Ÿæ··åˆåœ¨ä¸€èµ·ï¼Œå¹¶ä¸”æœŸæœ›å®ƒä»¬ç»„æˆå•ä¸ªçš„å¤§ç³»ç»Ÿã€‚å¯ç§»åŠ¨ç»„ä»¶è¶Šå¤šï¼Œå¯èƒ½å‘ç”Ÿé—®é¢˜çš„åœ°æ–¹å°±è¶Šå¤šã€‚</p>
<p>åœ¨è¿™ä¸ªé—®é¢˜é‡Œï¼Œé«˜å»¶è¿Ÿå¹¶ä¸æ˜¯å› ä¸ºbugæˆ–è€…Kubernetesã€Kiamã€AWS Java SDKæˆ–æˆ‘ä»¬è‡ªå·±å¾®æœåŠ¡æœ¬èº«æœ‰ä»€ä¹ˆé—®é¢˜ã€‚å®ƒæ˜¯Kiamå’ŒAWS Java SDKé‡Œä¸¤ä¸ªç‹¬ç«‹çš„é»˜è®¤å€¼ç»„åˆåœ¨ä¸€èµ·å¯¼è‡´çš„é—®é¢˜ã€‚ç‹¬ç«‹æ¥çœ‹ï¼Œä¸¤ä¸ªé»˜è®¤å€¼éƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼šAWS Java SDKå¼ºåˆ¶credentialåˆ·æ–°ç­–ç•¥å’ŒKiamæ¯”è¾ƒä½çš„é»˜è®¤è¿‡æœŸæ—¶é—´ã€‚ä½†æ˜¯ç»„åˆèµ·æ¥å°±å¯¼è‡´äº†é—®é¢˜ã€‚<strong>ä¸¤ä¸ªå•ç‹¬çœ‹éƒ½æ˜¯æ­£ç¡®çš„å†³å®šåˆåœ¨ä¸€èµ·å¹¶ä¸ä¸€å®šæ˜¯æ­£ç¡®çš„</strong>ã€‚</p>
<blockquote>
<p>å¦‚æœä½¿ç”¨çš„æ˜¯awsçš„eksï¼Œç°åœ¨å¯ä»¥ä¸ç”¨ä½¿ç”¨kiamè¿™ä¸ªæ’ä»¶æ¥å®ç°roleè®¿é—®awsæœåŠ¡ï¼Œaws eks å®ç°äº†service accounts ä¸ role ç»‘å®šï¼Œå…·ä½“å‚è€ƒï¼š<a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/iam-roles-for-service-accounts.html" target="_blank" rel="external">https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/iam-roles-for-service-accounts.html</a></p>
</blockquote>
<p>æ¥æºï¼škubernetes-added-a-0-to-my-latency</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[LPRæ˜¯ä»€ä¹ˆï¼Œå¤®è¡Œç»™æœ‰æ”¾è´·çš„äººå¸¦æ¥ä»€ä¹ˆæ–°å¹´ç¤¼ç‰©]]></title>
      <url>http://team.jiunile.com/blog/2020/01/lpr.html</url>
      <content type="html"><![CDATA[<h2 id="part-1"><a href="#part-1" class="headerlink" title="part 1"></a>part 1</h2><p><code>æ¯ä¸€ä¸ªèƒŒè´Ÿäº†æˆ¿è´·çš„äººï¼Œç»å¯¹æƒ³ä¸åˆ°ï¼Œè¿›å…¥2020å¹´å¤´çš„æ—¶å€™ï¼Œå¤®è¡Œä¼šé€æ¥ä¸€ä»½å¤§ç¤¼ã€‚</code></p>
<p>2019å¹´12æœˆ28æ—¥ï¼Œä¸­å›½äººæ°‘é“¶è¡Œï¼ˆå¤®è¡Œï¼‰å‘å¸ƒå¹´å†…ç¬¬30å·å…¬å‘Šã€‚å…¬å‘Šä¸­çš„æ–‡å­—éå¸¸ä¸“ä¸šã€æ™¦æ¶©ï¼Œä¸æ˜¯é‡‘èä¸“ä¸šå‡ºèº«çš„äººï¼Œä¼šè§‰å¾—äº‘é‡Œé›¾é‡Œï¼Œä¹Ÿä½“ä¼šä¸åˆ°è¿™åˆ™å…¬å‘Šçš„å²è¯—çº§ä½œç”¨ã€‚</p>
<p>ç¬¬ä¸€ï¼š<strong>ä»2020å¹´1æœˆ1æ—¥å¼€å§‹ï¼Œå•†ä¸šé“¶è¡Œä¸å¾—å’Œä¹°æˆ¿äººï¼Œç­¾è®¢å‚è€ƒè´·æ¬¾åŸºå‡†åˆ©ç‡çš„æµ®åŠ¨åˆ©ç‡è´·æ¬¾åˆåŒã€‚</strong></p>
<p>ç¬¬äºŒï¼š<strong>ä»2020å¹´3æœˆ1æ—¥å¼€å§‹ï¼Œå•†ä¸šé“¶è¡Œå¿…é¡»å’Œå­˜é‡æˆ¿è´·çš„å€Ÿæ¬¾äººï¼ŒåºŸé™¤åŸæœ‰æˆ¿è´·åˆåŒï¼Œè®©å€Ÿæ¬¾äººé‡æ–°äºŒé€‰ä¸€ï¼Œè¦ä¹ˆï¼šå›ºå®šåˆ©ç‡ï¼›è¦ä¹ˆï¼šã€ŒLPRåˆ©ç‡+åŸºç‚¹åŠ æˆã€æ¨¡å¼ã€‚</strong></p>
<a id="more"></a>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä»ä»Šå¹´çš„3æœˆ1æ—¥å¼€å§‹è‡³8æœˆä»½çš„5ä¸ªæœˆæ—¶é—´é‡Œï¼Œå½“åˆå’Œä¹°æˆ¿äººç­¾è®¢äº†æˆ¿è´·åˆåŒçš„é“¶è¡Œï¼Œä¼šè”ç³»ä¹°æˆ¿äººï¼Œåå•†åºŸé™¤åŸæœ‰çš„ã€ŒåŸºå‡†åˆ©ç‡+æµ®åŠ¨æ¯”ä¾‹ã€åˆ©ç‡åˆåŒï¼Œå†äºŒé€‰ä¸€ã€‚</p>
<p>ä¸€å®šè¦è®°ä½ï¼Œæ— è®ºé“¶è¡Œæ€ä¹ˆå·§èˆŒå¦‚ç°§ï¼Œå£åè²èŠ±ï¼š</p>
<p><code>ä¸è¦é€‰æ‹©å›ºå®šåˆ©ç‡æ¨¡å¼ï¼Œé€‰æ‹©ã€ŒLPRåˆ©ç‡+åŸºç‚¹åŠ æˆã€æ¨¡å¼ï¼</code></p>
<p>å¤®è¡Œå…¬å‘Šä¸­è¯´å¾—å¾ˆæ¸…æ¥šï¼Œè¿™ç§å˜æ›´ï¼Œä¸€è¾ˆå­åªæœ‰ä¸€æ¬¡æœºä¼šï¼Œé€‰é”™äº†çš„è¯ï¼Œæ˜¯æ— æ³•æ›´æ”¹çš„ã€‚</p>
<p>ä¸è¦å°çœ‹ä¸¤ç§åˆ©ç‡æ¨¡å¼çš„å·®åˆ«ï¼Œæˆ‘ä»¬å¯ä»¥å¤§è‡´ä¼°ç®—ä¸‹ï¼Œåœ¨æŸäº›å¹´ä»½ï¼Œåˆ©ç‡å·®è·å¯èƒ½è¾¾åˆ°1-5ä¸ªç™¾åˆ†ç‚¹ã€‚å¦‚æœæˆ¿è´·ä½™é¢æœ‰300ä¸‡å…ƒçš„è¯ï¼Œæ¯å¹´è¿˜æ¬¾å·®å¼‚å¯èƒ½è¾¾åˆ°3-15ä¸‡å…ƒã€‚</p>
<p>åœ¨è¿‡å»å‡ å¹´ï¼Œæ•°ç™¾ä¸‡çš„å¹´è½»äººå¤«å¦»ï¼Œæç©ºäº†çˆ¶æ¯è¾ˆçš„é’±åŒ…ï¼ŒèƒŒè´Ÿäº†æˆ¿è´·ï¼Œä¸æ•¢è¾èŒå’Œè·³æ§½ï¼Œè¿‡ä¸Šäº†ä¸æ•¢æ¶ˆè´¹çš„ä½›ç³»ç”Ÿæ´»ã€‚</p>
<p>ç¿»é˜…äº†å¤®è¡Œçš„å®šæœŸæŠ¥å‘Šï¼Œæˆªæ­¢2019å¹´8æœˆä»½ï¼Œä¸ªäººè´·æ¬¾ä½™é¢æ€»é‡åœ¨29ä¸‡äº¿å…ƒã€‚ä½ çš„æˆ¿è´·ï¼Œå°±åœ¨å…¶ä¸­ã€‚</p>
<p>ç°åœ¨ï¼Œå¤®è¡Œè¦ç»™ä½ æ¾ç»‘äº†ï¼Œå¸ä¸‹é‡æ‹…äº†ï¼Œå°±çœ‹ä½ 3ä¸ªæœˆä¹‹åï¼Œè¦ä¸è¦æ¥æ”¶è¿™ä»½å¤§ç¤¼ï¼Œæ”¹å˜ä¸€å®¶å­çš„å‘½è¿äº†ã€‚</p>
<h2 id="part-2"><a href="#part-2" class="headerlink" title="part 2"></a>part 2</h2><p>å¤®è¡Œåœ¨2019å¹´8æœˆä»½ï¼Œè¿›è¡Œæˆ¿è´·å˜é©çš„ç»†èŠ‚ã€‚</p>
<p><strong>å˜é©å‰ï¼Œæˆ¿è´·åˆ©ç‡=å¤®è¡ŒåŸºå‡†åˆ©ç‡+æµ®åŠ¨æ¯”ä¾‹ã€‚</strong></p>
<p>åŸºå‡†åˆ©ç‡ç”±å¤®è¡Œç»Ÿä¸€å…¬å¸ƒï¼Œå•†ä¸šé“¶è¡Œæ— æƒæ§åˆ¶ï¼Œåªèƒ½è¢«åŠ¨è·Ÿéšã€‚å¦‚æœå¤®è¡ŒåŠ æ¯äº†ï¼Œæˆ–è€…é™æ¯äº†ï¼Œé‚£ä¹ˆåœ¨æ¥å¹´çš„å›ºå®šæ—¥æœŸ1æœˆ1æ—¥ï¼Œè´­æˆ¿è€…çš„åŸºå‡†åˆ©ç‡å°±ç»Ÿä¸€æ”¹å˜ã€‚å½“å‰çš„åŸºå‡†åˆ©ç‡æ˜¯4.90%ã€‚</p>
<p>å•†ä¸šé“¶è¡Œèƒ½å¤Ÿæ”¹å˜çš„å°±æ˜¯â€œæµ®åŠ¨æ¯”ä¾‹â€ã€‚æœ‰äº›åŸå¸‚çš„é“¶è¡Œè´§å¸å®½æ¾ï¼Œé¼“åŠ±é¦–å¥—æˆ¿ç½®ä¸šï¼Œåœ°æ–¹æ”¿åºœè´¢æºä¾èµ–äºåœŸåœ°å‡ºè®©é‡‘ï¼Œé‚£ä¹ˆå¯èƒ½åœ¨åŸºå‡†åˆ©ç‡çš„åŸºç¡€ä¸Šæ‰“æŠ˜æ‰£ï¼Œä½†æ˜¯å¤§å¤šæ•°åŸå¸‚ï¼Œæ˜¯æ²¡æœ‰æµ®åŠ¨æ¯”ä¾‹ï¼Œæˆ–è€…ä¸Šæµ®çš„ã€‚</p>
<p>å¯¹è´­æˆ¿è€…è€Œè¨€ï¼Œå’Œé“¶è¡Œç­¾è®¢çš„â€œæµ®åŠ¨æ¯”ä¾‹â€ä¸€æ—¦ç¡®è®¤ï¼Œæ˜¯æ— æ³•å˜æ›´çš„ã€‚</p>
<p><strong>å˜é©åï¼Œæˆ¿è´·åˆ©ç‡=è´·æ¬¾å¸‚åœºæŠ¥ä»·ï¼ˆLPRï¼‰åˆ©ç‡+åŸºç‚¹åŠ æˆã€‚</strong></p>
<p>LPRåˆ©ç‡ï¼Œä¸“ä¸šè¯´æ³•æ˜¯â€œå…¨å›½é“¶è¡Œé—´åŒä¸šæ‹†å€Ÿä¸­å¿ƒâ€ï¼Œç»Ÿè®¡18å®¶é“¶è¡ŒæŠ¥å‡ºçš„å„è‡ªçš„1å¹´æœŸå’Œ5å¹´æœŸä»¥ä¸Šè´·æ¬¾åˆ©ç‡ï¼Œå‰”é™¤æœ€ä½ä»·ã€æœ€é«˜ä»·åï¼Œè®¡ç®—ç®—æœ¯å¹³å‡ä»·ã€‚</p>
<p>è¯´å¾—æ›´åŠ ç›´ç™½ä¸€ç‚¹</p>
<p><code>LPRåˆ©ç‡æ›´åŠ å¸‚åœºåŒ–ï¼Œåœ¨åæ˜ å…¨ç¤¾ä¼šæ— é£é™©åˆ©ç‡çš„ç¨‹åº¦ä¸Šï¼Œæ›´åŠ é€¼çœŸã€‚</code></p>
<p>å½“ç»æµè¿‡çƒ­æ—¶ï¼Œé€šèƒ€æ—¶ï¼Œåˆ©ç‡é«˜ï¼›</p>
<p>å½“ç»æµè¿‡å†·æ—¶ï¼Œé€šç¼©æ—¶ï¼Œåˆ©ç‡ä½ã€‚</p>
<p>è¿™ç§å¸‚åœºåŒ–çš„åˆ©ç‡ï¼Œå°†è´·æ¬¾äººå’Œå€Ÿæ¬¾äººä¹‹é—´çš„åˆ©ç›Šã€é£é™©ï¼Œå‡è¡¡äº†ä¸‹ã€‚</p>
<p>å¤®è¡Œé«˜å±‹å»ºç“´ï¼Œå°†1å¹´æœŸLPRåˆ©ç‡ï¼Œç”¨äºå®ä½“ç»æµï¼›å°†5å¹´æœŸLPRåˆ©ç‡ï¼Œç”¨äºäº†æˆ¿åœ°äº§å¸‚åœºã€‚<br><img src="/images/other/1.jpg" alt="1"></p>
<p>å½“éœ€è¦ç»™å®ä½“ç»æµé™æ¯æ—¶ï¼Œå°±è°ƒä½1å¹´æœŸLPRåˆ©ç‡ï¼Œä¸è®©æ¼«çŒçš„å¤§æ°´è¿›å…¥æˆ¿åœ°äº§è¡Œä¸šã€‚</p>
<p>å½“éœ€è¦å•ç‹¬å¯¹æˆ¿åœ°äº§è°ƒæ§æ—¶ï¼Œåªéœ€è¦æé«˜5å¹´æœŸLPRçš„åˆ©ç‡ï¼Œå°±ä¸ä¼šå¯¹å®ä½“ç»æµäº§ç”Ÿæˆæœ¬å‹åŠ›ã€‚</p>
<p>ä½†æ˜¯ä»é•¿æœŸæ¥çœ‹ï¼Œ<strong>5å¹´æœŸLPRåˆ©ç‡ï¼Œä¸€å®šä¼šå‘1å¹´æœŸLPRåˆ©ç‡è¿›è¡Œå›å½’å’Œé æ‹¢çš„ã€‚</strong></p>
<p>2019å¹´11æœˆ20æ—¥ï¼Œå¤®è¡Œæˆæƒå…¨å›½é“¶è¡Œé—´åŒä¸šæ‹†å€Ÿä¸­å¿ƒå…¬å¸ƒäº†æœ€æ–°ä¸€æœŸè´·æ¬¾å¸‚åœºæŠ¥ä»·åˆ©ç‡ï¼ˆLPRï¼‰ã€‚1å¹´æœŸLPRåˆ©ç‡ä¸º4.15%ï¼Œ5å¹´æœŸä»¥ä¸ŠLPRåˆ©ç‡ä¸º4.80%ã€‚åŒ10æœˆ21æ—¥å…¬å¸ƒçš„ä¸ŠæœŸæ•°å€¼ç›¸æ¯”ï¼Œå‡ä¸‹è°ƒäº†5ä¸ªåŸºç‚¹ã€‚</p>
<p>ç‰¹åˆ«åœ°ï¼Œ5å¹´æœŸLPRåˆ©ç‡4.80%ï¼Œæ¯”åŸæœ‰çš„è´·æ¬¾åŸºå‡†åˆ©ç‡4.90%ï¼Œä½äº†10ä¸ªåŸºç‚¹ï¼Œä¹Ÿå°±æ˜¯0.1ä¸ªç™¾åˆ†ç‚¹ã€‚</p>
<p>å¦‚æœ2020å¹´1æœˆä»¥åä¹°æˆ¿å­ï¼Œç­¾è®¢çš„æ˜¯å˜é©åçš„æˆ¿è´·åˆ©ç‡æ¨¡å¼ï¼Œæœªæ¥LPRåˆ©ç‡é•¿æœŸä¸‹è¡Œï¼Œé‚£ä¹ˆä¹°æˆ¿äººå’Œè´·æ¬¾æœºæ„çš„æˆ¿è´·åˆ©ç‡ï¼Œä¹Ÿå¿…ç„¶ä¸‹è¡Œï¼Œè¿™æ ·çš„è¯ï¼Œä¹°æˆ¿äººæ‰¿æ‹…çš„åˆ©ç‡æˆæœ¬ï¼Œå’Œå…¨ç¤¾ä¼šçš„åˆ©ç‡æˆæœ¬å¤§è‡´ç›¸å½“ã€‚</p>
<p>å¦‚æœæ˜¯2019å¹´8æœˆä»½ä¹‹å‰ä¹°çš„æˆ¿å­ï¼Œä¹°æˆ¿äººå’Œè´·æ¬¾æœºæ„ç­¾è®¢çš„æ˜¯åŸºå‡†åˆ©ç‡ï¼Œæˆ–è€…å›ºå®šåˆ©ç‡ï¼Œé‚£ä¹ˆæœªæ¥ç¤¾ä¼šæ— é£é™©åˆ©ç‡ä¸‹è¡Œåï¼Œä¹°æˆ¿äººæ‰¿æ‹…çš„å‹åŠ›ï¼Œå°†å‰æ‰€æœªæœ‰çš„å¤§ã€‚è¿™æ‰¹ä¹°æˆ¿äººï¼Œå®Œå…¨å°†è‡ªå·±çš„äººç”Ÿä¸Šè´¡ç»™äº†é“¶è¡Œå¸å›½ï¼Œå’Œåæ¥è½»è£…ä¸Šé˜µçš„ä¹°æˆ¿è€…ï¼Œæ³¾æ¸­åˆ†æ˜ï¼Œç¤¾ä¼šçš„ä¸å…¬å¹³æ€§å°±æ‹‰å¤§äº†ã€‚</p>
<p>æœ‰äº›äººå¯èƒ½ä¼šè¯´ï¼Œå˜é©å‰åï¼ŒäºŒç§åˆ©ç‡çš„å·®å¼‚ï¼Œå°±åœ¨10ä¸ªåŸºç‚¹ï¼Œ0.1ä¸ªç™¾åˆ†ç‚¹ï¼Œå·®å¼‚ä¸å¤§ã€‚</p>
<p>ä½ è¦è¿™ä¹ˆè¯´ï¼Œåªèƒ½è¯æ˜ï¼Œ<code>å¯¹æˆ‘ä»¬å›½å®¶æœªæ¥åˆ©ç‡ä¸‹è¡Œè¶‹åŠ¿çš„åŠ›é‡ï¼Œä¸€æ— æ‰€çŸ¥ï¼</code></p>
<h2 id="part-3"><a href="#part-3" class="headerlink" title="part 3"></a>part 3</h2><p>ä½ ä¹Ÿè®¸ä¼šé—®ï¼š</p>
<p><strong>å¤®è¡Œå’Œæ”¾è´·é“¶è¡Œï¼Œå±…ç„¶ç»™æˆ‘ä»¬ä¹°æˆ¿è€…è¿™ä¹ˆå¥½çš„ç¦åˆ©ï¼Œä¼šæŠŠåƒè¿›è‚šå­é‡Œçš„è‚‰ï¼Œåäº†å‡ºæ¥ï¼Œå®ƒä»¬å›¾ä»€ä¹ˆå‘¢ï¼Ÿ</strong></p>
<p>å‘µå‘µã€‚å…ˆè®©æ˜å“¥ç¬‘å‡ å£°ã€‚</p>
<p>å¦‚æœä½ èƒ½è¿™ä¹ˆæƒ³ï¼Œè¯´æ˜ä½ çœŸçš„å¤ªå¤©çœŸäº†ã€‚</p>
<p>å¤®è¡Œå’Œæ”¾è´·é“¶è¡Œï¼Œç»™å€Ÿæ¬¾äººæ¾ç»‘ï¼Œç»å¯¹ä¸æ˜¯ä¸ºäº†æŠŠåƒè¿›è‚šå­é‡Œçš„è‚‰åå‡ºæ¥ï¼Œè€Œæ˜¯æ‹…å¿ƒæœªæ¥è¿›å…¥ä½åˆ©ç‡æ—¶ä»£ä»¥åï¼Œå€Ÿæ¬¾äººå¼ƒæˆ¿è€Œå»ï¼Œé‚£æ ·ä¼šå¼•å‘å…¨ç¤¾ä¼šç³»ç»Ÿæ€§çš„å¤§é£é™©ã€‚</p>
<p>å› ä¸ºï¼Œå®ƒä»¬æ˜¯æå…¶ä¸“ä¸šå’Œå‰ç»çš„æœºæ„ï¼Œå·²ç»æå‰é¢„æµ‹åˆ°äº†ï¼š</p>
<p><code>åœ¨æœªæ¥5-20å¹´çš„æ—¶é—´é•¿åº¦å†…ï¼Œä¸­å›½ä¸€å®šä¼šæ­¥å‘è¾¾å›½å®¶çš„åå°˜ï¼Œè¿›å…¥ä½åˆ©ç‡ï¼Œç”šè‡³æ˜¯è´Ÿåˆ©ç‡æ—¶ä»£ã€‚</code></p>
<p>è¿™æ˜¯åäº‹å—ï¼Ÿç»å¯¹ä¸æ˜¯ï¼Œè¿™æ˜¯ä»»ä½•ç»æµä½“å‘å±•åˆ°ä¸€å®šæ°´å¹³åï¼Œå¿…ç„¶è¦è¿›å…¥çš„å¸¸æ€ã€‚</p>
<p>å½“ç»æµä½“çš„ç”Ÿäº§åŠ›å·²ç»å……åˆ†å‘è¾¾ï¼Œäººå£ä¸å†ç»§ç»­å¢é•¿ï¼Œç‰©è´¨å……åˆ†ä¸°å¯Œä»¥åï¼Œä¸€ä¸ªå¸‚åœºçš„æ¶ˆè´¹èƒ½åŠ›æ˜¯æœ‰é™çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¼ä¸šç”Ÿäº§å‡ºæ¥çš„å®ä½“å•†å“ã€æä¾›çš„æœåŠ¡å’Œè™šæ‹Ÿå•†å“ï¼Œç»ˆå°†è¶…è¿‡è¯¥å›½æˆ–è€…å…¨çƒæ‰€æœ‰äººå£çš„æ¶ˆè´¹æ½œåŠ›ã€‚</p>
<p>å‡å¦‚æ²¡æœ‰çªç ´æ€§çš„ç§‘æŠ€è¿›å±•ï¼Œé‚£ä¹ˆä¼ä¸šå®¶æ²¡æœ‰å¤šä½™åˆ©æ¶¦å¯å›¾ï¼Œå°†ä¸å†æ‰©å¤§ç”Ÿäº§ï¼Œä¸å°†åˆ©æ¶¦å†æŠ•èµ„ï¼Œä¸å‘é“¶è¡Œé—´æ¥è´·æ¬¾èèµ„ï¼Œä¸å‘è‚¡ç¥¨å¸‚åœºç›´æ¥è‚¡æƒèèµ„ï¼Œç¤¾ä¼šçš„GDPåŸåœ°è¸æ­¥ï¼Œå¹´è½»äººè–ªèµ„20å¹´ä¸ä¸Šæ¶¨ã€‚</p>
<p>è¿™æ ·å°†å¯¼è‡´ï¼Œç¤¾ä¼šä¸Šçš„å­˜æ¬¾èµ„é‡‘å’Œå¯æŠ•èµ„èµ„é‡‘ï¼Œå°†æ— å¤„å¯å»ã€‚å•†ä¸šé“¶è¡Œæ”¶å‚¨äº†æµ·é‡çš„å±…æ°‘å­˜æ¬¾ï¼Œæ‰¾ä¸åˆ°é€‚æ ¼çš„ä¼ä¸šå»å‘æ”¾è´·æ¬¾ï¼Œè‡ªç„¶ä¹Ÿèµšå–ä¸äº†æ¯å·®ã€‚</p>
<p>æ•´ä½“ç¤¾ä¼šçš„åˆ©ç‡ï¼Œå°†æ˜¾è‘—ä¸‹è¡Œã€‚</p>
<p>ç»Ÿè®¡è¿‡ï¼Œ2020å¹´åˆï¼Œå…¨çƒ26ä¸ªå›½å®¶æˆ–ç»æµä½“å½“ä¸­ï¼Œæœ‰20ä¸ªå›½å®¶æˆ–ç»æµä½“åˆ©ç‡å¤„äºä¸‹é™è¶‹åŠ¿ã€‚</p>
<p>æ¬§ç›Ÿå¤®è¡Œï¼š-0.5%ï¼›</p>
<p>æ—¥æœ¬å¤®è¡Œï¼š-0.1%ï¼›</p>
<p>å¾·å›½10å¹´æœŸå›½å€ºï¼š-0.675%ã€‚</p>
<p>2019å¹´8æœˆ5å·ï¼Œä¸¹éº¦çš„ç¬¬ä¸‰å¤§é“¶è¡Œæ—¥å¾·å…°é“¶è¡Œï¼Œæ¨å‡ºäº†äººç±»å†å²ä¸Šé¦–ç¬”è´Ÿåˆ©ç‡æŒ‰æ­è´·æ¬¾ä¸šåŠ¡ï¼Œæˆ¿è´·åˆ©ç‡ä¸º-0.5%ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p>
<p>å¦‚æœä½ å€Ÿä¸¹éº¦è¿™å®¶é“¶è¡Œ100ä¸‡å…ƒå»ä¹°æˆ¿ï¼Œä¸€å¹´åä½ åªéœ€è¿˜99.5ä¸‡å…ƒå°±å¯ä»¥äº†ã€‚</p>
<p>è¿™å®¶é“¶è¡Œå‘ä¹°æˆ¿äººå‘æ”¾è´·æ¬¾ï¼Œè´·æ¬¾ä¹°æˆ¿äººï¼Œæœ€ç»ˆè¿˜çš„é’±ï¼Œæ¯”å½“åˆé“¶è¡Œå€Ÿå‡ºçš„é’±ï¼Œè¿˜è¦å°‘ï¼</p>
<p>å¬èµ·æ¥ï¼Œåƒä¸åƒå¤©æ–¹å¤œè°­ï¼Ÿç»å¯¹ä¸æ˜¯ï¼Œè¿™åœ¨è¥¿æ–¹å‘è¾¾ç»æµä½“ä¹‹ä¸­ï¼Œå·²ç»æˆä¸ºäº†å¸¸è¯†ã€‚</p>
<p>2019å¹´8æœˆ6å·ï¼Œç‘å£«é“¶è¡Œå®£å¸ƒå¯¹50ä¸‡æ¬§å…ƒä»¥ä¸‹çš„å­˜æ¬¾è´¦æˆ·æ”¶å–å¹´è´¹ï¼Œå¹¶ä¸”ä¸æ”¯ä»˜åˆ©æ¯ã€‚</p>
<p>åŒæ ·åœ°ï¼Œç”±äºæ¬§ç›Ÿç»„ç»‡é‡‘èä½“ç³»çš„åˆ©ç‡æ˜¯-0.5%ï¼Œè¿™æ„å‘³ç€ï¼Œä¸€ä¸ªäººåœ¨æ¬§ç›Ÿæ‰€å±çš„é“¶è¡Œå­˜æ¬¾1ä¸‡æ¬§å…ƒï¼Œä¸€å¹´åï¼Œåªèƒ½å–å›9950æ¬§å…ƒã€‚<br><img src="/images/other/2.jpg" alt="2"></p>
<p>2019å¹´11æœˆ21æ—¥ï¼Œå·²ç»å¸ä»»äº†ä¸­å›½äººæ°‘é“¶è¡Œè¡Œé•¿èŒä½çš„å‘¨å°å·ï¼Œåœ¨åˆ›æ–°ç»æµè®ºå›ä¸Šè¡¨ç¤ºï¼š</p>
<p><strong>ä¸­å›½å¯ä»¥å°½é‡é¿å…å¿«é€Ÿåœ°è¿›å…¥åˆ°è´Ÿåˆ©ç‡æ—¶ä»£ã€‚</strong></p>
<p>è¨€ä¸‹ä¹‹æ„ï¼Œæˆ‘ä»¬ç¤¾ä¼šå¯ä»¥æ¨è¿Ÿè¿›å…¥åˆ°è´Ÿåˆ©ç‡æ—¶ä»£çš„æ—¶é—´é•¿åº¦ï¼Œå»¶è¿Ÿå®ƒçš„åˆ°æ¥ï¼Œä½†æ˜¯æ”¹å˜ä¸äº†å†å²å½’é€”ã€‚</p>
<p>åœ¨2017å¹´ä¹‹å‰çš„20å¹´æ—¶é—´é‡Œï¼Œæˆ‘ä»¬å·²ç»ä¹ æƒ¯äº†æˆ¿ä»·çš„ä¸Šæ¶¨ã€ç‰©ä»·çš„ä¸Šæ¶¨ï¼Œäººæ°‘å¸è´­ä¹°åŠ›çš„è´¬å€¼ã€‚å…¶æ ¹æœ¬åŸå› åœ¨äºï¼Œæˆ‘ä»¬å›½å®¶ä¾ç„¶å¤„äºå‘å±•é˜¶æ®µï¼Œå„è¡Œå„ä¸šçš„å•†å“å’ŒæœåŠ¡ï¼Œè¿˜æœ‰ç€å·¨å¤§çš„ç©ºç™½å¸‚åœºå»ç­‰ç€å‘æ˜ã€‚</p>
<p>æˆ¿è´·åˆ©ç‡5.53%ã€æ°‘é—´å€Ÿè´·åˆ©ç‡10-30%ã€P2Pç½‘è´·åˆ©ç‡20-50%ã€‚é“¶è¡Œç†è´¢äº§å“æ”¶ç›Šç‡ä½äº6%ï¼Œéƒ½æ²¡æœ‰å¤§å¦ˆå¤§çˆ·çœ‹å¾—ä¸Šã€‚</p>
<p>ä»2017å¹´å¼€å§‹ï¼Œé«˜æ”¶ç›Šçš„å¹»è±¡ï¼Œé€ä¸€ç ´ç­äº†ã€‚æˆ¿ä»·ä¸‹è·Œã€P2På¹³å°çˆ†é›·ã€ä¸Šå¸‚å…¬å¸å¤šå…ƒåŒ–æ‰©å¼ ä¸€åœ°é¸¡æ¯›ã€‚é‚£äº›è¿½é€é«˜æ”¶ç›Šçš„äººï¼Œä¸ä»…æ²¡æœ‰å¾—åˆ°é«˜åˆ©ç‡ï¼Œè¿è‡ªå·±çš„æœ¬é‡‘éƒ½æŸå¤±æ‰äº†ã€‚</p>
<p>è‚¡å¸‚æ”¶ç›Šç‡é¢„æœŸé™ä½ã€å¹´è½»äººå°±ä¸šå¿ƒæ€æ”¾å¹³ã€ä¸­å¹´äººåªæ±‚ä¿ä½é¥­ç¢—ï¼Œè¿™æ‰æ˜¯æœªæ¥æˆ‘å›½ç»æµçš„ã€Œæ–°å¸¸æ€ã€ã€‚</p>
<p>è¿›å…¥ä½åˆ©ç‡æ—¶ä»£åï¼Œæˆ‘ä»¬å»é“¶è¡Œå­˜é’±ï¼Œä¸ä»…æ²¡æœ‰åˆ©æ¯ï¼Œè¿˜è¦å€’ä»˜è´¹ç”¨ç»™é“¶è¡Œæ¥è´Ÿè´£ä¿ç®¡æˆ‘ä»¬çš„èµ„äº§æ•°æ®ã€‚</p>
<p>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>å› ä¸ºé“¶è¡Œæ”¶å‚¨ä¹‹åï¼Œå°†å±…æ°‘èµ„äº§ä¿ç®¡åœ¨é“¶è¡Œå†…éƒ¨ï¼Œå®ƒæ”¾è´·ä¸å‡ºå»ï¼Œæ²¡æœ‰äººæ¥å€Ÿæ¬¾ï¼Œè‡ªç„¶èµšå–ä¸äº†åˆ©æ¯å·®å¸¦æ¥çš„åˆ©æ¶¦ã€‚</p>
<p>æ‰€ä»¥ï¼Œè´Ÿåˆ©ç‡æ—¶ä»£åˆ°æ¥ä»¥åï¼Œè°æ”¾é’±åœ¨é“¶è¡Œï¼Œè°å°±è¦æ”¯ä»˜ç»™é“¶è¡Œä¸€å®šçš„è´¹ç”¨ã€‚</p>
<p>å¦‚æœå€Ÿæ¬¾äººå‘ç°ï¼Œè‡ªå·±çš„å­˜æ¬¾æ²¡æœ‰åˆ©æ¯ï¼Œå…¨ç¤¾ä¼šçš„æ— é£é™©åˆ©ç‡éƒ½æ¥è¿‘äºé›¶ï¼Œä¼ä¸šä¸æ„¿æ„å»æŠ•èµ„ï¼Œç¤¾ä¼šGDPå¢é€ŸåŸåœ°è¸æ­¥ï¼Œè‡ªå·±åè€Œè¦æ‰¿æ‹…4.9%çš„åˆ©ç‡ï¼Œé‚£è¿™ç§è´Ÿæ‹…ï¼Œç»å¯¹æ˜¯å‹åŠ›å±±å¤§ï¼Œä¸å¯æ‰¿å—çš„ã€‚</p>
<p>ç­‰åˆ°é‚£ä¸ªæ—¶å€™ï¼Œåˆ«è¯´å¥¢æœ›æˆ¿ä»·ä¸Šæ¶¨æˆä¸ºäº†ç™½æ—¥æ¢¦ï¼Œæ¯å¹´ä¸‹è·Œ2-10%ï¼Œéƒ½æ˜¯å¾ˆæœ‰å¯èƒ½çš„ï¼Œç»“æœè¿˜è¦å‡­ç©ºæ‰¿æ‹…-4.9%çš„åˆ©ç‡äºæŸï¼Œå‚»å­éƒ½çŸ¥é“ï¼Œåº”è¯¥æŠ›å¼ƒæˆ¿å­ï¼Œç›´æ¥æ–­ä¾›ã€‚</p>
<p>å¦‚æœå¤§æ‰¹é‡çš„ä¹°æˆ¿äººï¼Œé›†ä½“æ–­ä¾›ï¼Œæœ€ç»ˆä¼šå¼•å‘ä»€ä¹ˆåæœå‘¢ï¼Ÿé‚£å°±æ˜¯2008å¹´ç¾å›½æ¬¡è´·å±æœºçš„ç¿»ç‰ˆï¼Œé“¶è¡Œå°†å€’é—­ï¼Œç»æµç»§ç»­è§æ¡ï¼Œå¹´è½»äººå¤±ä¸šã€‚é‚£ç§åæœä¸æ˜¯æ¯ä¸ªç¤¾ä¼šéƒ½èƒ½æ‰¿å—çš„ã€‚</p>
<p>å¯¹äºé‚£äº›åœ¨2020å¹´ï¼Œå°±é€‰æ‹©äº†ã€ŒLPRåˆ©ç‡+åŸºç‚¹åŠ æˆã€æ¨¡å¼çš„ä¹°æˆ¿äººè€Œè¨€ï¼Œä¼šå¼ ç¯ç»“å½©ã€æ•²é”£æ‰“é¼“åœ°è¿æ¥ä½åˆ©ç‡æ—¶ä»£ã€ç”šè‡³æ˜¯è´Ÿåˆ©ç‡æ—¶ä»£çš„åˆ°æ¥ã€‚</p>
<p>ç†æƒ³æƒ…å†µä¸‹ï¼Œå‡å¦‚5å¹´æœŸLPRåˆ©ç‡é™ä½åˆ°äº†é›¶ï¼Œé‚£ä¹ˆå½“åˆçš„ä¹°æˆ¿äººæ‰¿æ‹…çš„åˆ©ç‡å°±åªæ˜¯å½“åˆçš„ã€ŒåŸºç‚¹åŠ æˆã€ï¼Œæ— è®ºæ˜¯ä¸Šæµ®è¿˜æ˜¯ä¸‹æµ®ï¼Œéƒ½å¯ä»¥è®¤ä¸ºè½»å¦‚é¸¿æ¯›ã€‚</p>
<p>è¿™ä¸ªæ—¶å€™ï¼ŒåŸæœ‰ä¼ ç»Ÿæ¨¡å¼ä¹°æˆ¿äººï¼Œæ‰¿æ‹…çš„åˆ©ç‡æ˜¯4.90%ï¼Œæ¥å—äº†æ–°æ¨¡å¼çš„ä¹°æˆ¿äººï¼Œå‡ ä¹æ²¡æœ‰æˆ¿è´·åˆ©ç‡ï¼</p>
<p>å¹´åŒ–4.90%åˆ©ç‡çš„å·®åˆ«ï¼Œå¦‚æœæˆ¿è´·ä½™é¢è¿˜å‰©ä¸‹200ä¸‡ï¼Œé‚£å°±æ˜¯å¹´åŒ–9.8ä¸‡å…ƒçš„å·®è·ã€‚</p>
<p>è¿™é’±ä¸é¦™å—ï¼Ÿä¸ºä»€ä¹ˆè¦å‡­ç©ºè´¡çŒ®ç»™é“¶è¡Œå‘¢ï¼Ÿ</p>
<h2 id="part-4"><a href="#part-4" class="headerlink" title="part 4"></a>part 4</h2><p>ç«™åœ¨2020å¹´çš„é—¨æ§›ä¸Šï¼Œå¤®è¡Œä¸€çœ¼æ´ç©¿äº†æœªæ¥20å¹´çš„ç»æµè½¨è¿¹ï¼Œå‚è€ƒäº†è¥¿æ–¹å‘è¾¾å›½å®¶çš„æˆç†Ÿç»éªŒï¼Œå¼•å¯¼å„å¤§å•†ä¸šé“¶è¡Œè´·æ¬¾äººï¼Œå’Œå€Ÿæ¬¾äººï¼Œé‡æ–°ç­¾è®¢é”šå®šäºLPRåˆ©ç‡çš„è´·æ¬¾åˆåŒã€‚</p>
<p>è¿™ä¸ä»…æ˜¯ç»™äºˆå€Ÿæ¬¾äººçš„å¤§çº¢åŒ…ï¼Œä¹Ÿæ˜¯ç«™åœ¨å…¨ç¤¾ä¼šçš„è§’åº¦ï¼Œæœªé›¨ç»¸ç¼ªï¼Œå°†æ”¶ç›Šå’Œé£é™©ï¼Œåœ¨å€Ÿæ¬¾äººå’Œè´·æ¬¾æœºæ„ä¹‹é—´åˆ†æ‘Šï¼Œä¿ƒè¿›æ•´ä¸ªç¤¾ä¼šçš„ç¨³å®šè¿è¡Œã€‚</p>
<p>ä½†æ˜¯ï¼Œå¤®è¡Œå‡ºå°çš„æˆ¿è´·æ”¹é©æ–°æ”¿ï¼Œè®©è´·æ¬¾äººå’Œå€Ÿæ¬¾äººé‡æ–°ç­¾è®¢åˆ©ç‡åˆåŒï¼Œå……æ»¡ç€å¤§é‡çš„é‡‘èæœ¯è¯­å’Œæ™¦æ¶©çš„æ¦‚å¿µã€‚</p>
<p>å•†ä¸šé“¶è¡Œçš„ç›®çš„æ˜¯ä¸ºäº†é€åˆ©ã€‚å®ƒä»¬ä½œä¸ºè´·æ¬¾äººï¼Œèµšå–åˆ©æ¯å·®ï¼Œè®©å€Ÿæ¬¾äººæ‰¿æ‹…çš„åˆ©ç‡è¶Šé«˜ï¼Œé“¶è¡Œçš„åˆ©æ¶¦å°±è¶Šé«˜ã€‚<br><img src="/images/other/3.jpg" alt="3"></p>
<p>æ”¶å–æ™ºå•†ç¨çš„æœ€ä½³æ–¹å¼æ˜¯ï¼Œåˆ¶é€ ä¿¡æ¯ä¸å¯¹ç§°ï¼Œåˆ©ç”¨è‡ªå·±çš„ä¿¡æ¯ä¼˜åŠ¿ï¼Œæ¥æ”¶å‰²å¯¹æ–¹ã€‚</p>
<p>å•†ä¸šé“¶è¡Œä¸€å®šä¼šå·§èˆŒå¦‚ç°§ã€å£åè²èŠ±ä¸€èˆ¬ï¼Œæ•…æ„å°†ä¸¤ç§åˆ©ç‡æ¨¡å¼ï¼Œè¯´å¾—å€Ÿæ¬¾äººå¦‚äº‘å±±é›¾é‡Œï¼Œçœ¼å†’é‡‘æ˜Ÿã€‚</p>
<p>ç«™åœ¨é“¶è¡Œçš„è§’åº¦æ¥è¯´ï¼Œå®ƒä»¬å¸Œæœ›å€Ÿæ¬¾äººåƒæ— å¤´è‹è‡ä¸€æ ·ï¼Œè·Ÿç€ä»–ä»¬çš„èŠ‚å¥èµ°ï¼Œä¸çŸ¥ä¸è§‰å°±èººåœ¨ç §æ¿ä¸Šï¼Œæ‘†å¥½äº†å¾…å®°çš„ä½“ä½ã€‚</p>
<p>åªæœ‰æ˜å“¥ï¼Œæƒ¦è®°ç€ä½ çš„é’±åŒ…ã€‚</p>
<p>åƒè¨€ä¸‡è¯­ï¼Œæ±‡æˆä¸€å¥è¯ï¼</p>
<p><code>ä»2020å¹´3æœˆ1æ—¥å¼€å§‹çš„5ä¸ªæœˆæ—¶é—´é‡Œï¼Œå½“é“¶è¡Œè”ç³»ä½ é‡æ–°åå•†æˆ¿è´·åˆ©ç‡æ—¶ï¼Œä¸€å®šè¦åšæŒã€ŒLPRåˆ©ç‡+åŸºç‚¹åŠ æˆã€æ¨¡å¼ï¼Œå¹¶ä¸”åˆ©ç‡ä¸€å¹´è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ã€‚</code></p>
<p>è¿™ä¸ªæœºä¼šï¼Œæ¶‰åŠåˆ°ä½ å®¶åº­æ•°åä¸‡ï¼Œç”šè‡³ä¸Šç™¾ä¸‡çš„èµ„é‡‘ï¼Œæ˜¯ç”¨äºè‡ªå·±ï¼Œè¿˜æ˜¯è´¡çŒ®ç»™é“¶è¡Œã€‚</p>
<p>å¯åƒä¸‡åˆ«é€‰é”™äº†ï¼Œå› ä¸ºå¤®è¡Œåªç»™äº†ä¸€æ¬¡æœºä¼šï¼Œæ²¡æœ‰åæ‚”è¯å¯åƒï¼</p>
<p>æ¥æºï¼šæ˜å“¥åœ¨è·¯ä¸Š</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[kubernetes corednsåŸŸåè§£æ5ç§’è®°å½•]]></title>
      <url>http://team.jiunile.com/blog/2019/12/k8s-coredns-debug.html</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿‘æœŸçº¿ä¸Š <code>k8s</code> æ—¶ä¸æ—¶å°±ä¼šå‡ºç°ä¸€äº›å†…éƒ¨æœåŠ¡é—´çš„è°ƒç”¨è¶…æ—¶é—®é¢˜ï¼Œé€šè¿‡æ—¥å¿—å¯ä»¥å¾—çŸ¥è¶…æ—¶çš„åŸå› éƒ½æ˜¯å‡ºç°åœ¨åŸŸåè§£æä¸Šï¼Œå¹¶ä¸”éƒ½æ˜¯ <code>k8s</code> å†…éƒ¨çš„åŸŸåè§£æè¶…æ—¶ï¼Œäºæ˜¯ç›´æ¥å…ˆå°†å†…éƒ¨åŸŸåæ›¿æ¢æˆ <code>k8s service</code> çš„ IPï¼Œè§‚å¯Ÿä¸€æ®µæ—¶é—´å‘ç°æ²¡æœ‰è¶…æ—¶çš„æƒ…å†µå‘ç”Ÿäº†ï¼Œä½†æ˜¯ç”±äºä½¿ç”¨ <code>service IP</code> ä¸æ˜¯é•¿ä¹…ä¹‹è®¡ï¼Œæ‰€ä»¥è¿˜è¦å»æ‰¾è§£å†³åŠæ³•ã€‚<br><a id="more"></a></p>
<h2 id="å®šä½"><a href="#å®šä½" class="headerlink" title="å®šä½"></a>å®šä½</h2><p>ä¸€å¼€å§‹è¿ç»´åŒäº‹åœ¨è°ƒç”¨æ–¹ pod ä¸­ä½¿ç”¨abå·¥å…·å¯¹ç›®æ ‡æœåŠ¡è¿›è¡Œäº†å¤šæ¬¡å‹æµ‹ï¼Œå¹¶æ²¡æœ‰å‘ç°æœ‰è¶…æ—¶çš„è¯·æ±‚ï¼Œæˆ‘ä»‹å…¥ä¹‹ååˆ†æabè¿™ç±» http å‹æµ‹å·¥å…·åº”è¯¥éƒ½ä¼šæœ‰ dns ç¼“å­˜ï¼Œè€Œæˆ‘ä»¬ä¸»è¦æ˜¯è¦æµ‹è¯• dns æœåŠ¡çš„æ€§èƒ½ï¼Œäºæ˜¯ç›´æ¥åŠ¨æ‰‹æ’¸äº†ä¸€ä¸ªå‹æµ‹å·¥å…·åªåšåŸŸåè§£æï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"flag"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"net"</span></span><br><span class="line">	<span class="string">"sync/atomic"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> host <span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> connections <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> duration <span class="keyword">int64</span></span><br><span class="line"><span class="keyword">var</span> limit <span class="keyword">int64</span></span><br><span class="line"><span class="keyword">var</span> timeoutCount <span class="keyword">int64</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// os.Args = append(os.Args, "-host", "www.baidu.com", "-c", "200", "-d", "30", "-l", "5000")</span></span><br><span class="line"></span><br><span class="line">	flag.StringVar(&amp;host, <span class="string">"host"</span>, <span class="string">""</span>, <span class="string">"Resolve host"</span>)</span><br><span class="line">	flag.IntVar(&amp;connections, <span class="string">"c"</span>, <span class="number">100</span>, <span class="string">"Connections"</span>)</span><br><span class="line">	flag.Int64Var(&amp;duration, <span class="string">"d"</span>, <span class="number">0</span>, <span class="string">"Duration(s)"</span>)</span><br><span class="line">	flag.Int64Var(&amp;limit, <span class="string">"l"</span>, <span class="number">0</span>, <span class="string">"Limit(ms)"</span>)</span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> count <span class="keyword">int64</span> = <span class="number">0</span></span><br><span class="line">	<span class="keyword">var</span> errCount <span class="keyword">int64</span> = <span class="number">0</span></span><br><span class="line">	pool := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, connections)</span><br><span class="line">	exit := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		min <span class="keyword">int64</span> = <span class="number">0</span></span><br><span class="line">		max <span class="keyword">int64</span> = <span class="number">0</span></span><br><span class="line">		sum <span class="keyword">int64</span> = <span class="number">0</span></span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		time.Sleep(time.Second * time.Duration(duration))</span><br><span class="line">		exit &lt;- <span class="literal">true</span></span><br><span class="line">	&#125;()</span><br><span class="line">endD:</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> pool &lt;- <span class="literal">nil</span>:</span><br><span class="line">			<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">				<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">					&lt;-pool</span><br><span class="line">				&#125;()</span><br><span class="line">				resolver := &amp;net.Resolver&#123;&#125;</span><br><span class="line">				now := time.Now()</span><br><span class="line">				_, err := resolver.LookupIPAddr(context.Background(), host)</span><br><span class="line">				use := time.Since(now).Nanoseconds() / <span class="keyword">int64</span>(time.Millisecond)</span><br><span class="line">				<span class="keyword">if</span> min == <span class="number">0</span> || use &lt; min &#123;</span><br><span class="line">					min = use</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> use &gt; max &#123;</span><br><span class="line">					max = use</span><br><span class="line">				&#125;</span><br><span class="line">				sum += use</span><br><span class="line">				<span class="keyword">if</span> limit &gt; <span class="number">0</span> &amp;&amp; use &gt;= limit &#123;</span><br><span class="line">					timeoutCount++</span><br><span class="line">				&#125;</span><br><span class="line">				atomic.AddInt64(&amp;count, <span class="number">1</span>)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					fmt.Println(err.Error())</span><br><span class="line">					atomic.AddInt64(&amp;errCount, <span class="number">1</span>)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;()</span><br><span class="line">		<span class="keyword">case</span> &lt;-exit:</span><br><span class="line">			<span class="keyword">break</span> endD</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"request countï¼š%d\nerror countï¼š%d\n"</span>, count, errCount)</span><br><span class="line">	fmt.Printf(<span class="string">"request timeï¼šmin(%dms) max(%dms) avg(%dms) timeout(%dn)\n"</span>, min, max, sum/count, timeoutCount)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç¼–è¯‘å¥½<a href="http://www.jiunile.com/k8s/ab-dns" target="_blank" rel="external">äºŒè¿›åˆ¶</a>ç¨‹åºç›´æ¥ä¸¢åˆ°å¯¹åº”çš„ pod å®¹å™¨ä¸­è¿›è¡Œå‹æµ‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 200ä¸ªå¹¶å‘,æŒç»­30ç§’</span></span><br><span class="line"></span><br><span class="line">$ ./ab-dns -host &#123;service&#125;.&#123;namespace&#125; -c 200 <span class="_">-d</span> 30</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ¬¡å¯ä»¥å‘ç°æœ€å¤§è€—æ—¶æœ‰5så¤šï¼Œå¤šæ¬¡æµ‹è¯•ç»“æœéƒ½æ˜¯ç±»ä¼¼ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./ab-dns -host s-inno-bpm.inno-ci -c 200 -d 30</span></span><br><span class="line">request countï¼š109061</span><br><span class="line">error countï¼š0</span><br><span class="line">request timeï¼šmin(1ms) max(5082ms) avg(53ms) timeout(0n)</span><br></pre></td></tr></table></figure></p>
<p>è€Œæˆ‘ä»¬å†…éƒ¨æœåŠ¡é—´ HTTP è°ƒç”¨çš„è¶…æ—¶ä¸€èˆ¬éƒ½æ˜¯è®¾ç½®åœ¨3så·¦å³ï¼Œä»¥æ­¤æ¨æ–­å‡ºä¸çº¿ä¸Šçš„è¶…æ—¶æƒ…å†µåº”è¯¥æ˜¯åŒä¸€ç§æƒ…å†µï¼Œåœ¨å¹¶å‘é«˜çš„æƒ…å†µä¸‹ä¼šå‡ºç°éƒ¨åˆ†åŸŸåè§£æè¶…æ—¶è€Œå¯¼è‡´ HTTP è¯·æ±‚å¤±è´¥ã€‚</p>
<h2 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h2><p>èµ·åˆä¸€ç›´ä»¥ä¸ºæ˜¯ <code>coredns</code> çš„é—®é¢˜ï¼Œäºæ˜¯æ‰¾è¿ç»´å‡çº§äº†ä¸‹ <code>coredns</code> ç‰ˆæœ¬å†è¿›è¡Œå‹æµ‹ï¼Œå‘ç°é—®é¢˜è¿˜æ˜¯å­˜åœ¨ï¼Œè¯´æ˜ä¸æ˜¯ç‰ˆæœ¬çš„é—®é¢˜ï¼Œéš¾é“æ˜¯ <code>coredns</code> æœ¬èº«çš„æ€§èƒ½å°±å·®å¯¼è‡´çš„ï¼Ÿæƒ³æƒ³ä¹Ÿä¸å¤ªå¯èƒ½å•Šï¼Œæ‰ 200 çš„å¹¶å‘å°±é¡¶ä¸ä½äº†é‚£æ€§èƒ½ä¹Ÿæœªå…å¤ªå¼±äº†å§ï¼Œç»“åˆä¹‹å‰çš„å‹æµ‹æ•°æ®ï¼Œå¹³å‡å“åº”éƒ½æŒºæ­£å¸¸çš„(53ms)ï¼Œä½†æ˜¯å°±æœ‰ä¸ªåˆ«è¯·æ±‚ä¼šå»¶è¿Ÿï¼Œè€Œä¸”éƒ½æ˜¯ 5 ç§’å·¦å³ï¼Œæ‰€ä»¥å°±åˆå¸¦ç€k8s dns 5sçš„å…³é”®å­—å» google æœäº†ä¸€ä¸‹ï¼Œè¿™ä¸æœä¸çŸ¥é“ä¸€æœå“ä¸€è·³å•Šï¼ŒåŸæ¥æ˜¯ k8s é‡Œçš„ä¸€ä¸ªå¤§å‘å•Š(å…¶å®å’Œ k8s æ²¡æœ‰å¤ªå¤§çš„å…³ç³»ï¼Œåªæ˜¯ k8s å±‚é¢æ²¡æœ‰æä¾›è§£å†³æ–¹æ¡ˆ)ã€‚</p>
<h2 id="5s-è¶…æ—¶åŸå› "><a href="#5s-è¶…æ—¶åŸå› " class="headerlink" title="5s è¶…æ—¶åŸå› "></a>5s è¶…æ—¶åŸå› </h2><p>linux ä¸­ <code>glibc</code> çš„ resolver çš„ç¼ºçœè¶…æ—¶æ—¶é—´æ˜¯ 5sï¼Œè€Œå¯¼è‡´è¶…æ—¶çš„åŸå› æ˜¯å†…æ ¸ <code>conntrack</code> æ¨¡å—çš„ bugã€‚</p>
<blockquote>
<p>Weave works çš„å·¥ç¨‹å¸ˆ Martynas Pumputis å¯¹è¿™ä¸ªé—®é¢˜åšäº†å¾ˆè¯¦ç»†çš„åˆ†æï¼š<a href="https://www.weave.works/blog/racy-conntrack-and-dns-lookup-timeouts" target="_blank" rel="external">https://www.weave.works/blog/racy-conntrack-and-dns-lookup-timeouts</a></p>
</blockquote>
<p>è¿™é‡Œå†å¼•ç”¨ä¸‹ <a href="https://imroc.io/posts/kubernetes/troubleshooting-with-kubernetes-network/" target="_blank" rel="external">https://imroc.io/posts/kubernetes/troubleshooting-with-kubernetes-network/</a> æ–‡ç« ä¸­çš„è§£é‡Šï¼š</p>
<blockquote>
<p>DNS client (glibc æˆ– musl libc) ä¼šå¹¶å‘è¯·æ±‚ A å’Œ AAAA è®°å½•ï¼Œè·Ÿ DNS Server é€šä¿¡è‡ªç„¶ä¼šå…ˆ connect (å»ºç«‹ fd)ï¼Œåé¢è¯·æ±‚æŠ¥æ–‡ä½¿ç”¨è¿™ä¸ª fd æ¥å‘é€ï¼Œç”±äº UDP æ˜¯æ— çŠ¶æ€åè®®ï¼Œ connect æ—¶å¹¶ä¸ä¼šå‘åŒ…ï¼Œä¹Ÿå°±ä¸ä¼šåˆ›å»º conntrack è¡¨é¡¹, è€Œå¹¶å‘è¯·æ±‚çš„ A å’Œ AAAA è®°å½•é»˜è®¤ä½¿ç”¨åŒä¸€ä¸ª fd å‘åŒ…ï¼Œsend æ—¶å„è‡ªå‘çš„åŒ…å®ƒä»¬æº Port ç›¸åŒ(å› ä¸ºç”¨çš„åŒä¸€ä¸ª socket å‘é€)ï¼Œå½“å¹¶å‘å‘åŒ…æ—¶ï¼Œä¸¤ä¸ªåŒ…éƒ½è¿˜æ²¡æœ‰è¢«æ’å…¥ conntrack è¡¨é¡¹ï¼Œæ‰€ä»¥ netfilter ä¼šä¸ºå®ƒä»¬åˆ†åˆ«åˆ›å»º conntrack è¡¨é¡¹ï¼Œè€Œé›†ç¾¤å†…è¯·æ±‚ kube-dns æˆ– coredns éƒ½æ˜¯è®¿é—®çš„ CLUSTER-IPï¼ŒæŠ¥æ–‡æœ€ç»ˆä¼šè¢« DNAT æˆä¸€ä¸ª endpoint çš„ POD IPï¼Œå½“ä¸¤ä¸ªåŒ…æ°å¥½åˆè¢« DNAT æˆåŒä¸€ä¸ª POD IP æ—¶ï¼Œå®ƒä»¬çš„äº”å…ƒç»„å°±ç›¸åŒäº†ï¼Œåœ¨æœ€ç»ˆæ’å…¥çš„æ—¶å€™åé¢é‚£ä¸ªåŒ…å°±ä¼šè¢«ä¸¢æ‰ï¼Œå¦‚æœ dns çš„ pod å‰¯æœ¬åªæœ‰ä¸€ä¸ªå®ä¾‹çš„æƒ…å†µå°±å¾ˆå®¹æ˜“å‘ç”Ÿ(å§‹ç»ˆè¢« DNAT æˆåŒä¸€ä¸ª POD IP)ï¼Œç°è±¡å°±æ˜¯ dns è¯·æ±‚è¶…æ—¶ï¼Œclient é»˜è®¤ç­–ç•¥æ˜¯ç­‰å¾… 5s è‡ªåŠ¨é‡è¯•ï¼Œå¦‚æœé‡è¯•æˆåŠŸï¼Œæˆ‘ä»¬çœ‹åˆ°çš„ç°è±¡å°±æ˜¯ dns è¯·æ±‚æœ‰ 5s çš„å»¶æ—¶ã€‚</p>
</blockquote>
<h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><h3 id="æ–¹æ¡ˆï¼ˆä¸€ï¼‰ï¼šä½¿ç”¨-TCP-åè®®å‘é€-DNS-è¯·æ±‚"><a href="#æ–¹æ¡ˆï¼ˆä¸€ï¼‰ï¼šä½¿ç”¨-TCP-åè®®å‘é€-DNS-è¯·æ±‚" class="headerlink" title="æ–¹æ¡ˆï¼ˆä¸€ï¼‰ï¼šä½¿ç”¨ TCP åè®®å‘é€ DNS è¯·æ±‚"></a>æ–¹æ¡ˆï¼ˆä¸€ï¼‰ï¼šä½¿ç”¨ TCP åè®®å‘é€ DNS è¯·æ±‚</h3><p>é€šè¿‡ <code>resolv.conf</code> çš„ <code>use-vc</code> é€‰é¡¹æ¥å¼€å¯ TCP åè®®, ä¿®æ”¹ <code>/etc/resolv.conf</code> æ–‡ä»¶ï¼Œåœ¨æœ€ååŠ å…¥ä¸€è¡Œæ–‡æœ¬<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver ...</span><br><span class="line">search ...</span><br><span class="line">options ndots:5 use-vc</span><br></pre></td></tr></table></figure></p>
<p>ç»è¿‡æµ‹è¯•ï¼Œç¡®å®æ²¡æœ‰å‡ºç° 5s çš„è¶…æ—¶é—®é¢˜äº†ï¼Œä½†æ˜¯éƒ¨åˆ†è¯·æ±‚è€—æ—¶è¿˜æ˜¯æ¯”è¾ƒé«˜ï¼Œåœ¨ 4s å·¦å³ï¼Œè€Œä¸”å¹³å‡è€—æ—¶æ¯” UPD åè®®çš„è¿˜é«˜ï¼Œæ•ˆæœå¹¶ä¸å¥½ã€‚</p>
<h3 id="æ–¹æ¡ˆï¼ˆäºŒï¼‰ï¼šé¿å…ç›¸åŒäº”å…ƒç»„-DNS-è¯·æ±‚çš„å¹¶å‘"><a href="#æ–¹æ¡ˆï¼ˆäºŒï¼‰ï¼šé¿å…ç›¸åŒäº”å…ƒç»„-DNS-è¯·æ±‚çš„å¹¶å‘" class="headerlink" title="æ–¹æ¡ˆï¼ˆäºŒï¼‰ï¼šé¿å…ç›¸åŒäº”å…ƒç»„ DNS è¯·æ±‚çš„å¹¶å‘"></a>æ–¹æ¡ˆï¼ˆäºŒï¼‰ï¼šé¿å…ç›¸åŒäº”å…ƒç»„ DNS è¯·æ±‚çš„å¹¶å‘</h3><p>é€šè¿‡ <code>resolv.conf</code> çš„ <code>single-request-reopen</code> å’Œ <code>single-request</code> é€‰é¡¹æ¥é¿å…ï¼š</p>
<ul>
<li>single-request-reopen (glibc&gt;=2.9) å‘é€ A ç±»å‹è¯·æ±‚å’Œ AAAA ç±»å‹è¯·æ±‚ä½¿ç”¨ä¸åŒçš„æºç«¯å£ã€‚è¿™æ ·ä¸¤ä¸ªè¯·æ±‚åœ¨ conntrack è¡¨ä¸­ä¸å ç”¨åŒä¸€ä¸ªè¡¨é¡¹ï¼Œä»è€Œé¿å…å†²çªã€‚</li>
<li>single-request (glibc&gt;=2.10) é¿å…å¹¶å‘ï¼Œæ”¹ä¸ºä¸²è¡Œå‘é€ A ç±»å‹å’Œ AAAA ç±»å‹è¯·æ±‚ï¼Œæ²¡æœ‰äº†å¹¶å‘ï¼Œä»è€Œä¹Ÿé¿å…äº†å†²çªã€‚</li>
</ul>
<p>ä¿®æ”¹ /etc/resolv.conf æ–‡ä»¶ï¼Œåœ¨æœ€ååŠ å…¥ä¸€è¡Œæ–‡æœ¬ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver ...</span><br><span class="line">search ...</span><br><span class="line">options ndots:5 timeout:2 single-request-reopen</span><br></pre></td></tr></table></figure></p>
<p>é€šè¿‡å‹æµ‹ç»“æœå¯ä»¥çœ‹åˆ° <code>single-request-reopen</code> å’Œ <code>single-request</code> é€‰é¡¹ç¡®å®å¯ä»¥æ˜¾è‘—çš„é™ä½åŸŸåè§£æè€—æ—¶ã€‚</p>
<h2 id="å…³äºæ–¹æ¡ˆï¼ˆä¸€ï¼‰å’Œæ–¹æ¡ˆï¼ˆäºŒï¼‰çš„å®æ–½æ­¥éª¤å’Œç¼ºç‚¹"><a href="#å…³äºæ–¹æ¡ˆï¼ˆä¸€ï¼‰å’Œæ–¹æ¡ˆï¼ˆäºŒï¼‰çš„å®æ–½æ­¥éª¤å’Œç¼ºç‚¹" class="headerlink" title="å…³äºæ–¹æ¡ˆï¼ˆä¸€ï¼‰å’Œæ–¹æ¡ˆï¼ˆäºŒï¼‰çš„å®æ–½æ­¥éª¤å’Œç¼ºç‚¹"></a>å…³äºæ–¹æ¡ˆï¼ˆä¸€ï¼‰å’Œæ–¹æ¡ˆï¼ˆäºŒï¼‰çš„å®æ–½æ­¥éª¤å’Œç¼ºç‚¹</h2><p>å…¶å®å°±æ˜¯è¦ç»™å®¹å™¨çš„ <code>/etc/resolv.conf</code> æ–‡ä»¶æ·»åŠ é€‰é¡¹ï¼Œç›®å‰æœ‰ä¸¤ä¸ªæ–¹æ¡ˆæ¯”è¾ƒåˆé€‚ï¼š</p>
<ol>
<li><p>é€šè¿‡ä¿®æ”¹ pod çš„ postStart hook æ¥è®¾ç½®</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lifecycle:</span></span><br><span class="line"><span class="attr">  postStart:</span></span><br><span class="line"><span class="attr">    exec:</span></span><br><span class="line"><span class="attr">      command:</span></span><br><span class="line"><span class="bullet">        -</span> /bin/sh</span><br><span class="line"><span class="bullet">        -</span> -c</span><br><span class="line"><span class="bullet">        -</span> <span class="string">"/bin/echo 'options single-request-reopen' &gt;&gt; /etc/resolv.conf"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ä¿®æ”¹ pod çš„ template.spec.dnsConfig æ¥è®¾ç½®</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">template:</span></span><br><span class="line"><span class="attr">  spec:</span></span><br><span class="line"><span class="attr">    dnsConfig:</span></span><br><span class="line"><span class="attr">      options:</span></span><br><span class="line"><span class="attr">        - name:</span> single-request-reopen</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p><code>æ³¨: éœ€è¦ k8s ç‰ˆæœ¬&gt;=1.9</code></p>
</blockquote>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><p>ä¸æ”¯æŒ <code>alpine</code> åŸºç¡€é•œåƒçš„å®¹å™¨ï¼Œå› ä¸º <code>apline</code> åº•å±‚ä½¿ç”¨çš„ <code>musl libc</code> åº“å¹¶ä¸æ”¯æŒè¿™äº› <code>resolv.conf</code> é€‰é¡¹ï¼Œæ‰€ä»¥å¦‚æœä½¿ç”¨ <code>alpine</code> åŸºç¡€é•œåƒæ„å»ºçš„åº”ç”¨ï¼Œè¿˜æ˜¯æ— æ³•è§„é¿è¶…æ—¶çš„é—®é¢˜ã€‚</p>
<h2 id="æ–¹æ¡ˆï¼ˆä¸‰ï¼‰ï¼šæœ¬åœ°-DNS-ç¼“å­˜"><a href="#æ–¹æ¡ˆï¼ˆä¸‰ï¼‰ï¼šæœ¬åœ°-DNS-ç¼“å­˜" class="headerlink" title="æ–¹æ¡ˆï¼ˆä¸‰ï¼‰ï¼šæœ¬åœ° DNS ç¼“å­˜"></a>æ–¹æ¡ˆï¼ˆä¸‰ï¼‰ï¼šæœ¬åœ° DNS ç¼“å­˜</h2><p>å…¶å® k8s å®˜æ–¹ä¹Ÿæ„è¯†åˆ°äº†è¿™ä¸ªé—®é¢˜æ¯”è¾ƒå¸¸è§ï¼Œç»™å‡ºäº† coredns ä»¥ cache æ¨¡å¼ä½œä¸º daemonset éƒ¨ç½²çš„è§£å†³æ–¹æ¡ˆ: <a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns/nodelocaldns" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns/nodelocaldns</a></p>
<p>å¤§æ¦‚åŸç†å°±æ˜¯ï¼š</p>
<blockquote>
<p>æœ¬åœ° DNS ç¼“å­˜ä»¥ DaemonSet æ–¹å¼åœ¨æ¯ä¸ªèŠ‚ç‚¹éƒ¨ç½²ä¸€ä¸ªä½¿ç”¨ hostNetwork çš„ Podï¼Œåˆ›å»ºä¸€ä¸ªç½‘å¡ç»‘ä¸Šæœ¬åœ° DNS çš„ IPï¼Œæœ¬æœºçš„ Pod çš„ DNS è¯·æ±‚è·¯ç”±åˆ°æœ¬åœ° DNSï¼Œç„¶åå–ç¼“å­˜æˆ–è€…ç»§ç»­ä½¿ç”¨ TCP è¯·æ±‚ä¸Šæ¸¸é›†ç¾¤ DNS è§£æ (ç”±äºä½¿ç”¨ TCPï¼ŒåŒä¸€ä¸ª socket åªä¼šåšä¸€éä¸‰æ¬¡æ¡æ‰‹ï¼Œä¸å­˜åœ¨å¹¶å‘åˆ›å»º conntrack è¡¨é¡¹ï¼Œä¹Ÿå°±ä¸ä¼šæœ‰ conntrack å†²çª)</p>
</blockquote>
<h3 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h3><ol>
<li><p>è·å–å½“å‰ <code>kube-dns service</code> çš„ <code>clusterIP</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n kube-system get svc kube-dns -o jsonpath=<span class="string">"&#123;.spec.clusterIP&#125;"</span></span><br><span class="line"></span><br><span class="line">10.96.0.10</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸‹è½½å®˜æ–¹æä¾›çš„ yaml æ¨¡æ¿è¿›è¡Œå…³é”®å­—æ›¿æ¢</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ wget -O nodelocaldns.yaml <span class="string">"https://github.com/kubernetes/kubernetes/raw/master/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml"</span> &amp;&amp; \</span><br><span class="line">$ sed -i <span class="string">'s/__PILLAR__DNS__SERVER__/10.96.0.10/g'</span> nodelocaldns.yaml &amp;&amp; \</span><br><span class="line">$ sed -i <span class="string">'s/__PILLAR__LOCAL__DNS__/169.254.20.10/g'</span> nodelocaldns.yaml &amp;&amp; \</span><br><span class="line">$ sed -i <span class="string">'s/__PILLAR__DNS__DOMAIN__/cluster.local/g'</span> nodelocaldns.yaml &amp;&amp; \</span><br><span class="line">$ sed -i <span class="string">'s/__PILLAR__CLUSTER__DNS__/10.96.0.10/g'</span> nodelocaldns.yaml &amp;&amp; \</span><br><span class="line">$ sed -i <span class="string">'s/__PILLAR__UPSTREAM__SERVERS__/\/etc\/resolv.conf/g'</span> nodelocaldns.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>æœ€ç»ˆ yaml æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> ServiceAccount</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> node-local-dns</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Service</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> kube-dns-upstream</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> kube-dns</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/name: <span class="string">"KubeDNSUpstream"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - name:</span> dns</span><br><span class="line"><span class="attr">      port:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">      protocol:</span> UDP</span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">    - name:</span> dns-tcp</span><br><span class="line"><span class="attr">      port:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">      protocol:</span> TCP</span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> kube-dns</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> ConfigMap</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> node-local-dns</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  Corefile:</span> <span class="string">|</span><br><span class="line">    cluster.local:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        cache &#123;</span><br><span class="line">                success 9984 30</span><br><span class="line">                denial 9984 5</span><br><span class="line">        &#125;</span><br><span class="line">        reload</span><br><span class="line">        loop</span><br><span class="line">        bind 169.254.20.10 10.96.0.10</span><br><span class="line">        forward . 10.96.0.10 &#123;</span><br><span class="line">                force_tcp</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9253</span><br><span class="line">        health 169.254.20.10:8080</span><br><span class="line">        &#125;</span><br><span class="line">    in-addr.arpa:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        cache 30</span><br><span class="line">        reload</span><br><span class="line">        loop</span><br><span class="line">        bind 169.254.20.10 10.96.0.10</span><br><span class="line">        forward . 10.96.0.10 &#123;</span><br><span class="line">                force_tcp</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9253</span><br><span class="line">        &#125;</span><br><span class="line">    ip6.arpa:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        cache 30</span><br><span class="line">        reload</span><br><span class="line">        loop</span><br><span class="line">        bind 169.254.20.10 10.96.0.10</span><br><span class="line">        forward . 10.96.0.10 &#123;</span><br><span class="line">                force_tcp</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9253</span><br><span class="line">        &#125;</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        cache 30</span><br><span class="line">        reload</span><br><span class="line">        loop</span><br><span class="line">        bind 169.254.20.10 10.96.0.10</span><br><span class="line">        forward . /etc/resolv.conf &#123;</span><br><span class="line">                force_tcp</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9253</span><br><span class="line">        &#125;</span><br><span class="line">---</span><br><span class="line"></span><span class="attr">apiVersion:</span> apps/v1</span><br><span class="line"><span class="attr">kind:</span> DaemonSet</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> node-local-dns</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> node-local-dns</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  updateStrategy:</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">10</span>%</span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> node-local-dns</span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> node-local-dns</span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      priorityClassName:</span> system-node-critical</span><br><span class="line"><span class="attr">      serviceAccountName:</span> node-local-dns</span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> Default <span class="comment"># Don't use cluster DNS.</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">"CriticalAddonsOnly"</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">"Exists"</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> node-cache</span><br><span class="line"><span class="attr">          image:</span> k8s.gcr.io/k8s-dns-node-cache:<span class="number">1.15</span><span class="number">.7</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="number">25</span>m</span><br><span class="line"><span class="attr">              memory:</span> <span class="number">5</span>Mi</span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line">            [</span><br><span class="line">              <span class="string">"-localip"</span>,</span><br><span class="line">              <span class="string">"169.254.20.10,10.96.0.10"</span>,</span><br><span class="line">              <span class="string">"-conf"</span>,</span><br><span class="line">              <span class="string">"/etc/Corefile"</span>,</span><br><span class="line">              <span class="string">"-upstreamsvc"</span>,</span><br><span class="line">              <span class="string">"kube-dns-upstream"</span>,</span><br><span class="line">            ]</span><br><span class="line"><span class="attr">          securityContext:</span></span><br><span class="line"><span class="attr">            privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">              name:</span> dns</span><br><span class="line"><span class="attr">              protocol:</span> UDP</span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">              name:</span> dns-tcp</span><br><span class="line"><span class="attr">              protocol:</span> TCP</span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">9253</span></span><br><span class="line"><span class="attr">              name:</span> metrics</span><br><span class="line"><span class="attr">              protocol:</span> TCP</span><br><span class="line"><span class="attr">          livenessProbe:</span></span><br><span class="line"><span class="attr">            httpGet:</span></span><br><span class="line"><span class="attr">              host:</span> <span class="number">169.254</span><span class="number">.20</span><span class="number">.10</span></span><br><span class="line"><span class="attr">              path:</span> /health</span><br><span class="line"><span class="attr">              port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">            initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">            timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - mountPath:</span> /run/xtables.lock</span><br><span class="line"><span class="attr">              name:</span> xtables-lock</span><br><span class="line"><span class="attr">              readOnly:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">            - name:</span> config-volume</span><br><span class="line"><span class="attr">              mountPath:</span> /etc/coredns</span><br><span class="line"><span class="attr">            - name:</span> kube-dns-config</span><br><span class="line"><span class="attr">              mountPath:</span> /etc/kube-dns</span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> xtables-lock</span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> /run/xtables.lock</span><br><span class="line"><span class="attr">            type:</span> FileOrCreate</span><br><span class="line"><span class="attr">        - name:</span> kube-dns-config</span><br><span class="line"><span class="attr">          configMap:</span></span><br><span class="line"><span class="attr">            name:</span> kube-dns</span><br><span class="line"><span class="attr">            optional:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        - name:</span> config-volume</span><br><span class="line"><span class="attr">          configMap:</span></span><br><span class="line"><span class="attr">            name:</span> node-local-dns</span><br><span class="line"><span class="attr">            items:</span></span><br><span class="line"><span class="attr">              - key:</span> Corefile</span><br><span class="line"><span class="attr">                path:</span> Corefile.base</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>é€šè¿‡ yaml å¯ä»¥çœ‹åˆ°å‡ ä¸ªç»†èŠ‚ï¼š</p>
<ol>
<li>éƒ¨ç½²ç±»å‹æ˜¯ä½¿ç”¨çš„ <code>DaemonSet</code>ï¼Œå³åœ¨æ¯ä¸ª <code>k8s node</code> èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª dns æœåŠ¡</li>
<li><code>hostNetwork</code> å±æ€§ä¸º <code>true</code>ï¼Œå³ç›´æ¥ä½¿ç”¨ node ç‰©ç†æœºçš„ç½‘å¡è¿›è¡Œç«¯å£ç»‘å®šï¼Œè¿™æ ·åœ¨æ­¤ node èŠ‚ç‚¹ä¸­çš„ pod å¯ä»¥ç›´æ¥è®¿é—® dns æœåŠ¡ï¼Œä¸é€šè¿‡ service è¿›è¡Œè½¬å‘ï¼Œä¹Ÿå°±ä¸ä¼šæœ‰ DNAT</li>
<li><code>dnsPolicy</code> å±æ€§ä¸º <code>Default</code>ï¼Œä¸ä½¿ç”¨ <code>cluster DNS</code>ï¼Œåœ¨è§£æå¤–ç½‘åŸŸåæ—¶ç›´æ¥ä½¿ç”¨æœ¬åœ°çš„ DNS è®¾ç½®</li>
<li>ç»‘å®šåœ¨ node èŠ‚ç‚¹ <code>169.254.20.10</code> å’Œ <code>10.96.0.10</code> IP ä¸Šï¼Œè¿™æ ·èŠ‚ç‚¹ä¸‹é¢çš„ pod åªéœ€è¦å°† dns è®¾ç½®ä¸º<code>169.254.20.10</code> å³å¯ç›´æ¥è®¿é—®å®¿ä¸»æœºä¸Šçš„ dns æœåŠ¡ã€‚</li>
</ol>
<h3 id="å®æ–½"><a href="#å®æ–½" class="headerlink" title="å®æ–½"></a>å®æ–½</h3><ol>
<li><p>é€šè¿‡ä¿®æ”¹ <code>pod</code> çš„ <code>template.spec.dnsConfig</code> æ¥è®¾ç½®ï¼Œå¹¶å°† <code>dnsPolicy</code> è®¾ç½®ä¸º <code>None</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">template:</span></span><br><span class="line"><span class="attr">  spec:</span></span><br><span class="line"><span class="attr">    dnsConfig:</span></span><br><span class="line">	  nameservers:</span><br><span class="line"><span class="bullet">        -</span> <span class="number">169.254</span><span class="number">.20</span><span class="number">.10</span></span><br><span class="line"><span class="attr">      searches:</span></span><br><span class="line"><span class="bullet">        -</span> public.svc.cluster.local</span><br><span class="line">		- svc.cluster.local</span><br><span class="line">		- cluster.local</span><br><span class="line"><span class="attr">      options:</span></span><br><span class="line"><span class="attr">        - name:</span> ndots</span><br><span class="line"><span class="attr">          value:</span> <span class="string">"5"</span></span><br><span class="line"><span class="attr">    dnsPolicy:</span> None</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹é»˜è®¤çš„ cluster-dnsï¼Œåœ¨ node èŠ‚ç‚¹ä¸Šå°† <code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> æ–‡ä»¶ä¸­çš„ <code>--cluster-dns</code> å‚æ•°å€¼ä¿®æ”¹ä¸º <code>169.254.20.10</code>ï¼Œç„¶åé‡å¯ <code>kubelet</code>ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>å‚è€ƒï¼š</p>
<ul>
<li>monkeywie.github.io</li>
<li>imroc.io</li>
</ul>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ç™½è¯Kubernetesæ ¸å¿ƒç»„ä»¶åŠåŸç†]]></title>
      <url>http://team.jiunile.com/blog/2019/12/k8s-k8s-intro.html</url>
      <content type="html"><![CDATA[<h2 id="Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ"></a>Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>Kuberneteså…¶å®å°±æ˜¯ä¸€ä¸ªé›†ç¾¤ï¼Œä»æˆ‘ä»¬æ­¤å‰è¿ç»´çš„è§’åº¦æ¥ç†è§£ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªé›†ç¾¤ï¼Œç»„åˆå¤šå°ä¸»æœºçš„èµ„æºï¼ˆå†…å­˜ã€CPUã€ç£ç›˜ç­‰ï¼‰æ•´åˆæˆä¸€ä¸ªå¤§çš„èµ„æºæ± å¹¶ç»Ÿä¸€å¯¹å¤–æä¾›è®¡ç®—å­˜å‚¨ç­‰èƒ½åŠ›çš„é›†ç¾¤ã€‚æˆ‘ä»¬æ‰¾å¾ˆå¤šå°ä¸»æœºï¼Œæ¯å°ä¸»æœºä¸Šé¢å®‰è£…Kubernetesçš„ç›¸å…³ç¨‹åºï¼Œè€Œä¸åŒçš„ä¸»æœºç¨‹åºä¹‹é—´ç›¸äº’é€šä¿¡ï¼Œä»è€Œå®Œæˆå½¼æ­¤ä¹‹é—´çš„åè°ƒï¼Œå¹¶ä¸”é€šè¿‡è¿™äº›åº”ç”¨ç¨‹åºä¹‹é—´çš„ååŒå·¥ä½œï¼ŒæŠŠå¤šä¸ªä¸»æœºå½“æˆä¸€ä¸ªä¸»æœºæ¥ä½¿ç”¨ï¼Œå½¢æˆä¸€ä¸ªé›†ç¾¤ï¼Œä»…æ­¤è€Œå·²ï¼Œä½†æ˜¯åœ¨kubernetesé›†ç¾¤å½“ä¸­ä¸»æœºæ˜¯åˆ†è§’è‰²çš„ï¼Œå³æ‰€è°“çš„æœ‰ä¸­å¿ƒç»“ç‚¹æ¶æ„çš„é›†ç¾¤ç³»ç»Ÿï¼Œmaster/nodesæ¨¡å‹, ç”±ä¸€ç»„èŠ‚ç‚¹ç”¨äºmasterä¸éœ€è¦å¤ªå¤šï¼Œä¸€èˆ¬é«˜å¯ç”¨çš„è¯éœ€è¦ä¸‰ä¸ªï¼ˆæ ¹æ®é›†ç¾¤è§„æ¨¡æ¥åˆ¤æ–­ï¼‰ï¼ŒnodesèŠ‚ç‚¹ï¼ˆworkerèŠ‚ç‚¹ï¼‰å°±æ˜¯å¹²æ´»çš„ï¼ŒKubernetesä¸Šæä¾›çš„å„ç§èµ„æºæœåŠ¡ï¼Œè¿è¡Œåœ¨nodeèŠ‚ç‚¹ä¸Šé¢ã€‚<br><a id="more"></a></p>
<h2 id="ç”¨æˆ·å¦‚ä½•åœ¨kubernetesè¿è¡Œå®¹å™¨ï¼Œé€»è¾‘è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ç”¨æˆ·å¦‚ä½•åœ¨kubernetesè¿è¡Œå®¹å™¨ï¼Œé€»è¾‘è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ç”¨æˆ·å¦‚ä½•åœ¨kubernetesè¿è¡Œå®¹å™¨ï¼Œé€»è¾‘è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ"></a>ç”¨æˆ·å¦‚ä½•åœ¨kubernetesè¿è¡Œå®¹å™¨ï¼Œé€»è¾‘è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>ç”¨æˆ·æŠŠåˆ›å»ºå¯åŠ¨å®¹å™¨çš„è¯·æ±‚é¦–å…ˆå‘ç»™masterï¼Œå…·ä½“æ¥è¯´æ˜¯å‘ç»™äº†masterèŠ‚ç‚¹ä¸Šé¢çš„<code>API Server</code>ç»„ä»¶ï¼Œ <code>API Server</code>é€šè¿‡è°ƒåº¦å™¨ï¼ŒæŒ‰ç…§é¢„è®¾çš„è°ƒåº¦ç®—æ³•åŠç­–ç•¥ï¼Œå»åˆ†æå„nodeèŠ‚ç‚¹ä¸Šé¢ç°æœ‰çš„å¯ç”¨èµ„æºçŠ¶æ€ï¼Œç„¶åæ‰¾ä¸€ä¸ªæœ€ä½³é€‚é…ï¼Œæ¥è¿è¡Œç”¨æˆ·æ‰€è¯·æ±‚å®¹å™¨çš„ç»“ç‚¹ï¼Œå¹¶æŠŠå®ƒè°ƒåº¦ä¸Šå»ï¼ˆè¿™é‡Œéœ€è¦ä¸nodeèŠ‚ç‚¹ä¸Šé¢çš„<code>kubelet</code>äº¤äº’ï¼‰ï¼Œå¹¶ç”±è¿™ä¸ªnodeèŠ‚ç‚¹ä¸Šé¢æœ¬åœ°çš„dockeræˆ–å…¶å®ƒå®¹å™¨å¼•æ“è´Ÿè´£æŠŠè¿™ä¸ªå®¹å™¨å¯åŠ¨èµ·æ¥ï¼Œè¦å¯åŠ¨å®¹å™¨ï¼Œéœ€è¦æœ‰é•œåƒï¼Œé•œåƒåœ¨å“ªé‡Œå‘¢ï¼Ÿåœ¨ä»“åº“ä¸Šé¢ï¼Œnodeä¸Šé¢å¯åŠ¨å®¹å™¨æ˜¯ä¼šå…ˆæ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰é•œåƒï¼ˆæ ¹æ®é•œåƒæ‹‰å–ç­–ç•¥ï¼‰ï¼Œå¦‚æœæ²¡æœ‰ä¼šdocker pullä¸‹æ¥ï¼Œç„¶åå†å¯åŠ¨ï¼Œkubernetesè‡ªèº«å¹¶æ²¡æœ‰æ‰˜ç®¡è‡ªåŠ¨æ‰€ä¾èµ–çš„æ¯ä¸€ä¸ªå®¹å™¨é•œåƒï¼Œè€Œæ˜¯éœ€è¦åˆ°ä»“åº“ä¸­å»ä¸‹è½½çš„ï¼Œä»“åº“å¯ä»¥æ˜¯ç§æœ‰çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¬æœ‰çš„ã€‚</p>
<p>é›†ç¾¤åœ¨masterèŠ‚ç‚¹ä¸Šé¢æä¾›ä¸€ä¸ª<code>API Server</code>ç»„ä»¶ï¼Œå®ƒè´Ÿè´£æ¥å—è¯·æ±‚ï¼Œè§£æè¯·æ±‚ï¼Œå¤„ç†è¯·æ±‚çš„ï¼Œè‡³äºå½“ç”¨æˆ·è¯·æ±‚çš„æ˜¯åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œæœ€å¥½ä¸è¦è¿è¡Œåœ¨masterèŠ‚ç‚¹ä¸Šé¢ï¼Œè€Œåº”è¯¥è¿è¡Œåœ¨nodeèŠ‚ç‚¹ä¸Šé¢ï¼Œç¡®å®šå“ªä¸ªnodeæ›´åˆé€‚ï¼Œè¿™ä¸ªæ—¶é—´å°±éœ€è¦<code>scheder</code>è°ƒåº¦å™¨ï¼Œå®ƒè´Ÿè´£ç›‘æ§æ¯ä¸ªnodeèŠ‚ç‚¹ä¸Šé¢æ€»å¯ç”¨çš„è®¡ç®—ã€å†…å­˜ã€å­˜å‚¨ç­‰èµ„æºï¼Œå¹¶æ ¹æ®ç”¨æˆ·æ‰€è¯·æ±‚åˆ›å»ºçš„è¿™ä¸ªå®¹å™¨æ‰€éœ€è¦çš„èµ„æºï¼Œdockerå®¹å™¨å¯ä»¥åšèµ„æºé™åˆ¶ ï¼Œä½†åœ¨kubernetesä¸Šé¢ä¸ä½†å¯ä»¥è®¾å®šå®¹å™¨ä½¿ç”¨èµ„æºçš„ä¸Šé™ï¼ˆé˜€å€¼ï¼‰ï¼Œè¿˜å¯ä»¥è®¾å®šèµ„æºä½¿ç”¨çš„ä¸‹é™ï¼ˆèµ„æºè¯·æ±‚é‡ï¼‰ï¼Œè°ƒåº¦å™¨å°±æ˜¯æ ¹æ®å®¹å™¨çš„æœ€ä½éœ€æ±‚æ¥è¿›è¡Œè¯„ä¼°ï¼Œå“ªä¸€ä¸ªèŠ‚ç‚¹æœ€åˆé€‚ï¼›å½“ç„¶äº†ï¼Œèµ„æºçš„è¯„ä¼°ä¸åªæ˜¯ä¸€ä¸ªç»´åº¦ï¼Œè€Œæ˜¯ä»å¤šä¸ªç»´åº¦è€ƒè™‘ï¼Œè¿™éƒ½æ˜¯è°ƒåº¦å™¨<code>scheduler</code>æ ¹æ®è°ƒåº¦ç­–ç•¥å’Œç®—æ³•éœ€è¦è€ƒè™‘çš„ï¼Œå¦‚æœåœ¨ä¸€ä¸ªnodeä¸Šé¢æŠŠå®¹å™¨å¯åŠ¨èµ·æ¥äº†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹å®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºçš„å¥åº·çŠ¶æ€åšç›‘æµ‹ï¼Œæˆ‘ä»¬ä¸ä½†èƒ½æ ¹æ®å®¹å™¨ä¸­åº”ç”¨ç¨‹åºæ˜¯å¦è¿è¡Œåˆ¤æ–­å®ƒçš„å¥åº·çŠ¶å†µï¼Œè¿˜å¯ä»¥æ ¹æ®é¢å¤–çš„å¥åº·çŠ¶æ€æ¢æµ‹æ–¹å¼æ¥æ¢æµ‹ï¼Œæˆ‘ä»¬å«åšå¯ç”¨æ€§æ¢æµ‹æœºåˆ¶æ¥æ¢æµ‹æœåŠ¡çš„å¯ç”¨æ€§ã€‚å¦‚æœä¸€æ—¦å®¹å™¨ä¸­çš„åº”ç”¨æŒ‚äº†ï¼Œæˆ‘ä»¬åˆéœ€è¦ç¡®ä¿å®¹å™¨ä¸­çš„ä¸€ä¸ªå®¹å™¨è¦è¿è¡Œï¼Œæ­¤æ—¶æ€ä¹ˆåŠï¼ŸnodeèŠ‚ç‚¹ä¹‹ä¸Šæœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºå°±æ˜¯<code>kebulet</code>ï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºç¡®ä¿å®¹å™¨å§‹ç»ˆå¤„äºå¥åº·çŠ¶æ€ï¼Œå¦‚æœå‡ºç°é—®é¢˜ï¼Œå®ƒå°±ä¼šé€šçŸ¥<code>API Server</code>ï¼Œç„¶åé‡æ–°è°ƒåº¦ï¼›ä½†æ˜¯æœ‰ä¸€ç‚¹ï¼Œå¾ˆä¸å¹¸ï¼Œè¿™ä¸ªnodeèŠ‚ç‚¹å¦‚æœå®•æœºäº†ï¼Œé‚£ä¹ˆæ­¤å‰æ‹–ç®¡åœ¨æ­¤nodeä¸Šé¢çš„æ‰€æœ‰å®¹å™¨å°±æŒ‚äº†ï¼Œæˆ‘ä»¬çŸ¥é“kuberneteså…·æœ‰è‡ªæ„ˆçš„èƒ½åŠ›ï¼Œæ— è®ºæ˜¯å•ä¸ªå®¹å™¨ï¼Œè¿˜æ˜¯nodeèŠ‚ç‚¹ä¸Šé¢çš„æ‰€æœ‰å®¹å™¨ï¼Œä¸€æ—¦å®¹å™¨ä¸è§äº†ï¼Œæ˜¯ä¸éœ€è¦äººå·¥å‚ä¸çš„ï¼Œkubernetesä¼šä½¿ç”¨æ–°çš„ä¸ªä½“æ¥å–ä»£å®ƒï¼Œå®ƒä¼šåœ¨å…¶å®ƒnodeä¸Šé¢åˆ›å»ºå‡ºæ¥ä¸€æ¨¡ä¸€æ ·çš„å®¹å™¨å‡ºæ¥ã€‚å¦‚ä½•ç¡®ä¿è¿™ä¸ªå®¹å™¨æ˜¯å¥åº·çš„å‘¢ï¼Ÿä»¥åŠä¸€æ—¦å‡ºé—®é¢˜å°±å¯ä»¥åŠæ—¶è¢«å‘ç°å‘¢? å…¶å®kubernetesæ˜¯é€šè¿‡æ§åˆ¶å™¨ç»„ä»¶æ¥è´Ÿè´£ç›‘æ§å®ƒæ‰€ç®¡ç†çš„æ¯ä¸€ä¸ªå®¹å™¨çš„å¥åº·çŠ¶æ€ï¼Œä¸€æ—¦å‘ç°ä¸å¥åº·äº†ï¼Œæ§åˆ¶å™¨å‘masterä¸Šé¢ <code>API server</code>å‘è¯·æ±‚ï¼Œå®¹å™¨æŒ‚äº†ä¸€ä¸ªï¼Œä½ å¸®æˆ‘é‡æ–°è°ƒåº¦å†å¯åŠ¨ä¸€ä¸ªï¼Œè¿™é‡Œæ§åˆ¶å™¨éœ€è¦åœ¨æœ¬åœ°ä¸åœçš„loopå¾ªç¯ï¼Œå‘¨æœŸæ€§ï¼ŒæŒç»­æ€§çš„æ¢æµ‹æ‰€ç®¡ç†çš„å®¹å™¨çš„å¥åº·çŠ¶å†µï¼Œä¸€æ—¦ä¸å¥åº·ï¼Œæˆ–è€…ä¸ç¬¦åˆç”¨æˆ·æ‰€å®šä¹‰ï¼ˆæœŸæœ›ï¼‰çš„ç›®æ ‡ï¼Œæ­¤æ˜¯è°ƒåº¦å™¨å°±ä¼šå‘ç”¨æˆ·æœŸå¾…çš„çŠ¶æ€å‘å‰ç§»ï¼Œç¡®ä¿ç¬¦åˆç”¨æˆ·æœŸæœ›çš„çŠ¶æ€ï¼›å…¶å®åœ¨kubernetesé›†ç¾¤ä¸­æˆ‘ä»¬æœ‰å¾ˆå¤šå¾ˆå¤šçš„æ§åˆ¶å™¨ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ§åˆ¶å™¨æŒ‚äº†å‘¢ï¼Œç”¨äºç›‘æ§å®¹å™¨å¥åº·çš„æ§åˆ¶å™¨ä¸å¥åº·äº†ï¼Œå®¹å™¨çš„å¥åº·çŠ¶æ€å°±æ— æ³•ä¿è¯ï¼Œæ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬åœ¨masterèŠ‚ç‚¹ä¸Šé¢æœ‰ä¸€ä¸ªæ§åˆ¶å™¨ç®¡ç†å™¨ï¼Œæ§åˆ¶å™¨ç®¡ç†å™¨è´Ÿè´£æ§åˆ¶ç›‘æ§æ¯ä¸ªæ§åˆ¶å™¨çš„å¥åº·çŠ¶å†µï¼Œæ§åˆ¶å™¨ç®¡ç†å™¨å¦‚æœå‡ºç°é—®é¢˜æ€ä¹ˆåŠï¼Œå› æ­¤åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ§åˆ¶å™¨ç®¡ç†å™¨åšå†—ä½™ã€‚</p>
<p>ä»¥ä¸Šæˆ‘ä»¬é€šè¿‡åœ¨é›†ç¾¤ä¸Šé¢åˆ›å»ºä¸€ä¸ªå®¹å™¨çš„ä¾‹å­ï¼Œè®²è§£äº†<code>API Server</code>ã€<code>scheduler</code>ã€<code>æ§åˆ¶å™¨</code>ã€<code>æ§åˆ¶ç®¡ç†å™¨</code>ç­‰ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯Podï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯Podï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯Podï¼Ÿ"></a>ä»€ä¹ˆæ˜¯Podï¼Ÿ</h2><p>Podï¼Œè‹±æ–‡æ„æ€æ˜¯è±†èšã€‚å¤§å®¶éƒ½çŸ¥é“è¿™ç§æ¤ç‰©ï¼Œä¸€ä¸ªè±†èšä¸­æœ‰å‡ ä¸ªè±†ç²’ã€‚</p>
<p>Kubernetesä¸Šé¢è¿è¡Œçš„æœ€å°å•å…ƒæ˜¯<code>Pod</code>,  kuberneteså¹¶ä¸ç›´æ¥è°ƒåº¦å®¹å™¨çš„è¿è¡Œï¼Œè€Œè°ƒåº¦çš„ç›®æ ‡æ˜¯<code>Pod</code>ï¼Œ<code>Pod</code>å¯ä»¥ç†è§£ä¸ºå®¹å™¨çš„å¤–å£³ï¼Œç»™å®¹å™¨åšäº†ä¸€å±‚æŠ½è±¡çš„å°è£…ï¼Œå› æ­¤<code>Pod</code>æˆä¸ºäº†Kubernetesé›†ç¾¤ä¹‹ä¸Šæœ€å°çš„è°ƒåº¦å•ä½ï¼ˆé€»è¾‘å•å…ƒï¼‰ï¼Œ<code>Pod</code>å†…éƒ¨ä¸»è¦æ˜¯ç”¨æ¥æ”¾å®¹å™¨çš„ï¼Œ<code>Pod</code>æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œä¸€ä¸ª<code>Pod</code>ä¸­å¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œå¤šä¸ªå®¹å™¨å…±äº«åŒä¸€ä¸ªåº•å±‚çš„ç½‘ç»œå‘½åç©ºé—´ï¼ˆåº•å±‚çš„<code>net</code>, <code>uts</code>, <code>IPC</code>ä¸‰ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼‰ï¼Œå¦å¤–ä¸‰ä¸ªå‘½åç©ºé—´ç›¸äº’éš”ç¦»ï¼ˆ<code>User</code>, <code>mnt</code>, <code>pid</code>ï¼‰ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒåŒä¸€ä¸ª<code>Pod</code>ä¸Šé¢çš„å¤šä¸ªå®¹å™¨ï¼Œæ¯ä¸ªå®¹å™¨ä¸Šé¢è·‘åº”ç”¨ç¨‹åº ï¼Œå¯¹å¤–æ›´åƒæ˜¯åŒä¸€å°â€œè™šæ‹Ÿæœºâ€ï¼Œè¿™ä¹Ÿæ˜¯kubernetesç»„ç»‡å®¹å™¨çš„ä¸€ä¸ªéå¸¸ç²¾å·§çš„åŠæ³•ï¼ŒåŸºäºæ­¤æˆ‘ä»¬å¯ä»¥æ„å»ºè¾ƒä¸ºç²¾ç»†çš„å®¹å™¨é—´é€šä¿¡ï¼Œå¹¶ä¸”åŒä¸€ä¸ªPodä¸Šé¢çš„å®¹å™¨ï¼Œè¿˜å…±äº«ç¬¬äºŒç§èµ„æºï¼Œå«åšå­˜å‚¨å·ï¼Œå­˜å‚¨å·ä¸å±äºå®¹å™¨ï¼Œå±äº<code>Pod</code>ï¼Œ<code>Pod</code>çš„ç£ç›˜ï¼Œç›¸åŒ<code>Pod</code>çš„å®¹å™¨å…±äº«ã€‚</p>
<p>å„ä¸ªnodeèŠ‚ç‚¹ä¸»è¦æ˜¯ç”¨æ¥è¿è¡Œ<code>Pod</code>çš„ï¼Œä¸€èˆ¬è¯´æ¥ï¼Œä¸€ä¸ª<code>Pod</code>ä¸Šé¢åªæ”¾ä¸€ä¸ªå®¹å™¨ï¼Œé™¤éæœ‰ç‰¹åˆ«ç´§å¯†çš„å…³ç³»ï¼Œéœ€è¦æ”¾åœ¨åŒä¸€ä¸ª<code>Pod</code>ä¸Šé¢ï¼Œå¦åˆ™ï¼Œä¸è¦æ”¾åœ¨åŒä¸€<code>Pod</code>ä¸Šé¢ï¼›å¦‚æœç¡®å®æœ‰éœ€è¦ï¼Œå°†å¤šä¸ªå®¹å™¨éœ€è¦æ”¾åœ¨ä¸€ä¸ª<code>Pod</code>ä¸­ï¼Œé€šå¸¸æœ‰ä¸€ä¸ªå®¹å™¨æ˜¯ä¸»å®¹å™¨ï¼Œå…¶å®ƒçš„å®¹å™¨ä¸ºè¾…åŠ©ä¸»å®¹å™¨ï¼Œè¾…åŠ©å®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºä¸»è¦æ˜¯ä¸ºäº†å®Œæˆæ›´å¤šåŠŸèƒ½æ¥è¾…ä½ä¸»å®¹å™¨å·¥ä½œï¼Œè¿™é‡Œæˆ‘ä»¬è°ƒåº¦å™¨ä¹Ÿæ˜¯è°ƒåº¦çš„<code>Pod</code>, nodeèŠ‚ç‚¹ä¸Šé¢ä¹Ÿæ˜¯<code>Pod</code>, <code>Pod</code>æ˜¯ä¸€ä¸ªåŸå­å•å…ƒï¼Œä¹Ÿå°±æ„å‘³ç€ä¸€ä¸ª<code>Pod</code>ä¸­æœ‰ä¸€ä¸ªå®¹å™¨ï¼Œè¿˜æ˜¯æœ‰å¤šä¸ªå®¹å™¨ï¼Œä¸€æ—¦è¢«è°ƒåº¦ä¹‹åï¼Œç›¸åŒ<code>Pod</code>ä¸Šé¢çš„å®¹å™¨ï¼Œåªèƒ½åœ¨åŒä¸€ä¸ªnodeèŠ‚ç‚¹ä¸Šé¢ã€‚</p>
<p>åˆ›å»º<code>Pod</code>æ—¶ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºï¼Œå¹¶ä¸”è‡ªä¸»ç®¡ç†çš„ï¼Œä½†å®ƒä»ç„¶è¦æäº¤ç»™<code>API Server</code>ï¼Œç”±<code>API Server</code>æ¥æ”¶ä»¥åï¼Œé€šè¿‡è°ƒåº¦å™¨è°ƒåº¦åˆ°æŒ‡å®šçš„NodeèŠ‚ç‚¹ä¸Šï¼Œè€ŒnodeèŠ‚ç‚¹å¯åŠ¨æ­¤Podï¼Œæ­¤åå¦‚æœpodä¸Šé¢çš„å®¹å™¨å‡ºç°æ•…éšœï¼Œéœ€è¦é‡è¦é‡å¯å®¹å™¨ï¼Œéœ€è¦<code>kubelet</code>å®Œæˆï¼Œä½†æ˜¯nodeèŠ‚ç‚¹æ•…éšœäº†ï¼ŒèŠ‚ç‚¹å°±æ¶ˆå¤±äº†ã€‚è¿˜æœ‰ä¸€ç§Podçš„åˆ›å»ºæ–¹å¼ï¼Œæ˜¯é€šè¿‡æ§åˆ¶å™¨æ¥åˆ›å»ºçš„ï¼Œåé¢ä¸ºè®²ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨ï¼Œå®ƒçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<h2 id="NodeèŠ‚ç‚¹æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"><a href="#NodeèŠ‚ç‚¹æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ" class="headerlink" title="NodeèŠ‚ç‚¹æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"></a>NodeèŠ‚ç‚¹æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</h2><p>åˆšæ‰è¯´äº†nodeæ˜¯kubernetesé›†ç¾¤ä¸­çš„å·¥ä½œèŠ‚ç‚¹ï¼Œè´Ÿè´£è¿è¡Œç”±masterèŠ‚ç‚¹ä¸Šé¢æŒ‡æ´¾çš„å„ç§ä»»åŠ¡ï¼Œè€Œæœ€æ ¸å¿ƒçš„ä»»åŠ¡æ˜¯ä»¥Podçš„å½¢å¼è¿è¡Œå®¹å™¨çš„ï¼Œç†è§£ä¸Šè®²nodeå¯ä»¥æ˜¯ä»»ä½•å½¢å¼çš„èµ„æºè®¾å¤‡ï¼Œåªè¦æœ‰ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„å†…å­˜ã€CPUã€å­˜å‚¨èµ„æºå³å¯ï¼Œå¹¶ä¸”å¯ä»¥å®‰è£…ä¸ŠKubernetesé›†ç¾¤çš„åº”ç”¨ç¨‹åº ï¼Œéƒ½å¯ä»¥åšä¸ºk8sé›†ç¾¤çš„ä¸€ä¸ªä»½å­æ¥å·¥ä½œï¼Œå®ƒæ˜¯æ‰¿è½½èµ„æºçš„ã€‚</p>
<p>è¿™æ ·ä¸€æ¥ç»ˆç«¯ç”¨æˆ·ä¸éœ€è¦å…³å¿ƒåº”ç”¨ç¨‹åºï¼ˆPodï¼‰åœ¨å“ªä¸ªNodeèŠ‚ç‚¹ä¸Šé¢ï¼Œå®ƒå°±è¿™æ ·è„±ç¦»äº†ç»ˆç«¯ç”¨æˆ·çš„è§†çº¿ï¼Œç»ˆç«¯ç”¨æˆ·ä¹Ÿæ— éœ€å…³æ³¨åº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨å“ªä¸ªnodeèŠ‚ç‚¹ä¸Šé¢çš„podï¼Œä»è€ŒçœŸæ­£æ„ä¹‰ä¸Šå®ç°äº†èµ„æºæ± ï¼Œä»è€Œè¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯æ ‡ç­¾ï¼Œæ ‡ç­¾é€‰æ‹©å™¨æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯æ ‡ç­¾ï¼Œæ ‡ç­¾é€‰æ‹©å™¨æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯æ ‡ç­¾ï¼Œæ ‡ç­¾é€‰æ‹©å™¨æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯æ ‡ç­¾ï¼Œæ ‡ç­¾é€‰æ‹©å™¨æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</h2><p>å¦‚ä½•è®©ä¸€ä¸ªæ§åˆ¶å™¨ç®¡ç†æŒ‡å®šçš„Podï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆ›å»ºäº†5ä¸ªPodï¼ŒPodä¸­è¿è¡Œtomcatå®¹å™¨ï¼Œæˆ‘ä»¬è®©ä¸€ä¸ªæ§åˆ¶å™¨æ¥ç®¡ç†è¿™ä¸€ç»„Podï¼Œä¸ºäº†è®©Podèƒ½å¤Ÿå®ç°è¢«æ§åˆ¶å™¨ç®¡ç†è¯†åˆ«ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Podä¸Šé¢é™„åŠ ä¸€äº›å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ï¼‰ï¼Œç”¨æ ‡ç­¾æ¥è¯†åˆ«Podï¼Œåœ¨åˆ›å»ºPodçš„æ—¶å€™ï¼Œæˆ–è€…äººä¸ºçš„æ‰“ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œè®©æ§åˆ¶å™¨èƒ½å¤Ÿè¯†åˆ«å‡ºæ ‡ç­¾ï¼Œè¿›è€Œè¯†åˆ«å‡ºPodã€‚æˆ‘ä»¬å‰é¢åˆ›å»ºäº†5ä¸ª Podï¼Œæˆ‘ä»¬åœ¨æ¯ä¸€ä¸ªpodä¸Šé¢åŠ ä¸€ä¸ªæ ‡ç­¾app, æ ‡ç­¾çš„å€¼å«tomcat (<code>æ ‡ç­¾ï¼šå€¼====&gt; app:tomcat</code>)ï¼Œæˆ‘ä»¬æƒ³æŠŠè¿™ä¸€ç±»æ‰¾å‡ºæ¥ï¼Œæ€ä¹ˆæ‰¾ï¼Œæˆ‘ä»¬å…ˆæ‰¾æ‹¥æœ‰keyæ˜¯appï¼Œå¹¶ä¸”å€¼æ˜¯tomcatçš„podåˆ†æ‹£å‡ºæ¥ã€‚æ ‡ç­¾æ˜¯Kuberneteså¤§è§„æ¨¡é›†ç¾¤ç®¡ç†ã€åˆ†ç±»ã€è¯†åˆ«èµ„æºä½¿ç”¨çš„ï¼Œæ ‡ç­¾æ˜¯éå¸¸éå¸¸é‡è¦çš„å‡­è¯ï¼Œæˆ‘ä»¬æ˜¯å¦‚ä½•æŠŠæˆ‘ä»¬æ„Ÿå…´è¶£çš„æ ‡ç­¾æ‰¾åˆ°çš„å‘¢ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ ‡ç­¾é€‰æ‹©å™¨/æŒ‘é€‰å™¨ï¼ˆselectorï¼‰ç»„ä»¶ï¼Œæ ‡ç­¾é€‰æ‹©å™¨ï¼Œç®€å•æ¥è®²å°±æ˜¯æ ¹æ®æ ‡ç­¾ï¼Œè¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„èµ„æºå¯¹è±¡çš„æœºåˆ¶ï¼Œå…¶å®æ ‡ç­¾ä¸åªæ˜¯Podæœ‰ï¼Œå¾ˆå¤šå…¶å®ƒèµ„æºéƒ½æœ‰ï¼Œå› æ­¤è¿™ç§é€‰æ‹©å™¨å«åšæ ‡ç­¾é€‰æ‹©å™¨ï¼Œè€Œä¸å«podæ ‡ç­¾é€‰æ‹©å™¨ï¼ŒKubernetesæ˜¯Restfull é£æ ¼çš„APIï¼Œé€šè¿‡httpæˆ–è€…httpså¯¹å¤–æä¾›æœåŠ¡ï¼Œæ‰€ä»¥æ‰€æœ‰Restfullå¯¹å¤–æä¾›çš„æœåŠ¡èµ„æºéƒ½ç§°ä¸ºå¯¹è±¡ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½å¯ä»¥æ‹¥æœ‰æ ‡ç­¾ï¼Œæ‰€æœ‰çš„æ ‡ç­¾éƒ½å¯ä»¥ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨æ¥é€‰æ‹©ï¼Œåªä¸è¿‡podæ˜¯å…¶ä¸­ä¸€ç§æ¯”è¾ƒé‡è¦çš„ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨ï¼Œæ§åˆ¶å™¨æ˜¯åšä»€ä¹ˆçš„ï¼Œæœ‰å“ªäº›æ§åˆ¶å™¨ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨ï¼Œæ§åˆ¶å™¨æ˜¯åšä»€ä¹ˆçš„ï¼Œæœ‰å“ªäº›æ§åˆ¶å™¨ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨ï¼Œæ§åˆ¶å™¨æ˜¯åšä»€ä¹ˆçš„ï¼Œæœ‰å“ªäº›æ§åˆ¶å™¨ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨ï¼Œæ§åˆ¶å™¨æ˜¯åšä»€ä¹ˆçš„ï¼Œæœ‰å“ªäº›æ§åˆ¶å™¨ï¼Ÿ</h2><p>æˆ‘ä»¬åˆšæ‰è®²Podçš„æ—¶å€™ ï¼Œè®²åˆ°äº†åˆ›å»ºPodæ—¶ï¼Œä¸€ç§æ˜¯ç›´æ¥åˆ›å»ºPodï¼ŒPodåˆ é™¤åï¼Œä¸ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œè¿˜æœ‰ä¸€ç§åˆ›å»ºPodçš„æ–¹å¼ï¼Œæ˜¯é€šè¿‡æ§åˆ¶å™¨åˆ›å»ºçš„Podï¼Œè¿™ç§<code>æ§åˆ¶å™¨ç®¡ç†çš„Pod</code>ï¼Œ æ­£æ˜¯æ§åˆ¶å™¨ç®¡ç†å™¨æœºåˆ¶çš„ä½¿ç”¨ã€‚åœ¨Kubernetesè®¾è®¡ä¸­ï¼ŒPodå®Œå…¨å¯ä»¥å«åšæœ‰ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ï¼Œè€Œåç”±è°ƒåº¦å™¨å°†å…¶è°ƒåº¦è‡³é›†ç¾¤ä¸­çš„æŸèŠ‚ç‚¹ï¼Œè¿è¡Œä»¥åï¼Œä»»åŠ¡ç»ˆæ­¢ä¹Ÿå°±è¢«åˆ é™¤åœæ‰äº†ï¼Œä½†æ˜¯æœ‰ä¸€äº›ä»»åŠ¡ï¼Œæ¯”å¦‚nginxï¼Œæˆ–è€…è¿è¡Œä¸€ä¸ªtomcatï¼Œä»–ä»¬æ˜¯åšä¸ºå®ˆæŠ¤è¿›ç¨‹æ¥è¿è¡Œçš„ï¼Œè¿™ç§ç¨‹åºï¼Œæˆ‘ä»¬è¦ç¡®ä¿è¿™ç§podéšæ—¶è¿è¡Œï¼Œä¸€æ—¦å‡ºç°æ•…éšœï¼Œéœ€è¦ç¬¬ä¸€æ—¶é—´å‘ç°ï¼Œè¦ä¹ˆå–ä»£å®ƒï¼Œè¦ä¹ˆé‡å¯å®ƒï¼Œè¦ä¹ˆé‡å»ºä¸€ä¸ªæ–°çš„podï¼Œè¿™ç§é äººçš„å³çœ¼æ˜¯æ— æ³•ä¿è¯çš„ï¼Œè€ŒKubernetesæä¾›äº†å…·å¤‡è¿™ç§å·¥ä½œèƒ½åŠ›çš„ç»„ä»¶å«<code>Podæ§åˆ¶å™¨</code>ã€‚</p>
<p>Podæ§åˆ¶å™¨æœ€æ—©çš„ä¸€ç§å«<code>ReplicationController</code> (å‰¯æœ¬æ§åˆ¶å™¨ï¼Œæ—©æœŸç‰ˆæœ¬çš„æ§åˆ¶å™¨ï¼Œä¹Ÿç§°ä¸ºPodæ§åˆ¶å™¨)ï¼Œ å½“æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªpodæ—¶ï¼Œä¸€ä¸ªä¸å¤Ÿäº†ï¼Œå¯ä»¥å†å¯åŠ¨ä¸€ä¸ªå‰¯æœ¬ï¼Œæ§åˆ¶å™¨å°±æ˜¯æ§åˆ¶åŒä¸€ç±»èµ„æºå¯¹è±¡çš„å‰¯æœ¬ï¼Œä¸€æ—¦å‰¯æœ¬æ•°é‡å°‘äº†ï¼Œå°±ä¼šè‡ªåŠ¨åŠ ä¸€ä¸ªï¼Œèƒ½å¤Ÿå®šä¹‰è¦æ±‚çš„å‰¯æœ¬æ•°ï¼Œå¤šäº†å°±åˆ é™¤ï¼Œç²¾ç¡®ç¬¦åˆäººä»¬æœŸæœ›çš„æ•°é‡ï¼Œå®ƒè¿˜å¯ä»¥å®ç°æ»šåŠ¨æ›´æ–°ï¼Œå®ƒå…è®¸ä¸´æ—¶æ·»åŠ å‰¯æœ¬ï¼Œç„¶åæŠŠæ—§ç‰ˆæœ¬çš„å»æ‰ï¼Œå®ç°æ»šåŠ¨æ›´æ–°ï¼›å®ƒä¹Ÿå…è®¸å›æ»šæ“ä½œï¼Œåæ¥çš„ç‰ˆæœ¬ä¸­æ–°åŠ äº†<code>ReplicaSetController</code>ï¼ˆå‰¯æœ¬é›†æ§åˆ¶å™¨ï¼‰ï¼Œè€Œ<code>ReplicaSetController</code>ä¹Ÿä¸ç›´æ¥ä½¿ç”¨ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ªå£°æ˜å¼æ›´æ–°çš„æ§åˆ¶å™¨å«<code>Deployment</code>ï¼Œç”¨å®ƒæ¥è¿›è¡Œç®¡ç†æ§åˆ¶ï¼Œ æˆ‘ä»¬ä½¿ç”¨çš„æœ€å¤šçš„ä¹Ÿæ˜¯<code>Deployment</code>æ§åˆ¶å™¨ï¼Œè€Œ<code>Deployment</code>æ§åˆ¶å™¨åªèƒ½ç®¡ç†å“ªäº›æ— çŠ¶æ€çš„åº”ç”¨ï¼Œå“ªä¹ˆæœ‰çŠ¶æ€çš„åº”ç”¨å¦‚ä½•æ§åˆ¶ç®¡ç†å‘¢ï¼Ÿæˆ‘ä»¬ä½¿ç”¨æ–°çš„æ§åˆ¶å™¨ï¼Œå«<code>StatefulSet</code>æœ‰çŠ¶æ€å‰¯æœ¬é›†ï¼Œå¦å¤–å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªnodeä¸Šé¢è¿è¡Œä¸€ä¸ªPodï¼Œè€Œä¸æ˜¯éšæ„è¿è¡Œï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ª<code>DaemonSet</code>ï¼Œå¦‚æœæˆ‘ä»¬è¿è¡Œä½œä¸šï¼Œè¿˜éœ€è¦Job, å‘¨æœŸæ€§ä½œä¸šï¼Œ<code>Cronjob</code>,  è¿™äº›æ˜¯å¸¸è§çš„Podæ§åˆ¶å™¨ï¼›åé¢çš„è¿™äº›æ§åˆ¶å™¨éƒ½æ˜¯å®ç°ä¸€ç§ç‰¹å®šçš„åº”ç”¨ç®¡ç†ï¼Œæ¯”å¦‚ä¸´æ—¶è¿è¡Œä¸€ä¸ªå®¹å™¨å»å®Œæˆåˆ é™¤æ—¥å¿—çš„åŠŸèƒ½ï¼Œè¿™ä¸ªè¿è¡Œå®Œå°±åˆ é™¤äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨Jobæ§åˆ¶å™¨ç®¡ç†Pod, ä½†æ˜¯å¦‚æœJobæ²¡æœ‰è¿è¡Œå®ŒæŒ‚äº†ï¼Œéœ€è¦é‡æ–°å¯åŠ¨ï¼Œå¦‚æœè¿è¡Œå®Œï¼Œå°±åˆ é™¤äº†ï¼Œå†æ¯”å¦‚nginxä¸€ç›´éœ€è¦å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå°±ä¸èƒ½ä½¿ç”¨Jobæ§åˆ¶å™¨ï¼Œæ‰€ä»¥è¯´è¿™ä¹ˆå¤šçš„æ§åˆ¶å™¨æ˜¯ç”¨äºç¡®ä¿ä¸åŒç±»å‹çš„Podèµ„æºï¼Œæ¥ç¬¦åˆç”¨æˆ·æ‰€æœŸæœ›çš„æ–¹å¼æ¥è¿è¡Œï¼Œåƒ<code>Deployment</code>æ§åˆ¶å™¨è¿˜æ”¯æŒäºŒçº§æ§åˆ¶å™¨ï¼Œå«<code>HPA</code>ï¼Œå«æ°´å¹³Podï¼Œè‡ªåŠ¨ä¼¸ç¼©æ§åˆ¶å™¨ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸€ä¸ªæ§åˆ¶å™¨æ§åˆ¶ä¸¤ä¸ªå‰¯æœ¬åœ¨è¿è¡Œï¼Œä½†åœ¨èµ„æºåˆ©ç”¨ç‡é«˜çš„æ—¶å€™ï¼Œå¯ä»¥è‡ªåŠ¨çš„ä¼¸ç¼©æ§åˆ¶ï¼Œå°±æ˜¯ä½¿ç”¨<code>HPA</code>è¿›è¡Œæ§åˆ¶ï¼Œä¸€æ—¦åˆ©ç”¨ç‡ä½äº†ï¼Œå¯ä»¥è‡ªåŠ¨å‡å°‘ï¼Œä½†è¦ç¬¦åˆæˆ‘ä»¬é¢„æœŸçš„æœ€å°å€¼ã€‚</p>
<h2 id="Serveiceæ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆéœ€è¦Serviceï¼Ÿ"><a href="#Serveiceæ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆéœ€è¦Serviceï¼Ÿ" class="headerlink" title="Serveiceæ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆéœ€è¦Serviceï¼Ÿ"></a>Serveiceæ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆéœ€è¦Serviceï¼Ÿ</h2><p>åˆ°è¿™é‡Œæˆ‘ä»¬æƒ³åˆ°ä¸€ä¸ªé—®é¢˜ï¼ŒPodæ˜¯ç”±ç”Ÿå‘½å‘¨æœŸçš„ï¼Œä¸‡ä¸€Podæ‰€åœ¨NodeèŠ‚ç‚¹å®•æœºäº†ï¼ŒPodæœ‰å¯èƒ½éœ€è¦åœ¨å…¶å®ƒçš„ NodeèŠ‚ç‚¹ä¸Šé¢é‡æ–°åˆ›å»ºï¼Œè€Œé‡æ–°åˆ›å»ºå®Œæˆåçš„podï¼Œè·Ÿä¹‹å‰çš„ä¸æ˜¯ä¸€ä¸ªï¼Œåªä¸è¿‡æ˜¯åº”ç”¨ç¨‹åºä¸€æ ·è€Œå·²ï¼Œæä¾›ç›¸åŒçš„æœåŠ¡ï¼Œç”±äºæ¯ä¸ªpodä¸­å®¹å™¨çš„IPåœ°å€å°±ä¸ä¸€æ ·ï¼Œè¿™æ ·ä¸€æ¥å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å®¢æˆ·ç«¯æ€ä¹ˆå»è®¿é—®è¿™äº›Podå‘¢ï¼Ÿæ˜¯åˆ©ç”¨æœåŠ¡å‘ç°æœºåˆ¶ï¼Œé¦–å…ˆå®¢æˆ·ç«¯æ¯ä¸€æ¬¡å»è®¿é—®æœåŠ¡æ—¶ï¼Œå®¢æˆ·ç«¯æ˜¯ä¸çŸ¥é“åç«¯çš„æœåŠ¡æ˜¯è°çš„ï¼ˆä¸çŸ¥é“podçš„å­˜åœ¨ï¼‰ï¼Œä»–éœ€è¦æ‰¾ä¸€ä¸ªåœ°æ–¹é—®ä¸€å¥ï¼Œå‘ç°ä¸€ä¸‹ï¼Œæœ‰æ²¡æœ‰è¿™ç§æœåŠ¡ï¼Œè¿™äº›æœåŠ¡æ˜¯Podå¯åŠ¨çš„æ—¶å€™æ³¨å†Œåˆ°ä¸€ä¸ªç±»ä¼¼æ€»çº¿åœ°å€ä¸Šï¼Œå®¢æˆ·ç«¯ç›´æ¥å»æ€»çº¿ä½ç½®å»é—®ï¼Œæœ‰æ²¡æœ‰ï¼Œæœ‰çš„è¯ï¼Œç»™ä¸€ä¸ªPodåœ°å€ï¼Œå®¢æˆ·ç«¯ä¸Podåœ°å€è¿›è¡Œé€šä¿¡ï¼›å› æ­¤å°½å¯èƒ½é™ä½è¿™ç§å¤æ‚åº¦ï¼ŒKubernetesä¸ºæ¯ä¸€ç»„æä¾›ç›¸åŒåŠŸèƒ½çš„Podå’Œå®¢æˆ·ç«¯ä¹‹é—´æ·»åŠ äº†ä¸€ä¸ªä¸­é—´å±‚ï¼Œè¿™ä¸ªä¸­é—´å±‚æ˜¯å›ºå®šçš„ï¼Œè¿™ä¸ªä¸­é—´å±‚å°±å«serviceï¼Œåªè¦serviceä¸åˆ é™¤ï¼Œå®ƒå°±æ˜¯å›ºå®šçš„ï¼Œåç§°ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œå½“å®¢æˆ·ç«¯éœ€è¦è®¿é—®æ—¶ï¼Œåªéœ€è¦åœ¨å®¢æˆ·ç«¯å†™ä¸Šservice ä¸»æœºå|æœåŠ¡å™¨|åœ°å€å³å¯ï¼Œä¹Ÿä¸éœ€è¦å‘ç°ï¼Œè€Œè¿™ä¸ªæœåŠ¡service æ˜¯ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œä¸ä½†æä¾›ä¸€ä¸ªå›ºå®šç¨³å®šçš„è®¿é—®å…¥å£ï¼Œåªè¦ä¸åˆ é™¤ï¼Œå®ƒå°±æ˜¯ç¨³å®šçš„ï¼Œå®¢æˆ·ç«¯åªéœ€è¦å†™serviceåç§°å³å¯ï¼ŒæœåŠ¡å†æŠŠè¯·æ±‚ä»£ç†åˆ°åé¢çš„podä¸Šé¢ï¼Œé‚£ä¹ˆPodå®•æœºäº†ï¼Œæ–°åˆ›å»ºçš„podä¼šè¢«serviceç«‹å³ç»™å…³è”è¿›æ¥ï¼›è¿˜ä¼šæŠŠæ–°åŠ çš„podä½œä¸ºserviceåé¢çš„å¯ç”¨èµ„æºå¯¹è±¡ä¹‹ä¸€ï¼Œæ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é€šä¿¡æ˜¯é€šè¿‡<code>IPï¼šPort</code>æˆ–è€…<code>åŸŸå:Port</code>å½¢å¼ï¼Œè€Œserviceä¸åé¢çš„podä¸æ˜¯ä¾é <code>IP:Port</code>çš„å½¢å¼ï¼ˆå› ä¸ºpodçš„ä¸»æœºåå’ŒIPç»å¸¸è¦å˜ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡Podä¸Šé¢å›ºå®šçš„æ ‡ç­¾æ¥è¯†åˆ«ï¼Œåªè¦æ˜¯ç›¸åŒæ ‡ç­¾çš„podï¼Œä¸ç®¡ä¸»æœºåå’ŒIPæ€ä¹ˆå˜ï¼Œéƒ½ä¼šè¢«serviceé€šè¿‡æ ‡ç­¾è¯†åˆ«ï¼Œserviceæ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨æ¥å…³è”podçš„ï¼›è¿™æ ·ä¸€æ¥ï¼Œåªè¦podå±äºè¿™ä¸ªæ ‡ç­¾é€‰æ‹©å™¨ï¼Œå°±èƒ½ç«‹å³è¢«serviceèƒ½é€‰ä¸­ï¼Œå¹¶ä¸”åšä¸ºserviceåç«¯ç»„ä»¶å­˜åœ¨ï¼Œå…³è”è¿›æ¥ä»¥åï¼Œå†åŠ¨æ€æ¢æµ‹è¿™ä¸ªpodçš„IPåœ°å€æ˜¯ä»€ä¹ˆï¼Œç«¯å£æ˜¯ä»€ä¹ˆï¼Œå¹¶åšä¸ºè‡ªå·±åç«¯å¯è°ƒåº¦çš„æœåŠ¡å™¨ï¼Œèµ„æºå¯¹è±¡ï¼Œ æœ€åï¼Œå®¢æˆ·ç«¯æ˜¯é€šè¿‡serviceä»£ç†è‡³åç«¯podè¿›è¡Œé€šä¿¡ï¼›æ„å‘³ç€å®¢æˆ·ç«¯çœ‹åˆ°çš„åœ°å€å°±æ˜¯serviceçš„åœ°å€ï¼Œè€Œåœ¨kubernetesé›†ç¾¤ä¸Šserviceå¯ä¸æ˜¯ä»€ä¹ˆåº”ç”¨ç¨‹åº ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ªå®ä½“ç»„ä»¶ï¼Œå®ƒåªä¸è¿‡æ˜¯ä¸€ä¸ª<code>iptables DNAT</code>è§„åˆ™ï¼›æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>DNAT</code> è§„åˆ™ ï¼Œæˆ‘ä»¬æ‰€æœ‰åˆ°è¾¾xxxåœ°å€çš„ï¼Œéƒ½ç»Ÿç»Ÿè¢«ç›®æ ‡åœ°å€è½¬æ¢æˆyyyåœ°å€ï¼Œ<code>DNAT</code>è§„åˆ™åªæ˜¯ä¸€ä¸ªè§„åˆ™ ï¼Œè€Œserviceåœ°å€ï¼Œäº‹å®ä¸Šå¹¶æ²¡æœ‰é…ç½®åˆ°ä»»ä½•ä¸€å¼ ç½‘å¡ä¸Šï¼Œæ˜¯ä¸å­˜åœ¨çš„ï¼Œå®ƒä»…ä»…å‡ºåœ¨è§„åˆ™ä¸­ï¼Œå¯ä»¥pingé€šçš„ï¼Œå¹¶ä¸”å¯ä»¥åšè¯·æ±‚ä¸­è½¬ï¼Œèƒ½pingé€šæ˜¯å› ä¸ºæœ‰<code>TCP/IP</code>åè®®æ ˆã€‚è¿™ä¸ªIPåœ°å€ï¼Œä»…å‡ºç°åœ¨è§„åˆ™ä¸­ï¼Œæ›´é‡è¦çš„æ˜¯serviceåšä¸ºKubernetesä¸­çš„å¯¹è±¡æ¥è®²ï¼Œå®ƒæœ‰åç§°ï¼Œå°±ç›¸å½“äºè¿™ä¸ªæœåŠ¡çš„åå­—ï¼Œåç§°å¯ä»¥è¢«è§£æï¼Œå°±æ˜¯æŠŠserviceåç§°è§£ææˆIPï¼Œåç§°è§£æé DNSï¼Œæ²¡é”™ï¼Œæˆ‘ä»¬å®‰è£…å®Œk8såï¼Œç¬¬ä¸€ä»¶äº‹ï¼Œå°±æ˜¯è®©éƒ¨ç½²ä¸€ä¸ª<code>DNS Pod</code>ï¼Œä»¥ç¡®ä¿serviceè¢«è§£æï¼Œè¿™ä¸ªPodæ˜¯Kubernetesè‡ªèº«çš„æœåŠ¡å°±éœ€è¦çš„podï¼Œæ‰€ä»¥æˆ‘ä»¬ç§°ä¹‹ä¸ºåŸºç¡€æ€§çš„ç³»ç»Ÿæ¶æ„çº§çš„podæˆ–å¯¹è±¡ï¼Œè€Œä¸”ç§°ä»–ä»¬å«é›†ç¾¤çš„é™„ä»¶ã€‚</p>
<h2 id="é›†ç¾¤é™„ä»¶DNS"><a href="#é›†ç¾¤é™„ä»¶DNS" class="headerlink" title="é›†ç¾¤é™„ä»¶DNS"></a>é›†ç¾¤é™„ä»¶DNS</h2><p>DNSé™„ä»¶åªæ˜¯Kubernetesé›†ç¾¤ä¸­çºµå¤šé™„ä»¶ä¸­çš„ä¸€ä¸ªï¼Œå¹¶ä¸”è¿™ç§DNSæœ‰ä¸€ä¸ªå¾ˆæœ‰æ„ä¹‰çš„ç‰¹ç‚¹ï¼Œå¯ä»¥åŠ¨æ€çš„åˆ›å»ºï¼ŒåŠ¨æ€çš„æ”¹å˜ï¼ŒåŠ¨æ€çš„æ›´æ–°ï¼ŒåŠ¨æ€çš„å˜åŠ¨ï¼Œæ¯”å¦‚ï¼Œä½ æ›´æ–°äº†serviceåç§°ï¼ŒDNSä¸­çš„è®°å½•å³å°±ä¼šè¢«æ”¹å˜ï¼Œå†æ¯”å¦‚æˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹äº†service IP ,ä»–ä¼šè‡ªåŠ¨è§¦å‘DNS æœåŠ¡ä¸­çš„è§£æè®°å½•çš„æ›´æ”¹ï¼Œæ‰€ä»¥ä»¥åå®¢æˆ·ç«¯è®¿é—®serviceæ—¶ï¼Œå¯ä»¥ç›´æ¥è®¿é—®æœåŠ¡çš„åç§° ï¼Œè€Œç”±é›†ç¾¤ä¸­ä¸“é—¨çš„DNSæœåŠ¡æ¥è´Ÿè´£è§£æï¼Œè§£æçš„æ˜¯serviceçš„åœ°å€ï¼Œä¸æ˜¯podåœ°å€ï¼Œå†ç”±serviceä»£ç†è®¿é—®podï¼Œåˆšæ‰ä¹Ÿè¯´äº†ï¼Œè¿™ç§ä»£ç†æ˜¯ç«¯å£ä»£ç†ï¼Œç”±DNATå®ç°ï¼Œå¯ä¸èƒ½å¿˜è®°serviceåé¢ä¸­ä¸¤ä¸ªæˆ–è€…å¤šä¸ªpodï¼Œè¿™é‡Œçš„DNATå°±æ˜¯å¤šä¸ªç›®æ ‡äº†ï¼Œå¤šç›®æ ‡è°ƒåº¦ï¼Œå¯¹äºlinuxæ¥è®²ï¼Œå¤§å®¶çŸ¥é“å¯¹äºiptablesæ¥è®²ï¼Œå·²ç»æŠŠè´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ä¸»è¦äº¤ç»™äº†IPVSï¼Œå› æ­¤å¦‚æœserviceèƒŒåçš„åŒä¸€ä¸ªæœåŠ¡æœ‰å¤šä¸ªPodï¼Œå¹¶ä¸”ç”±DNATæ¥å®ç°ï¼Œå¯èƒ½åœ¨è°ƒåº¦æ•ˆæœä¸Šå¹¶ä¸å°½äººæ„ï¼Œå› æ­¤åœ¨ Kubernetes 1.11ç‰ˆæœ¬ä»¥åï¼Œå·²ç»æŠŠiptablesè§„åˆ™æ”¹æˆäº†IPVSè§„åˆ™ï¼Œä¹Ÿå°±ç›¸å½“äºï¼Œå½“ä½ åˆ›å»ºä¸€æ¡serviceè§„åˆ™æ—¶ï¼Œå°±åˆ›å»ºäº†ä¸€æ¡IPVSè§„åˆ™ ï¼Œåªä¸è¿‡æ˜¯NATæ¨¡å‹çš„IPVSè§„åˆ™ï¼Œå› æ­¤è¿˜æ”¯æŒç”¨æˆ·å¯ä»¥æŒ‡å®šä»»æ„çš„è°ƒåº¦ç®—æ³•ï¼Œå¦‚è½®è¯¢ã€åŠ æƒã€æœ€å°è¿æ¥ç­‰ï¼Œæ‰€ä»¥ä½ å°±ä¼šå‘ç°LVSæ˜¯æˆ‘ä»¬çš„åŸºç¡€æ€§æœåŠ¡ï¼Œä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬æ‰€è®²çš„serviceç»„ä»¶ã€‚</p>
<p>æ¥æºï¼šLinuxç‚¹æ»´è¿ç»´å®è·µ</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[kubernetesä¿®æ”¹ä¸»æœºip]]></title>
      <url>http://team.jiunile.com/blog/2019/12/k8s-kubeadm-edit-hostip.html</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç”±äºå¤–éƒ¨ç­‰ä¸ç¡®å®šå› ç´ å°è±¡ï¼Œkubernetesé›†ç¾¤ä¸­çš„ä¸»æœºIPä¿®æ”¹äº†ï¼Œä¼šå¯¼è‡´é›†ç¾¤å—å½±å“ï¼Œæ•…å‡ºä»¥ä¸‹æ•™ç¨‹æ¥ä¿è¯é›†ç¾¤çš„ç¨³å®šæ€§ã€‚æ­¤æ•™ç¨‹é€‚ç”¨äºkubeadmå®‰è£…çš„kubernetesé›†ç¾¤ï¼Œä½¿ç”¨ç‰ˆæœ¬kubeadm1.15+ </p>
<a id="more"></a>
<h2 id="ä¿®æ”¹masterä¸»æœºip"><a href="#ä¿®æ”¹masterä¸»æœºip" class="headerlink" title="ä¿®æ”¹masterä¸»æœºip"></a>ä¿®æ”¹masterä¸»æœºip</h2><h3 id="æ–¹å¼ä¸€ï¼šé€šè¿‡kubeadmå‘½ä»¤è¿›è¡Œè°ƒæ•´"><a href="#æ–¹å¼ä¸€ï¼šé€šè¿‡kubeadmå‘½ä»¤è¿›è¡Œè°ƒæ•´" class="headerlink" title="æ–¹å¼ä¸€ï¼šé€šè¿‡kubeadmå‘½ä»¤è¿›è¡Œè°ƒæ•´"></a>æ–¹å¼ä¸€ï¼šé€šè¿‡kubeadmå‘½ä»¤è¿›è¡Œè°ƒæ•´</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#kubeadm.conf é…ç½®æ–‡ä»¶å¦‚ä¸‹</span></span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.15.3 <span class="comment">#--&gt;è¿™é‡Œæ”¹æˆä½ é›†ç¾¤å¯¹åº”çš„ç‰ˆæœ¬</span></span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers </span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡æ–°ç”Ÿæˆ/etc/kubernetesç›®å½•ä¸‹çš„confæ–‡ä»¶</span></span><br><span class="line">kubeadm init phase kubeconfig all --config=/root/kubeadm.conf</span><br><span class="line"><span class="comment">#è¿è¡Œä¸Šè¿°å‘½ä»¤ä¼šå½±å“ä»¥ä¸‹æ–‡ä»¶</span></span><br><span class="line"><span class="comment">#admin.conf	</span></span><br><span class="line"><span class="comment">#controller-manager.conf	</span></span><br><span class="line"><span class="comment">#kubelet.conf	</span></span><br><span class="line"><span class="comment">#scheduler.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡æ–°ç”Ÿæˆmanifestsç›®å½•ä¸‹çš„yamlé…ç½®</span></span><br><span class="line">kubeadm init phase control-plane all --config=/root/kubeadm.conf</span><br><span class="line"><span class="comment">#è¿è¡Œä¸Šè¿°å‘½ä»¤ä¼šå½±å“ä»¥ä¸‹æ–‡ä»¶</span></span><br><span class="line"><span class="comment">#manifests/kube-apiserver.yaml</span></span><br><span class="line"><span class="comment">#manifests/kube-controller-manager.yaml</span></span><br><span class="line"><span class="comment">#manifests/kube-scheduler.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡æ–°ç”Ÿæˆetcd.yaml,å¦‚æœæ˜¯å¤–éƒ¨etcdåˆ™ç•¥è¿‡</span></span><br><span class="line">kubeadm init phase etcd <span class="built_in">local</span> --config=/root/kubeadm.conf</span><br><span class="line"><span class="comment">#è¿è¡Œä¸Šè¿°å‘½ä»¤ä¼šå½±å“ä»¥ä¸‹æ–‡ä»¶ï¼Œå¤–éƒ¨etcdåˆ™ä¸ä¼šå½±å“</span></span><br><span class="line"><span class="comment">#manifests/etcd.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡æ–°ç”Ÿæˆç»„ä»¶é…ç½®</span></span><br><span class="line">kubeadm init phase addon all --config=/root/kubeadm.conf</span><br><span class="line"><span class="comment">#è¿è¡Œä¸Šè¿°å‘½ä»¤ä¼šå½±å“ä»¥ä¸‹ç»„ä»¶</span></span><br><span class="line"><span class="comment">#kube-proxy</span></span><br><span class="line"><span class="comment">#coredns</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¤‡ä»½/etc/kubernetes/pkiç›®å½•</span></span><br><span class="line">cp -r /etc/kubernetes/pki /etc/kubernetes/pki-old</span><br><span class="line">rm -rf /etc/kubernetes/pki/apiserver.*  /etc/kubernetes/pki/front-proxy-client* </span><br><span class="line">rm -rf /etc/kubernetes/pki/etcd/healthcheck-client* /etc/kubernetes/pki/etcd/peer* /etc/kubernetes/pki/etcd/server*</span><br><span class="line"><span class="comment">#é‡æ–°ç”Ÿæˆè¯ä¹¦</span></span><br><span class="line">kubeadm init phase certs all --config=/root/kubeadm.conf</span><br></pre></td></tr></table></figure>
<h3 id="æ–¹å¼äºŒï¼šé€šè¿‡sed-å‘½ä»¤è¿›è¡Œè°ƒæ•´"><a href="#æ–¹å¼äºŒï¼šé€šè¿‡sed-å‘½ä»¤è¿›è¡Œè°ƒæ•´" class="headerlink" title="æ–¹å¼äºŒï¼šé€šè¿‡sed å‘½ä»¤è¿›è¡Œè°ƒæ•´"></a>æ–¹å¼äºŒï¼šé€šè¿‡sed å‘½ä»¤è¿›è¡Œè°ƒæ•´</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¿®æ”¹/etc/kubernetes ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line">sed -i <span class="string">'s/oldip/newip/g'</span> `grep <span class="string">"oldip"</span> -rl /etc/kubernetes`</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹kube-proxy configmapé…ç½®</span></span><br><span class="line">kubectl  get cm kube-proxy -n kube-system -o yaml &gt; proxy.yaml</span><br><span class="line">sed -i <span class="string">'s/oldip/newip/g'</span> proxy.yaml</span><br><span class="line">kubectl apply <span class="_">-f</span> proxy.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡æ–°renewè¯ä¹¦</span></span><br><span class="line">kubeadm alpha certs renew all --config=/root/kubeadm.conf</span><br></pre></td></tr></table></figure>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[åœ¨ Kubernetes ä¸­é…ç½® Container Capabilities]]></title>
      <url>http://team.jiunile.com/blog/2019/12/capabilities.html</url>
      <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨ä½¿ç”¨ Kubernetes è¿‡ç¨‹ä¸­ï¼Œå¶å°”ä¼šé‡åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€æ®µé…ç½®ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">securityContext:</span></span><br><span class="line"><span class="attr">  capabilities:</span></span><br><span class="line"><span class="attr">    drop:</span></span><br><span class="line"><span class="bullet">    -</span> ALL</span><br><span class="line"><span class="attr">    add:</span></span><br><span class="line"><span class="bullet">    -</span> NET_BIND_SERVICE</span><br></pre></td></tr></table></figure></p>
<p>å®é™…ä¸Šè¿™æ˜¯é…ç½®å¯¹åº”çš„å®¹å™¨çš„ <code>Capabilities</code>ï¼Œåœ¨æˆ‘ä»¬ä½¿ç”¨ <code>docker run</code> çš„æ—¶å€™å¯ä»¥é€šè¿‡ <code>--cap-add</code> å’Œ <code>--cap-drop</code> å‘½ä»¤æ¥ç»™å®¹å™¨æ·»åŠ  <code>Linux Capabilities</code>ã€‚å¯¹äºå¤§éƒ¨åˆ†åŒå­¦å¯èƒ½åˆè¦ç–‘é—® <code>Linux Capabilities</code> æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<br><a id="more"></a></p>
<h2 id="Linux-Capabilities"><a href="#Linux-Capabilities" class="headerlink" title="Linux Capabilities"></a>Linux Capabilities</h2><p>è¦äº†è§£ <code>Linux Capabilities</code>ï¼Œè¿™å°±å¾—ä» Linux çš„æƒé™æ§åˆ¶å‘å±•æ¥è¯´æ˜ã€‚åœ¨ Linux 2.2 ç‰ˆæœ¬ä¹‹å‰ï¼Œå½“å†…æ ¸å¯¹è¿›ç¨‹è¿›è¡Œæƒé™éªŒè¯çš„æ—¶å€™ï¼ŒLinux å°†è¿›ç¨‹åˆ’åˆ†ä¸ºä¸¤ç±»ï¼šç‰¹æƒè¿›ç¨‹ï¼ˆUID=0ï¼Œä¹Ÿå°±æ˜¯è¶…çº§ç”¨æˆ·ï¼‰å’Œéç‰¹æƒè¿›ç¨‹ï¼ˆUID!=0ï¼‰ï¼Œç‰¹æƒè¿›ç¨‹æ‹¥æœ‰æ‰€æœ‰çš„å†…æ ¸æƒé™ï¼Œè€Œéç‰¹æƒè¿›ç¨‹åˆ™æ ¹æ®è¿›ç¨‹å‡­è¯ï¼ˆeffective UID, effective GIDï¼Œsupplementary group ç­‰ï¼‰è¿›è¡Œæƒé™æ£€æŸ¥ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬ä»¥å¸¸ç”¨çš„ <code>passwd</code> å‘½ä»¤ä¸ºä¾‹ï¼Œä¿®æ”¹ç”¨æˆ·å¯†ç éœ€è¦å…·æœ‰ root æƒé™ï¼Œè€Œæ™®é€šç”¨æˆ·æ˜¯æ²¡æœ‰è¿™ä¸ªæƒé™çš„ã€‚ä½†æ˜¯å®é™…ä¸Šæ™®é€šç”¨æˆ·åˆå¯ä»¥ä¿®æ”¹è‡ªå·±çš„å¯†ç ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿåœ¨ Linux çš„æƒé™æ§åˆ¶æœºåˆ¶ä¸­ï¼Œæœ‰ä¸€ç±»æ¯”è¾ƒç‰¹æ®Šçš„æƒé™è®¾ç½®ï¼Œæ¯”å¦‚ SUID(Set User ID on execution)ï¼Œå…è®¸ç”¨æˆ·ä»¥å¯æ‰§è¡Œæ–‡ä»¶çš„ owner çš„æƒé™æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ã€‚å› ä¸ºç¨‹åºæ–‡ä»¶ <code>/bin/passwd</code> è¢«è®¾ç½®äº† <code>SUID</code> æ ‡è¯†ï¼Œæ‰€ä»¥æ™®é€šç”¨æˆ·åœ¨æ‰§è¡Œ passwd å‘½ä»¤æ—¶ï¼Œè¿›ç¨‹æ˜¯ä»¥ passwd çš„æ‰€æœ‰è€…ï¼Œä¹Ÿå°±æ˜¯ root ç”¨æˆ·çš„èº«ä»½è¿è¡Œï¼Œä»è€Œå°±å¯ä»¥ä¿®æ”¹å¯†ç äº†ã€‚</p>
<p>ä½†æ˜¯ä½¿ç”¨ <code>SUID</code> å´å¸¦æ¥äº†æ–°çš„å®‰å…¨éšæ‚£ï¼Œå½“æˆ‘ä»¬è¿è¡Œè®¾ç½®äº† <code>SUID</code> çš„å‘½ä»¤æ—¶ï¼Œé€šå¸¸åªæ˜¯éœ€è¦å¾ˆå°ä¸€éƒ¨åˆ†çš„ç‰¹æƒï¼Œä½†æ˜¯ <code>SUID</code> å´ç»™äº†å®ƒ root å…·æœ‰çš„å…¨éƒ¨æƒé™ï¼Œä¸€æ—¦ è¢«è®¾ç½®äº† <code>SUID</code> çš„å‘½ä»¤å‡ºç°æ¼æ´ï¼Œæ˜¯ä¸æ˜¯å°±å¾ˆå®¹æ˜“è¢«åˆ©ç”¨äº†ã€‚</p>
<p>ä¸ºæ­¤ Linux å¼•å…¥äº† <code>Capabilities</code> æœºåˆ¶æ¥å¯¹ root æƒé™è¿›è¡Œäº†æ›´åŠ ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œå®ç°æŒ‰éœ€è¿›è¡Œæˆæƒï¼Œè¿™æ ·å°±å¤§å¤§å‡å°äº†ç³»ç»Ÿçš„å®‰å…¨éšæ‚£ã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯-Capabilities"><a href="#ä»€ä¹ˆæ˜¯-Capabilities" class="headerlink" title="ä»€ä¹ˆæ˜¯ Capabilities"></a>ä»€ä¹ˆæ˜¯ Capabilities</h3><p>ä»å†…æ ¸ 2.2 å¼€å§‹ï¼ŒLinux å°†ä¼ ç»Ÿä¸Šä¸è¶…çº§ç”¨æˆ· root å…³è”çš„ç‰¹æƒåˆ’åˆ†ä¸ºä¸åŒçš„å•å…ƒï¼Œç§°ä¸º <code>capabilites</code>ã€‚<code>Capabilites</code> æ¯ä¸ªå•å…ƒéƒ½å¯ä»¥ç‹¬ç«‹å¯ç”¨å’Œç¦ç”¨ã€‚è¿™æ ·å½“ç³»ç»Ÿåœ¨ä½œæƒé™æ£€æŸ¥çš„æ—¶å€™å°±å˜æˆäº†ï¼šåœ¨æ‰§è¡Œç‰¹æƒæ“ä½œæ—¶ï¼Œå¦‚æœè¿›ç¨‹çš„æœ‰æ•ˆèº«ä»½ä¸æ˜¯ <strong>root</strong>ï¼Œå°±å»æ£€æŸ¥æ˜¯å¦å…·æœ‰è¯¥ç‰¹æƒæ“ä½œæ‰€å¯¹åº”çš„ <strong>capabilites</strong>ï¼Œå¹¶ä»¥æ­¤å†³å®šæ˜¯å¦å¯ä»¥è¿›è¡Œè¯¥ç‰¹æƒæ“ä½œã€‚æ¯”å¦‚å¦‚æœæˆ‘ä»¬è¦è®¾ç½®ç³»ç»Ÿæ—¶é—´ï¼Œå°±å¾—å…·æœ‰ <code>CAP_SYS_TIME</code> è¿™ä¸ª capabilitesã€‚ä¸‹é¢æ˜¯ä» <a href="http://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank" rel="external">capabilities man page</a> ä¸­æ‘˜å–çš„ capabilites åˆ—è¡¨ï¼š<br><img src="/images/capabilities.png" alt="capabilities"></p>
<h3 id="å¦‚ä½•ä½¿ç”¨-Capabilities"><a href="#å¦‚ä½•ä½¿ç”¨-Capabilities" class="headerlink" title="å¦‚ä½•ä½¿ç”¨ Capabilities"></a>å¦‚ä½•ä½¿ç”¨ Capabilities</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>getcap</code> å’Œ <code>setcap</code> ä¸¤æ¡å‘½ä»¤æ¥åˆ†åˆ«æŸ¥çœ‹å’Œè®¾ç½®ç¨‹åºæ–‡ä»¶çš„ <code>capabilities</code> å±æ€§ã€‚æ¯”å¦‚å½“å‰æˆ‘ä»¬æ˜¯<code>zuiapp</code> è¿™ä¸ªç”¨æˆ·ï¼Œä½¿ç”¨ <code>getcap</code> å‘½ä»¤æŸ¥çœ‹ <code>ping</code> å‘½ä»¤ç›®å‰å…·æœ‰çš„ <code>capabilities</code>ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">â¯ ll /bin/ping</span><br><span class="line">-rwxr-xr-x 1 root root 62088 11æœˆ  7 2016 /bin/ping</span><br><span class="line">â¯ <span class="built_in">getcap</span> /bin/ping</span><br><span class="line">/bin/ping = <span class="built_in">cap</span>_net_admin,<span class="built_in">cap</span>_net_raw+p</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…·æœ‰ <code>cap_net_admin</code> è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨å¯ä»¥æ‰§è¡Œ <code>ping</code> å‘½ä»¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">â¯ ping team.jiunile.com</span><br><span class="line">PING icyxp.github.io (185.199.109.153): 56 data bytes</span><br><span class="line">64 bytes from 185.199.109.153: icmp_seq=0 ttl=58 time=46.651 ms</span><br><span class="line">64 bytes from 185.199.109.153: icmp_seq=1 ttl=58 time=35.604 ms</span><br></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬æŠŠå‘½ä»¤çš„ <code>capabilities</code> å±æ€§ç§»é™¤æ‰ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â¯ sudo <span class="built_in">setcap</span> <span class="built_in">cap</span>_net_admin,<span class="built_in">cap</span>_net_raw-p /bin/ping</span><br><span class="line">â¯ <span class="built_in">getcap</span> /bin/ping</span><br><span class="line">/bin/ping =</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ‰§è¡Œ <code>ping</code> å‘½ä»¤å¯ä»¥å‘ç°å·²ç»æ²¡æœ‰æƒé™äº†ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">â¯ ping team.jiunile.com</span><br><span class="line">ping: socket: Operation not permitted</span><br></pre></td></tr></table></figure></p>
<p>å› ä¸º ping å‘½ä»¤åœ¨æ‰§è¡Œæ—¶éœ€è¦è®¿é—®ç½‘ç»œï¼Œæ‰€éœ€çš„ <code>capabilities</code> ä¸º <code>cap_net_admin</code> å’Œ <code>cap_net_raw</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>setcap</code> å‘½ä»¤å¯æ¥æ·»åŠ å®ƒä»¬ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â¯ sudo <span class="built_in">setcap</span> <span class="built_in">cap</span>_net_admin,<span class="built_in">cap</span>_net_raw+p /bin/ping</span><br><span class="line">â¯ <span class="built_in">getcap</span> /bin/ping</span><br><span class="line">/bin/ping = <span class="built_in">cap</span>_net_admin,<span class="built_in">cap</span>_net_raw+p</span><br><span class="line">â¯ ping team.jiunile.com</span><br><span class="line">PING icyxp.github.io (185.199.109.153): 56 data bytes</span><br><span class="line">64 bytes from 185.199.109.153: icmp_seq=0 ttl=58 time=46.651 ms</span><br><span class="line">64 bytes from 185.199.109.153: icmp_seq=1 ttl=58 time=35.604 ms</span><br></pre></td></tr></table></figure></p>
<p>å‘½ä»¤ä¸­çš„ <code>p</code> è¡¨ç¤º <code>Permitted</code> é›†åˆ(æ¥ä¸‹æ¥ä¼šä»‹ç»)ï¼Œ<code>+</code> å·è¡¨ç¤ºæŠŠæŒ‡å®šçš„ <code>capabilities</code> æ·»åŠ åˆ°è¿™äº›é›†åˆä¸­ï¼Œ<code>-</code> å·è¡¨ç¤ºä»é›†åˆä¸­ç§»é™¤ã€‚</p>
<p>å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶çš„å±æ€§ä¸­æœ‰ä¸‰ä¸ªé›†åˆæ¥ä¿å­˜ä¸‰ç±» <code>capabilities</code>ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>Permittedï¼šåœ¨è¿›ç¨‹æ‰§è¡Œæ—¶ï¼ŒPermitted é›†åˆä¸­çš„ capabilites è‡ªåŠ¨è¢«åŠ å…¥åˆ°è¿›ç¨‹çš„ Permitted é›†åˆä¸­ã€‚</li>
<li>Inheritableï¼šInheritable é›†åˆä¸­çš„ capabilites ä¼šä¸è¿›ç¨‹çš„ Inheritable é›†åˆæ‰§è¡Œä¸æ“ä½œï¼Œä»¥ç¡®å®šè¿›ç¨‹åœ¨æ‰§è¡Œ execve å‡½æ•°åå“ªäº› capabilites è¢«ç»§æ‰¿ã€‚</li>
<li>Effectiveï¼šEffective åªæ˜¯ä¸€ä¸ª bitã€‚å¦‚æœè®¾ç½®ä¸ºå¼€å¯ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œ execve å‡½æ•°åï¼ŒPermitted é›†åˆä¸­æ–°å¢çš„ capabilities ä¼šè‡ªåŠ¨å‡ºç°åœ¨è¿›ç¨‹çš„ Effective é›†åˆä¸­ã€‚</li>
</ul>
<p>å¯¹äºè¿›ç¨‹ä¸­æœ‰äº”ç§ <code>capabilities</code> é›†åˆç±»å‹ï¼Œç›¸æ¯”æ–‡ä»¶çš„ <code>capabilites</code>ï¼Œè¿›ç¨‹çš„ <code>capabilities</code> å¤šäº†ä¸¤ä¸ªé›†åˆï¼Œåˆ†åˆ«æ˜¯ <code>Bounding</code> å’Œ <code>Ambient</code>ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½åæ¥æŸ¥çœ‹å½“å‰è¿›ç¨‹çš„ <code>capabilities</code> ä¿¡æ¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">â¯ cat /proc/7029/status | grep <span class="string">'Cap'</span>  <span class="comment">#7029ä¸ºPID</span></span><br><span class="line">CapInh:	0000000000000000</span><br><span class="line">CapPrm:	0000000000000000</span><br><span class="line">CapEff:	0000000000000000</span><br><span class="line">CapBnd:	0000001fffffffff</span><br><span class="line">CapAmb:	0000000000000000</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>capsh</code> å‘½ä»¤æŠŠå®ƒä»¬è½¬ä¹‰ä¸ºå¯è¯»çš„æ ¼å¼ï¼Œè¿™æ ·åŸºæœ¬å¯ä»¥çœ‹å‡ºè¿›ç¨‹å…·æœ‰çš„ <code>capabilities</code> äº†ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">â¯ capsh --decode=0000001fffffffff</span><br><span class="line">0x0000001fffffffff=<span class="built_in">cap</span>_chown,<span class="built_in">cap</span>_dac_override,<span class="built_in">cap</span>_dac_<span class="built_in">read</span>_search,<span class="built_in">cap</span>_fowner,<span class="built_in">cap</span>_fsetid,<span class="built_in">cap</span>_<span class="built_in">kill</span>,<span class="built_in">cap</span>_setgid,<span class="built_in">cap</span>_setuid,<span class="built_in">cap</span>_setpcap,<span class="built_in">cap</span>_linux_immutable,<span class="built_in">cap</span>_net_<span class="built_in">bind</span>_service,<span class="built_in">cap</span>_net_broadcast,<span class="built_in">cap</span>_net_admin,<span class="built_in">cap</span>_net_raw,<span class="built_in">cap</span>_ipc_lock,<span class="built_in">cap</span>_ipc_owner,<span class="built_in">cap</span>_sys_module,<span class="built_in">cap</span>_sys_rawio,<span class="built_in">cap</span>_sys_chroot,<span class="built_in">cap</span>_sys_ptrace,<span class="built_in">cap</span>_sys_pacct,<span class="built_in">cap</span>_sys_admin,<span class="built_in">cap</span>_sys_boot,<span class="built_in">cap</span>_sys_nice,<span class="built_in">cap</span>_sys_resource,<span class="built_in">cap</span>_sys_time,<span class="built_in">cap</span>_sys_tty_config,<span class="built_in">cap</span>_mknod,<span class="built_in">cap</span>_lease,<span class="built_in">cap</span>_audit_write,<span class="built_in">cap</span>_audit_control,<span class="built_in">cap</span>_setfcap,<span class="built_in">cap</span>_mac_override,<span class="built_in">cap</span>_mac_admin,<span class="built_in">cap</span>_syslog,35,36</span><br></pre></td></tr></table></figure></p>
<h2 id="Docker-Container-Capabilities"><a href="#Docker-Container-Capabilities" class="headerlink" title="Docker Container Capabilities"></a>Docker Container Capabilities</h2><p>æˆ‘ä»¬è¯´ Docker å®¹å™¨æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥ç†è®ºä¸Šå®¹å™¨å°±ä¼šå’Œè¿›ç¨‹ä¸€æ ·ä¼šæœ‰ä¸€äº›é»˜è®¤çš„å¼€æ”¾æƒé™ï¼Œé»˜è®¤æƒ…å†µä¸‹ Docker ä¼šåˆ é™¤å¿…é¡»çš„ <code>capabilities</code> ä¹‹å¤–çš„æ‰€æœ‰ <code>capabilities</code>ï¼Œå› ä¸ºåœ¨å®¹å™¨ä¸­æˆ‘ä»¬ç»å¸¸ä¼šä»¥ root ç”¨æˆ·æ¥è¿è¡Œï¼Œä½¿ç”¨ <code>capabilities</code> ç°åœ¨åï¼Œå®¹å™¨ä¸­çš„ä½¿ç”¨çš„ root ç”¨æˆ·æƒé™å°±æ¯”æˆ‘ä»¬å¹³æ—¶åœ¨å®¿ä¸»æœºä¸Šä½¿ç”¨çš„ root ç”¨æˆ·æƒé™è¦å°‘å¾ˆå¤šäº†ï¼Œè¿™æ ·å³ä½¿å‡ºç°äº†å®‰å…¨æ¼æ´ï¼Œä¹Ÿå¾ˆéš¾ç ´åæˆ–è€…è·å–å®¿ä¸»æœºçš„ root æƒé™ï¼Œæ‰€ä»¥ Docker æ”¯æŒ <code>Capabilities</code> å¯¹äºå®¹å™¨çš„å®‰å…¨æ€§æ¥è¯´æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚</p>
<p>ä¸è¿‡æˆ‘ä»¬åœ¨è¿è¡Œå®¹å™¨çš„æ—¶å€™å¯ä»¥é€šè¿‡æŒ‡å®š <code>--privileded</code> å‚æ•°æ¥å¼€å¯å®¹å™¨çš„è¶…çº§æƒé™ï¼Œè¿™ä¸ªå‚æ•°ä¸€å®šè¦æ…ç”¨ï¼Œå› ä¸ºä»–ä¼šè·å–ç³»ç»Ÿ root ç”¨æˆ·æ‰€æœ‰èƒ½åŠ›èµ‹å€¼ç»™å®¹å™¨ï¼Œå¹¶ä¸”ä¼šæ‰«æå®¿ä¸»æœºçš„æ‰€æœ‰è®¾å¤‡æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ï¼Œæ‰€ä»¥æ˜¯éå¸¸å±é™©çš„æ“ä½œã€‚</p>
<p>ä½†æ˜¯å¦‚æœä½ ç¡®å®éœ€è¦ä¸€äº›ç‰¹æ®Šçš„æƒé™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>--cap-add</code> å’Œ <code>--cap-drop</code> è¿™ä¸¤ä¸ªå‚æ•°æ¥åŠ¨æ€è°ƒæ•´ï¼Œå¯ä»¥æœ€å¤§é™åº¦åœ°ä¿è¯å®¹å™¨çš„ä½¿ç”¨å®‰å…¨ã€‚ä¸‹é¢è¡¨æ ¼ä¸­åˆ—å‡ºçš„ <code>Capabilities</code> æ˜¯ Docker é»˜è®¤ç»™å®¹å™¨æ·»åŠ çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>--cap-drop</code> å»é™¤å…¶ä¸­ä¸€ä¸ªæˆ–è€…å¤šä¸ªï¼š<br><img src="/images/docker-add-capabilities.png" alt="docker-add-capabilities"></p>
<p>ä¸‹é¢è¡¨æ ¼ä¸­åˆ—å‡ºçš„ <code>Capabilities</code> æ˜¯ Docker é»˜è®¤åˆ é™¤çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>--cap-add</code>æ·»åŠ å…¶ä¸­ä¸€ä¸ªæˆ–è€…å¤šä¸ªï¼š<br><img src="/images/docker-drop-capabilities.png" alt="docker-drop-capabilities"></p>
<blockquote>
<p><code>--cap-add</code>å’Œ<code>--cap-drop</code> è¿™ä¸¤å‚æ•°éƒ½æ”¯æŒ<code>ALL</code>å€¼ï¼Œæ¯”å¦‚å¦‚æœä½ æƒ³è®©æŸä¸ªå®¹å™¨æ‹¥æœ‰é™¤äº†<code>MKNOD</code>ä¹‹å¤–çš„æ‰€æœ‰å†…æ ¸æƒé™ï¼Œé‚£ä¹ˆå¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š <code>$ sudo docker run --cap-add=ALL --cap-drop=MKNOD ...</code></p>
</blockquote>
<p>æ¯”å¦‚ç°åœ¨æˆ‘ä»¬éœ€è¦ä¿®æ”¹ç½‘ç»œæ¥å£æ•°æ®ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯æ²¡æœ‰æƒé™çš„ï¼Œå› ä¸ºéœ€è¦çš„ <code>NET_ADMIN</code> è¿™ä¸ª <code>Capabilities</code> é»˜è®¤è¢«ç§»é™¤äº†ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">â¯ docker run -it --rm busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ip link add dummy0 type dummy</span></span><br><span class="line">ip: RTNETLINK answers: Operation not permitted</span><br><span class="line">/ <span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥åœ¨ä¸ä½¿ç”¨ <code>--privileged</code> çš„æƒ…å†µä¸‹ï¼ˆä¸å»ºè®®ï¼‰æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>--cap-add=NET_ADMIN</code> å°†è¿™ä¸ª <code>Capabilities</code> æ·»åŠ å›æ¥ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â¯ docker run -it --rm --cap-add=NET_ADMIN busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ip link add dummy0 type dummy</span></span><br><span class="line">/ <span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°å·²ç» OK äº†ã€‚</p>
<h2 id="Kubernetes-é…ç½®-Capabilities"><a href="#Kubernetes-é…ç½®-Capabilities" class="headerlink" title="Kubernetes é…ç½® Capabilities"></a>Kubernetes é…ç½® Capabilities</h2><p>ä¸Šé¢æˆ‘ä»‹ç»äº†åœ¨ Docker å®¹å™¨ä¸‹å¦‚ä½•æ¥é…ç½® <code>Capabilities</code>ï¼Œåœ¨ Kubernetes ä¸­ä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿çš„æ¥å®šä¹‰ï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ åˆ° Pod å®šä¹‰çš„ <code>spec.containers.sercurityContext.capabilities</code>ä¸­å³å¯ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œ <code>add</code> å’Œ <code>drop</code> é…ç½®ï¼ŒåŒæ ·ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬è¦ç»™ busybox å®¹å™¨æ·»åŠ  <code>NET_ADMIN</code> è¿™ä¸ª <code>Capabilities</code>ï¼Œå¯¹åº”çš„ YAML æ–‡ä»¶å¯ä»¥è¿™æ ·å®šä¹‰ï¼š(cpb-demo.yaml)<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Pod</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> cpb-demo</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> cpb</span><br><span class="line"><span class="attr">    image:</span> busybox</span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">    -</span> sleep</span><br><span class="line"><span class="bullet">    -</span> <span class="string">"3600"</span></span><br><span class="line"><span class="attr">    securityContext:</span></span><br><span class="line"><span class="attr">      capabilities:</span></span><br><span class="line"><span class="attr">        add:</span> <span class="comment"># æ·»åŠ </span></span><br><span class="line"><span class="bullet">        -</span> NET_ADMIN</span><br><span class="line"><span class="attr">        drop:</span>  <span class="comment"># åˆ é™¤</span></span><br><span class="line"><span class="bullet">        -</span> KILL</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬åœ¨ <code>securityContext</code> ä¸‹é¢æ·»åŠ äº† <code>capabilities</code> å­—æ®µï¼Œå…¶ä¸­æ·»åŠ äº† <code>NET_ADMIN</code> å¹¶ä¸”åˆ é™¤äº† <code>KILL</code> è¿™ä¸ªé»˜è®¤çš„å®¹å™¨ <code>Capabilities</code>ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ Pod ä¸­ä¿®æ”¹ç½‘ç»œæ¥å£æ•°æ®äº†ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â¯ kubectl apply <span class="_">-f</span> cpb-demo.yaml</span><br><span class="line">â¯ kubectl get pods</span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">cpb-demo                  1/1     Running   0          2m9s</span><br><span class="line">â¯ kubectl <span class="built_in">exec</span> -it cpb-demo /bin/sh</span><br><span class="line">/ <span class="comment"># ip link add dummy0 type dummy</span></span><br><span class="line">/ <span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<p>åœ¨ Kubernetes ä¸­é€šè¿‡ <code>sercurityContext.capabilities</code> è¿›è¡Œé…ç½®å®¹å™¨çš„ <code>Capabilities</code>ï¼Œå½“ç„¶æœ€ç»ˆè¿˜æ˜¯é€šè¿‡ Docker çš„ <code>libcontainer</code> å»å€ŸåŠ© <code>Linux kernel capabilities</code> å®ç°çš„æƒé™ç®¡ç†ã€‚</p>
<h3 id="åº”ç”¨ä¸€ï¼šåœ¨kuberneteså®¹å™¨ä¸­ä½¿ç”¨perfå‘½ä»¤"><a href="#åº”ç”¨ä¸€ï¼šåœ¨kuberneteså®¹å™¨ä¸­ä½¿ç”¨perfå‘½ä»¤" class="headerlink" title="åº”ç”¨ä¸€ï¼šåœ¨kuberneteså®¹å™¨ä¸­ä½¿ç”¨perfå‘½ä»¤"></a>åº”ç”¨ä¸€ï¼šåœ¨kuberneteså®¹å™¨ä¸­ä½¿ç”¨perfå‘½ä»¤</h3><p>åœ¨å®¹å™¨ä¸­è¿è¡Œ <code>perf</code> ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€Error:â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚No permission to <span class="built_in">enable</span> cycles event.                             â”‚</span><br><span class="line">â”‚                                                                  â”‚</span><br><span class="line">â”‚You may not have permission to collect system-wide stats.         â”‚</span><br><span class="line">â”‚                                                                  â”‚</span><br><span class="line">â”‚Consider tweaking /proc/sys/kernel/perf_event_paranoid,           â”‚</span><br><span class="line">â”‚<span class="built_in">which</span> controls use of the performance events system by            â”‚</span><br><span class="line">â”‚unprivileged users (without CAP_SYS_ADMIN).                       â”‚</span><br><span class="line">â”‚                                                                  â”‚</span><br><span class="line">â”‚The current value is 3:                                           â”‚</span><br><span class="line">â”‚                                                                  â”‚</span><br><span class="line">â”‚  -1: Allow use of (almost) all events by all users               â”‚</span><br><span class="line">â”‚&gt;= 0: Disallow raw tracepoint access by users without CAP_IOC_LOCKâ”‚</span><br><span class="line">â”‚&gt;= 1: Disallow CPU event access by users without CAP_SYS_ADMIN    â”‚</span><br><span class="line">â”‚&gt;= 2: Disallow kernel profiling by users without C                â”‚</span><br><span class="line">â”‚                                                                  â”‚</span><br><span class="line">â”‚                                                                  â”‚</span><br><span class="line">â”‚Press any key...                                                  â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure></p>
<p>æç¤ºæ²¡æœ‰æƒé™ï¼Œéœ€è¦æ›´æ”¹ <code>/proc/sys/kernel/perf_event_paranoid</code> æ–‡ä»¶ï¼Œç„¶åå°è¯•æ‰§è¡Œ:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/perf_event_paranoid</span><br><span class="line">bash: /proc/sys/kernel/perf_event_paranoid: Read-only file system</span><br></pre></td></tr></table></figure></p>
<p>è§£å†³åŠæ³•ï¼Œä¿®æ”¹å®¹å™¨çš„deploymentæ–‡ä»¶ï¼ŒåŠ å…¥ <code>SYS_ADMIN</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">securityContext:</span></span><br><span class="line"><span class="attr">    capabilities:</span></span><br><span class="line"><span class="attr">        add:</span> [<span class="string">"SYS_ADMIN"</span>]</span><br></pre></td></tr></table></figure></p>
<p>å‚è€ƒé“¾æ¥:</p>
<ul>
<li><a href="https://www.cnblogs.com/sparkdev/p/11417781.html" target="_blank" rel="external">https://www.cnblogs.com/sparkdev/p/11417781.html</a></li>
<li><a href="https://hustcat.github.io/docker-config-capabilities/" target="_blank" rel="external">https://hustcat.github.io/docker-config-capabilities/</a></li>
<li><a href="https://blog.csdn.net/WaltonWang/article/details/62226738" target="_blank" rel="external">https://blog.csdn.net/WaltonWang/article/details/62226738</a></li>
<li><a href="http://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank" rel="external">http://man7.org/linux/man-pages/man7/capabilities.7.html</a></li>
<li>www.qikqiak.com</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[golangå¦‚ä½•å–æ¶ˆå­ goroutine]]></title>
      <url>http://team.jiunile.com/blog/2019/09/go-cancellation-of-goroutines.html</url>
      <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>ä¹‹å‰å†™äº†ä¸ªå·¥å…·ï¼Œç”¨äºæ£€æµ‹gitlab runneræ˜¯å¦èƒ½æ‰¿å—ä½å½“å‰runner jobçš„æ„å»ºï¼Œæ ¹æ®Prometheusçš„ç›‘æ§ï¼Œåœ¨èµ„æºä½¿ç”¨è¿‡è½½çš„æƒ…å†µä¸‹ï¼Œå°±ä¸´æœŸå¯åŠ¨æœåŠ¡å™¨åŠ å…¥åˆ°é›†ç¾¤ä¸­ç”¨äºåˆ†æ‹…runner jobæ„å»ºæ—¶çš„å‹åŠ›ã€‚åœ¨è¿è¡Œä¸€æ®µæ—¶é—´åå‘ç°å†…å­˜æœ‰æ—¶å ç”¨æœ‰ç‚¹é«˜ï¼ˆ<code>goroutine</code>è¿‡å¤šï¼‰ï¼Œäºæ˜¯å°±æœ‰äº†ä¸‹é¢ä¸€æ­¥æ­¥çš„ä¼˜åŒ–ã€‚<br> <a id="more"></a></p>
<h2 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h2><p>é¦–å…ˆæˆ‘ä»¬ä¸€å¼€å§‹æœ‰ä»¥ä¸‹ä¸€æ®µä»£ç é€»è¾‘ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    wg sync.WaitGroup</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//å‡è®¾è¿™ä¸ªä»»åŠ¡è¦å¹²1000æ¬¡ï¼Œä¸€æ¬¡ä»»åŠ¡éœ€è¦åš2ç§’å®Œæˆ</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-time.After(<span class="number">2</span> * time.Second):</span><br><span class="line">            fmt.Println(<span class="string">"Doing some work "</span>, i)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Hey, I'm going to do some work"</span>)</span><br><span class="line"></span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> work()</span><br><span class="line">    wg.Wait()</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"Finished. I'm going home"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ go run work.go</span><br><span class="line">Hey, I<span class="string">'m going to do some work</span><br><span class="line">Doing some work  0</span><br><span class="line">Doing some work  1</span><br><span class="line">Doing some work  2</span><br><span class="line">Doing some work  3</span><br><span class="line">...</span><br><span class="line">Doing some work  999</span><br><span class="line">Finished. I'</span>m going home</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨æˆ‘ä»¬å‡è®¾ä¸‹æˆ‘ä»¬è°ƒç”¨çš„<code>work</code>è¿™ä¸ªæ–¹å¼æ˜¯æ¥è‡ªç”¨æˆ·çš„äº¤äº’æˆ–è€…ä¸€ä¸ªhttpè¯·æ±‚ï¼Œæˆ‘ä»¬å¯èƒ½ä¸æƒ³ä¸€ç›´ç­‰å¾…ç›´åˆ°<code>goroutine</code>å®Œæˆï¼Œå› æ­¤ï¼Œå¸¸è§çš„åšæ³•æ˜¯é‡‡ç”¨è¶…æ—¶æœºåˆ¶ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-time.After(<span class="number">2</span> * time.Second):</span><br><span class="line">            fmt.Println(<span class="string">"Doing some work "</span>, i)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Hey, I'm going to do some work"</span>)</span><br><span class="line"></span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        ch &lt;- work()</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> err := &lt;-ch:</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Fatal(<span class="string">"Something went wrong :("</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(<span class="number">4</span> * time.Second):</span><br><span class="line">        fmt.Println(<span class="string">"ç­‰çš„ä¸è€çƒ¦äº†ï¼Œå°±è¿™æ ·å§..."</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"Finished. I'm going home"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœå¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ go run work.go</span><br><span class="line">Hey, I<span class="string">'m going to do some work</span><br><span class="line">Doing some work  0</span><br><span class="line">Doing some work  1</span><br><span class="line">Life is to short to wait that long</span><br><span class="line">Finished. I'</span>m going home</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨æƒ…å†µæ¯”ä¸Šä¸€ä¸ªå¥½ä¸€äº›ï¼Œmainçš„æ‰§è¡Œä¸åœ¨éœ€è¦ç­‰å¾…workå®Œæˆã€‚</p>
<p>ä½†ä¸Šè¿°ä»£ç è¿˜å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚è¿™æ®µä»£ç å†™åœ¨ä¸€ä¸ªhttpæœåŠ¡ä¸­ï¼Œå³ä½¿åˆ©ç”¨è¶…æ—¶æœºåˆ¶ä¸ç­‰å¾…<code>work</code>çš„å®Œæˆï¼Œä½†<code>work</code> è¿™ä¸ª<code>goroutine</code>è¿˜æ˜¯ä¼šåœ¨åå°ä¸€ç›´è¿è¡Œå¹¶æ¶ˆè€—èµ„æºã€‚è¿™æ—¶å€™å°±éœ€è¦æƒ³ä¸ªåŠæ³•æ¥å–æ¶ˆè¿™ä¸ªå­<code>goroutine</code>ã€‚äºæ˜¯æˆ‘æƒ³åˆ°äº†<code>context</code> è¿™ä¸ªåŒ…ï¼Œäºæ˜¯åˆæœ‰äº†å¦‚ä¸‹çš„ä»£ç <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;sync&quot;</span><br><span class="line">    &quot;time&quot;</span><br><span class="line"></span><br><span class="line">    &quot;golang.org/x/net/context&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var (</span><br><span class="line">    wg sync.WaitGroup</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func work(ctx context.Context) error &#123;</span><br><span class="line">    defer wg.Done()</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; 1000; i++ &#123;</span><br><span class="line">        select &#123;</span><br><span class="line">        case &lt;-time.After(2 * time.Second):</span><br><span class="line">            fmt.Println(&quot;Doing some work &quot;, i)</span><br><span class="line"></span><br><span class="line">        // we received the signal of cancelation in this channel    </span><br><span class="line">        case &lt;-ctx.Done():</span><br><span class="line">            fmt.Println(&quot;Cancel the context &quot;, i)</span><br><span class="line">            return ctx.Err()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;   </span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), 4*time.Second)</span><br><span class="line">    defer cancel()</span><br><span class="line"></span><br><span class="line">    fmt.Println(&quot;Hey, I&apos;m going to do some work&quot;)</span><br><span class="line"></span><br><span class="line">    wg.Add(1)</span><br><span class="line">    go work(ctx)</span><br><span class="line">    wg.Wait()</span><br><span class="line"></span><br><span class="line">    fmt.Println(&quot;Finished. I&apos;m going home&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ go run work.go</span><br><span class="line">Hey, I<span class="string">'m going to do some work</span><br><span class="line">Doing some work  0</span><br><span class="line">Cancel the context  1</span><br><span class="line">Finished. I'</span>m going home</span><br></pre></td></tr></table></figure></p>
<p>è¿™çœ‹ä¸Šå»éå¸¸çš„å¥½ï¼Œä»£ç çœ‹ä¸Šå»ä¹Ÿæ˜“äºç®¡ç†è¶…æ—¶ï¼Œç°åœ¨æˆ‘ä»¬ç¡®ä¿å‡½æ•°æ­£å¸¸å·¥ä½œä¹Ÿä¸ä¼šæµªè´¹ä»»ä½•èµ„æºã€‚ç°åœ¨ä¸ºäº†è®©ä¾‹å­æ›´åŠ çœŸå®ï¼Œæˆ‘ä»¬åœ¨å®é™…çš„httpæœåŠ¡ä¸­æ¥è¿›è¡Œæ¨¡æ‹Ÿã€‚</p>
<p>ä»¥ä¸‹æ˜¯http serverä»£ç ï¼Œæ¨¡æ‹Ÿæœ‰éƒ¨åˆ†æ¦‚ç‡ä¼šæœ‰æ…¢å“åº”ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">// Lazy and Very Random Server </span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"math/rand"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    http.HandleFunc(<span class="string">"/"</span>, LazyServer)</span><br><span class="line">    http.ListenAndServe(<span class="string">":1111"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sometimes really fast server, sometimes really slow server</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LazyServer</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">    headOrTails := rand.Intn(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> headOrTails == <span class="number">0</span> &#123;</span><br><span class="line">        time.Sleep(<span class="number">6</span> * time.Second)</span><br><span class="line">        fmt.Fprintf(w, <span class="string">"Go! slow %v"</span>, headOrTails)</span><br><span class="line">        fmt.Printf(<span class="string">"Go! slow %v"</span>, headOrTails)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Fprintf(w, <span class="string">"Go! quick %v"</span>, headOrTails)</span><br><span class="line">    fmt.Printf(<span class="string">"Go! quick %v"</span>, headOrTails)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨curlæ¥è¯·æ±‚æŸ¥çœ‹ç»“æœï¼›<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://localhost:1111/</span><br><span class="line">Go! quick 1</span><br><span class="line">$ curl http://localhost:1111/</span><br><span class="line">Go! quick 1</span><br><span class="line">$ curl http://localhost:1111/</span><br><span class="line">*some seconds later*</span><br><span class="line">Go! slow 0</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†åœ¨<code>goroutine</code>ä¸­å‘è¯¥æœåŠ¡å™¨å‘å‡ºhttpè¯·æ±‚ï¼Œä½†æ˜¯å¦‚æœæœåŠ¡å™¨é€Ÿåº¦è¾ƒæ…¢ï¼Œæˆ‘ä»¬å°†å–æ¶ˆè¯¥è¯·æ±‚å¹¶å¿«é€Ÿè¿”å›ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ç®¡ç†å–æ¶ˆå¹¶é‡Šæ”¾è¿æ¥ã€‚ ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"io/ioutil"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"golang.org/x/net/context"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    wg sync.WaitGroup</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// main is not changed</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">2</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"Hey, I'm going to do some work"</span>)</span><br><span class="line"></span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> work(ctx)</span><br><span class="line">    wg.Wait()</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"Finished. I'm going home"</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">(ctx context.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line"></span><br><span class="line">    tr := &amp;http.Transport&#123;&#125;</span><br><span class="line">    client := &amp;http.Client&#123;Transport: tr&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// anonymous struct to pack and unpack data in the channel</span></span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">        r   *http.Response</span><br><span class="line">        err error</span><br><span class="line">    &#125;, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    req, _ := http.NewRequest(<span class="string">"GET"</span>, <span class="string">"http://localhost:1111"</span>, <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        resp, err := client.Do(req)</span><br><span class="line">        fmt.Println(<span class="string">"Doing http request is a hard job"</span>)</span><br><span class="line">        pack := <span class="keyword">struct</span> &#123;</span><br><span class="line">            r   *http.Response</span><br><span class="line">            err error</span><br><span class="line">        &#125;&#123;resp, err&#125;</span><br><span class="line">        c &lt;- pack</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">        tr.CancelRequest(req)</span><br><span class="line">        &lt;-c <span class="comment">// Wait for client.Do</span></span><br><span class="line">        fmt.Println(<span class="string">"Cancel the context"</span>)</span><br><span class="line">        <span class="keyword">return</span> ctx.Err()</span><br><span class="line">    <span class="keyword">case</span> ok := &lt;-c:</span><br><span class="line">        err := ok.err</span><br><span class="line">        resp := ok.r</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">"Error "</span>, err)</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">        out, _ := ioutil.ReadAll(resp.Body)</span><br><span class="line">        fmt.Printf(<span class="string">"Server Response: %s\n"</span>, out)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ go run work.go</span><br><span class="line">Hey, I<span class="string">'m going to do some work</span><br><span class="line">Doing http request is a hard job</span><br><span class="line">Server Response: Go! quick 1</span><br><span class="line">Finished. I'</span>m going home</span><br><span class="line"></span><br><span class="line">$ go run work.go</span><br><span class="line">Hey, I<span class="string">'m going to do some work</span><br><span class="line">Doing http request is a hard job</span><br><span class="line">Cancel the context</span><br><span class="line">Finished. I'</span>m going home</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æ‚¨åœ¨è¾“å‡ºä¸­æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬é¿å…äº†æœåŠ¡å™¨çš„ç¼“æ…¢å“åº”ã€‚åœ¨å®¢æˆ·ç«¯ä¸­ï¼Œtcpè¿æ¥å·²å–æ¶ˆï¼Œå› æ­¤ä¸ä¼šå¿™äºç­‰å¾…å“åº”ç¼“æ…¢ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä¼šæµªè´¹èµ„æºã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªä¾‹å­ï¼Œæœ‰ä¸€ä¸ªå¸¸é©»çš„ä»»åŠ¡ï¼Œå³è¦æ§åˆ¶<code>goroutine</code>çš„å¢é•¿ï¼Œåˆéœ€è¦é˜²æ­¢åœ¨<code>goroutine</code>è¶…æ—¶å<code>goroutine</code>åœ¨åå°è¿è¡Œé€ æˆèµ„æºçš„æµªè´¹ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä½•å®ç°ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"golang.org/x/net/context"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//var wg sync.WaitGroup</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">work1</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">//defer wg.Done()</span></span><br><span class="line">	ch &lt;- <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//ä»»åŠ¡è¶…è¿‡3ç§’å°±è¶…æ—¶</span></span><br><span class="line">	ctx, cancel := context.WithTimeout(context.Background(), <span class="number">3</span>*time.Second)</span><br><span class="line">	<span class="keyword">defer</span> cancel()</span><br><span class="line">	chT := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(chT)</span><br><span class="line">		<span class="comment">//å…·ä½“çš„ä»»åŠ¡ï¼Œè¿™é‡Œæ¨¡æ‹Ÿåšçš„ä»»åŠ¡éœ€è¦5ç§’å®Œæˆ</span></span><br><span class="line">		time.Sleep(time.Second * <span class="number">5</span>)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> &lt;-chT:</span><br><span class="line">		fmt.Println(<span class="string">"job1 finsh..."</span>, runtime.NumGoroutine())</span><br><span class="line">	<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">		fmt.Println(<span class="string">"job1 timeout..."</span>, runtime.NumGoroutine())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"job1 exit.."</span>)</span><br><span class="line">	&lt;-ch  <span class="comment">//é‡Šæ”¾chanel</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">work2</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">//defer wg.Done()</span></span><br><span class="line">	ch &lt;- <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">	ctx, cancel := context.WithTimeout(context.Background(), <span class="number">3</span>*time.Second)</span><br><span class="line">	<span class="keyword">defer</span> cancel()</span><br><span class="line">	chT := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(chT)</span><br><span class="line">		<span class="comment">//å…·ä½“çš„ä»»åŠ¡ï¼Œè¿™é‡Œæ¨¡æ‹Ÿåšçš„ä»»åŠ¡éœ€è¦1ç§’å®Œæˆ</span></span><br><span class="line">		time.Sleep(time.Second * <span class="number">1</span>)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> &lt;-chT:</span><br><span class="line">		fmt.Println(<span class="string">"job2 finsh..."</span>, runtime.NumGoroutine())</span><br><span class="line">	<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">		fmt.Println(<span class="string">"job2 timeout..."</span>, runtime.NumGoroutine())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&lt;-ch <span class="comment">//é‡Šæ”¾chanel</span></span><br><span class="line">	fmt.Println(<span class="string">"job2 exit.."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"Hey, I'm going to do some work"</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//æ§åˆ¶goroutineæ•°é‡</span></span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ°¸ä¹…è¿è¡Œ</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="comment">//å› ä¸ºæ˜¯æ°¸ä¹…è¿è¡Œï¼Œæ‰€ä»¥è¿™é‡Œçš„sync.Waitgroupå¯ä»¥ä¸å†éœ€è¦</span></span><br><span class="line">		<span class="comment">//wg.Add(2)</span></span><br><span class="line">		<span class="keyword">go</span> work1(ch)</span><br><span class="line">		<span class="keyword">go</span> work2(ch)</span><br><span class="line">		time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//wg.Wait()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¸Œæœ›ä»¥ä¸Šä¾‹å­å¯ä»¥ç»™ä½ å¸¦æ¥ä¸€äº›å¸®åŠ©ï¼Happy coding gophers!.</p>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Go ç¨‹åºå ç”¨å¤§é‡å†…å­˜é—®é¢˜åˆ†æ]]></title>
      <url>http://team.jiunile.com/blog/2019/09/go-debug-memory.html</url>
      <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>åœ¨è¿è¡Œä¸€æ®µæ—¶é—´çš„goç¨‹åºåå†…å­˜ç«Ÿç„¶è¾¾åˆ°4Gå·¦å³ï¼Œå‡ ä¹å¯ä»¥è‚¯å®šæ˜¯ç”±äºæŸæ®µæ–¹æ³•æ“ä½œä¸è§„èŒƒå¼•èµ·çš„é—®é¢˜ï¼Œäºæ˜¯å¯¹goç¨‹åºè¿›è¡Œåˆ†æ<br><a id="more"></a></p>
<h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>åˆ†æå†…å­˜å…‰é æ‰‹æ’•ä»£ç æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œæ€»è¦å€ŸåŠ©ä¸€äº›å·¥å…·ã€‚Golang <code>pprof</code>æ˜¯Goå®˜æ–¹çš„<code>profiling</code>å·¥å…·ï¼Œéå¸¸å¼ºå¤§ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚</p>
<p>ä»£ç æ”¹é€ ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="string">"net/http/pprof"</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.ListenAndServe(<span class="string">"0.0.0.0:8888"</span>, <span class="literal">nil</span>)</span><br><span class="line"> &#125;()</span><br></pre></td></tr></table></figure></p>
<p>æ”¹é€ åç¨‹åºå¯åŠ¨åï¼Œæµè§ˆå™¨ä¸­è¾“å…¥<a href="http://ip:8899/debug/pprof/å°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ±‡æ€»åˆ†æé¡µé¢ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š" target="_blank" rel="external">http://ip:8899/debug/pprof/å°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ±‡æ€»åˆ†æé¡µé¢ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/debug/pprof/</span><br><span class="line"></span><br><span class="line">profiles:</span><br><span class="line">0    block</span><br><span class="line">32    goroutine</span><br><span class="line">552    heap</span><br><span class="line">0    mutex</span><br><span class="line">51    threadcreate</span><br><span class="line"></span><br><span class="line">full goroutine stack dump</span><br></pre></td></tr></table></figure></p>
<p>ç‚¹å‡»heapï¼Œåœ¨æ±‡æ€»åˆ†æé¡µé¢çš„æœ€ä¸Šæ–¹å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¢è‰²ç®­å¤´æ‰€æŒ‡çš„å°±æ˜¯å½“å‰å·²ç»ä½¿ç”¨çš„å †å†…å­˜æ˜¯25Mï¼ï¼<br><img src="/images/go/debug_memory_1.png" alt="å†…å­˜åˆ†æ"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©<code>go tool pprof</code>æ¥åˆ†æï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof -inuse_space http://æœ¬æœºIp:8888/debug/pprof/heap</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªå‘½ä»¤è¿›å…¥åï¼Œæ˜¯ä¸€ä¸ªç±»ä¼¼<code>gdb</code>çš„äº¤äº’å¼ç•Œé¢ï¼Œè¾“å…¥ <code>top</code> å‘½ä»¤å¯ä»¥å‰10å¤§çš„å†…å­˜åˆ†é…ï¼Œ<code>flat</code> æ˜¯å †æ ˆä¸­å½“å‰å±‚çš„inuseå†…å­˜å€¼ï¼Œcumæ˜¯å †æ ˆä¸­æœ¬å±‚çº§çš„ç´¯è®¡inuseå†…å­˜å€¼ï¼ˆåŒ…æ‹¬è°ƒç”¨çš„å‡½æ•°çš„inuseå†…å­˜å€¼ï¼Œä¸Šé¢çš„å±‚çº§ï¼‰<br><img src="/images/go/debug_memory_2.png" alt="å†…å­˜åˆ†æ"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>bytes.makeSlice</code>è¿™ä¸ªå†…ç½®æ–¹æ³•ç«Ÿç„¶ä½¿ç”¨äº†24Må†…å­˜ï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°<code>ReadFrom</code>è¿™ä¸ªæ–¹æ³•ï¼Œæœäº†ä¸€ä¸‹ï¼Œå‘ç° <code>ioutil.ReadAll()</code> é‡Œä¼šè°ƒç”¨ <code>bytes.Buffer.ReadFrom</code>, è€Œ <code>bytes.Buffer.ReadFrom</code> ä¼šè¿›è¡Œ <code>makeSlice</code>ã€‚å†å›å¤´çœ‹ä¸€ä¸‹<code>io/ioutil.readAll</code>çš„ä»£ç å®ç°ï¼Œ<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readAll</span><span class="params">(r io.Reader, capacity <span class="keyword">int64</span>)</span> <span class="params">(b []<span class="keyword">byte</span>, err error)</span></span> &#123;</span><br><span class="line">    buf := bytes.NewBuffer(<span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">0</span>, capacity))</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        e := <span class="built_in">recover</span>()</span><br><span class="line">        <span class="keyword">if</span> e == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> panicErr, ok := e.(error); ok &amp;&amp; panicErr == bytes.ErrTooLarge &#123;</span><br><span class="line">            err = panicErr</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    _, err = buf.ReadFrom(r)</span><br><span class="line">    <span class="keyword">return</span> buf.Bytes(), err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// bytes.MinRead = 512</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadAll</span><span class="params">(r io.Reader)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> readAll(r, bytes.MinRead)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>ioutil.ReadAll</code> æ¯æ¬¡éƒ½ä¼šåˆ†é…åˆå§‹åŒ–ä¸€ä¸ªå¤§å°ä¸º <code>bytes.MinRead</code> çš„ buffer ï¼Œ<code>bytes.MinRead</code> åœ¨ Golang é‡Œæ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå€¼ä¸º <code>512</code> ã€‚å°±æ˜¯è¯´æ¯æ¬¡è°ƒç”¨ <code>ioutil.ReadAll</code> éƒ½ä¼šåˆ†é…ä¸€å—å¤§å°ä¸º <code>512</code> å­—èŠ‚çš„å†…å­˜ï¼Œç›®å‰çœ‹èµ·æ¥æ˜¯æ­£å¸¸çš„ï¼Œä½†æˆ‘ä»¬å†çœ‹ä¸€ä¸‹<code>ReadFrom</code>çš„å®ç°ï¼Œ<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReadFrom reads data from r until EOF and appends it to the buffer, growing</span></span><br><span class="line"><span class="comment">// the buffer as needed. The return value n is the number of bytes read. Any</span></span><br><span class="line"><span class="comment">// error except io.EOF encountered during the read is also returned. If the</span></span><br><span class="line"><span class="comment">// buffer becomes too large, ReadFrom will panic with ErrTooLarge.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">ReadFrom</span><span class="params">(r io.Reader)</span> <span class="params">(n <span class="keyword">int64</span>, err error)</span></span> &#123;</span><br><span class="line">    b.lastRead = opInvalid</span><br><span class="line">    <span class="comment">// If buffer is empty, reset to recover space.</span></span><br><span class="line">    <span class="keyword">if</span> b.off &gt;= <span class="built_in">len</span>(b.buf) &#123;</span><br><span class="line">        b.Truncate(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> free := <span class="built_in">cap</span>(b.buf) - <span class="built_in">len</span>(b.buf); free &lt; MinRead &#123;</span><br><span class="line">            <span class="comment">// not enough space at end</span></span><br><span class="line">            newBuf := b.buf</span><br><span class="line">            <span class="keyword">if</span> b.off+free &lt; MinRead &#123;</span><br><span class="line">                <span class="comment">// not enough space using beginning of buffer;</span></span><br><span class="line">                <span class="comment">// double buffer capacity</span></span><br><span class="line">                newBuf = makeSlice(<span class="number">2</span>*<span class="built_in">cap</span>(b.buf) + MinRead)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">copy</span>(newBuf, b.buf[b.off:])</span><br><span class="line">            b.buf = newBuf[:<span class="built_in">len</span>(b.buf)-b.off]</span><br><span class="line">            b.off = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        m, e := r.Read(b.buf[<span class="built_in">len</span>(b.buf):<span class="built_in">cap</span>(b.buf)])</span><br><span class="line">        b.buf = b.buf[<span class="number">0</span> : <span class="built_in">len</span>(b.buf)+m]</span><br><span class="line">        n += <span class="keyword">int64</span>(m)</span><br><span class="line">        <span class="keyword">if</span> e == io.EOF &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> n, e</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n, <span class="literal">nil</span> <span class="comment">// err is EOF, so return nil explicitly</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªå‡½æ•°ä¸»è¦ä½œç”¨å°±æ˜¯ä» <code>io.Reader</code> é‡Œè¯»å–çš„æ•°æ®æ”¾å…¥ <code>buffer</code> ä¸­ï¼Œå¦‚æœ buffer ç©ºé—´ä¸å¤Ÿï¼Œå°±æŒ‰ç…§æ¯æ¬¡ <code>2x + MinRead</code> çš„ç®—æ³•é€’å¢ï¼Œè¿™é‡Œ <code>MinRead</code> çš„å¤§å°ä¹Ÿæ˜¯ 512 Bytes ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬ä¸€æ¬¡æ€§è¯»å–çš„æ–‡ä»¶è¿‡å¤§ï¼Œå°±ä¼šå¯¼è‡´æ‰€ä½¿ç”¨çš„å†…å­˜å€å¢ï¼Œå‡è®¾æˆ‘ä»¬çš„çˆ¬è™«æ–‡ä»¶æ€»å…±æœ‰500M,é‚£ä¹ˆæ‰€ç”¨çš„å†…å­˜å°±æœ‰500M * 2 + 512Bï¼Œå†µä¸”çˆ¬è™«æ–‡ä»¶ä¸­è¿˜å¸¦äº†é‚£ä¹ˆå¤šlogæ–‡ä»¶ï¼Œé‚£çœ‹çœ‹crawlabæºç ä¸­æ˜¯å“ªä¸€æ®µä½¿ç”¨<code>ioutil.ReadAll</code>è¯»äº†çˆ¬è™«æ–‡ä»¶ï¼Œå®šä½åˆ°äº†è¿™é‡Œï¼š<br><img src="/images/go/debug_memory_3.jpg" alt="å†…å­˜åˆ†æ"></p>
<p>è¿™é‡Œç›´æ¥å°†å…¨éƒ¨çš„æ–‡ä»¶å†…å®¹ï¼Œä»¥äºŒè¿›åˆ¶çš„å½¢å¼è¯»äº†è¿›æ¥ï¼Œå¯¼è‡´å†…å­˜å€å¢ï¼Œä»¤äººçª’æ¯çš„æ“ä½œã€‚</p>
<h2 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h2><p>å…¶å®åœ¨è¯»å¤§æ–‡ä»¶çš„æ—¶å€™ï¼ŒæŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»åˆ°å†…å­˜ï¼Œç›´æ¥å°±ç¿»è½¦äº†ï¼Œæ­£ç¡®æ˜¯å¤„ç†æ–¹æ³•æœ‰ä¸¤ç§</p>
<h3 id="æµå¼å¤„ç†"><a href="#æµå¼å¤„ç†" class="headerlink" title="æµå¼å¤„ç†"></a>æµå¼å¤„ç†</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFile</span><span class="params">(filePath <span class="keyword">string</span>, handle <span class="keyword">func</span>(<span class="keyword">string</span>)</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">    f, err := os.Open(filePath)</span><br><span class="line">    <span class="keyword">defer</span> f.Close()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    buf := bufio.NewReader(f)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        line, err := buf.ReadLine(<span class="string">"\n"</span>)</span><br><span class="line">        line = strings.TrimSpace(line)</span><br><span class="line">        handle(line)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> err == io.EOF&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åˆ†ç‰‡å¤„ç†"><a href="#åˆ†ç‰‡å¤„ç†" class="headerlink" title="åˆ†ç‰‡å¤„ç†"></a>åˆ†ç‰‡å¤„ç†</h3><blockquote>
<p>å½“è¯»å–çš„æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ²¡æœ‰æ¢è¡Œç¬¦çš„æ—¶å€™ï¼Œä½¿ç”¨è¿™ç§æ–¹æ¡ˆæ¯”è¾ƒåˆé€‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadBigFile</span><span class="params">(fileName <span class="keyword">string</span>, handle <span class="keyword">func</span>([]<span class="keyword">byte</span>)</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">    f, err := os.Open(fileName)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"can't opened this file"</span>)</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> f.Close()</span><br><span class="line">    s := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">4096</span>)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> nr, err := f.Read(s[:]); <span class="literal">true</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> nr &lt; <span class="number">0</span>:</span><br><span class="line">            fmt.Fprintf(os.Stderr, <span class="string">"cat: error reading: %s\n"</span>, err.Error())</span><br><span class="line">            os.Exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">case</span> nr == <span class="number">0</span>: <span class="comment">// EOF</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">case</span> nr &gt; <span class="number">0</span>:</span><br><span class="line">            handle(s[<span class="number">0</span>:nr])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li>juejin.im/post/5d5be347f265da03b94ff66b</li>
</ul>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[æ…ç”¨<-time.After()ï¼Œå®¹æ˜“å¯¼è‡´å†…å­˜æ³„æ¼]]></title>
      <url>http://team.jiunile.com/blog/2019/09/go-select-timer.html</url>
      <content type="html"><![CDATA[<h2 id="é—®é¢˜ä»£ç "><a href="#é—®é¢˜ä»£ç " class="headerlink" title="é—®é¢˜ä»£ç "></a>é—®é¢˜ä»£ç </h2><a id="more"></a>
<blockquote>
<p>é¡ºå¸¦è¯´æ˜ä¸‹select ç›‘å¬æ˜¯å¦‚ä½•å·¥ä½œçš„</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//go start</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			timerC := time.After(<span class="number">2</span> * time.Second)</span><br><span class="line">			<span class="comment">//timerC æ¯æ¬¡éƒ½æ˜¯é‡æ–°åˆ›å»ºçš„ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿç®€å•è¯´æ¥ï¼Œå½“ select æˆåŠŸç›‘å¬ ch å¹¶è¿›å…¥å®ƒçš„å¤„ç†åˆ†æ”¯ï¼Œä¸‹æ¬¡å¾ªç¯ timerC é‡æ–°åˆ›å»ºäº†ï¼Œæ—¶é—´è‚¯å®šå°±é‡ç½®äº†ã€‚</span></span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="comment">//å¦‚æœæœ‰å¤šä¸ª case éƒ½å¯ä»¥è¿è¡Œï¼Œselect ä¼šéšæœºå…¬å¹³é€‰æ‹©å‡ºä¸€ä¸ªæ‰§è¡Œã€‚å…¶ä½™çš„åˆ™ä¸ä¼šæ‰§è¡Œ</span></span><br><span class="line">			<span class="keyword">case</span> num := &lt;-ch:</span><br><span class="line">				fmt.Println(<span class="string">"get num is"</span>, num)</span><br><span class="line">			<span class="keyword">case</span> &lt;-timerC:</span><br><span class="line">				<span class="comment">//ç­‰ä»·äº case &lt;-time.After(2 * time.Second)</span></span><br><span class="line">				fmt.Println(<span class="string">"time's up!!!"</span>)</span><br><span class="line">				<span class="comment">//done&lt;-true</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">		ch &lt;- i</span><br><span class="line">		time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="é—®é¢˜è¯´æ˜"><a href="#é—®é¢˜è¯´æ˜" class="headerlink" title="é—®é¢˜è¯´æ˜"></a>é—®é¢˜è¯´æ˜</h2><p>ä»¥ä¸Šä»£ç ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œå…¶ç½ªé­ç¥¸é¦–æ˜¯<code>&lt;-time.After()</code>ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­æœ‰æ­¤è¯´æ˜ï¼šå¦‚æœå®šæ—¶å™¨æ²¡æœ‰åˆ°è¾¾å®šæ—¶æ—¶é—´ï¼Œ<code>gc</code> å°±ä¸ä¼šå¯åŠ¨åƒåœ¾å›æ”¶ã€‚æ ‡å‡†åº“æ–‡æ¡£ä¸­æœ‰è¯´æ˜ï¼š</p>
<blockquote>
<p>The underlying Timer is not recovered by the garbage collector until the timer fires</p>
</blockquote>
<h2 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h2><p>åœ¨ä¸ä½¿ç”¨ <code>time.After</code> æ¥å®ç°è¶…æ—¶çš„å‰æä¸‹ï¼Œå¯é€šè¿‡åˆ›å»º <code>timer</code> é…åˆ <code>reset</code> æ¥å®ç°è¶…æ—¶æœºåˆ¶ï¼Œå…·ä½“ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">	idleDuration := <span class="number">2</span> * time.Second</span><br><span class="line">	idleDelay := time.NewTimer(idleDuration)</span><br><span class="line">	<span class="keyword">defer</span> idleDelay.Stop()</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		idleDelay.Reset(idleDuration)</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> num := &lt;-ch:</span><br><span class="line">			fmt.Println(<span class="string">"get num is"</span>, num)</span><br><span class="line">		<span class="keyword">case</span> &lt;-idleDelay.C:</span><br><span class="line">			fmt.Println(<span class="string">"time's up!!!"</span>)</span><br><span class="line">			<span class="comment">//done&lt;-ture</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">....</span><br></pre></td></tr></table></figure></p>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li>studygolang.com/articles/22617</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Go é™·é˜±ç³»åˆ—]]></title>
      <url>http://team.jiunile.com/blog/2019/09/go-trap.html</url>
      <content type="html"><![CDATA[<h2 id="é™·é˜±ä¸€-interfaceé—®é¢˜"><a href="#é™·é˜±ä¸€-interfaceé—®é¢˜" class="headerlink" title="é™·é˜±ä¸€ interfaceé—®é¢˜"></a>é™·é˜±ä¸€ interfaceé—®é¢˜</h2><a id="more"></a>
<h3 id="é—®é¢˜ä»£ç "><a href="#é—®é¢˜ä»£ç " class="headerlink" title="é—®é¢˜ä»£ç "></a>é—®é¢˜ä»£ç </h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//DetaildError ...</span></span><br><span class="line"><span class="keyword">type</span> DetaildError <span class="keyword">struct</span> &#123;</span><br><span class="line">	code    <span class="keyword">int</span></span><br><span class="line">	message <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e DetaildError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"Error occured at (%d,%s)"</span>, e.code, e.message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">(x <span class="keyword">int</span>)</span> *<span class="title">DetaildError</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> x != <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;DetaildError&#123;code: <span class="number">1000</span>, message: <span class="string">"whoami?"</span>&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	err = handle(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"I am Error 1 of %s\n"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	err = handle(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"I am Error 2 of %s\n"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¾“å‡ºç»“æœ"><a href="#è¾“å‡ºç»“æœ" class="headerlink" title="è¾“å‡ºç»“æœ"></a>è¾“å‡ºç»“æœ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">I am Error 1 of Error occured at (1000,whoami?)</span><br><span class="line">I am Error 2 of &lt;nil&gt;</span><br></pre></td></tr></table></figure>
<h3 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h3><blockquote>
<p>err æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ¥å£åœ¨Goä¸­ä¿å­˜äº†ä¸¤ä¸ªå€¼ï¼Œä¸€ä¸ªæ˜¯<code>ç±»å‹T</code>ï¼Œä¸€ä¸ª<code>å€¼V</code><br>åªæœ‰å½“<code>T</code>å’Œ<code>V</code> <strong>åŒæ—¶</strong> ä¸º<code>nil</code>æ—¶ï¼Œæ¥å£æ‰æ˜¯<code>nil</code><br>åœ¨Goä¸­ï¼Œæ¥å£æ˜¯éšå¼å®ç°ï¼Œ<strong>å› æ­¤å½“æˆ‘ä»¬ç”¨ä¸€ä¸ªæ¥å£ç±»å‹å»æ¥æ”¶ä¸€ä¸ªnilç»“æ„ä½“çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¥å£å°†ä¸å†æ˜¯nil</strong><br>æ­¤æ—¶çš„errå€¼ä¸º<code>(T=*DetaildError, V=nil)</code>ï¼Œä¸æ»¡è¶³æ¥å£ä¸ºnilæ¡ä»¶</p>
</blockquote>
<h3 id="è§£å†³åŠæ³•"><a href="#è§£å†³åŠæ³•" class="headerlink" title="è§£å†³åŠæ³•"></a>è§£å†³åŠæ³•</h3><h4 id="ä¿®æ­£ä¸€ï¼šå°†var-err-Error-ä¿®æ”¹ä¸ºæ¥æ”¶Struct-è€Œä¸æ˜¯æ¥å£"><a href="#ä¿®æ­£ä¸€ï¼šå°†var-err-Error-ä¿®æ”¹ä¸ºæ¥æ”¶Struct-è€Œä¸æ˜¯æ¥å£" class="headerlink" title="ä¿®æ­£ä¸€ï¼šå°†var err Error ä¿®æ”¹ä¸ºæ¥æ”¶Struct è€Œä¸æ˜¯æ¥å£"></a>ä¿®æ­£ä¸€ï¼šå°†var err Error ä¿®æ”¹ä¸ºæ¥æ”¶Struct è€Œä¸æ˜¯æ¥å£</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> err *DetaildError</span><br></pre></td></tr></table></figure>
<h4 id="ä¿®æ­£äºŒï¼šå°†handleæ–¹æ³•çš„è¿”å›ç±»å‹ä¸ºinterface"><a href="#ä¿®æ­£äºŒï¼šå°†handleæ–¹æ³•çš„è¿”å›ç±»å‹ä¸ºinterface" class="headerlink" title="ä¿®æ­£äºŒï¼šå°†handleæ–¹æ³•çš„è¿”å›ç±»å‹ä¸ºinterface"></a>ä¿®æ­£äºŒï¼šå°†handleæ–¹æ³•çš„è¿”å›ç±»å‹ä¸ºinterface</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">(x <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> x != <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;DetaildError&#123;code: <span class="number">1000</span>, message: <span class="string">"whoami?"</span>&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li>mp.weixin.qq.com/s/0bJOzNxoQhdVjFOunhmVKQ</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[æ§åˆ¶ Goroutine çš„å¹¶å‘æ•°é‡]]></title>
      <url>http://team.jiunile.com/blog/2019/09/go-control-goroutine-number.html</url>
      <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>åœ¨ Go è¯­è¨€ä¸­åˆ›å»ºåç¨‹ï¼ˆGoroutineï¼‰çš„æˆæœ¬éå¸¸ä½ï¼Œå› æ­¤ç¨ä¸æ³¨æ„å°±å¯èƒ½åˆ›å»ºå‡ºå¤§é‡çš„åç¨‹ï¼Œä¸€æ–¹é¢ä¼šé€ æˆèµ„æºä¸æ–­å¢é•¿è´Ÿè½½å˜é«˜ï¼Œå¦ä¸€æ–¹é¢ä¸å®¹æ˜“æ§åˆ¶è¿™äº›åç¨‹çš„çŠ¶æ€ã€‚</p>
<p>ä¸è¿‡ï¼Œâ€œèƒ½åŠ›è¶Šå¤§ï¼Œè¶Šéœ€è¦å…‹åˆ¶â€ã€‚ç½‘ç»œä¸Šå·²ç»å­˜åœ¨ä¸€äº›è®²æ§åˆ¶ Goroutine æ•°ç›®çš„æ–‡ç« ï¼Œæœ¬æ–‡é€šè¿‡å›¾ç¤ºçš„æ–¹å¼å†ç®€å•æ€»ç»“ä¸€ä¸‹å…¶åŸºæœ¬ç†å¿µï¼Œä»¥ä¾¿äºè®°å¿†ã€‚</p>
<a id="more"></a>
<h2 id="Goroutine-æ•°é‡ä¸å—æ§ç¤ºä¾‹"><a href="#Goroutine-æ•°é‡ä¸å—æ§ç¤ºä¾‹" class="headerlink" title="Goroutine æ•°é‡ä¸å—æ§ç¤ºä¾‹"></a>Goroutine æ•°é‡ä¸å—æ§ç¤ºä¾‹</h2><h3 id="ç¤ºä¾‹ä»£ç "><a href="#ç¤ºä¾‹ä»£ç " class="headerlink" title="ç¤ºä¾‹ä»£ç "></a>ç¤ºä¾‹ä»£ç </h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	jobsCount := <span class="number">10</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; jobsCount; j++ &#123;</span><br><span class="line">		wg.Add(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">go</span> do(j)</span><br><span class="line">		fmt.Printf(<span class="string">"index: %d,goroutine Num: %d \n"</span>, j, runtime.NumGoroutine())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"done!"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">do</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> wg.Done()</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"hello %d!\n"</span>, i)</span><br><span class="line">	time.Sleep(time.Second * <span class="number">2</span>) <span class="comment">// åˆ»æ„ç¡ 2 ç§’é’Ÿï¼Œæ¨¡æ‹Ÿè€—æ—¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç å‡è®¾æœ‰ <code>jobsCount</code> ä¸ªä»»åŠ¡ï¼Œé€šè¿‡ <code>for-range ç»™æ¯ä¸ªä»»åŠ¡åˆ›å»ºäº†ä¸€ä¸ª Goroutine</code>ã€‚ä¸ºäº†è®©ä¸»åç¨‹ç­‰å¾…æ‰€æœ‰çš„å­åç¨‹æ‰§è¡Œå®Œæ¯•åå†é€€å‡ºï¼Œä½¿ç”¨ <code>sync.WaitGroup</code> ç›‘æ§æ‰€æœ‰åç¨‹çš„çŠ¶æ€ï¼Œä»è€Œä¿è¯ä¸»åç¨‹ç»“æŸæ—¶æ‰€æœ‰çš„å­åç¨‹å·²ç»é€€å‡ºã€‚ä¸ºäº†è¯´æ˜é—®é¢˜ï¼Œä¸Šé¢çš„ä»£ç è¿˜è¾“å‡ºäº† <code>runtime.NumGoroutine()</code> çš„å€¼ç”¨ä»¥è¡¨å¾åç¨‹çš„æ•°é‡ã€‚</p>
<p>è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥å¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºã€‚ä»ä¸‹é¢çš„è¾“å‡ºä¸­æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸¤ç‚¹ä¿¡æ¯ï¼šâ‘  åç¨‹çš„æ‰§è¡Œé¡ºåºæ˜¯éšæœºçš„ï¼ˆæ¯”å¦‚ hello 3 åœ¨ hello 6 åé¢å‡ºç°ï¼‰ï¼›â‘¡ åç¨‹çš„æ•°é‡é€’å¢ï¼Œæœ€ååˆ°äº† 11 ä¸ªä¹‹å¤šã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">index: 0,goroutine Num: 2</span><br><span class="line">hello 0!</span><br><span class="line">index: 1,goroutine Num: 3</span><br><span class="line">index: 2,goroutine Num: 4</span><br><span class="line">hello 1!</span><br><span class="line">index: 3,goroutine Num: 5</span><br><span class="line">index: 4,goroutine Num: 6</span><br><span class="line">index: 5,goroutine Num: 7</span><br><span class="line">index: 6,goroutine Num: 8</span><br><span class="line">hello 6!</span><br><span class="line">hello 3!</span><br><span class="line">index: 7,goroutine Num: 9</span><br><span class="line">hello 7!</span><br><span class="line">index: 8,goroutine Num: 10</span><br><span class="line">index: 9,goroutine Num: 11</span><br><span class="line">hello 2!</span><br><span class="line">hello 9!</span><br><span class="line">hello 8!</span><br><span class="line">hello 4!</span><br><span class="line"><span class="keyword">done</span>!</span><br><span class="line">hello 5!</span><br></pre></td></tr></table></figure></p>
<h3 id="Goroutine-æ•°é‡ä¸å—æ§åˆ¶çš„å›¾ç¤º"><a href="#Goroutine-æ•°é‡ä¸å—æ§åˆ¶çš„å›¾ç¤º" class="headerlink" title="Goroutine æ•°é‡ä¸å—æ§åˆ¶çš„å›¾ç¤º"></a>Goroutine æ•°é‡ä¸å—æ§åˆ¶çš„å›¾ç¤º</h3><p>æˆ‘ä»¬åº”è¯¥æ€ä¹ˆç†è§£ä¾‹ä¸€çš„ä»£ç å‘¢ï¼Ÿ</p>
<p>å‡å¦‚ CPU åªæœ‰ <strong>ä¸¤ä¸ª</strong> æ ¸ï¼Œä¸‹å›¾å±•ç¤ºäº†ä¸ºæ¯ä¸ª job åˆ›å»ºä¸€ä¸ª goroutine çš„æƒ…å†µï¼ˆæ¢å¥è¯è¯´ï¼Œgoroutine çš„æ•°é‡æ˜¯ä¸å—æ§åˆ¶çš„ï¼‰ã€‚æ­¤ç§æƒ…å†µè™½ç„¶ç”Ÿæˆäº†å¾ˆå¤šçš„ goroutineï¼Œä½†æ˜¯ <strong><code>æ¯ä¸ª CPU æ ¸ä¸ŠåŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ª goroutine</code></strong> ï¼›å½“ job å¾ˆå¤šä¸”ç”Ÿæˆäº†ç›¸åº”æ•°ç›®çš„ goroutine åï¼Œä¼šå‡ºç°å¾ˆå¤šç­‰å¾…æ‰§è¡Œçš„ goroutineï¼Œä»è€Œé€ æˆèµ„æºä¸Šçš„æµªè´¹ã€‚</p>
<p><img src="/images/go/figure-goroutine-controll-1.png" alt="goroutine"></p>
<h2 id="Goroutine-æ•°é‡å—æ§åˆ¶ç¤ºä¾‹"><a href="#Goroutine-æ•°é‡å—æ§åˆ¶ç¤ºä¾‹" class="headerlink" title="Goroutine æ•°é‡å—æ§åˆ¶ç¤ºä¾‹"></a>Goroutine æ•°é‡å—æ§åˆ¶ç¤ºä¾‹</h2><h3 id="Goroutine-æ•°é‡å—åˆ°é™åˆ¶çš„å›¾ç¤º"><a href="#Goroutine-æ•°é‡å—åˆ°é™åˆ¶çš„å›¾ç¤º" class="headerlink" title="Goroutine æ•°é‡å—åˆ°é™åˆ¶çš„å›¾ç¤º"></a>Goroutine æ•°é‡å—åˆ°é™åˆ¶çš„å›¾ç¤º</h3><p>ç»™æ¯ä¸ª job ç”Ÿæˆä¸€ä¸ª goroutine çš„æ–¹å¼æ˜¾å¾—ç²—æš´äº†å¾ˆå¤šï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ä»€ä¹ˆæ ·çš„æ–¹å¼æ§åˆ¶ goroutine çš„æ•°ç›®å‘¢ï¼Ÿå…¶å®ä¸Šé¢çš„ä»£ç é€šè¿‡ä¸€ä¸ª for-range å¾ªç¯å®Œæˆäº†ä¸¤ä»¶äº‹æƒ…ï¼šâ‘ ä¸ºæ¯ä¸ª job åˆ›å»º goroutineï¼›â‘¡æŠŠä»»åŠ¡ç›¸å…³çš„æ ‡è¯†ä¼ ç»™ç›¸åº”çš„ goroutine æ‰§è¡Œã€‚ä¸ºäº†æ§åˆ¶ goroutine çš„æ•°ç›®ï¼Œå¯ä»¥é€šè¿‡ buffered channel ç»™æ¯ä¸ª goroutine ä¼ é€’ä»»åŠ¡ç›¸å…³çš„ä¿¡æ¯ æˆ–è€… å¯ä»¥æŠŠä¸Šé¢çš„ä¸¤ä¸ªè¿‡ç¨‹æ‹†åˆ†å¼€ï¼šaï¼‰å…ˆé€šè¿‡ä¸€ä¸ª for-range å¾ªç¯åˆ›å»ºæŒ‡å®šæ•°ç›®çš„ goroutineï¼Œbï¼‰ç„¶åé€šè¿‡ channel/buffered channel ç»™æ¯ä¸ª goroutine ä¼ é€’ä»»åŠ¡ç›¸å…³çš„ä¿¡æ¯ï¼ˆè¿™é‡Œçš„channelæ˜¯å¦ç¼“å†²æ— æ‰€è°“ï¼Œä¸»è¦ç”¨åˆ°çš„æ˜¯ channel çš„çº¿ç¨‹å®‰å…¨ç‰¹æ€§ï¼‰ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/images/go/figure-goroutine-controll-2.png" alt="goroutine"></p>
<h3 id="ç¤ºä¾‹ä»£ç -1"><a href="#ç¤ºä¾‹ä»£ç -1" class="headerlink" title="ç¤ºä¾‹ä»£ç "></a>ç¤ºä¾‹ä»£ç </h3><p>æ–¹å¼ä¸€ï¼šé€šè¿‡æœ‰é˜»å¡çš„ <code>buffer channel</code> æ¥æ§åˆ¶ <code>goroutine</code> å¢é•¿<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	jobsCount := <span class="number">10</span></span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">2</span>) <span class="comment">//é€šè¿‡ channel æ§åˆ¶ goroutine æ•°é‡ï¼Œé˜²æ­¢æ— ä¼‘æ­¢å¢é•¿</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; jobsCount; j++ &#123;</span><br><span class="line">		wg.Add(<span class="number">1</span>)</span><br><span class="line">		ch &lt;- <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">go</span> do(ch, j)</span><br><span class="line">		fmt.Printf(<span class="string">"index: %d,goroutine Num: %d \n"</span>, j, runtime.NumGoroutine())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wg.Wait()</span><br><span class="line">	fmt.Println(<span class="string">"done!"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">do</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">bool</span>, i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> wg.Done()</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"hello %d!\n"</span>, i)</span><br><span class="line">	time.Sleep(time.Second * <span class="number">2</span>) <span class="comment">// åˆ»æ„ç¡ 2 ç§’é’Ÿï¼Œæ¨¡æ‹Ÿè€—æ—¶</span></span><br><span class="line"></span><br><span class="line">	&lt;-ch  <span class="comment">//å¿…é¡»åœ¨ä»»åŠ¡å®Œæˆåä»channelå–å‡ºï¼Œé€šè¿‡channelæ¥é˜»å¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ–¹å¼äºŒï¼šé€šè¿‡æ‹†ä»»åŠ¡å®ç°ï¼š</p>
<ul>
<li>aï¼‰å…ˆé€šè¿‡ä¸€ä¸ª for-range å¾ªç¯åˆ›å»ºæŒ‡å®šæ•°ç›®çš„ goroutine</li>
<li>bï¼‰ç„¶åé€šè¿‡ channel/buffered channel ç»™æ¯ä¸ª goroutine ä¼ é€’ä»»åŠ¡ç›¸å…³çš„ä¿¡æ¯</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	jobsCount := <span class="number">10</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> jobsChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// a) ç”ŸæˆæŒ‡å®šæ•°ç›®çš„ goroutineï¼Œæ¯ä¸ª goroutine æ¶ˆè´¹ jobsChan ä¸­çš„æ•°æ®</span></span><br><span class="line">	poolCount := <span class="number">2</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; poolCount; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> job(jobsChan)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// b) æŠŠ job ä¾æ¬¡æ¨é€åˆ° jobsChan ä¾› goroutine æ¶ˆè´¹</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; jobsCount; i++ &#123;</span><br><span class="line">		jobsChan &lt;- i</span><br><span class="line">		wg.Add(<span class="number">1</span>)</span><br><span class="line">		fmt.Printf(<span class="string">"index: %d,goroutine Num: %d\n"</span>, i, runtime.NumGoroutine())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wg.Wait()</span><br><span class="line">	</span><br><span class="line">	fmt.Println(<span class="string">"done!"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">job</span><span class="params">(jobsChan <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> j := <span class="keyword">range</span> jobsChan &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"hello %d\n"</span>, j)</span><br><span class="line">		time.Sleep(time.Second * <span class="number">2</span>) <span class="comment">// åˆ»æ„ç¡ 2 ç§’é’Ÿï¼Œæ¨¡æ‹Ÿè€—æ—¶</span></span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä¸Šé¢çš„ä»£ç å¯ä»¥å¾—åˆ°ä¸‹é¢ç±»ä¼¼çš„è¾“å‡ºï¼ˆå¯ä»¥çœ‹åˆ° goroutine çš„æ•°é‡æ§åˆ¶åœ¨äº† 3 ä¸ªï¼‰<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">hello 0!</span><br><span class="line">index: 0,goroutine Num: 2</span><br><span class="line">index: 1,goroutine Num: 3</span><br><span class="line">hello 1!</span><br><span class="line">hello 2!</span><br><span class="line">index: 2,goroutine Num: 3</span><br><span class="line">index: 3,goroutine Num: 3</span><br><span class="line">hello 3!</span><br><span class="line">index: 4,goroutine Num: 3</span><br><span class="line">hello 4!</span><br><span class="line">index: 5,goroutine Num: 3</span><br><span class="line">hello 5!</span><br><span class="line">index: 6,goroutine Num: 3</span><br><span class="line">index: 7,goroutine Num: 3</span><br><span class="line">hello 7!</span><br><span class="line">hello 6!</span><br><span class="line">index: 8,goroutine Num: 3</span><br><span class="line">index: 9,goroutine Num: 3</span><br><span class="line">hello 8!</span><br><span class="line">hello 9!</span><br><span class="line"><span class="keyword">done</span>!</span><br></pre></td></tr></table></figure></p>
<p>å‚è€ƒï¼š</p>
<ul>
<li>jingwei.link</li>
</ul>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Podmanã€Skopeoå’ŒBuildahä¸‹ä¸€ä»£å®¹å™¨ä»£æ›¿Docker]]></title>
      <url>http://team.jiunile.com/blog/2019/09/containers-podman-skopeo-buildah.html</url>
      <content type="html"><![CDATA[<h2 id="ç¼˜èµ·"><a href="#ç¼˜èµ·" class="headerlink" title="ç¼˜èµ·"></a>ç¼˜èµ·</h2><p>åœ¨Dockerå®è·µä¸­ï¼Œå¾ˆå¤šäººåº”è¯¥éƒ½é‡åˆ°è¿‡å¼€æœºé‡å¯æ—¶ï¼Œç”±äºDockerå®ˆæŠ¤ç¨‹åºåœ¨å ç”¨å¤šæ ¸CPUä½¿ç”¨100%Cä½¿ç”¨çš„æƒ…å†µï¼Œæ­¤æ—¶æ‰€æœ‰å®¹å™¨éƒ½æ— æ³•æ­£å¸¸å·¥ä½œï¼Œæ‰€æœ‰æœåŠ¡éƒ½ä¸èƒ½ç”¨ã€‚è§£å†³å”¯ä¸€æ–¹æ³•åªèƒ½æ€æ‰æ‰€æœ‰å®¹å™¨å¹¶é‡å¯å®ˆæŠ¤è¿›ç¨‹ï¼Œæ‰èƒ½æ¢å¤ã€‚ç»è¿‡äº†è§£è¯¥é—®é¢˜æ˜¯ç”±äºDockerå®ˆæŠ¤è¿›ç¨‹å¼•èµ·ï¼Œè€Œä¸”Dockerå®ˆæŠ¤è¿›ç¨‹æ˜¯ä»¥rootç‰¹æƒæƒé™å¯åŠ¨çš„ï¼Œæ˜¯ä¸€ä¸ªå®‰å…¨é—®é¢˜ï¼Œé‚£ä¹ˆæœ‰ä»€ä¹ˆæ–¹æ³•è§£å†³å‘¢ï¼Ÿæœ¬æ–‡ä»‹ç»ä¸€ä¸‹åŸºäºCRI ç­‰æ ‡å‡†ï¼ˆDockeræ–°æ¶æ„ä¹Ÿç¬¦åˆCRIæ ‡å‡†ï¼‰çš„æ–°ä¸€ä»£å®¹å™¨å·¥å…·<code>Podman</code>ã€<code>Skopero</code>å’Œ<code>Buiddah</code>å¥—ä»¶ã€‚</p>
<h2 id="OCI"><a href="#OCI" class="headerlink" title="OCI"></a>OCI</h2><p>ä¸ºäº†é˜²æ­¢å®¹å™¨è¢«Dockerä¸€å®¶å„æ–­ï¼Œå·¨å¤´ä»¬ï¼ˆè°·æ­Œï¼ŒRedhatã€å¾®è½¯ã€IBMã€Intelã€æ€ç§‘ï¼‰èšåœ¨ä¸€èµ·å†³å®šè¦æˆç«‹ä¸€ä¸ªç»„ç»‡ï¼ˆOCIï¼‰ï¼Œå¤§å®¶ä¸€èµ·å•†é‡æŒ‡å®šäº†ä¸€å¥—è§„èŒƒï¼ˆCRIã€CNIï¼‰ï¼Œå¤§å®¶ä¸€è‡´ç»Ÿä¸€åªå…¼å®¹ç¬¦åˆè¿™å¥—è§„èŒƒçš„å·¥å…·ã€‚Dockerè™½ç„¶å¿ƒæœ‰ä¸ç”˜ä½†æ˜¯æ¯•ç«Ÿèƒ³è†Šæ‹§ä¸è¿‡å¤§è…¿ï¼Œåªèƒ½è¯¥æ¶æ„å…¼å®¹è§„èŒƒã€‚</p>
<p>åœ¨è¯¥è§„èŒƒçš„æŒ‡å¯¼ä¸‹å°±æœ‰äº†æœ¬æ–‡çš„ä¸‰ä¸ªä¸»äººå…¬ï¼Œè¿™ä¸‰ä¸ªå·¥å…·éƒ½æ˜¯ç¬¦åˆOCIè®¡åˆ’ä¸‹çš„å·¥å…·ï¼ˆ<a href="https://github.com/containers" target="_blank" rel="external">https://github.com/containers</a>ï¼‰ã€‚ä»–ä»¬ä¸»è¦æ˜¯ç”±RedHatæ¨åŠ¨ï¼Œä¸‰è€…å„å¸å…¶èŒï¼Œé…åˆå®ŒæˆDockeræ‰€æœ‰çš„åŠŸèƒ½å’Œæ–°æ‰©å±•åŠŸèƒ½ï¼Œå¹¶ä¸”å¯¹dockerçš„é—®é¢˜è¿›è¡Œäº†æ”¹è‰¯ï¼šåŒ…æ‹¬ä¸éœ€è¦å®ˆæŠ¤ç¨‹åºæˆ–è®¿é—®æœ‰rootæƒé™çš„ç»„ï¼›å®¹å™¨æ¶æ„åŸºäºfork/execæ¨¡å‹åˆ›å»ºå®¹å™¨ï¼Œæ›´åŠ å®‰å…¨å¯é ï¼›æ‰€ä»¥æ˜¯æ›´å…ˆè¿›ã€é«˜æ•ˆå’Œå®‰å…¨çš„ä¸‹ä¸€ä»£å®¹å™¨å®¹å™¨å·¥å…·ã€‚</p>
<a id="more"></a>
<h2 id="Podman"><a href="#Podman" class="headerlink" title="Podman"></a>Podman</h2><p><img src="/images/containers/podman.jpg" alt="podman"></p>
<p><a href="https://github.com/containers/libpod" target="_blank" rel="external">Podman</a>æ˜¯è¯¥å·¥å…·å¥—ä»¶çš„æ ¸å¿ƒï¼Œç”¨æ¥æ›¿æ¢Dockerä¸­äº†å¤§å¤šæ•°å­å‘½ä»¤ï¼ˆRUNï¼ŒPUSHï¼ŒPULLç­‰ï¼‰ã€‚Podmanæ— éœ€å®ˆæŠ¤è¿›ç¨‹ï¼Œä½¿ç”¨ç”¨æˆ·å‘½åç©ºé—´æ¥æ¨¡æ‹Ÿå®¹å™¨ä¸­çš„rootï¼Œæ— éœ€è¿æ¥åˆ°å…·æœ‰rootæƒé™çš„å¥—æ¥å­—ä¿è¯å®¹å™¨çš„ä½“ç³»å®‰å…¨ã€‚</p>
<p>Podmanä¸“æ³¨äºç»´æŠ¤å’Œä¿®æ”¹OCIé•œåƒçš„æ‰€æœ‰å‘½ä»¤å’ŒåŠŸèƒ½ï¼Œä¾‹å¦‚æ‹‰åŠ¨å’Œæ ‡è®°ã€‚å®ƒè¿˜å…è®¸æˆ‘ä»¬åˆ›å»ºï¼Œè¿è¡Œå’Œç»´æŠ¤ä»è¿™äº›é•œåƒåˆ›å»ºçš„å®¹å™¨ã€‚</p>
<h2 id="Buildah"><a href="#Buildah" class="headerlink" title="Buildah"></a>Buildah</h2><p><a href="https://github.com/containers/buildah" target="_blank" rel="external">Buildah</a>ç”¨æ¥æ„å»ºOCIå›¾åƒã€‚è™½ç„¶Podmanä¹Ÿå¯ä»¥ç”¨æˆ·æ„å»ºDockeré•œåƒï¼Œä½†æ˜¯æ„å»ºé€Ÿåº¦è¶…æ…¢ï¼Œå¹¶ä¸”é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨vfså­˜å‚¨é©±åŠ¨ç¨‹åºä¼šè€—å°½å¤§é‡ç£ç›˜ç©ºé—´ã€‚ buildah budï¼ˆä½¿ç”¨Dockerfileæ„å»ºï¼‰åˆ™ä¼šéå¸¸å¿«ï¼Œå¹¶ä½¿ç”¨è¦†ç›–å­˜å‚¨é©±åŠ¨ç¨‹åºã€‚</p>
<p><img src="/images/containers/buildah.jpg" alt="buildah"></p>
<p>Buildahä¸“æ³¨äºæ„å»ºOCIé•œåƒã€‚ Buildahçš„å‘½ä»¤å¤åˆ¶äº†Dockerfileä¸­çš„æ‰€æœ‰å‘½ä»¤ã€‚å¯ä»¥ä½¿ç”¨Dockerfilesæ„å»ºé•œåƒï¼Œå¹¶ä¸”ä¸éœ€è¦ä»»ä½•rootæƒé™ã€‚ Buildahçš„æœ€ç»ˆç›®æ ‡æ˜¯æä¾›æ›´ä½çº§åˆ«çš„coreutilsç•Œé¢æ¥æ„å»ºå›¾åƒã€‚Buildahä¹Ÿæ”¯æŒéDockerfilesæ„å»ºé•œåƒï¼Œå¯ä»¥å…è®¸å°†å…¶ä»–è„šæœ¬è¯­è¨€é›†æˆåˆ°æ„å»ºè¿‡ç¨‹ä¸­ã€‚ Buildahéµå¾ªä¸€ä¸ªç®€å•çš„fork-execæ¨¡å‹ï¼Œä¸ä»¥å®ˆæŠ¤è¿›ç¨‹è¿è¡Œï¼Œä½†å®ƒåŸºäºgolangä¸­çš„ç»¼åˆAPIï¼Œå¯ä»¥å­˜å‚¨åˆ°å…¶ä»–å·¥å…·ä¸­ã€‚</p>
<h2 id="Skopeo"><a href="#Skopeo" class="headerlink" title="Skopeo"></a>Skopeo</h2><p><a href="https://github.com/containers/skopeo" target="_blank" rel="external">Skopeo</a>æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå…è®¸æˆ‘ä»¬é€šè¿‡æ¨ï¼Œæ‹‰å’Œå¤åˆ¶é•œåƒæ¥å¤„ç†Dockerå’ŒOCé•œåƒã€‚</p>
<p><img src="/images/containers/skopeo.jpg" alt="skopeo"></p>
<h2 id="ä¸‰ä¸ªå·¥å…·å¯¹æ¯”"><a href="#ä¸‰ä¸ªå·¥å…·å¯¹æ¯”" class="headerlink" title="ä¸‰ä¸ªå·¥å…·å¯¹æ¯”"></a>ä¸‰ä¸ªå·¥å…·å¯¹æ¯”</h2><p>Buildahæ„å»ºå®¹å™¨ï¼ŒPodmanè¿è¡Œå®¹å™¨ï¼ŒSkopeoä¼ è¾“å®¹å™¨é•œåƒã€‚è¿™äº›éƒ½æ˜¯ç”±Githubå®¹å™¨ç»„ç»‡ç»´æŠ¤çš„å¼€æºå·¥å…·ï¼ˆ<a href="https://github.com/containers" target="_blank" rel="external">https://github.com/containers</a>ï¼‰ã€‚è¿™äº›å·¥å…·éƒ½ä¸éœ€è¦è¿è¡Œå®ˆæŠ¤è¿›ç¨‹ï¼Œå¹¶ä¸”å¤§å¤šæ•°æƒ…å†µä¸‹ä¹Ÿä¸éœ€è¦rootè®¿é—®æƒé™ã€‚</p>
<p>Podmanå’ŒBuildahä¹‹é—´çš„ä¸€ä¸ªä¸»è¦åŒºåˆ«æ˜¯ä»–ä»¬çš„å®¹å™¨æ¦‚å¿µã€‚ Podmanå…è®¸ç”¨æˆ·åˆ›å»ºâ€ä¼ ç»Ÿå®¹å™¨â€ã€‚è™½ç„¶Buildahå®¹å™¨å®é™…ä¸Šåªæ˜¯ä¸ºäº†å…è®¸å°†å†…å®¹æ·»åŠ å›å®¹å™¨å›¾åƒè€Œåˆ›å»ºçš„ã€‚ä¸€ç§ç®€å•æ–¹æ³•æ˜¯buildah runå‘½ä»¤æ¨¡æ‹ŸDockerfileä¸­çš„RUNå‘½ä»¤ï¼Œè€Œpodman runå‘½ä»¤æ¨¡æ‹ŸåŠŸèƒ½ä¸­çš„docker runå‘½ä»¤ã€‚</p>
<p>æ€»ä¹‹ï¼ŒBuildahæ˜¯åˆ›å»ºOCIé•œåƒçš„æœ‰æ•ˆæ–¹å¼ï¼Œè€ŒPodmanå…è®¸æˆ‘ä»¬ä½¿ç”¨ç†Ÿæ‚‰çš„å®¹å™¨cliå‘½ä»¤åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç®¡ç†å’Œç»´æŠ¤è¿™äº›é•œåƒå’Œå®¹å™¨ã€‚</p>
<h2 id="å®¹å™¨è¿ç§»"><a href="#å®¹å™¨è¿ç§»" class="headerlink" title="å®¹å™¨è¿ç§»"></a>å®¹å™¨è¿ç§»</h2><h3 id="å¥—ä»¶å®‰è£…"><a href="#å¥—ä»¶å®‰è£…" class="headerlink" title="å¥—ä»¶å®‰è£…"></a>å¥—ä»¶å®‰è£…</h3><p>å„å¤§Linuxå‘è¡Œç‰ˆéƒ½æä¾›äº†äºŒè¿›åˆ¶å®‰è£…åŒ…ï¼Œ å¯ä»¥ä½¿ç”¨å‘è¡Œç‰ˆçš„ç³»ç»ŸåŒ…ç®¡ç†å·¥å…·ä¸€é”®å®‰è£…ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Fedora, CentOSï¼šsudo yum -y install podman</span><br><span class="line">Arch &amp; Manjaro Linuxï¼š sudo pacman -S podman</span><br></pre></td></tr></table></figure></p>
<p>Ubuntuä¸æ”¯æŒä¸€é”®å®‰è£…ï¼Œéœ€è¦å…ˆæ·»åŠ ç¬¬ä¸‰æ–¹ç§æœ‰ppaä»“åº“ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update -qq</span><br><span class="line">sudo apt-get install -qq -y software-properties-common uidmap</span><br><span class="line">sudo add-apt-repository -y ppa:projectatomic/ppa</span><br><span class="line">sudo apt-get update -qq</span><br><span class="line">sudo apt-get -qq -y install podman</span><br></pre></td></tr></table></figure></p>
<h2 id="å®è·µè¿ç§»"><a href="#å®è·µè¿ç§»" class="headerlink" title="å®è·µè¿ç§»"></a>å®è·µè¿ç§»</h2><p>å®‰è£…äº†å¥—ä»¶çš„ä¸‰ä¸ªå·¥å…·åï¼Œå°±å¯ä»¥å¯¹dockerå®ä¾‹è¿›è¡Œè¿ç§»äº†ã€‚</p>
<blockquote>
<p>æ›¿æ¢cronæˆ–è€…CIä½œä¸šï¼ˆè„šæœ¬ï¼‰ä¸­çš„æ‰€æœ‰dockerå®ä¾‹ï¼ŒæŠŠdockeræ›¿æ¢ä¸ºpodmanï¼Œå¯ä»¥ä½¿ç”¨åé¢æåˆ°çš„åˆ«åçš„æ–¹å¼ã€‚</p>
</blockquote>
<h3 id="1ã€åœæ­¢å’Œåˆ é™¤æ‰€æœ‰çš„è¿è¡Œçš„dockerã€‚"><a href="#1ã€åœæ­¢å’Œåˆ é™¤æ‰€æœ‰çš„è¿è¡Œçš„dockerã€‚" class="headerlink" title="1ã€åœæ­¢å’Œåˆ é™¤æ‰€æœ‰çš„è¿è¡Œçš„dockerã€‚"></a>1ã€åœæ­¢å’Œåˆ é™¤æ‰€æœ‰çš„è¿è¡Œçš„dockerã€‚</h3><p>ä¸ºäº†ç¡®ä¿æ²¡æœ‰æœ‰å·®é”™ï¼Œå¯ä»¥ä½¿ç”¨sysdigæ¥æ•è·ç³»ç»Ÿä¸­dockerçš„å¼•ç”¨ï¼Œçœ‹çœ‹æ˜¯å¦è¿˜æœ‰å…¶ä»–ä¸œè¥¿åœ¨è°ƒç”¨dockerã€‚</p>
<h3 id="2ã€åˆ é™¤docker"><a href="#2ã€åˆ é™¤docker" class="headerlink" title="2ã€åˆ é™¤docker"></a>2ã€åˆ é™¤docker</h3><p>ç°åœ¨å°±å¯ä»¥åˆ é™¤dockeräº†ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker || apt remove -y docker-ce</span><br></pre></td></tr></table></figure></p>
<h3 id="3ã€ç¯å¢ƒæ¸…ç†"><a href="#3ã€ç¯å¢ƒæ¸…ç†" class="headerlink" title="3ã€ç¯å¢ƒæ¸…ç†"></a>3ã€ç¯å¢ƒæ¸…ç†</h3><p>æœ€åæ¸…ç†ä¸‹dockeræ–‡ä»¶ï¼Œæˆ‘ä»¬å»ºä¸ªä¸€ç›®å½•dockerå¤‡ä»½ç›®å½•ï¼ŒæŠŠä»¥ä¸‹ç›®å½•mvåˆ°å¤‡ä»½ç›®å½•å³å¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/docker/*ï¼Œ/etc/default/dockerå’Œ/var/lib/ dockerä¸­çš„ä»»ä½•é—ç•™æ–‡ä»¶</span><br></pre></td></tr></table></figure></p>
<p>åˆ é™¤dockerç»„<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delgroup docker</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨å¯ä»¥å§dockeråˆ«åæˆpodmanæ¥æ— ç¼ä½¿ç”¨äº†<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> docker = podman</span><br></pre></td></tr></table></figure></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ä»‹ç»äº†ç¬¦åˆCIRæ ‡å‡†çš„ cri-o å®¹å™¨å¥—ä»¶Podmanï¼ŒSkopeoå’ŒBuildahã€‚è¯¥æ–°ä¸€ä»£å®¹å™¨å¥—ä»¶æ¶æ„åŸºäº*nixä¼ ç»Ÿçš„fork-execæ¨¡å‹ï¼Œè§£å†³äº†ç”±äºdockerå®ˆæŠ¤ç¨‹åºå¯¼è‡´çš„å¯åŠ¨å’Œå®‰å…¨é—®é¢˜ï¼Œææé«˜äº†å®¹å™¨çš„æ€§èƒ½å’Œå®‰å…¨ã€‚</p>
<p>æ¥æºï¼š</p>
<ul>
<li>zhuanlan.zhihu.com</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Kubelet çŠ¶æ€æ›´æ–°æœºåˆ¶]]></title>
      <url>http://team.jiunile.com/blog/2019/08/k8s-kubelet-sync-node-status.html</url>
      <content type="html"><![CDATA[<h2 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h2><p>å½“ Kubernetes ä¸­ Node èŠ‚ç‚¹å‡ºç°çŠ¶æ€å¼‚å¸¸çš„æƒ…å†µä¸‹ï¼ŒèŠ‚ç‚¹ä¸Šçš„ Pod ä¼šè¢«é‡æ–°è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šå»ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™æˆ‘ä»¬ä¼šå‘ç°èŠ‚ç‚¹ Down æ‰ä»¥åï¼ŒPod å¹¶ä¸ä¼šç«‹å³è§¦å‘é‡æ–°è°ƒåº¦ï¼Œè¿™å®é™…ä¸Šå°±æ˜¯å’Œ Kubelet çš„çŠ¶æ€æ›´æ–°æœºåˆ¶å¯†åˆ‡ç›¸å…³çš„ï¼ŒKubernetes æä¾›äº†ä¸€äº›å‚æ•°é…ç½®æ¥è§¦å‘é‡æ–°è°ƒåº¦åˆ°å—¯æ—¶é—´ï¼Œä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸‹ Kubelet çŠ¶æ€æ›´æ–°çš„åŸºæœ¬æµç¨‹ã€‚</p>
<ol>
<li>kubelet è‡ªèº«ä¼šå®šæœŸæ›´æ–°çŠ¶æ€åˆ° apiserverï¼Œé€šè¿‡å‚æ•°<code>--node-status-update-frequency</code>æŒ‡å®šä¸ŠæŠ¥é¢‘ç‡ï¼Œé»˜è®¤æ˜¯ 10s ä¸ŠæŠ¥ä¸€æ¬¡ã€‚</li>
<li>kube-controller-manager ä¼šæ¯éš”<code>--node-monitor-period</code>æ—¶é—´å»æ£€æŸ¥ kubelet çš„çŠ¶æ€ï¼Œé»˜è®¤æ˜¯ 5sã€‚</li>
<li>å½“ node å¤±è”ä¸€æ®µæ—¶é—´åï¼Œkubernetes åˆ¤å®š node ä¸º <code>notready</code> çŠ¶æ€ï¼Œè¿™æ®µæ—¶é•¿é€šè¿‡<code>--node-monitor-grace-period</code>å‚æ•°é…ç½®ï¼Œé»˜è®¤ 40sã€‚</li>
<li>å½“ node å¤±è”ä¸€æ®µæ—¶é—´åï¼Œkubernetes åˆ¤å®š node ä¸º <code>unhealthy</code>çŠ¶æ€ï¼Œè¿™æ®µæ—¶é•¿é€šè¿‡<code>--node-startup-grace-period</code>å‚æ•°é…ç½®ï¼Œé»˜è®¤ 1m0sã€‚</li>
<li>å½“ node å¤±è”ä¸€æ®µæ—¶é—´åï¼Œkubernetes å¼€å§‹åˆ é™¤åŸ node ä¸Šçš„ podï¼Œè¿™æ®µæ—¶é•¿æ˜¯é€šè¿‡<code>--pod-eviction-timeout</code>å‚æ•°é…ç½®ï¼Œé»˜è®¤ 5m0sã€‚</li>
</ol>
<blockquote>
<p>kube-controller-manager å’Œ kubelet æ˜¯å¼‚æ­¥å·¥ä½œçš„ï¼Œè¿™æ„å‘³ç€å»¶è¿Ÿå¯èƒ½åŒ…æ‹¬ä»»ä½•çš„ç½‘ç»œå»¶è¿Ÿã€apiserver çš„å»¶è¿Ÿã€etcd å»¶è¿Ÿï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„è´Ÿè½½å¼•èµ·çš„å»¶è¿Ÿç­‰ç­‰ã€‚å› æ­¤ï¼Œå¦‚æœ<code>--node-status-update-frequency</code>è®¾ç½®ä¸º5sï¼Œé‚£ä¹ˆå®é™…ä¸Š etcd ä¸­çš„æ•°æ®å˜åŒ–ä¼šéœ€è¦ 6-7sï¼Œç”šè‡³æ›´é•¿æ—¶é—´ã€‚<br><a id="more"></a><br>Kubeletåœ¨æ›´æ–°çŠ¶æ€å¤±è´¥æ—¶ï¼Œä¼šè¿›è¡Œ<code>nodeStatusUpdateRetry</code>æ¬¡é‡è¯•ï¼Œé»˜è®¤ä¸º<strong><code>5 æ¬¡</code></strong>ã€‚</p>
</blockquote>
<p>Kubelet ä¼šåœ¨å‡½æ•°<code>tryUpdateNodeStatus</code>ä¸­å°è¯•è¿›è¡ŒçŠ¶æ€æ›´æ–°ã€‚Kubelet ä½¿ç”¨äº† Golang ä¸­çš„<code>http.Client()</code>æ–¹æ³•ï¼Œä½†æ˜¯æ²¡æœ‰æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œå› æ­¤ï¼Œå¦‚æœ API Server è¿‡è½½æ—¶ï¼Œå½“å»ºç«‹ TCP è¿æ¥æ—¶å¯èƒ½ä¼šå‡ºç°ä¸€äº›æ•…éšœã€‚</p>
<p>å› æ­¤ï¼Œåœ¨<code>nodeStatusUpdateRetry * --node-status-update-frequency</code>æ—¶é—´åæ‰ä¼šæ›´æ–°ä¸€æ¬¡èŠ‚ç‚¹çŠ¶æ€ã€‚</p>
<p>åŒæ—¶ï¼ŒKubernetes çš„ controller manager å°†å°è¯•æ¯<code>--node-monitor-period</code>æ—¶é—´å‘¨æœŸå†…æ£€æŸ¥<code>nodeStatusUpdateRetry</code>æ¬¡ã€‚åœ¨<code>--node-monitor-grace-period</code>ä¹‹åï¼Œä¼šè®¤ä¸ºèŠ‚ç‚¹ unhealthyï¼Œç„¶åä¼šåœ¨<code>--pod-eviction-timeout</code>ååˆ é™¤ Podã€‚</p>
<p>kube proxy æœ‰ä¸€ä¸ª watcher APIï¼Œä¸€æ—¦ Pod è¢«é©±é€äº†ï¼Œkube proxy å°†ä¼šé€šçŸ¥æ›´æ–°èŠ‚ç‚¹çš„ iptables è§„åˆ™ï¼Œå°† Pod ä» Service çš„ Endpoints ä¸­ç§»é™¤ï¼Œè¿™æ ·å°±ä¸ä¼šè®¿é—®åˆ°æ¥è‡ªæ•…éšœèŠ‚ç‚¹çš„ Pod äº†ã€‚</p>
<h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>å¯¹äºè¿™äº›å‚æ•°çš„é…ç½®ï¼Œéœ€è¦æ ¹æ®ä¸é€šçš„é›†ç¾¤è§„æ¨¡åœºæ™¯æ¥è¿›è¡Œé…ç½®ã€‚</p>
<h3 id="ç¤¾åŒºé»˜è®¤çš„é…ç½®"><a href="#ç¤¾åŒºé»˜è®¤çš„é…ç½®" class="headerlink" title="ç¤¾åŒºé»˜è®¤çš„é…ç½®"></a>ç¤¾åŒºé»˜è®¤çš„é…ç½®</h3><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th style="text-align:left">è¯´æ˜</th>
<th style="text-align:left">å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>â€“node-status-update-frequency</td>
<td style="text-align:left">kubelet é—´éš”å¤šå°‘æ—¶é—´å‘apiserverä¸ŠæŠ¥node statusä¿¡æ¯</td>
<td style="text-align:left">10s</td>
</tr>
<tr>
<td>â€“node-monitor-period</td>
<td style="text-align:left">kube-controller-manager é—´éš”å¤šå°‘æ—¶é—´åä»apiserveråŒæ­¥node statusä¿¡æ¯</td>
<td style="text-align:left">5s</td>
</tr>
<tr>
<td>â€“node-monitor-grace-period</td>
<td style="text-align:left">kube-controller-manager é—´éš”å¤šå°‘æ—¶é—´ä¹‹åï¼ŒæŠŠnodeçŠ¶æ€è®¾ç½®ä¸ºNotReady</td>
<td style="text-align:left">40s</td>
</tr>
<tr>
<td>â€“pod-eviction-timeout</td>
<td style="text-align:left">kube-controller-manager åœ¨ç¬¬ä¸€æ¬¡kubelet notReadyäº‹ä»¶ä¹‹åçš„å¤šå°‘æ—¶é—´åï¼Œå¼€å§‹é©±é€podã€‚å¹¶ä¸æ˜¯CMæŠŠnodeçŠ¶æ€è®¾ç½®ä¸ºnotreadyä¹‹åå†ç­‰å¾…<code>pod-eviction-timeout</code>æ—¶é—´</td>
<td style="text-align:left">5m</td>
</tr>
</tbody>
</table>
<h3 id="å¿«é€Ÿæ›´æ–°å’Œå¿«é€Ÿå“åº”"><a href="#å¿«é€Ÿæ›´æ–°å’Œå¿«é€Ÿå“åº”" class="headerlink" title="å¿«é€Ÿæ›´æ–°å’Œå¿«é€Ÿå“åº”"></a>å¿«é€Ÿæ›´æ–°å’Œå¿«é€Ÿå“åº”</h3><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th style="text-align:left">è¯´æ˜</th>
<th style="text-align:left">å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>â€“node-status-update-frequency</td>
<td style="text-align:left">kubelet é—´éš”å¤šå°‘æ—¶é—´å‘apiserverä¸ŠæŠ¥node statusä¿¡æ¯</td>
<td style="text-align:left">4s</td>
</tr>
<tr>
<td>â€“node-monitor-period</td>
<td style="text-align:left">kube-controller-manager é—´éš”å¤šå°‘æ—¶é—´åä»apiserveråŒæ­¥node statusä¿¡æ¯</td>
<td style="text-align:left">2s</td>
</tr>
<tr>
<td>â€“node-monitor-grace-period</td>
<td style="text-align:left">kube-controller-manager é—´éš”å¤šå°‘æ—¶é—´ä¹‹åï¼ŒæŠŠnodeçŠ¶æ€è®¾ç½®ä¸ºNotReady</td>
<td style="text-align:left">20s</td>
</tr>
<tr>
<td>â€“pod-eviction-timeout</td>
<td style="text-align:left">kube-controller-manager åœ¨ç¬¬ä¸€æ¬¡kubelet notReadyäº‹ä»¶ä¹‹åçš„å¤šå°‘æ—¶é—´åï¼Œå¼€å§‹é©±é€podã€‚å¹¶ä¸æ˜¯CMæŠŠnodeçŠ¶æ€è®¾ç½®ä¸ºnotreadyä¹‹åå†ç­‰å¾…<code>pod-eviction-timeout</code>æ—¶é—´</td>
<td style="text-align:left">30s</td>
</tr>
</tbody>
</table>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒPod å°†åœ¨ 50s è¢«é©±é€ï¼Œå› ä¸ºè¯¥èŠ‚ç‚¹åœ¨ 20s åè¢«è§†ä¸ºDownæ‰äº†ï¼Œ<code>--pod-eviction-timeout</code> åœ¨ 30s ä¹‹åå‘ç”Ÿï¼ŒKubeletå°†å°è¯•æ¯4ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€ã€‚å› æ­¤ï¼Œåœ¨Kubernetesæ§åˆ¶å™¨ç®¡ç†å™¨è€ƒè™‘èŠ‚ç‚¹çš„ä¸å¥åº·çŠ¶æ€ä¹‹å‰ï¼Œå®ƒå°†æ˜¯ (20s / 4s * 5) = 25 æ¬¡å°è¯•ï¼Œä½†æ˜¯ï¼Œè¿™ç§æƒ…å†µä¼šç»™ etcd äº§ç”Ÿå¾ˆå¤§çš„å¼€é”€ï¼Œå› ä¸ºæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå°è¯•æ¯ 2s æ›´æ–°ä¸€æ¬¡çŠ¶æ€ã€‚</p>
<p>å¦‚æœç¯å¢ƒæœ‰1000ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ¯åˆ†é’Ÿå°†æœ‰(60s / 4s * 1000) = 15000æ¬¡èŠ‚ç‚¹æ›´æ–°æ“ä½œï¼Œè¿™å¯èƒ½éœ€è¦å¤§å‹ etcd å®¹å™¨ç”šè‡³æ˜¯ etcd çš„ä¸“ç”¨èŠ‚ç‚¹ã€‚</p>
<blockquote>
<p>å¦‚æœæˆ‘ä»¬è®¡ç®—å°è¯•æ¬¡æ•°ï¼Œåˆ™é™¤æ³•å°†ç»™å‡º5ï¼Œä½†å®é™…ä¸Šæ¯æ¬¡å°è¯•çš„ nodeStatusUpdateRetry å°è¯•å°†ä»3åˆ°5ã€‚ ç”±äºæ‰€æœ‰ç»„ä»¶çš„å»¶è¿Ÿï¼Œå°è¯•æ€»æ¬¡æ•°å°†åœ¨15åˆ°25ä¹‹é—´å˜åŒ–ã€‚</p>
</blockquote>
<h3 id="ä¸­ç­‰æ›´æ–°å’Œå¹³å‡å“åº”"><a href="#ä¸­ç­‰æ›´æ–°å’Œå¹³å‡å“åº”" class="headerlink" title="ä¸­ç­‰æ›´æ–°å’Œå¹³å‡å“åº”"></a>ä¸­ç­‰æ›´æ–°å’Œå¹³å‡å“åº”</h3><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th style="text-align:left">è¯´æ˜</th>
<th style="text-align:left">å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>â€“node-status-update-frequency</td>
<td style="text-align:left">kubelet é—´éš”å¤šå°‘æ—¶é—´å‘apiserverä¸ŠæŠ¥node statusä¿¡æ¯</td>
<td style="text-align:left">20s</td>
</tr>
<tr>
<td>â€“node-monitor-period</td>
<td style="text-align:left">kube-controller-manager é—´éš”å¤šå°‘æ—¶é—´åä»apiserveråŒæ­¥node statusä¿¡æ¯</td>
<td style="text-align:left">5s</td>
</tr>
<tr>
<td>â€“node-monitor-grace-period</td>
<td style="text-align:left">kube-controller-manager é—´éš”å¤šå°‘æ—¶é—´ä¹‹åï¼ŒæŠŠnodeçŠ¶æ€è®¾ç½®ä¸ºNotReady</td>
<td style="text-align:left">2m</td>
</tr>
<tr>
<td>â€“pod-eviction-timeout</td>
<td style="text-align:left">kube-controller-manager åœ¨ç¬¬ä¸€æ¬¡kubelet notReadyäº‹ä»¶ä¹‹åçš„å¤šå°‘æ—¶é—´åï¼Œå¼€å§‹é©±é€podã€‚å¹¶ä¸æ˜¯CMæŠŠnodeçŠ¶æ€è®¾ç½®ä¸ºnotreadyä¹‹åå†ç­‰å¾…<code>pod-eviction-timeout</code>æ—¶é—´</td>
<td style="text-align:left">1m</td>
</tr>
</tbody>
</table>
<p>è¿™ç§åœºæ™¯ä¸‹ä¼šï¼ŒPod å°†åœ¨ 3m è¢«é©±é€ã€‚ Kubeletå°†å°è¯•æ¯20ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€ã€‚å› æ­¤ï¼Œåœ¨Kubernetesæ§åˆ¶å™¨ç®¡ç†å™¨è€ƒè™‘èŠ‚ç‚¹çš„ä¸å¥åº·çŠ¶æ€ä¹‹å‰ï¼Œå®ƒå°†æ˜¯ (2m <em> 60 / 20s </em> 5) = 30 æ¬¡å°è¯•</p>
<p>å¦‚æœæœ‰ 1000 ä¸ªèŠ‚ç‚¹ï¼Œ1åˆ†é’Ÿä¹‹å†…å°±ä¼šæœ‰ (60s / 20s * 1000) = 3000 æ¬¡çš„èŠ‚ç‚¹çŠ¶æ€æ›´æ–°æ“ä½œã€‚</p>
<h3 id="ä½æ›´æ–°å’Œæ…¢å“åº”"><a href="#ä½æ›´æ–°å’Œæ…¢å“åº”" class="headerlink" title="ä½æ›´æ–°å’Œæ…¢å“åº”"></a>ä½æ›´æ–°å’Œæ…¢å“åº”</h3><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th style="text-align:left">è¯´æ˜</th>
<th style="text-align:left">å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>â€“node-status-update-frequency</td>
<td style="text-align:left">kubelet é—´éš”å¤šå°‘æ—¶é—´å‘apiserverä¸ŠæŠ¥node statusä¿¡æ¯</td>
<td style="text-align:left">1m</td>
</tr>
<tr>
<td>â€“node-monitor-period</td>
<td style="text-align:left">kube-controller-manager é—´éš”å¤šå°‘æ—¶é—´åä»apiserveråŒæ­¥node statusä¿¡æ¯</td>
<td style="text-align:left">5s</td>
</tr>
<tr>
<td>â€“node-monitor-grace-period</td>
<td style="text-align:left">kube-controller-manager é—´éš”å¤šå°‘æ—¶é—´ä¹‹åï¼ŒæŠŠnodeçŠ¶æ€è®¾ç½®ä¸ºNotReady</td>
<td style="text-align:left">5m</td>
</tr>
<tr>
<td>â€“pod-eviction-timeout</td>
<td style="text-align:left">kube-controller-manager åœ¨ç¬¬ä¸€æ¬¡kubelet notReadyäº‹ä»¶ä¹‹åçš„å¤šå°‘æ—¶é—´åï¼Œå¼€å§‹é©±é€podã€‚å¹¶ä¸æ˜¯CMæŠŠnodeçŠ¶æ€è®¾ç½®ä¸ºnotreadyä¹‹åå†ç­‰å¾…<code>pod-eviction-timeout</code>æ—¶é—´</td>
<td style="text-align:left">1m</td>
</tr>
</tbody>
</table>
<p>è¿™ç§åœºæ™¯ä¸‹ä¼šï¼ŒPod å°†åœ¨ 6m è¢«é©±é€ã€‚ Kubeletå°†å°è¯•æ¯1åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡çŠ¶æ€ã€‚å› æ­¤ï¼Œåœ¨Kubernetesæ§åˆ¶å™¨ç®¡ç†å™¨è€ƒè™‘èŠ‚ç‚¹çš„ä¸å¥åº·çŠ¶æ€ä¹‹å‰ï¼Œå®ƒå°†æ˜¯ (5m / 1m * 5) = 25 æ¬¡å°è¯•</p>
<p>å¦‚æœæœ‰ 1000 ä¸ªèŠ‚ç‚¹ï¼Œ1åˆ†é’Ÿä¹‹å†…å°±ä¼šæœ‰ (1m / 60s * 1000) = 1000 æ¬¡çš„èŠ‚ç‚¹çŠ¶æ€æ›´æ–°æ“ä½œã€‚</p>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<ul>
<li><a href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/kubernetes-reliability.md" target="_blank" rel="external">https://github.com/kubernetes-sigs/kubespray/blob/master/docs/kubernetes-reliability.md</a></li>
<li><a href="https://github.com/Kevin-fqh/learning-k8s-source-code/blob/master/kubelet/(05)kubelet%E8%B5%84%E6%BA%90%E4%B8%8A%E6%8A%A5%26Evition%E6%9C%BA%E5%88%B6.md" target="_blank" rel="external">https://github.com/Kevin-fqh/learning-k8s-source-code/blob/master/kubelet/(05)kubelet%E8%B5%84%E6%BA%90%E4%B8%8A%E6%8A%A5%26Evition%E6%9C%BA%E5%88%B6.md</a></li>
</ul>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Calico 3.5+ æ ¹æ®èŠ‚ç‚¹æ ‡ç­¾åˆ†é… IP åœ°å€]]></title>
      <url>http://team.jiunile.com/blog/2019/08/k8s-calico-assigning-ip.html</url>
      <content type="html"><![CDATA[<h2 id="å…³äº-IP-åœ°å€çš„åˆ†é…"><a href="#å…³äº-IP-åœ°å€çš„åˆ†é…" class="headerlink" title="å…³äº IP åœ°å€çš„åˆ†é…"></a>å…³äº IP åœ°å€çš„åˆ†é…</h2><p>Calico èƒ½å¤Ÿè¿›è¡Œé…ç½®ï¼Œä¸ºä¸åŒæ‹“æ‰‘æŒ‡å®š IP åœ°å€æ± ã€‚ä¾‹å¦‚å¯èƒ½å¸Œæœ›æŸäº›æœºæ¶ã€åœ°åŒºã€æˆ–è€…åŒºåŸŸèƒ½å¤Ÿä»åŒä¸€ä¸ª IP æ± ä¸­è·å–åœ°å€ã€‚è¿™å¯¹äºé™ä½è·¯ç”±æ•°é‡æˆ–è€…é…åˆé˜²ç«å¢™ç­–ç•¥çš„è¦æ±‚ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚</p>
<p><a href="https://docs.projectcalico.org/v3.5/reference/cni-plugin/configuration#ipam" target="_blank" rel="external">cni æ’ä»¶é…ç½®å‚è€ƒä¸­çš„ IP åœ°å€ç®¡ç†ç« èŠ‚</a>ä¸­åŒ…å«äº†ä¸‰ç§åˆ†é… IP åœ°å€çš„æ–¹å¼ã€‚Kubernetes æ³¨è§£æ–¹å¼åªèƒ½ç”¨äº Namespace æˆ–è€… Pod ä¸€çº§ã€‚å‰©ä¸‹çš„åªæœ‰ä¸¤ä¸ªåŠæ³•ï¼ŒCNI é…ç½®æˆ–è€…æ˜¯åŸºäºèŠ‚ç‚¹é€‰æ‹©å™¨çš„ IP æ± ï¼Œç›¸å¯¹äº CNI é…ç½®çš„æ–¹å¼æ¥è¯´ï¼ŒèŠ‚ç‚¹é€‰æ‹©å™¨æ–¹æ¡ˆçœå»äº†ä¿®æ”¹æœ¬åœ°æ–‡ä»¶çš„éº»çƒ¦ã€‚</p>
<p>åœ¨æ›´é«˜å±‚æ¬¡ä¸Šï¼ŒåŸºäºèŠ‚ç‚¹é€‰æ‹©å™¨çš„ IP åœ°å€åˆ†é…æ–¹æ³•å°±æ˜¯ç»™èŠ‚ç‚¹è®¾ç½®æ ‡ç­¾ï¼Œç„¶åç”¨èŠ‚ç‚¹é€‰æ‹©å™¨é€‰æ‹©å¯¹åº”çš„ IP åœ°å€æ± è¿›è¡Œåˆ†é…ã€‚åé¢çš„å†…å®¹ä¸­å°†ç»™å‡ºä¸€ä¸ªè¯¦ç»†çš„ä¾‹å­ï¼Œç”¨è¿™ç§æ–¹å¼æ¥è®¾ç½®ä¸€ç§æœºæ¶äº²å’Œæ–¹å¼çš„ IP åœ°å€åˆ†é…æ–¹æ¡ˆã€‚</p>
<blockquote>
<p>å¦‚æœ Calico æ— æ³•æ ¹æ®ä¸Šè¿°é¡ºåºæ¥å†³å®šä¸€ä¸ª IP åœ°å€æ± ï¼Œæˆ–è€…åœ¨é€‰å®šçš„åœ°å€æ± ä¸­æ‰¾ä¸åˆ°å¯ç”¨çš„ IP åœ°å€ï¼Œé‚£ä¹ˆè¿™ä¸€å·¥ä½œè´Ÿè½½å°±ä¸ä¼šåˆ†åˆ° IP åœ°å€ï¼Œæ— æ³•å¯åŠ¨ã€‚ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œæˆ‘ä»¬å»ºè®®æ‰€æœ‰èŠ‚ç‚¹è‡³å°‘æœ‰ä¸€ä¸ªåˆé€‚çš„åœ°å€æ± ã€‚<br><a id="more"></a></p>
<h2 id="å…ˆå†³æ¡ä»¶"><a href="#å…ˆå†³æ¡ä»¶" class="headerlink" title="å…ˆå†³æ¡ä»¶"></a>å…ˆå†³æ¡ä»¶</h2><p><strong><code>è¿™ä¸€åŠŸèƒ½éœ€è¦ Calico åœ¨ ETCD æ¨¡å¼ä¸‹å·¥ä½œ</code></strong></p>
</blockquote>
<h2 id="ç¤ºä¾‹ï¼šKubernetes"><a href="#ç¤ºä¾‹ï¼šKubernetes" class="headerlink" title="ç¤ºä¾‹ï¼šKubernetes"></a>ç¤ºä¾‹ï¼šKubernetes</h2><p>æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ªé›†ç¾¤ï¼Œå…¶ä¸­åŒ…å«å››ä¸ªèŠ‚ç‚¹ï¼Œåˆ†å¸ƒåœ¨ä¸¤ä¸ªæœºæ¶ä¸Šï¼Œæ¯ä¸ªæœºæ¶å„ä¸¤å°ã€‚ç¤ºæ„å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">       -------------------</span><br><span class="line">       |    router       |</span><br><span class="line">       -------------------</span><br><span class="line">       |                 |</span><br><span class="line">---------------   ---------------</span><br><span class="line">| rack-0      |   | rack-1      |</span><br><span class="line">---------------   ---------------</span><br><span class="line">| kube-node-0 |   | kube-node-2 |</span><br><span class="line">- - - - - - - -   - - - - - - - -</span><br><span class="line">| kube-node-1 |   | kube-node-3 |</span><br><span class="line">- - - - - - - -   - - - - - - - -</span><br></pre></td></tr></table></figure></p>
<p>Pod IP åœ°å€èŒƒå›´ä¸º <code>192.168.0.0/16</code>ï¼Œæˆ‘ä»¬è¿›è¡Œå¦‚ä¸‹è®¾è®¡ï¼šä¿ç•™ <code>192.168.0.0/24</code> ç»™ <code>rack-0</code>,  <code>192.168.1.0/24</code> ç»™ <code>rack-1</code>ã€‚</p>
<p>è¦è®¾ç½®ä¸€ä¸ªæ²¡æœ‰ç¼ºçœåœ°å€æ± çš„çš„ Calicoï¼Œé¦–å…ˆè¿è¡Œ <code>calicoctl get ippool -o wide</code>ï¼Œä¼šçœ‹åˆ°å·²ç»åˆ›å»ºäº†ä¸€ä¸ª <code>192.168.0.0/16</code> çš„åœ°å€æ± ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                  CIDR             NAT    IPIPMODE   DISABLED   SELECTOR</span><br><span class="line">default-ipv4-ippool   192.168.0.0/16   <span class="literal">true</span>   Always     <span class="literal">false</span>      all()</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>åˆ é™¤ç¼ºçœåœ°å€æ± <br><code>default-ipv4-ippool</code> åœ°å€æ± å·²ç»å­˜åœ¨ï¼Œå¹¶å æ®äº†æ•´ä¸ª <code>/16</code> å—ï¼Œå› æ­¤å¿…é¡»åˆ é™¤ï¼š<code>calicoctl delete ippools default-ipv4-ippool</code></p>
</li>
<li><p>ç»™ Node æ‰“æ ‡ç­¾ã€‚<br>è¦ç»™ç‰¹å®šèŠ‚ç‚¹åˆ†é…åœ°å€æ± ï¼ŒèŠ‚ç‚¹å¿…é¡»ç”¨æ ‡ç­¾è¿›è¡Œæ ‡è¯†ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes kube-node-0 rack=0</span><br><span class="line">kubectl label nodes kube-node-1 rack=0</span><br><span class="line">kubectl label nodes kube-node-2 rack=1</span><br><span class="line">kubectl label nodes kube-node-3 rack=1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>ä¸ºæ¯ä¸ªæœºæ¶åˆ›å»ºåœ°å€æ± </strong></p>
<p>rack-0-ippool<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">calicoctl create -f -&lt;&lt;EOF</span><br><span class="line"><span class="attr">apiVersion:</span> projectcalico.org/v3</span><br><span class="line"><span class="attr">kind:</span> IPPool</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> rack<span class="bullet">-0</span>-ippool</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  cidr:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line"><span class="attr">  ipipMode:</span> Always</span><br><span class="line"><span class="attr">  natOutgoing:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> rack == <span class="string">"0"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>rack-1-ippool<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">calicoctl create -f -&lt;&lt;EOF</span><br><span class="line"><span class="attr">apiVersion:</span> projectcalico.org/v3</span><br><span class="line"><span class="attr">kind:</span> IPPool</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> rack<span class="bullet">-1</span>-ippool</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  cidr:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line"><span class="attr">  ipipMode:</span> Always</span><br><span class="line"><span class="attr">  natOutgoing:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> rack == <span class="string">"1"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨å°±åˆ›å»ºäº†ä¸¤ä¸ªåœ°å€æ± ï¼Œä½¿ç”¨ <code>calicoctl get ippool -o wide</code> è¿›è¡ŒæŸ¥çœ‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                  CIDR             NAT    IPIPMODE   DISABLED   SELECTOR</span><br><span class="line">rack-1-ippool         192.168.0.0/24   <span class="literal">true</span>   Always     <span class="literal">false</span>      rack == <span class="string">"0"</span></span><br><span class="line">rack-2-ippool         192.168.1.0/24   <span class="literal">true</span>   Always     <span class="literal">false</span>      rack == <span class="string">"1"</span></span><br></pre></td></tr></table></figure></p>
<ol>
<li>æ£€æŸ¥åœ°å€æ± çš„å·¥ä½œçŠ¶æ€<br>åˆ›å»ºä¸€ä¸ª Nginx çš„ Deploymentï¼Œå…¶ä¸­åŒ…å«äº”ä¸ªå‰¯æœ¬ï¼Œä¿è¯åˆ†é…åˆ°æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run nginx --image nginx --replicas 5</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>æ£€æŸ¥æ–°çš„ Pod æ˜¯å¦å·²ç»æ ¹æ®æ‰€åœ¨æœºæ¶è·å¾—äº†åº”æœ‰çš„ IP åœ°å€ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME                   READY   STATUS    RESTARTS   AGE    IP             NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-5c7588df-prx4z   1/1     Running   0          6m3s   192.168.0.64   kube-node-0   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-5c7588df<span class="_">-s</span>7qw6   1/1     Running   0          6m7s   192.168.0.129  kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-5c7588df-w7r7g   1/1     Running   0          6m3s   192.168.1.65   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-5c7588df-62lnf   1/1     Running   0          6m3s   192.168.1.1    kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-5c7588df-pnsvv   1/1     Running   0          6m3s   192.168.1.64   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒIP åœ°å€çš„æ˜¯æ ¹æ®èŠ‚ç‚¹ï¼ˆæ‰€åœ¨çš„æœºæ¶ï¼‰æ¥é€‰æ‹©äº†å¯¹åº”çš„åœ°å€æ± è¿›è¡Œåˆ†é…çš„ã€‚</p>
<p>å‚è€ƒåœ°å€</p>
<ul>
<li><a href="https://docs.projectcalico.org/v3.5/usage/assigning-ip-addresses-topology" target="_blank" rel="external">calico 3.5</a></li>
<li><a href="https://docs.projectcalico.org/v3.6/networking/assigning-ip-addresses-topology" target="_blank" rel="external">calico 3.6</a></li>
<li><a href="https://docs.projectcalico.org/v3.7/networking/assigning-ip-addresses-topology" target="_blank" rel="external">calico 3.7</a></li>
<li><a href="https://docs.projectcalico.org/v3.8/networking/assigning-ip-addresses-topology" target="_blank" rel="external">calico 3.8</a></li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[é•œåƒæ¼æ´æ£€æµ‹å·¥å…· -- Trivy]]></title>
      <url>http://team.jiunile.com/blog/2019/08/security-trivy.html</url>
      <content type="html"><![CDATA[<blockquote>
<p>é“è·¯åƒä¸‡æ¡ï¼Œå®‰å…¨ç¬¬ä¸€æ¡ï¼› é•œåƒä¸è§„èŒƒï¼ŒåŒäº‹ä¸¤è¡Œæ³ªã€‚</p>
</blockquote>
<p><a href="https://github.com/aquasecurity/trivy" target="_blank" rel="external">Trivy</a> æ˜¯ä¸€ä¸ªé¢å‘é•œåƒçš„æ¼æ´æ£€æµ‹å·¥å…·ï¼Œå…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li>å¼€æº</li>
<li>å…è´¹</li>
<li>æ˜“ç”¨</li>
<li>å‡†ç¡®åº¦é«˜</li>
<li>CI å‹å¥½</li>
</ol>
<p>ç›¸å¯¹äºè€å‰è¾ˆ <a href="https://github.com/coreos/clair" target="_blank" rel="external">Clair</a>ï¼ŒTrivy çš„ä½¿ç”¨éå¸¸ç›´è§‚æ–¹ä¾¿ï¼Œé€‚ç”¨äºæ›´å¤šçš„åœºæ™¯ã€‚</p>
<p>ä¸‹é¢æ˜¯å®˜æ–¹å‡ºå…·çš„å¯¹æ¯”è¡¨æ ¼ï¼š</p>
<table>
<thead>
<tr>
<th>æ‰«æå™¨</th>
<th style="text-align:center">æ“ä½œç³»ç»Ÿ</th>
<th style="text-align:center">ä¾èµ–æ£€æµ‹</th>
<th style="text-align:center">é€‚ç”¨æ€§</th>
<th style="text-align:center">å‡†ç¡®åº¦</th>
<th style="text-align:center">CI å‹å¥½</th>
</tr>
</thead>
<tbody>
<tr>
<td>Trivy</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">â—</td>
<td style="text-align:center">â—¯</td>
</tr>
<tr>
<td>Clair</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">Ã—</td>
<td style="text-align:center">â–³</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">â–³</td>
</tr>
<tr>
<td>Anchore Engine</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">â–³</td>
<td style="text-align:center">â–³</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">â–³</td>
</tr>
<tr>
<td>Quay</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">Ã—</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">Ã—</td>
</tr>
<tr>
<td>MicroScanner</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">Ã—</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">â—¯</td>
</tr>
<tr>
<td>Docker Hub</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">Ã—</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">Ã—</td>
<td style="text-align:center">Ã—</td>
</tr>
<tr>
<td>GCR</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">Ã—</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">â—¯</td>
<td style="text-align:center">Ã—</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><h3 id="MacOS"><a href="#MacOS" class="headerlink" title="MacOS"></a>MacOS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ brew tap knqyf263/trivy</span><br><span class="line">$ brew install knqyf263/trivy/trivy</span><br></pre></td></tr></table></figure>
<h3 id="RHEL-CentOS"><a href="#RHEL-CentOS" class="headerlink" title="RHEL/CentOS"></a>RHEL/CentOS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/yum.repos.d/trivy.repo</span><br><span class="line">[trivy]</span><br><span class="line">name=Trivy repository</span><br><span class="line">baseurl=https://aquasecurity.github.io/trivy-repo/rpm/releases/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">$ sudo yum -y update</span><br><span class="line">$ sudo yum -y install trivy</span><br></pre></td></tr></table></figure>
<p>or<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -ivh https://github.com/aquasecurity/trivy/releases/download/v0.0.15/trivy_0.0.15_Linux-64bit.rpm</span><br></pre></td></tr></table></figure></p>
<h2 id="å¿«é€Ÿå…¥é—¨"><a href="#å¿«é€Ÿå…¥é—¨" class="headerlink" title="å¿«é€Ÿå…¥é—¨"></a>å¿«é€Ÿå…¥é—¨</h2><p>è¿™ä¸ªå·¥å…·çš„æœ€å¤§é—ªå…‰ç‚¹å°±æ˜¯æä¾›äº†å¾ˆå¤šé€‚åˆç”¨åœ¨è‡ªåŠ¨åŒ–åœºæ™¯çš„ç”¨æ³•ã€‚è¯¦ç»†ä½¿ç”¨å¸®åŠ©å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://github.com/aquasecurity/trivy" target="_blank" rel="external">Trivy</a></p>
<h3 id="æ‰«æé•œåƒï¼š"><a href="#æ‰«æé•œåƒï¼š" class="headerlink" title="æ‰«æé•œåƒï¼š"></a>æ‰«æé•œåƒï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ trivy centos</span><br></pre></td></tr></table></figure>
<h3 id="æ‰«æé•œåƒæ–‡ä»¶"><a href="#æ‰«æé•œåƒæ–‡ä»¶" class="headerlink" title="æ‰«æé•œåƒæ–‡ä»¶"></a>æ‰«æé•œåƒæ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker save ruby:2.3.0-alpine3.9 -o ruby-2.3.0.tar</span><br><span class="line">$ trivy --input ruby-2.3.0.tar</span><br></pre></td></tr></table></figure>
<h3 id="æ ¹æ®ä¸¥é‡ç¨‹åº¦è¿›è¡Œè¿‡æ»¤"><a href="#æ ¹æ®ä¸¥é‡ç¨‹åº¦è¿›è¡Œè¿‡æ»¤" class="headerlink" title="æ ¹æ®ä¸¥é‡ç¨‹åº¦è¿›è¡Œè¿‡æ»¤"></a>æ ¹æ®ä¸¥é‡ç¨‹åº¦è¿›è¡Œè¿‡æ»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ trivy --severity HIGH,CRITICAL ruby:2.3.0</span><br></pre></td></tr></table></figure>
<h3 id="å¿½ç•¥æœªä¿®å¤é—®é¢˜"><a href="#å¿½ç•¥æœªä¿®å¤é—®é¢˜" class="headerlink" title="å¿½ç•¥æœªä¿®å¤é—®é¢˜"></a>å¿½ç•¥æœªä¿®å¤é—®é¢˜</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ trivy --ignore-unfixed ruby:2.3.0</span><br></pre></td></tr></table></figure>
<h3 id="å¿½ç•¥ç‰¹å®šé—®é¢˜"><a href="#å¿½ç•¥ç‰¹å®šé—®é¢˜" class="headerlink" title="å¿½ç•¥ç‰¹å®šé—®é¢˜"></a>å¿½ç•¥ç‰¹å®šé—®é¢˜</h3><p>ä½¿ç”¨ <code>.trivyignore</code>ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat .trivyignore</span><br><span class="line"><span class="comment"># Accept the risk</span></span><br><span class="line">CVE-2018-14618</span><br><span class="line"></span><br><span class="line"><span class="comment"># No impact in our settings</span></span><br><span class="line">CVE-2019-1543</span><br><span class="line"></span><br><span class="line">$ trivy python:3.4-alpine3.9</span><br></pre></td></tr></table></figure></p>
<h3 id="ä½¿ç”¨-JSON-è¾“å‡ºç»“æœ"><a href="#ä½¿ç”¨-JSON-è¾“å‡ºç»“æœ" class="headerlink" title="ä½¿ç”¨ JSON è¾“å‡ºç»“æœ"></a>ä½¿ç”¨ JSON è¾“å‡ºç»“æœ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ trivy <span class="_">-f</span> json dustise/translat-chatbot:20190428-5</span><br></pre></td></tr></table></figure>
<h3 id="å®šä¹‰è¿”å›å€¼"><a href="#å®šä¹‰è¿”å›å€¼" class="headerlink" title="å®šä¹‰è¿”å›å€¼"></a>å®šä¹‰è¿”å›å€¼</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ trivy --exit-code 0 --severity MEDIUM,HIGH ruby:2.3.0</span><br><span class="line">$ trivy --exit-code 1 --severity CRITICAL ruby:2.3.0</span><br></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç›¸å¯¹äºå…¶å®ƒåŒç±»å·¥å…·ï¼ŒTrivy éå¸¸é€‚åˆè‡ªåŠ¨åŒ–æ“ä½œï¼Œä» CircleCI ä¹‹ç±»çš„å…¬æœ‰æœåŠ¡ï¼Œåˆ°ä¼ä¸šå†…éƒ¨ä½¿ç”¨çš„ Jenkinsã€Gitlab ç­‰ç§æœ‰å·¥å…·ï¼Œæˆ–è€…ä½œä¸ºå¼€å‘è¿ç»´äººå‘˜çš„è‡ªæµ‹ç¯èŠ‚ï¼Œéƒ½æœ‰ Trivy çš„ç”¨æ­¦ä¹‹åœ°ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Go è¯­è¨€çš„é”™è¯¯å¤„ç†ï¼šä»æ‹’ç»åˆ°æ¥å—]]></title>
      <url>http://team.jiunile.com/blog/2019/08/go-errors-in-go.html</url>
      <content type="html"><![CDATA[<h3 id="å­¦ä¹ å¦‚ä½•åœ¨goä¸­ä¸åœ¨æ‹…å¿ƒå¹¶ä¸”çˆ±ä¸Šé”™è¯¯å¤„ç†"><a href="#å­¦ä¹ å¦‚ä½•åœ¨goä¸­ä¸åœ¨æ‹…å¿ƒå¹¶ä¸”çˆ±ä¸Šé”™è¯¯å¤„ç†" class="headerlink" title="å­¦ä¹ å¦‚ä½•åœ¨goä¸­ä¸åœ¨æ‹…å¿ƒå¹¶ä¸”çˆ±ä¸Šé”™è¯¯å¤„ç†"></a>å­¦ä¹ å¦‚ä½•åœ¨goä¸­ä¸åœ¨æ‹…å¿ƒå¹¶ä¸”çˆ±ä¸Šé”™è¯¯å¤„ç†</h3><p>æ­£å¦‚ä¸€ä½è‹±å›½è¯—äººæ‰€è¯´çš„ï¼Œâ€œçŠ¯é”™æ˜¯äººï¼Œå®½æ•æ˜¯ç¥â€ã€‚é”™è¯¯å¤„ç†æ˜¯ç¼–ç¨‹å®è·µä¸­éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œä½†åœ¨å¾ˆå¤šæµè¡Œè¯­è¨€ä¸­å¹¶æ²¡æœ‰å¯¹å®ƒç»™äºˆè¶³å¤Ÿçš„é‡è§†ã€‚</p>
<p>ä½œä¸ºä¼—å¤šè¯­è¨€çš„é¼»ç¥–ï¼ŒC è¯­è¨€ä»ä¸€å¼€å§‹å°±æ²¡æœ‰ä¸€ä¸ªå®Œå–„çš„é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æœºåˆ¶ã€‚åœ¨ C è¯­è¨€ä¸­ï¼Œé”™è¯¯å¤„ç†å®Œå…¨ç”±ç¨‹åºå‘˜æ¥è´Ÿè´£ï¼Œè¦ä¹ˆé€šè¿‡è®¾ç½®ä¸€ä¸ªé”™è¯¯ç ï¼Œæˆ–è€…ç¨‹åºç›´æ¥å°±å´©æºƒäº†ï¼ˆsegment faultï¼‰ã€‚</p>
<p>è™½ç„¶å¼‚å¸¸å¤„ç†æœºåˆ¶æ—©åœ¨ C è¯­è¨€å‘æ˜ä¹‹å‰å°±å‡ºç°äº†ï¼ˆæœ€æ—©ç”± LISP 1.5åœ¨1962å¹´æ”¯æŒï¼‰ï¼Œä½†ç›´åˆ°19ä¸–çºª80å¹´ä»£å®ƒæ‰æµè¡Œå¼€æ¥ã€‚C++ å’Œ Java è®©ç¨‹åºå‘˜ç†Ÿæ‚‰äº† <code>try...catch</code> è¿™ä¸€æ¨¡å¼ï¼Œæ‰€æœ‰çš„è§£é‡Šå‹è¯­è¨€ä¹Ÿæ²¿ç”¨äº†å®ƒã€‚</p>
<p>å°½ç®¡åœ¨è¯­æ³•ä¸Šç•¥æœ‰å·®å¼‚ï¼ˆæ¯”å¦‚æ˜¯ç”¨ <code>try</code> è¿˜æ˜¯ <code>begin</code>ï¼‰ï¼Œæˆ‘ä¹‹å‰é‡åˆ°çš„æ¯ä¸€ç§è¯­è¨€åœ¨ä¸€å¼€å§‹å­¦ä¹ çš„æ—¶å€™éƒ½ä¸ä¼šè®©ä½ æ³¨æ„åˆ°é”™è¯¯å¤„ç†çš„æ¦‚å¿µã€‚é€šå¸¸ï¼Œåœ¨ä½ åˆšå¼€å§‹å†™ç€ç©çš„æ—¶å€™æ ¹æœ¬ç”¨ä¸åˆ°å®ƒï¼Œåªæœ‰å½“ä½ å¼€å§‹å†™ä¸€ä¸ªçœŸæ­£çš„é¡¹ç›®æ—¶æ‰ä¼šæ„è¯†åˆ°éœ€è¦æœ‰é”™è¯¯å¤„ç†ã€‚è‡³å°‘å¯¹äºæˆ‘è€Œè¨€ï¼Œä¸€ç›´å¦‚æ­¤ã€‚</p>
<p>ç„¶åæˆ‘é‡åˆ°äº† Golang ï¼šä¸€å¼€å§‹å¤§å®¶éƒ½æ˜¯ä»ã€Ša Tour of Goã€‹æ¥è®¤è¯†å®ƒçš„ã€‚<br><a id="more"></a></p>
<p>åœ¨å­¦ä¹ ã€Ša Tour of Goã€‹çš„è¿‡ç¨‹ä¸­ï¼Œä¸æ–­çš„æœ‰ <code>err</code> è¿™æ ·ä»£è¡¨é”™è¯¯çš„å˜é‡æ˜ å…¥çœ¼å¸˜ã€‚ä¸ç®¡ä¸€ä¸ª Go é¡¹ç›®æœ‰å¤šå¤§ï¼Œä¸€ç§æ¨¡å¼æ€»æ˜¯å­˜åœ¨ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f, err := os.Open(filename)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  <span class="comment">// åœ¨è¿™é‡Œå¤„ç†é”™è¯¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ® Go çš„æƒ¯ä¾‹ï¼Œæ¯ä¸€ä¸ªä¼šå‡ºç°é”™è¯¯çš„å‡½æ•°éƒ½éœ€è¦åœ¨æœ€åä¸€ä¸ªè¿”å›å€¼ä¸­å®šä¹‰å®ƒï¼ˆGo å…è®¸å¤šè¿”å›å€¼ï¼‰ï¼Œç¨‹åºå‘˜éœ€è¦åœ¨æ¯ä¸€æ¬¡è°ƒç”¨å‡½æ•°åéƒ½å¯¹è¿”å›çš„é”™è¯¯è¿›è¡Œå¤„ç†ï¼Œå› æ­¤å°±å‡ºç°äº†éšå¤„å¯è§çš„ <code>if err != nil</code> ä»£ç ç‰‡æ®µã€‚</p>
<p>ä¸€å¼€å§‹ï¼Œæ¯ä¸ªå‡½æ•°è°ƒç”¨åéƒ½è¿›è¡Œä¸€æ¬¡é”™è¯¯æ£€æŸ¥è®©äººæ„Ÿè§‰å¾ˆå´©æºƒã€‚å¯¹äºè®¸å¤š Go æ–°æ‰‹æ¥è¯´ï¼Œè¿™éå¸¸ç—›è‹¦ã€‚åœ¨æˆ‘ä»¬åˆšæ¥è§¦åˆ°é”™è¯¯å¤„ç†çš„æ—¶å€™å°±å¼€å§‹ä¸ºå®ƒè¿™ç§ç¹ççš„å¤„ç†æ–¹å¼æ„Ÿåˆ°åŒæ¶äº†ã€‚</p>
<p>æœ‰ä¸€ä¸ªè‘—åçš„ç”¨äºå¤„ç†æ‚²ç—›å’Œå¤±å»çš„æ¨¡å‹ï¼Œå®ƒæ˜¯ç”±ç¾ç±ç‘å£«å¿ƒç†å­¦å®¶ Elisabeth KÃ¼bler-Ross åœ¨1969å¹´æå‡ºã€‚å®ƒåŒ…å«äº†äº”ä¸ªé˜¶æ®µï¼šæ‹’ç»ï¼Œæ„¤æ€’ï¼Œè®¨ä»·è¿˜ä»·ï¼Œå¤±è½ï¼Œæ¥å—ã€‚è™½ç„¶èµ·åˆå®ƒä¸»è¦æ˜¯ç”¨äºè§£å†³è·Ÿæ­»äº¡å’Œä¼¤ç—›æœ‰å…³çš„é—®é¢˜ï¼Œä½†äº‹å®å·²ç»è¯æ˜ï¼Œå®ƒåœ¨å¤„ç†å½“ä¸€ä¸ªäººé‡åˆ°é‡å¤§å˜æ•…è€Œäº§ç”Ÿå†…å¿ƒæŠµæŠ—æ—¶éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚å­¦ä¹ ä¸€é—¨æ–°çš„ç¼–ç¨‹è¯­è¨€æ˜¾ç„¶å±äºè¿™ä¸€èŒƒç•´ã€‚</p>
<p>åœ¨æˆ‘æ‹¥æŠ± Go çš„é”™è¯¯å¤„ç†æ¨¡å¼çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ç»å†äº†æ‰€æœ‰è¿™äº”ä¸ªé˜¶æ®µï¼Œä¸‹é¢æˆ‘å°±è·Ÿä½ åˆ†äº«ä¸€ä¸‹æˆ‘çš„æ—…ç¨‹ã€‚</p>
<p>é‚£ä¹ˆï¼Œä¸€åˆ‡éƒ½ä»æ‹’ç»å¼€å§‹è¯´èµ·å§ã€‚</p>
<h3 id="æ‹’ç»"><a href="#æ‹’ç»" class="headerlink" title="æ‹’ç»"></a>æ‹’ç»</h3><p>â€œä¸€å®šæ˜¯å“ªé‡Œå‡ºé”™äº†ï¼Œä¸åº”è¯¥å‡ºç°è¿™ä¹ˆå¤šé”™è¯¯æ£€æŸ¥â€¦â€</p>
<p>è¿™æ˜¯æˆ‘åˆšå¼€å§‹å†™ Go ä»£ç æ—¶çš„æƒ³æ³•ã€‚æˆ‘ä¸‹æ„è¯†çš„æƒ³æ‰¾ Go é‡Œçš„å¼‚å¸¸æœºåˆ¶ï¼Œä½†æˆ‘æ²¡æ‰¾åˆ°ã€‚Go æœ‰æ„åœ°å»æ‰äº†å¯¹å¼‚å¸¸çš„æ”¯æŒã€‚</p>
<p>ä½¿ç”¨å¼‚å¸¸çš„ä¸€ä¸ªé—®é¢˜æ˜¯ä½ æ°¸è¿œéƒ½ä¸çŸ¥é“ä¸€ä¸ªå‡½æ•°æ˜¯å¦ä¼šæŠ›å¼‚å¸¸ã€‚å½“ç„¶äº†ï¼ŒJava é€šè¿‡ <code>throws</code> å…³é”®å­—æ¥æ˜¾å¼å£°æ˜äº†ä¸€ä¸ªå‡½æ•°å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè¿™è§£å†³äº†å¼‚å¸¸ä¸æ˜ç¡®çš„é—®é¢˜ï¼Œä½†åŒæ—¶ä¹Ÿä½¿å¾—ä»£ç å˜å¾—éå¸¸å•°å—¦ã€‚æœ‰äººè¯´æˆ‘å¯ä»¥åœ¨æ–‡æ¡£ä¸­æŠŠè¿™ä¸ªé—®é¢˜è¯´æ¸…æ¥šï¼Œä½†æ–‡æ¡£ä¹Ÿä¸æ˜¯é“¶å¼¹ï¼Œé€šå¸¸æ›´æ–°ä¸åŠæ—¶çš„æ–‡æ¡£æ˜¯å¤§éƒ¨åˆ†é¡¹ç›®æ°¸è¿œçš„ç—›ã€‚</p>
<p>Go ä¸­çš„é”™è¯¯å¤„ç†æœºåˆ¶ä½“ç°äº†ä¸€è‡´æ€§ï¼šæ¯ä¸ªå¯èƒ½äº§ç”Ÿé”™è¯¯çš„å‡½æ•°éƒ½åº”åœ¨æœ€åä¸€ä¸ªè¿”å›å€¼ä¸­è¿”å›ä¸€ä¸ª <code>error</code> ç±»å‹ã€‚</p>
<p>å¦‚æœä½ æ­£å¸¸å¤„ç†äº†é”™è¯¯ï¼Œé‚£ä¸€åˆ‡ç›¸å®‰æ— äº‹ï¼Œä»£ç ä¼šç»§ç»­è¿è¡Œã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœä½ è§‰å¾—æ²¡æœ‰å¿…è¦è¿›è¡Œé”™è¯¯æ£€æŸ¥ï¼Œä½ å®Œå…¨å¯ä»¥å¿½ç•¥å®ƒã€‚å½“å‡ºç°é”™è¯¯æ—¶ï¼Œå…¶å®ƒçš„è¿”å›å€¼é»˜è®¤åˆ™æ˜¯é›¶å€¼ï¼Œè¿™æ ·æœ‰äº›é”™è¯¯ä½ å®Œå…¨ä¸å¿…ç†ä¼šã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Let's convert a string into int64.</span></span><br><span class="line"><span class="comment">// We don't care whether strconv.ParseInt returns an error</span></span><br><span class="line"><span class="comment">// as the first returned value will be 0 if it fails to convert.</span></span><br><span class="line">i, _ := strconv.ParseInt(strVal, <span class="number">10</span>, <span class="number">64</span>)</span><br><span class="line">log.Printf(<span class="string">"Parsed value is: %d"</span>, i)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¾‹å¦‚ä¸Šé¢çš„ ParseInt å‡½æ•°ï¼Œå½“è½¬æ¢é”™è¯¯æ—¶ i é»˜è®¤ä¸º0ï¼Œå› ä¸ºå¯¹äºè½¬æ¢çš„é”™è¯¯ä½ å³ä½¿ä¸åšå¤„ç†ä¹Ÿæ˜¯ ok çš„ï¼Œä½†æ˜¯å¯¹äºåç»­çš„å¤„ç†é€»è¾‘åˆ™æ— æ³•åŒºåˆ†æ˜¯å› ä¸ºè½¬æ¢é”™è¯¯å¯¼è‡´ i ç­‰äº0ï¼Œè¿˜æ˜¯æœ¬èº«è½¬æ¢çš„å†…å®¹å°±æ˜¯0è¿™ä¸¤ç§æƒ…å†µã€‚</p>
</blockquote>
<p>ä½†æ˜¯å¦‚æœä½ ä»…ä»…æ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¹¶æ²¡æœ‰å¤„ç†å®ƒçš„è¿”å›å€¼ï¼Œé‚£ä¹ˆä½ å¾ˆå®¹æ˜“å¿˜è®°è¿™ä¸ªå‡½æ•°å¯èƒ½è¿˜ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨ä¹‹å‰åœ¨æ–‡æ¡£ä¸­æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°æ˜¯å¦ä¼šè¿”å›é”™è¯¯æ°¸è¿œéƒ½æ˜¯æ˜æ™ºçš„åšæ³•ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http.ListenAndServe returns an error, but we don't check for it.</span></span><br><span class="line"><span class="comment">// Since we don't use returned values further, this code will compile.</span></span><br><span class="line">http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// However, it is still better to check the returned error for consistency.</span></span><br><span class="line">err := http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  log.Fatalf(<span class="string">"Can't start the server: %s"</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ„¤æ€’"><a href="#æ„¤æ€’" class="headerlink" title="æ„¤æ€’"></a>æ„¤æ€’</h3><p>æœ‰è®¸å¤šç¼–ç¨‹è¯­è¨€éƒ½æœ‰æ‰€è°“â€œæ­£å¸¸â€çš„é”™è¯¯å¤„ç†ï¼ˆç±»ä¼¼äº <code>try catch</code>ï¼‰ï¼Œé‚£æˆ‘ä¸ºä»€ä¹ˆè¦ç”¨è¿™ç§å¥‡æ€ªçš„åƒåƒåœ¾ç¢ç‰‡ä¸€æ ·çš„â€œæŠŠé”™è¯¯ä½œä¸ºå‡½æ•°ç»“æœâ€æ¥è¿”å›å‘¢ï¼Ÿ</p>
<p>ä½œä¸ºä½œè€…ï¼Œè¿™ä¸¤ç§å¤„ç†æœºåˆ¶æˆ‘éƒ½ä½¿ç”¨è¿‡ã€‚Go ä¸ä»…ä»…æ˜¯å°†é‚£äº›æˆ‘ä¹ ä»¥ä¸ºå¸¸çš„ exception å½“æˆ error æ¥æ›¿æ¢ï¼Œè¿™è®©æˆ‘å¯¹è¿™é—¨è¯­è¨€æ„Ÿåˆ°æ„¤æ…¨ã€‚ç„¶è€Œæ›´å¥½çš„åšæ³•æ˜¯å°†è¿™ç§ error è§†ä¸ºæ–¹æ³•æ˜¯å¦è¢«æˆåŠŸæ‰§è¡Œçš„æŒ‡ç¤ºã€‚</p>
<p>å¦‚æœä½ æ›¾ç»åœ¨ Rails ä¸­ç”¨è¿‡ <code>active record</code>ï¼Œä½ å¯èƒ½ä¼šç†Ÿæ‚‰è¿™æ ·çš„ä»£ç ï¼š</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">user = User.new(user_params)</span><br><span class="line"><span class="keyword">if</span> user.save</span><br><span class="line">  head <span class="symbol">:ok</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  render <span class="symbol">json:</span> user.errors, <span class="symbol">status:</span> <span class="number">422</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>if</code> åé¢çš„ <code>user.save</code> æ˜¯ä¸€ä¸ª bool å€¼ï¼Œå®ƒè¡¨ç¤ºæ˜¯å¦æˆåŠŸä¿å­˜äº†ç”¨æˆ·çš„å®ä¾‹ã€‚<code>user.errors</code> åˆ™è¿”å›äº†å¯èƒ½å‘ç”Ÿçš„ error åˆ—è¡¨ç»“æœã€‚å½“æ—¶ä¿å­˜ç”¨æˆ·å®ä¾‹å¤±è´¥çš„æ—¶å€™ï¼Œ <code>user</code> å°±ä¼šåŒ…å« <code>errors</code>ï¼Œè¿™ç§æ–¹æ³•ç»å¸¸è¢«æ‰¹è¯„ä¸ºåæ¨¡å¼ã€‚</p>
<p>ç„¶è€Œï¼ŒGo è¯­è¨€è‡ªå¸¦æŠ¥å‘Šæ–¹æ³•â€å¤±è´¥ç»†èŠ‚â€œçš„å†…ç½®æ¨¡å¼ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰ä»€ä¹ˆå‰¯ä½œç”¨ã€‚æ¯•ç«Ÿï¼ŒGo çš„ error åªæ˜¯ä¸€ä¸ªå«æœ‰å•ä¸ªæ–¹æ³•çš„æ¥å£ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> &#123;</span><br><span class="line">  Error() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥ä»»æ„å»é›†æˆè¿™ä¸ªæ¥å£ã€‚å¦‚æœæƒ³è¦æä¾›ä¸€äº›éªŒè¯é”™è¯¯çš„ä¿¡æ¯ï¼Œå¯ä»¥å®šä¹‰å¦‚ä¸‹çš„ç»“æ„ä½“ç±»å‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ValidationErr <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="comment">// We will store validation errors here.</span></span><br><span class="line">  <span class="comment">// The key is a field name, and the value is a slice of validation messages.</span></span><br><span class="line">  ErrorMessages <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *ValidationErr)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> FormatErrors(e.ErrorMessages)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…³äºå¦‚ä½•æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯å¹¶ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œ æ‰€ä»¥æˆ‘çœå»äº† <code>FormatErrors</code> æ–¹æ³•çš„å…·ä½“å®ç°ã€‚æˆ‘ä»¬åªè¯´å¦‚ä½•å°†é”™è¯¯ä¿¡æ¯åˆå¹¶æˆå•ä¸ªçš„å­—ç¬¦ä¸²ã€‚</p>
<p>ç°åœ¨å‡è®¾æˆ‘ä»¬ç”¨ Go è¯­è¨€å†™äº†ä¸€ä¸ªç±»ä¼¼ Rails çš„æ¡†æ¶ï¼Œ<code>actions handler</code> çš„å¤„ç†æ–¹å¼å°±åƒè¿™æ ·ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a * Action)</span> <span class="title">Handle</span><span class="params">()</span></span> &#123;</span><br><span class="line">  user := NewUser(a.Params[<span class="string">"user"</span>])</span><br><span class="line">  <span class="keyword">if</span> err := user.Save(); err == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// No errors, yay! Respond with 200.</span></span><br><span class="line">    a.Respond(<span class="number">200</span>, <span class="string">"OK"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> verr, ok := err.(*ValidationErr); ok &#123;</span><br><span class="line">    <span class="comment">// err was successfully typecast to ValidationErr.</span></span><br><span class="line">    <span class="comment">// Let's respond with 422.</span></span><br><span class="line">    resp, _ := json.Marshal(verr.ErrorMessages)</span><br><span class="line">    a.Respond(<span class="number">422</span>, <span class="keyword">string</span>(resp), <span class="string">"application/json"</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Unexpected error, respond with 500.</span></span><br><span class="line">    a.Respond(<span class="number">500</span>, err.Error(), <span class="string">"text/plain"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°±è¿™æ ·ï¼Œé”™è¯¯éªŒè¯æ˜¯å‡½æ•°è¿”å›çš„åˆæ³•éƒ¨åˆ†ï¼Œæˆ‘ä»¬å‡å°‘äº† <code>user.Save</code> æ–¹æ³•çš„å‰¯ä½œç”¨ã€‚æ‰€æœ‰éé¢„æœŸçš„é”™è¯¯éƒ½æ˜¯åœ¨æ˜¾å¼çš„è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯éšè—åœ¨æ¡†æ¶é‡Œé¢ã€‚å¦‚æœè¿˜å‡ºç°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤„ç†åç»­é€»è¾‘ä¹‹å‰é‡‡å–å…¶ä»–å¿…è¦çš„æªæ–½ã€‚</p>
<p>è¿”å›é”™è¯¯çš„æ—¶å€™å¦‚æœæœ‰é¢å¤–çš„ä¿¡æ¯ï¼Œè¿™æ€»å½’æ˜¯å¥½çš„ã€‚è®¸å¤šæµè¡Œçš„ Go åŒ…éƒ½ä¼šç”¨ä»–ä»¬è‡ªå·±å®ç°çš„ error æ¥å£ï¼Œæ¯”å¦‚æˆ‘çš„ imgproxy ä¹Ÿä¸ä¾‹å¤–ã€‚æ­¤å¤„ï¼Œæˆ‘ç”¨äº†è‡ªå®šä¹‰çš„ imgproxyError ç»“æ„ä½“ï¼Œå®ƒæ¥å‘Šè¯‰ HTTP handler åº”è¯¥è¿”å›ä»€ä¹ˆçŠ¶æ€ç ï¼Œè¿”å›ç»™ä¸Šå±‚è°ƒç”¨è€…ä»€ä¹ˆæ¶ˆæ¯ï¼Œåœ¨æ—¥å¿—ä¸­åº”è¯¥æ‰“å°ä»€ä¹ˆä¿¡æ¯ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> imgproxyError <span class="keyword">struct</span> &#123;</span><br><span class="line">  StatusCode    <span class="keyword">int</span></span><br><span class="line">  Message       <span class="keyword">string</span></span><br><span class="line">  PublicMessage <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *imgproxyError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> e.Message</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥æ¼”ç¤ºä¸€ä¸‹æˆ‘æ˜¯å¦‚ä½•ç”¨è¿™ç§æ–¹å¼çš„:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ierr, ok := err.(*imgproxyError); ok &#123;</span><br><span class="line">  respondWithError(ierr)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  msg := fmt.Sprintf(<span class="string">"Unexpected error: %s"</span>, err)</span><br><span class="line">  respondWithError(&amp;imgproxyError&#123;<span class="number">500</span>, msg, <span class="string">"Internal error"</span>&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œåœ¨ä¹‹å‰ï¼Œæˆ‘æ‰€åšçš„å°±æ˜¯æ£€æŸ¥é”™è¯¯ç±»å‹æ˜¯å¦æ˜¯æˆ‘æ‰€å®šä¹‰çš„ç±»å‹ï¼Œä¸æ˜¯æˆ‘å®šä¹‰çš„ç±»å‹è¯´æ˜ä¸æ˜¯é¢„æœŸçš„é”™è¯¯ã€‚é‚£ä¹ˆå°±å°†å®ƒè½¬åŒ–æˆ imgproxyError å®ä¾‹ï¼Œä»¥æ­¤æ¥å‘Šè¯‰ HTTP handler å»å“åº”500çš„çŠ¶æ€ç å¹¶è®©ç¨‹åºåœ¨æ—¥å¿—ä¸­æ‰“å°é”™è¯¯ä¿¡æ¯ã€‚</p>
<p>è¿™é‡Œæœ‰å¿…è¦è¯´ä¸€ä¸ª Go ä¸­ç±»å‹è½¬æ¢çš„æ³¨æ„äº‹é¡¹ï¼Œæ¯•ç«Ÿå®ƒæ€»æ˜¯è®©æ–°æ‰‹å›°æ‰°ã€‚ä½ å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è¿›è¡Œç±»å‹è½¬æ¢ï¼Œä¸è¿‡å»ºè®®æœ€å¥½è¿˜æ˜¯ç”¨ç›¸å¯¹å®‰å…¨çš„æ–¹å¼ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Unsafe. If err is not *imgproxyError, Go will panic.</span></span><br><span class="line">ierr := err.(*imgproxyError)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Safe way. ok indicates if interface was typecast successfully or not.</span></span><br><span class="line"><span class="comment">// Go will not panic even if the interface represents the wrong type.</span></span><br><span class="line">ierr, ok := err.(*imgproxyError)</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Go æƒ¯ç”¨çš„é”™è¯¯å¤„ç†å¯ä»¥éå¸¸çš„çµæ´»ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è¿›å…¥ä¸‹ä¸€ä¸ªç¯èŠ‚ - è®¨ä»·è¿˜ä»·ã€‚</p>
<h3 id="è®¨ä»·è¿˜ä»·"><a href="#è®¨ä»·è¿˜ä»·" class="headerlink" title="è®¨ä»·è¿˜ä»·"></a>è®¨ä»·è¿˜ä»·</h3><p>â€œå“ªé‡Œå‡ºç°é”™è¯¯ï¼Œå“ªé‡Œå¤„ç†é”™è¯¯â€ï¼Œè¿™ç§é”™è¯¯å¤„ç†çš„æ–¹å¼ä¾æ—§å¯¹æˆ‘æ¥è¯´å¾ˆé™Œç”Ÿï¼Œä¹Ÿè®¸æˆ‘èƒ½åšäº›ä»€ä¹ˆè®©å®ƒæ›´åƒæˆ‘å–œæ¬¢çš„è¯­è¨€ã€‚</p>
<p>åœ¨ä»£ç æ¯ä¸ªå¯èƒ½å‡ºç°çš„åœ°æ–¹éƒ½è¿›è¡Œé”™è¯¯å¤„ç†æ˜¯ä¸€ä»¶å¾ˆéº»çƒ¦çš„äº‹æƒ…ã€‚å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬éƒ½æƒ³æŠŠé”™è¯¯æå‡åˆ°æŸäº›å¯ä»¥æ‰¹é‡æˆ–é›†ä¸­å¤„ç†çš„åœ°æ–¹ã€‚è¿™ç§æ–¹å¼ï¼Œæœ€æ˜¾è€Œæ˜“è§çš„å°±æ˜¯å‡½æ•°åµŒå¥—è°ƒç”¨ï¼Œåœ¨æœ€ä¸Šå±‚å¤„ç†æ‰æ¥è‡ªåº•å±‚çš„æ–¹æ³•æ‰€äº§ç”Ÿçš„é”™è¯¯ã€‚</p>
<p>çœ‹ä¸€ä¸‹è¿™ä¸ªå…¬è®¤çš„å‡½æ•°è°ƒç”¨å‡½æ•°çš„ä¾‹å­ï¼ŒæœŸæœ›åœ¨æœ€é¡¶å±‚å¤„ç†æ‰æ‰€æœ‰çš„errorï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"errors"</span></span><br><span class="line">  <span class="string">"log"</span></span><br><span class="line">  <span class="string">"math"</span></span><br><span class="line">  <span class="string">"strconv"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// The principal function to be called where all errors will end up.</span></span><br><span class="line"><span class="comment">// Takes a numeric string, logs a square root of that number.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LogSqrt</span><span class="params">(str <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  f, err := StringToSqrt(str)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    HandleError(err) <span class="comment">// a function where he handle all errors</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  log.Printf(<span class="string">"Sqrt of %s is %f"</span>, str, f)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tries to parse a float64 out of a string and returns its square root.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StringToSqrt</span><span class="params">(str <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">float64</span>, error)</span></span> &#123;</span><br><span class="line">  f, err := strconv.ParseFloat(str, <span class="number">64</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  f, err = Sqrt(f)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> f, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Calculates a square root of the float.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sqrt</span><span class="params">(f <span class="keyword">float64</span>)</span> <span class="params">(<span class="keyword">float64</span>, error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> f &lt; <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"Can't calc sqrt of a negative number"</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> math.Sqrt(f), <span class="literal">nil</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ Go è¯­è¨€æƒ¯ç”¨çš„æ–¹å¼ï¼Œæ˜¯çš„ï¼Œçœ‹èµ·æ¥åˆè‡­åˆé•¿ã€‚å¥½åœ¨å†™ Go è¯­è¨€çš„äººå¥½åƒä¹Ÿæ‰¿è®¤äº†è¿™ä¸ªé—®é¢˜ã€‚ç›®å‰ä»–ä»¬æ­£åœ¨å°± Go 2 çš„é”™è¯¯æ£€æŸ¥å’Œå¤„ç†é—®é¢˜å‘èµ·è®¨è®ºã€‚å®˜æ–¹é”™è¯¯å¤„ç†è‰æ¡ˆå¼•å…¥äº†ä¸€ä¸ªæ–°çš„ construct <code>check ... handle</code>ï¼Œå…³äºå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè‰æ¡ˆæ˜¯è¿™ä¹ˆè¯´çš„ï¼š</p>
<ul>
<li>check è¯­å¥é€‚ç”¨äº error ç±»å‹çš„è¡¨è¾¾å¼æˆ–è€…å‡½æ•°è¿”å›ä»¥ error ç±»å‹å€¼ç»“å°¾çš„å‡½æ•°è°ƒç”¨ã€‚å¦‚æœ error é nilï¼Œcheck è¯­å¥å°†ä¼šè¿”å›é—­åŒ…æ–¹æ³•çš„ç»“æœï¼Œè€Œè¿™ä¸ªé—­åŒ…æ–¹æ³•æ˜¯é€šè¿‡ error å€¼è°ƒç”¨å¤„ç†ç¨‹åºé“¾è§¦å‘çš„ã€‚</li>
<li>handle è¯­å¥å®šä¹‰çš„ä»£ç å—å°±æ˜¯ handlerï¼Œç”¨æ¥å¤„ç† check è¯­å¥æ£€æµ‹åˆ°çš„ errorã€‚handler ä¸­çš„ return è¯­å¥ä¼šå¯¼è‡´é—­åŒ…å‡½æ•°ç«‹åˆ»è¿”å›ç»™å®šçš„è¿”å›å€¼ã€‚åªæœ‰é—­åŒ…å‡½æ•°æ²¡æœ‰ç»“æœæˆ–ä½¿ç”¨å‘½åç»“æœçš„æ—¶å€™ï¼Œ æ‰å…è®¸ä¸å¸¦è¿”å›å€¼ã€‚åœ¨åä¸€ç§æƒ…å†µä¸‹ï¼Œå‡½æ•°è¿”å›é‚£äº›ç»“æœçš„å½“å‰å€¼ã€‚</li>
</ul>
<p>ä¾æ—§æ˜¯ square çš„ä¾‹å­ï¼Œç°åœ¨ç”¨å¦ä¸€ç§æ–¹å¼æ¥è¿›è¡Œé”™è¯¯å¤„ç†ã€‚Go 2 å·²ç»å‘å¸ƒï¼Œå®˜æ–¹å»ºè®®çš„å†™æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"errors"</span></span><br><span class="line">  <span class="string">"log"</span></span><br><span class="line">  <span class="string">"math"</span></span><br><span class="line">  <span class="string">"strconv"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LogSqrt</span><span class="params">(str <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  handle err &#123; HandleError(err) &#125; <span class="comment">// where the magic happens</span></span><br><span class="line">  log.Printf(<span class="string">"Sqrt of %s is %f"</span>, str, check StringToSqrt(str))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StringToSqrt</span><span class="params">(str <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">float64</span>, error)</span></span> &#123;</span><br><span class="line">  handle err &#123; <span class="keyword">return</span> <span class="number">0</span>, err &#125; <span class="comment">// no need to explicitly if...else</span></span><br><span class="line">  <span class="keyword">return</span> check math.Sqrt(check strconv.ParseFloat(str, <span class="number">64</span>)), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sqrt</span><span class="params">(f <span class="keyword">float64</span>)</span> <span class="params">(<span class="keyword">float64</span>, error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> f &lt; <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"Can't calculate sqrt of a negative number"</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> math.Sqrt(f), <span class="literal">nil</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹ä¸Šå»å¥½ä¸€äº›äº†ï¼Œä½†æ˜¯è·ç¦»çœŸæ­£ç”¨ Go 2 åšå®é™…å¼€å‘ä»æ—§æœ‰ä¸€æ®µè·ç¦»ã€‚</p>
<p>ä¸æ­¤åŒæ—¶ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥ç”¨å¦ä¸€ç§é”™è¯¯å¤„ç†çš„æ–¹å¼ï¼Œä»–å¯ä»¥æ˜¾è‘—å‡å°‘ <code>if ... else</code> è¯­å¥ï¼Œå¹¶ä¸”å…è®¸å‡ºç°å•ç‚¹çš„ errorã€‚æˆ‘å«è¿™ç§æ–¹æ³•ä¸ºâ€œPanic é©±åŠ¨çš„é”™è¯¯å¤„ç†â€ã€‚</p>
<p>ä¸ºäº†åšåˆ°â€œPanic é©±åŠ¨â€ï¼Œå°†ä¾èµ–å†…ç½®äº Go è¯­è¨€çš„ä¸‰ä¸ªå…³é”®è¯ï¼šdeferï¼Œpanicï¼Œrecoverã€‚è¿™é‡Œç¨å¾®å›é¡¾ä¸€ä¸‹ä»–ä»¬åˆ†æ—¶æ˜¯ä»€ä¹ˆï¼š</p>
<ul>
<li>defer å°†å‡½æ•° push åˆ°æœ¬å‡½æ•°è¿”å›åæ‰§è¡Œçš„å †æ ˆä¸­ï¼Œå½“ä½ éœ€è¦ä¸€äº›æ¸…ç†æ—¶å€™ä¼šæ´¾ä¸Šç”¨åœºã€‚åœ¨æˆ‘ä»¬çš„è¿™ä¸ª case é‡Œé¢ï¼Œä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ° defer å‘¢ï¼Ÿå°±æ˜¯ä» panic ä¸­ recover çš„æ—¶å€™ï¼Œéœ€è¦ç”¨åˆ° deferã€‚</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Foo</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, _ := os.Open(<span class="string">"filename"</span>)</span><br><span class="line"><span class="comment">// defer ensures that f.Close() will be executed when Foo returns.</span></span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>panic ä¼šåœæ­¢æ™®é€šçš„ç¨‹åºæµæ§åˆ¶å¹¶å¼€å§‹ panickingã€‚å½“å‡½æ•°å¼€å§‹ panicï¼Œç¨‹åºçš„æ­£å¸¸æ‰§è¡Œä¼šè¢«ä¸­æ­¢ï¼Œç¨‹åºå¼€å§‹è°ƒç”¨å †æ ˆæ‰§è¡Œæ‰€æœ‰çš„ defer æ–¹æ³•ï¼ŒåŒæ—¶åœ¨å½“å‰çš„ goroutine çš„ root goroutine ç¨‹åºå¼€å§‹å´©æºƒã€‚</li>
<li>recover é‡æ–°è·å–æ­£åœ¨ panic çš„ goroutine çš„æ§åˆ¶ï¼Œå¹¶è¿”å›è§¦å‘ panic çš„ interfaceã€‚recover ä»…åœ¨ defer ä¸­æœ‰æ•ˆï¼Œåœ¨å…¶ä»–åœ°æ–¹å°†è¿”å› nilã€‚</li>
</ul>
<p>BTWï¼Œçº¯ç²¹çš„è®²ï¼Œä¸‹é¢çš„ä»£ç ä¸ä»£è¡¨æœ€å¸¸è§çš„ Goã€‚çµæ„Ÿæ¥è‡ªäº Gin çš„æºç ï¼ˆGin æ˜¯å½“å‰æ¯”è¾ƒæµè¡Œçš„Go é¢†åŸŸçš„ web æ¡†æ¶ï¼‰æˆ‘è‡ªå·±å¹¶æ²¡æœ‰å®Œå…¨æƒ³çš„å‡ºå®ƒã€‚ åœ¨ Gin æ¡†æ¶é‡Œé¢ï¼Œå¦‚æœä¸€ä¸ª critical error å‘ç”Ÿäº†ï¼Œä½ å¯ä»¥åœ¨ handler ç¨‹åºä¸­è°ƒç”¨ panicï¼Œç„¶å Gin ä¼š recoverï¼Œæ‰“å°é”™è¯¯æ—¥å¿—å¹¶ä¸”è¿”å›500çŠ¶æ€ç ã€‚</p>
<p>ç”± Panic é©±åŠ¨é”™è¯¯å¤„ç†çš„æƒ³æ³•å¾ˆç®€å•ï¼šåªè¦åµŒå¥—è°ƒç”¨è¿”å› error å¼•å‘çš„ panicï¼ˆè¯‘è€…æ³¨ï¼šcheckErr å°è£…ä½œä¸º referenceï¼Œæœ‰å¤šå¤„åœ°æ–¹è°ƒç”¨ï¼‰ï¼Œåœ¨ recover çš„æ—¶å€™æœ‰å•ç‹¬çš„åœ°æ–¹è¿›è¡Œé”™è¯¯å¤„ç†ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"errors"</span></span><br><span class="line">  <span class="string">"log"</span></span><br><span class="line">  <span class="string">"math"</span></span><br><span class="line">  <span class="string">"strconv"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// A simple helper to panic on errors.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkErr</span><span class="params">(err error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LogSqrt</span><span class="params">(str <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  <span class="comment">// It is important to defer the anonymous function that wraps around error handling.</span></span><br><span class="line">  <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> err, ok := r.(error); ok &#123;</span><br><span class="line">        <span class="comment">// Recover returned an error, handle it somehow.</span></span><br><span class="line">        HandleError(err)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Recover returned something that is not an error, so "re-panic".</span></span><br><span class="line">        <span class="built_in">panic</span>(r)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A call that starts a chain of events that might go wrong</span></span><br><span class="line">  log.Printf(<span class="string">"Sqrt of %s is %f"</span>, str, StringToSqrt(str))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StringToSqrt</span><span class="params">(str <span class="keyword">string</span>)</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">  f, err := strconv.ParseFloat(str, <span class="number">64</span>)</span><br><span class="line">  checkErr(err)</span><br><span class="line"></span><br><span class="line">  f, err = Sqrt(f)</span><br><span class="line">  checkErr(err)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sqrt</span><span class="params">(f <span class="keyword">float64</span>)</span> <span class="params">(<span class="keyword">float64</span>, error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> f &lt; <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"Can't calculate sqrt of a negative number"</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> math.Sqrt(f), <span class="literal">nil</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çš„ç¡®ï¼Œ è¿™çœ‹èµ·æ¥ä¸åƒå…¶ä»–è¯­è¨€ä¸Šçš„ <code>try catch</code>ï¼Œä½†æ˜¯å´è®©æˆ‘ä»¬å°†é”™è¯¯å¤„ç†è¿™æ ·çš„è´£ä»»ç§»åŠ¨åˆ°å¯¹åº”çš„è°ƒç”¨é“¾ä¸Šã€‚</p>
<p>åœ¨ imgproxy è¿™ä¸ªæ¨¡å—é‡Œé¢ï¼Œæˆ‘ç”¨è¿™ç§æ–¹å¼å®ç°å½“è¾¾åˆ° timeout å°±åœæ­¢å›¾ç‰‡åŠ è½½ã€‚å›åˆ°ä¹‹å‰è¯´çš„ï¼Œå¦‚æœåœ¨æ¯ä¸ªæ–¹æ³•ä¸­è¾¾åˆ°timeoutå°±è¦è¿›è¡Œ timeout error çš„å¤„ç†ï¼Œè¿™æ˜¯å¾ˆè®©äººçƒ¦æ¼çš„ï¼Œç°åœ¨ï¼Œæˆ‘å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ç”¨ä¸€è¡Œä»£ç è¿›è¡Œ timeout çš„ checkã€‚</p>
<p>å…³äº error çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¹ŸåŒæ ·å¸Œæœ›èƒ½æ·»åŠ æ›´å¤šçš„ä¿¡æ¯ï¼Œä½†æ˜¯golangçš„æ ‡å‡†é”™è¯¯ç±»å‹å¹¶æ²¡æœ‰æä¾›å †æ ˆè·Ÿè¸ªä¿¡æ¯ã€‚å¥½åœ¨å¯ä»¥ç›´æ¥ç”¨ github.com/pkg/errors æ¥æ›¿æ¢å†…ç½®çš„ errors åŒ…ã€‚ä½ åªéœ€è¦ç”¨ <code>import â€œgithub.com/pkg/errorsâ€</code> æ›¿æ¢ <code>import â€œerrorsâ€</code>ï¼Œç„¶åä½ çš„ errors å°±å¯ä»¥åŒ…å«å †æ ˆè·Ÿè¸ªä¿¡æ¯äº†ã€‚æ³¨æ„ç°åœ¨èµ·ï¼Œä½ å¯ä¸æ˜¯åœ¨å¤„ç†é»˜è®¤çš„ error ç±»å‹ã€‚ä¸‹é¢å°±æ˜¯æ ‡å‡†ç±»åº“çš„æ›¿ä»£æ–¹æ¡ˆæ‰€å»ºè®®çš„ï¼š</p>
<ul>
<li><code>func New(message string)</code> æ˜¯ç±»ä¼¼äºå†…ç½® errors åŒ…çš„åŒåå‡½æ•°ã€‚å®ƒå®ç°å¹¶è¿”å›äº†åŒ…å«å †æ ˆä¿¡æ¯çš„ error ç±»å‹</li>
<li><code>func WithMessage(err error,message string)</code> å°†ä½ çš„ error å°è£…åˆ°å¦ä¸€ä¸ªç±»å‹é‡Œé¢ï¼Œ å¹¶ä¸”è¿™ä¸ªç±»å‹åŒ…å«äº†ä¸€äº›é¢å¤–çš„ä¿¡æ¯ã€‚</li>
<li><code>fuc WithStack(err error) error</code> å°è£…äº†ä½ çš„ error åˆ°å¦ä¸€ä¸ªç±»å‹ï¼Œ è¿™ä¸ªç±»å‹åŒ…å«äº†å †æ ˆä¿¡æ¯ã€‚å½“ä½ ç”¨ç¬¬ä¸‰æ–¹åŒ…æ—¶ï¼Œç›¸å½“å½“å‰ç±»å‹çš„ error æ·»åŠ åˆ°ç¬¬ä¸‰æ–¹åŒ…çš„ errorï¼›æˆ–è€…æƒ³è¦æ·»åŠ å †æ ˆä¿¡æ¯åˆ°ç¬¬ä¸‰æ–¹åŒ…çš„ errorã€‚</li>
<li><code>func Wrap(err error,messag string) error</code> æ˜¯ WithStack+WitchMessage çš„ç¼©å†™ã€‚</li>
</ul>
<p>è¯•ç€ç”¨åˆšæ‰è¯´çš„æ–¹æ³•æ”¹è¿›ä¸€ä¸‹ä¹‹å‰çš„ä»£ç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"log"</span></span><br><span class="line">  <span class="string">"math"</span></span><br><span class="line">  <span class="string">"strconv"</span></span><br><span class="line"></span><br><span class="line">  <span class="string">"github.com/pkg/errors"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkErr</span><span class="params">(err error, msg <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(errors.WithMessage(err, msg))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkErrWithStack</span><span class="params">(err error, msg <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(errors.Wrap(err, msg))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LogSqrt</span><span class="params">(str <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> err, ok := r.(error); ok &#123;</span><br><span class="line">        <span class="comment">// Print the error to the log before handling.</span></span><br><span class="line">        <span class="comment">// %+v prints formatted error with additional messages and a stack trace:</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Failed to sqrt: Can't calc sqrt of a negative number</span></span><br><span class="line">        <span class="comment">// main.main /app/main.go:14</span></span><br><span class="line">        <span class="comment">// runtime.main /goroot/libexec/src/runtime/proc.go:198</span></span><br><span class="line">        <span class="comment">// runtime.goexit /goroot/libexec/src/runtime/asm_amd64.s:2361</span></span><br><span class="line">        log.Printf(<span class="string">"%+v"</span>, err)</span><br><span class="line">        HandleError(err)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(r)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  log.Printf(<span class="string">"Sqrt of %s is %f"</span>, str, StringToSqrt(str))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StringToSqrt</span><span class="params">(str <span class="keyword">string</span>)</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">  f, err := strconv.ParseFloat(str, <span class="number">64</span>)</span><br><span class="line">  checkErrWithStack(err, <span class="string">"Failed to parse"</span>)</span><br><span class="line"></span><br><span class="line">  f, err = Sqrt(f)</span><br><span class="line">  checkErr(err, <span class="string">"Failed to sqrt"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sqrt</span><span class="params">(f <span class="keyword">float64</span>)</span> <span class="params">(<span class="keyword">float64</span>, error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> f &lt; <span class="number">0</span> &#123;</span><br><span class="line">    <span class="comment">// We use New from https://github.com/pkg/errors,</span></span><br><span class="line">    <span class="comment">// so our error will contain a stack trace.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"Can't calc sqrt of a negative number"</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> math.Sqrt(f), <span class="literal">nil</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>é‡è¦æç¤º</strong>ï¼šä¹Ÿè®¸ä½ å·²ç»æ³¨æ„åˆ°äº†ï¼Œerrors.WithMessage å’Œ errors.WithStack å°† github.com/pkg/errors å°è£…è¿›äº†å®šä¹‰ç±»å‹é‡Œé¢ã€‚ è¿™åŒæ—¶æ„å‘³ç€ä½ ä¸èƒ½å¯¹è‡ªå·±çš„ error å®ç°ç›´æ¥çš„è¿›è¡Œç±»å‹è½¬åŒ–äº†ã€‚ä¸ºäº†èƒ½å°† github.com/pkg/errors ç±»å‹è½¬åŒ–æˆä½ è‡ªå·±çš„ error ç±»å‹ï¼Œé¦–å…ˆéœ€è¦ç”¨errors.Cause å¯¹ github.com/pkg/errors è¿›è¡Œè§£åŒ…ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">err := PerformValidation()</span><br><span class="line"><span class="keyword">if</span> verr, ok := errors.Cause(err).(*ValidationErr); ok &#123;</span><br><span class="line">  <span class="comment">// Do something with the validation error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨çœ‹ä¼¼æœ‰å¼ºå¤§çš„æœºåˆ¶åœ¨ä¸€ä¸ªåœ°æ–¹é›†ä¸­å¤„ç†ç›¸å…³çš„é”™è¯¯ã€‚ä½†æ˜¯åˆ«é«˜å…´çš„å¤ªæ—©ï¼ŒGo è¯­è¨€ä¸­æœ€å¼ºå¤§çš„å°±æ˜¯ goroutineï¼Œgoroutine åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œè¿™ç§æ–¹æ³•å°†ä¼šå¤±è´¥ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è®²è®²è¿™ç§è®©äººæ²®ä¸§çš„æ—¶åˆ» - å¤±è½ã€‚</p>
<h3 id="å¤±è½"><a href="#å¤±è½" class="headerlink" title="å¤±è½"></a>å¤±è½</h3><p>æˆ‘åŠªåŠ›çš„åœ¨æˆ‘çš„ä»£ç ä¸­é‡‡ç”¨é›†ä¸­å¤„ç†é”™è¯¯çš„æ–¹å¼ï¼Œä½†æ˜¯å½“æˆ‘åœ¨ä½¿ç”¨ goroutines çš„æ—¶å€™å®ƒå´å¤±æ•ˆäº†ã€‚è¿™ç§é”™è¯¯å¤„ç†æœºåˆ¶å˜å¾—æ¯«æ— æ„ä¹‰ã€‚ã€‚ã€‚</p>
<p>ä¸è¦ panicï¼Œå°† panic ç•™ç»™ä½ çš„ä»£ç ã€‚åœ¨ goroutines ä¸­çš„å›ºå®šä½ç½®å¤„ç†é”™è¯¯ä¾ç„¶å¯è¡Œï¼Œæ­¤å¤„æˆ‘å°†ä½¿ç”¨ä¸æ­¢ä¸€ç§æ–¹æ³•ï¼ˆå®é™…ä¸Šæ˜¯ä¸¤ç§ï¼‰ã€‚</p>
<h3 id="Channels-å’Œ-sync-WaitGroup"><a href="#Channels-å’Œ-sync-WaitGroup" class="headerlink" title="Channels å’Œ sync.WaitGroup"></a>Channels å’Œ sync.WaitGroup</h3><p>ä½ å¯ä»¥å°† Go çš„ channel å’Œå†…ç½®çš„ sync.Waitgroup ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ç‰¹å®šçš„ channel ä¸­å¤„ç†ç›¸åº”çš„ errorsï¼ŒåŒæ—¶åœ¨å¼‚æ­¥è¿›ç¨‹å¤„ç†å®Œæˆåå¯ä»¥ä¸€ä¸ªä¸ªçš„å¤„ç†å®ƒä»¬ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">errCh := <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="comment">// We will launch two goroutines.</span></span><br><span class="line">wg.Add(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Goroutine #1</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">// We are done on return</span></span><br><span class="line">  <span class="keyword">defer</span> wg.Done()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If any error has occurred, put it into the channel.</span></span><br><span class="line">  <span class="keyword">if</span> err := dangerous.Action(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    errCh &lt;- err</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Goroutine #2</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">defer</span> wg.Done()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err := dangerous.Action(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    errCh &lt;- err</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Wait till all goroutines are done and close the channel.</span></span><br><span class="line">wg.Wait()</span><br><span class="line"><span class="built_in">close</span>(errCh)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Loop over the channel to collect all errors.</span></span><br><span class="line"><span class="keyword">for</span> err := <span class="keyword">range</span> errCh &#123;</span><br><span class="line">  HandleErr(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ä½ éœ€è¦åœ¨å¤šä¸ª goroutines ä¸­æ”¶é›†æ‰€æœ‰é”™è¯¯æ—¶ï¼Œè¿™ç§æ–¹æ³•å°†éå¸¸æœ‰ç”¨ã€‚</p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¾ˆå°‘éœ€è¦å¤„ç†æ¯ä¸ªä¸€ä¸ªé”™è¯¯ã€‚å¤šæ•°æƒ…å†µä¸‹ï¼Œè¦ä¹ˆå…¨å¤„ç†è¦ä¹ˆä¸å¤„ç†ï¼šæˆ‘ä»¬éœ€è¦çŸ¥é“æ˜¯å¦å…¶ä¸­ä¸€äº› goroutines å¤±è´¥äº†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å‡†å¤‡ä½¿ç”¨ Golang å®˜æ–¹çš„å­ä»£ç åº“ä¸­çš„ errgroup åŒ…ã€‚ä¸‹é¢ä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨å®ƒï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> g errgroup.Group</span><br><span class="line"></span><br><span class="line"><span class="comment">// g.Go takes a function that returns error.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Goroutine #1</span></span><br><span class="line">g.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="comment">// If any error has occurred, return it.</span></span><br><span class="line">  <span class="keyword">if</span> err := dangerous.Action(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Goroutine #2</span></span><br><span class="line">g.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> err := dangerous.Action(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// g.Wait waits till all goroutines are done</span></span><br><span class="line"><span class="comment">// and returns only the first error.</span></span><br><span class="line"><span class="keyword">if</span> err := g.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">  HandleErr(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åªæœ‰ errgroup.Group å†…éƒ¨å¯åŠ¨çš„ subroutines ä¸­çš„ç¬¬ä¸€ä¸ªéé›¶é”™è¯¯ï¼ˆå¦‚æœæœ‰ï¼‰æ‰ä¼šè¢«è¿”å›ã€‚è€Œæ‰€æœ‰ç¹é‡çš„å·¥ä½œéƒ½æ˜¯åœ¨å¹•åå®Œæˆçš„ã€‚</p>
<h3 id="å¼€å§‹ä½ è‡ªå·±çš„-PanicGroup"><a href="#å¼€å§‹ä½ è‡ªå·±çš„-PanicGroup" class="headerlink" title="å¼€å§‹ä½ è‡ªå·±çš„ PanicGroup"></a>å¼€å§‹ä½ è‡ªå·±çš„ PanicGroup</h3><p>æ­£å¦‚ä¹‹å‰æåˆ°çš„ï¼Œæ‰€æœ‰çš„ goroutines åœ¨ä»–ä»¬è‡ªå·±çš„èŒƒå›´é‡Œå‘ç”Ÿ panicã€‚å¦‚æœä½ æƒ³åœ¨ goroutines ä¸­ä½¿ç”¨â€œpanic é©±åŠ¨é”™è¯¯å¤„ç†â€æ¨¡å¼ï¼Œä½ è¿˜éœ€è¦åšä¸€ç‚¹ç‚¹å…¶ä»–çš„å·¥ä½œã€‚ç³Ÿç³•çš„æ˜¯ errgroup ä¸ä¼šæœ‰æ‰€å¸®åŠ©ã€‚ç„¶è€Œï¼Œæ²¡æœ‰ä»»ä½•äººé˜»æ­¢æˆ‘ä»¬å®ç°ä¸€éæˆ‘ä»¬è‡ªå·±çš„ PanicGroupï¼ä¸‹é¢è¯•ä¸€ä¸‹å®Œæ•´çš„å®ç°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PanicGroup <span class="keyword">struct</span> &#123;</span><br><span class="line">  wg      sync.WaitGroup</span><br><span class="line">  errOnce sync.Once</span><br><span class="line">  err     error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PanicGroup)</span> <span class="title">Wait</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  g.wg.Wait()</span><br><span class="line">  <span class="keyword">return</span> g.err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PanicGroup)</span> <span class="title">Go</span><span class="params">(f <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">  g.wg.Add(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> g.wg.Done()</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err, ok := r.(error); ok &#123;</span><br><span class="line">          <span class="comment">// æˆ‘ä»¬ä»…ä»…éœ€è¦ç¬¬ä¸€ä¸ªé”™è¯¯, sync.Onece åœ¨è¿™é‡Œå¾ˆæœ‰å¸®åŠ©.</span></span><br><span class="line">          g.errOnce.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            g.err = err</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="built_in">panic</span>(r)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    f()</span><br><span class="line">  &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ PanicGroupï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkErr</span><span class="params">(err error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Foo</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> g PanicGroup</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Goroutine #1</span></span><br><span class="line">  g.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœåœ¨è¿™é‡Œå‘ç”Ÿäº†ä»»ä½•é”™è¯¯, panic.</span></span><br><span class="line">    checkErr(dangerous.Action())</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Goroutine #2</span></span><br><span class="line">  g.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    checkErr(dangerous.Action())</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err := g.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    HandleErr(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥ï¼Œ å½“æˆ‘ä»¬éœ€è¦å¤„ç†å¤šä¸ª goroutinesï¼Œå¹¶ä¸”æ¯ä¸ª goroutines è¿˜éœ€è¦æŠ›å‡ºå®ƒè‡ªå®šä¹‰çš„ panic æ—¶ï¼Œ æˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡ä¸Šé¢çš„æ–¹å¼ï¼Œ æ¥ä¿è¯ä»£ç æ¸…æ™°ï¼Œç®€ç»ƒã€‚</p>
<h3 id="æ¥å—-å¹¶ä¸”å®Œç¾"><a href="#æ¥å—-å¹¶ä¸”å®Œç¾" class="headerlink" title="æ¥å—(å¹¶ä¸”å®Œç¾)"></a>æ¥å—(å¹¶ä¸”å®Œç¾)</h3><p>æ„Ÿè°¢æ‚¨çœ‹å®Œäº†æˆ‘çš„æ–‡ç« ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°±èƒ½äº†è§£åˆ°ä¸ºä»€ä¹ˆ Go è¯­è¨€é‡Œçš„é”™è¯¯å¤„ç†æ˜¯è¿™ä¸ªæ ·å­ï¼Œä»€ä¹ˆæ‰æ˜¯å¤§å®¶æœ€å…³å¿ƒçš„é—®é¢˜ï¼Œä»¥åŠå½“ Go 2 ä»…ä»…å‡ºç°ä¸€ç‚¹ç‚¹è‹—å¤´çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ€ä¹ˆå»å…‹æœè¿™äº›å›°éš¾ã€‚æˆ‘ä»¬çš„â€ç–—æ³•â€å¾ˆå®Œæ•´ã€‚</p>
<p>å½“æµè§ˆå®Œæˆ‘æ‰€æœ‰çš„5ä¸ªæ‚²ä¼¤çš„é˜¶æ®µï¼Œæˆ‘æ„è¯†åˆ°ï¼ŒGo é‡Œé¢çš„é”™è¯¯å¤„ç†ä¸åº”è¯¥è¢«å½“æˆä¸€ç§ç—›è‹¦ï¼Œåè€Œç›¸å¯¹äºæµç¨‹æ§åˆ¶è€Œè¨€ï¼Œæ˜¯ä¸€ç§å¼ºå¤§çš„ï¼Œçµæ´»çš„å·¥å…·ã€‚</p>
<p>æ— è®ºä»»ä½•æ—¶å€™ï¼Œåœ¨é”™è¯¯åˆšåˆšå‡ºç°çš„åé¢ï¼Œé€šè¿‡ <code>if err != nil</code> æ¥å¤„ç†æ˜¯ä¸€ç§å®Œç¾çš„é€‰æ‹©ã€‚å¦‚æœä½ éœ€è¦åœ¨ä¸€ä¸ªåœ°æ–¹é›†ä¸­å¤„ç†æ‰€æœ‰çš„é”™è¯¯ï¼Œå°†é”™è¯¯å‘ä¸Šé€å±‚è¿”å›åˆ°è°ƒç”¨è€…ã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œä¸ºé”™è¯¯æ·»åŠ ä¸Šä¸‹æ–‡å°†æ˜¯æœ‰ç›Šçš„ï¼Œå› æ­¤æ‚¨ä¸ä¼šå¿˜è®°æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…å¹¶ä¸”å¯ä»¥æ­£ç¡®å¤„ç†æ¯ç§é”™è¯¯ã€‚</p>
<p>å¦‚æœæ‚¨éœ€è¦åœ¨å‘ç”Ÿé”™è¯¯åå®Œå…¨åœæ­¢ç¨‹åºæµç¨‹ï¼Œè¯·éšä¾¿ä½¿ç”¨æˆ‘æ‰€æè¿°çš„â€œpanic é©±åŠ¨é”™è¯¯å¤„ç†â€ï¼Œå¹¶ä¸”ä¸è¦å¿˜è®°é€šè¿‡ Twitter ä¸æˆ‘åˆ†äº«æ‚¨çš„ç»éªŒã€‚</p>
<p>æœ€åä¸€ä¸ªè¦ç‚¹ï¼Œè¯·è®°ä½ï¼Œå½“äº‹æƒ…çœŸçš„å‘ç”Ÿäº†é”™è¯¯ï¼Œä¿è¯æ€»ä¼šæœ‰ <code>log.Fatal</code> å»è®°å½•ä¸€ä¸‹ã€‚</p>
<p>æ¥æºï¼ševilmartians.com</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ä¸€ä»½å¿«é€Ÿå®ç”¨çš„ tcpdump å‘½ä»¤å‚è€ƒæ‰‹å†Œ]]></title>
      <url>http://team.jiunile.com/blog/2019/06/tcpdump.html</url>
      <content type="html"><![CDATA[<h2 id="tcpdump-ç®€ä»‹"><a href="#tcpdump-ç®€ä»‹" class="headerlink" title="tcpdump ç®€ä»‹"></a>tcpdump ç®€ä»‹</h2><p>å¯¹äº <code>tcpdump</code> çš„ä½¿ç”¨ï¼Œå¤§éƒ¨åˆ†ç®¡ç†å‘˜ä¼šåˆ†æˆä¸¤ç±»ã€‚æœ‰ä¸€ç±»ç®¡ç†å‘˜ï¼Œä»–ä»¬ç†ŸçŸ¥  <code>tcpdump</code> å’Œå…¶ä¸­çš„æ‰€æœ‰æ ‡è®°ï¼›å¦ä¸€ç±»ç®¡ç†å‘˜ï¼Œä»–ä»¬ä»…äº†è§£åŸºæœ¬çš„ä½¿ç”¨æ–¹æ³•ï¼Œå‰©ä¸‹äº‹æƒ…éƒ½è¦å€ŸåŠ©å‚è€ƒæ‰‹å†Œæ‰èƒ½å®Œæˆã€‚å‡ºç°è¿™ç§æƒ…å†µçš„åŸå› åœ¨äºï¼Œ <code>tcpdump</code> æ˜¯ä¸€ä¸ªç›¸å½“é«˜çº§çš„å‘½ä»¤ï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦å¯¹ç½‘ç»œçš„å·¥ä½œæœºåˆ¶æœ‰ç›¸å½“æ·±å…¥çš„äº†è§£ã€‚</p>
<p>åœ¨ä»Šå¤©çš„æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³æä¾›ä¸€ä¸ªå¿«é€Ÿä½†ç›¸å½“å®ç”¨çš„ <code>tcpdump</code> å‚è€ƒã€‚æˆ‘ä¼šè°ˆåˆ°åŸºæœ¬çš„å’Œä¸€äº›é«˜çº§çš„ä½¿ç”¨æ–¹æ³•ã€‚æˆ‘æ•¢è‚¯å®šæˆ‘ä¼šå¿½ç•¥ä¸€äº›ç›¸å½“é…·çš„å‘½ä»¤ï¼Œæ¬¢è¿ä½ è¡¥å……åœ¨è¯„è®ºéƒ¨åˆ†ã€‚</p>
<p>åœ¨æˆ‘ä»¬æ·±å…¥äº†è§£ä»¥å‰ï¼Œæœ€é‡è¦çš„æ˜¯äº†è§£  <code>tcpdump</code> æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ã€‚ tcpdump å‘½ä»¤ç”¨æ¥ä¿å­˜å’Œè®°å½•ç½‘ç»œæµé‡ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è§‚å¯Ÿç½‘ç»œä¸Šå‘ç”Ÿäº†ä»€ä¹ˆï¼Œå¹¶å¯ç”¨æ¥è§£å†³å„ç§å„æ ·çš„é—®é¢˜ï¼ŒåŒ…æ‹¬å’Œç½‘ç»œé€šä¿¡æ— å…³çš„é—®é¢˜ã€‚é™¤äº†ç½‘ç»œé—®é¢˜ï¼Œæˆ‘ç»å¸¸ç”¨ <code>tcpdump</code> è§£å†³åº”ç”¨ç¨‹åºçš„é—®é¢˜ã€‚å¦‚æœä½ å‘ç°ä¸¤ä¸ªåº”ç”¨ç¨‹åºä¹‹é—´æ— æ³•å¾ˆå¥½å·¥ä½œï¼Œå¯ä»¥ç”¨  <code>tcpdump</code>  è§‚å¯Ÿå‡ºäº†ä»€ä¹ˆé—®é¢˜ã€‚ <code>tcpdump</code> å¯ä»¥ç”¨æ¥æŠ“å–å’Œè¯»å–æ•°æ®åŒ…ï¼Œç‰¹åˆ«æ˜¯å½“é€šä¿¡æ²¡æœ‰è¢«åŠ å¯†çš„æ—¶å€™ã€‚</p>
<a id="more"></a>
<h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><p>äº†è§£ <code>tcpdump</code> ï¼Œé¦–å…ˆè¦çŸ¥é“ <code>tcpdump</code> ä¸­ä½¿ç”¨çš„æ ‡è®°ï¼ˆflagï¼‰ã€‚åœ¨è¿™ä¸ªç« èŠ‚ä¸­ï¼Œæˆ‘ä¼šæ¶µç›–åˆ°å¾ˆå¤šåŸºæœ¬çš„æ ‡è®°ï¼Œè¿™äº›æ ‡è®°åœ¨å¾ˆå¤šåœºåˆä¸‹ä¼šè¢«ç”¨åˆ°ã€‚</p>
<h3 id="ä¸è½¬æ¢ä¸»æœºåã€ç«¯å£å·ç­‰"><a href="#ä¸è½¬æ¢ä¸»æœºåã€ç«¯å£å·ç­‰" class="headerlink" title="ä¸è½¬æ¢ä¸»æœºåã€ç«¯å£å·ç­‰"></a>ä¸è½¬æ¢ä¸»æœºåã€ç«¯å£å·ç­‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -n</span></span><br></pre></td></tr></table></figure>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œ tcpdump  ä¼šå°è¯•æŸ¥æ‰¾å’Œè½¬æ¢ä¸»æœºåå’Œç«¯å£å·ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">16:15:05.051896 IP blog.ssh &gt; 10.0.3.1.32855: Flags [P.], seq 2546456553:2546456749, ack 1824683693, win 355, options [nop,nop,TS val 620879437 ecr 620879348], length 196</span><br></pre></td></tr></table></figure></p>
<p>ä½ å¯ä»¥é€šè¿‡ <code>-n</code> æ ‡è®°å…³é—­è¿™ä¸ªåŠŸèƒ½ã€‚æˆ‘ä¸ªäººæ€»æ˜¯ä½¿ç”¨è¿™ä¸ªæ ‡è®°ï¼Œå› ä¸ºæˆ‘å–œæ¬¢ä½¿ç”¨ IP åœ°å€è€Œä¸æ˜¯ä¸»æœºåï¼Œä¸»æœºåå’Œç«¯å£å·çš„è½¬æ¢ç»å¸¸ä¼šå¸¦æ¥å›°æ‰°ã€‚ä½†æ˜¯ï¼ŒçŸ¥é“åˆ©ç”¨  <code>tcpdump</code>  è½¬æ¢æˆ–è€…ä¸è½¬æ¢çš„åŠŸèƒ½è¿˜æ˜¯ç›¸å½“æœ‰ç”¨çš„ï¼Œç‰¹åˆ«æ˜¯æœ‰äº›æ—¶å€™ï¼ŒçŸ¥é“æºæµé‡ï¼ˆsource trafficï¼‰æ¥è‡ªå“ªä¸ªæœåŠ¡å™¨æ˜¯ç›¸å½“é‡è¦çš„ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -n</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">16:23:47.934665 IP 10.0.3.246.22 &gt; 10.0.3.1.32855: Flags [P.], seq 2546457621:2546457817, ack 1824684201, win 355, options [nop,nop,TS val 621010158 ecr 621010055], length 196</span><br></pre></td></tr></table></figure></p>
<h3 id="å¢åŠ è¯¦ç»†ä¿¡æ¯"><a href="#å¢åŠ è¯¦ç»†ä¿¡æ¯" class="headerlink" title="å¢åŠ è¯¦ç»†ä¿¡æ¯"></a>å¢åŠ è¯¦ç»†ä¿¡æ¯</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -v</span></span><br></pre></td></tr></table></figure>
<p>å¢åŠ ä¸€ä¸ªç®€å• <code>-v</code> æ ‡è®°ï¼Œè¾“å‡ºä¼šåŒ…å«æ›´å¤šä¿¡æ¯ï¼Œä¾‹å¦‚ä¸€ä¸ª IP åŒ…çš„ç”Ÿå­˜æ—¶é—´(ttl, time to live)ã€é•¿åº¦å’Œå…¶ä»–çš„é€‰é¡¹ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">16:15:05.051896 IP blog.ssh &gt; 10.0.3.1.32855: Flags [P.], seq 2546456553:2546456749, ack 1824683693, win 355, options [nop,nop,TS val 620879437 ecr 620879348], length 196</span><br></pre></td></tr></table></figure></p>
<p><code>tcpdump</code>  çš„è¯¦ç»†ä¿¡æ¯æœ‰ä¸‰ä¸ªç­‰çº§ï¼Œä½ å¯ä»¥é€šè¿‡åœ¨å‘½ä»¤è¡Œå¢åŠ  <code>v</code> æ ‡è®°çš„ä¸ªæ•°æ¥è·å–æ›´å¤šçš„ä¿¡æ¯ã€‚é€šå¸¸æˆ‘åœ¨ä½¿ç”¨ <code>tcpmdump</code> çš„æ—¶å€™ï¼Œæ€»æ˜¯ä½¿ç”¨æœ€é«˜ç­‰çº§çš„è¯¦ç»†ä¿¡æ¯ï¼Œå› ä¸ºæˆ‘å¸Œæœ›çœ‹åˆ°æ‰€æœ‰ä¿¡æ¯ï¼Œä»¥å…åé¢ä¼šç”¨åˆ°ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -vvv -c 1</span></span><br><span class="line">tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">16:36:13.873456 IP (tos 0x10, ttl 64, id 121, offset 0, flags [DF], proto TCP (6), length 184)</span><br><span class="line">    blog.ssh &gt; 10.0.3.1.32855: Flags [P.], cksum 0x1ba1 (incorrect -&gt; 0x0dfd), seq 2546458841:2546458973, ack 1824684869, win 355, options [nop,nop,TS val 621196643 ecr 621196379], length 132</span><br></pre></td></tr></table></figure></p>
<h3 id="æŒ‡å®šç½‘ç»œæ¥å£"><a href="#æŒ‡å®šç½‘ç»œæ¥å£" class="headerlink" title="æŒ‡å®šç½‘ç»œæ¥å£"></a>æŒ‡å®šç½‘ç»œæ¥å£</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -i eth0</span></span><br></pre></td></tr></table></figure>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœä¸æŒ‡å®šç½‘ç»œæ¥å£ï¼Œ <code>tcpdump</code>  åœ¨è¿è¡Œæ—¶ä¼šé€‰æ‹©ç¼–å·æœ€ä½çš„ç½‘ç»œæ¥å£ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ <code>eth0</code>ï¼Œä¸è¿‡å› ç³»ç»Ÿä¸åŒå¯èƒ½ä¼šæœ‰æ‰€å·®å¼‚ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">16:15:05.051896 IP blog.ssh &gt; 10.0.3.1.32855: Flags [P.], seq 2546456553:2546456749, ack 1824683693, win 355, options [nop,nop,TS val 620879437 ecr 620879348], length 196</span><br></pre></td></tr></table></figure></p>
<p>ä½ å¯ä»¥ç”¨ <code>-i</code> æ ‡è®°æ¥æŒ‡å®šç½‘ç»œæ¥å£ã€‚åœ¨å¤§å¤šæ•° Linux ç³»ç»Ÿä¸Šï¼Œ<code>any</code> è¿™ä¸€ç‰¹å®šçš„ç½‘ç»œæ¥å£åç”¨æ¥è®©  <code>tcpdump</code>  ç›‘å¬æ‰€æœ‰çš„æ¥å£ã€‚æˆ‘å‘ç°è¿™åœ¨æ’æŸ¥æœåŠ¡å™¨ï¼ˆæ‹¥æœ‰å¤šä¸ªç½‘ç»œæ¥å£ï¼‰çš„é—®é¢˜ç‰¹åˆ«æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯ç‰µæ‰¯åˆ°è·¯ç”±çš„æ—¶å€™ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -i any</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">16:45:59.312046 IP blog.ssh &gt; 10.0.3.1.32855: Flags [P.], seq 2547763641:2547763837, ack 1824693949, win 355, options [nop,nop,TS val 621343002 ecr 621342962], length 196</span><br></pre></td></tr></table></figure></p>
<h3 id="å†™å…¥æ–‡ä»¶"><a href="#å†™å…¥æ–‡ä»¶" class="headerlink" title="å†™å…¥æ–‡ä»¶"></a>å†™å…¥æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -w /path/to/file</span></span><br></pre></td></tr></table></figure>
<p><code>tcpdump</code>  è¿è¡Œç»“æœä¼šè¾“å‡ºåœ¨å±å¹•ä¸Šã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">16:15:05.051896 IP blog.ssh &gt; 10.0.3.1.32855: Flags [P.], seq 2546456553:2546456749, ack 1824683693, win 355, options [nop,nop,TS val 620879437 ecr 620879348], length 196</span><br></pre></td></tr></table></figure></p>
<p>ä½†å¾ˆå¤šæ—¶å€™ï¼Œä½ å¸Œæœ›æŠŠ  <code>tcpdump</code>  çš„è¾“å‡ºç»“æœä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯åˆ©ç”¨ <code>-w</code> æ ‡è®°ã€‚å¦‚æœä½ åç»­è¿˜ä¼šæ£€æŸ¥è¿™äº›ç½‘ç»œæ•°æ®ï¼Œè¿™æ ·åšå°±ç‰¹åˆ«æœ‰ç”¨ã€‚å°†è¿™äº›æ•°æ®å­˜æˆä¸€ä¸ªæ–‡ä»¶çš„å¥½å¤„ï¼Œå°±æ˜¯ä½ å¯ä»¥å¤šæ¬¡è¯»å–è¿™ä¸ªä¿å­˜ä¸‹æ¥çš„æ–‡ä»¶ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è¿™ä¸ªç½‘ç»œæµé‡çš„å¿«ç…§ä¸Šä½¿ç”¨å…¶å®ƒæ ‡è®°æˆ–è€…è¿‡æ»¤å™¨ï¼ˆæˆ‘ä»¬åé¢ä¼šè®¨è®ºåˆ°ï¼‰ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tcpdump  -w /var/tmp/tcpdata.pcap</span></span><br><span class="line"> tcpdump : listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">1 packet captured</span><br><span class="line">2 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure></p>
<p>é€šå¸¸è¿™äº›æ•°æ®è¢«ç¼“å­˜è€Œä¸ä¼šè¢«å†™å…¥æ–‡ä»¶ï¼Œç›´åˆ°ä½ ç”¨ <code>CTRL+C</code> ç»“æŸ <code>tcpdump</code> å‘½ä»¤çš„æ—¶å€™ã€‚</p>
<h3 id="è¯»å–æ–‡ä»¶"><a href="#è¯»å–æ–‡ä»¶" class="headerlink" title="è¯»å–æ–‡ä»¶"></a>è¯»å–æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tcpdump  -r /path/to/file</span></span><br></pre></td></tr></table></figure>
<p>ä¸€æ—¦ä½ å°†è¾“å‡ºå­˜æˆæ–‡ä»¶ï¼Œå°±å¿…ç„¶éœ€è¦è¯»å–è¿™ä¸ªæ–‡ä»¶ã€‚è¦åšåˆ°è¿™ç‚¹ï¼Œä½ åªéœ€è¦åœ¨ <code>-r</code> æ ‡è®°åæŒ‡å®šè¿™ä¸ªæ–‡ä»¶çš„å­˜æ”¾è·¯å¾„ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -r /var/tmp/tcpdata.pcap </span></span><br><span class="line">reading from file /var/tmp/tcpdata.pcap, link-type EN10MB (Ethernet)</span><br><span class="line">16:56:01.610473 IP blog.ssh &gt; 10.0.3.1.32855: Flags [P.], seq 2547766673:2547766805, ack 1824696181, win 355, options [nop,nop,TS val 621493577 ecr 621493478], length 132</span><br></pre></td></tr></table></figure></p>
<p>ä¸€ä¸ªå°æé†’ï¼Œå¦‚æœä½ ç†Ÿæ‚‰ <a href="https://www.wireshark.org/" target="_blank" rel="external">wireshark</a> è¿™ç±»ç½‘ç»œè¯Šæ–­å·¥å…·ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨å®ƒä»¬æ¥è¯»å–  <code>tcpdump</code>  ä¿å­˜çš„æ–‡ä»¶ã€‚</p>
<h3 id="æŒ‡å®šæŠ“åŒ…å¤§å°"><a href="#æŒ‡å®šæŠ“åŒ…å¤§å°" class="headerlink" title="æŒ‡å®šæŠ“åŒ…å¤§å°"></a>æŒ‡å®šæŠ“åŒ…å¤§å°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tcpdump  -s 100</span></span><br></pre></td></tr></table></figure>
<p>è¾ƒæ–°ç‰ˆæœ¬çš„  <code>tcpdump</code>  é€šå¸¸å¯ä»¥æˆªè· <strong>65535</strong> å­—èŠ‚ï¼Œä½†æŸäº›æƒ…å†µä¸‹ä½ ä¸éœ€è¦æˆªè·é»˜è®¤å¤§å°çš„æ•°æ®åŒ…ã€‚è¿è¡Œ  <code>tcpdump</code>  æ—¶ï¼Œä½ å¯ä»¥é€šè¿‡ <code>-s</code> æ ‡è®°æ¥æŒ‡å®šå¿«ç…§é•¿åº¦ã€‚</p>
<h3 id="æŒ‡å®šæŠ“åŒ…æ•°é‡"><a href="#æŒ‡å®šæŠ“åŒ…æ•°é‡" class="headerlink" title="æŒ‡å®šæŠ“åŒ…æ•°é‡"></a>æŒ‡å®šæŠ“åŒ…æ•°é‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tcpdump  -c 10</span></span><br></pre></td></tr></table></figure>
<p><code>tcpdump</code>  ä¼šä¸€ç›´è¿è¡Œï¼Œç›´è‡³ä½ ç”¨ <code>CTRL+C</code> è®©å®ƒé€€å‡ºã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tcpdump  host google.com</span></span><br><span class="line"> tcpdump : verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">^C</span><br><span class="line">0 packets captured</span><br><span class="line">4 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure></p>
<p>ä½ ä¹Ÿå¯ä»¥é€šè¿‡ <code>-c</code> æ ‡è®°åé¢åŠ ä¸ŠæŠ“åŒ…çš„æ•°é‡ï¼Œè®©  <code>tcpdump</code> åœ¨æŠ“åˆ°ä¸€å®šæ•°é‡çš„æ•°æ®åŒ…ååœæ­¢æ“ä½œã€‚å½“ä½ ä¸å¸Œæœ›çœ‹åˆ°  <code>tcpdump</code>  çš„è¾“å‡ºå¤§é‡å‡ºç°åœ¨å±å¹•ä¸Šï¼Œä»¥è‡³äºä½ æ— æ³•é˜…è¯»çš„æ—¶å€™ï¼Œå°±ä¼šå¸Œæœ›ä½¿ç”¨è¿™ä¸ªæ ‡è®°ã€‚å½“ç„¶ï¼Œé€šå¸¸æ›´å¥½çš„æ–¹æ³•æ˜¯å€ŸåŠ©è¿‡æ»¤å™¨æ¥æˆªè·ç‰¹å®šçš„æµé‡ã€‚</p>
<h3 id="åŸºç¡€çŸ¥è¯†æ±‡æ€»"><a href="#åŸºç¡€çŸ¥è¯†æ±‡æ€»" class="headerlink" title="åŸºç¡€çŸ¥è¯†æ±‡æ€»"></a>åŸºç¡€çŸ¥è¯†æ±‡æ€»</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tcpdump  -nvvv -i any -c 100 -s 100</span></span><br></pre></td></tr></table></figure>
<p>ä½ å¯ä»¥å°†ä»¥ä¸Šè¿™äº›åŸºç¡€çš„æ ‡è®°ç»„åˆèµ·æ¥ä½¿ç”¨ï¼Œæ¥è®©  <code>tcpdump</code>  æä¾›ä½ æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -w /var/tmp/tcpdata.pcap -i any -c 10 -vvv</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">10 packets captured</span><br><span class="line">10 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line"><span class="comment"># tcpdump -r /var/tmp/tcpdata.pcap -nvvv -c 5</span></span><br><span class="line">reading from file /var/tmp/tcpdata.pcap, link-type LINUX_SLL (Linux cooked)</span><br><span class="line">17:35:14.465902 IP (tos 0x10, ttl 64, id 5436, offset 0, flags [DF], proto TCP (6), length 104)</span><br><span class="line">    10.0.3.246.22 &gt; 10.0.3.1.32855: Flags [P.], cksum 0x1b51 (incorrect -&gt; 0x72bc), seq 2547781277:2547781329, ack 1824703573, win 355, options [nop,nop,TS val 622081791 ecr 622081775], length 52</span><br><span class="line">17:35:14.466007 IP (tos 0x10, ttl 64, id 52193, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.1.32855 &gt; 10.0.3.246.22: Flags [.], cksum 0x1b1d (incorrect -&gt; 0x4950), seq 1, ack 52, win 541, options [nop,nop,TS val 622081791 ecr 622081791], length 0</span><br><span class="line">17:35:14.470239 IP (tos 0x10, ttl 64, id 5437, offset 0, flags [DF], proto TCP (6), length 168)</span><br><span class="line">    10.0.3.246.22 &gt; 10.0.3.1.32855: Flags [P.], cksum 0x1b91 (incorrect -&gt; 0x98c3), seq 52:168, ack 1, win 355, options [nop,nop,TS val 622081792 ecr 622081791], length 116</span><br><span class="line">17:35:14.470370 IP (tos 0x10, ttl 64, id 52194, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.1.32855 &gt; 10.0.3.246.22: Flags [.], cksum 0x1b1d (incorrect -&gt; 0x48da), seq 1, ack 168, win 541, options [nop,nop,TS val 622081792 ecr 622081792], length 0</span><br><span class="line">17:35:15.464575 IP (tos 0x10, ttl 64, id 5438, offset 0, flags [DF], proto TCP (6), length 104)</span><br><span class="line">    10.0.3.246.22 &gt; 10.0.3.1.32855: Flags [P.], cksum 0x1b51 (incorrect -&gt; 0xc3ba), seq 168:220, ack 1, win 355, options [nop,nop,TS val 622082040 ecr 622081792], length 52</span><br></pre></td></tr></table></figure></p>
<h2 id="è¿‡æ»¤å™¨"><a href="#è¿‡æ»¤å™¨" class="headerlink" title="è¿‡æ»¤å™¨"></a>è¿‡æ»¤å™¨</h2><p>ä»‹ç»å®ŒåŸºç¡€çš„æ ‡è®°åï¼Œæˆ‘ä»¬è¯¥ä»‹ç»è¿‡æ»¤å™¨äº†ã€‚ <code>tcpdump</code>  å¯ä»¥é€šè¿‡å„å¼å„æ ·çš„è¡¨è¾¾å¼ï¼Œæ¥è¿‡æ»¤æ‰€æˆªå–æˆ–è€…è¾“å‡ºçš„æ•°æ®ã€‚æˆ‘åœ¨è¿™ç¯‡æ–‡ç« é‡Œä¼šç»™å‡ºä¸€äº›ç®€å•çš„ä¾‹å­ï¼Œä»¥ä¾¿è®©ä½ ä»¬äº†è§£è¯­æ³•è§„åˆ™ã€‚ä½ ä»¬å¯ä»¥æŸ¥è¯¢  <code>tcpdump</code>  å¸®åŠ©ä¸­çš„ <a href="http://www.tcpdump.org/manpages/pcap-filter.7.html" target="_blank" rel="external">pcap-filter</a> ç« èŠ‚ï¼Œäº†è§£æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯ã€‚</p>
<h3 id="æŸ¥æ‰¾ç‰¹å®šä¸»æœºçš„æµé‡"><a href="#æŸ¥æ‰¾ç‰¹å®šä¸»æœºçš„æµé‡" class="headerlink" title="æŸ¥æ‰¾ç‰¹å®šä¸»æœºçš„æµé‡"></a>æŸ¥æ‰¾ç‰¹å®šä¸»æœºçš„æµé‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tcpdump  -nvvv -i any -c 3 host 10.0.3.1</span></span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä¸Šè¿°å‘½ä»¤ï¼Œ <code>tcpdump</code>  ä¼šåƒå‰é¢ä¸€æ ·æŠŠç»“æœè¾“å‡ºåˆ°å±å¹•ä¸Šï¼Œä¸è¿‡åªä¼šæ˜¾ç¤ºæº IP æˆ–è€…ç›®çš„ IP åœ°å€æ˜¯ <code>10.0.3.1</code> çš„æ•°æ®åŒ…ã€‚é€šè¿‡å¢åŠ ä¸»æœº <code>10.0.3.1</code> å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è®©  <code>tcpdump</code>  è¿‡æ»¤æ‰æºå’Œç›®çš„åœ°å€ä¸æ˜¯ <code>10.0.3.1</code> çš„æ•°æ®åŒ…ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -nvvv -i any -c 3 host 10.0.3.1</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">17:54:15.067496 IP (tos 0x10, ttl 64, id 5502, offset 0, flags [DF], proto TCP (6), length 184)</span><br><span class="line">    10.0.3.246.22 &gt; 10.0.3.1.32855: Flags [P.], cksum 0x1ba1 (incorrect -&gt; 0x9f75), seq 2547785621:2547785753, ack 1824705637, win 355, options [nop,nop,TS val 622366941 ecr 622366923], length 132</span><br><span class="line">17:54:15.067613 IP (tos 0x10, ttl 64, id 52315, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.1.32855 &gt; 10.0.3.246.22: Flags [.], cksum 0x1b1d (incorrect -&gt; 0x7c34), seq 1, ack 132, win 540, options [nop,nop,TS val 622366941 ecr 622366941], length 0</span><br><span class="line">17:54:15.075230 IP (tos 0x10, ttl 64, id 5503, offset 0, flags [DF], proto TCP (6), length 648)</span><br><span class="line">    10.0.3.246.22 &gt; 10.0.3.1.32855: Flags [P.], cksum 0x1d71 (incorrect -&gt; 0x3443), seq 132:728, ack 1, win 355, options [nop,nop,TS val 622366943 ecr 622366941], length 596</span><br></pre></td></tr></table></figure></p>
<h3 id="åªæ˜¾ç¤ºæºåœ°å€ä¸ºç‰¹å®šä¸»æœºçš„æµé‡"><a href="#åªæ˜¾ç¤ºæºåœ°å€ä¸ºç‰¹å®šä¸»æœºçš„æµé‡" class="headerlink" title="åªæ˜¾ç¤ºæºåœ°å€ä¸ºç‰¹å®šä¸»æœºçš„æµé‡"></a>åªæ˜¾ç¤ºæºåœ°å€ä¸ºç‰¹å®šä¸»æœºçš„æµé‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tcpdump  -nvvv -i any -c 3 src host 10.0.3.1</span></span><br></pre></td></tr></table></figure>
<p>å‰é¢çš„ä¾‹å­æ˜¾ç¤ºäº†æºå’Œç›®çš„åœ°å€æ˜¯ <code>10.0.3.1</code> çš„æµé‡ï¼Œè€Œä¸Šé¢çš„å‘½ä»¤åªæ˜¾ç¤ºæ•°æ®åŒ…æºåœ°å€æ˜¯ <code>10.0.3.1</code> çš„æµé‡ã€‚è¿™æ˜¯é€šè¿‡åœ¨ <code>host</code> å‰é¢å¢åŠ  <code>src</code> å‚æ•°æ¥å®ç°çš„ã€‚è¿™ä¸ªé¢å¤–çš„è¿‡æ»¤å™¨å‘Šè¯‰  <code>tcpdump</code>  æŸ¥æ‰¾ç‰¹å®šçš„æºåœ°å€ã€‚ åè¿‡æ¥é€šè¿‡ <code>dst</code> è¿‡æ»¤å™¨ï¼Œå¯ä»¥æŒ‡å®šç›®çš„åœ°å€ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -nvvv -i any -c 3 src host 10.0.3.1</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">17:57:12.194902 IP (tos 0x10, ttl 64, id 52357, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.1.32855 &gt; 10.0.3.246.22: Flags [.], cksum 0x1b1d (incorrect -&gt; 0x1707), seq 1824706545, ack 2547787717, win 540, options [nop,nop,TS val 622411223 ecr 622411223], length 0</span><br><span class="line">17:57:12.196288 IP (tos 0x10, ttl 64, id 52358, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.1.32855 &gt; 10.0.3.246.22: Flags [.], cksum 0x1b1d (incorrect -&gt; 0x15c5), seq 0, ack 325, win 538, options [nop,nop,TS val 622411223 ecr 622411223], length 0</span><br><span class="line">17:57:12.197677 IP (tos 0x10, ttl 64, id 52359, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.1.32855 &gt; 10.0.3.246.22: Flags [.], cksum 0x1b1d (incorrect -&gt; 0x1491), seq 0, ack 633, win 536, options [nop,nop,TS val 622411224 ecr 622411224], length 0</span><br><span class="line"><span class="comment"># tcpdump -nvvv -i any -c 3 dst host 10.0.3.1</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">17:59:37.266838 IP (tos 0x10, ttl 64, id 5552, offset 0, flags [DF], proto TCP (6), length 184)</span><br><span class="line">    10.0.3.246.22 &gt; 10.0.3.1.32855: Flags [P.], cksum 0x1ba1 (incorrect -&gt; 0x586d), seq 2547789725:2547789857, ack 1824707577, win 355, options [nop,nop,TS val 622447491 ecr 622447471], length 132</span><br><span class="line">17:59:37.267850 IP (tos 0x10, ttl 64, id 5553, offset 0, flags [DF], proto TCP (6), length 392)</span><br><span class="line">    10.0.3.246.22 &gt; 10.0.3.1.32855: Flags [P.], cksum 0x1c71 (incorrect -&gt; 0x462e), seq 132:472, ack 1, win 355, options [nop,nop,TS val 622447491 ecr 622447491], length 340</span><br><span class="line">17:59:37.268606 IP (tos 0x10, ttl 64, id 5554, offset 0, flags [DF], proto TCP (6), length 360)</span><br><span class="line">    10.0.3.246.22 &gt; 10.0.3.1.32855: Flags [P.], cksum 0x1c51 (incorrect -&gt; 0xf469), seq 472:780, ack 1, win 355, options [nop,nop,TS val 622447491 ecr 622447491], length 308</span><br></pre></td></tr></table></figure></p>
<h3 id="è¿‡æ»¤æºå’Œç›®çš„ç«¯å£"><a href="#è¿‡æ»¤æºå’Œç›®çš„ç«¯å£" class="headerlink" title="è¿‡æ»¤æºå’Œç›®çš„ç«¯å£"></a>è¿‡æ»¤æºå’Œç›®çš„ç«¯å£</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tcpdump  -nvvv -i any -c 3 port 22 and port 60738</span></span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ç±»ä¼¼ <code>and</code> æ“ä½œç¬¦ï¼Œä½ å¯ä»¥åœ¨  <code>tcpdump</code>  ä¸Šä½¿ç”¨æ›´ä¸ºå¤æ‚çš„è¿‡æ»¤å™¨æè¿°ã€‚è¿™ä¸ªå°±ç±»ä¼¼ <code>if</code> è¯­å¥ï¼Œä½ å°±è¿™ä¹ˆæƒ³å§ã€‚è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>and</code> æ“ä½œç¬¦å‘Šè¯‰  <code>tcpdump</code>  åªè¾“å‡ºç«¯å£å·æ˜¯ <code>22</code> å’Œ <code>60738</code> çš„æ•°æ®åŒ…ã€‚è¿™ç‚¹åœ¨åˆ†æç½‘ç»œé—®é¢˜çš„æ—¶å€™å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥å…³æ³¨æŸä¸€ä¸ªç‰¹å®šä¼šè¯ï¼ˆsessionï¼‰çš„æ•°æ®åŒ…ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -nvvv -i any -c 3 port 22 and port 60738</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">18:05:54.069403 IP (tos 0x10, ttl 64, id 64401, offset 0, flags [DF], proto TCP (6), length 104)</span><br><span class="line">    10.0.3.1.60738 &gt; 10.0.3.246.22: Flags [P.], cksum 0x1b51 (incorrect -&gt; 0x5b3c), seq 917414532:917414584, ack 1550997318, win 353, options [nop,nop,TS val 622541691 ecr 622538903], length 52</span><br><span class="line">18:05:54.072963 IP (tos 0x10, ttl 64, id 13601, offset 0, flags [DF], proto TCP (6), length 184)</span><br><span class="line">    10.0.3.246.22 &gt; 10.0.3.1.60738: Flags [P.], cksum 0x1ba1 (incorrect -&gt; 0xb0b1), seq 1:133, ack 52, win 355, options [nop,nop,TS val 622541692 ecr 622541691], length 132</span><br><span class="line">18:05:54.073080 IP (tos 0x10, ttl 64, id 64402, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.1.60738 &gt; 10.0.3.246.22: Flags [.], cksum 0x1b1d (incorrect -&gt; 0x1e3b), seq 52, ack 133, win 353, options [nop,nop,TS val 622541692 ecr 622541692], length 0</span><br></pre></td></tr></table></figure></p>
<p>ä½ å¯ä»¥ç”¨ä¸¤ç§æ–¹å¼æ¥è¡¨ç¤º <code>and</code> æ“ä½œç¬¦ï¼Œ<code>and</code> æˆ–è€… <code>&amp;&amp;</code> éƒ½å¯ä»¥ã€‚æˆ‘ä¸ªäººå€¾å‘äºä¸¤ä¸ªéƒ½ä½¿ç”¨ï¼Œç‰¹åˆ«è¦è®°ä½åœ¨ä½¿ç”¨ <code>&amp;&amp;</code> çš„æ—¶å€™ï¼Œè¦ç”¨å•å¼•å·æˆ–è€…åŒå¼•å·åŒ…ä½è¡¨è¾¾å¼ã€‚åœ¨ BASH ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>&amp;&amp;</code> è¿è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œè¯¥å‘½ä»¤æˆåŠŸåå†æ‰§è¡Œåé¢çš„å‘½ä»¤ã€‚é€šå¸¸ï¼Œæœ€å¥½å°†è¡¨è¾¾å¼ç”¨å¼•å·åŒ…èµ·æ¥ï¼Œè¿™æ ·ä¼šé¿å…ä¸é¢„æœŸçš„ç»“æœï¼Œç‰¹åˆ«å½“è¿‡æ»¤å™¨ä¸­æœ‰ä¸€äº›ç‰¹æ®Šå­—ç¬¦çš„æ—¶å€™ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -nvvv -i any -c 3 'port 22 &amp;&amp; port 60738'</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">18:06:16.062818 IP (tos 0x10, ttl 64, id 64405, offset 0, flags [DF], proto TCP (6), length 88)</span><br><span class="line">    10.0.3.1.60738 &gt; 10.0.3.246.22: Flags [P.], cksum 0x1b41 (incorrect -&gt; 0x776c), seq 917414636:917414672, ack 1550997518, win 353, options [nop,nop,TS val 622547190 ecr 622541776], length 36</span><br><span class="line">18:06:16.065567 IP (tos 0x10, ttl 64, id 13603, offset 0, flags [DF], proto TCP (6), length 120)</span><br><span class="line">    10.0.3.246.22 &gt; 10.0.3.1.60738: Flags [P.], cksum 0x1b61 (incorrect -&gt; 0xaf2d), seq 1:69, ack 36, win 355, options [nop,nop,TS val 622547191 ecr 622547190], length 68</span><br><span class="line">18:06:16.065696 IP (tos 0x10, ttl 64, id 64406, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.1.60738 &gt; 10.0.3.246.22: Flags [.], cksum 0x1b1d (incorrect -&gt; 0xf264), seq 36, ack 69, win 353, options [nop,nop,TS val 622547191 ecr 622547191], length 0</span><br></pre></td></tr></table></figure></p>
<h3 id="æŸ¥æ‰¾ä¸¤ä¸ªç«¯å£å·çš„æµé‡"><a href="#æŸ¥æ‰¾ä¸¤ä¸ªç«¯å£å·çš„æµé‡" class="headerlink" title="æŸ¥æ‰¾ä¸¤ä¸ªç«¯å£å·çš„æµé‡"></a>æŸ¥æ‰¾ä¸¤ä¸ªç«¯å£å·çš„æµé‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tcpdump  -nvvv -i any -c 20 'port 80 or port 443'</span></span><br></pre></td></tr></table></figure>
<p>ä½ å¯ä»¥ç”¨ <code>or</code> æˆ–è€… <code>||</code> æ“ä½œç¬¦æ¥è¿‡æ»¤ç»“æœã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>or</code> æ“ä½œç¬¦å»æˆªè·å‘é€å’Œæ¥æ”¶ç«¯å£ä¸º <code>80</code> æˆ– <code>443</code> çš„æ•°æ®æµã€‚è¿™åœ¨ Web æœåŠ¡å™¨ä¸Šç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºæœåŠ¡å™¨é€šå¸¸æœ‰ä¸¤ä¸ªå¼€æ”¾çš„ç«¯å£ï¼Œç«¯å£å· <code>80</code> è¡¨ç¤º <code>http</code> è¿æ¥ï¼Œ<code>443</code> è¡¨ç¤º <code>https</code>ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -nvvv -i any -c 20 'port 80 or port 443'</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">18:24:28.817940 IP (tos 0x0, ttl 64, id 39930, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    10.0.3.1.50524 &gt; 10.0.3.246.443: Flags [S], cksum 0x1b25 (incorrect -&gt; 0x8611), seq 3836995553, win 29200, options [mss 1460,sackOK,TS val 622820379 ecr 0,nop,wscale 7], length 0</span><br><span class="line">18:24:28.818052 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 40)</span><br><span class="line">    10.0.3.246.443 &gt; 10.0.3.1.50524: Flags [R.], cksum 0x012c (correct), seq 0, ack 3836995554, win 0, length 0</span><br><span class="line">18:24:32.721330 IP (tos 0x0, ttl 64, id 48510, offset 0, flags [DF], proto TCP (6), length 475)</span><br><span class="line">    10.0.3.1.60374 &gt; 10.0.3.246.80: Flags [P.], cksum 0x1cc4 (incorrect -&gt; 0x3a4e), seq 580573019:580573442, ack 1982754038, win 237, options [nop,nop,TS val 622821354 ecr 622815632], length 423</span><br><span class="line">18:24:32.721465 IP (tos 0x0, ttl 64, id 1266, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.246.80 &gt; 10.0.3.1.60374: Flags [.], cksum 0x1b1d (incorrect -&gt; 0x45d7), seq 1, ack 423, win 243, options [nop,nop,TS val 622821355 ecr 622821354], length 0</span><br><span class="line">18:24:32.722098 IP (tos 0x0, ttl 64, id 1267, offset 0, flags [DF], proto TCP (6), length 241)</span><br><span class="line">    10.0.3.246.80 &gt; 10.0.3.1.60374: Flags [P.], cksum 0x1bda (incorrect -&gt; 0x855c), seq 1:190, ack 423, win 243, options [nop,nop,TS val 622821355 ecr 622821354], length 189</span><br><span class="line">18:24:32.722232 IP (tos 0x0, ttl 64, id 48511, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.1.60374 &gt; 10.0.3.246.80: Flags [.], cksum 0x1b1d (incorrect -&gt; 0x4517), seq 423, ack 190, win 245, options [nop,nop,TS val 622821355 ecr 622821355], length 0</span><br></pre></td></tr></table></figure></p>
<h3 id="æŸ¥æ‰¾ä¸¤ä¸ªç‰¹å®šç«¯å£å’Œæ¥è‡ªç‰¹å®šä¸»æœºçš„æ•°æ®æµ"><a href="#æŸ¥æ‰¾ä¸¤ä¸ªç‰¹å®šç«¯å£å’Œæ¥è‡ªç‰¹å®šä¸»æœºçš„æ•°æ®æµ" class="headerlink" title="æŸ¥æ‰¾ä¸¤ä¸ªç‰¹å®šç«¯å£å’Œæ¥è‡ªç‰¹å®šä¸»æœºçš„æ•°æ®æµ"></a>æŸ¥æ‰¾ä¸¤ä¸ªç‰¹å®šç«¯å£å’Œæ¥è‡ªç‰¹å®šä¸»æœºçš„æ•°æ®æµ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tcpdump  -nvvv -i any -c 20 '(port 80 or port 443) and host 10.0.3.169'</span></span><br></pre></td></tr></table></figure>
<p>å‰é¢çš„ä¾‹å­ç”¨æ¥æ’æŸ¥å¤šç«¯å£çš„åè®®é—®é¢˜ï¼Œæ˜¯éå¸¸æœ‰æ•ˆçš„ã€‚å¦‚æœ Web æœåŠ¡å™¨çš„æ•°æ®æµé‡ç›¸å½“å¤§ï¼Œ <code>tcpdump</code>  çš„è¾“å‡ºå¯èƒ½æœ‰ç‚¹æ··ä¹±ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ  <code>host</code> å‚æ•°è¿›ä¸€æ­¥é™å®šè¾“å‡ºã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šè¿‡æŠŠ <code>or</code> è¡¨è¾¾å¼æ”¾åœ¨æ‹¬å·ä¸­æ¥ä¿æŒ <code>or</code> æè¿°ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -nvvv -i any -c 20 '(port 80 or port 443) and host 10.0.3.169'</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">18:38:05.551194 IP (tos 0x0, ttl 64, id 63169, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    10.0.3.169.33786 &gt; 10.0.3.246.443: Flags [S], cksum 0x1bcd (incorrect -&gt; 0x0d96), seq 4173164403, win 29200, options [mss 1460,sackOK,TS val 623024562 ecr 0,nop,wscale 7], length 0</span><br><span class="line">18:38:05.551310 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 40)</span><br><span class="line">    10.0.3.246.443 &gt; 10.0.3.169.33786: Flags [R.], cksum 0xa64a (correct), seq 0, ack 4173164404, win 0, length 0</span><br><span class="line">18:38:05.717130 IP (tos 0x0, ttl 64, id 51574, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    10.0.3.169.35629 &gt; 10.0.3.246.80: Flags [S], cksum 0x1bcd (incorrect -&gt; 0xdf7c), seq 1068257453, win 29200, options [mss 1460,sackOK,TS val 623024603 ecr 0,nop,wscale 7], length 0</span><br><span class="line">18:38:05.717255 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    10.0.3.246.80 &gt; 10.0.3.169.35629: Flags [S.], cksum 0x1bcd (incorrect -&gt; 0xed80), seq 2992472447, ack 1068257454, win 28960, options [mss 1460,sackOK,TS val 623024603 ecr 623024603,nop,wscale 7], length 0</span><br><span class="line">18:38:05.717474 IP (tos 0x0, ttl 64, id 51575, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.169.35629 &gt; 10.0.3.246.80: Flags [.], cksum 0x1bc5 (incorrect -&gt; 0x8c87), seq 1, ack 1, win 229, options [nop,nop,TS val 623024604 ecr 623024603], length 0</span><br></pre></td></tr></table></figure></p>
<p>åœ¨ä¸€ä¸ªè¿‡æ»¤å™¨ä¸­ï¼Œä½ å¯ä»¥å¤šæ¬¡ä½¿ç”¨æ‹¬å·ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œä¸‹é¢å‘½ä»¤å¯ä»¥é™å®šæˆªè·æ»¡è¶³å¦‚ä¸‹æ¡ä»¶çš„æ•°æ®åŒ…ï¼šå‘é€æˆ–æ¥æ”¶ç«¯å£å·ä¸º <code>80</code> æˆ– <code>443</code>ï¼Œä¸»æœºæ¥æºäº <code>10.0.3.169</code> æˆ–è€… <code>10.0.3.1</code>ï¼Œä¸”ç›®çš„åœ°å€æ˜¯ <code>10.0.3.246</code>ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -nvvv -i any -c 20 '((port 80 or port 443) and (host 10.0.3.169 or host 10.0.3.1)) and dst host 10.0.3.246'</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">18:53:30.349306 IP (tos 0x0, ttl 64, id 52641, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    10.0.3.1.35407 &gt; 10.0.3.246.80: Flags [S], cksum 0x1b25 (incorrect -&gt; 0x4890), seq 3026316656, win 29200, options [mss 1460,sackOK,TS val 623255761 ecr 0,nop,wscale 7], length 0</span><br><span class="line">18:53:30.349558 IP (tos 0x0, ttl 64, id 52642, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.1.35407 &gt; 10.0.3.246.80: Flags [.], cksum 0x1b1d (incorrect -&gt; 0x3454), seq 3026316657, ack 3657995297, win 229, options [nop,nop,TS val 623255762 ecr 623255762], length 0</span><br><span class="line">18:53:30.354056 IP (tos 0x0, ttl 64, id 52643, offset 0, flags [DF], proto TCP (6), length 475)</span><br><span class="line">    10.0.3.1.35407 &gt; 10.0.3.246.80: Flags [P.], cksum 0x1cc4 (incorrect -&gt; 0x10c2), seq 0:423, ack 1, win 229, options [nop,nop,TS val 623255763 ecr 623255762], length 423</span><br><span class="line">18:53:30.354682 IP (tos 0x0, ttl 64, id 52644, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.1.35407 &gt; 10.0.3.246.80: Flags [.], cksum 0x1b1d (incorrect -&gt; 0x31e6), seq 423, ack 190, win 237, options [nop,nop,TS val 623255763 ecr 623255763], length 0</span><br></pre></td></tr></table></figure></p>
<h2 id="ç†è§£è¾“å‡ºç»“æœ"><a href="#ç†è§£è¾“å‡ºç»“æœ" class="headerlink" title="ç†è§£è¾“å‡ºç»“æœ"></a>ç†è§£è¾“å‡ºç»“æœ</h2><p>æ‰“å¼€  <code>tcpdump</code>  çš„æ‰€æœ‰é€‰é¡¹å»æˆªè·ç½‘ç»œæµé‡æ˜¯ç›¸å½“å›°éš¾çš„ï¼Œä½†ä¸€æ—¦ä½ æ‹¿åˆ°è¿™äº›æ•°æ®ä½ å°±è¦å¯¹å®ƒè¿›è¡Œè§£è¯»ã€‚åœ¨è¿™ä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬å°†æ¶‰åŠå¦‚ä½•åˆ¤æ–­æº/ç›®çš„ IP åœ°å€ï¼Œæº/ç›®çš„ç«¯å£å·ï¼Œä»¥åŠ <code>TCP</code> åè®®ç±»å‹çš„æ•°æ®åŒ…ã€‚å½“ç„¶è¿™äº›æ˜¯ç›¸å½“åŸºç¡€çš„ï¼Œä½ ä»  <code>tcpdump</code>  é‡Œé¢è·å–çš„ä¿¡æ¯ä¹Ÿè¿œä¸æ­¢è¿™äº›ã€‚ä¸è¿‡è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ç²—ç•¥çš„ä»‹ç»ï¼Œæˆ‘ä»¬ä¼šå…³æ³¨åœ¨è¿™äº›åŸºç¡€çŸ¥è¯†ä¸Šã€‚æˆ‘å»ºè®®ä½ ä»¬å¯ä»¥é€šè¿‡<a href="http://www.tcpdump.org/manpages/" target="_blank" rel="external">å¸®åŠ©é¡µ</a>è·å–æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯ã€‚</p>
<h3 id="åˆ¤æ–­æºå’Œç›®çš„åœ°å€"><a href="#åˆ¤æ–­æºå’Œç›®çš„åœ°å€" class="headerlink" title="åˆ¤æ–­æºå’Œç›®çš„åœ°å€"></a>åˆ¤æ–­æºå’Œç›®çš„åœ°å€</h3><p>åˆ¤æ–­æºå’Œç›®çš„åœ°å€å’Œç«¯å£å·ç›¸å½“ç®€å•ã€‚</p>
<p>ä»ä¸Šé¢çš„è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æº IP åœ°å€æ˜¯ <code>10.0.3.246</code>ï¼Œæºç«¯å£å·æ˜¯ <code>56894</code>ï¼Œ ç›®çš„ IP åœ°å€æ˜¯ <code>192.168.0.92</code>ï¼Œç«¯å£å·æ˜¯ <code>22</code>ã€‚ä¸€æ—¦ä½ ç†è§£  <code>tcpdump</code>  æ ¼å¼åï¼Œè¿™äº›ä¿¡æ¯å¾ˆå®¹æ˜“åˆ¤æ–­ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰çŒœåˆ°æ ¼å¼ï¼Œä½ å¯ä»¥æŒ‰ç…§ <code>src-ip.src-port &gt; dest-ip.dest-port: Flags[S]</code> æ ¼å¼æ¥åˆ†æã€‚æºåœ°å€ä½äº <code>&gt;</code> å‰é¢ï¼Œåé¢åˆ™æ˜¯ç›®çš„åœ°å€ã€‚ä½ å¯ä»¥æŠŠ <code>&gt;</code> æƒ³è±¡æˆä¸€ä¸ªæŒ‡å‘ç›®çš„åœ°å€çš„ç®­å¤´ç¬¦å·ã€‚</p>
<h3 id="åˆ¤æ–­æ•°æ®åŒ…ç±»å‹"><a href="#åˆ¤æ–­æ•°æ®åŒ…ç±»å‹" class="headerlink" title="åˆ¤æ–­æ•°æ®åŒ…ç±»å‹"></a>åˆ¤æ–­æ•°æ®åŒ…ç±»å‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.0.3.246.56894 &gt; 192.168.0.92.22: Flags [S], cksum 0xcf28 (incorrect -&gt; 0x0388), seq 682725222, win 29200, options [mss 1460,sackOK,TS val 619989005 ecr 0,nop,wscale 7], length 0</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­è¿™ä¸ªæ•°æ®åŒ…æ˜¯ä¸€ä¸ª <code>SYN</code> æ•°æ®åŒ…ã€‚æˆ‘ä»¬æ˜¯é€šè¿‡  <code>tcpdump</code>  è¾“å‡ºä¸­çš„ <code>[S]</code> æ ‡è®°å­—æ®µå¾—å‡ºè¿™ä¸ªç»“è®ºï¼Œä¸åŒç±»å‹çš„æ•°æ®åŒ…æœ‰ä¸åŒç±»å‹çš„æ ‡è®°ã€‚ä¸éœ€è¦æ·±å…¥äº†è§£ <code>TCP</code> åè®®ä¸­çš„æ•°æ®åŒ…ç±»å‹ï¼Œä½ å°±å¯ä»¥é€šè¿‡ä¸‹é¢çš„é€ŸæŸ¥è¡¨æ¥åŠ ä»¥åˆ¤æ–­ã€‚</p>
<ul>
<li>[S] â€“ SYN (å¼€å§‹è¿æ¥)</li>
<li>[.] â€“ æ²¡æœ‰æ ‡è®°</li>
<li>[P] â€“ PSH (æ•°æ®æ¨é€)</li>
<li>[F] â€“ FIN (ç»“æŸè¿æ¥)</li>
<li>[R] â€“ RST (é‡å¯è¿æ¥)</li>
</ul>
<p>åœ¨è¿™ä¸ªç‰ˆæœ¬çš„  <code>tcpdump</code>  è¾“å‡ºä¸­ï¼Œ<code>[S.]</code> æ ‡è®°ä»£è¡¨è¿™ä¸ªæ•°æ®åŒ…æ˜¯ <code>SYN-ACK</code> æ•°æ®åŒ…ã€‚</p>
<h3 id="ä¸å¥½çš„ä¾‹å­"><a href="#ä¸å¥½çš„ä¾‹å­" class="headerlink" title="ä¸å¥½çš„ä¾‹å­"></a>ä¸å¥½çš„ä¾‹å­</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">15:15:43.323412 IP (tos 0x0, ttl 64, id 51051, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    10.0.3.246.56894 &gt; 192.168.0.92.22: Flags [S], cksum 0xcf28 (incorrect -&gt; 0x0388), seq 682725222, win 29200, options [mss 1460,sackOK,TS val 619989005 ecr 0,nop,wscale 7], length 0</span><br><span class="line">15:15:44.321444 IP (tos 0x0, ttl 64, id 51052, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    10.0.3.246.56894 &gt; 192.168.0.92.22: Flags [S], cksum 0xcf28 (incorrect -&gt; 0x028e), seq 682725222, win 29200, options [mss 1460,sackOK,TS val 619989255 ecr 0,nop,wscale 7], length 0</span><br><span class="line">15:15:46.321610 IP (tos 0x0, ttl 64, id 51053, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    10.0.3.246.56894 &gt; 192.168.0.92.22: Flags [S], cksum 0xcf28 (incorrect -&gt; 0x009a), seq 682725222, win 29200, options [mss 1460,sackOK,TS val 619989755 ecr 0,nop,wscale 7], length 0</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æ˜¾ç¤ºäº†ä¸€ä¸ªä¸å¥½çš„é€šä¿¡ä¾‹å­ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­â€œä¸å¥½â€ï¼Œä»£è¡¨é€šä¿¡æ²¡æœ‰å»ºç«‹èµ·æ¥ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>10.0.3.246</code> å‘å‡ºä¸€ä¸ª <code>SYN</code> æ•°æ®åŒ…ç»™ ä¸»æœº <code>192.168.0.92</code>ï¼Œä½†æ˜¯ä¸»æœºå¹¶æ²¡æœ‰åº”ç­”ã€‚</p>
<h3 id="å¥½çš„ä¾‹å­"><a href="#å¥½çš„ä¾‹å­" class="headerlink" title="å¥½çš„ä¾‹å­"></a>å¥½çš„ä¾‹å­</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">15:18:25.716453 IP (tos 0x10, ttl 64, id 53344, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    10.0.3.246.34908 &gt; 192.168.0.110.22: Flags [S], cksum 0xcf3a (incorrect -&gt; 0xc838), seq 1943877315, win 29200, options [mss 1460,sackOK,TS val 620029603 ecr 0,nop,wscale 7], length 0</span><br><span class="line">15:18:25.716777 IP (tos 0x0, ttl 63, id 0, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    192.168.0.110.22 &gt; 10.0.3.246.34908: Flags [S.], cksum 0x594a (correct), seq 4001145915, ack 1943877316, win 5792, options [mss 1460,sackOK,TS val 18495104 ecr 620029603,nop,wscale 2], length 0</span><br><span class="line">15:18:25.716899 IP (tos 0x10, ttl 64, id 53345, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.3.246.34908 &gt; 192.168.0.110.22: Flags [.], cksum 0xcf32 (incorrect -&gt; 0x9dcc), ack 1, win 229, options [nop,nop,TS val 620029603 ecr 18495104], length 0</span><br></pre></td></tr></table></figure>
<p>å¥½çš„ä¾‹å­åº”è¯¥å‘ä¸Šé¢è¿™æ ·ï¼Œæˆ‘ä»¬çœ‹åˆ°å…¸å‹çš„ TCP 3æ¬¡æ¡æ‰‹ã€‚ç¬¬ä¸€æ•°æ®åŒ…æ˜¯ <code>SYN</code> åŒ…ï¼Œä»ä¸»æœº <code>10.0.3.246</code> å‘é€ç»™ ä¸»æœº<code>192.168.0.110</code>ï¼Œç¬¬äºŒä¸ªåŒ…æ˜¯ <code>SYN-ACK</code> åŒ…ï¼Œä¸»æœº<code>192.168.0.110</code> å›åº” <code>SYN</code> åŒ…ã€‚æœ€åä¸€ä¸ªåŒ…æ˜¯ä¸€ä¸ª <code>ACK</code> æˆ–è€… <code>SYN â€“ ACK â€“ ACK</code> åŒ…ï¼Œæ˜¯ä¸»æœº <code>10.0.3.246</code> å›åº”æ”¶åˆ°äº† <code>SYN â€“ ACK</code> åŒ…ã€‚ä»ä¸Šé¢çœ‹åˆ°ä¸€ä¸ª TCP/IP è¿æ¥æˆåŠŸå»ºç«‹ã€‚</p>
<h2 id="æ•°æ®åŒ…æ£€æŸ¥"><a href="#æ•°æ®åŒ…æ£€æŸ¥" class="headerlink" title="æ•°æ®åŒ…æ£€æŸ¥"></a>æ•°æ®åŒ…æ£€æŸ¥</h2><h3 id="ç”¨åå…­è¿›åˆ¶å’Œ-ASCII-ç æ‰“å°æ•°æ®åŒ…"><a href="#ç”¨åå…­è¿›åˆ¶å’Œ-ASCII-ç æ‰“å°æ•°æ®åŒ…" class="headerlink" title="ç”¨åå…­è¿›åˆ¶å’Œ ASCII ç æ‰“å°æ•°æ®åŒ…"></a>ç”¨åå…­è¿›åˆ¶å’Œ ASCII ç æ‰“å°æ•°æ®åŒ…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tcpdump  -nvvv -i any -c 1 -XX 'port 80 and host 10.0.3.1'</span></span><br></pre></td></tr></table></figure>
<p>æ’æŸ¥åº”ç”¨ç¨‹åºç½‘ç»œé—®é¢˜çš„é€šå¸¸åšæ³•ï¼Œå°±æ˜¯ç”¨  <code>tcpdump</code>  çš„ <code>-XX</code> æ ‡è®°æ‰“å°å‡º 16 è¿›åˆ¶å’Œ ASCII ç æ ¼å¼çš„æ•°æ®åŒ…ã€‚è¿™æ˜¯ä¸€ä¸ªç›¸å½“æœ‰ç”¨çš„å‘½ä»¤ï¼Œå®ƒå¯ä»¥è®©ä½ çœ‹åˆ°æºåœ°å€ï¼Œç›®çš„åœ°å€ï¼Œæ•°æ®åŒ…ç±»å‹ä»¥åŠæ•°æ®åŒ…æœ¬èº«ã€‚ä½†æˆ‘ä¸æ˜¯è¿™ä¸ªå‘½ä»¤è¾“å‡ºçš„ç²‰ä¸ï¼Œæˆ‘è®¤ä¸ºå®ƒå¤ªéš¾è¯»äº†ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -nvvv -i any -c 1 -XX 'port 80 and host 10.0.3.1'</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">19:51:15.697640 IP (tos 0x0, ttl 64, id 54313, offset 0, flags [DF], proto TCP (6), length 483)</span><br><span class="line">    10.0.3.1.45732 &gt; 10.0.3.246.80: Flags [P.], cksum 0x1ccc (incorrect -&gt; 0x2ce8), seq 3920159713:3920160144, ack 969855140, win 245, options [nop,nop,TS val 624122099 ecr 624117334], length 431</span><br><span class="line">        0x0000:  0000 0001 0006 fe0a e2d1 8785 0000 0800  ................</span><br><span class="line">        0x0010:  4500 01e3 d429 4000 4006 49f5 0a00 0301  E....)@.@.I.....</span><br><span class="line">        0x0020:  0a00 03f6 b2a4 0050 e9a8 e3e1 39ce d0a4  .......P....9...</span><br><span class="line">        0x0030:  8018 00f5 1ccc 0000 0101 080a 2533 58f3  ............%3X.</span><br><span class="line">        0x0040:  2533 4656 4745 5420 2f73 6f6d 6570 6167  %3FVGET./somepag</span><br><span class="line">        0x0050:  6520 4854 5450 2f31 2e31 0d0a 486f 7374  e.HTTP/1.1..Host</span><br><span class="line">        0x0060:  3a20 3130 2e30 2e33 2e32 3436 0d0a 436f  :.10.0.3.246..Co</span><br><span class="line">        0x0070:  6e6e 6563 7469 6f6e 3a20 6b65 6570 2d61  nnection:.keep<span class="_">-a</span></span><br><span class="line">        0x0080:  6c69 7665 0d0a 4361 6368 652d 436f 6e74  live..Cache-Cont</span><br><span class="line">        0x0090:  726f 6c3a 206d 6178 2d61 6765 3d30 0d0a  rol:.max-age=0..</span><br><span class="line">        0x00a0:  4163 6365 7074 3a20 7465 7874 2f68 746d  Accept:.text/htm</span><br><span class="line">        0x00b0:  6c2c 6170 706c 6963 6174 696f 6e2f 7868  l,application/xh</span><br><span class="line">        0x00c0:  746d 6c2b 786d 6c2c 6170 706c 6963 6174  tml+xml,applicat</span><br><span class="line">        0x00d0:  696f 6e2f 786d 6c3b 713d 302e 392c 696d  ion/xml;q=0.9,im</span><br><span class="line">        0x00e0:  6167 652f 7765 6270 2c2a 2f2a 3b71 3d30  age/webp,*/*;q=0</span><br><span class="line">        0x00f0:  2e38 0d0a 5573 6572 2d41 6765 6e74 3a20  .8..User-Agent:.</span><br><span class="line">        0x0100:  4d6f 7a69 6c6c 612f 352e 3020 284d 6163  Mozilla/5.0.(Mac</span><br><span class="line">        0x0110:  696e 746f 7368 3b20 496e 7465 6c20 4d61  intosh;.Intel.Ma</span><br><span class="line">        0x0120:  6320 4f53 2058 2031 305f 395f 3529 2041  c.OS.X.10_9_5).A</span><br><span class="line">        0x0130:  7070 6c65 5765 624b 6974 2f35 3337 2e33  ppleWebKit/537.3</span><br><span class="line">        0x0140:  3620 284b 4854 4d4c 2c20 6c69 6b65 2047  6.(KHTML,.like.G</span><br><span class="line">        0x0150:  6563 6b6f 2920 4368 726f 6d65 2f33 382e  ecko).Chrome/38.</span><br><span class="line">        0x0160:  302e 3231 3235 2e31 3031 2053 6166 6172  0.2125.101.Safar</span><br><span class="line">        0x0170:  692f 3533 372e 3336 0d0a 4163 6365 7074  i/537.36..Accept</span><br><span class="line">        0x0180:  2d45 6e63 6f64 696e 673a 2067 7a69 702c  -Encoding:.gzip,</span><br><span class="line">        0x0190:  6465 666c 6174 652c 7364 6368 0d0a 4163  deflate,sdch..Ac</span><br><span class="line">        0x01a0:  6365 7074 2d4c 616e 6775 6167 653a 2065  cept-Language:.e</span><br><span class="line">        0x01b0:  6e2d 5553 2c65 6e3b 713d 302e 380d 0a49  n-US,en;q=0.8..I</span><br><span class="line">        0x01c0:  662d 4d6f 6469 6669 6564 2d53 696e 6365  f-Modified-Since</span><br><span class="line">        0x01d0:  3a20 5375 6e2c 2031 3220 4f63 7420 3230  :.Sun,.12.Oct.20</span><br><span class="line">        0x01e0:  3134 2031 393a 3430 3a32 3020 474d 540d  14.19:40:20.GMT.</span><br><span class="line">        0x01f0:  0a0d 0a                                  ...</span><br></pre></td></tr></table></figure></p>
<h3 id="åªæ‰“å°-ASCII-ç æ ¼å¼çš„æ•°æ®åŒ…"><a href="#åªæ‰“å°-ASCII-ç æ ¼å¼çš„æ•°æ®åŒ…" class="headerlink" title="åªæ‰“å° ASCII ç æ ¼å¼çš„æ•°æ®åŒ…"></a>åªæ‰“å° ASCII ç æ ¼å¼çš„æ•°æ®åŒ…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tcpdump  -nvvv -i any -c 1 -A 'port 80 and host 10.0.3.1'</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘å€¾å‘äºåªæ‰“å° ASCII æ ¼å¼æ•°æ®ï¼Œè¿™å¯ä»¥å¸®åŠ©æˆ‘å¿«é€Ÿå®šä½æ•°æ®åŒ…ä¸­å‘é€äº†ä»€ä¹ˆï¼Œå“ªäº›æ˜¯æ­£ç¡®çš„ï¼Œå“ªäº›æ˜¯é”™è¯¯çš„ã€‚ä½ å¯ä»¥é€šè¿‡ <code>-A</code> æ ‡è®°æ¥å®ç°è¿™ä¸€ç‚¹ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -nvvv -i any -c 1 -A 'port 80 and host 10.0.3.1'</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">19:59:52.011337 IP (tos 0x0, ttl 64, id 53757, offset 0, flags [DF], proto TCP (6), length 406)</span><br><span class="line">    10.0.3.1.46172 &gt; 10.0.3.246.80: Flags [P.], cksum 0x1c7f (incorrect -&gt; 0xead1), seq 1552520173:1552520527, ack 428165415, win 237, options [nop,nop,TS val 624251177 ecr 624247749], length 354</span><br><span class="line">E.....@.@.Ln</span><br><span class="line">...</span><br><span class="line">....\.P\.....I<span class="string">'...........</span><br><span class="line">%5Q)%5C.GET /newpage HTTP/1.1</span><br><span class="line"> </span><br><span class="line">Host: 10.0.3.246</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/38.0.2125.101 Safari/537.36</span><br><span class="line">Accept-Encoding: gzip,deflate,sdch</span><br><span class="line">Accept-Language: en-US,en;q=0.8</span></span><br></pre></td></tr></table></figure></p>
<p>ä»ä¸Šé¢çš„è¾“å‡ºï¼Œä½ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸè·å–äº†ä¸€ä¸ª http çš„ <code>GET</code> è¯·æ±‚åŒ…ã€‚å¦‚æœç½‘ç»œé€šä¿¡æ²¡æœ‰è¢«åŠ å¯†ï¼Œç”¨äººç±»å¯é˜…è¯»çš„æ ¼å¼æ‰“å‡ºåŒ…ä¸­æ•°æ®ï¼Œå¯¹äºè§£å†³åº”ç”¨ç¨‹åºçš„é—®é¢˜æ˜¯å¾ˆæœ‰å¸®åŠ©ã€‚å¦‚æœä½ æ’æŸ¥ä¸€ä¸ªç½‘ç»œé€šä¿¡è¢«åŠ å¯†çš„é—®é¢˜ï¼Œæ‰“å°åŒ…ä¸­æ•°æ®å°±ä¸æ˜¯å¾ˆæœ‰ç”¨ã€‚ä¸è¿‡å¦‚æœä½ æœ‰è¯ä¹¦çš„è¯ï¼Œä½ è¿˜æ˜¯å¯ä»¥ä½¿ç”¨ <code>ssldump</code> æˆ–è€… <code>wireshark</code>ã€‚</p>
<h2 id="é-TCP-æ•°æ®æµ"><a href="#é-TCP-æ•°æ®æµ" class="headerlink" title="é TCP æ•°æ®æµ"></a>é TCP æ•°æ®æµ</h2><p>è™½ç„¶è¿™ç¯‡æ–‡ç« ä¸»è¦é‡‡ç”¨ TCP ä¼ è¾“æ¥è®²è§£  <code>tcpdump</code> ï¼Œä½†æ˜¯  <code>tcpdump</code>  ç»å¯¹ä¸æ˜¯åªèƒ½æŠ“ TCP æ•°æ®åŒ…ã€‚å®ƒè¿˜å¯ä»¥ç”¨æ¥è·å–å…¶ä»–ç±»å‹çš„æ•°æ®åŒ…ï¼Œä¾‹å¦‚ ICMPã€ UDP å’Œ ARP åŒ…ã€‚ä¸‹é¢æ˜¯ä¸€äº›ç®€å•çš„ä¾‹å­ï¼Œè¯´æ˜  <code>tcpdump</code>  å¯ä»¥æˆªè·é TCP æ•°æ®åŒ…ã€‚</p>
<h3 id="ICMP-æ•°æ®åŒ…"><a href="#ICMP-æ•°æ®åŒ…" class="headerlink" title="ICMP æ•°æ®åŒ…"></a>ICMP æ•°æ®åŒ…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -nvvv -i any -c 2 icmp</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">20:11:24.627824 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto ICMP (1), length 84)</span><br><span class="line">    10.0.3.169 &gt; 10.0.3.246: ICMP <span class="built_in">echo</span> request, id 15683, seq 1, length 64</span><br><span class="line">20:11:24.627926 IP (tos 0x0, ttl 64, id 31312, offset 0, flags [none], proto ICMP (1), length 84)</span><br><span class="line">    10.0.3.246 &gt; 10.0.3.169: ICMP <span class="built_in">echo</span> reply, id 15683, seq 1, length 64</span><br></pre></td></tr></table></figure>
<h3 id="UDP-æ•°æ®åŒ…"><a href="#UDP-æ•°æ®åŒ…" class="headerlink" title="UDP æ•°æ®åŒ…"></a>UDP æ•°æ®åŒ…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpdump -nvvv -i any -c 2 udp</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">20:12:41.726355 IP (tos 0xc0, ttl 64, id 0, offset 0, flags [DF], proto UDP (17), length 76)</span><br><span class="line">    10.0.3.246.123 &gt; 198.55.111.50.123: [bad udp cksum 0x43a9 -&gt; 0x7043!] NTPv4, length 48</span><br><span class="line">        Client, Leap indicator: clock unsynchronized (192), Stratum 2 (secondary reference), poll 6 (64s), precision -22</span><br><span class="line">        Root Delay: 0.085678, Root dispersion: 57.141830, Reference-ID: 199.102.46.75</span><br><span class="line">          Reference Timestamp:  3622133515.811991035 (2014/10/12 20:11:55)</span><br><span class="line">          Originator Timestamp: 3622133553.828614115 (2014/10/12 20:12:33)</span><br><span class="line">          Receive Timestamp:    3622133496.748308420 (2014/10/12 20:11:36)</span><br><span class="line">          Transmit Timestamp:   3622133561.726278364 (2014/10/12 20:12:41)</span><br><span class="line">            Originator - Receive Timestamp:  -57.080305658</span><br><span class="line">            Originator - Transmit Timestamp: +7.897664248</span><br><span class="line">20:12:41.748948 IP (tos 0x0, ttl 54, id 9285, offset 0, flags [none], proto UDP (17), length 76)</span><br><span class="line">    198.55.111.50.123 &gt; 10.0.3.246.123: [udp sum ok] NTPv4, length 48</span><br><span class="line">        Server, Leap indicator:  (0), Stratum 3 (secondary reference), poll 6 (64s), precision -20</span><br><span class="line">        Root Delay: 0.054077, Root dispersion: 0.058944, Reference-ID: 216.229.0.50</span><br><span class="line">          Reference Timestamp:  3622132887.136984840 (2014/10/12 20:01:27)</span><br><span class="line">          Originator Timestamp: 3622133561.726278364 (2014/10/12 20:12:41)</span><br><span class="line">          Receive Timestamp:    3622133618.830113530 (2014/10/12 20:13:38)</span><br><span class="line">          Transmit Timestamp:   3622133618.830129086 (2014/10/12 20:13:38)</span><br><span class="line">            Originator - Receive Timestamp:  +57.103835195</span><br><span class="line">            Originator - Transmit Timestamp: +57.103850722</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä½ è§‰å¾—æœ‰å¥½ä¾‹å­è¿›ä¸€æ­¥è¯´æ˜  <code>tcpdump</code>  å‘½ä»¤ï¼Œè¯·åœ¨è¯„è®ºä¸­è¡¥å……ã€‚</p>
<p>æ¥æºï¼šbencane.com</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Calico é—®é¢˜æ’éšœ]]></title>
      <url>http://team.jiunile.com/blog/2019/05/k8s-calico-troubleshooting.html</url>
      <content type="html"><![CDATA[<h2 id="æ•…éšœä¸€"><a href="#æ•…éšœä¸€" class="headerlink" title="æ•…éšœä¸€"></a>æ•…éšœä¸€</h2><h3 id="é—®é¢˜è¡¨ç°"><a href="#é—®é¢˜è¡¨ç°" class="headerlink" title="é—®é¢˜è¡¨ç°"></a>é—®é¢˜è¡¨ç°</h3><p>é›†ç¾¤ä¸­æœ‰å°nodeæœåŠ¡å™¨å› ä¸ºèµ„æºè¾¾åˆ°ä¸Šé™å‡ºç°å‡æ­»ç°çŠ¶ï¼Œé‡å¯åå‘ç°calico node æ— æ³•å¯åŠ¨æˆåŠŸï¼Œæç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:Readiness probe failed: caliconode is not ready: BIRD is not ready: BGP not established with 172.18.0.1</span><br></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨<code>calicoctl node status</code> å‘½ä»¤æŸ¥çœ‹nodeçŠ¶æ€ä¿¡æ¯æç¤ºå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Calico process is running.</span><br><span class="line"></span><br><span class="line">IPv4 BGP status</span><br><span class="line">+--------------+-------------------+-------+----------+--------------------------------+</span><br><span class="line">| PEER ADDRESS |     PEER TYPE     | STATE |  SINCE   |              INFO              |</span><br><span class="line">+--------------+-------------------+-------+----------+--------------------------------+</span><br><span class="line">| 172.18.0.1   | node-to-node mesh | start | 01:56:41 | Connect Socket: Network        |</span><br><span class="line">|              |                   |       |          | unreachable                    |</span><br><span class="line">+--------------+-------------------+-------+----------+--------------------------------+</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<h3 id="é—®é¢˜æ’æŸ¥"><a href="#é—®é¢˜æ’æŸ¥" class="headerlink" title="é—®é¢˜æ’æŸ¥"></a>é—®é¢˜æ’æŸ¥</h3><p>åœ¨BGPç½‘ç»œä¸­å‡ºç°äº†ä¸€ä¸ªæœªçŸ¥çš„IPåœ°å€172.18.0.1ï¼Œæˆ‘ä»¬é›†ç¾¤ä¸­çš„æœºå™¨éƒ½æ˜¯10å¼€å¤´çš„ç½‘ç»œåœ°å€ï¼Œæ‰€ä»¥ç™»å½•æœ‰é—®é¢˜çš„æœºå™¨ä¸ŠæŸ¥çœ‹å¯¹åº”çš„ç½‘ç»œä¿¡æ¯ <code>ip a</code>ï¼Œç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">14: br-3a10a9384428: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:3a:f3:45:18 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.1/16 brd 172.18.255.255 scope global br-3a10a9384428</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:3aff:fef3:4518/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></p>
<p>åæ¥å’¨è¯¢äº†ç›¸å…³åŒäº‹ï¼Œç»“æœæ˜¯åŒäº‹åœ¨nodeæœºå™¨ä¸Šç”¨dockerå¯åŠ¨äº†<a href="https://github.com/google/cadvisor" target="_blank" rel="external"><code>advisor</code></a> è¿™ä¸ªå®¹å™¨ç›‘æ§ç¨‹åºï¼Œæ‰€ä»¥ä¼šäº§ç”Ÿä¸€å—è™šæ‹Ÿç½‘å¡å‡ºæ¥ã€‚</p>
<h3 id="é—®é¢˜å¤„ç†"><a href="#é—®é¢˜å¤„ç†" class="headerlink" title="é—®é¢˜å¤„ç†"></a>é—®é¢˜å¤„ç†</h3><h4 id="æ–¹æ¡ˆä¸€"><a href="#æ–¹æ¡ˆä¸€" class="headerlink" title="æ–¹æ¡ˆä¸€"></a>æ–¹æ¡ˆä¸€</h4><p>å°†<code>advisor</code> æ”¹æˆä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶å¯åŠ¨ï¼Œä¸ä½¿ç”¨å®¹å™¨å¯åŠ¨ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿè™šæ‹Ÿç½‘ç»œè®¾å¤‡</p>
<h4 id="æ–¹æ¡ˆäºŒ"><a href="#æ–¹æ¡ˆäºŒ" class="headerlink" title="æ–¹æ¡ˆäºŒ"></a>æ–¹æ¡ˆäºŒ</h4><p>è°ƒæ•´calicao ç½‘ç»œæ’ä»¶çš„ç½‘å¡å‘ç°æœºåˆ¶ï¼Œä¿®æ”¹<code>IP_AUTODETECTION_METHOD</code>å¯¹åº”çš„valueå€¼ã€‚å®˜æ–¹æä¾›çš„yamlæ–‡ä»¶ä¸­ï¼Œipè¯†åˆ«ç­–ç•¥ï¼ˆIPDETECTMETHODï¼‰æ²¡æœ‰é…ç½®ï¼Œå³é»˜è®¤ä¸ºfirst-foundï¼Œè¿™ä¼šå¯¼è‡´ä¸€ä¸ªç½‘ç»œå¼‚å¸¸çš„ipä½œä¸ºnodeIPè¢«æ³¨å†Œï¼Œä»è€Œå½±å“<code>node-to-node mesh</code>ã€‚æˆ‘ä»¬å¯ä»¥ä¿®æ”¹æˆ<code>can-reach</code>æˆ–è€…<code>interface</code>çš„ç­–ç•¥ï¼Œå°è¯•è¿æ¥æŸä¸€ä¸ªReadyçš„nodeçš„IPï¼Œä»¥æ­¤é€‰æ‹©å‡ºæ­£ç¡®çš„IPã€‚</p>
<ul>
<li><p><strong>can-reach</strong> ä½¿ç”¨æ‚¨çš„æœ¬åœ°è·¯ç”±æ¥ç¡®å®šå°†ä½¿ç”¨å“ªä¸ªIPåœ°å€åˆ°è¾¾æä¾›çš„ç›®æ ‡ã€‚å¯ä»¥ä½¿ç”¨IPåœ°å€å’ŒåŸŸåã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Using IP addresses</span></span><br><span class="line">IP_AUTODETECTION_METHOD=can-reach=8.8.8.8</span><br><span class="line">IP6_AUTODETECTION_METHOD=can-reach=2001:4860:4860::8888</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using domain names</span></span><br><span class="line">IP_AUTODETECTION_METHOD=can-reach=www.google.com</span><br><span class="line">IP6_AUTODETECTION_METHOD=can-reach=www.google.com</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>interface</strong> ä½¿ç”¨æä¾›çš„æ¥å£æ­£åˆ™è¡¨è¾¾å¼ï¼ˆgolangè¯­æ³•ï¼‰æšä¸¾åŒ¹é…çš„æ¥å£å¹¶è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…æ¥å£ä¸Šçš„ç¬¬ä¸€ä¸ªIPåœ°å€ã€‚åˆ—å‡ºæ¥å£å’ŒIPåœ°å€çš„é¡ºåºå–å†³äºç³»ç»Ÿã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Valid IP address on interface eth0, eth1, eth2 etc.</span></span><br><span class="line">IP_AUTODETECTION_METHOD=interface=eth.*</span><br><span class="line">IP6_AUTODETECTION_METHOD=interface=eth.*</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="æ•…éšœäºŒ"><a href="#æ•…éšœäºŒ" class="headerlink" title="æ•…éšœäºŒ"></a>æ•…éšœäºŒ</h2><h3 id="é—®é¢˜è¡¨ç°-1"><a href="#é—®é¢˜è¡¨ç°-1" class="headerlink" title="é—®é¢˜è¡¨ç°"></a>é—®é¢˜è¡¨ç°</h3><p>å°†æŸå°æ–°æœºå™¨ï¼ˆawsç¾ä¸œåŒºåŸŸï¼‰åŠ åˆ°å®¹å™¨é›†ç¾¤ä¹‹åï¼Œå‘ç°è¯¥èŠ‚ç‚¹æ²¡æ³•åŠ å…¥åˆ°å®¹å™¨é›†ç¾¤é‡Œé¢ã€‚</p>
<p>è¯¥èŠ‚ç‚¹çš„calico-nodeå¯åŠ¨åä¸ä¹…åå¤çš„crashé‡å¯ã€‚crashå‰çš„logå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl logs -f calico-node-wm6bb  -n kube-system -c calico-node</span></span><br><span class="line">Skipping datastore connection <span class="built_in">test</span></span><br><span class="line">Using autodetected IPv4 address 10.12.13.12/24 on matching interface eth0</span><br></pre></td></tr></table></figure></p>
<p>æ°å·§æ–°åŠ å¡å’Œç¾ä¸œåŒºåŸŸå„æœ‰ä¸€å°é—²ç½®æœºå™¨ï¼Œå°è¯•å°†è¿™ä¸¤å°æœºå™¨åŠ å…¥calicoç½‘ç»œã€‚å‘ç°æ–°åŠ å¡æœºå™¨æˆåŠŸåŠ å…¥åˆ°calicoç½‘ç»œï¼Œè€Œç¾ä¸œæœºå™¨åŠ å…¥calicoå¤±è´¥ï¼Œä¸”å¤±è´¥è¡¨ç°ç›¸åŒã€‚</p>
<p>è¿™ç©¶ç«Ÿæ˜¯ä»€ä¹ˆé¬¼åŸå› ï¼Ÿ</p>
<h3 id="é—®é¢˜æ’æŸ¥-1"><a href="#é—®é¢˜æ’æŸ¥-1" class="headerlink" title="é—®é¢˜æ’æŸ¥"></a>é—®é¢˜æ’æŸ¥</h3><h4 id="æ’é™¤ETCDè¿æ¥é—®é¢˜"><a href="#æ’é™¤ETCDè¿æ¥é—®é¢˜" class="headerlink" title="æ’é™¤ETCDè¿æ¥é—®é¢˜"></a>æ’é™¤ETCDè¿æ¥é—®é¢˜</h4><p>calico-nodeå¯åŠ¨é˜¶æ®µä¼šè®¿é—®etcdè·å–é›†ç¾¤ç½‘ç»œé…ç½®ï¼Œæ‰€ä»¥é¦–å…ˆæ€€ç–‘ä¼šä¸ä¼šæ˜¯èŠ‚ç‚¹è¿æ¥etcdå¤±è´¥ã€‚</p>
<p>åœ¨é—®é¢˜èŠ‚ç‚¹ä¸Šï¼Œå°è¯•è®¿é—®etcdï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  curl --cacert /etc/cni/net.d/calico-tls/etcd-ca --cert /etc/cni/net.d/calico-tls/etcd-cert --key /etc/cni/net.d/calico-tls/etcd-key https://[ETCDæœåŠ¡IP]:2379/health</span></span><br><span class="line">&#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>å‘ç°å¯ä»¥è¿ä¸Šetcdã€‚é‚£ä¹ˆå¯ä»¥æ’é™¤etcdè¿æ¥é—®é¢˜ã€‚</p>
<h4 id="æ’é™¤AWSè·¯ç”±è¡¨é™åˆ¶"><a href="#æ’é™¤AWSè·¯ç”±è¡¨é™åˆ¶" class="headerlink" title="æ’é™¤AWSè·¯ç”±è¡¨é™åˆ¶"></a>æ’é™¤AWSè·¯ç”±è¡¨é™åˆ¶</h4><p><a href="https://docs.aws.amazon.com/vpc/latest/userguide/amazon-vpc-limits.html#vpc-limits-route-tables" target="_blank" rel="external">AWS EC2è·¯ç”±è¡¨æœ‰50æ¡çš„æ•°é‡é™åˆ¶</a> ï¼Œè¿™æœ‰å¯èƒ½ä¼šé™åˆ¶é›†ç¾¤çš„èŠ‚ç‚¹æ•°ä¸Šé™ã€‚<a href="https://docs.projectcalico.org/v3.2/reference/public-cloud/aws" target="_blank" rel="external">ä½†æ ¹æ®calicoå®˜æ–¹æ–‡æ¡£ï¼Œcalicoåº”è¯¥ä¸å—aws 50èŠ‚ç‚¹çš„é™åˆ¶</a> :<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">No 50 Node Limit: Calico allows you to surpass the 50 node <span class="built_in">limit</span>, <span class="built_in">which</span> exists as a consequence of the AWS 50 route <span class="built_in">limit</span> when using the VPC routing table.</span><br></pre></td></tr></table></figure></p>
<p>è€Œä¸”ï¼Œæˆ‘ä»¬çš„é›†ç¾¤èŠ‚ç‚¹æ•°å·²ç»è¶…å‡º50ï¼ˆç›®å‰èŠ‚ç‚¹æ•°53ï¼‰ã€‚</p>
<p>è‡³æ­¤ï¼Œæ’é™¤AWSè·¯ç”±è¡¨åŸå› ã€‚</p>
<h4 id="æ’é™¤aws-security-groupså½±å“"><a href="#æ’é™¤aws-security-groupså½±å“" class="headerlink" title="æ’é™¤aws security groupså½±å“"></a>æ’é™¤aws security groupså½±å“</h4><p>ä»”ç»†çœ‹äº†<a href="https://docs.projectcalico.org/v2.6/reference/public-cloud/aws" target="_blank" rel="external">calicoçš„awséƒ¨ç½²è¯´æ˜ï¼Œå…¶ä¸­æåˆ°éœ€è¦é…ç½®awså®‰å…¨ç»„ï¼Œå…è®¸BGPå’ŒIPIPé€šä¿¡</a>ï¼Œä¼šä¸ä¼šå› ä¸ºå…¬å¸awsç¾ä¸œåŒºåŸŸå®‰å…¨ç»„é…ç½®çš„åŸå› ï¼Ÿ</p>
<p>æŸ¥çœ‹ç¾ä¸œé‚£ä¸¤å°é—®é¢˜æœºå™¨çš„security-groupsæ˜¯ DY-Default-10.12ï¼Œè€Œå…¶ä»–æœºå™¨çš„ security-groupsæ˜¯DY-Default-10.12ã€‚å¾ˆå¤±æœ›ã€‚å¯ä»¥æ’é™¤aws security groupçš„å½±å“ã€‚</p>
<h4 id="æœ€ç»ˆåŸå› "><a href="#æœ€ç»ˆåŸå› " class="headerlink" title="æœ€ç»ˆåŸå› "></a>æœ€ç»ˆåŸå› </h4><p>è‡³æ­¤ï¼Œé—®é¢˜åŸå› ä»æ¯«æ— å¤´ç»ªã€‚åªå¥½æ‰¾æ¥<a href="https://github.com/projectcalico/node/blob/4db4e815e47885db77957e113a18269fa1ce0ffd/pkg/startup/startup.go#L233" target="_blank" rel="external">calico nodeçš„å¯åŠ¨ä»£ç </a>æ¥çœ‹çœ‹ã€‚</p>
<p>æœŸé—´å‘ç°ï¼Œcalico nodeå¯åŠ¨æ—¶æ˜¯ä¾æ®<code>CALICO_STARTUP_LOGLEVEL</code>ç¯å¢ƒå˜é‡æ¥è®¾ç½®logçº§åˆ«ã€‚è€ƒè™‘åˆ°å‡ºé—®é¢˜çš„calico nodeè¾“å‡ºçš„logå®åœ¨æ˜¯å¤ªå°‘ï¼Œä¿®æ”¹calico nodeçš„daemonseté…ç½®ï¼Œå°†logç­‰çº§è®¾ç½®æˆæœ€ä½çš„DEBUGçº§åˆ«ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - env:</span></span><br><span class="line"><span class="attr">    - name:</span> CALICO_STARTUP_LOGLEVEL</span><br><span class="line"><span class="attr">      value:</span> DEBUG</span><br></pre></td></tr></table></figure></p>
<p>é‡å¯é—®é¢˜èŠ‚ç‚¹çš„calico-nodeï¼Œæœç„¶è¾“å‡ºäº†æ›´å¤šçš„logï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl logs -f calico-node-jz7cz -n kube-system -c calico-node </span></span><br><span class="line">time=<span class="string">"2018-10-31T07:47:16Z"</span> level=info msg=<span class="string">"Early log level set to debug"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:16Z"</span> level=info msg=<span class="string">"NODENAME environment not specified - check HOSTNAME"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:16Z"</span> level=info msg=<span class="string">"Loading config from environment"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:16Z"</span> level=debug msg=<span class="string">"Using datastore type 'etcdv2'"</span> </span><br><span class="line">Skipping datastore connection <span class="built_in">test</span></span><br><span class="line">time=<span class="string">"2018-10-31T07:47:16Z"</span> level=debug msg=<span class="string">"Validate name: AMZ-IAD12-OpsResPool-13-33"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:16Z"</span> level=debug msg=<span class="string">"Get Key: /calico/v1/host/AMZ-IAD12-OpsResPool-13-33/metadata"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=debug msg=<span class="string">"Key not found error"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=debug msg=<span class="string">"Key not found error"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=info msg=<span class="string">"Building new node resource"</span> Name=AMZ-IAD12-OpsResPool-13-33 </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=info msg=<span class="string">"Initialise BGP data"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=debug msg=<span class="string">"Querying interface addresses"</span> Interface=eth0 </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=debug msg=<span class="string">"Found valid IP address and network"</span> CIDR=10.12.13.33/24 </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=debug msg=<span class="string">"Check interface"</span> Name=eth0 </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=debug msg=<span class="string">"Check address"</span> CIDR=10.12.13.33/24 </span><br><span class="line">Using autodetected IPv4 address 10.12.13.33/24 on matching interface eth0</span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=info msg=<span class="string">"Node IPv4 changed, will check for conflicts"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=debug msg=<span class="string">"Listing all host metadatas"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=debug msg=<span class="string">"Parse host directories."</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=debug msg=<span class="string">"Get Node key from /calico/v1/host/AMZ-IAD12-Coupon-35-221/metadata"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=debug msg=<span class="string">"Get Node key from /calico/v1/host/AMZ-IAD12-Coupon-35-222/metadata"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:17Z"</span> level=debug msg=<span class="string">"Get Node key from /calico/v1/host/AMZ-IAD12-OpsResPool-13-31/metadata"</span> </span><br><span class="line"></span><br><span class="line">.... çœç•¥ç±»ä¼¼<span class="built_in">log</span> ....</span><br><span class="line"></span><br><span class="line">time=<span class="string">"2018-10-31T07:47:26Z"</span> level=debug msg=<span class="string">"Get Key: /calico/bgp/v1/host/AMZ-OR39-CTR-135-60/ip_addr_v4"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:26Z"</span> level=debug msg=<span class="string">"Get Key: /calico/bgp/v1/host/AMZ-OR39-CTR-135-60/network_v4"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:26Z"</span> level=debug msg=<span class="string">"Get Key: /calico/bgp/v1/host/AMZ-OR39-CTR-135-60/ip_addr_v6"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:26Z"</span> level=debug msg=<span class="string">"Get Key: /calico/bgp/v1/host/AMZ-OR39-CTR-135-60/network_v6"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:26Z"</span> level=debug msg=<span class="string">"Key not found error"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:26Z"</span> level=debug msg=<span class="string">"Get Key: /calico/bgp/v1/host/AMZ-OR39-CTR-135-60/as_num"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:27Z"</span> level=debug msg=<span class="string">"Key not found error"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:47:27Z"</span> level=debug msg=<span class="string">"Get Key: /calico/v1/host/AMZ-OR39-CTR-135-60/orchestrator_refs"</span> </span><br><span class="line"></span><br><span class="line">.... çœç•¥ç±»ä¼¼<span class="built_in">log</span> ....</span><br><span class="line"></span><br><span class="line">time=<span class="string">"2018-10-31T07:48:12Z"</span> level=debug msg=<span class="string">"Get Key: /calico/bgp/v1/host/AMZ-SIN8-OpsResPool-33-62/ip_addr_v4"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:48:13Z"</span> level=debug msg=<span class="string">"Get Key: /calico/bgp/v1/host/AMZ-SIN8-OpsResPool-33-62/network_v4"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:48:13Z"</span> level=debug msg=<span class="string">"Get Key: /calico/bgp/v1/host/AMZ-SIN8-OpsResPool-33-62/ip_addr_v6"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:48:13Z"</span> level=debug msg=<span class="string">"Get Key: /calico/bgp/v1/host/AMZ-SIN8-OpsResPool-33-62/network_v6"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:48:13Z"</span> level=debug msg=<span class="string">"Key not found error"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:48:13Z"</span> level=debug msg=<span class="string">"Get Key: /calico/bgp/v1/host/AMZ-SIN8-OpsResPool-33-62/as_num"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:48:14Z"</span> level=debug msg=<span class="string">"Key not found error"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:48:14Z"</span> level=debug msg=<span class="string">"Get Key: /calico/v1/host/AMZ-SIN8-OpsResPool-33-62/orchestrator_refs"</span> </span><br><span class="line">time=<span class="string">"2018-10-31T07:48:14Z"</span> level=debug msg=<span class="string">"Get Key: /calico/bgp/v1/host/AMZ-SIN8-OpsResPool-33-63/ip_addr_v4"</span></span><br></pre></td></tr></table></figure></p>
<p>è¾“å‡ºå®Œä¸Šé¢çš„logåï¼Œcalico-nodeå°±è¢«é‡å¯äº†ï¼Œæ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿ</p>
<p>æ ¹æ®calico nodeçš„ä»£ç ï¼Œ<a href="https://github.com/projectcalico/node/blob/4db4e815e47885db77957e113a18269fa1ce0ffd/pkg/startup/startup.go#L1003" target="_blank" rel="external">å¦‚æœcalico nodeå¯åŠ¨å¤±è´¥ï¼Œé‚£é€€å‡ºå‰ä¼šå…ˆæ‰“ä¸€è¡Œlogï¼šTerminating</a>ï¼Œä½†åœ¨ä¸Šé¢çš„logä¸­å¹¶æœªå‘ç°æœ‰Terminatingã€‚</p>
<p>ä»logçœ‹å‡ºï¼Œcalico-nodeç»ˆæ­¢å‰æ˜¯åœ¨æŸ¥è¯¢etcdä¸­çš„èŠ‚ç‚¹æ•°æ®ã€‚äºæ˜¯åˆè¯•äº†è¯•åœ¨é—®é¢˜èŠ‚ç‚¹ä¸ŠæŸ¥è¯¢etcdï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># etcdctl  --ca-file=/var/lib/kubernetes/ca.pem --cert-file=/var/lib/kubernetes/kubernetes.pem --key-file=/var/lib/kubernetes/kubernetes-key.pem --endpoints=https://[etcdæœåŠ¡ip]:2379 get /calico/bgp/v1/host/AMZ-SIN8-OpsResPool-33-63/ip_addr_v4</span></span><br><span class="line">10.8.33.63</span><br></pre></td></tr></table></figure></p>
<p>çœ‹ç»“æœå¾ˆæ­£å¸¸ï¼Œç»ä¸ä¼šå› æ­¤è€Œå‡ºé”™ã€‚</p>
<p>çº ç»“ä¹‹é™…ï¼Œçªç„¶æƒ³åˆ°ï¼šä¼šä¸ä¼šcalico-nodeå¯åŠ¨è¶…æ—¶äº†ï¼Ÿ</p>
<h3 id="é—®é¢˜å¤„ç†-1"><a href="#é—®é¢˜å¤„ç†-1" class="headerlink" title="é—®é¢˜å¤„ç†"></a>é—®é¢˜å¤„ç†</h3><p>é©¬ä¸Šçœ‹äº†ä¸‹calico-node daemonsetçš„livenessProbeï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line"><span class="attr">  failureThreshold:</span> <span class="number">6</span></span><br><span class="line"><span class="attr">  httpGet:</span></span><br><span class="line"><span class="attr">    path:</span> /liveness</span><br><span class="line"><span class="attr">    port:</span> <span class="number">9099</span></span><br><span class="line"><span class="attr">    scheme:</span> HTTP</span><br><span class="line"><span class="attr">  initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  timeoutSeconds:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>å°è¯•ç€æŠŠinitialDelaySecondsåŠ åˆ°60ç§’ï¼ŒfailureThresholdåŠ åˆ°10ã€‚<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line"><span class="attr">  failureThreshold:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  httpGet:</span></span><br><span class="line"><span class="attr">    path:</span> /liveness</span><br><span class="line"><span class="attr">    port:</span> <span class="number">9099</span></span><br><span class="line"><span class="attr">    scheme:</span> HTTP</span><br><span class="line"><span class="attr">  initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">  periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  timeoutSeconds:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>æ”¹å®Œé‡å¯äº†é—®é¢˜èŠ‚ç‚¹çš„calico-nodeã€‚ç­‰å¾…äº†æ•°åˆ†é’Ÿï¼Œå‘ç°å±…ç„¶å¯åŠ¨æˆåŠŸäº†ã€‚</p>
<p>è‡³æ­¤ï¼Œé—®é¢˜åŸå› å°±æ˜ç¡®äº†ï¼š<strong><code>ç”±äºé›†ç¾¤èŠ‚ç‚¹è¶Šæ¥è¶Šå¤šï¼Œcalico-nodeå¯åŠ¨æ‰€éœ€æ—¶é—´ä¹Ÿéšç€å˜é•¿äº†ï¼Œè¶…å‡ºäº†liveness probeçš„é‡å¯æ—¶é—´é™åˆ¶ï¼Œä»è€Œè¢«k8så¹²æ‰é‡å¯</code></strong>ã€‚</p>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆæ–°åŠ å¡åŒºåŸŸçš„èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼Œè€Œç¾ä¸œçš„èŠ‚ç‚¹å¯åŠ¨å¤±è´¥ï¼Ÿ</p>
<p>åŸå› åº”è¯¥æ˜¯ï¼Œæˆ‘ä»¬çš„masterä¸etcdéƒ½åœ¨æ–°åŠ å¡åŒºåŸŸï¼Œå› æ­¤æ–°åŠ å¡èŠ‚ç‚¹ä»etcdè·å–æ•°æ®è¾ƒå¿«ï¼Œcalico-nodeå¯åŠ¨é€Ÿåº¦ä¹Ÿå°±æ›´å¿«ï¼Œå¯ä»¥åœ¨é™å®šçš„æ—¶é—´å†…å¯åŠ¨å®Œæ¯•ã€‚è€Œç¾ä¸œèŠ‚ç‚¹è®¿é—®æ–°åŠ å¡etcdçš„å»¶è¿Ÿè¾ƒé•¿ï¼Œå› æ­¤ç¾ä¸œcalico-nodeå¯åŠ¨æ›´æ…¢ã€‚</p>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è°ˆè°ˆkubernetes Runtime]]></title>
      <url>http://team.jiunile.com/blog/2019/05/k8s-k8s-runtime.html</url>
      <content type="html"><![CDATA[<h2 id="ç™½è¯kubernetes-Runtime"><a href="#ç™½è¯kubernetes-Runtime" class="headerlink" title="ç™½è¯kubernetes Runtime"></a>ç™½è¯kubernetes Runtime</h2><blockquote>
<p>å›æƒ³æœ€å¼€å§‹æ¥è§¦ k8s çš„æ—¶å€™, ç»å¸¸æä¸æ‡‚ CRI å’Œ OCI çš„è”ç³»å’ŒåŒºåˆ«, ä¹Ÿä¸çŸ¥é“ä¸ºå•¥è¦å«é‚£ä¹ˆå¤šçš„ â€œshimâ€(å°¤å…¶æ˜¯ containerd-shim å’Œ dockershim è¿™ä¸¤ä¸ªå®Œå…¨æ²¡å•¥å…³è”çš„ä¸œè¥¿è¿˜æ°å¥½éƒ½å« shim). æ‰€ä»¥å˜›, è¿™ç¯‡å°±å†™ä¸€å†™ k8s çš„ runtime éƒ¨åˆ†, äº‰å–ä¸€ç¯‡æ–‡ç« æŠŠä¸‹é¢è¿™å¼  Landscape é‡Œçš„æ ¸å¿ƒé¡¹ç›®ç»™ç™½è¯æ˜ç™½</p>
</blockquote>
<p><img src="/images/k8s/bf52b77fly1g0wkhtwdlij217c0si44d.jpg" alt="landscape"></p>
<h2 id="å…¸å‹çš„-Runtime-æ¶æ„"><a href="#å…¸å‹çš„-Runtime-æ¶æ„" class="headerlink" title="å…¸å‹çš„ Runtime æ¶æ„"></a>å…¸å‹çš„ Runtime æ¶æ„</h2><p>æˆ‘ä»¬ä»æœ€å¸¸è§çš„ runtime æ–¹æ¡ˆ Docker è¯´èµ·, ç°åœ¨ Kubelet å’Œ Docker çš„é›†æˆè¿˜æ˜¯æŒºå•°å—¦çš„:</p>
<p><img src="/images/k8s/bf52b77fly1g0ws7jziucj21hy0dmtb0.jpg" alt="å…¸å‹çš„runtimeæ¶æ„"><br><a id="more"></a><br>å½“ Kubelet æƒ³è¦åˆ›å»ºä¸€ä¸ªå®¹å™¨æ—¶, æœ‰è¿™ä¹ˆå‡ æ­¥:</p>
<ol>
<li>Kubelet é€šè¿‡ <strong>CRI æ¥å£</strong>(gRPC) è°ƒç”¨ dockershim, è¯·æ±‚åˆ›å»ºä¸€ä¸ªå®¹å™¨. <strong>CRI</strong> å³å®¹å™¨è¿è¡Œæ—¶æ¥å£(Container Runtime Interface), è¿™ä¸€æ­¥ä¸­, Kubelet å¯ä»¥è§†ä½œä¸€ä¸ªç®€å•çš„ CRI Client, è€Œ dockershim å°±æ˜¯æ¥æ”¶è¯·æ±‚çš„ Server. ç›®å‰ dockershim çš„ä»£ç å…¶å®æ˜¯å†…åµŒåœ¨ Kubelet ä¸­çš„, æ‰€ä»¥æ¥æ”¶è°ƒç”¨çš„å‡‘å·§å°±æ˜¯ Kubelet è¿›ç¨‹;</li>
<li>dockershim æ”¶åˆ°è¯·æ±‚å, è½¬åŒ–æˆ Docker Daemon èƒ½å¬æ‡‚çš„è¯·æ±‚, å‘åˆ° Docker Daemon ä¸Šè¯·æ±‚åˆ›å»ºä¸€ä¸ªå®¹å™¨;</li>
<li>Docker Daemon æ—©åœ¨ 1.12 ç‰ˆæœ¬ä¸­å°±å·²ç»å°†é’ˆå¯¹å®¹å™¨çš„æ“ä½œç§»åˆ°å¦ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹: containerd ä¸­äº†, å› æ­¤ Docker Daemon ä»ç„¶ä¸èƒ½å¸®æˆ‘ä»¬åˆ›å»ºå®¹å™¨, è€Œæ˜¯è¦è¯·æ±‚ containerd åˆ›å»ºä¸€ä¸ªå®¹å™¨;</li>
<li>containerd æ”¶åˆ°è¯·æ±‚å, å¹¶ä¸ä¼šè‡ªå·±ç›´æ¥å»æ“ä½œå®¹å™¨, è€Œæ˜¯åˆ›å»ºä¸€ä¸ªå«åš containerd-shim çš„è¿›ç¨‹, è®© containerd-shim å»æ“ä½œå®¹å™¨. è¿™æ˜¯å› ä¸ºå®¹å™¨è¿›ç¨‹éœ€è¦ä¸€ä¸ªçˆ¶è¿›ç¨‹æ¥åšè¯¸å¦‚æ”¶é›†çŠ¶æ€, ç»´æŒ stdin ä»¥åŠ fd æ‰“å¼€ç­‰å·¥ä½œ. è€Œå‡å¦‚è¿™ä¸ªçˆ¶è¿›ç¨‹å°±æ˜¯ containerd, é‚£æ¯æ¬¡ containerd æŒ‚æ‰æˆ–å‡çº§, æ•´ä¸ªå®¿ä¸»æœºä¸Šæ‰€æœ‰çš„å®¹å™¨éƒ½å¾—é€€å‡ºäº†. è€Œå¼•å…¥äº† containerd-shim å°±è§„é¿äº†è¿™ä¸ªé—®é¢˜(containerd å’Œ shim å¹¶ä¸éœ€è¦æ˜¯çˆ¶å­è¿›ç¨‹å…³ç³», å½“ containerd é€€å‡ºæˆ–é‡å¯æ—¶, shim ä¼š re-parent åˆ° systemd è¿™æ ·çš„ 1 å·è¿›ç¨‹ä¸Š);</li>
<li>æˆ‘ä»¬çŸ¥é“åˆ›å»ºå®¹å™¨éœ€è¦åšä¸€äº›è®¾ç½® namespaces å’Œ cgroups, æŒ‚è½½ root filesystem ç­‰ç­‰æ“ä½œ, è€Œè¿™äº›äº‹è¯¥æ€ä¹ˆåšå·²ç»æœ‰äº†å…¬å¼€çš„è§„èŒƒäº†, é‚£å°±æ˜¯ <a href="https://github.com/opencontainers/runtime-spec" target="_blank" rel="external">OCI(Open Container Initiative, å¼€æ”¾å®¹å™¨æ ‡å‡†)</a>. å®ƒçš„ä¸€ä¸ªå‚è€ƒå®ç°å«åš <a href="https://github.com/opencontainers/runc" target="_blank" rel="external">runc</a>. äºæ˜¯, containerd-shim åœ¨è¿™ä¸€æ­¥éœ€è¦è°ƒç”¨ <code>runc</code> è¿™ä¸ªå‘½ä»¤è¡Œå·¥å…·, æ¥å¯åŠ¨å®¹å™¨;</li>
<li><code>runc</code> å¯åŠ¨å®Œå®¹å™¨åæœ¬èº«ä¼šç›´æ¥é€€å‡º, containerd-shim åˆ™ä¼šæˆä¸ºå®¹å™¨è¿›ç¨‹çš„çˆ¶è¿›ç¨‹, è´Ÿè´£æ”¶é›†å®¹å™¨è¿›ç¨‹çš„çŠ¶æ€, ä¸ŠæŠ¥ç»™ containerd, å¹¶åœ¨å®¹å™¨ä¸­ pid ä¸º 1 çš„è¿›ç¨‹é€€å‡ºåæ¥ç®¡å®¹å™¨ä¸­çš„å­è¿›ç¨‹è¿›è¡Œæ¸…ç†, ç¡®ä¿ä¸ä¼šå‡ºç°åƒµå°¸è¿›ç¨‹;</li>
</ol>
<p>è¿™ä¸ªè¿‡ç¨‹ä¹ä¸€çœ‹åƒæ˜¯åœ¨ææˆ‘ä»¬: Docker Daemon å’Œ dockershim çœ‹ä¸Šå»å°±æ˜¯ä¸¤ä¸ªä¸å¹²æ´»èººåœ¨ä¸­é—´åˆ’æ°´çš„å•Š, Kubelet ä¸ºå•¥ä¸ç›´æ¥è°ƒç”¨ containerd å‘¢?</p>
<p>å½“ç„¶æ˜¯å¯ä»¥çš„, ä¸è¿‡å’±ä»¬å…ˆä¸æé‚£ä¸ª, å…ˆçœ‹çœ‹ä¸ºä»€ä¹ˆç°åœ¨çš„æ¶æ„å¦‚æ­¤ç¹å†—.</p>
<h2 id="å°æ’æ›²-å®¹å™¨å†å²å°å™-ä¸è´Ÿè´£ä»»ç‰ˆ"><a href="#å°æ’æ›²-å®¹å™¨å†å²å°å™-ä¸è´Ÿè´£ä»»ç‰ˆ" class="headerlink" title="å°æ’æ›²: å®¹å™¨å†å²å°å™(ä¸è´Ÿè´£ä»»ç‰ˆ)"></a>å°æ’æ›²: å®¹å™¨å†å²å°å™(ä¸è´Ÿè´£ä»»ç‰ˆ)</h2><p>å…¶å® k8s æœ€å¼€å§‹çš„ Runtime æ¶æ„è¿œæ²¡è¿™ä¹ˆå¤æ‚: kubelet æƒ³è¦åˆ›å»ºå®¹å™¨ç›´æ¥è·Ÿ Docker Daemon è¯´ä¸€å£°å°±è¡Œ, è€Œé‚£æ—¶ä¹Ÿä¸å­˜åœ¨ containerd, Docker Daemon è‡ªå·±è°ƒä¸€ä¸‹ <code>libcontainer</code> è¿™ä¸ªåº“æŠŠå®¹å™¨è·‘èµ·æ¥, æ•´ä¸ªè¿‡ç¨‹å°±æå®Œäº†.</p>
<p>è€Œç†Ÿæ‚‰å®¹å™¨å’Œå®¹å™¨ç¼–æ’å†å²çš„è¯»è€…è€çˆ·åº”è¯¥çŸ¥é“, è¿™ä¹‹åå°±æ˜¯å®¹å™¨åœˆçš„ä¸€ç³»åˆ—æ”¿æ²»æ–—äº‰, å…ˆæ˜¯å¤§ä½¬ä»¬è®¤ä¸ºè¿è¡Œæ—¶æ ‡å‡†ä¸èƒ½è¢« Docker ä¸€å®¶å…¬å¸æ§åˆ¶, äºæ˜¯å°±æ’ºæ‡ç€æäº†å¼€æ”¾å®¹å™¨æ ‡å‡† OCI. Docker åˆ™æŠŠ <code>libcontainer</code> å°è£…äº†ä¸€ä¸‹, å˜æˆ runC æçŒ®å‡ºæ¥ä½œä¸º OCI çš„å‚è€ƒå®ç°.</p>
<p>å†æ¥ä¸‹æ¥å°±æ˜¯ <a href="https://github.com/rkt/rkt" target="_blank" rel="external">rkt</a> æƒ³ä» docker é‚£è¾¹åˆ†ä¸€æ¯ç¾¹, å¸Œæœ› k8s åŸç”Ÿæ”¯æŒ rkt ä½œä¸ºè¿è¡Œæ—¶, è€Œä¸” PR è¿˜çœŸçš„åˆè¿›å»äº†. ç»´æŠ¤è¿‡è¿™å—ä¸šåŠ¡åŒæ—¶æ¥ä¸¤ä¸ªéœ€æ±‚æ–¹çš„è¯»è€…è€çˆ·åº”è¯¥éƒ½çŸ¥é“ç±»ä¼¼çš„äº‹æƒ…æœ‰å¤šå‘, k8s ä¸­è´Ÿè´£ç»´æŠ¤ kubelet çš„å°ç»„ sig-node ä¹Ÿæ˜¯è¢«ç‹ ç‹ å‘äº†ä¸€æŠŠ.</p>
<p>å¤§å®¶ä¸€çœ‹è¿™ä¹ˆæå¯ä¸è¡Œ, ä»Šå¤©èƒ½æœ‰ rkt, æ˜å¤©å°±èƒ½æœ‰æ›´å¤šå¹ºè›¾å­å‡ºæ¥, è¿™ä¹ˆæä¸‹å»æˆ‘ä»¬å°ç»„ä¹Ÿä¸ç”¨å¹²æ´»äº†, æ•´å¤©æå…¼å®¹æ€§çš„ bug å°±å¤Ÿå‘›. äºæ˜¯ä¹, k8s 1.5 æ¨å‡ºäº† CRI æœºåˆ¶, å³å®¹å™¨è¿è¡Œæ—¶æ¥å£(Container Runtime Interface), k8s å‘Šè¯‰å¤§å®¶, ä½ ä»¬æƒ³åš Runtime å¯ä»¥å•Š, æˆ‘ä»¬ä¹Ÿèµ„ç“·æ¬¢è¿, å®ç°è¿™ä¸ªæ¥å£å°±æˆ, æˆåŠŸåå®¢ä¸ºä¸».</p>
<p>ä¸è¿‡ CRI æœ¬èº«åªæ˜¯ k8s æ¨çš„ä¸€ä¸ªæ ‡å‡†, å½“æ—¶çš„ k8s å°šæœªè¾¾åˆ°å¦‚ä»Šè¿™èˆ¬æ­¦æ—ç›Ÿä¸»çš„åœ°ä½, å®¹å™¨è¿è¡Œæ—¶å½“ç„¶ä¸èƒ½è¯´æˆ‘è·Ÿ k8s ç»‘æ­»äº†åªæä¾› CRI æ¥å£, äºæ˜¯å°±æœ‰äº† shim(å«ç‰‡) è¿™ä¸ªè¯´æ³•, ä¸€ä¸ª shim çš„èŒè´£å°±æ˜¯ä½œä¸º Adapter å°†å„ç§å®¹å™¨è¿è¡Œæ—¶æœ¬èº«çš„æ¥å£é€‚é…åˆ° k8s çš„ CRI æ¥å£ä¸Š.</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯ Docker è¦æ Swarm è¿›å†› PaaS å¸‚åœº, äºæ˜¯åšäº†ä¸ªæ¶æ„åˆ‡åˆ†, æŠŠå®¹å™¨æ“ä½œéƒ½ç§»åŠ¨åˆ°ä¸€ä¸ªå•ç‹¬çš„ Daemon è¿›ç¨‹ containerd ä¸­å», è®© Docker Daemon ä¸“é—¨è´Ÿè´£ä¸Šå±‚çš„å°è£…ç¼–æ’. å¯æƒœ Swarm åœ¨ k8s é¢å‰å®åœ¨æ˜¯ä¸å¤Ÿæ‰“, æƒ¨è´¥ä¹‹å Docker å…¬å¸å°±æŠŠ <a href="https://github.com/containerd/containerd" target="_blank" rel="external">containerd é¡¹ç›®</a>æç»™ CNCF ç¼©å›å»å®‰å¿ƒæ Docker ä¼ä¸šç‰ˆäº†.</p>
<p>æœ€åå°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šä¸€å¼ å›¾é‡Œçœ‹åˆ°çš„è¿™ä¸€å¨ä¸œè¥¿äº†, å°½ç®¡ç°åœ¨å·²ç»æœ‰ CRI-O, containerd-plugin è¿™æ ·æ›´ç²¾ç®€è½»é‡çš„ Runtime æ¶æ„, dockershim è¿™ä¸€å¥—ä½œä¸ºç»å—äº†æœ€å¤šç”Ÿäº§ç¯å¢ƒè€ƒéªŒçš„æ–¹æ¡ˆ, è¿„ä»Šä¸ºæ­¢ä»æ˜¯ k8s é»˜è®¤çš„ runtime å®ç°.</p>
<p>äº†è§£è¿™äº›å…·ä½“çš„æ¶æ„æœ‰æ—¶èƒ½åœ¨ debug æ—¶å€™å¸®æˆ‘ä»¬ä¸€äº›å¿™, ä½†æ›´é‡è¦çš„æ˜¯å®ƒä»¬èƒ½ä½œä¸ºä¸€ä¸ªä¾‹å­, å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£æ•´ä¸ª k8s runtime èƒŒåçš„è®¾è®¡é€»è¾‘, æˆ‘ä»¬è¿™å°±è¨€å½’æ­£ä¼ .</p>
<h2 id="OCI-CRI-ä¸è¢«æ»¥ç”¨çš„åè¯-â€œRuntimeâ€"><a href="#OCI-CRI-ä¸è¢«æ»¥ç”¨çš„åè¯-â€œRuntimeâ€" class="headerlink" title="OCI, CRI ä¸è¢«æ»¥ç”¨çš„åè¯ â€œRuntimeâ€"></a>OCI, CRI ä¸è¢«æ»¥ç”¨çš„åè¯ â€œRuntimeâ€</h2><p>OCI, ä¹Ÿå°±æ˜¯å‰æ–‡æåˆ°çš„â€å¼€æ”¾å®¹å™¨æ ‡å‡†â€å…¶å®å°±æ˜¯ä¸€å¨æ–‡æ¡£, å…¶ä¸­ä¸»è¦è§„å®šäº†ä¸¤ç‚¹:</p>
<ol>
<li>å®¹å™¨é•œåƒè¦é•¿å•¥æ ·, å³ <a href="https://github.com/opencontainers/image-spec" target="_blank" rel="external">ImageSpec</a>. é‡Œé¢çš„å¤§è‡´è§„å®šå°±æ˜¯ä½ è¿™ä¸ªä¸œè¥¿éœ€è¦æ˜¯ä¸€ä¸ªå‹ç¼©äº†çš„æ–‡ä»¶å¤¹, æ–‡ä»¶å¤¹é‡Œä»¥ xxx ç»“æ„æ”¾ xxx æ–‡ä»¶;</li>
<li>å®¹å™¨è¦éœ€è¦èƒ½æ¥æ”¶å“ªäº›æŒ‡ä»¤, è¿™äº›æŒ‡ä»¤çš„è¡Œä¸ºæ˜¯ä»€ä¹ˆ, å³ <a href="https://github.com/opencontainers/runtime-spec" target="_blank" rel="external">RuntimeSpec</a>. è¿™é‡Œé¢çš„å¤§è‡´å†…å®¹å°±æ˜¯â€å®¹å™¨â€è¦èƒ½å¤Ÿæ‰§è¡Œ â€œcreateâ€, â€œstartâ€, â€œstopâ€, â€œdeleteâ€ è¿™äº›å‘½ä»¤, å¹¶ä¸”è¡Œä¸ºè¦è§„èŒƒ.</li>
</ol>
<p><a href="https://github.com/opencontainers/runc" target="_blank" rel="external">runC</a> ä¸ºå•¥å«å‚è€ƒå®ç°å‘¢, å°±æ˜¯å®ƒèƒ½æŒ‰ç…§æ ‡å‡†å°†ç¬¦åˆæ ‡å‡†çš„å®¹å™¨é•œåƒè¿è¡Œèµ·æ¥(å½“ç„¶, è¿™é‡Œä¸ºäº†æ˜“è¯»æ€§ç•¥å»äº†å¾ˆå¤šç»†èŠ‚, è¦äº†è§£è¯¦æƒ…å»ºè®®ç‚¹å‰æ–‡çš„é“¾æ¥è¯»æ–‡æ¡£)</p>
<p>æ ‡å‡†çš„å¥½å¤„å°±æ˜¯æ–¹ä¾¿æåˆ›æ–°, åæ­£åªè¦æˆ‘ç¬¦åˆæ ‡å‡†, ç”Ÿæ€åœˆé‡Œçš„å…¶å®ƒå·¥å…·éƒ½èƒ½å’Œæˆ‘ä¸€èµ·æ„‰å¿«åœ°å·¥ä½œ(â€¦å½“ç„¶ OCI è¿™ä¸ªæ ‡å‡†æœ¬èº«åˆ¶è®¢å¾—ä¸æ€ä¹ˆæ ·, çœŸæ­£å·¥ç¨‹ä¸Šè¿˜æ˜¯è¦åšä¸€äº› adapter çš„), é‚£æˆ‘çš„é•œåƒå°±å¯ä»¥ç”¨ä»»æ„çš„å·¥å…·å»æ„å»º, æˆ‘çš„â€å®¹å™¨â€å°±ä¸ä¸€å®šéè¦ç”¨ namespace å’Œ cgroups æ¥åšéš”ç¦». è¿™å°±è®©å„ç§è™šæ‹ŸåŒ–å®¹å™¨å¯ä»¥æ›´å¥½åœ°å‚ä¸åˆ°æ¸¸æˆå½“ä¸­, æˆ‘ä»¬æš‚ä¸”ä¸è¡¨.</p>
<p>è€Œ CRI æ›´ç®€å•, å•çº¯æ˜¯ä¸€ç»„ gRPC æ¥å£, æ‰«ä¸€çœ¼ <a href="https://github.com/kubernetes/kubernetes/blob/8327e433590f9e867b1e31a4dc32316685695729/pkg/kubelet/apis/cri/services.go" target="_blank" rel="external">kubelet/apis/cri/services.go</a> å°±èƒ½å½’çº³å‡ºå‡ å¥—æ ¸å¿ƒæ¥å£:</p>
<ul>
<li>ä¸€å¥—é’ˆå¯¹å®¹å™¨æ“ä½œçš„æ¥å£, åŒ…æ‹¬åˆ›å»º,å¯åœå®¹å™¨ç­‰ç­‰;</li>
<li>ä¸€å¥—é’ˆå¯¹é•œåƒæ“ä½œçš„æ¥å£, åŒ…æ‹¬æ‹‰å–é•œåƒåˆ é™¤é•œåƒç­‰;</li>
<li>è¿˜æœ‰ä¸€å¥—é’ˆå¯¹ PodSandbox (å®¹å™¨æ²™ç®±ç¯å¢ƒ) çš„æ“ä½œæ¥å£, æˆ‘ä»¬ä¹‹åå†è¯´;</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¾ˆå¤šç¬¦åˆ OCI æ ‡å‡†æˆ–å…¼å®¹äº† CRI æ¥å£çš„é¡¹ç›®, è€Œè¿™äº›é¡¹ç›®å°±å¤§ä½“æ„æˆäº†æ•´ä¸ª Kuberentes çš„ Runtime ç”Ÿæ€:</p>
<ul>
<li>OCI Compatible: <a href="https://github.com/opencontainers/runc" target="_blank" rel="external">runC</a>, <a href="https://github.com/kata-containers/kata-containers" target="_blank" rel="external">Kata</a>(ä»¥åŠå®ƒçš„å‰èº« <a href="https://github.com/hyperhq/runv" target="_blank" rel="external">runV</a> å’Œ <a href="https://github.com/clearcontainers/runtime" target="_blank" rel="external">Clear Containers</a>), <a href="https://github.com/google/gvisor" target="_blank" rel="external">gVisor</a>. å…¶å®ƒæ¯”è¾ƒåé—¨çš„è¿˜æœ‰ Rust å†™çš„ <a href="https://github.com/oracle/railcar" target="_blank" rel="external">railcar</a></li>
<li>CRI Compatible: Docker(å€ŸåŠ© dockershim), <a href="https://github.com/containerd/containerd" target="_blank" rel="external">containerd</a>(å€ŸåŠ© CRI-containerd), <a href="https://github.com/kubernetes-sigs/cri-o" target="_blank" rel="external">CRI-O</a>, <a href="https://github.com/kubernetes/frakti" target="_blank" rel="external">frakti</a>, etc.</li>
</ul>
<p>æœ€å¼€å§‹ k8s çš„æ—¶å€™æˆ‘ç»å¸¸å¼„ä¸æ¸… OCI å’Œ CRI çš„åŒºåˆ«ä¸è”ç³», å…¶ä¸­ä¸€å¤§åŸå› å°±æ˜¯ç¤¾åŒºé‡Œç³Ÿç³•çš„å‘½å: è¿™ä¸Šé¢çš„é¡¹ç›®ç»Ÿç»Ÿå¯ä»¥ç§°ä¸ºå®¹å™¨è¿è¡Œæ—¶(Container Runtime), å½¼æ­¤ä¹‹é—´åŒºåˆ†çš„åŠæ³•å°±æ˜¯ç»™â€å®¹å™¨è¿è¡Œæ—¶â€è¿™ä¸ªè¯åŠ ä¸Šå„ç§å®šè¯­å’Œä»å¥æ¥è¿›è¡Œä¿®é¥°. Dave Cheney æœ‰æ¡æ¨è¯´:</p>
<blockquote>
<p>Good naming is like a good joke. If you have to explain it, itâ€™s not funny.</p>
</blockquote>
<p>æ˜¾ç„¶ Container Runtime åœ¨è¿™é‡Œå°±ä¸æ˜¯ä¸€ä¸ªå¥½åå­—äº†, æˆ‘ä»¬æ¥ä¸‹æ¥æ¢æˆä¸€ä¸ªåœ¨è¿™ç¯‡æ–‡ç« çš„è¯­å¢ƒä¸­æ›´å‡†ç¡®çš„è¯´æ³•: <strong>cri-runtime</strong> å’Œ <strong>oci-runtime</strong>. é€šè¿‡è¿™ä¸ªç²—ç•¥çš„åˆ†ç±», æˆ‘ä»¬å…¶å®å¯ä»¥æ€»ç»“å‡ºæ•´ä¸ª runtime æ¶æ„ä¸‡å˜ä¸ç¦»å…¶å®—çš„ä¸‰å±‚æŠ½è±¡:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Orchestration API -&gt; Container API -&gt; Kernel API</span><br></pre></td></tr></table></figure></p>
<p>è¿™å…¶ä¸­ k8s å·²ç»æ˜¯ Orchestration API çš„äº‹å®æ ‡å‡†, è€Œåœ¨ k8s ä¸­, Container API çš„æ¥å£æ ‡å‡†å°±æ˜¯ CRI, ç”± cri-runtime å®ç°, Kernel API çš„è§„èŒƒæ˜¯ OCI, ç”± oci-runtime å®ç°.</p>
<p>æ ¹æ®è¿™ä¸ªæ€è·¯, æˆ‘ä»¬å°±å¾ˆå®¹æ˜“ç†è§£ä¸‹é¢è¿™ä¸¤ç§ä¸œè¥¿:</p>
<ul>
<li>å„ç§æ›´ä¸ºç²¾ç®€çš„ cri-runtime</li>
<li>å„ç§â€å¼ºéš”ç¦»â€å®¹å™¨æ–¹æ¡ˆ</li>
</ul>
<h2 id="containerd-å’Œ-CRI-O"><a href="#containerd-å’Œ-CRI-O" class="headerlink" title="containerd å’Œ CRI-O"></a>containerd å’Œ CRI-O</h2><p>æˆ‘ä»¬åœ¨ç¬¬ä¸€èŠ‚å°±çœ‹åˆ°ç°åœ¨çš„ runtime å®åœ¨æ˜¯æœ‰ç‚¹å¤æ‚äº†, è€Œå¤æ‚æ˜¯ä¸‡æ¶ä¹‹æº, äºæ˜¯å°±æœ‰äº†ç›´æ¥æ‹¿ containerd åš oci-runtime çš„æ–¹æ¡ˆ. å½“ç„¶, é™¤äº† k8s ä¹‹å¤–, containerd è¿˜è¦æ¥è¯¸å¦‚ Swarm ç­‰è°ƒåº¦ç³»ç»Ÿ, å› æ­¤å®ƒä¸ä¼šå»ç›´æ¥å®ç° CRI, è¿™ä¸ªé€‚é…å·¥ä½œå½“ç„¶å°±è¦äº¤ç»™ä¸€ä¸ª shim äº†.</p>
<p>containerd 1.0 ä¸­, å¯¹ CRI çš„é€‚é…é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ <code>CRI-containerd</code> æ¥å®Œæˆ:</p>
<p><img src="/images/k8s/bf52b77fly1g0ws7vtgq2j21de0cmgmo.jpg" alt="containerd 1.0"></p>
<p>containerd 1.1 ä¸­åšçš„åˆæ›´æ¼‚äº®ä¸€ç‚¹, ç æ‰äº† CRI-containerd è¿™ä¸ªè¿›ç¨‹, ç›´æ¥æŠŠé€‚é…é€»è¾‘ä½œä¸ºæ’ä»¶æ”¾è¿›äº† containerd ä¸»è¿›ç¨‹ä¸­:</p>
<p><img src="/images/k8s/bf52b77fly1g0ws87espcj21ao0d00tz.jpg" alt="containerd 1.1"></p>
<p>ä½†åœ¨ containerd åšè¿™äº›äº‹æƒ…ä¹‹æƒ…, ç¤¾åŒºå°±å·²ç»æœ‰äº†ä¸€ä¸ªæ›´ä¸ºä¸“æ³¨çš„ cri-runtime: <a href="https://github.com/kubernetes-sigs/cri-o" target="_blank" rel="external">CRI-O</a>, å®ƒéå¸¸çº¯ç²¹, å°±æ˜¯å…¼å®¹ CRI å’Œ OCI, åšä¸€ä¸ª k8s ä¸“ç”¨çš„è¿è¡Œæ—¶:</p>
<p><img src="/images/k8s/bf52b77fly1g0ws8dqqsoj21am0d0q4q.jpg" alt="CRI-O"></p>
<p>å…¶ä¸­ <code>conmon</code> å°±å¯¹åº” containerd-shim, å¤§ä½“æ„å›¾æ˜¯ä¸€æ ·çš„.</p>
<p>CRI-O å’Œ (ç›´æ¥è°ƒç”¨)containerd çš„æ–¹æ¡ˆæ¯”èµ·é»˜è®¤çš„ dockershim ç¡®å®ç®€æ´å¾ˆå¤š, ä½†æ²¡å•¥ç”Ÿäº§ç¯å¢ƒçš„éªŒè¯æ¡ˆä¾‹, æˆ‘æ‰€çŸ¥é“çš„ä»…ä»…æ˜¯ containerd åœ¨ GKE ä¸Šæ˜¯ beta çŠ¶æ€. å› æ­¤å‡å¦‚ä½ å¯¹ docker æ²¡æœ‰ç‰¹æ®Šçš„æ”¿æ²»æ¨æ„, å¤§å¯ä¸å¿…æŠŠ dockershim è¿™å¥—æ¢æ‰.</p>
<h2 id="å¼ºéš”ç¦»å®¹å™¨-Kata-gVisor-firecracker"><a href="#å¼ºéš”ç¦»å®¹å™¨-Kata-gVisor-firecracker" class="headerlink" title="å¼ºéš”ç¦»å®¹å™¨: Kata, gVisor, firecracker"></a>å¼ºéš”ç¦»å®¹å™¨: Kata, gVisor, firecracker</h2><p>ä¸€ç›´ä»¥æ¥ k8s éƒ½æœ‰ä¸€ä¸ªè¢«è¯Ÿç—…çš„ç‚¹: éš¾ä»¥å®ç°çœŸæ­£çš„å¤šç§Ÿæˆ·.</p>
<p>ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢, æˆ‘ä»¬å…ˆè€ƒè™‘ä¸€ä¸‹ä»€ä¹ˆæ ·æ˜¯ç†æƒ³çš„å¤šç§Ÿæˆ·çŠ¶æ€:</p>
<blockquote>
<p>ç†æƒ³æ¥è¯´, å¹³å°çš„å„ä¸ªç§Ÿæˆ·(tenant)ä¹‹é—´åº”è¯¥æ— æ³•æ„Ÿå—åˆ°å½¼æ­¤çš„å­˜åœ¨, è¡¨ç°å¾—å°±åƒæ¯ä¸ªç§Ÿæˆ·ç‹¬å è¿™æ•´ä¸ªå¹³å°ä¸€æ ·. å…·ä½“æ¥è¯´, æˆ‘ä¸èƒ½çœ‹åˆ°å…¶å®ƒç§Ÿæˆ·çš„èµ„æº, æˆ‘çš„èµ„æºè·‘æ»¡äº†ä¸èƒ½å½±å“å…¶å®ƒç§Ÿæˆ·çš„èµ„æºä½¿ç”¨, æˆ‘ä¹Ÿæ— æ³•ä»ç½‘ç»œæˆ–å†…æ ¸ä¸Šæ”»å‡»å…¶å®ƒç§Ÿæˆ·.</p>
</blockquote>
<p>k8s å½“ç„¶åšä¸åˆ°, å…¶ä¸­æœ€å¤§çš„ä¸¤ä¸ªåŸå› æ˜¯:</p>
<ul>
<li>kube-apiserver æ˜¯æ•´ä¸ªé›†ç¾¤ä¸­çš„å•ä¾‹, å¹¶ä¸”æ²¡æœ‰å¤šç§Ÿæˆ·æ¦‚å¿µ</li>
<li>é»˜è®¤çš„ oci-runtime æ˜¯ runC, è€Œ runC å¯åŠ¨çš„å®¹å™¨æ˜¯å…±äº«å†…æ ¸çš„</li>
</ul>
<p>å¯¹äºç¬¬äºŒä¸ªé—®é¢˜, ä¸€ä¸ªå…¸å‹çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯æä¾›ä¸€ä¸ªæ–°çš„ OCI å®ç°, ç”¨ VM æ¥è·‘å®¹å™¨, å®ç°å†…æ ¸ä¸Šçš„ç¡¬éš”ç¦». <a href="https://github.com/hyperhq/runv" target="_blank" rel="external">runV</a> å’Œ <a href="https://github.com/clearcontainers/runtime" target="_blank" rel="external">Clear Containers</a> éƒ½æ˜¯è¿™ä¸ªæ€è·¯. å› ä¸ºè¿™ä¸¤ä¸ªé¡¹ç›®åšå¾—äº‹æƒ…æ˜¯å¾ˆç±»ä¼¼, åæ¥å°±åˆå¹¶æˆäº†ä¸€ä¸ªé¡¹ç›® <a href="https://github.com/kata-containers/kata-containers" target="_blank" rel="external">Kata Container</a>. Kata çš„ä¸€å¼ å›¾å¾ˆå¥½åœ°è§£é‡Šäº†åŸºäºè™šæ‹Ÿæœºçš„å®¹å™¨ä¸åŸºäº namespaces å’Œ cgroups çš„å®¹å™¨é—´çš„åŒºåˆ«:</p>
<p><img src="/images/k8s/bf52b77fly1g0wnfdxo9fj20hs0anmyb.jpg" alt="Kata Container"></p>
<blockquote>
<p>å½“ç„¶, æ²¡æœ‰ç³»ç»Ÿæ˜¯å®Œå…¨å®‰å…¨çš„, å‡å¦‚ hypervisor å­˜åœ¨æ¼æ´, é‚£ä¹ˆç”¨æˆ·ä»æœ‰å¯èƒ½æ”»ç ´éš”ç¦». ä½†æ‰€æœ‰çš„äº‹æƒ…éƒ½è¦å¯¹æ¯”è€Œè¨€, åœ¨å…±äº«å†…æ ¸çš„æƒ…å†µä¸‹, æš´éœ²çš„æ”»å‡»é¢æ˜¯éå¸¸å¤§çš„, åšå®‰å…¨éš”ç¦»çš„éš¾åº¦å°±åƒåœ¨ç¾åˆ©åšå’Œå¢¨è¥¿å“¥ä¹‹é—´ä¿® The Great Wall, è€Œå½“å†…æ ¸éš”ç¦»ä¹‹å, åªè¦å®ˆä½ hypervisor è¿™é“å…³å­å°±åé¡¾æ— è™äº†</p>
</blockquote>
<p>å—¯, ä¸€ä¸ª VM é‡Œè·‘ä¸€ä¸ªå®¹å™¨, å¬ä¸Šå»éš”ç¦»æ€§å¾ˆä¸é”™, ä½†ä¸æ˜¯è¯´è™šæ‹Ÿæœºåˆç¬¨é‡åˆä¸å¥½ç®¡ç†æ‰åˆ‡æ¢åˆ°å®¹å™¨çš„å—, æ€ä¹ˆåˆè¦èµ°å›å»äº†?</p>
<p>Kata å‘Šè¯‰ä½ , è™šæ‹Ÿæœºæ²¡é‚£ä¹ˆé‚ªæ¶, åªæ˜¯ä»¥å‰æ²¡ç©å¥½:</p>
<ul>
<li><strong>ä¸å¥½ç®¡ç†</strong>æ˜¯å› ä¸ºæ²¡æœ‰éµå¾ªâ€ä¸å¯å˜åŸºç¡€è®¾æ–½â€, å¤§å®¶éƒ½å»è™šæ‹Ÿæœºä¸Šè¿™æ‘¸æ‘¸é‚£ç¢°ç¢°, è¿™å°è£… Java 8 é‚£å°è£… Java 6, Admin æ˜¯è¦ angry çš„. Kata åˆ™æ”¯æŒ OCI é•œåƒ, å®Œå…¨å¯ä»¥ç”¨ä¸Š Dockerfile + é•œåƒ, è®©ä¸å¥½ç®¡ç†æˆä¸ºäº†è¿‡å»æ—¶;</li>
<li><strong>ç¬¨é‡</strong>æ˜¯å› ä¸ºä¹‹å‰è¦è™šæ‹ŸåŒ–æ•´ä¸ªç³»ç»Ÿ, ç°åœ¨æˆ‘ä»¬åªç€çœ¼äºè™šæ‹ŸåŒ–åº”ç”¨, é‚£å°±å¯ä»¥è£å‰ªæ‰å¾ˆå¤šåŠŸèƒ½, æŠŠ VM åšå¾—å¾ˆè½»é‡, å› æ­¤å³ä¾¿ç”¨è™šæ‹Ÿæœºæ¥åšå®¹å™¨, Kata è¿˜æ˜¯å¯ä»¥å°†å®¹å™¨å¯åŠ¨æ—¶é—´å‹ç¼©å¾—éå¸¸çŸ­, å¯åŠ¨ååœ¨å†…å­˜ä¸Šå’ŒIO ä¸Šçš„ overhead ä¹Ÿå°½å¯èƒ½å»ä¼˜åŒ–;</li>
</ul>
<p>ä¸è¿‡è¯è¯´å›æ¥, k8s ä¸Šçš„è°ƒåº¦å•ä½æ˜¯ Pod, æ˜¯å®¹å™¨ç»„å•Š, Kata è¿™æ ·ä¸€ä¸ªè™šæ‹Ÿæœºé‡Œä¸€ä¸ªå®¹å™¨, åŒä¸€ä¸ª Pod é—´çš„å®¹å™¨è¿˜æ€ä¹ˆåš namespace çš„å…±äº«?</p>
<p>è¿™å°±è¦è¯´å›æˆ‘ä»¬å‰é¢è®²åˆ°çš„ CRI ä¸­é’ˆå¯¹ PodSandbox (å®¹å™¨æ²™ç®±ç¯å¢ƒ) çš„æ“ä½œæ¥å£äº†. ç¬¬ä¸€èŠ‚ä¸­, æˆ‘ä»¬åˆ»æ„ç®€åŒ–äº†åœºæ™¯, åªè€ƒè™‘åˆ›å»ºä¸€ä¸ª<strong>å®¹å™¨</strong>, è€Œæ²¡æœ‰è®¨è®ºåˆ›å»ºä¸€ä¸ª<strong>Pod</strong>. å¤§å®¶éƒ½çŸ¥é“, çœŸæ­£å¯åŠ¨ Pod é‡Œå®šä¹‰çš„å®¹å™¨ä¹‹å‰, kubelet ä¼šå…ˆå¯åŠ¨ä¸€ä¸ª infra å®¹å™¨, å¹¶æ‰§è¡Œ /pause è®© infra å®¹å™¨çš„ä¸»è¿›ç¨‹æ°¸è¿œæŒ‚èµ·. è¿™ä¸ªå®¹å™¨å­˜åœ¨çš„ç›®çš„å°±æ˜¯ç»´æŒä½æ•´ä¸ª pod çš„å„ç§ namespace, çœŸæ­£çš„ä¸šåŠ¡å®¹å™¨åªè¦åŠ å…¥ infra å®¹å™¨çš„ network ç­‰ namespace å°±èƒ½å®ç°å¯¹åº” namespace çš„å…±äº«. è€Œ infra å®¹å™¨åˆ›é€ çš„è¿™ä¸ªå…±äº«ç¯å¢ƒåˆ™è¢«æŠ½è±¡ä¸º <strong>PodSandbox</strong>. æ¯æ¬¡ kubelet åœ¨åˆ›å»º Pod æ—¶, å°±ä¼šå…ˆè°ƒç”¨ CRI çš„ <code>RunPodSandbox</code> æ¥å£å¯åŠ¨ä¸€ä¸ªæ²™ç®±ç¯å¢ƒ, å†è°ƒç”¨ <code>CreateContainer</code> åœ¨æ²™ç®±ä¸­åˆ›å»ºå®¹å™¨.</p>
<p>è¿™é‡Œå°±å·²ç»è¯´å‡ºç­”æ¡ˆäº†, å¯¹äº <strong>Kata Container</strong> è€Œè¨€, åªè¦åœ¨ <code>RunPodSandbox</code> è°ƒç”¨ä¸­åˆ›å»ºä¸€ä¸ª VM, ä¹‹åå†å¾€ VM ä¸­æ·»åŠ å®¹å™¨å°±å¯ä»¥äº†. æœ€åè¿è¡Œ Pod çš„æ ·å­å°±æ˜¯è¿™æ ·çš„:</p>
<p><img src="/images/k8s/bf52b77fly1g0ws90i7ttj21mq0d440r.jpg" alt="Kata Container"></p>
<p>è¯´å®Œäº† Kata, å…¶å® gVisor å’Œ firecracker éƒ½ä¸è¨€è‡ªæ˜äº†, å¤§ä½“ä¸Šéƒ½æ˜¯ç±»ä¼¼çš„, åªæ˜¯:</p>
<ul>
<li><a href="https://github.com/google/gvisor" target="_blank" rel="external">gVisor</a> å¹¶ä¸ä¼šå»åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ VM, è€Œæ˜¯å®ç°äº†ä¸€ä¸ªå« â€œSentryâ€ çš„ç”¨æˆ·æ€è¿›ç¨‹æ¥å¤„ç†å®¹å™¨çš„ syscall, è€Œæ‹¦æˆª syscall å¹¶é‡å®šå‘åˆ° Sentry çš„è¿‡ç¨‹åˆ™ç”± KVM æˆ– ptrace å®ç°.</li>
<li><a href="https://github.com/firecracker-microvm/firecracker" target="_blank" rel="external">firecracker</a> ç§°è‡ªå·±ä¸º microVM, å³è½»é‡çº§è™šæ‹Ÿæœº, å®ƒæœ¬èº«è¿˜æ˜¯åŸºäº KVM çš„, ä¸è¿‡ KVM é€šå¸¸ä½¿ç”¨ QEMU æ¥è™šæ‹ŸåŒ–é™¤CPUå’Œå†…å­˜å¤–çš„èµ„æº, æ¯”å¦‚IOè®¾å¤‡,ç½‘ç»œè®¾å¤‡. firecracker åˆ™ä½¿ç”¨ rust å®ç°äº†æœ€ç²¾ç®€çš„è®¾å¤‡è™šæ‹ŸåŒ–, ä¸ºçš„å°±æ˜¯å‹æ¦¨è™šæ‹ŸåŒ–çš„å¼€é”€, è¶Šè½»é‡è¶Šå¥½.</li>
</ul>
<h2 id="å®‰å…¨å®¹å™¨ä¸-Serverless"><a href="#å®‰å…¨å®¹å™¨ä¸-Serverless" class="headerlink" title="å®‰å…¨å®¹å™¨ä¸ Serverless"></a>å®‰å…¨å®¹å™¨ä¸ Serverless</h2><p>ä½ å¯èƒ½è§‰å¾—å®‰å…¨å®¹å™¨å¯¹è‡ªå·±è€Œè¨€æ²¡ä»€ä¹ˆç”¨: å¤§ä¸äº†æˆ‘ç»™æ¯ä¸ªäº§å“çº¿éƒ½éƒ¨ç½² k8s, æœºå™¨æ± ä¹Ÿéƒ½éš”ç¦»æ‰, ä»åŸºç¡€è®¾æ–½çš„å±‚é¢å°±éš”ç¦»æ‰å˜›.</p>
<p>è¿™ä¹ˆåšå½“ç„¶å¯ä»¥, ä½†åŒæ—¶ä¹Ÿè¦çŸ¥é“, è¿™ç§åšæ³•æœ€ç»ˆå…¶å®æ˜¯ä»¥ IaaS çš„æ–¹å¼åœ¨å–èµ„æº, æ˜¯åšä¸äº†çœŸæ­£çš„ PaaS ä¹ƒè‡³ Serverless çš„.</p>
<p>Serverless è¦åšåˆ°æ‰€æœ‰çš„ç”¨æˆ·å®¹å™¨æˆ–å‡½æ•°æŒ‰éœ€ä½¿ç”¨è®¡ç®—èµ„æº, é‚£å¿…é¡»æ»¡è¶³ä¸¤ç‚¹:</p>
<ul>
<li><strong>å¤šç§Ÿæˆ·å¼ºéš”ç¦»</strong>: ç”¨æˆ·çš„å®¹å™¨æˆ–å‡½æ•°éƒ½æ˜¯æŒ‰éœ€å¯åŠ¨æŒ‰ç§’è®¡è´¹, æˆ‘ä»¬å¯ä¸èƒ½ç»™æ¯ä¸ªç”¨æˆ·é¢„å…ˆåˆ†é…ä¸€å¨éš”ç¦»çš„èµ„æº,å› æ­¤æˆ‘ä»¬è¦ä¿è¯æ•´ä¸ª Platform æ˜¯å¤šç§Ÿæˆ·å¼ºéš”ç¦»çš„;</li>
<li><strong>æåº¦è½»é‡</strong>: Serverless çš„ç¬¬ä¸€ä¸ªç‰¹ç‚¹æ˜¯è¿è¡Œæ—¶æ²™ç®±ä¼šæ›´é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯, ç¬¬äºŒä¸ªç‰¹ç‚¹æ˜¯åˆ‡åˆ†çš„ç²’åº¦ä¼šéå¸¸éå¸¸ç»†, ç»†ä¸­ç»†å°±æ˜¯ FaaS, ä¸€ä¸ªå‡½æ•°å°±è¦ä¸€ä¸ªæ²™ç®±. å› æ­¤å°±è¦æ±‚ä¸¤ç‚¹: <pre><code>1. æ²™ç®±å¯åŠ¨åˆ é™¤å¿…é¡»é£å¿«; 
2. æ²™ç®±å ç”¨çš„èµ„æºè¶Šå°‘è¶Šå¥½. 
</code></pre>è¿™ä¸¤ç‚¹åœ¨ long-running, ç²’åº¦ä¸å¤§çš„å®¹å™¨è¿è¡Œç¯å¢ƒä¸‹å¯èƒ½ä¸æ˜æ˜¾, ä½†åœ¨ Serverless ç¯å¢ƒä¸‹å°±ä¼šæ€¥å‰§è¢«æ”¾å¤§. è¿™æ—¶å€™å»åšMicroVM çš„ ROI å°±æ¯”ä»¥å‰è¦é«˜å¾ˆå¤š. æƒ³æƒ³, ç”¨ä¼ ç»Ÿçš„ KVM å»è·‘ FaaS, é‚£è¿˜ä¸å¾—äºåˆ°å§¥å§¥å®¶äº†?</li>
</ul>
<h2 id="ç»“å°¾"><a href="#ç»“å°¾" class="headerlink" title="ç»“å°¾"></a>ç»“å°¾</h2><p>è¿™æ¬¡çš„å†…å®¹æ˜¯è¶Šå†™è¶Šå¤š, æ„Ÿè§‰æ€ä¹ˆéƒ½å†™ä¸å®Œçš„æ ·å­, rkt, lxd å…¶å®éƒ½è¿˜æ²¡æ¶‰åŠ, è¿™é‡Œå°±æä¾›ä¸‹ç±»æ¯”, å¤§å®¶å¯ä»¥è‡ªè¡Œåšæ‹“å±•é˜…è¯»: rkt è·Ÿ docker ä¸€æ ·æ˜¯ä¸€ä¸ªå®¹å™¨å¼•æ“, ç‰¹ç‚¹æ˜¯æ—  daemon, ç›®å‰é¡¹ç›®åŸºæœ¬ä¸æ´»è·ƒäº†; lxc æ˜¯ docker æœ€æ—©ä½¿ç”¨çš„å®¹å™¨å·¥å…·é›†, ä½ç½®å¯ä»¥ç±»æ¯” runc, æä¾›è·Ÿ kernel æ‰“äº¤é“çš„åº“&amp;å‘½ä»¤è¡Œå·¥å…·, lxd åˆ™æ˜¯åŸºäº lxc çš„ä¸€ä¸ªå®¹å™¨å¼•æ“, åªä¸è¿‡å¤§å¤šæ•°å®¹å™¨å¼•æ“çš„ç›®æ ‡æ˜¯å®¹å™¨åŒ–åº”ç”¨, lxd çš„ç›®æ ‡åˆ™æ˜¯å®¹å™¨åŒ–æ“ä½œç³»ç»Ÿ.</p>
<p>æ¥æºï¼šaleiwu.com</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[å¦‚ä½•åœ¨çº¿å…³é—­ä¸€ä¸ªtcp socketè¿æ¥]]></title>
      <url>http://team.jiunile.com/blog/2019/05/k8s-online-close-tcp-socket.html</url>
      <content type="html"><![CDATA[<p>ä½ å¯èƒ½ä¼šè¯´ï¼Œç®€å•ï¼Œ<code>netstat -antp</code>æ‰¾åˆ°è¿æ¥ï¼Œ<code>kill</code>æ‰è¿™ä¸ªè¿›ç¨‹å°±è¡Œäº†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># netstat -antp|grep 6789</span></span><br><span class="line">tcp        0      0 1.1.1.1:59950      1.1.1.2:6789        ESTABLISHED 45059/ceph-fuse</span><br><span class="line"><span class="comment"># kill 45059</span></span><br></pre></td></tr></table></figure>
<p>è¿æ¥ç¡®å®å…³æ‰äº†ï¼Œè¿›ç¨‹ä¹Ÿè·Ÿç€ä¸€èµ·æ€æ­»äº†ã€‚è¾¾ä¸åˆ°â€œåœ¨çº¿â€çš„è¦æ±‚ã€‚</p>
<p>æœ‰æ²¡æœ‰åŠæ³•ä¸æ€æ­»è¿›ç¨‹ï¼Œä½†è¿˜æ˜¯å¯ä»¥å…³é—­socketè¿æ¥å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ç¼–ç çš„æ—¶å€™ï¼Œè¦å…³é—­ä¸€ä¸ªsocketï¼Œåªè¦è°ƒç”¨ close å‡½æ•°å°±å¯ä»¥äº†ï¼Œä½†æ˜¯è¿›ç¨‹åœ¨è¿è¡Œç€å‘¢ï¼Œæ€ä¹ˆè®©å®ƒè°ƒç”¨ close å‘¢ï¼Ÿ<br><a id="more"></a></p>
<p>åœ¨<a href="https://superuser.com/" target="_blank" rel="external">superuser</a>ä¸Šçœ‹åˆ°ä¸€ä¸ªå¾ˆæ£’çš„æ–¹æ³•ï¼ŒåŸç†å°±æ˜¯ <code>gdb attach</code> åˆ°è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œç„¶å <code>call close($fd)</code>ã€‚</p>
<p>1ã€ ä½¿ç”¨ <code>netstat</code> æ‰¾åˆ°è¿›ç¨‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># netstat -antp|grep 6789</span></span><br><span class="line">tcp        0      0 1.1.1.1:59950      1.1.1.2:6789        ESTABLISHED 45059/ceph-fuse</span><br></pre></td></tr></table></figure></p>
<p>å¦‚ä¸Šï¼Œè¿›ç¨‹pidä¸º45059ã€‚</p>
<p>2ã€ ä½¿ç”¨ lsof æ‰¾åˆ°è¿›ç¨‹45059æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶æ‰¾åˆ°å¯¹åº”çš„socketè¿æ¥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lsof -np 45059</span><br><span class="line">COMMAND     PID USER   FD   TYPE             DEVICE SIZE/OFF       NODE NAME</span><br><span class="line">ceph-fuse 45059 root  rtd    DIR                8,2     4096          2 /</span><br><span class="line">ceph-fuse 45059 root  txt    REG                8,2  6694144    1455967 /usr/bin/ceph-fuse</span><br><span class="line">ceph-fuse 45059 root  mem    REG                8,2   510416    2102312 /usr/lib64/libfreeblpriv3.so</span><br><span class="line">...</span><br><span class="line">ceph-fuse 45059 root   12u  IPv4         1377072656      0t0        TCP 1.1.1.1:59950-&gt;1.1.1.2:smc-https (ESTABLISHED)</span><br></pre></td></tr></table></figure></p>
<p>å…¶ä¸­ <code>12u</code> å°±æ˜¯ä¸Šé¢å¯¹åº”socketè¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p>3ã€ gdb è¿æ¥åˆ°è¿›ç¨‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb -p 45059</span><br></pre></td></tr></table></figure></p>
<p>4ã€ å…³é—­socketè¿æ¥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) call close(12u)</span><br></pre></td></tr></table></figure></p>
<p>socketè¿æ¥å°±å¯ä»¥å…³é—­äº†ï¼Œä½†æ˜¯è¿›ç¨‹ 45059 è¿˜æ˜¯å¥½å¥½ç€çš„ã€‚</p>
<p>ä½ å¯èƒ½ä¼šé—®ï¼Œä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°è¿™ä¸ªç‰¹æ€§å‘¢ï¼Ÿåœºæ™¯è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œæ¯”å¦‚ä½ æƒ³æµ‹è¯•ä¸‹åº”ç”¨æ˜¯å¦ä¼šè‡ªåŠ¨é‡è¿mysqlï¼Œé€šè¿‡è¿™ä¸ªåŠæ³•å°±å¯ä»¥æ¯”è¾ƒæ–¹ä¾¿çš„æµ‹è¯•äº†ã€‚</p>
<p>Ref:</p>
<ul>
<li><a href="https://superuser.com/questions/127863/manually-closing-a-port-from-commandline" target="_blank" rel="external">Manually closing a port from commandline</a></li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[kuberenetes å‡çº§åæ–°åŠ å…¥èŠ‚ç‚¹æŠ¥é”™]]></title>
      <url>http://team.jiunile.com/blog/2019/05/k8s-kubeadm-up-node-join-failed.html</url>
      <content type="html"><![CDATA[<h2 id="é—®é¢˜ç®€è¿°"><a href="#é—®é¢˜ç®€è¿°" class="headerlink" title="é—®é¢˜ç®€è¿°"></a>é—®é¢˜ç®€è¿°</h2><blockquote>
<p>åŸæœ¬ç”¨<code>kubeadm</code>å®‰è£…çš„çš„kubernetes 1.11.xé›†ç¾¤å‡çº§åˆ°1.12.x åï¼ˆä½¿ç”¨<code>kubeadm upgrade</code>å‡çº§ï¼‰å‘ç°æ— æ³•å°†æ–°çš„nodeåŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œä¼šå‡ºç°ä»¥ä¸‹æŠ¥é”™ä¿¡æ¯</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[preflight] running pre-flight checks</span><br><span class="line">    [WARNING RequiredIPVSKernelModulesAvailable]: the IPVS proxier will not be used, because the following required kernel modules are not loaded: [ip_vs_sh ip_vs ip_vs_rr ip_vs_wrr] or no <span class="built_in">builtin</span> kernel ipvs support: map[ip_vs_rr:&#123;&#125; ip_vs_wrr:&#123;&#125; ip_vs_sh:&#123;&#125; nf_conntrack_ipv4:&#123;&#125; ip_vs:&#123;&#125;]</span><br><span class="line">you can solve this problem with following methods:</span><br><span class="line"> 1. Run <span class="string">'modprobe -- '</span> to load missing kernel modules;</span><br><span class="line">2. Provide the missing <span class="built_in">builtin</span> kernel ipvs support</span><br><span class="line"></span><br><span class="line">[discovery] Trying to connect to API Server <span class="string">"172.19.170.254:6443"</span></span><br><span class="line">[discovery] Created cluster-info discovery client, requesting info from <span class="string">"https://172.19.170.254:6443"</span></span><br><span class="line">[discovery] Requesting info from <span class="string">"https://172.19.170.254:6443"</span> again to validate TLS against the pinned public key</span><br><span class="line">[discovery] Cluster info signature and contents are valid and TLS certificate validates against pinned roots, will use API Server <span class="string">"172.19.170.254:6443"</span></span><br><span class="line">[discovery] Successfully established connection with API Server <span class="string">"172.19.170.254:6443"</span></span><br><span class="line">[kubelet] Downloading configuration <span class="keyword">for</span> the kubelet from the <span class="string">"kubelet-config-1.12"</span> ConfigMap <span class="keyword">in</span> the kube-system namespace</span><br><span class="line">configmaps <span class="string">"kubelet-config-1.12"</span> is forbidden: User <span class="string">"system:bootstrap:y1zgt7"</span> cannot get configmaps <span class="keyword">in</span> the namespace <span class="string">"kube-system"</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="ä¿®å¤æ–¹æ³•"><a href="#ä¿®å¤æ–¹æ³•" class="headerlink" title="ä¿®å¤æ–¹æ³•"></a>ä¿®å¤æ–¹æ³•</h2><blockquote>
<p>åœ¨masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œæ­¥éª¤1-4ï¼Œåœ¨ä»èŠ‚ç‚¹ï¼ˆå°†è¦åŠ å…¥é›†ç¾¤çš„æœºå™¨ï¼‰ä¸Šæ‰§è¡Œæ­¥éª¤5</p>
</blockquote>
<h3 id="æ­¥éª¤ä¸€"><a href="#æ­¥éª¤ä¸€" class="headerlink" title="æ­¥éª¤ä¸€"></a>æ­¥éª¤ä¸€</h3><p><strong>ä»ç°æœ‰çš„â€ConfigMap kubelet-config-1.11â€ åˆ›å»ºä¸€ä¸ªæ–°çš„ConfigMap â€œkubelet-config-1.12â€</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get cm --all-namespaces</span><br><span class="line">$ kubectl -n kube-system get cm kubelet-config-1.11 -o yaml --export &gt; kubelet-config-1.12-cm.yaml</span><br><span class="line">$ vim kubelet-config-1.12-cm.yaml       <span class="comment">#modify at the bottom:</span></span><br><span class="line">                                        <span class="comment">#name: kubelet-config-1.12</span></span><br><span class="line">                                        <span class="comment">#delete selfLink</span></span><br><span class="line">$ kubectl -n kube-system create <span class="_">-f</span> kubelet-config-1.12-cm.yaml</span><br></pre></td></tr></table></figure>
<h3 id="æ­¥éª¤äºŒï¼šè·å–ä»¤ç‰Œå‰ç¼€"><a href="#æ­¥éª¤äºŒï¼šè·å–ä»¤ç‰Œå‰ç¼€" class="headerlink" title="æ­¥éª¤äºŒï¼šè·å–ä»¤ç‰Œå‰ç¼€"></a>æ­¥éª¤äºŒï¼šè·å–ä»¤ç‰Œå‰ç¼€</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm token list           <span class="comment">#if no output, then create a token:</span></span><br><span class="line">$ kubeadm token create</span><br><span class="line">TOKEN                       ...     ...</span><br><span class="line">a0b1c2.svn4my9ifft4zxgg     ...     ...</span><br><span class="line"><span class="comment"># Token prefix is "a0b1c2"</span></span><br></pre></td></tr></table></figure>
<h3 id="æ­¥éª¤ä¸‰"><a href="#æ­¥éª¤ä¸‰" class="headerlink" title="æ­¥éª¤ä¸‰"></a>æ­¥éª¤ä¸‰</h3><p><strong>ä»ç°æœ‰è§’è‰²â€œkubeadmï¼škubelet-config-1.11â€åˆ›å»ºä¸€ä¸ªæ–°è§’è‰²â€œkubeadmï¼škubelet-config-1.12â€</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get roles --all-namespaces</span><br><span class="line">$ kubectl -n kube-system get role kubeadm:kubelet-config-1.11 -o yaml &gt; kubeadm:kubelet-config-1.12-role.yaml</span><br><span class="line">$ vim kubeadm\:kubelet-config-1.12-role.yaml    <span class="comment">#modify the following:</span></span><br><span class="line">                                                <span class="comment">#name: kubeadm:kubelet-config-1.12</span></span><br><span class="line">                                                <span class="comment">#resourceNames: kubelet-config-1.12</span></span><br><span class="line">                                                <span class="comment">#delete creationTimestamp, resourceVersion, selfLink, uid (because --export option is not supported)    </span></span><br><span class="line">$ kubectl -n kube-system create <span class="_">-f</span> kubeadm\:kubelet-config-1.12-role.yaml</span><br></pre></td></tr></table></figure>
<h3 id="æ­¥éª¤å››"><a href="#æ­¥éª¤å››" class="headerlink" title="æ­¥éª¤å››"></a>æ­¥éª¤å››</h3><p><strong>ä»ç°æœ‰è§’è‰²ç»‘å®š â€œkubeadmï¼škubelet-config-1.11â€ åˆ›å»ºä¸€ä¸ªæ–°è§’è‰²ç»‘å®š â€œkubeadmï¼škubelet-config-1.12â€ </strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get rolebindings --all-namespaces</span><br><span class="line">$ kubectl -n kube-system get rolebinding kubeadm:kubelet-config-1.11 -o yaml &gt; kubeadm:kubelet-config-1.12-rolebinding.yaml</span><br><span class="line">$ vim kubeadm\:kubelet-config-1.12-rolebinding.yaml     <span class="comment">#modify the following:</span></span><br><span class="line">                                                            <span class="comment">#metadata/name: kubeadm:kubelet-config-1.12</span></span><br><span class="line">                                                            <span class="comment">#roleRef/name: kubeadm:kubelet-config-1.12</span></span><br><span class="line">                                                            <span class="comment">#delete creationTimestamp, resourceVersion, selfLink, uid (because --export option is not supported)</span></span><br><span class="line">- apiGroup: rbac.authorization.k8s.io                       <span class="comment">#add these 3 lines as another group in "subjects:" at the bottom, with the 6 character token prefix from STEP 2</span></span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:bootstrap:a0b1c2 </span><br><span class="line">$ kubectl -n kube-system create <span class="_">-f</span> kubeadm\:kubelet-config-1.12-rolebinding.yaml</span><br></pre></td></tr></table></figure>
<h3 id="æ­¥éª¤5ï¼šä»å·¥ä½œèŠ‚ç‚¹å¯åŠ¨kubeadm-join"><a href="#æ­¥éª¤5ï¼šä»å·¥ä½œèŠ‚ç‚¹å¯åŠ¨kubeadm-join" class="headerlink" title="æ­¥éª¤5ï¼šä»å·¥ä½œèŠ‚ç‚¹å¯åŠ¨kubeadm join"></a>æ­¥éª¤5ï¼šä»å·¥ä½œèŠ‚ç‚¹å¯åŠ¨kubeadm join</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo kubeadm join --token &lt;token&gt; &lt;master-IP&gt;:6443 --discovery-token-ca-cert-hash sha256:&lt;key-value&gt; </span><br><span class="line"><span class="comment"># If you receive 2 ERRORS, run kubeadm join again with the following options:</span></span><br><span class="line">$ sudo kubeadm join --token &lt;token&gt; &lt;master-IP&gt;:6443 --discovery-token-ca-cert-hash sha256:&lt;key-value&gt; --ignore-preflight-errors=FileAvailable--etc-kubernetes-bootstrap-kubelet.conf,FileAvailable--etc-kubernetes-pki-ca.crt</span><br></pre></td></tr></table></figure>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Kubeadm1.14 è¯ä¹¦è°ƒæ•´]]></title>
      <url>http://team.jiunile.com/blog/2019/05/k8s-kubeadm14-ca-upgrade.html</url>
      <content type="html"><![CDATA[<blockquote>
<p>kubeadméƒ¨ç½²çš„kubernetsè¯ä¹¦ä¸€ç›´éƒ½æ˜¯ä¸ªè¯Ÿç—…ï¼Œé»˜è®¤éƒ½åªæœ‰ä¸€å¹´æœ‰æ•ˆæœŸï¼Œkubeadm 1.14.xå®‰è£…åæœ‰éƒ¨åˆ†è¯ä¹¦è¿˜æ˜¯ä¸€å¹´æœ‰æ•ˆæœŸï¼Œä½†ä¸ªåˆ«è¯ä¹¦å·²ä¿®æ”¹ä¸º10å¹´æœ‰æ•ˆæœŸï¼Œä½†å¯¹æˆ‘ä»¬ä½¿ç”¨æ¥è¯´ï¼Œä¸€å¹´æœ‰æ•ˆæœŸè¿˜æ˜¯ä¸€ä¸ªæ¯”è¾ƒçš„å‘ï¼Œéœ€è¦è¿›è¡Œè°ƒæ•´ã€‚</p>
</blockquote>
<h3 id="ä¿®æ”¹kubeadm-1-14-xæºç ï¼Œè°ƒæ•´è¯ä¹¦è¿‡æœŸæ—¶é—´"><a href="#ä¿®æ”¹kubeadm-1-14-xæºç ï¼Œè°ƒæ•´è¯ä¹¦è¿‡æœŸæ—¶é—´" class="headerlink" title="ä¿®æ”¹kubeadm 1.14.xæºç ï¼Œè°ƒæ•´è¯ä¹¦è¿‡æœŸæ—¶é—´"></a>ä¿®æ”¹kubeadm 1.14.xæºç ï¼Œè°ƒæ•´è¯ä¹¦è¿‡æœŸæ—¶é—´</h3><h4 id="kubeadm1-14-x-å®‰è£…è¿‡åcrtè¯ä¹¦å¦‚ä¸‹æ‰€ç¤º"><a href="#kubeadm1-14-x-å®‰è£…è¿‡åcrtè¯ä¹¦å¦‚ä¸‹æ‰€ç¤º" class="headerlink" title="kubeadm1.14.x å®‰è£…è¿‡åcrtè¯ä¹¦å¦‚ä¸‹æ‰€ç¤º"></a>kubeadm1.14.x å®‰è£…è¿‡åcrtè¯ä¹¦å¦‚ä¸‹æ‰€ç¤º</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/etc/kubernetes/pki/apiserver.crt</span><br><span class="line">/etc/kubernetes/pki/front-proxy-ca.crt         #10å¹´æœ‰æ•ˆæœŸ</span><br><span class="line">/etc/kubernetes/pki/ca.crt                     #10å¹´æœ‰æ•ˆæœŸ</span><br><span class="line">/etc/kubernetes/pki/apiserver-etcd-client.crt</span><br><span class="line">/etc/kubernetes/pki/front-proxy-client.crt     #10å¹´æœ‰æ•ˆæœŸ</span><br><span class="line">/etc/kubernetes/pki/etcd/server.crt</span><br><span class="line">/etc/kubernetes/pki/etcd/ca.crt                #10å¹´æœ‰æ•ˆæœŸ</span><br><span class="line">/etc/kubernetes/pki/etcd/peer.crt              #10å¹´æœ‰æ•ˆæœŸ</span><br><span class="line">/etc/kubernetes/pki/etcd/healthcheck-client.crt</span><br><span class="line">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œé™¤äº†æ ‡æ³¨è¯´æ˜çš„è¯ä¹¦ä¸º10å¹´æœ‰æ•ˆæœŸï¼Œå…¶ä½™éƒ½æ˜¯1å¹´æœ‰æ•ˆæœŸï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸‹åŸå…ˆè°ƒæ•´è¯ä¹¦æœ‰æ•ˆæœŸçš„æºç ï¼Œå…‹éš†kubernetes æºç ï¼Œåˆ‡æ¢åˆ°1.14.1 tag æŸ¥çœ‹ï¼š<br>ä»£ç ç›®å½•ï¼š <code>staging/src/k8s.io/client-go/util/cert/cert.go</code><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> duration365d = time.Hour * <span class="number">24</span> * <span class="number">365</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSelfSignedCACert</span><span class="params">(cfg Config, key crypto.Signer)</span> <span class="params">(*x509.Certificate, error)</span></span> &#123;</span><br><span class="line">    now := time.Now()</span><br><span class="line">    tmpl := x509.Certificate&#123;</span><br><span class="line">        SerialNumber: <span class="built_in">new</span>(big.Int).SetInt64(<span class="number">0</span>),</span><br><span class="line">        Subject: pkix.Name&#123;</span><br><span class="line">            CommonName:   cfg.CommonName,</span><br><span class="line">            Organization: cfg.Organization,</span><br><span class="line">        &#125;,</span><br><span class="line">        NotBefore:             now.UTC(),</span><br><span class="line">        <span class="comment">//è¿™é‡Œå·²ç»è°ƒæ•´ä¸º10å¹´æœ‰æ•ˆæœŸ</span></span><br><span class="line">        NotAfter:              now.Add(duration365d * <span class="number">10</span>).UTC(),</span><br><span class="line">        KeyUsage:              x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature | x509.KeyUsageCertSign,</span><br><span class="line">        BasicConstraintsValid: <span class="literal">true</span>,</span><br><span class="line">        IsCA:                  <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    certDERBytes, err := x509.CreateCertificate(cryptorand.Reader, &amp;tmpl, &amp;tmpl, key.Public(), key)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> x509.ParseCertificate(certDERBytes)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œé€šè¿‡<code>NewSelfSignedCACert</code>è¿™ä¸ªæ–¹æ³•ç­¾å‘çš„è¯ä¹¦éƒ½é»˜è®¤ä¸º10å¹´æœ‰æ•ˆæœŸäº†ï¼Œä½†è¿™ä¸ªåªå½±å“éƒ¨åˆ†è¯ä¹¦ï¼Œä½†è¿™æ ·è¿˜æ²¡æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä¸ªåˆ«è¯ä¹¦çš„æœ‰æ•ˆæœŸè°ƒæ•´ï¼Œåœ¨ç»è¿‡å¯¹æºç çš„åˆ†æåï¼Œæ‰¾åˆ°äº†å¦‚ä¸‹çš„é€»è¾‘ï¼š</p>
<p>å‘ç°éƒ¨åˆ†è¯ä¹¦æ˜¯é€šè¿‡<code>NewSignedCert</code>è¿™ä¸ªæ–¹æ³•ç­¾å‘ï¼Œè€Œè¿™ä¸ªæ–¹æ³•ç­¾å‘çš„è¯ä¹¦é»˜è®¤åªæœ‰ä¸€å¹´æœ‰æ•ˆæœŸï¼ŒæŸ¥çœ‹ä»£ç é€»è¾‘ï¼š<br>ä»£ç : <code>cmd/kubeadm/app/util/pkiutil/pki_helpers.go</code><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> duration365d = time.Hour * <span class="number">24</span> * <span class="number">365</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSignedCert</span><span class="params">(cfg *certutil.Config, key crypto.Signer, caCert *x509.Certificate, caKey crypto.Signer)</span> <span class="params">(*x509.Certificate, error)</span></span> &#123;</span><br><span class="line">    serial, err := rand.Int(rand.Reader, <span class="built_in">new</span>(big.Int).SetInt64(math.MaxInt64))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(cfg.CommonName) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"must specify a CommonName"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(cfg.Usages) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"must specify at least one ExtKeyUsage"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    certTmpl := x509.Certificate&#123;</span><br><span class="line">        Subject: pkix.Name&#123;</span><br><span class="line">            CommonName:   cfg.CommonName,</span><br><span class="line">            Organization: cfg.Organization,</span><br><span class="line">        &#125;,</span><br><span class="line">        DNSNames:     cfg.AltNames.DNSNames,</span><br><span class="line">        IPAddresses:  cfg.AltNames.IPs,</span><br><span class="line">        SerialNumber: serial,</span><br><span class="line">        NotBefore:    caCert.NotBefore,</span><br><span class="line">        <span class="comment">// åªæœ‰ä¸€å¹´æœ‰æ•ˆæœŸ</span></span><br><span class="line">        NotAfter:     time.Now().Add(duration365d).UTC(),</span><br><span class="line">        KeyUsage:     x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature,</span><br><span class="line">        ExtKeyUsage:  cfg.Usages,</span><br><span class="line">    &#125;</span><br><span class="line">    certDERBytes, err := x509.CreateCertificate(cryptorand.Reader, &amp;certTmpl, caCert, key.Public(), caKey)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> x509.ParseCertificate(certDERBytes)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è‡³æ­¤ï¼Œè°ƒæ•´<code>NewSignedCert</code>è¿™ä¸ªæ–¹æ³•ï¼Œé‡æ–°è¿›è¡Œç¼–è¯‘ï¼Œå°†è¯ä¹¦æœ‰æ•ˆæœŸè°ƒæ•´ä¸ºä½ æƒ³è¦çš„ä»»ä½•æ—¶é—´ã€‚</p>
<p>å¦‚ä½•é‡æ–°ç¼–è¯‘kubeadmæºç ï¼Œè¯·å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼Œé“¾æ¥å¦‚ä¸‹ï¼š<a href="http://team.jiunile.com/blog/2018/12/k8s-kubeadm-ca-upgdate.html">Kubeadmè¯ä¹¦è¿‡æœŸæ—¶é—´è°ƒæ•´</a></p>
<h3 id="å¦‚ä½•ä¸€é”®ç¦»çº¿å®‰è£…kubernetes-1-14æ•™ç¨‹"><a href="#å¦‚ä½•ä¸€é”®ç¦»çº¿å®‰è£…kubernetes-1-14æ•™ç¨‹" class="headerlink" title="å¦‚ä½•ä¸€é”®ç¦»çº¿å®‰è£…kubernetes 1.14æ•™ç¨‹"></a>å¦‚ä½•ä¸€é”®ç¦»çº¿å®‰è£…kubernetes 1.14æ•™ç¨‹</h3><blockquote>
<p>k8s 1.14.x ç¦»çº¿ä¸€é”®å®‰è£…åŒ…æ•™ç¨‹&amp;&amp;åœ°å€ï¼š<a href="http://team.jiunile.com/pro/k8s/">kubernetes 1.14 ç¦»çº¿å®‰è£…åœ°å€</a></p>
</blockquote>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[kuberenetes äº‘åº”ç”¨å®è·µ]]></title>
      <url>http://team.jiunile.com/blog/2019/03/k8s-cloud.html</url>
      <content type="html"><![CDATA[<h2 id="å¦‚ä½•ä½¿ç”¨äº‘ç›˜"><a href="#å¦‚ä½•ä½¿ç”¨äº‘ç›˜" class="headerlink" title="å¦‚ä½•ä½¿ç”¨äº‘ç›˜"></a>å¦‚ä½•ä½¿ç”¨äº‘ç›˜</h2><h3 id="aws-ebs"><a href="#aws-ebs" class="headerlink" title="aws ebs"></a>aws ebs</h3><a id="more"></a>
<h4 id="è®¾ç½®IAMè§’è‰²å¹¶åˆ†é…åˆ°æœºå™¨ä¸Š"><a href="#è®¾ç½®IAMè§’è‰²å¹¶åˆ†é…åˆ°æœºå™¨ä¸Š" class="headerlink" title="è®¾ç½®IAMè§’è‰²å¹¶åˆ†é…åˆ°æœºå™¨ä¸Š"></a>è®¾ç½®IAMè§’è‰²å¹¶åˆ†é…åˆ°æœºå™¨ä¸Š</h4><blockquote>
<p>å…·æœ‰controlplane(æ§åˆ¶é¢æ¿)è§’è‰²çš„èŠ‚ç‚¹çš„IAMç­–ç•¥ï¼š</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line"><span class="attr">"Statement"</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">    <span class="attr">"Action"</span>: [</span><br><span class="line">      <span class="string">"autoscaling:DescribeAutoScalingGroups"</span>,</span><br><span class="line">      <span class="string">"autoscaling:DescribeLaunchConfigurations"</span>,</span><br><span class="line">      <span class="string">"autoscaling:DescribeTags"</span>,</span><br><span class="line">      <span class="string">"ec2:DescribeInstances"</span>,</span><br><span class="line">      <span class="string">"ec2:DescribeRegions"</span>,</span><br><span class="line">      <span class="string">"ec2:DescribeRouteTables"</span>,</span><br><span class="line">      <span class="string">"ec2:DescribeSecurityGroups"</span>,</span><br><span class="line">      <span class="string">"ec2:DescribeSubnets"</span>,</span><br><span class="line">      <span class="string">"ec2:DescribeVolumes"</span>,</span><br><span class="line">      <span class="string">"ec2:CreateSecurityGroup"</span>,</span><br><span class="line">      <span class="string">"ec2:CreateTags"</span>,</span><br><span class="line">      <span class="string">"ec2:CreateVolume"</span>,</span><br><span class="line">      <span class="string">"ec2:ModifyInstanceAttribute"</span>,</span><br><span class="line">      <span class="string">"ec2:ModifyVolume"</span>,</span><br><span class="line">      <span class="string">"ec2:AttachVolume"</span>,</span><br><span class="line">      <span class="string">"ec2:AuthorizeSecurityGroupIngress"</span>,</span><br><span class="line">      <span class="string">"ec2:CreateRoute"</span>,</span><br><span class="line">      <span class="string">"ec2:DeleteRoute"</span>,</span><br><span class="line">      <span class="string">"ec2:DeleteSecurityGroup"</span>,</span><br><span class="line">      <span class="string">"ec2:DeleteVolume"</span>,</span><br><span class="line">      <span class="string">"ec2:DetachVolume"</span>,</span><br><span class="line">      <span class="string">"ec2:RevokeSecurityGroupIngress"</span>,</span><br><span class="line">      <span class="string">"ec2:DescribeVpcs"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:AddTags"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:AttachLoadBalancerToSubnets"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:ApplySecurityGroupsToLoadBalancer"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:CreateLoadBalancer"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:CreateLoadBalancerPolicy"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:CreateLoadBalancerListeners"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:ConfigureHealthCheck"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:DeleteLoadBalancer"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:DeleteLoadBalancerListeners"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:DescribeLoadBalancers"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:DescribeLoadBalancerAttributes"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:DetachLoadBalancerFromSubnets"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:DeregisterInstancesFromLoadBalancer"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:ModifyLoadBalancerAttributes"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:RegisterInstancesWithLoadBalancer"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:SetLoadBalancerPoliciesForBackendServer"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:AddTags"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:CreateListener"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:CreateTargetGroup"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:DeleteListener"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:DeleteTargetGroup"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:DescribeListeners"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:DescribeLoadBalancerPolicies"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:DescribeTargetGroups"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:DescribeTargetHealth"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:ModifyListener"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:ModifyTargetGroup"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:RegisterTargets"</span>,</span><br><span class="line">      <span class="string">"elasticloadbalancing:SetLoadBalancerPoliciesOfListener"</span>,</span><br><span class="line">      <span class="string">"iam:CreateServiceLinkedRole"</span>,</span><br><span class="line">      <span class="string">"kms:DescribeKey"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Resource"</span>: [</span><br><span class="line">      <span class="string">"*"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>workerè§’è‰²çš„èŠ‚ç‚¹çš„IAMç­–ç•¥</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line"><span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">        <span class="attr">"Action"</span>: [</span><br><span class="line">            <span class="string">"ec2:DescribeInstances"</span>,</span><br><span class="line">            <span class="string">"ec2:DescribeRegions"</span>,</span><br><span class="line">            <span class="string">"ecr:GetAuthorizationToken"</span>,</span><br><span class="line">            <span class="string">"ecr:BatchCheckLayerAvailability"</span>,</span><br><span class="line">            <span class="string">"ecr:GetDownloadUrlForLayer"</span>,</span><br><span class="line">            <span class="string">"ecr:GetRepositoryPolicy"</span>,</span><br><span class="line">            <span class="string">"ecr:DescribeRepositories"</span>,</span><br><span class="line">            <span class="string">"ecr:ListImages"</span>,</span><br><span class="line">            <span class="string">"ecr:BatchGetImage"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="é…ç½®ClusterID"><a href="#é…ç½®ClusterID" class="headerlink" title="é…ç½®ClusterID"></a>é…ç½®ClusterID</h4><blockquote>
<p>éœ€è¦åœ¨æœºå™¨ä¸Šæ‰“ä¸Šæ ‡ç­¾ï¼Œå¦‚æœä¸é…ç½®ä¼šäº§ç”Ÿä»¥ä¸‹é”™è¯¯</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed to run Kubelet: could not init cloud provider <span class="string">"aws"</span>: AWS cloud failed to find ClusterID</span><br></pre></td></tr></table></figure>
<p>æ ‡ ç­¾ Key ï¼š <code>kubernetes.io/cluster/CLUSTERID</code><br>æ ‡ç­¾Valueï¼š  <code>owned</code></p>
<p><code>CLUSTERID</code> å¯ä»¥ä¸ºä»»ä½•å€¼</p>
<h4 id="kubernetesé…ç½®"><a href="#kubernetesé…ç½®" class="headerlink" title="kubernetesé…ç½®"></a>kubernetesé…ç½®</h4><p>éœ€è¦kube-apiserver, kube-controller-managerä»¥åŠkubelet å¯åŠ¨åŠ ä¸Š <code>--cloud-provider=aws</code>å‚æ•° , <code>æ³¨æ„</code>éœ€è¦åœ¨<strong>æ‰€æœ‰node</strong>ä¸Šçš„kubelet å¼€å¯<code>--cloud-provider=aws</code></p>
<p><strong>ä½¿ç”¨kubeadm åˆå§‹åŒ–kubernetesè®¾ç½®</strong><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiServerExtraArgs:</span></span><br><span class="line"><span class="attr">  cloud-provider:</span> aws</span><br><span class="line"><span class="attr">controllerManagerExtraArgs:</span></span><br><span class="line"><span class="attr">  cloud-provider:</span> aws</span><br><span class="line"></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="comment">#å»ºè®®å°†Kubeletçš„åç§°è®¾ç½®ä¸ºEC2ä¸­èŠ‚ç‚¹çš„ç§æœ‰DNSæ¡ç›®ï¼ˆè¿™å¯ç¡®ä¿å®ƒä¸ä¸»æœºååŒ¹é…ï¼Œå¦‚æœ¬æ–‡å‰é¢æ‰€è¿°ï¼‰</span></span><br><span class="line"><span class="attr">  name:</span> ip<span class="bullet">-10</span><span class="bullet">-15</span><span class="bullet">-30</span><span class="bullet">-45.</span>cn-northwest<span class="bullet">-1.</span>compute.internal</span><br><span class="line"><span class="attr">  kubeletExtraArgs:</span></span><br><span class="line"><span class="attr">    cloud-provider:</span> aws</span><br></pre></td></tr></table></figure></p>
<p><strong>ä½¿ç”¨kubeadm å‘½ä»¤å®‰è£…åçš„æƒ…å†µä¸‹</strong></p>
<ul>
<li><code>kube-apiserver</code> ä¿®æ”¹ <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>ä¸‹çš„å¯åŠ¨å‚æ•°</li>
<li><code>kube-controller-manager</code> ä¿®æ”¹ <code>/etc/kubernetes/manifests/kube-controller-manager.yaml</code>ä¸‹çš„å¯åŠ¨å‚æ•°</li>
<li><code>kubelet</code> ä¿®æ”¹ <code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> ä¸‹çš„å¯åŠ¨å‚æ•°</li>
</ul>
<h4 id="å¼€å§‹ä½¿ç”¨EBS"><a href="#å¼€å§‹ä½¿ç”¨EBS" class="headerlink" title="å¼€å§‹ä½¿ç”¨EBS"></a>å¼€å§‹ä½¿ç”¨EBS</h4><h5 id="åˆ›å»ºStorageClass"><a href="#åˆ›å»ºStorageClass" class="headerlink" title="åˆ›å»ºStorageClass"></a>åˆ›å»ºStorageClass</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat standard-storageclass.yaml</span></span><br><span class="line"><span class="attr">kind:</span> StorageClass</span><br><span class="line"><span class="attr">apiVersion:</span> storage.k8s.io/v1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> standard</span><br><span class="line"><span class="attr">provisioner:</span> kubernetes.io/aws-ebs</span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">  type:</span> gp2</span><br><span class="line"><span class="attr">  zone:</span> ap-northeast<span class="bullet">-1</span>b</span><br><span class="line"><span class="attr">reclaimPolicy:</span> Delete       <span class="comment"># åœ¨åˆ é™¤ Pod çš„åŒæ—¶ï¼Œä¹Ÿåˆ é™¤ EBS ç£ç›˜</span></span><br><span class="line"><span class="comment"># kubectl apply -f standard-storageclass.yaml</span></span><br></pre></td></tr></table></figure>
<h5 id="åˆ›å»ºPVC"><a href="#åˆ›å»ºPVC" class="headerlink" title="åˆ›å»ºPVC"></a>åˆ›å»ºPVC</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat nginx-pv-claim.yaml</span></span><br><span class="line"><span class="attr">kind:</span> PersistentVolumeClaim</span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> nginx-pv-claim</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> ReadWriteOnce</span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">20</span>Gi</span><br><span class="line"><span class="attr">  storageClassName:</span> standard</span><br><span class="line"><span class="comment"># kubectl apply -f nginx-pv-claim.yaml</span></span><br></pre></td></tr></table></figure>
<h5 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat nginx-pv-pod.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Pod</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> nginx-pv</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> nginx</span><br><span class="line"><span class="attr">    image:</span> nginx:<span class="number">1.7</span><span class="number">.9</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">    - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    volumeMounts:</span></span><br><span class="line"><span class="attr">    - name:</span> nginx-pv-claim</span><br><span class="line"><span class="attr">      mountPath:</span> /data</span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">  - name:</span> nginx-pv-claim</span><br><span class="line"><span class="attr">    persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">      claimName:</span> nginx-pv-claim</span><br><span class="line"><span class="comment"># kubectl apply -f nginx-pv-pod.yaml</span></span><br></pre></td></tr></table></figure>
<h4 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h4><ul>
<li><a href="https://www.kubernetes.org.cn/4078.html" target="_blank" rel="external">https://www.kubernetes.org.cn/4078.html</a></li>
<li><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#aws" target="_blank" rel="external">https://kubernetes.io/docs/concepts/storage/storage-classes/#aws</a></li>
<li><a href="https://blog.scottlowe.org/2018/09/28/setting-up-the-kubernetes-aws-cloud-provider/" target="_blank" rel="external">https://blog.scottlowe.org/2018/09/28/setting-up-the-kubernetes-aws-cloud-provider/</a></li>
</ul>
<h3 id="é˜¿é‡Œäº‘äº‘ç›˜"><a href="#é˜¿é‡Œäº‘äº‘ç›˜" class="headerlink" title="é˜¿é‡Œäº‘äº‘ç›˜"></a>é˜¿é‡Œäº‘äº‘ç›˜</h3><h4 id="åˆ›å»ºé˜¿é‡Œäº‘Provisioner-æ§åˆ¶å™¨"><a href="#åˆ›å»ºé˜¿é‡Œäº‘Provisioner-æ§åˆ¶å™¨" class="headerlink" title="åˆ›å»ºé˜¿é‡Œäº‘Provisioner æ§åˆ¶å™¨"></a>åˆ›å»ºé˜¿é‡Œäº‘Provisioner æ§åˆ¶å™¨</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> StorageClass</span><br><span class="line"><span class="attr">apiVersion:</span> storage.k8s.io/v1beta1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> alicloud-disk-common</span><br><span class="line"><span class="attr">provisioner:</span> alicloud/disk</span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">  type:</span> cloud</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> StorageClass</span><br><span class="line"><span class="attr">apiVersion:</span> storage.k8s.io/v1beta1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> alicloud-disk-efficiency</span><br><span class="line"><span class="attr">provisioner:</span> alicloud/disk</span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">  type:</span> cloud_efficiency</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> StorageClass</span><br><span class="line"><span class="attr">apiVersion:</span> storage.k8s.io/v1beta1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> alicloud-disk-ssd</span><br><span class="line"><span class="attr">provisioner:</span> alicloud/disk</span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">  type:</span> cloud_ssd</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> StorageClass</span><br><span class="line"><span class="attr">apiVersion:</span> storage.k8s.io/v1beta1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> alicloud-disk-available</span><br><span class="line"><span class="attr">provisioner:</span> alicloud/disk</span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">  type:</span> available</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> ClusterRole</span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> alicloud-disk-controller-runner</span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> [<span class="string">""</span>]</span><br><span class="line"><span class="attr">    resources:</span> [<span class="string">"persistentvolumes"</span>]</span><br><span class="line"><span class="attr">    verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"delete"</span>]</span><br><span class="line"><span class="attr">  - apiGroups:</span> [<span class="string">""</span>]</span><br><span class="line"><span class="attr">    resources:</span> [<span class="string">"persistentvolumeclaims"</span>]</span><br><span class="line"><span class="attr">    verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"update"</span>]</span><br><span class="line"><span class="attr">  - apiGroups:</span> [<span class="string">"storage.k8s.io"</span>]</span><br><span class="line"><span class="attr">    resources:</span> [<span class="string">"storageclasses"</span>]</span><br><span class="line"><span class="attr">    verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line"><span class="attr">  - apiGroups:</span> [<span class="string">""</span>]</span><br><span class="line"><span class="attr">    resources:</span> [<span class="string">"events"</span>]</span><br><span class="line"><span class="attr">    verbs:</span> [<span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> ServiceAccount</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> alicloud-disk-controller</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> ClusterRoleBinding</span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> run-alicloud-disk-controller</span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">  - kind:</span> ServiceAccount</span><br><span class="line"><span class="attr">    name:</span> alicloud-disk-controller</span><br><span class="line"><span class="attr">    namespace:</span> kube-system</span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> ClusterRole</span><br><span class="line"><span class="attr">  name:</span> alicloud-disk-controller-runner</span><br><span class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> ConfigMap</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> cloud-config</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  special.keyid: ä½ é˜¿é‡Œäº‘çš„access key</span><br><span class="line">  special.keysecret: ä½ é˜¿é‡Œäº‘çš„secret key</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> Deployment</span><br><span class="line"><span class="attr">apiVersion:</span> extensions/v1beta1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> alicloud-disk-controller</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> Recreate</span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> alicloud-disk-controller</span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">      - effect:</span> NoSchedule</span><br><span class="line"><span class="attr">        operator:</span> Exists</span><br><span class="line"><span class="attr">        key:</span> node-role.kubernetes.io/master</span><br><span class="line"><span class="attr">      - effect:</span> NoSchedule</span><br><span class="line"><span class="attr">        operator:</span> Exists</span><br><span class="line"><span class="attr">        key:</span> node.cloudprovider.kubernetes.io/uninitialized</span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line">         node-role.kubernetes.io/master: <span class="string">""</span></span><br><span class="line"><span class="attr">      serviceAccount:</span> alicloud-disk-controller</span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> alicloud-disk-controller</span><br><span class="line"><span class="attr">          image:</span> icyboy/alicloud-disk-controller:<span class="number">3652</span>ddf</span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line"><span class="attr">          - name:</span> ACCESS_KEY_ID</span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              configMapKeyRef:</span></span><br><span class="line"><span class="attr">                name:</span> cloud-config</span><br><span class="line"><span class="attr">                key:</span> special.keyid</span><br><span class="line"><span class="attr">          - name:</span> ACCESS_KEY_SECRET</span><br><span class="line"><span class="attr">            valueFrom:</span></span><br><span class="line"><span class="attr">              configMapKeyRef:</span></span><br><span class="line"><span class="attr">                name:</span> cloud-config</span><br><span class="line"><span class="attr">                key:</span> special.keysecret</span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> cloud-config</span><br><span class="line"><span class="attr">              mountPath:</span> /etc/kubernetes/</span><br><span class="line"><span class="attr">            - name:</span> logdir</span><br><span class="line"><span class="attr">              mountPath:</span> /var/log/alicloud/</span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> cloud-config</span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> /etc/kubernetes/</span><br><span class="line"><span class="attr">        - name:</span> logdir</span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> /var/log/alicloud/</span><br></pre></td></tr></table></figure>
<h4 id="åˆ›å»ºPVC-1"><a href="#åˆ›å»ºPVC-1" class="headerlink" title="åˆ›å»ºPVC"></a>åˆ›å»ºPVC</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> PersistentVolumeClaim</span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> disk</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> ReadWriteOnce</span><br><span class="line"><span class="comment">#alicloud-disk-common     æ™®é€šäº‘ç›˜</span></span><br><span class="line"><span class="comment">#alicloud-disk-efficiency é«˜æ•ˆäº‘ç›˜</span></span><br><span class="line"><span class="comment">#alicloud-disk-ssd        ssdäº‘ç›˜</span></span><br><span class="line"><span class="comment">#alicloud-disk-available</span></span><br><span class="line"><span class="attr">  storageClassName:</span> alicloud-disk-common</span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">20</span>Gi</span><br></pre></td></tr></table></figure>
<h4 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get pvc</span></span><br><span class="line">NAME      STATUS    VOLUME                   CAPACITY   ACCESS MODES   STORAGECLASS           AGE</span><br><span class="line">disk      Bound     d-bp1cz8sslda31ld2snbq   20Gi       RWO            alicloud-disk-common   11s</span><br><span class="line"><span class="comment"># kubectl get pv</span></span><br><span class="line">NAME                     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM          STORAGECLASS           REASON    AGE</span><br><span class="line">d-bp1cz8sslda31ld2snbq   20Gi       RWO            Delete           Bound     default/disk   alicloud-disk-common             14s</span><br></pre></td></tr></table></figure>
<h4 id="å‚è€ƒé“¾æ¥-1"><a href="#å‚è€ƒé“¾æ¥-1" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h4><ul>
<li><a href="https://yq.aliyun.com/articles/629001" target="_blank" rel="external">https://yq.aliyun.com/articles/629001</a></li>
<li><a href="https://github.com/AliyunContainerService/alicloud-storage-provisioner" target="_blank" rel="external">https://github.com/AliyunContainerService/alicloud-storage-provisioner</a></li>
</ul>
<h2 id="IAM-ä½¿ç”¨"><a href="#IAM-ä½¿ç”¨" class="headerlink" title="IAM ä½¿ç”¨"></a>IAM ä½¿ç”¨</h2><h3 id="kube2iam-in-aws-iam"><a href="#kube2iam-in-aws-iam" class="headerlink" title="kube2iam in aws iam"></a>kube2iam in aws iam</h3><h4 id="é€šè¿‡AWS-IAMåˆ›å»ºä¸€ä¸ªåä¸ºkube2iamçš„ç­–ç•¥ï¼Œç­–ç•¥è§„åˆ™å¦‚ä¸‹"><a href="#é€šè¿‡AWS-IAMåˆ›å»ºä¸€ä¸ªåä¸ºkube2iamçš„ç­–ç•¥ï¼Œç­–ç•¥è§„åˆ™å¦‚ä¸‹" class="headerlink" title="é€šè¿‡AWS IAMåˆ›å»ºä¸€ä¸ªåä¸ºkube2iamçš„ç­–ç•¥ï¼Œç­–ç•¥è§„åˆ™å¦‚ä¸‹"></a>é€šè¿‡AWS IAMåˆ›å»ºä¸€ä¸ªåä¸ºkube2iamçš„<code>ç­–ç•¥</code>ï¼Œç­–ç•¥è§„åˆ™å¦‚ä¸‹</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Action"</span>: [</span><br><span class="line">                <span class="string">"sts:AssumeRole"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Resource"</span>: <span class="string">"arn:aws-cn:iam::955466075186:role/k8s-*"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="é€šè¿‡AWS-IAMåˆ›å»ºä¸€ä¸ªåä¸ºï¼šnode-k8s-roleçš„è§’è‰²ï¼Œå¹¶å°†kube2iamçš„ç­–ç•¥èµ‹äºˆå®ƒï¼Œæ³¨æ„ï¼ï¼åŒæ—¶å°†è¿™ä¸ªè§’è‰²èµ‹äºˆåˆ°æœºå™¨ä¸Š"><a href="#é€šè¿‡AWS-IAMåˆ›å»ºä¸€ä¸ªåä¸ºï¼šnode-k8s-roleçš„è§’è‰²ï¼Œå¹¶å°†kube2iamçš„ç­–ç•¥èµ‹äºˆå®ƒï¼Œæ³¨æ„ï¼ï¼åŒæ—¶å°†è¿™ä¸ªè§’è‰²èµ‹äºˆåˆ°æœºå™¨ä¸Š" class="headerlink" title="é€šè¿‡AWS IAMåˆ›å»ºä¸€ä¸ªåä¸ºï¼šnode-k8s-roleçš„è§’è‰²ï¼Œå¹¶å°†kube2iamçš„ç­–ç•¥èµ‹äºˆå®ƒï¼Œæ³¨æ„ï¼ï¼åŒæ—¶å°†è¿™ä¸ªè§’è‰²èµ‹äºˆåˆ°æœºå™¨ä¸Š"></a>é€šè¿‡AWS IAMåˆ›å»ºä¸€ä¸ªåä¸ºï¼šnode-k8s-roleçš„<code>è§’è‰²</code>ï¼Œå¹¶å°†<code>kube2iam</code>çš„<code>ç­–ç•¥</code>èµ‹äºˆå®ƒï¼Œ<code>æ³¨æ„ï¼ï¼åŒæ—¶å°†è¿™ä¸ªè§’è‰²èµ‹äºˆåˆ°æœºå™¨ä¸Š</code></h4><h4 id="é€šè¿‡AWS-IAMåˆ›å»ºä¸€ä¸ªåä¸ºï¼šk8s-kube2iam-demoçš„è§’è‰²ï¼Œå°†AmazonS3FullAccessçš„ç­–ç•¥èµ‹äºˆå®ƒï¼ŒåŒæ—¶ç¼–è¾‘ä¿¡ä»»å…³ç³»ï¼Œè°ƒæ•´ä¸ºå¦‚ä¸‹ï¼š"><a href="#é€šè¿‡AWS-IAMåˆ›å»ºä¸€ä¸ªåä¸ºï¼šk8s-kube2iam-demoçš„è§’è‰²ï¼Œå°†AmazonS3FullAccessçš„ç­–ç•¥èµ‹äºˆå®ƒï¼ŒåŒæ—¶ç¼–è¾‘ä¿¡ä»»å…³ç³»ï¼Œè°ƒæ•´ä¸ºå¦‚ä¸‹ï¼š" class="headerlink" title="é€šè¿‡AWS IAMåˆ›å»ºä¸€ä¸ªåä¸ºï¼šk8s-kube2iam-demoçš„è§’è‰²ï¼Œå°†AmazonS3FullAccessçš„ç­–ç•¥èµ‹äºˆå®ƒï¼ŒåŒæ—¶ç¼–è¾‘ä¿¡ä»»å…³ç³»ï¼Œè°ƒæ•´ä¸ºå¦‚ä¸‹ï¼š"></a>é€šè¿‡AWS IAMåˆ›å»ºä¸€ä¸ªåä¸ºï¼šk8s-kube2iam-demoçš„<code>è§’è‰²</code>ï¼Œå°†<code>AmazonS3FullAccess</code>çš„<code>ç­–ç•¥</code>èµ‹äºˆå®ƒï¼ŒåŒæ—¶ç¼–è¾‘ä¿¡ä»»å…³ç³»ï¼Œè°ƒæ•´ä¸ºå¦‚ä¸‹ï¼š</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Principal"</span>: &#123;</span><br><span class="line">        <span class="attr">"Service"</span>: <span class="string">"ec2.amazonaws.com.cn"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"Action"</span>: <span class="string">"sts:AssumeRole"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Sid"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Principal"</span>: &#123;</span><br><span class="line">        <span class="attr">"AWS"</span>: <span class="string">"arn:aws-cn:iam::955466075186:role/node-k8s-role"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"Action"</span>: <span class="string">"sts:AssumeRole"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="éƒ¨ç½²kube2iam"><a href="#éƒ¨ç½²kube2iam" class="headerlink" title="éƒ¨ç½²kube2iam"></a>éƒ¨ç½²kube2iam</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: kube2iam/templates/serviceaccount.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> ServiceAccount</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> kube2iam</span><br><span class="line"><span class="attr">    chart:</span> kube2iam<span class="bullet">-1.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">    heritage:</span> Tiller</span><br><span class="line"><span class="attr">    release:</span> ardent-wildebeest</span><br><span class="line"><span class="attr">  name:</span> ardent-wildebeest-kube2iam</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: kube2iam/templates/clusterrole.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="attr">kind:</span> ClusterRole</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> kube2iam</span><br><span class="line"><span class="attr">    chart:</span> kube2iam<span class="bullet">-1.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">    heritage:</span> Tiller</span><br><span class="line"><span class="attr">    release:</span> ardent-wildebeest</span><br><span class="line"><span class="attr">  name:</span> ardent-wildebeest-kube2iam</span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> namespaces</span><br><span class="line"><span class="bullet">      -</span> pods</span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> list</span><br><span class="line"><span class="bullet">      -</span> watch</span><br><span class="line"><span class="bullet">      -</span> get</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: kube2iam/templates/clusterrolebinding.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="attr">kind:</span> ClusterRoleBinding</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> kube2iam</span><br><span class="line"><span class="attr">    chart:</span> kube2iam<span class="bullet">-1.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">    heritage:</span> Tiller</span><br><span class="line"><span class="attr">    release:</span> ardent-wildebeest</span><br><span class="line"><span class="attr">  name:</span> ardent-wildebeest-kube2iam</span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="attr">  kind:</span> ClusterRole</span><br><span class="line"><span class="attr">  name:</span> ardent-wildebeest-kube2iam</span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">  - kind:</span> ServiceAccount</span><br><span class="line"><span class="attr">    name:</span> ardent-wildebeest-kube2iam</span><br><span class="line"><span class="attr">    namespace:</span> default</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: kube2iam/templates/daemonset.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> extensions/v1beta1</span><br><span class="line"><span class="attr">kind:</span> DaemonSet</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> kube2iam</span><br><span class="line"><span class="attr">    chart:</span> kube2iam<span class="bullet">-1.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">    heritage:</span> Tiller</span><br><span class="line"><span class="attr">    release:</span> ardent-wildebeest</span><br><span class="line"><span class="attr">  name:</span> ardent-wildebeest-kube2iam</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> kube2iam</span><br><span class="line"><span class="attr">        release:</span> ardent-wildebeest</span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> kube2iam</span><br><span class="line"><span class="attr">          image:</span> <span class="string">"jtblin/kube2iam:0.10.4"</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">"IfNotPresent"</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"--host-interface=cali+"</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"--node=$(NODE_NAME)"</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"--host-ip=$(HOST_IP)"</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"--iptables=true"</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"--base-role-arn=arn:aws-cn:iam::955466075186:role/node-k8s-role"</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"--app-port=8181"</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"--use-regional-sts-endpoint"</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line"><span class="attr">            - name:</span> HOST_IP</span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                fieldRef:</span></span><br><span class="line"><span class="attr">                  fieldPath:</span> status.podIP</span><br><span class="line"><span class="attr">            - name:</span> NODE_NAME</span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                fieldRef:</span></span><br><span class="line"><span class="attr">                  fieldPath:</span> spec.nodeName</span><br><span class="line"><span class="attr">            - name:</span> AWS_REGION</span><br><span class="line"><span class="attr">              value:</span> cn-northwest<span class="bullet">-1</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - name:</span> http</span><br><span class="line"><span class="attr">              containerPort:</span> <span class="number">8181</span></span><br><span class="line"><span class="attr">          livenessProbe:</span></span><br><span class="line"><span class="attr">            httpGet:</span></span><br><span class="line"><span class="attr">              path:</span> /healthz</span><br><span class="line"><span class="attr">              port:</span> <span class="number">8181</span></span><br><span class="line"><span class="attr">              scheme:</span> HTTP</span><br><span class="line"><span class="attr">            initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">            periodSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">            successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">            failureThreshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">            timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line">            &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">          securityContext:</span></span><br><span class="line"><span class="attr">            privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> ardent-wildebeest-kube2iam</span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line">        []</span><br><span class="line"></span><br><span class="line"><span class="attr">  updateStrategy:</span></span><br><span class="line"><span class="attr">    type:</span> OnDelete</span><br></pre></td></tr></table></figure>
<h4 id="æµ‹è¯•pod"><a href="#æµ‹è¯•pod" class="headerlink" title="æµ‹è¯•pod"></a>æµ‹è¯•pod</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> apps/v1</span><br><span class="line"><span class="attr">kind:</span> Deployment</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> awscli-deployment</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> awscli</span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        iam.amazonaws.com/role: arn:aws-cn:iam::<span class="number">955466075186</span>:role/k8s/k8s-kube2iam-demo</span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> awscli</span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> awscli</span><br><span class="line"><span class="attr">        image:</span> mesosphere/aws-cli</span><br><span class="line"><span class="attr">        command:</span> [ <span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"--"</span> ]</span><br><span class="line"><span class="attr">        args:</span> [ <span class="string">"while true; do sleep 3000; done;"</span> ]</span><br></pre></td></tr></table></figure>
<h2 id="äº‘åº”ç”¨ç–‘éš¾æ‚ç—‡"><a href="#äº‘åº”ç”¨ç–‘éš¾æ‚ç—‡" class="headerlink" title="äº‘åº”ç”¨ç–‘éš¾æ‚ç—‡"></a>äº‘åº”ç”¨ç–‘éš¾æ‚ç—‡</h2><h3 id="ä½¿ç”¨äº‘è´Ÿè½½å‡è¡¡å™¨ä»£ç†APIServeré—®é¢˜"><a href="#ä½¿ç”¨äº‘è´Ÿè½½å‡è¡¡å™¨ä»£ç†APIServeré—®é¢˜" class="headerlink" title="ä½¿ç”¨äº‘è´Ÿè½½å‡è¡¡å™¨ä»£ç†APIServeré—®é¢˜"></a>ä½¿ç”¨äº‘è´Ÿè½½å‡è¡¡å™¨ä»£ç†APIServeré—®é¢˜</h3><blockquote>
<p>é˜¿é‡Œäº‘/AWSçš„è´Ÿè½½å‡è¡¡æ˜¯å››å±‚TCPè´Ÿè´£ï¼Œ<strong>ä¸æ”¯æŒåç«¯ECSå®ä¾‹æ—¢ä½œä¸ºReal Serveråˆä½œä¸ºå®¢æˆ·ç«¯å‘æ‰€åœ¨çš„è´Ÿè½½å‡è¡¡å®ä¾‹å‘é€è¯·æ±‚</strong>ã€‚å› ä¸ºè¿”å›çš„æ•°æ®åŒ…åªåœ¨äº‘æœåŠ¡å™¨å†…éƒ¨è½¬å‘ï¼Œä¸ç»è¿‡è´Ÿè½½å‡è¡¡ï¼Œæ‰€ä»¥åœ¨åç«¯ECSå®ä¾‹ä¸Šå»è®¿é—®è´Ÿè½½å‡è¡¡çš„æœåŠ¡åœ°å€æ˜¯ä¸é€šçš„ã€‚ä»€ä¹ˆæ„æ€ï¼Ÿå°±æ˜¯å¦‚æœä½ è¦ä½¿ç”¨é˜¿é‡Œäº‘çš„SLBçš„è¯ï¼Œé‚£ä¹ˆä½ ä¸èƒ½åœ¨apiserverèŠ‚ç‚¹ä¸Šä½¿ç”¨SLBï¼ˆæ¯”å¦‚åœ¨apiserver ä¸Šå®‰è£…kubectlï¼Œç„¶åå°†apiserverçš„åœ°å€è®¾ç½®ä¸ºSLBçš„è´Ÿè½½åœ°å€ä½¿ç”¨ï¼‰ï¼Œå› ä¸ºè¿™æ ·çš„è¯å°±å¯èƒ½é€ æˆå›ç¯äº†ï¼Œæ‰€ä»¥ç®€å•çš„åšæ³•æ˜¯å¦å¤–ç”¨ä¸¤ä¸ªæ–°çš„èŠ‚ç‚¹åšHAå®ä¾‹ï¼Œç„¶åå°†è¿™ä¸¤ä¸ªå®ä¾‹æ·»åŠ åˆ°SLB æœºå™¨ç»„ä¸­ã€‚</p>
</blockquote>
<ul>
<li>aws ä½¿ç”¨nlbï¼ŒæŒ‡å®šip</li>
<li>aliyun åœ¨apiserverä¸Šæ­å»ºkeepalived</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[kuberneteså†…éƒ¨DNSå‰–æ]]></title>
      <url>http://team.jiunile.com/blog/2019/03/k8s-dns.html</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ Service ç”Ÿæˆçš„<code>ClusterIP(VIP)</code>æ¥è®¿é—® Pod æä¾›çš„æœåŠ¡ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨çš„æ—¶å€™è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬æ€ä¹ˆçŸ¥é“æŸä¸ªåº”ç”¨çš„ VIP å‘¢ï¼Ÿæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸¤ä¸ªåº”ç”¨ï¼Œä¸€ä¸ªæ˜¯ api åº”ç”¨ï¼Œä¸€ä¸ªæ˜¯ db åº”ç”¨ï¼Œä¸¤ä¸ªåº”ç”¨éƒ½æ˜¯é€šè¿‡<code>Deployment</code>è¿›è¡Œç®¡ç†çš„ï¼Œå¹¶ä¸”éƒ½é€šè¿‡ Service æš´éœ²å‡ºäº†ç«¯å£æä¾›æœåŠ¡ã€‚api éœ€è¦è¿æ¥åˆ° db è¿™ä¸ªåº”ç”¨ï¼Œæˆ‘ä»¬åªçŸ¥é“ db åº”ç”¨çš„åç§°å’Œ db å¯¹åº”çš„ Service çš„åç§°ï¼Œä½†æ˜¯å¹¶ä¸çŸ¥é“å®ƒçš„ VIP åœ°å€ï¼Œæˆ‘ä»¬å‰é¢çš„ Service è¯¾ç¨‹ä¸­æ˜¯ä¸æ˜¯å­¦ä¹ åˆ°æˆ‘ä»¬é€šè¿‡<code>ClusterIP</code>å°±å¯ä»¥è®¿é—®åˆ°åé¢çš„<code>Pod</code>æœåŠ¡ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“äº† VIP çš„åœ°å€æ˜¯ä¸æ˜¯å°±è¡Œäº†ï¼Ÿ</p>
<h2 id="apiserver"><a href="#apiserver" class="headerlink" title="apiserver"></a>apiserver</h2><p>æˆ‘ä»¬çŸ¥é“å¯ä»¥ä» apiserver ä¸­ç›´æ¥æŸ¥è¯¢è·å–åˆ°å¯¹åº” service çš„åç«¯ Endpointsä¿¡æ¯ï¼Œæ‰€ä»¥æœ€ç®€å•çš„åŠæ³•æ˜¯ä» apiserver ä¸­ç›´æ¥æŸ¥è¯¢ï¼Œå¦‚æœå¶å°”ä¸€ä¸ªç‰¹æ®Šçš„åº”ç”¨ï¼Œæˆ‘ä»¬é€šè¿‡<code>apiserver</code>å»æŸ¥è¯¢åˆ°<code>Service</code>åé¢çš„ <code>Endpoints</code>ç›´æ¥ä½¿ç”¨æ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯å¦‚æœæ¯ä¸ªåº”ç”¨éƒ½åœ¨å¯åŠ¨çš„æ—¶å€™å»æŸ¥è¯¢ä¾èµ–çš„æœåŠ¡ï¼Œè¿™ä¸ä½†å¢åŠ äº†åº”ç”¨çš„å¤æ‚åº¦ï¼Œè¿™ä¹Ÿå¯¼è‡´äº†æˆ‘ä»¬çš„åº”ç”¨éœ€è¦ä¾èµ–<code>Kubernetes</code>äº†ï¼Œè€¦åˆåº¦å¤ªé«˜äº†ï¼Œä¸å…·æœ‰é€šç”¨æ€§ã€‚<br><a id="more"></a></p>
<h2 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h2><p>ä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œåœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼ŒKubernetes é‡‡ç”¨äº†ç¯å¢ƒå˜é‡çš„æ–¹æ³•ï¼Œæ¯ä¸ª Pod å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®æ‰€æœ‰æœåŠ¡çš„ IP å’Œ port ä¿¡æ¯ï¼Œè¿™æ · Pod ä¸­çš„åº”ç”¨å¯ä»¥é€šè¿‡è¯»å–ç¯å¢ƒå˜é‡æ¥è·å–ä¾èµ–æœåŠ¡çš„åœ°å€ä¿¡æ¯ï¼Œè¿™ç§æ–¹æ³•ä½¿ç”¨èµ·æ¥ç›¸å¯¹ç®€å•ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜å°±æ˜¯ä¾èµ–çš„æœåŠ¡å¿…é¡»åœ¨ Pod å¯åŠ¨ä¹‹å‰å°±å­˜åœ¨ï¼Œä¸ç„¶æ˜¯ä¸ä¼šè¢«æ³¨å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­çš„ã€‚æ¯”å¦‚æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ª Nginx æœåŠ¡ï¼š(test-nginx.yaml)<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> apps/v1beta1</span><br><span class="line"><span class="attr">kind:</span> Deployment</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> nginx-deploy</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> nginx-demo</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> nginx</span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> nginx</span><br><span class="line"><span class="attr">        image:</span> nginx:<span class="number">1.7</span><span class="number">.9</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Service</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> nginx-service</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    name:</span> nginx-service</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> nginx</span><br></pre></td></tr></table></figure></p>
<p>åˆ›å»ºä¸Šé¢çš„æœåŠ¡ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create <span class="_">-f</span> <span class="built_in">test</span>-nginx.yaml</span><br><span class="line">deployment.apps <span class="string">"nginx-deploy"</span> created</span><br><span class="line">service <span class="string">"nginx-service"</span> created</span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">...</span><br><span class="line">nginx-deploy-75675f5897-47h4t             1/1       Running   0          53s</span><br><span class="line">nginx-deploy-75675f5897-mmm8w             1/1       Running   0          53s</span><br><span class="line">...</span><br><span class="line">$ kubectl get svc</span><br><span class="line">NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">...</span><br><span class="line">nginx-service   ClusterIP   10.107.225.42    &lt;none&gt;        5000/TCP         1m</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸¤ä¸ª Pod å’Œä¸€ä¸ªåä¸º nginx-service çš„æœåŠ¡åˆ›å»ºæˆåŠŸäº†ï¼Œè¯¥ Service ç›‘å¬çš„ç«¯å£æ˜¯ 5000ï¼ŒåŒæ—¶å®ƒä¼šæŠŠæµé‡è½¬å‘ç»™å®ƒä»£ç†çš„æ‰€æœ‰ Podï¼ˆæˆ‘ä»¬è¿™é‡Œå°±æ˜¯æ‹¥æœ‰ app: nginx æ ‡ç­¾çš„ä¸¤ä¸ª Podï¼‰ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å†æ¥åˆ›å»ºä¸€ä¸ªæ™®é€šçš„ Podï¼Œè§‚å¯Ÿä¸‹è¯¥ Pod ä¸­çš„ç¯å¢ƒå˜é‡æ˜¯å¦åŒ…å«ä¸Šé¢çš„ nginx-service çš„æœåŠ¡ä¿¡æ¯ï¼šï¼ˆtest-pod.yamlï¼‰<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Pod</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> test-pod</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> test-service-pod</span><br><span class="line"><span class="attr">    image:</span> busybox</span><br><span class="line"><span class="attr">    command:</span> [<span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"env"</span>]</span><br></pre></td></tr></table></figure></p>
<p>ç„¶ååˆ›å»ºè¯¥æµ‹è¯•çš„ Podï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create <span class="_">-f</span> <span class="built_in">test</span>-pod.yaml</span><br><span class="line">pod <span class="string">"test-pod"</span> created</span><br></pre></td></tr></table></figure></p>
<p>ç­‰ Pod åˆ›å»ºå®Œæˆåï¼Œæˆ‘ä»¬æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs <span class="built_in">test</span>-pod</span><br><span class="line">...</span><br><span class="line">KUBERNETES_PORT=tcp://10.96.0.1:443</span><br><span class="line">KUBERNETES_SERVICE_PORT=443</span><br><span class="line">HOSTNAME=<span class="built_in">test</span>-pod</span><br><span class="line">HOME=/root</span><br><span class="line">NGINX_SERVICE_PORT_5000_TCP_ADDR=10.107.225.42</span><br><span class="line">NGINX_SERVICE_PORT_5000_TCP_PORT=5000</span><br><span class="line">NGINX_SERVICE_PORT_5000_TCP_PROTO=tcp</span><br><span class="line">KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1</span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">NGINX_SERVICE_SERVICE_HOST=10.107.225.42</span><br><span class="line">NGINX_SERVICE_PORT_5000_TCP=tcp://10.107.225.42:5000</span><br><span class="line">KUBERNETES_PORT_443_TCP_PORT=443</span><br><span class="line">KUBERNETES_PORT_443_TCP_PROTO=tcp</span><br><span class="line">NGINX_SERVICE_SERVICE_PORT=5000</span><br><span class="line">NGINX_SERVICE_PORT=tcp://10.107.225.42:5000</span><br><span class="line">KUBERNETES_SERVICE_PORT_HTTPS=443</span><br><span class="line">KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443</span><br><span class="line">KUBERNETES_SERVICE_HOST=10.96.0.1</span><br><span class="line">PWD=/</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰“å°äº†å¾ˆå¤šç¯å¢ƒå˜é‡å¤„ç†ï¼Œå…¶ä¸­å°±åŒ…æ‹¬æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ nginx-service è¿™ä¸ªæœåŠ¡ï¼Œæœ‰ HOSTã€PORTã€PROTOã€ADDR ç­‰ï¼Œä¹ŸåŒ…æ‹¬å…¶ä»–å·²ç»å­˜åœ¨çš„ Service çš„ç¯å¢ƒå˜é‡ï¼Œç°åœ¨å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ª Pod é‡Œé¢è®¿é—® nginx-service çš„æœåŠ¡ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ç›´æ¥é€šè¿‡ NGINX_SERVICE_SERVICE_HOST å’Œ NGINX_SERVICE_SERVICE_PORT å°±å¯ä»¥äº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹ŸçŸ¥é“å¦‚æœè¿™ä¸ª Pod å¯åŠ¨èµ·æ¥çš„æ—¶å€™å¦‚æœ nginx-service æœåŠ¡è¿˜æ²¡å¯åŠ¨èµ·æ¥ï¼Œåœ¨ç¯å¢ƒå˜é‡ä¸­æˆ‘ä»¬æ˜¯æ— æ³•è·å–åˆ°è¿™äº›ä¿¡æ¯çš„ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>initContainer</code>ä¹‹ç±»çš„æ–¹æ³•æ¥ç¡®ä¿ nginx-service å¯åŠ¨åå†å¯åŠ¨ Podï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•æ¯•ç«Ÿå¢åŠ äº† Pod å¯åŠ¨çš„å¤æ‚æ€§ï¼Œæ‰€ä»¥è¿™ä¸æ˜¯æœ€ä¼˜çš„æ–¹æ³•ã€‚</p>
<h2 id="KubeDNS"><a href="#KubeDNS" class="headerlink" title="KubeDNS"></a>KubeDNS</h2><p>ç”±äºä¸Šé¢ç¯å¢ƒå˜é‡è¿™ç§æ–¹å¼çš„å±€é™æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ›´åŠ æ™ºèƒ½çš„æ–¹æ¡ˆï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥è‡ªå·±æƒ³å­¦ä¸€ç§æ¯”è¾ƒç†æƒ³çš„æ–¹æ¡ˆï¼šé‚£å°±æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨ Service çš„åç§°ï¼Œå› ä¸º Service çš„åç§°ä¸ä¼šå˜åŒ–ï¼Œæˆ‘ä»¬ä¸éœ€è¦å»å…³å¿ƒåˆ†é…çš„<code>ClusterIP</code>çš„åœ°å€ï¼Œå› ä¸ºè¿™ä¸ªåœ°å€å¹¶ä¸æ˜¯å›ºå®šä¸å˜çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ Service çš„åå­—ï¼Œç„¶åå¯¹åº”çš„<code>ClusterIP</code>åœ°å€çš„è½¬æ¢èƒ½å¤Ÿè‡ªåŠ¨å®Œæˆå°±å¾ˆå¥½äº†ã€‚æˆ‘ä»¬çŸ¥é“åå­—å’Œ IP ç›´æ¥çš„è½¬æ¢æ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬å¹³æ—¶è®¿é—®çš„ç½‘ç«™éå¸¸ç±»ä¼¼å•Šï¼Ÿä»–ä»¬ä¹‹é—´çš„è½¬æ¢åŠŸèƒ½é€šè¿‡<code>DNS</code>å°±å¯ä»¥è§£å†³äº†ï¼ŒåŒæ ·çš„ï¼Œ<code>Kubernetes</code>ä¹Ÿæä¾›äº†<code>DNS</code><br>çš„æ–¹æ¡ˆæ¥è§£å†³ä¸Šé¢çš„æœåŠ¡å‘ç°çš„é—®é¢˜ã€‚</p>
<h3 id="kubedns-ä»‹ç»"><a href="#kubedns-ä»‹ç»" class="headerlink" title="kubedns ä»‹ç»"></a>kubedns ä»‹ç»</h3><p>DNS æœåŠ¡ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç³»ç»ŸæœåŠ¡ï¼Œè€Œæ˜¯ä½œä¸ºä¸€ç§ addon æ’ä»¶è€Œå­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸æ˜¯ Kubernetes é›†ç¾¤å¿…é¡»å®‰è£…çš„ï¼Œå½“ç„¶æˆ‘ä»¬å¼ºçƒˆæ¨èå®‰è£…ï¼Œå¯ä»¥å°†è¿™ä¸ªæ’ä»¶çœ‹æˆæ˜¯ä¸€ç§è¿è¡Œåœ¨ Kubernetes é›†ç¾¤ä¸Šçš„ä¸€ç›´æ¯”è¾ƒç‰¹æ®Šçš„åº”ç”¨ï¼Œç°åœ¨æ¯”è¾ƒæ¨èçš„ä¸¤ä¸ªæ’ä»¶ï¼š<code>kube-dns</code> å’Œ <code>CoreDNS</code>ã€‚æˆ‘ä»¬åœ¨å‰é¢ä½¿ç”¨<code>kubeadm</code>æ­å»ºé›†ç¾¤çš„æ—¶å€™ç›´æ¥å®‰è£…çš„ kube-dns æ’ä»¶ï¼Œå¦‚æœä¸è®°å¾—äº†å¯ä»¥å›å¤´å»çœ‹ä¸€çœ‹ã€‚å½“ç„¶å¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨<code>CoreDNS</code> çš„è¯ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œåªéœ€è¦æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init --feature-gates=CoreDNS=<span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p>Kubernetes DNS pod ä¸­åŒ…æ‹¬ 3 ä¸ªå®¹å™¨ï¼Œå¯ä»¥é€šè¿‡ kubectl å·¥å…·æŸ¥çœ‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">NAME                                    READY     STATUS    RESTARTS   AGE</span><br><span class="line">...</span><br><span class="line">kube-dns-5868f69869-zp5kz               3/3       Running   0          19d</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>READY ä¸€æ å¯ä»¥çœ‹åˆ°æ˜¯ 3/3ï¼Œç”¨å¦‚ä¸‹å‘½ä»¤å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ° kube-dns åŒ…å«çš„3ä¸ªå®¹å™¨ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe pod kube-dns-5868f69869-zp5kz -n kube-system</span><br></pre></td></tr></table></figure></p>
<p>kube-dnsã€dnsmasq-nannyã€sidecar è¿™3ä¸ªå®¹å™¨åˆ†åˆ«å®ç°äº†ä»€ä¹ˆåŠŸèƒ½?</p>
<ul>
<li>kubedns: kubedns åŸºäº SkyDNS åº“ï¼Œé€šè¿‡ apiserver ç›‘å¬ Service å’Œ Endpoints çš„å˜æ›´äº‹ä»¶åŒæ—¶ä¹ŸåŒæ­¥åˆ°æœ¬åœ° Cacheï¼Œå®ç°äº†ä¸€ä¸ªå®æ—¶çš„ Kubernetes é›†ç¾¤å†… Service å’Œ Pod çš„ DNSæœåŠ¡å‘ç°</li>
<li>dnsmasq: dsnmasq å®¹å™¨åˆ™å®ç°äº† DNS çš„ç¼“å­˜åŠŸèƒ½(åœ¨å†…å­˜ä¸­é¢„ç•™ä¸€å—é»˜è®¤å¤§å°ä¸º 1G çš„åœ°æ–¹ï¼Œä¿å­˜å½“å‰æœ€å¸¸ç”¨çš„ DNS æŸ¥è¯¢è®°å½•ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰è¦æŸ¥æ‰¾çš„è®°å½•ï¼Œå®ƒä¼šåˆ° kubedns ä¸­æŸ¥è¯¢ï¼Œå¹¶æŠŠç»“æœç¼“å­˜èµ·æ¥)ï¼Œé€šè¿‡ç›‘å¬ ConfigMap æ¥åŠ¨æ€ç”Ÿæˆé…ç½®</li>
<li>sider: sidecar å®¹å™¨å®ç°äº†å¯é…ç½®çš„ DNS æ¢æµ‹ï¼Œå¹¶é‡‡é›†å¯¹åº”çš„ç›‘æ§æŒ‡æ ‡æš´éœ²å‡ºæ¥ä¾› prometheus ä½¿ç”¨<br><img src="/images/k8s/kubedns.jpg" alt="kubedns"></li>
</ul>
<h3 id="å¯¹-Pod-çš„å½±å“"><a href="#å¯¹-Pod-çš„å½±å“" class="headerlink" title="å¯¹ Pod çš„å½±å“"></a>å¯¹ Pod çš„å½±å“</h3><p>DNS Pod å…·æœ‰é™æ€ IP å¹¶ä½œä¸º Kubernetes æœåŠ¡æš´éœ²å‡ºæ¥ã€‚è¯¥é™æ€ IP è¢«åˆ†é…åï¼Œkubelet ä¼šå°†ä½¿ç”¨ <code>--cluster-dns = &lt;dns-service-ip&gt;</code>å‚æ•°é…ç½®çš„ DNS ä¼ é€’ç»™æ¯ä¸ªå®¹å™¨ã€‚DNS åç§°ä¹Ÿéœ€è¦åŸŸåï¼Œæœ¬åœ°åŸŸå¯ä»¥ä½¿ç”¨å‚æ•°<code>--cluster-domain = &lt;default-local-domain&gt;</code>åœ¨<code>kubelet</code>ä¸­é…ç½®ã€‚</p>
<p>æˆ‘ä»¬è¯´<code>dnsmasq</code>å®¹å™¨é€šè¿‡ç›‘å¬<code>ConfigMap</code>æ¥åŠ¨æ€ç”Ÿæˆé…ç½®ï¼Œå¯ä»¥è‡ªå®šä¹‰å­˜æ ¹åŸŸå’Œä¸Šä¸‹æ¸¸åŸŸåæœåŠ¡å™¨ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„<code>ConfigMap</code>å»ºç«‹äº†ä¸€ä¸ª DNS é…ç½®ï¼Œå®ƒå…·æœ‰ä¸€ä¸ªå•ç‹¬çš„å­˜æ ¹åŸŸå’Œä¸¤ä¸ªä¸Šæ¸¸åŸŸåæœåŠ¡å™¨ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> ConfigMap</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> kube-dns</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  stubDomains:</span> <span class="string">|</span><br><span class="line">    &#123;"jiunile.local": ["192.168.3.108"]&#125;</span><br><span class="line"></span><span class="attr">  upstreamNameservers:</span> <span class="string">|</span><br><span class="line">    ["8.8.8.8", "8.8.4.4"]</span></span><br></pre></td></tr></table></figure></p>
<p>å¦‚ä½•å·²ä½¿ç”¨corednsï¼Œåˆ™é€šè¿‡ä¿®æ”¹corednsé…ç½®ä¿¡æ¯æ¥è°ƒæ•´ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  Corefile:</span> <span class="string">|</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        health</span><br><span class="line">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class="line">           pods insecure</span><br><span class="line">           # ç”¨äºè§£æå¤–éƒ¨ä¸»æœºä¸»æœºï¼ˆå¤–éƒ¨æœåŠ¡ï¼‰</span><br><span class="line">           upstream 114.114.114.114 223.5.5.5</span><br><span class="line">           fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9153</span><br><span class="line">        # ä»»ä½•ä¸åœ¨é›†ç¾¤åŸŸå†…çš„æŸ¥è¯¢å°†è½¬å‘åˆ°é¢„å®šä¹‰çš„è§£æå™¨ï¼Œé»˜è®¤ï¼š/etc/resolv.confï¼›</span><br><span class="line">        # åœ¨coredns "Deployment"èµ„æºä¸­"dnsPolicy"è®¾ç½®ä¸º"Default"ï¼Œå³æä¾›dnsæœåŠ¡çš„podä»æ‰€åœ¨èŠ‚ç‚¹ç»§æ‰¿/etc/resolv.confï¼Œå¦‚æœèŠ‚ç‚¹çš„ä¸Šæ¸¸è§£æåœ°å€ä¸"upstream"ä¸€è‡´ï¼Œåˆ™è®¾ç½®ä»»æ„ä¸€ä¸ªå‚æ•°å³å¯</span><br><span class="line">        proxy . /etc/resolv.conf</span><br><span class="line">        #proxy . 114.114.114.114 223.5.5.5</span><br><span class="line">        cache 30</span><br><span class="line">        reload</span><br><span class="line">    &#125;</span><br><span class="line">    # è‡ªå®šä¹‰dnsè®°å½•ï¼Œå¯¹åº”kube-dnsä¸­çš„stubdomainsï¼›</span><br><span class="line">    # æ¯æ¡è®°å½•ï¼Œå•ç‹¬è®¾ç½®1å„zone</span><br><span class="line">    jiunile.local:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        cache 30</span><br><span class="line">        proxy . 192.168.3.108</span><br><span class="line">    &#125;</span><br><span class="line"></span><span class="attr">kind:</span> ConfigMap</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  creationTimestamp:</span> <span class="number">2019</span><span class="bullet">-01</span><span class="bullet">-25</span>T10:<span class="number">19</span>:<span class="number">17</span>Z</span><br><span class="line"><span class="attr">  name:</span> coredns</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">  resourceVersion:</span> <span class="string">"2637234"</span></span><br><span class="line"><span class="attr">  selfLink:</span> /api/v1/namespaces/kube-system/configmaps/coredns</span><br><span class="line"><span class="attr">  uid:</span> ac30bd36<span class="bullet">-208</span>a<span class="bullet">-11e9</span><span class="bullet">-999</span>a<span class="bullet">-02390</span>c37278e</span><br></pre></td></tr></table></figure></p>
<p>æŒ‰å¦‚ä¸Šè¯´æ˜ï¼Œå…·æœ‰.jiunile.localåç¼€çš„ DNS è¯·æ±‚è¢«è½¬å‘åˆ° DNS 192.168.3.108ã€‚Google å…¬å…± DNS æœåŠ¡å™¨ ä¸ºä¸Šæ¸¸æŸ¥è¯¢æä¾›æœåŠ¡ã€‚ä¸‹è¡¨æè¿°äº†å…·æœ‰ç‰¹å®šåŸŸåçš„æŸ¥è¯¢å¦‚ä½•æ˜ å°„åˆ°å®ƒä»¬çš„ç›®æ ‡ DNS æœåŠ¡å™¨ï¼š<br>| åŸŸå      | å“åº”æŸ¥è¯¢çš„æœåŠ¡å™¨  |<br>| :â€”â€”â€“ | :â€”â€”â€“ |<br>| kubernetes.default.svc.cluster.local  | kube-dns |<br>| jiunile.local | è‡ªå®šä¹‰ DNS (192.168.3.108) |<br>| widget.com | ä¸Šæ¸¸ DNS (114.114.114.114, 223.5.5.5å…¶ä¸­ä¹‹ä¸€) |</p>
<p>å¦å¤–æˆ‘ä»¬è¿˜å¯ä»¥ä¸ºæ¯ä¸ª Pod è®¾ç½® DNS ç­–ç•¥ã€‚ å½“å‰ Kubernetes æ”¯æŒä¸¤ç§ Pod ç‰¹å®šçš„ DNS ç­–ç•¥ï¼šâ€œDefaultâ€ å’Œ â€œClusterFirstâ€ã€‚ å¯ä»¥é€šè¿‡<code>dnsPolicy</code>æ ‡å¿—æ¥æŒ‡å®šè¿™äº›ç­–ç•¥ã€‚</p>
<blockquote>
<p><strong><code>æ³¨æ„</code></strong>ï¼šDefault ä¸æ˜¯é»˜è®¤çš„ DNS ç­–ç•¥ã€‚å¦‚æœæ²¡æœ‰æ˜¾å¼åœ°æŒ‡å®šdnsPolicyï¼Œå°†ä¼šä½¿ç”¨ ClusterFirst</p>
</blockquote>
<ul>
<li>å¦‚æœ<code>dnsPolicy</code>è¢«è®¾ç½®ä¸º â€œDefaultâ€ï¼Œåˆ™åå­—è§£æé…ç½®ä¼šç»§æ‰¿è‡ª Pod è¿è¡Œæ‰€åœ¨çš„èŠ‚ç‚¹ã€‚è‡ªå®šä¹‰ä¸Šæ¸¸åŸŸåæœåŠ¡å™¨å’Œå­˜æ ¹åŸŸä¸èƒ½å¤Ÿä¸è¿™ä¸ªç­–ç•¥ä¸€èµ·ä½¿ç”¨</li>
<li>å¦‚æœ<code>dnsPolicy</code>è¢«è®¾ç½®ä¸º â€œClusterFirstâ€ï¼Œè¿™å°±è¦ä¾èµ–äºæ˜¯å¦é…ç½®äº†å­˜æ ¹åŸŸå’Œä¸Šæ¸¸ DNS æœåŠ¡å™¨<ul>
<li>æœªè¿›è¡Œè‡ªå®šä¹‰é…ç½®ï¼šæ²¡æœ‰åŒ¹é…ä¸Šé…ç½®çš„é›†ç¾¤åŸŸååç¼€çš„ä»»ä½•è¯·æ±‚ï¼Œä¾‹å¦‚ â€œwww.kubernetes.ioâ€ï¼Œå°†ä¼šè¢«è½¬å‘åˆ°ç»§æ‰¿è‡ªèŠ‚ç‚¹çš„ä¸Šæ¸¸åŸŸåæœåŠ¡å™¨ã€‚<ul>
<li>è¿›è¡Œè‡ªå®šä¹‰é…ç½®ï¼šå¦‚æœé…ç½®äº†å­˜æ ¹åŸŸå’Œä¸Šæ¸¸ DNS æœåŠ¡å™¨ï¼ˆç±»ä¼¼äº å‰é¢ç¤ºä¾‹ é…ç½®çš„å†…å®¹ï¼‰ï¼ŒDNS æŸ¥è¯¢å°†åŸºäºä¸‹é¢çš„æµç¨‹å¯¹è¯·æ±‚è¿›è¡Œè·¯ç”±ï¼š<ul>
<li>æŸ¥è¯¢é¦–å…ˆè¢«å‘é€åˆ°<code>kube-dns</code>ä¸­çš„ DNS ç¼“å­˜å±‚ã€‚</li>
<li>ä»ç¼“å­˜å±‚ï¼Œæ£€æŸ¥è¯·æ±‚çš„åç¼€ï¼Œå¹¶æ ¹æ®ä¸‹é¢çš„æƒ…å†µè½¬å‘åˆ°å¯¹åº”çš„ DNS ä¸Šï¼š<ul>
<li>å…·æœ‰é›†ç¾¤åç¼€çš„åå­—ï¼ˆä¾‹å¦‚ â€œ.cluster.localâ€ï¼‰ï¼šè¯·æ±‚è¢«å‘é€åˆ° kubednsã€‚</li>
<li>å…·æœ‰å­˜æ ¹åŸŸåç¼€çš„åå­—ï¼ˆä¾‹å¦‚ â€œ.jiunile.localâ€ï¼‰ï¼šè¯·æ±‚è¢«å‘é€åˆ°é…ç½®çš„è‡ªå®šä¹‰ DNS è§£æå™¨ï¼ˆä¾‹å¦‚ï¼šç›‘å¬åœ¨ 192.168.3.108ï¼‰ã€‚</li>
<li>æœªèƒ½åŒ¹é…ä¸Šåç¼€çš„åå­—ï¼ˆä¾‹å¦‚ â€œwidget.comâ€ï¼‰ï¼šè¯·æ±‚è¢«è½¬å‘åˆ°ä¸Šæ¸¸ DNSï¼ˆä¾‹å¦‚ï¼šGoogle å…¬å…± DNS æœåŠ¡å™¨ï¼Œ114.114.114.114 å’Œ 223.5.5.5ï¼‰ã€‚<br><img src="/images/k8s/dns.png" alt="dns"></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="åŸŸåæ ¼å¼"><a href="#åŸŸåæ ¼å¼" class="headerlink" title="åŸŸåæ ¼å¼"></a>åŸŸåæ ¼å¼</h3><p>æˆ‘ä»¬å‰é¢è¯´äº†å¦‚æœæˆ‘ä»¬å»ºç«‹çš„ Service å¦‚æœæ”¯æŒåŸŸåå½¢å¼è¿›è¡Œè§£æï¼Œå°±å¯ä»¥è§£å†³æˆ‘ä»¬çš„æœåŠ¡å‘ç°çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆåˆ©ç”¨ kubedns å¯ä»¥å°† Service ç”Ÿæˆæ€æ ·çš„ DNS è®°å½•å‘¢ï¼Ÿ</p>
<ul>
<li>æ™®é€šçš„ Serviceï¼šä¼šç”Ÿæˆ<code>servicename.namespace.svc.cluster.local</code>çš„åŸŸåï¼Œä¼šè§£æåˆ° Service å¯¹åº”çš„ ClusterIP ä¸Šï¼Œåœ¨ Pod ä¹‹é—´çš„è°ƒç”¨å¯ä»¥ç®€å†™æˆ <code>servicename.namespace</code>ï¼Œå¦‚æœå¤„äºåŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹é¢ï¼Œç”šè‡³å¯ä»¥åªå†™æˆ servicename å³å¯è®¿é—®</li>
<li>Headless Serviceï¼šæ— å¤´æœåŠ¡ï¼Œå°±æ˜¯æŠŠ clusterIP è®¾ç½®ä¸º None çš„ï¼Œä¼šè¢«è§£æä¸ºæŒ‡å®š Pod çš„ IP åˆ—è¡¨ï¼ŒåŒæ ·è¿˜å¯ä»¥é€šè¿‡<code>podname.servicename.namespace.svc.cluster.local</code>è®¿é—®åˆ°å…·ä½“çš„æŸä¸€ä¸ª Podã€‚</li>
</ul>
<blockquote>
<p>CoreDNS å®ç°çš„åŠŸèƒ½å’Œ KubeDNS æ˜¯ä¸€è‡´çš„ï¼Œä¸è¿‡<code>CoreDNS</code>çš„æ‰€æœ‰åŠŸèƒ½éƒ½é›†æˆåœ¨äº†åŒä¸€ä¸ªå®¹å™¨ä¸­ï¼Œåœ¨æœ€æ–°ç‰ˆçš„1.11.0ç‰ˆæœ¬ä¸­å®˜æ–¹å·²ç»æ¨èä½¿ç”¨ <code>CoreDNS</code>äº†ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å®‰è£…CoreDNSæ¥ä»£æ›¿ KubeDNSï¼Œå…¶ä»–ä½¿ç”¨æ–¹æ³•éƒ½æ˜¯ä¸€è‡´çš„ï¼š<a href="https://coredns.io/" target="_blank" rel="external">https://coredns.io/</a></p>
</blockquote>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>ç°åœ¨æˆ‘ä»¬æ¥ä½¿ç”¨ä¸€ä¸ªç®€å• Pod æ¥æµ‹è¯•ä¸‹ Service çš„åŸŸåè®¿é—®ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run --rm -i --tty <span class="built_in">test</span>-dns --image=busybox /bin/sh</span><br><span class="line">If you don<span class="string">'t see a command prompt, try pressing enter.</span><br><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">nameserver 10.96.0.10</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:5</span><br><span class="line">/ #</span></span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬è¿›å…¥åˆ° Pod ä¸­ï¼ŒæŸ¥çœ‹/etc/resolv.confä¸­çš„å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ° nameserver çš„åœ°å€10.96.0.10ï¼Œè¯¥ IP åœ°å€å³æ˜¯åœ¨å®‰è£… kubedns æ’ä»¶çš„æ—¶å€™é›†ç¾¤åˆ†é…çš„ä¸€ä¸ªå›ºå®šçš„é™æ€ IP åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc kube-dns -n kube-system</span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP   62d</span><br></pre></td></tr></table></figure></p>
<p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¿™ä¸ª Pod ç°åœ¨é»˜è®¤çš„ nameserver å°±æ˜¯ kubedns çš„åœ°å€ï¼Œç°åœ¨æˆ‘ä»¬æ¥è®¿é—®ä¸‹å‰é¢æˆ‘ä»¬åˆ›å»ºçš„ nginx-service æœåŠ¡ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># wget -q -O- nginx-service.default.svc.cluster.local</span></span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢æˆ‘ä»¬ä½¿ç”¨ wget å‘½ä»¤å»è®¿é—® nginx-service æœåŠ¡çš„åŸŸåçš„æ—¶å€™è¢« hang ä½äº†ï¼Œæ²¡æœ‰å¾—åˆ°æœŸæœ›çš„ç»“æœï¼Œè¿™æ˜¯å› ä¸ºä¸Šé¢æˆ‘ä»¬å»ºç«‹ Service çš„æ—¶å€™æš´éœ²çš„ç«¯å£æ˜¯ 5000ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># wget -q -O- nginx-service.default.svc.cluster.local:5000</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>åŠ ä¸Š 5000 ç«¯å£ï¼Œå°±æ­£å¸¸è®¿é—®åˆ°æœåŠ¡ï¼Œå†è¯•ä¸€è¯•è®¿é—®ï¼šnginx-service.default.svcã€nginx-service.defaultã€nginx-serviceï¼Œä¸å‡ºæ„å¤–è¿™äº›åŸŸåéƒ½å¯ä»¥æ­£å¸¸è®¿é—®åˆ°æœŸæœ›çš„ç»“æœã€‚</p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å°±å®ç°äº†åœ¨é›†ç¾¤å†…éƒ¨é€šè¿‡ Service çš„åŸŸåå½¢å¼è¿›è¡Œäº’ç›¸é€šä¿¡äº†ï¼Œå¤§å®¶ä¸‹å»è¯•ç€çœ‹çœ‹è®¿é—®ä¸åŒ namespace ä¸‹é¢çš„æœåŠ¡å‘¢ï¼Ÿ</p>
<p>æ¥æºï¼šé˜³æ˜çš„åšå®¢</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[kuberenetes æ“ä½œå®è·µ]]></title>
      <url>http://team.jiunile.com/blog/2019/03/k8s-best-practices.html</url>
      <content type="html"><![CDATA[<h2 id="å¸¸ç”¨æ“ä½œå‘½ä»¤"><a href="#å¸¸ç”¨æ“ä½œå‘½ä»¤" class="headerlink" title="å¸¸ç”¨æ“ä½œå‘½ä»¤"></a>å¸¸ç”¨æ“ä½œå‘½ä»¤</h2><h3 id="å¸¸è§„å‘½ä»¤"><a href="#å¸¸è§„å‘½ä»¤" class="headerlink" title="å¸¸è§„å‘½ä»¤"></a>å¸¸è§„å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®ä¸»æœºå</span></span><br><span class="line">hostnamectl --static <span class="built_in">set</span>-hostname  xxxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–é›†ç¾¤åŠ å…¥ä¿¡æ¯</span></span><br><span class="line">kubeadm token create --print-join-command</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®dockerä»“åº“å£ä»¤</span></span><br><span class="line">kubectl create secret docker-registry registry-secret --docker-server=registry.cn-shanghai.aliyuncs.com --docker-username=xupeng@patsnap --docker-password=patsnap2019! --docker-email=xupeng@patsnap -n ningbo</span><br><span class="line"></span><br><span class="line"><span class="comment"># etcd3.3 nodeçŠ¶æ€æŸ¥çœ‹</span></span><br><span class="line">ETCDCTL_API=3 etcdctl endpoint health --endpoints <span class="string">"https://10.40.20.41:2379,https://10.40.20.46:2379,https://10.40.20.233:2379"</span>   --cacert=/etc/etcd/ssl/etcd-ca.pem  --cert=/etc/etcd/ssl/etcd.pem   --key=/etc/etcd/ssl/etcd-key.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># etcd key æŸ¥çœ‹</span></span><br><span class="line">ETCDCTL_API=3 etcdctl \</span><br><span class="line">--endpoints=https://127.0.0.1:2379 \</span><br><span class="line">--cacert /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert /etc/kubernetes/pki/etcd/peer.crt \</span><br><span class="line">--key /etc/kubernetes/pki/etcd/peer.key \</span><br><span class="line">get /registry/minions/ningbo-db --prefix</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="kubernetes-node-å¸¸ç”¨æ“ä½œå‘½ä»¤"><a href="#kubernetes-node-å¸¸ç”¨æ“ä½œå‘½ä»¤" class="headerlink" title="kubernetes node å¸¸ç”¨æ“ä½œå‘½ä»¤"></a>kubernetes node å¸¸ç”¨æ“ä½œå‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è®¾ç½®node ä¸å¯è°ƒåº¦</span></span><br><span class="line">kubectl cordon k8s-node-1</span><br><span class="line"></span><br><span class="line"><span class="comment">#é©±é€node ä¸Šçš„pod</span></span><br><span class="line">kubectl drain k8s-node-1 --delete-local-data --force --ignore-daemonsets</span><br><span class="line"></span><br><span class="line"><span class="comment">#node é‡æ–°åŠ å…¥</span></span><br><span class="line">kubectl uncordon k8s-node-1</span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ é™¤node</span></span><br><span class="line">kubectl delete node k8s-node-1</span><br><span class="line"></span><br><span class="line"><span class="comment">#è®¾ç½®masterä¸è¿›è¡Œè°ƒåº¦</span></span><br><span class="line">kubectl taint nodes k8s-master node-role.kubernetes.io/master=:NoSchedule</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®label</span></span><br><span class="line">kubectl label node k8s-master project=ipms-app</span><br><span class="line"></span><br><span class="line"><span class="comment">#è®¾ç½®roleæ ‡ç­¾</span></span><br><span class="line">kubectl label node k8s-node-01 node-role.kubernetes.io/node=</span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ é™¤æ ‡ç­¾</span></span><br><span class="line">kubectl label nodes k8s-master mtype-</span><br></pre></td></tr></table></figure>
<h2 id="å¦‚ä½•è°ƒæ•´ç½‘ç»œæ’ä»¶"><a href="#å¦‚ä½•è°ƒæ•´ç½‘ç»œæ’ä»¶" class="headerlink" title="å¦‚ä½•è°ƒæ•´ç½‘ç»œæ’ä»¶"></a>å¦‚ä½•è°ƒæ•´ç½‘ç»œæ’ä»¶</h2><blockquote>
<p>calicoç½‘ç»œæ’ä»¶è°ƒæ•´ï¼ŒåŸæœ¬æ²¡ä½¿ç”¨IPIPæ¨¡å¼ï¼Œç°åœ¨éœ€è¦ä½¿ç”¨CrossSubnet</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å…ˆåˆ é™¤åŸæœ¬çš„calicoæ’ä»¶</span></span><br><span class="line">kubectl delete <span class="_">-f</span> calico.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹calico.yamlï¼Œå°†CALICO_IPV4POOL_IPIPè°ƒæ•´ä¸ºCrossSubnet</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯ç”¨calicoæ’ä»¶</span></span><br><span class="line">kubectl apply <span class="_">-f</span> calico.yaml</span><br></pre></td></tr></table></figure>
<h2 id="å¦‚ä½•å°†kubeProxyçš„iptablesä¿®æ”¹ä¸ºipvs"><a href="#å¦‚ä½•å°†kubeProxyçš„iptablesä¿®æ”¹ä¸ºipvs" class="headerlink" title="å¦‚ä½•å°†kubeProxyçš„iptablesä¿®æ”¹ä¸ºipvs"></a>å¦‚ä½•å°†kubeProxyçš„iptablesä¿®æ”¹ä¸ºipvs</h2><h3 id="1-åŠ è½½å†…æ ¸æ¨¡å—"><a href="#1-åŠ è½½å†…æ ¸æ¨¡å—" class="headerlink" title="1. åŠ è½½å†…æ ¸æ¨¡å—"></a>1. åŠ è½½å†…æ ¸æ¨¡å—</h3><p>æŸ¥çœ‹å†…æ ¸æ¨¡å—æ˜¯å¦åŠ è½½<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod|grep ip_vs</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœæ²¡æœ‰åŠ è½½ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åŠ è½½ipvsç›¸å…³æ¨¡å—<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4</span><br></pre></td></tr></table></figure></p>
<h3 id="2-æ›´æ”¹kube-proxyé…ç½®"><a href="#2-æ›´æ”¹kube-proxyé…ç½®" class="headerlink" title="2. æ›´æ”¹kube-proxyé…ç½®"></a>2. æ›´æ”¹kube-proxyé…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit configmap kube-proxy -n kube-system</span><br></pre></td></tr></table></figure>
<p>æ‰¾åˆ°å¹¶ä¿®æ”¹å¦‚ä¸‹éƒ¨åˆ†çš„å†…å®¹<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">enableProfiling:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">10256</span></span><br><span class="line"><span class="attr">hostnameOverride:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">iptables:</span></span><br><span class="line"><span class="attr">  masqueradeAll:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  masqueradeBit:</span> <span class="number">14</span></span><br><span class="line"><span class="attr">  minSyncPeriod:</span> <span class="number">0</span>s</span><br><span class="line"><span class="attr">  syncPeriod:</span> <span class="number">30</span>s</span><br><span class="line"><span class="attr">ipvs:</span></span><br><span class="line"><span class="attr">  excludeCIDRs:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">  minSyncPeriod:</span> <span class="number">0</span>s</span><br><span class="line"><span class="attr">  scheduler:</span> <span class="string">""</span>  <span class="comment">#=========================&gt; ä¸ºç©ºè¡¨ç¤ºé»˜è®¤çš„è´Ÿè½½å‡è¡¡ç®—æ³•ä¸ºè½®è¯¢ï¼Œ rr, wrr, lc, wlc, sh, dh, lblc...</span></span><br><span class="line"><span class="attr">  syncPeriod:</span> <span class="number">30</span>s</span><br><span class="line"><span class="attr">kind:</span> KubeProxyConfiguration</span><br><span class="line"><span class="attr">metricsBindAddress:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">10249</span></span><br><span class="line"><span class="attr">mode:</span> iptables   <span class="comment">#=========================&gt; ä¿®æ”¹æ­¤å¤„ä¸ºipvs</span></span><br><span class="line"><span class="attr">nodePortAddresses:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">oomScoreAdj:</span> <span class="bullet">-999</span></span><br><span class="line"><span class="attr">portRange:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">resourceContainer:</span> /kube-proxy</span><br><span class="line"><span class="attr">udpIdleTimeout:</span> <span class="number">250</span>ms</span><br></pre></td></tr></table></figure></p>
<p>ç¼–è¾‘å®Œï¼Œä¿å­˜é€€å‡º</p>
<h3 id="3-åˆ é™¤æ‰€æœ‰kube-proxyçš„pod"><a href="#3-åˆ é™¤æ‰€æœ‰kube-proxyçš„pod" class="headerlink" title="3. åˆ é™¤æ‰€æœ‰kube-proxyçš„pod"></a>3. åˆ é™¤æ‰€æœ‰kube-proxyçš„pod</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod $(kubectl get pod -n kube-system | grep kube-proxy | awk -F <span class="string">' '</span> <span class="string">'&#123;print $1&#125;'</span>) -n kube-system</span><br></pre></td></tr></table></figure>
<h3 id="4-æŸ¥çœ‹kube-proxyçš„podæ—¥å¿—"><a href="#4-æŸ¥çœ‹kube-proxyçš„podæ—¥å¿—" class="headerlink" title="4. æŸ¥çœ‹kube-proxyçš„podæ—¥å¿—"></a>4. æŸ¥çœ‹kube-proxyçš„podæ—¥å¿—</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs kube-proxy-xxx -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment">#I0308 02:16:02.980965       1 server_others.go:183] Using ipvs Proxier.</span></span><br><span class="line"><span class="comment">#W0308 02:16:02.991188       1 proxier.go:356] IPVS scheduler not specified, use rr by default</span></span><br><span class="line"><span class="comment">#I0308 02:16:02.991338       1 server_others.go:210] Tearing down inactive rules.</span></span><br><span class="line"><span class="comment">#I0308 02:16:03.022123       1 server.go:448] Version: v1.11.6</span></span><br><span class="line"><span class="comment">#I0308 02:16:03.028801       1 conntrack.go:98] Set sysctl 'net/netfilter/nf_conntrack_max' to 131072</span></span><br><span class="line"><span class="comment">#I0308 02:16:03.029030       1 conntrack.go:52] Setting nf_conntrack_max to 131072</span></span><br><span class="line"><span class="comment">#I0308 02:16:03.029208       1 conntrack.go:98] Set sysctl 'net/netfilter/nf_conntrack_tcp_timeout_established' to 86400</span></span><br><span class="line"><span class="comment">#I0308 02:16:03.029296       1 conntrack.go:98] Set sysctl 'net/netfilter/nf_conntrack_tcp_timeout_close_wait' to 3600</span></span><br><span class="line"><span class="comment">#I0308 02:16:03.029639       1 config.go:102] Starting endpoints config controller</span></span><br><span class="line"><span class="comment">#I0308 02:16:03.029682       1 controller_utils.go:1025] Waiting for caches to sync for endpoints config controller</span></span><br><span class="line"><span class="comment">#I0308 02:16:03.029723       1 config.go:202] Starting service config controller</span></span><br><span class="line"><span class="comment">#I0308 02:16:03.029777       1 controller_utils.go:1025] Waiting for caches to sync for service config controller</span></span><br><span class="line"><span class="comment">#I0308 02:16:03.129930       1 controller_utils.go:1032] Caches are synced for endpoints config controller</span></span><br><span class="line"><span class="comment">#I0308 02:16:03.129931       1 controller_utils.go:1032] Caches are synced for service config controller</span></span><br><span class="line"></span><br><span class="line">çœ‹åˆ°æœ‰ Using ipvs Proxier å³è¡¨æ˜åˆ‡æ¢æˆåŠŸ.</span><br></pre></td></tr></table></figure>
<h3 id="5-å®‰è£…ipvsadm"><a href="#5-å®‰è£…ipvsadm" class="headerlink" title="5. å®‰è£…ipvsadm"></a>5. å®‰è£…ipvsadm</h3><p>ä½¿ç”¨ipvsadmæŸ¥çœ‹ipvsç›¸å…³è§„åˆ™ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªå‘½ä»¤å¯ä»¥ç›´æ¥yumå®‰è£…<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install ipvsadm</span><br></pre></td></tr></table></figure></p>
<h2 id="kubelet-GC-æœºåˆ¶åŠå¯¹åº”é…ç½®"><a href="#kubelet-GC-æœºåˆ¶åŠå¯¹åº”é…ç½®" class="headerlink" title="kubelet GC æœºåˆ¶åŠå¯¹åº”é…ç½®"></a>kubelet GC æœºåˆ¶åŠå¯¹åº”é…ç½®</h2><blockquote>
<p>å¯é€šè¿‡kubelet gcçš„èƒ½åŠ›æ¥è‡ªåŠ¨æ¸…ç†æ— ç”¨çš„containerä»¥åŠimageï¼Œä»è€Œæ¥é‡Šæ”¾ç£ç›˜ç©ºé—´ã€‚kubeletä¼šå¯åŠ¨ä¸¤ä¸ªGCï¼Œåˆ†åˆ«å›æ”¶containerå’Œimageã€‚å…¶ä¸­containerçš„å›æ”¶é¢‘ç‡ä¸º1åˆ†é’Ÿä¸€æ¬¡ï¼Œè€Œimageå›æ”¶é¢‘ç‡ä¸º2åˆ†é’Ÿä¸€æ¬¡ã€‚</p>
</blockquote>
<h3 id="å®¹å™¨GC"><a href="#å®¹å™¨GC" class="headerlink" title="å®¹å™¨GC"></a>å®¹å™¨GC</h3><blockquote>
<p>é€€å‡ºçš„å®¹å™¨ä¹Ÿä¼šç»§ç»­å ç”¨ç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚è¿˜ä¼šåœ¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨å¾ˆå¤šæ•°æ®ã€docker åº”ç”¨ä¹Ÿè¦å ç”¨ CPU å’Œå†…å­˜å»ç»´æŠ¤è¿™äº›å®¹å™¨ã€‚docker æœ¬èº«å¹¶ä¸ä¼šè‡ªåŠ¨åˆ é™¤å·²ç»é€€å‡ºçš„å®¹å™¨ï¼Œå› æ­¤ kubelet å°±è´Ÿèµ·äº†è¿™ä¸ªè´£ä»»ã€‚kubelet å®¹å™¨çš„å›æ”¶æ˜¯ä¸ºäº†åˆ é™¤å·²ç»é€€å‡ºçš„å®¹å™¨ä»¥èŠ‚çœèŠ‚ç‚¹çš„ç©ºé—´ï¼Œæå‡æ€§èƒ½ã€‚å®¹å™¨ GC è™½ç„¶æœ‰åˆ©äºç©ºé—´å’Œæ€§èƒ½ï¼Œä½†æ˜¯åˆ é™¤å®¹å™¨ä¹Ÿä¼šå¯¼è‡´é”™è¯¯ç°åœºè¢«æ¸…ç†ï¼Œä¸åˆ©äº debug å’Œé”™è¯¯å®šä½ï¼Œå› æ­¤ä¸å»ºè®®æŠŠæ‰€æœ‰é€€å‡ºçš„å®¹å™¨éƒ½åˆ é™¤ã€‚å› æ­¤å®¹å™¨çš„æ¸…ç†éœ€è¦ä¸€å®šçš„ç­–ç•¥ï¼Œä¸»è¦æ˜¯å‘Šè¯‰ kubelet ä½ è¦ä¿å­˜å¤šå°‘å·²ç»é€€å‡ºçš„å®¹å™¨ã€‚å’Œå®¹å™¨ GC æœ‰å…³çš„å¯ä»¥é…ç½®çš„ kubelet å¯åŠ¨å‚æ•° <code>/var/lib/kubelet/config.yaml</code></p>
</blockquote>
<ul>
<li><code>MinimumGCAge</code>ï¼šcontainer ç»“æŸå¤šé•¿æ—¶é—´ä¹‹åæ‰èƒ½å¤Ÿè¢«å›æ”¶ï¼Œé»˜è®¤æ˜¯ä¸€åˆ†é’Ÿ</li>
<li><code>MaxPerPodContainerCount</code>ï¼šæ¯ä¸ª container æœ€ç»ˆå¯ä»¥ä¿å­˜å¤šå°‘ä¸ªå·²ç»ç»“æŸçš„å®¹å™¨ï¼Œé»˜è®¤æ˜¯ 1ï¼Œè®¾ç½®ä¸ºè´Ÿæ•°è¡¨ç¤ºä¸åšé™åˆ¶</li>
<li><code>MaxContainerCount</code>ï¼šèŠ‚ç‚¹ä¸Šæœ€å¤šèƒ½ä¿ç•™å¤šå°‘ä¸ªç»“æŸçš„å®¹å™¨ï¼Œé»˜è®¤æ˜¯ -1ï¼Œè¡¨ç¤ºä¸åšé™åˆ¶</li>
</ul>
<p>gcçš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>è·å–å¯ä»¥æ¸…é™¤çš„å®¹å™¨ï¼Œè¿™äº›å®¹å™¨éƒ½æ˜¯éæ´»åŠ¨çš„ï¼Œå¹¶ä¸”åˆ›å»ºæ—¶é—´æ¯” gcPolicy.MinAge è¦æ—©</li>
<li>é€šè¿‡å¼ºåˆ¶æ‰§è¡Œ gcPolicy.MaxPerPodContainerï¼Œä¸ºæ¯ä¸ªpodåˆ é™¤æœ€è€çš„æ­»äº¡å®¹å™¨</li>
<li>é€šè¿‡å¼ºåˆ¶æ‰§è¡Œ gcPolicy.MaxContainers æ¥ç§»é™¤æœ€è€çš„æ­»äº¡å®¹å™¨</li>
<li>è·å–æœªå‡†å¤‡å¥½ä¸”ä¸åŒ…å«å®¹å™¨çš„å¯æ¸…é™¤æ²™ç®±</li>
<li>ç§»é™¤å¯ç§»é™¤çš„æ²™ç®±</li>
</ol>
<h3 id="é•œåƒGC"><a href="#é•œåƒGC" class="headerlink" title="é•œåƒGC"></a>é•œåƒGC</h3><blockquote>
<p>é•œåƒä¸»è¦å ç”¨ç£ç›˜ç©ºé—´ï¼Œè™½ç„¶ docker ä½¿ç”¨é•œåƒåˆ†å±‚å¯ä»¥è®©å¤šä¸ªé•œåƒå…±äº«å­˜å‚¨ï¼Œä½†æ˜¯é•¿æ—¶é—´è¿è¡Œçš„èŠ‚ç‚¹å¦‚æœä¸‹è½½äº†å¾ˆå¤šé•œåƒä¹Ÿä¼šå¯¼è‡´å ç”¨çš„å­˜å‚¨ç©ºé—´è¿‡å¤šã€‚å¦‚æœé•œåƒå¯¼è‡´ç£ç›˜è¢«å æ»¡ï¼Œä¼šé€ æˆåº”ç”¨æ— æ³•æ­£å¸¸å·¥ä½œã€‚docker é»˜è®¤ä¹Ÿä¸ä¼šåšé•œåƒæ¸…ç†ï¼Œé•œåƒä¸€æ—¦ä¸‹è½½å°±ä¼šæ°¸è¿œç•™åœ¨æœ¬åœ°ï¼Œé™¤éè¢«æ‰‹åŠ¨åˆ é™¤ã€‚å…¶å®å¾ˆå¤šé•œåƒå¹¶æ²¡æœ‰è¢«å®é™…ä½¿ç”¨ï¼Œè¿™äº›ä¸ç”¨çš„é•œåƒç»§ç»­å ç”¨ç©ºé—´æ˜¯éå¸¸å¤§çš„æµªè´¹ï¼Œä¹Ÿæ˜¯å·¨å¤§çš„éšæ‚£ï¼Œå› æ­¤ kubelet ä¹Ÿä¼šå‘¨æœŸæ€§åœ°å»æ¸…ç†é•œåƒã€‚é•œåƒçš„æ¸…ç†å’Œå®¹å™¨ä¸åŒï¼Œæ˜¯ä»¥å ç”¨çš„ç©ºé—´ä½œä¸ºæ ‡å‡†çš„ï¼Œç”¨æˆ·å¯ä»¥é…ç½®å½“é•œåƒå æ®å¤šå¤§æ¯”ä¾‹çš„å­˜å‚¨ç©ºé—´æ—¶æ‰è¿›è¡Œæ¸…ç†ã€‚æ¸…ç†çš„æ—¶å€™ä¼šä¼˜å…ˆæ¸…ç†æœ€ä¹…æ²¡æœ‰è¢«ä½¿ç”¨çš„é•œåƒï¼Œé•œåƒè¢« pull ä¸‹æ¥æˆ–è€…è¢«å®¹å™¨ä½¿ç”¨éƒ½ä¼šæ›´æ–°å®ƒçš„æœ€è¿‘ä½¿ç”¨æ—¶é—´ã€‚å¯åŠ¨ kubelet çš„æ—¶å€™ï¼Œå¯ä»¥é…ç½®è¿™äº›å‚æ•°æ§åˆ¶é•œåƒæ¸…ç†çš„ç­–ç•¥ <code>/var/lib/kubelet/config.yaml</code></p>
</blockquote>
<ul>
<li><code>imageMinimumGCAge</code>ï¼šé•œåƒæœ€å°‘å¤šä¹…æ²¡æœ‰è¢«ä½¿ç”¨æ‰ä¼šè¢«æ¸…ç†</li>
<li><code>imageGCHighThresholdPercent</code>ï¼šç£ç›˜ä½¿ç”¨ç‡çš„ä¸Šé™ï¼Œå½“è¾¾åˆ°è¿™ä¸€ä½¿ç”¨ç‡çš„æ—¶å€™ä¼šè§¦å‘é•œåƒæ¸…ç†ã€‚é»˜è®¤å€¼ä¸º 90%</li>
<li><code>imageGCLowThresholdPercent</code>ï¼šç£ç›˜ä½¿ç”¨ç‡çš„ä¸‹é™ï¼Œæ¯æ¬¡æ¸…ç†ç›´åˆ°ä½¿ç”¨ç‡ä½äºè¿™ä¸ªå€¼æˆ–è€…æ²¡æœ‰å¯ä»¥æ¸…ç†çš„é•œåƒäº†æ‰ä¼šåœæ­¢.é»˜è®¤å€¼ä¸º 80%</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå½“é•œåƒå æ»¡æ‰€åœ¨ç›˜ 90% å®¹é‡çš„æ—¶å€™ï¼Œkubelet å°±ä¼šè¿›è¡Œæ¸…ç†ï¼Œä¸€ç›´åˆ°é•œåƒå ç”¨ç‡ä½äº 80% ä¸ºæ­¢ã€‚</p>
<h2 id="ä½¿ç”¨kubeadmè¿›è¡Œclusterå‡çº§"><a href="#ä½¿ç”¨kubeadmè¿›è¡Œclusterå‡çº§" class="headerlink" title="ä½¿ç”¨kubeadmè¿›è¡Œclusterå‡çº§"></a>ä½¿ç”¨kubeadmè¿›è¡Œclusterå‡çº§</h2><blockquote>
<p>ä½¿ç”¨kubeadm å®‰è£…å¥½åkubernetesï¼Œåç»­å¦‚ä½•è¿›è¡Œå‡çº§ï¼Œå‡çº§ kubernetesé›†ç¾¤ï¼Œåªèƒ½é€ç‰ˆæœ¬å‡çº§ã€‚åªèƒ½ä» 1.12 å‡çº§åˆ° 1.13 è€Œä¸èƒ½ä» 1.1 ç›´æ¥å‡çº§åˆ° 1.13ï¼Œå‡çº§æ­¥éª¤ï¼š 1.11â€”&gt;1.12â€”&gt;1.13â€”&gt;1.14</p>
</blockquote>
<p>éœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œkubernetesä»1.11ç‰ˆæœ¬å¼€å§‹å˜åŒ–æ¯”è¾ƒå¤§ï¼ŒCoreDNSå·²ä½œä¸ºé»˜è®¤DNSã€‚<br><code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code>ä¸­çš„ç¯å¢ƒå˜é‡è¢«åˆ†é…ä¸ºä¸‰ä¸ªæ–‡ä»¶ï¼š<code>/var/lib/kubelet/config.yaml</code> (å…¶ä¸­cgroupé©±åŠ¨é»˜è®¤cgroupfs)ã€<code>/var/lib/kubelet/kubeadm-flags.env</code> (cgroupé©±åŠ¨é»˜è®¤systemdï¼Œä¼˜å…ˆæƒ)ã€<code>/etc/sysconfig/kubelet</code><br>å…¨æ–°å®‰è£…çš„kubernetesé›†ç¾¤æ˜¯æœ‰ç½‘ç»œCNIé…ç½®çš„ï¼Œå‡çº§å®‰è£…çš„æ˜¯æ²¡æœ‰CNIé…ç½®çš„ï¼Œé…ç½®æ–‡ä»¶<code>/var/lib/kubelet/kubeadm-flags.env</code>ã€‚ä¾èµ–çš„é•œåƒtagæŠ¬å¤´ä»<code>gcr.io/google_containers</code>å˜æˆ<code>k8s.gcr.io</code>ï¼Œå‡çº§åŸºæœ¬ä½¿ç”¨gcr.io/google<em>containersï¼Œå…¨æ–°å®‰è£…åˆ™ä½¿ç”¨<code>k8s.gcr.io</code>&gt;</em>&lt;</p>
<blockquote>
<p>ä»1.8å¼€å§‹ä¸ºkube-proxyç»„ä»¶å¼•å…¥äº†IPVSæ¨¡å¼ï¼Œ1.11ç‰ˆæœ¬å¼€å§‹æ­£å¼æ”¯æŒIPVSï¼Œé»˜è®¤ä¸å¼€å¯ï¼Œ1.12ä»¥ä¸Šç‰ˆæœ¬é»˜è®¤å¼€å¯ï¼Œä¸å¼€å¯åˆ™ä½¿ç”¨iptablesæ¨¡å¼</p>
</blockquote>
<h3 id="å‡†å¤‡å‡çº§é•œåƒ"><a href="#å‡†å¤‡å‡çº§é•œåƒ" class="headerlink" title="å‡†å¤‡å‡çº§é•œåƒ"></a>å‡†å¤‡å‡çº§é•œåƒ</h3><p>æå‰å‡†å¤‡å¥½å‡çº§æ‰€éœ€çš„é•œåƒimageï¼Œå¹¶æ‰“æˆå®˜æ–¹æ ‡å‡†tagã€‚<br>masterèŠ‚ç‚¹éœ€è¦æ‰€æœ‰é•œåƒï¼ŒnodeèŠ‚ç‚¹ä»…éœ€è¦proxyã€pauseé•œåƒ</p>
<h4 id="åœ¨æ‰€æœ‰MasterèŠ‚ç‚¹ä¸‹è½½å„ç‰ˆæœ¬é•œåƒ"><a href="#åœ¨æ‰€æœ‰MasterèŠ‚ç‚¹ä¸‹è½½å„ç‰ˆæœ¬é•œåƒ" class="headerlink" title="åœ¨æ‰€æœ‰MasterèŠ‚ç‚¹ä¸‹è½½å„ç‰ˆæœ¬é•œåƒ"></a>åœ¨æ‰€æœ‰MasterèŠ‚ç‚¹ä¸‹è½½å„ç‰ˆæœ¬é•œåƒ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.12.7</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/kube-proxy:v1.12.7</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/kube-scheduler:v1.12.7</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/kube-controller-manager:v1.12.7</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/kube-apiserver:v1.12.7</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/etcd:3.2.24</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/pause:3.1</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/coredns:1.2.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1.13.5</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/kube-proxy:v1.13.5</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/kube-scheduler:v1.13.5</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/kube-controller-manager:v1.13.5</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/kube-apiserver:v1.13.5</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/etcd:3.2.24</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/pause:3.1</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/coredns:1.2.6</span></span><br></pre></td></tr></table></figure>
<h4 id="NodeèŠ‚ç‚¹ä¸‹è½½å„ç‰ˆæœ¬é•œåƒ"><a href="#NodeèŠ‚ç‚¹ä¸‹è½½å„ç‰ˆæœ¬é•œåƒ" class="headerlink" title="NodeèŠ‚ç‚¹ä¸‹è½½å„ç‰ˆæœ¬é•œåƒ"></a>NodeèŠ‚ç‚¹ä¸‹è½½å„ç‰ˆæœ¬é•œåƒ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#k8s.gcr.io/kube-proxy:v1.12.7</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/kube-proxy:v1.13.5</span></span><br><span class="line"><span class="comment">#k8s.gcr.io/pause:3.1</span></span><br></pre></td></tr></table></figure>
<h3 id="1-11-6å‡çº§åˆ°1-12-7"><a href="#1-11-6å‡çº§åˆ°1-12-7" class="headerlink" title="1.11.6å‡çº§åˆ°1.12.7"></a>1.11.6å‡çº§åˆ°1.12.7</h3><h4 id="masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å†…éƒ¨etcdï¼‰"><a href="#masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å†…éƒ¨etcdï¼‰" class="headerlink" title="masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å†…éƒ¨etcdï¼‰"></a>masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å†…éƒ¨etcdï¼‰</h4><h5 id="å‰ç½®å‡†å¤‡"><a href="#å‰ç½®å‡†å¤‡" class="headerlink" title="å‰ç½®å‡†å¤‡"></a>å‰ç½®å‡†å¤‡</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åœ¨æ‰€æœ‰masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤</span></span><br><span class="line">kubectl get configmap -n kube-system kubeadm-config -o yaml &gt; kubeadm-config-cm.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¼–è¾‘ç¬¬ä¸€å°masterèŠ‚ç‚¹kubeadm-config-cm.yamlé…ç½®ï¼Œä¿®æ”¹ä»¥ä¸‹å‚æ•°</span></span><br><span class="line">api.advertiseAddress <span class="comment">#---&gt; å½“å‰master ipåœ°å€</span></span><br><span class="line">etcd.local.extraArgs.advertise-client-urls <span class="comment">#---&gt; å½“å‰master ipåœ°å€</span></span><br><span class="line">etcd.local.extraArgs.initial-advertise-peer-urls <span class="comment">#---&gt; å½“å‰master ipåœ°å€</span></span><br><span class="line">etcd.local.extraArgs.listen-client-urls <span class="comment">#---&gt; å½“å‰master ipåœ°å€</span></span><br><span class="line">etcd.local.extraArgs.listen-peer-urls <span class="comment">#---&gt; å½“å‰master ipåœ°å€</span></span><br><span class="line">etcd.local.extraArgs.initial-cluster <span class="comment">#---&gt; å½“å‰master ipåœ°å€å’Œmasterä¸»æœºåï¼Œä¾‹å¦‚ï¼š"ip-172-31-92-42=https://172.31.92.42:2380,ip-172-31-89-186=https://172.31.89.186:2380,ip-172-31-90-42=https://172.31.90.42:2380"</span></span><br><span class="line"></span><br><span class="line">You must also pass an additional argument (initial-cluster-state: existing) to etcd.local.extraArgs.</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¼–è¾‘å…¶ä½™masterä¸»æœºä¸Šçš„kubeadm-config-cm.yaml ä¿®æ”¹ClusterConfigurationä»¥ä¸‹å‚æ•°ï¼š</span></span><br><span class="line">etcd.local.extraArgs.advertise-client-urls <span class="comment">#---&gt; å½“å‰master ipåœ°å€</span></span><br><span class="line">etcd.local.extraArgs.initial-advertise-peer-urls <span class="comment">#---&gt; å½“å‰master ipåœ°å€</span></span><br><span class="line">etcd.local.extraArgs.listen-client-urls <span class="comment">#---&gt; å½“å‰master ipåœ°å€</span></span><br><span class="line">etcd.local.extraArgs.listen-peer-urls <span class="comment">#---&gt; å½“å‰master ipåœ°å€</span></span><br><span class="line"></span><br><span class="line">You must also modify the ClusterStatus to add a mapping <span class="keyword">for</span> the current host under apiEndpoints.</span><br></pre></td></tr></table></figure>
<h5 id="å¼€å§‹masterå‡çº§"><a href="#å¼€å§‹masterå‡çº§" class="headerlink" title="å¼€å§‹masterå‡çº§"></a>å¼€å§‹masterå‡çº§</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è®¾ç½®å‡çº§dockerçš„èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦ï¼Œå¹¶ä¸”å°†å‰©ä½™çš„podé©±é€ï¼Œé€šè¿‡kubectl get nodeså‘½ä»¤çœ‹åˆ°è¯¥èŠ‚ç‚¹å·²è¢«æ ‡è®°ä¸å¯è°ƒåº¦</span></span><br><span class="line">kubectl cordon masterå…¶ä¸­ä¸€å°çš„èŠ‚ç‚¹å</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¿½ç•¥äº†æ‰€æœ‰çš„daemonsetçš„podï¼Œå¹¶ä¸”å°†å‰©ä½™çš„podé©±é€</span></span><br><span class="line">kubectl drain masterå…¶ä¸­ä¸€å°çš„èŠ‚ç‚¹å --ignore-daemonsets --delete-local-data</span><br><span class="line"></span><br><span class="line"><span class="comment">#å…ˆå‡çº§kubeadm</span></span><br><span class="line">yum install -y kubeadm-1.12.7 kubelet-1.12.7 kubectl-1.12.7 kubernetes-cni-0.7.5-0</span><br><span class="line"></span><br><span class="line">æ‰§è¡Œå‡çº§ï¼Œç¡®ä¿ä¸Šé¢å·²ç»å‡†å¤‡å¥½é•œåƒimage</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å‡çº§è®¡åˆ’</span></span><br><span class="line">kubeadm upgrade plan</span><br><span class="line"></span><br><span class="line"><span class="comment">#å‡çº§ç¬¬ä¸€å°masterèŠ‚ç‚¹</span></span><br><span class="line">kubectl apply <span class="_">-f</span> kubeadm-config-cm.yaml --force</span><br><span class="line">kubeadm upgrade apply v1.12.7</span><br><span class="line"></span><br><span class="line"><span class="comment">#å‡çº§å…¶ä½™masterèŠ‚ç‚¹</span></span><br><span class="line">kubectl annotate node &lt;nodename&gt; kubeadm.alpha.kubernetes.io/cri-socket=/var/run/dockershim.sock</span><br><span class="line">kubectl apply <span class="_">-f</span> kubeadm-config-cm.yaml --force</span><br><span class="line">kubeadm upgrade apply v1.12.7</span><br><span class="line"></span><br><span class="line"><span class="comment">#çœ‹åˆ°å¦‚ä¸‹ï¼Œè¯´æ˜å‡çº§æˆåŠŸ</span></span><br><span class="line">[upgrade/successful] SUCCESS! Your cluster was upgraded to <span class="string">"v1.12.7"</span>. Enjoy!</span><br><span class="line">[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets <span class="keyword">in</span> turn.</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®¹å™¨è¿›è¡Œåˆå§‹åŒ–ï¼ŒæŸ¥çœ‹ç³»ç»ŸæœåŠ¡podæ˜¯å¦æ¢å¤æ­£å¸¸è¿è¡Œã€‚</span></span><br><span class="line">kubectl get pod -o wide --all-namespaces</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¡®ä¿å®¹å™¨AGEåœ¨ä¸€åˆ†é’Ÿä»¥ä¸Šï¼Œå†é‡å¯æœåŠ¡</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹masterèŠ‚ç‚¹ç‰ˆæœ¬å·²æˆåŠŸå‡çº§</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¢å¤è°ƒåº¦</span></span><br><span class="line">kubectl uncordon masterèŠ‚ç‚¹åç§°</span><br></pre></td></tr></table></figure>
<h4 id="masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å¤–éƒ¨etcdï¼‰"><a href="#masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å¤–éƒ¨etcdï¼‰" class="headerlink" title="masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å¤–éƒ¨etcdï¼‰"></a>masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å¤–éƒ¨etcdï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åœ¨æ‰€æœ‰masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤</span></span><br><span class="line">kubectl get configmap -n kube-system kubeadm-config -o jsonpath=&#123;.data.MasterConfiguration&#125; &gt; kubeadm-config.yaml</span><br><span class="line"></span><br><span class="line">ç¼–è¾‘kubeadm-config.yaml, ä¿®æ”¹api.advertiseAddresså€¼ä¸ºå½“å‰masterçš„ipåœ°å€</span><br><span class="line"></span><br><span class="line"><span class="comment">#è®¾ç½®å‡çº§dockerçš„èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦ï¼Œå¹¶ä¸”å°†å‰©ä½™çš„podé©±é€ï¼Œé€šè¿‡kubectl get nodeså‘½ä»¤çœ‹åˆ°è¯¥èŠ‚ç‚¹å·²è¢«æ ‡è®°ä¸å¯è°ƒåº¦</span></span><br><span class="line">kubectl cordon masterå…¶ä¸­ä¸€å°çš„èŠ‚ç‚¹å</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¿½ç•¥äº†æ‰€æœ‰çš„daemonsetçš„podï¼Œå¹¶ä¸”å°†å‰©ä½™çš„podé©±é€</span></span><br><span class="line">kubectl drain masterå…¶ä¸­ä¸€å°çš„èŠ‚ç‚¹å --ignore-daemonsets --delete-local-data</span><br><span class="line"></span><br><span class="line"><span class="comment">#å…ˆå‡çº§kubeadm</span></span><br><span class="line">yum install -y kubeadm-1.12.3 kubelet-1.12.7 kubectl-1.12.7 kubernetes-cni-0.7.5-0</span><br><span class="line"></span><br><span class="line">æ‰§è¡Œå‡çº§ï¼Œç¡®ä¿ä¸Šé¢å·²ç»å‡†å¤‡å¥½é•œåƒimage</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å‡çº§è®¡åˆ’</span></span><br><span class="line">kubeadm upgrade plan</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ­£å¼å‡çº§å‘½ä»¤</span></span><br><span class="line">kubeadm upgrade apply v1.12.7 --config kubeadm-config.yaml</span><br><span class="line"><span class="comment">#çœ‹åˆ°å¦‚ä¸‹ï¼Œè¯´æ˜å‡çº§æˆåŠŸ</span></span><br><span class="line">[upgrade/successful] SUCCESS! Your cluster was upgraded to <span class="string">"v1.12.3"</span>. Enjoy!</span><br><span class="line">[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets <span class="keyword">in</span> turn.</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®¹å™¨è¿›è¡Œåˆå§‹åŒ–ï¼ŒæŸ¥çœ‹ç³»ç»ŸæœåŠ¡podæ˜¯å¦æ¢å¤æ­£å¸¸è¿è¡Œã€‚</span></span><br><span class="line">kubectl get pod -o wide --all-namespaces</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¡®ä¿å®¹å™¨AGEåœ¨ä¸€åˆ†é’Ÿä»¥ä¸Šï¼Œå†é‡å¯æœåŠ¡</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹masterèŠ‚ç‚¹ç‰ˆæœ¬å·²æˆåŠŸå‡çº§</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¢å¤è°ƒåº¦</span></span><br><span class="line">kubectl uncordon masterèŠ‚ç‚¹åç§°</span><br></pre></td></tr></table></figure>
<h4 id="nodeèŠ‚ç‚¹"><a href="#nodeèŠ‚ç‚¹" class="headerlink" title="nodeèŠ‚ç‚¹"></a>nodeèŠ‚ç‚¹</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è®¾ç½®å‡çº§kubernetesçš„èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦ï¼Œå¹¶ä¸”å°†å‰©ä½™çš„podé©±é€ï¼Œé€šè¿‡kubectl get nodeså‘½ä»¤çœ‹åˆ°è¯¥èŠ‚ç‚¹å·²è¢«æ ‡è®°ä¸å¯è°ƒåº¦</span></span><br><span class="line">kubectl cordon nodeå…¶ä¸­ä¸€å°çš„èŠ‚ç‚¹å</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¿½ç•¥äº†æ‰€æœ‰çš„daemonsetçš„podï¼Œå¹¶ä¸”å°†å‰©ä½™çš„podé©±é€</span></span><br><span class="line">kubectl drain nodeå…¶ä¸­ä¸€å°çš„èŠ‚ç‚¹å --ignore-daemonsets --delete-local-data</span><br><span class="line"></span><br><span class="line"><span class="comment">#èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œå‡çº§kubelet kubeadm kubectl</span></span><br><span class="line">yum install -y kubeadm-1.12.7 kubelet-1.12.7 kubectl-1.12.7 kubernetes-cni-0.7.5-0</span><br><span class="line"></span><br><span class="line"><span class="comment">#å‡çº§nodeèŠ‚ç‚¹çš„é…ç½®ï¼Œé…ç½®æ–‡ä»¶/var/lib/kubelet/config.yamlä¸­çš„cgroupDriveréœ€è¦ä¿æŒä¸dockerçš„Cgroup Driverä¸€è‡´</span></span><br><span class="line">kubeadm upgrade node config --kubelet-version $(kubelet --version | cut <span class="_">-d</span> <span class="string">' '</span> <span class="_">-f</span> 2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡å¯æœåŠ¡</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¢å¤è°ƒåº¦</span></span><br><span class="line">kubectl uncordon nodeèŠ‚ç‚¹åç§°</span><br></pre></td></tr></table></figure>
<h3 id="1-12-7å‡çº§åˆ°1-13-5"><a href="#1-12-7å‡çº§åˆ°1-13-5" class="headerlink" title="1.12.7å‡çº§åˆ°1.13.5"></a>1.12.7å‡çº§åˆ°1.13.5</h3><h4 id="masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å†…éƒ¨etcdï¼‰-1"><a href="#masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å†…éƒ¨etcdï¼‰-1" class="headerlink" title="masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å†…éƒ¨etcdï¼‰"></a>masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å†…éƒ¨etcdï¼‰</h4><h5 id="å‰ç½®å‡†å¤‡-1"><a href="#å‰ç½®å‡†å¤‡-1" class="headerlink" title="å‰ç½®å‡†å¤‡"></a>å‰ç½®å‡†å¤‡</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„configmap/kubeadm-config ClusterConfigurationå€¼</span></span><br><span class="line">kubectl edit configmap -n kube-system kubeadm-config</span><br><span class="line"></span><br><span class="line">1. ç§»é™¤etcdç›¸å…³éƒ¨åˆ†</span><br><span class="line">2. ä¿®æ”¹apiEndpointså€¼ Add an entry <span class="keyword">for</span> each of the additional control plane hostsï¼Œå¦‚ä¸‹ä¾‹å­ï¼š</span><br><span class="line"><span class="comment">#      ip-10-40-40-14.cn-northwest-1.compute.internal:</span></span><br><span class="line"><span class="comment">#        advertiseAddress: 10.40.40.14</span></span><br><span class="line"><span class="comment">#        bindPort: 6443</span></span><br><span class="line"><span class="comment">#      ip-10-40-40-190.cn-northwest-1.compute.internal:</span></span><br><span class="line"><span class="comment">#        advertiseAddress: 10.40.40.190</span></span><br><span class="line"><span class="comment">#        bindPort: 6443</span></span><br><span class="line"><span class="comment">#      ip-10-40-40-195.cn-northwest-1.compute.internal:</span></span><br><span class="line"><span class="comment">#        advertiseAddress: 10.40.40.195</span></span><br><span class="line"><span class="comment">#        bindPort: 6443</span></span><br></pre></td></tr></table></figure>
<h5 id="å¼€å§‹å‡çº§master"><a href="#å¼€å§‹å‡çº§master" class="headerlink" title="å¼€å§‹å‡çº§master"></a>å¼€å§‹å‡çº§master</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è®¾ç½®å‡çº§dockerçš„èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦ï¼Œå¹¶ä¸”å°†å‰©ä½™çš„podé©±é€ï¼Œé€šè¿‡kubectl get nodeså‘½ä»¤çœ‹åˆ°è¯¥èŠ‚ç‚¹å·²è¢«æ ‡è®°ä¸å¯è°ƒåº¦</span></span><br><span class="line">kubectl cordon masterå…¶ä¸­ä¸€å°çš„èŠ‚ç‚¹å</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¿½ç•¥äº†æ‰€æœ‰çš„daemonsetçš„podï¼Œå¹¶ä¸”å°†å‰©ä½™çš„podé©±é€</span></span><br><span class="line">kubectl drain masterå…¶ä¸­ä¸€å°çš„èŠ‚ç‚¹å --ignore-daemonsets --delete-local-data</span><br><span class="line"></span><br><span class="line"><span class="comment">#å…ˆå‡çº§kubeadm</span></span><br><span class="line">yum install -y kubeadm-1.13.5</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡Œå‡çº§ï¼Œç¡®ä¿ä¸Šé¢å·²ç»å‡†å¤‡å¥½é•œåƒimage</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å‡çº§è®¡åˆ’</span></span><br><span class="line">kubeadm upgrade plan</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¬¬ä¸€å°master ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œ</span></span><br><span class="line">kubeadm upgrade apply v1.13.5</span><br><span class="line"></span><br><span class="line"><span class="comment">#å…¶ä½™masterä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œ</span></span><br><span class="line">kubeadm upgrade node experimental-control-plane</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¬¬ä¸€å°masterå‡çº§æˆåŠŸä¿¡æ¯</span></span><br><span class="line">[upgrade/successful] SUCCESS! Your cluster was upgraded to <span class="string">"v1.13.5"</span>. Enjoy!</span><br><span class="line">[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets <span class="keyword">in</span> turn.</span><br><span class="line"><span class="comment">#å…¶ä½™masterå‡çº§æˆåŠŸä¿¡æ¯</span></span><br><span class="line">[upgrade/staticpods] Component <span class="string">"kube-scheduler"</span> upgraded successfully!</span><br><span class="line">[upgrade] The control plane instance <span class="keyword">for</span> this node was successfully updated!</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®¹å™¨è¿›è¡Œåˆå§‹åŒ–ï¼ŒæŸ¥çœ‹ç³»ç»ŸæœåŠ¡podæ˜¯å¦æ¢å¤æ­£å¸¸è¿è¡Œã€‚</span></span><br><span class="line">kubectl get pod -o wide --all-namespaces</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¡®ä¿å®¹å™¨AGEåœ¨ä¸€åˆ†é’Ÿä»¥ä¸Šï¼Œå†é‡å¯æœåŠ¡</span></span><br><span class="line">yum install -y kubelet-1.13.5 kubectl-1.13.5</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹masterèŠ‚ç‚¹ç‰ˆæœ¬å·²æˆåŠŸå‡çº§</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¢å¤è°ƒåº¦</span></span><br><span class="line">kubectl uncordon masterèŠ‚ç‚¹åç§°</span><br></pre></td></tr></table></figure>
<h4 id="masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å¤–éƒ¨etcdï¼‰-1"><a href="#masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å¤–éƒ¨etcdï¼‰-1" class="headerlink" title="masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å¤–éƒ¨etcdï¼‰"></a>masterèŠ‚ç‚¹ï¼ˆä½¿ç”¨å¤–éƒ¨etcdï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è®¾ç½®å‡çº§dockerçš„èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦ï¼Œå¹¶ä¸”å°†å‰©ä½™çš„podé©±é€ï¼Œé€šè¿‡kubectl get nodeså‘½ä»¤çœ‹åˆ°è¯¥èŠ‚ç‚¹å·²è¢«æ ‡è®°ä¸å¯è°ƒåº¦</span></span><br><span class="line">kubectl cordon masterå…¶ä¸­ä¸€å°çš„èŠ‚ç‚¹å</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¿½ç•¥äº†æ‰€æœ‰çš„daemonsetçš„podï¼Œå¹¶ä¸”å°†å‰©ä½™çš„podé©±é€</span></span><br><span class="line">kubectl drain masterå…¶ä¸­ä¸€å°çš„èŠ‚ç‚¹å --ignore-daemonsets --delete-local-data</span><br><span class="line"></span><br><span class="line"><span class="comment">#å…ˆå‡çº§kubeadm</span></span><br><span class="line">yum install -y kubeadm-1.13.5</span><br><span class="line"></span><br><span class="line">æ‰§è¡Œå‡çº§ï¼Œç¡®ä¿ä¸Šé¢å·²ç»å‡†å¤‡å¥½é•œåƒimage</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å‡çº§è®¡åˆ’</span></span><br><span class="line">kubeadm upgrade plan</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¬¬ä¸€å°masterä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œï¼š</span></span><br><span class="line">kubeadm upgrade apply v1.13.5</span><br><span class="line"></span><br><span class="line"><span class="comment">#å‰©ä½™masterä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œï¼š</span></span><br><span class="line">kubeadm upgrade node experimental-control-plane</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¬¬ä¸€å°masterå‡çº§æˆåŠŸä¿¡æ¯</span></span><br><span class="line">[upgrade/successful] SUCCESS! Your cluster was upgraded to <span class="string">"v1.13.5"</span>. Enjoy!</span><br><span class="line">[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets <span class="keyword">in</span> turn.</span><br><span class="line"><span class="comment">#å…¶ä½™masterå‡çº§æˆåŠŸä¿¡æ¯</span></span><br><span class="line">[upgrade/staticpods] Component <span class="string">"kube-scheduler"</span> upgraded successfully!</span><br><span class="line">[upgrade] The control plane instance <span class="keyword">for</span> this node was successfully updated!</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®¹å™¨è¿›è¡Œåˆå§‹åŒ–ï¼ŒæŸ¥çœ‹ç³»ç»ŸæœåŠ¡podæ˜¯å¦æ¢å¤æ­£å¸¸è¿è¡Œã€‚</span></span><br><span class="line">kubectl get pod -o wide --all-namespaces</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¡®ä¿å®¹å™¨AGEåœ¨ä¸€åˆ†é’Ÿä»¥ä¸Šï¼Œå†é‡å¯æœåŠ¡</span></span><br><span class="line">yum install -y kubelet-1.13.5 kubectl-1.13.5</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹masterèŠ‚ç‚¹ç‰ˆæœ¬å·²æˆåŠŸå‡çº§</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¢å¤è°ƒåº¦</span></span><br><span class="line">kubectl uncordon masterèŠ‚ç‚¹åç§°</span><br></pre></td></tr></table></figure>
<h4 id="nodeèŠ‚ç‚¹-1"><a href="#nodeèŠ‚ç‚¹-1" class="headerlink" title="nodeèŠ‚ç‚¹"></a>nodeèŠ‚ç‚¹</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è®¾ç½®å‡çº§kubernetesçš„èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦ï¼Œå¹¶ä¸”å°†å‰©ä½™çš„podé©±é€ï¼Œé€šè¿‡kubectl get nodeså‘½ä»¤çœ‹åˆ°è¯¥èŠ‚ç‚¹å·²è¢«æ ‡è®°ä¸å¯è°ƒåº¦</span></span><br><span class="line">kubectl cordon nodeå…¶ä¸­ä¸€å°çš„èŠ‚ç‚¹å</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¿½ç•¥äº†æ‰€æœ‰çš„daemonsetçš„podï¼Œå¹¶ä¸”å°†å‰©ä½™çš„podé©±é€</span></span><br><span class="line">kubectl drain nodeå…¶ä¸­ä¸€å°çš„èŠ‚ç‚¹å --ignore-daemonsets --delete-local-data</span><br><span class="line"></span><br><span class="line"><span class="comment">#èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œå‡çº§kubelet kubeadm kubectl</span></span><br><span class="line">yum install -y kubeadm-1.13.5 kubelet-1.13.5 kubectl-1.13.5 kubernetes-cni-0.7.5-0</span><br><span class="line"></span><br><span class="line"><span class="comment">#å‡çº§nodeèŠ‚ç‚¹çš„é…ç½®ï¼Œé…ç½®æ–‡ä»¶/var/lib/kubelet/config.yamlä¸­çš„cgroupDriveréœ€è¦ä¿æŒä¸dockerçš„Cgroup Driverä¸€è‡´</span></span><br><span class="line">kubeadm upgrade node config --kubelet-version $(kubelet --version | cut <span class="_">-d</span> <span class="string">' '</span> <span class="_">-f</span> 2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡å¯æœåŠ¡</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¢å¤è°ƒåº¦</span></span><br><span class="line">kubectl uncordon nodeèŠ‚ç‚¹åç§°</span><br></pre></td></tr></table></figure>
<h3 id="1-13-5å‡çº§åˆ°1-14-0"><a href="#1-13-5å‡çº§åˆ°1-14-0" class="headerlink" title="1.13.5å‡çº§åˆ°1.14.0"></a>1.13.5å‡çº§åˆ°1.14.0</h3><h4 id="å¦‚æœä½¿ç”¨çš„å¤–éƒ¨çš„etcdåˆ™è¿›è¡Œå¦‚ä¸‹æ“ä½œ"><a href="#å¦‚æœä½¿ç”¨çš„å¤–éƒ¨çš„etcdåˆ™è¿›è¡Œå¦‚ä¸‹æ“ä½œ" class="headerlink" title="å¦‚æœä½¿ç”¨çš„å¤–éƒ¨çš„etcdåˆ™è¿›è¡Œå¦‚ä¸‹æ“ä½œ"></a>å¦‚æœä½¿ç”¨çš„å¤–éƒ¨çš„etcdåˆ™è¿›è¡Œå¦‚ä¸‹æ“ä½œ</h4><p>Modify <code>configmap/kubeadm-config</code> for this control plane node by removing the <strong>etcd</strong> section completely</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„configmap/kubeadm-config ClusterConfigurationå€¼</span></span><br><span class="line">kubectl edit configmap -n kube-system kubeadm-config</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Please edit the object below. Lines beginning with a '#' will be ignored,</span></span><br><span class="line"><span class="comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span></span><br><span class="line"><span class="comment"># reopened with the relevant failures.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  ClusterConfiguration:</span> <span class="string">|</span><br><span class="line"></span><span class="attr">    apiServer:</span></span><br><span class="line"><span class="attr">      certSANs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">10.164</span><span class="number">.178</span><span class="number">.238</span></span><br><span class="line"><span class="attr">      extraArgs:</span></span><br><span class="line"><span class="attr">        authorization-mode:</span> Node,RBAC</span><br><span class="line"><span class="attr">      timeoutForControlPlane:</span> <span class="number">4</span>m0s</span><br><span class="line"><span class="attr">    apiVersion:</span> kubeadm.k8s.io/v1beta1</span><br><span class="line"><span class="attr">    certificatesDir:</span> /etc/kubernetes/pki</span><br><span class="line"><span class="attr">    clusterName:</span> kubernetes</span><br><span class="line"><span class="attr">    controlPlaneEndpoint:</span> <span class="number">10.164</span><span class="number">.178</span><span class="number">.238</span>:<span class="number">6443</span></span><br><span class="line"><span class="attr">    controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">    dns:</span></span><br><span class="line"><span class="attr">      type:</span> CoreDNS</span><br><span class="line"><span class="attr">    etcd:</span></span><br><span class="line"><span class="attr">      local:</span></span><br><span class="line"><span class="attr">        dataDir:</span> /var/lib/etcd</span><br><span class="line"><span class="attr">    imageRepository:</span> k8s.gcr.io</span><br><span class="line"><span class="attr">    kind:</span> ClusterConfiguration</span><br><span class="line"><span class="attr">    kubernetesVersion:</span> v1<span class="number">.14</span><span class="number">.0</span></span><br><span class="line"><span class="attr">    networking:</span></span><br><span class="line"><span class="attr">      dnsDomain:</span> cluster.local</span><br><span class="line"><span class="attr">      podSubnet:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">12</span></span><br><span class="line"><span class="attr">    scheduler:</span> &#123;&#125;</span><br><span class="line"><span class="attr">  ClusterStatus:</span> <span class="string">|</span><br><span class="line"></span><span class="attr">    apiEndpoints:</span></span><br><span class="line"><span class="attr">      k8s-master1:</span></span><br><span class="line"><span class="attr">        advertiseAddress:</span> <span class="number">10.164</span><span class="number">.178</span><span class="number">.161</span></span><br><span class="line"><span class="attr">        bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">      k8s-master2:</span></span><br><span class="line"><span class="attr">        advertiseAddress:</span> <span class="number">10.164</span><span class="number">.178</span><span class="number">.162</span></span><br><span class="line"><span class="attr">        bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">      k8s-master3:</span></span><br><span class="line"><span class="attr">        advertiseAddress:</span> <span class="number">10.164</span><span class="number">.178</span><span class="number">.163</span></span><br><span class="line"><span class="attr">        bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">    apiVersion:</span> kubeadm.k8s.io/v1beta1</span><br><span class="line"><span class="attr">    kind:</span> ClusterStatus</span><br><span class="line"><span class="attr">kind:</span> ConfigMap</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  creationTimestamp:</span> <span class="string">"2019-05-21T10:08:03Z"</span></span><br><span class="line"><span class="attr">  name:</span> kubeadm-config</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">  resourceVersion:</span> <span class="string">"209870"</span></span><br><span class="line"><span class="attr">  selfLink:</span> /api/v1/namespaces/kube-system/configmaps/kubeadm-config</span><br><span class="line"><span class="attr">  uid:</span> <span class="number">52419642</span><span class="bullet">-7</span>bb0<span class="bullet">-11e9</span><span class="bullet">-8</span>a89<span class="bullet">-0800270</span>fde1d</span><br></pre></td></tr></table></figure>
<h4 id="masterèŠ‚ç‚¹"><a href="#masterèŠ‚ç‚¹" class="headerlink" title="masterèŠ‚ç‚¹"></a>masterèŠ‚ç‚¹</h4><h5 id="å‡çº§ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢-mater1"><a href="#å‡çº§ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢-mater1" class="headerlink" title="å‡çº§ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢(mater1)"></a>å‡çº§ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢(mater1)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å®‰è£…å¯¹åº”çš„ç»„ä»¶</span></span><br><span class="line">yum install -y kubeadm-1.14.0-0 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹ç‰ˆæœ¬</span></span><br><span class="line">kubeadm version</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å‡çº§è®¡åˆ’</span></span><br><span class="line">kubeadm upgrade plan</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡Œå‡çº§</span></span><br><span class="line">kubeadm upgrade apply v1.14.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¡®ä¿å®¹å™¨AGEåœ¨ä¸€åˆ†é’Ÿä»¥ä¸Šï¼Œå†é‡å¯æœåŠ¡</span></span><br><span class="line">yum install -y kubelet-1.14.0-0 kubectl-1.14.0-0 --disableexcludes=kubernetes</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<h5 id="å‡çº§å…¶ä»–æ§åˆ¶å¹³é¢-mater2ã€master3"><a href="#å‡çº§å…¶ä»–æ§åˆ¶å¹³é¢-mater2ã€master3" class="headerlink" title="å‡çº§å…¶ä»–æ§åˆ¶å¹³é¢(mater2ã€master3)"></a>å‡çº§å…¶ä»–æ§åˆ¶å¹³é¢(mater2ã€master3)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å®‰è£…å¯¹åº”çš„ç»„ä»¶</span></span><br><span class="line">yum install -y kubeadm-1.14.0-0 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡Œå‡çº§</span></span><br><span class="line">kubeadm upgrade node experimental-control-plane</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¡®ä¿å®¹å™¨AGEåœ¨ä¸€åˆ†é’Ÿä»¥ä¸Šï¼Œå†é‡å¯æœåŠ¡</span></span><br><span class="line">yum install -y kubelet-1.14.0-0 kubectl-1.14.0-0 --disableexcludes=kubernetes</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">#master2æ—¥å¿—</span></span><br><span class="line">[upgrade] Reading configuration from the cluster...</span><br><span class="line">[upgrade] FYI: You can look at this config file with <span class="string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class="line">[upgrade] Upgrading your Static Pod-hosted control plane instance to version <span class="string">"v1.14.0"</span>...</span><br><span class="line">Static pod: kube-apiserver-k8s-master2 <span class="built_in">hash</span>: ba03afd84d454d318c2cc6e3a6e23f53</span><br><span class="line">Static pod: kube-controller-manager-k8s-master2 <span class="built_in">hash</span>: 0a9f25af4e4ad5e5427feb8295<span class="built_in">fc</span>055a</span><br><span class="line">Static pod: kube-scheduler-k8s-master2 <span class="built_in">hash</span>: 8cea5badbe1b177ab58353a73cdedd01</span><br><span class="line">[upgrade/etcd] Upgrading to TLS <span class="keyword">for</span> etcd</span><br><span class="line">Static pod: etcd-k8s-master2 <span class="built_in">hash</span>: d990ad5b88743835159168644453f90b</span><br><span class="line">[upgrade/staticpods] Moved new manifest to <span class="string">"/etc/kubernetes/manifests/etcd.yaml"</span> and backed up old manifest to <span class="string">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2019-05-21-23-45-09/etcd.yaml"</span></span><br><span class="line">[upgrade/staticpods] Waiting <span class="keyword">for</span> the kubelet to restart the component</span><br><span class="line">[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)</span><br><span class="line">Static pod: etcd-k8s-master2 <span class="built_in">hash</span>: d990ad5b88743835159168644453f90b</span><br><span class="line">Static pod: etcd-k8s-master2 <span class="built_in">hash</span>: e56ee6ac7c0de512a17ef30c3a44e01c</span><br><span class="line">[apiclient] Found 3 Pods <span class="keyword">for</span> label selector component=etcd</span><br><span class="line">[upgrade/staticpods] Component <span class="string">"etcd"</span> upgraded successfully!</span><br><span class="line">[upgrade/etcd] Waiting <span class="keyword">for</span> etcd to become available</span><br><span class="line">[upgrade/staticpods] Writing new Static Pod manifests to <span class="string">"/etc/kubernetes/tmp/kubeadm-upgraded-manifests998233672"</span></span><br><span class="line">[upgrade/staticpods] Moved new manifest to <span class="string">"/etc/kubernetes/manifests/kube-apiserver.yaml"</span> and backed up old manifest to <span class="string">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2019-05-21-23-45-09/kube-apiserver.yaml"</span></span><br><span class="line">[upgrade/staticpods] Waiting <span class="keyword">for</span> the kubelet to restart the component</span><br><span class="line">[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)</span><br><span class="line">Static pod: kube-apiserver-k8s-master2 <span class="built_in">hash</span>: ba03afd84d454d318c2cc6e3a6e23f53</span><br><span class="line">Static pod: kube-apiserver-k8s-master2 <span class="built_in">hash</span>: 94e207e0d84e092ae98dc64af5b870ba</span><br><span class="line">[apiclient] Found 3 Pods <span class="keyword">for</span> label selector component=kube-apiserver</span><br><span class="line">[upgrade/staticpods] Component <span class="string">"kube-apiserver"</span> upgraded successfully!</span><br><span class="line">[upgrade/staticpods] Moved new manifest to <span class="string">"/etc/kubernetes/manifests/kube-controller-manager.yaml"</span> and backed up old manifest to <span class="string">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2019-05-21-23-45-09/kube-controller-manager.yaml"</span></span><br><span class="line">[upgrade/staticpods] Waiting <span class="keyword">for</span> the kubelet to restart the component</span><br><span class="line">[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)</span><br><span class="line">Static pod: kube-controller-manager-k8s-master2 <span class="built_in">hash</span>: 0a9f25af4e4ad5e5427feb8295<span class="built_in">fc</span>055a</span><br><span class="line">Static pod: kube-controller-manager-k8s-master2 <span class="built_in">hash</span>: e45f10af1ae684722cbd74cb11807900</span><br><span class="line">[apiclient] Found 3 Pods <span class="keyword">for</span> label selector component=kube-controller-manager</span><br><span class="line">[upgrade/staticpods] Component <span class="string">"kube-controller-manager"</span> upgraded successfully!</span><br><span class="line">[upgrade/staticpods] Moved new manifest to <span class="string">"/etc/kubernetes/manifests/kube-scheduler.yaml"</span> and backed up old manifest to <span class="string">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2019-05-21-23-45-09/kube-scheduler.yaml"</span></span><br><span class="line">[upgrade/staticpods] Waiting <span class="keyword">for</span> the kubelet to restart the component</span><br><span class="line">[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)</span><br><span class="line">Static pod: kube-scheduler-k8s-master2 <span class="built_in">hash</span>: 8cea5badbe1b177ab58353a73cdedd01</span><br><span class="line">Static pod: kube-scheduler-k8s-master2 <span class="built_in">hash</span>: 58272442e226c838b193bbba4c44091e</span><br><span class="line">[apiclient] Found 3 Pods <span class="keyword">for</span> label selector component=kube-scheduler</span><br><span class="line">[upgrade/staticpods] Component <span class="string">"kube-scheduler"</span> upgraded successfully!</span><br><span class="line">[upgrade] The control plane instance <span class="keyword">for</span> this node was successfully updated!</span><br><span class="line"></span><br><span class="line"><span class="comment">#master3 å‡çº§æ—¥å¿—</span></span><br><span class="line">[upgrade] Reading configuration from the cluster...</span><br><span class="line">[upgrade] FYI: You can look at this config file with <span class="string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class="line">[upgrade] Upgrading your Static Pod-hosted control plane instance to version <span class="string">"v1.14.0"</span>...</span><br><span class="line">Static pod: kube-apiserver-k8s-master3 <span class="built_in">hash</span>: 556e7d43da7a389c6b0b116ae5a46d97</span><br><span class="line">Static pod: kube-controller-manager-k8s-master3 <span class="built_in">hash</span>: 0a9f25af4e4ad5e5427feb8295<span class="built_in">fc</span>055a</span><br><span class="line">Static pod: kube-scheduler-k8s-master3 <span class="built_in">hash</span>: 8cea5badbe1b177ab58353a73cdedd01</span><br><span class="line">[upgrade/etcd] Upgrading to TLS <span class="keyword">for</span> etcd</span><br><span class="line">[upgrade/staticpods] Writing new Static Pod manifests to <span class="string">"/etc/kubernetes/tmp/kubeadm-upgraded-manifests859456185"</span></span><br><span class="line">[upgrade/staticpods] Moved new manifest to <span class="string">"/etc/kubernetes/manifests/kube-apiserver.yaml"</span> and backed up old manifest to <span class="string">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2019-05-21-23-48-13/kube-apiserver.yaml"</span></span><br><span class="line">[upgrade/staticpods] Waiting <span class="keyword">for</span> the kubelet to restart the component</span><br><span class="line">[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)</span><br><span class="line">Static pod: kube-apiserver-k8s-master3 <span class="built_in">hash</span>: 556e7d43da7a389c6b0b116ae5a46d97</span><br><span class="line">Static pod: kube-apiserver-k8s-master3 <span class="built_in">hash</span>: 1a94c94ecfa9f698cfc902<span class="built_in">fc</span>37c15be9</span><br><span class="line">[apiclient] Found 3 Pods <span class="keyword">for</span> label selector component=kube-apiserver</span><br><span class="line">[upgrade/staticpods] Component <span class="string">"kube-apiserver"</span> upgraded successfully!</span><br><span class="line">[upgrade/staticpods] Moved new manifest to <span class="string">"/etc/kubernetes/manifests/kube-controller-manager.yaml"</span> and backed up old manifest to <span class="string">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2019-05-21-23-48-13/kube-controller-manager.yaml"</span></span><br><span class="line">[upgrade/staticpods] Waiting <span class="keyword">for</span> the kubelet to restart the component</span><br><span class="line">[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)</span><br><span class="line">Static pod: kube-controller-manager-k8s-master3 <span class="built_in">hash</span>: 0a9f25af4e4ad5e5427feb8295<span class="built_in">fc</span>055a</span><br><span class="line">Static pod: kube-controller-manager-k8s-master3 <span class="built_in">hash</span>: e45f10af1ae684722cbd74cb11807900</span><br><span class="line">[apiclient] Found 3 Pods <span class="keyword">for</span> label selector component=kube-controller-manager</span><br><span class="line">[upgrade/staticpods] Component <span class="string">"kube-controller-manager"</span> upgraded successfully!</span><br><span class="line">[upgrade/staticpods] Moved new manifest to <span class="string">"/etc/kubernetes/manifests/kube-scheduler.yaml"</span> and backed up old manifest to <span class="string">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2019-05-21-23-48-13/kube-scheduler.yaml"</span></span><br><span class="line">[upgrade/staticpods] Waiting <span class="keyword">for</span> the kubelet to restart the component</span><br><span class="line">[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)</span><br><span class="line">Static pod: kube-scheduler-k8s-master3 <span class="built_in">hash</span>: 8cea5badbe1b177ab58353a73cdedd01</span><br><span class="line">Static pod: kube-scheduler-k8s-master3 <span class="built_in">hash</span>: 58272442e226c838b193bbba4c44091e</span><br><span class="line">[apiclient] Found 3 Pods <span class="keyword">for</span> label selector component=kube-scheduler</span><br><span class="line">[upgrade/staticpods] Component <span class="string">"kube-scheduler"</span> upgraded successfully!</span><br><span class="line">[upgrade] The control plane instance <span class="keyword">for</span> this node was successfully updated!</span><br></pre></td></tr></table></figure>
<h4 id="nodeèŠ‚ç‚¹-node1ã€node2ã€node3-â€¦"><a href="#nodeèŠ‚ç‚¹-node1ã€node2ã€node3-â€¦" class="headerlink" title="nodeèŠ‚ç‚¹(node1ã€node2ã€node3 â€¦)"></a>nodeèŠ‚ç‚¹(node1ã€node2ã€node3 â€¦)</h4><h5 id="å‡çº§kubeadm"><a href="#å‡çº§kubeadm" class="headerlink" title="å‡çº§kubeadm"></a>å‡çº§kubeadm</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubeadm-1.14.x-0 --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure>
<h5 id="é©±é™¤èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å¹¶è®©èŠ‚ç‚¹ä¸å¯è°ƒåº¦"><a href="#é©±é™¤èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å¹¶è®©èŠ‚ç‚¹ä¸å¯è°ƒåº¦" class="headerlink" title="é©±é™¤èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å¹¶è®©èŠ‚ç‚¹ä¸å¯è°ƒåº¦"></a>é©±é™¤èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å¹¶è®©èŠ‚ç‚¹ä¸å¯è°ƒåº¦</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain <span class="variable">$WORKERNODE</span> --ignore-daemonsets</span><br><span class="line"><span class="comment">#$WORKERNODE: node1ã€node2ã€node3 ...</span></span><br></pre></td></tr></table></figure>
<h5 id="å‡çº§-kubelet-é…ç½®"><a href="#å‡çº§-kubelet-é…ç½®" class="headerlink" title="å‡çº§ kubelet é…ç½®"></a>å‡çº§ kubelet é…ç½®</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm upgrade node config --kubelet-version v1.14.0</span><br></pre></td></tr></table></figure>
<h5 id="å‡çº§-kubelet-ä¸-kubectl"><a href="#å‡çº§-kubelet-ä¸-kubectl" class="headerlink" title="å‡çº§ kubelet ä¸ kubectl"></a>å‡çº§ kubelet ä¸ kubectl</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet-1.14.x-0 kubectl-1.14.x-0 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡å¯kubelet</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">#è®©èŠ‚ç‚¹é‡æ–°åœ¨çº¿</span></span><br><span class="line">kubectl uncordon <span class="variable">$WORKERNODE</span></span><br></pre></td></tr></table></figure>
<h5 id="éªŒè¯é›†ç¾¤çš„çŠ¶æ€"><a href="#éªŒè¯é›†ç¾¤çš„çŠ¶æ€" class="headerlink" title="éªŒè¯é›†ç¾¤çš„çŠ¶æ€"></a>éªŒè¯é›†ç¾¤çš„çŠ¶æ€</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></figure>
<h3 id="1-14-0å‡çº§åˆ°1-15-0"><a href="#1-14-0å‡çº§åˆ°1-15-0" class="headerlink" title="1.14.0å‡çº§åˆ°1.15.0"></a>1.14.0å‡çº§åˆ°1.15.0</h3><h4 id="å¦‚æœä½¿ç”¨çš„å¤–éƒ¨çš„etcdåˆ™è¿›è¡Œå¦‚ä¸‹æ“ä½œ-1"><a href="#å¦‚æœä½¿ç”¨çš„å¤–éƒ¨çš„etcdåˆ™è¿›è¡Œå¦‚ä¸‹æ“ä½œ-1" class="headerlink" title="å¦‚æœä½¿ç”¨çš„å¤–éƒ¨çš„etcdåˆ™è¿›è¡Œå¦‚ä¸‹æ“ä½œ"></a>å¦‚æœä½¿ç”¨çš„å¤–éƒ¨çš„etcdåˆ™è¿›è¡Œå¦‚ä¸‹æ“ä½œ</h4><p>Modify <code>configmap/kubeadm-config</code> for this control plane node by removing the <strong>etcd</strong> section completely</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„configmap/kubeadm-config ClusterConfigurationå€¼</span></span><br><span class="line">kubectl edit configmap -n kube-system kubeadm-config</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Please edit the object below. Lines beginning with a '#' will be ignored,</span></span><br><span class="line"><span class="comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span></span><br><span class="line"><span class="comment"># reopened with the relevant failures.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  ClusterConfiguration:</span> <span class="string">|</span><br><span class="line"></span><span class="attr">    apiServer:</span></span><br><span class="line"><span class="attr">      certSANs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">10.164</span><span class="number">.178</span><span class="number">.238</span></span><br><span class="line"><span class="attr">      extraArgs:</span></span><br><span class="line"><span class="attr">        authorization-mode:</span> Node,RBAC</span><br><span class="line"><span class="attr">      timeoutForControlPlane:</span> <span class="number">4</span>m0s</span><br><span class="line"><span class="attr">    apiVersion:</span> kubeadm.k8s.io/v1beta2</span><br><span class="line"><span class="attr">    certificatesDir:</span> /etc/kubernetes/pki</span><br><span class="line"><span class="attr">    clusterName:</span> kubernetes</span><br><span class="line"><span class="attr">    controlPlaneEndpoint:</span> <span class="number">10.164</span><span class="number">.178</span><span class="number">.238</span>:<span class="number">6443</span></span><br><span class="line"><span class="attr">    controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">    dns:</span></span><br><span class="line"><span class="attr">      type:</span> CoreDNS</span><br><span class="line"><span class="attr">    etcd:</span></span><br><span class="line"><span class="attr">      local:</span></span><br><span class="line"><span class="attr">        dataDir:</span> /var/lib/etcd</span><br><span class="line"><span class="attr">    imageRepository:</span> k8s.gcr.io</span><br><span class="line"><span class="attr">    kind:</span> ClusterConfiguration</span><br><span class="line"><span class="attr">    kubernetesVersion:</span> v1<span class="number">.15</span><span class="number">.0</span></span><br><span class="line"><span class="attr">    networking:</span></span><br><span class="line"><span class="attr">      dnsDomain:</span> cluster.local</span><br><span class="line"><span class="attr">      serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">12</span></span><br><span class="line"><span class="attr">    scheduler:</span> &#123;&#125;</span><br><span class="line"><span class="attr">  ClusterStatus:</span> <span class="string">|</span><br><span class="line"></span><span class="attr">    apiEndpoints:</span></span><br><span class="line"><span class="attr">      k8s-master1:</span></span><br><span class="line"><span class="attr">        advertiseAddress:</span> <span class="number">10.164</span><span class="number">.178</span><span class="number">.161</span></span><br><span class="line"><span class="attr">        bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">      k8s-master2:</span></span><br><span class="line"><span class="attr">        advertiseAddress:</span> <span class="number">10.164</span><span class="number">.178</span><span class="number">.162</span></span><br><span class="line"><span class="attr">        bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">      k8s-master3:</span></span><br><span class="line"><span class="attr">        advertiseAddress:</span> <span class="number">10.164</span><span class="number">.178</span><span class="number">.163</span></span><br><span class="line"><span class="attr">        bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">    apiVersion:</span> kubeadm.k8s.io/v1beta2</span><br><span class="line"><span class="attr">    kind:</span> ClusterStatus</span><br><span class="line"><span class="attr">kind:</span> ConfigMap</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  creationTimestamp:</span> <span class="string">"2019-06-25T04:12:53Z"</span></span><br><span class="line"><span class="attr">  name:</span> kubeadm-config</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">  resourceVersion:</span> <span class="string">"1337635"</span></span><br><span class="line"><span class="attr">  selfLink:</span> /api/v1/namespaces/kube-system/configmaps/kubeadm-config</span><br><span class="line"><span class="attr">  uid:</span> <span class="number">81334</span>a15<span class="bullet">-96</span>ff<span class="bullet">-11e9</span>-b14f<span class="bullet">-0800270</span>fde1d</span><br></pre></td></tr></table></figure>
<h4 id="masterèŠ‚ç‚¹-1"><a href="#masterèŠ‚ç‚¹-1" class="headerlink" title="masterèŠ‚ç‚¹"></a>masterèŠ‚ç‚¹</h4><h5 id="å‡çº§ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢-mater1-1"><a href="#å‡çº§ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢-mater1-1" class="headerlink" title="å‡çº§ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢(mater1)"></a>å‡çº§ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢(mater1)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å®‰è£…å¯¹åº”çš„ç»„ä»¶</span></span><br><span class="line">yum install -y kubeadm-1.15.0-0 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹ç‰ˆæœ¬</span></span><br><span class="line">kubeadm version</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å‡çº§è®¡åˆ’</span></span><br><span class="line">kubeadm upgrade plan</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡Œå‡çº§</span></span><br><span class="line">kubeadm upgrade apply v1.15.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¡®ä¿å®¹å™¨AGEåœ¨ä¸€åˆ†é’Ÿä»¥ä¸Šï¼Œå†é‡å¯æœåŠ¡</span></span><br><span class="line">yum install -y kubelet-1.15.0-0 kubectl-1.15.0-0 --disableexcludes=kubernetes</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<h5 id="å‡çº§å…¶ä»–æ§åˆ¶å¹³é¢-mater2ã€master3-1"><a href="#å‡çº§å…¶ä»–æ§åˆ¶å¹³é¢-mater2ã€master3-1" class="headerlink" title="å‡çº§å…¶ä»–æ§åˆ¶å¹³é¢(mater2ã€master3)"></a>å‡çº§å…¶ä»–æ§åˆ¶å¹³é¢(mater2ã€master3)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å®‰è£…å¯¹åº”çš„ç»„ä»¶</span></span><br><span class="line">yum install -y kubeadm-1.15.0-0 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡Œå‡çº§</span></span><br><span class="line">kubeadm upgrade node</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¡®ä¿å®¹å™¨AGEåœ¨ä¸€åˆ†é’Ÿä»¥ä¸Šï¼Œå†é‡å¯æœåŠ¡</span></span><br><span class="line">yum install -y kubelet-1.15.0-0 kubectl-1.15.0-0 --disableexcludes=kubernetes</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<h4 id="nodeèŠ‚ç‚¹-node1ã€node2ã€node3-â€¦-1"><a href="#nodeèŠ‚ç‚¹-node1ã€node2ã€node3-â€¦-1" class="headerlink" title="nodeèŠ‚ç‚¹(node1ã€node2ã€node3 â€¦)"></a>nodeèŠ‚ç‚¹(node1ã€node2ã€node3 â€¦)</h4><h5 id="å‡çº§kubeadm-1"><a href="#å‡çº§kubeadm-1" class="headerlink" title="å‡çº§kubeadm"></a>å‡çº§kubeadm</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubeadm-1.15.x-0 --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure>
<h5 id="é©±é™¤èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å¹¶è®©èŠ‚ç‚¹ä¸å¯è°ƒåº¦-1"><a href="#é©±é™¤èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å¹¶è®©èŠ‚ç‚¹ä¸å¯è°ƒåº¦-1" class="headerlink" title="é©±é™¤èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å¹¶è®©èŠ‚ç‚¹ä¸å¯è°ƒåº¦"></a>é©±é™¤èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å¹¶è®©èŠ‚ç‚¹ä¸å¯è°ƒåº¦</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain <span class="variable">$WORKERNODE</span> --ignore-daemonsets</span><br><span class="line"><span class="comment">#$WORKERNODE: node1ã€node2ã€node3 ...</span></span><br></pre></td></tr></table></figure>
<h5 id="å‡çº§-kubelet-é…ç½®-1"><a href="#å‡çº§-kubelet-é…ç½®-1" class="headerlink" title="å‡çº§ kubelet é…ç½®"></a>å‡çº§ kubelet é…ç½®</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm upgrade node</span><br></pre></td></tr></table></figure>
<h5 id="å‡çº§-kubelet-ä¸-kubectl-1"><a href="#å‡çº§-kubelet-ä¸-kubectl-1" class="headerlink" title="å‡çº§ kubelet ä¸ kubectl"></a>å‡çº§ kubelet ä¸ kubectl</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet-1.15.x-0 kubectl-1.15.x-0 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡å¯kubelet</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">#è®©èŠ‚ç‚¹é‡æ–°åœ¨çº¿</span></span><br><span class="line">kubectl uncordon <span class="variable">$WORKERNODE</span></span><br></pre></td></tr></table></figure>
<h5 id="éªŒè¯é›†ç¾¤çš„çŠ¶æ€-1"><a href="#éªŒè¯é›†ç¾¤çš„çŠ¶æ€-1" class="headerlink" title="éªŒè¯é›†ç¾¤çš„çŠ¶æ€"></a>éªŒè¯é›†ç¾¤çš„çŠ¶æ€</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></figure>
<h3 id="1-15-0å‡çº§åˆ°1-16-0"><a href="#1-15-0å‡çº§åˆ°1-16-0" class="headerlink" title="1.15.0å‡çº§åˆ°1.16.0"></a>1.15.0å‡çº§åˆ°1.16.0</h3><h4 id="å¦‚æœä½¿ç”¨çš„å¤–éƒ¨çš„etcdåˆ™è¿›è¡Œå¦‚ä¸‹æ“ä½œ-2"><a href="#å¦‚æœä½¿ç”¨çš„å¤–éƒ¨çš„etcdåˆ™è¿›è¡Œå¦‚ä¸‹æ“ä½œ-2" class="headerlink" title="å¦‚æœä½¿ç”¨çš„å¤–éƒ¨çš„etcdåˆ™è¿›è¡Œå¦‚ä¸‹æ“ä½œ"></a>å¦‚æœä½¿ç”¨çš„å¤–éƒ¨çš„etcdåˆ™è¿›è¡Œå¦‚ä¸‹æ“ä½œ</h4><p>Modify <code>configmap/kubeadm-config</code> for this control plane node by removing the <strong>etcd</strong> section completely</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„configmap/kubeadm-config ClusterConfigurationå€¼</span></span><br><span class="line">kubectl edit configmap -n kube-system kubeadm-config</span><br></pre></td></tr></table></figure>
<h4 id="masterèŠ‚ç‚¹-2"><a href="#masterèŠ‚ç‚¹-2" class="headerlink" title="masterèŠ‚ç‚¹"></a>masterèŠ‚ç‚¹</h4><h5 id="å‡çº§ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢-mater1-2"><a href="#å‡çº§ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢-mater1-2" class="headerlink" title="å‡çº§ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢(mater1)"></a>å‡çº§ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢(mater1)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å®‰è£…å¯¹åº”çš„ç»„ä»¶</span></span><br><span class="line">yum install -y kubeadm-1.16.0-0 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹ç‰ˆæœ¬</span></span><br><span class="line">kubeadm version</span><br><span class="line"></span><br><span class="line"><span class="comment">#è®©master1ä¸‹çº¿</span></span><br><span class="line">kubectl drain <span class="variable">$MASTER</span> --ignore-daemonsets</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹å‡çº§è®¡åˆ’</span></span><br><span class="line">kubeadm upgrade plan</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡Œå‡çº§</span></span><br><span class="line">kubeadm upgrade apply v1.16.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#master ä¸Šçº¿</span></span><br><span class="line">kubectl uncordon <span class="variable">$MASTER</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¡®ä¿å®¹å™¨AGEåœ¨ä¸€åˆ†é’Ÿä»¥ä¸Šï¼Œå†é‡å¯æœåŠ¡</span></span><br><span class="line">yum install -y kubelet-1.15.0-0 kubectl-1.15.0-0 --disableexcludes=kubernetes</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<h5 id="å‡çº§å…¶ä»–æ§åˆ¶å¹³é¢-mater2ã€master3-2"><a href="#å‡çº§å…¶ä»–æ§åˆ¶å¹³é¢-mater2ã€master3-2" class="headerlink" title="å‡çº§å…¶ä»–æ§åˆ¶å¹³é¢(mater2ã€master3)"></a>å‡çº§å…¶ä»–æ§åˆ¶å¹³é¢(mater2ã€master3)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å®‰è£…å¯¹åº”çš„ç»„ä»¶</span></span><br><span class="line">yum install -y kubeadm-1.16.0-0 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡Œå‡çº§</span></span><br><span class="line">kubeadm upgrade node</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¡®ä¿å®¹å™¨AGEåœ¨ä¸€åˆ†é’Ÿä»¥ä¸Šï¼Œå†é‡å¯æœåŠ¡</span></span><br><span class="line">yum install -y kubelet-1.16.0-0 kubectl-1.16.0-0 --disableexcludes=kubernetes</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<h4 id="nodeèŠ‚ç‚¹-node1ã€node2ã€node3-â€¦-2"><a href="#nodeèŠ‚ç‚¹-node1ã€node2ã€node3-â€¦-2" class="headerlink" title="nodeèŠ‚ç‚¹(node1ã€node2ã€node3 â€¦)"></a>nodeèŠ‚ç‚¹(node1ã€node2ã€node3 â€¦)</h4><h5 id="å‡çº§kubeadm-2"><a href="#å‡çº§kubeadm-2" class="headerlink" title="å‡çº§kubeadm"></a>å‡çº§kubeadm</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubeadm-1.16.x-0 --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure>
<h5 id="é©±é™¤èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å¹¶è®©èŠ‚ç‚¹ä¸å¯è°ƒåº¦-2"><a href="#é©±é™¤èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å¹¶è®©èŠ‚ç‚¹ä¸å¯è°ƒåº¦-2" class="headerlink" title="é©±é™¤èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å¹¶è®©èŠ‚ç‚¹ä¸å¯è°ƒåº¦"></a>é©±é™¤èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å¹¶è®©èŠ‚ç‚¹ä¸å¯è°ƒåº¦</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain <span class="variable">$WORKERNODE</span> --ignore-daemonsets</span><br><span class="line"><span class="comment">#$WORKERNODE: node1ã€node2ã€node3 ...</span></span><br></pre></td></tr></table></figure>
<h5 id="å‡çº§-kubelet-é…ç½®-2"><a href="#å‡çº§-kubelet-é…ç½®-2" class="headerlink" title="å‡çº§ kubelet é…ç½®"></a>å‡çº§ kubelet é…ç½®</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm upgrade node</span><br></pre></td></tr></table></figure>
<h5 id="å‡çº§-kubelet-ä¸-kubectl-2"><a href="#å‡çº§-kubelet-ä¸-kubectl-2" class="headerlink" title="å‡çº§ kubelet ä¸ kubectl"></a>å‡çº§ kubelet ä¸ kubectl</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet-1.16.x-0 kubectl-1.16.x-0 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡å¯kubelet</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">#è®©èŠ‚ç‚¹é‡æ–°åœ¨çº¿</span></span><br><span class="line">kubectl uncordon <span class="variable">$WORKERNODE</span></span><br></pre></td></tr></table></figure>
<h5 id="éªŒè¯é›†ç¾¤çš„çŠ¶æ€-2"><a href="#éªŒè¯é›†ç¾¤çš„çŠ¶æ€-2" class="headerlink" title="éªŒè¯é›†ç¾¤çš„çŠ¶æ€"></a>éªŒè¯é›†ç¾¤çš„çŠ¶æ€</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></figure>
<h3 id="1-16-0å‡çº§åˆ°1-17-0"><a href="#1-16-0å‡çº§åˆ°1-17-0" class="headerlink" title="1.16.0å‡çº§åˆ°1.17.0"></a>1.16.0å‡çº§åˆ°1.17.0</h3><blockquote>
<p>åŒ1.15.0åˆ°1.16.0çš„å‡çº§</p>
</blockquote>
<h3 id="1-17-0å‡çº§åˆ°1-18-0"><a href="#1-17-0å‡çº§åˆ°1-18-0" class="headerlink" title="1.17.0å‡çº§åˆ°1.18.0"></a>1.17.0å‡çº§åˆ°1.18.0</h3><blockquote>
<p>åŒ1.15.0åˆ°1.16.0çš„å‡çº§</p>
</blockquote>
<p>å‚è€ƒï¼š<br><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade-ha-1-12/" target="_blank" rel="external">https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade-ha-1-12/</a><br><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade-ha-1-13/" target="_blank" rel="external">https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade-ha-1-13/</a><br><a href="https://github.com/truongnh1992/upgrade-kubeadm-cluster" target="_blank" rel="external">https://github.com/truongnh1992/upgrade-kubeadm-cluster</a></p>
<h2 id="kubeadm-init-config-é…ç½®"><a href="#kubeadm-init-config-é…ç½®" class="headerlink" title="kubeadm init config é…ç½®"></a>kubeadm init config é…ç½®</h2><h3 id="kubeadm-v1-12"><a href="#kubeadm-v1-12" class="headerlink" title="kubeadm v1.12"></a>kubeadm v1.12</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> kubeadm.k8s.io/v1alpha3</span><br><span class="line"><span class="attr">kind:</span> InitConfiguration</span><br><span class="line"><span class="attr">apiEndpoint:</span></span><br><span class="line"><span class="attr">  advertiseAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">  bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="attr">- groups:</span></span><br><span class="line"><span class="attr">  - system:</span>bootstrappers:kubeadm:default-node-token</span><br><span class="line"><span class="attr">  token:</span> abcdef<span class="number">.0123456789</span>abcdef</span><br><span class="line"><span class="attr">  ttl:</span> <span class="number">24</span>h0m0s</span><br><span class="line"><span class="attr">  usages:</span></span><br><span class="line"><span class="bullet">  -</span> signing</span><br><span class="line"><span class="bullet">  -</span> authentication</span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line"><span class="attr">  criSocket:</span> /var/run/containerd/containerd.sock</span><br><span class="line"><span class="attr">  name:</span> master</span><br><span class="line"><span class="attr">  taints:</span></span><br><span class="line"><span class="attr">  - effect:</span> NoSchedule</span><br><span class="line"><span class="attr">    key:</span> node-role.kubernetes.io/master</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://github.com/kubernetes/kubernetes/blob/master/cmd/kubeadm/app/apis/kubeadm/v1beta1/types.go</span></span><br><span class="line"><span class="comment"># https://github.com/kubernetes/kubernetes/blob/master/cmd/kubeadm/app/apis/kubeadm/v1alpha3/types.go</span></span><br><span class="line"><span class="attr">apiVersion:</span> kubeadm.k8s.io/v1alpha3</span><br><span class="line"><span class="attr">kind:</span> ClusterConfiguration</span><br><span class="line"><span class="attr">auditPolicy:</span></span><br><span class="line"><span class="attr">  logDir:</span> /var/log/kubernetes/audit</span><br><span class="line"><span class="attr">  logMaxAge:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">certificatesDir:</span> /etc/kubernetes/pki</span><br><span class="line"><span class="attr">clusterName:</span> kubernetes</span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">controllerManagerExtraArgs:</span></span><br><span class="line"><span class="attr">  address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">schedulerExtraArgs:</span></span><br><span class="line"><span class="attr">  address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line"><span class="attr">    dataDir:</span> /var/lib/etcd</span><br><span class="line"><span class="attr">    image:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">imageRepository:</span> k8s.gcr.io</span><br><span class="line"><span class="attr">kubernetesVersion:</span> v1<span class="number">.12</span><span class="number">.0</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line"><span class="attr">  dnsDomain:</span> cluster.local</span><br><span class="line"><span class="attr">  podSubnet:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">12</span></span><br><span class="line"><span class="attr">unifiedControlPlaneImage:</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> kubeadm.k8s.io/v1alpha3</span><br><span class="line"><span class="attr">kind:</span> JoinConfiguration</span><br><span class="line"><span class="attr">apiEndpoint:</span></span><br><span class="line"><span class="attr">  advertiseAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">  bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">caCertPath:</span> /etc/kubernetes/pki/ca.crt</span><br><span class="line"><span class="attr">clusterName:</span> kubernetes</span><br><span class="line"><span class="attr">discoveryFile:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">discoveryTimeout:</span> <span class="number">5</span>m0s</span><br><span class="line"><span class="attr">discoveryToken:</span> abcdef<span class="number">.0123456789</span>abcdef</span><br><span class="line"><span class="attr">discoveryTokenAPIServers:</span></span><br><span class="line"><span class="attr">- kube-apiserver:</span><span class="number">6443</span></span><br><span class="line"><span class="attr">discoveryTokenUnsafeSkipCAVerification:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line"><span class="attr">  criSocket:</span> /var/run/containerd/containerd.sock</span><br><span class="line"><span class="attr">  name:</span> master</span><br><span class="line"><span class="attr">tlsBootstrapToken:</span> abcdef<span class="number">.0123456789</span>abcdef</span><br><span class="line"><span class="attr">token:</span> abcdef<span class="number">.0123456789</span>abcdef</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line"><span class="attr">kind:</span> KubeProxyConfiguration</span><br><span class="line"><span class="attr">bindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">clientConnection:</span></span><br><span class="line"><span class="attr">  acceptContentTypes:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  burst:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  contentType:</span> application/vnd.kubernetes.protobuf</span><br><span class="line"><span class="attr">  kubeconfig:</span> /var/lib/kube-proxy/kubeconfig.conf</span><br><span class="line"><span class="attr">  qps:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">clusterCIDR:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">configSyncPeriod:</span> <span class="number">15</span>m0s</span><br><span class="line"><span class="attr">conntrack:</span></span><br><span class="line"><span class="attr">  max:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">  maxPerCore:</span> <span class="number">32768</span></span><br><span class="line"><span class="attr">  min:</span> <span class="number">131072</span></span><br><span class="line"><span class="attr">  tcpCloseWaitTimeout:</span> <span class="number">1</span>h0m0s</span><br><span class="line"><span class="attr">  tcpEstablishedTimeout:</span> <span class="number">24</span>h0m0s</span><br><span class="line"><span class="attr">enableProfiling:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">10256</span></span><br><span class="line"><span class="attr">hostnameOverride:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">iptables:</span></span><br><span class="line"><span class="attr">  masqueradeAll:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  masqueradeBit:</span> <span class="number">14</span></span><br><span class="line"><span class="attr">  minSyncPeriod:</span> <span class="number">0</span>s</span><br><span class="line"><span class="attr">  syncPeriod:</span> <span class="number">30</span>s</span><br><span class="line"><span class="attr">ipvs:</span></span><br><span class="line"><span class="attr">  excludeCIDRs:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">  minSyncPeriod:</span> <span class="number">0</span>s</span><br><span class="line"><span class="attr">  scheduler:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  syncPeriod:</span> <span class="number">30</span>s</span><br><span class="line"><span class="attr">metricsBindAddress:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">10249</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">nodePortAddresses:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">oomScoreAdj:</span> <span class="bullet">-999</span></span><br><span class="line"><span class="attr">portRange:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">resourceContainer:</span> /kube-proxy</span><br><span class="line"><span class="attr">udpIdleTimeout:</span> <span class="number">250</span>ms</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> kubelet.config.k8s.io/v1beta1</span><br><span class="line"><span class="attr">kind:</span> KubeletConfiguration</span><br><span class="line"><span class="attr">address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">authentication:</span></span><br><span class="line"><span class="attr">  anonymous:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  webhook:</span></span><br><span class="line"><span class="attr">    cacheTTL:</span> <span class="number">2</span>m0s</span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  x509:</span></span><br><span class="line"><span class="attr">    clientCAFile:</span> /etc/kubernetes/pki/ca.crt</span><br><span class="line"><span class="attr">authorization:</span></span><br><span class="line"><span class="attr">  mode:</span> Webhook</span><br><span class="line"><span class="attr">  webhook:</span></span><br><span class="line"><span class="attr">    cacheAuthorizedTTL:</span> <span class="number">5</span>m0s</span><br><span class="line"><span class="attr">    cacheUnauthorizedTTL:</span> <span class="number">30</span>s</span><br><span class="line"><span class="attr">cgroupDriver:</span> cgroupfs</span><br><span class="line"><span class="attr">cgroupsPerQOS:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">clusterDNS:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line"><span class="attr">clusterDomain:</span> cluster.local</span><br><span class="line"><span class="attr">configMapAndSecretChangeDetectionStrategy:</span> Watch</span><br><span class="line"><span class="attr">containerLogMaxFiles:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">containerLogMaxSize:</span> <span class="number">10</span>Mi</span><br><span class="line"><span class="attr">contentType:</span> application/vnd.kubernetes.protobuf</span><br><span class="line"><span class="attr">cpuCFSQuota:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">cpuCFSQuotaPeriod:</span> <span class="number">100</span>ms</span><br><span class="line"><span class="attr">cpuManagerPolicy:</span> none</span><br><span class="line"><span class="attr">cpuManagerReconcilePeriod:</span> <span class="number">10</span>s</span><br><span class="line"><span class="attr">enableControllerAttachDetach:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enableDebuggingHandlers:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enforceNodeAllocatable:</span></span><br><span class="line"><span class="bullet">-</span> pods</span><br><span class="line"><span class="attr">eventBurst:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">eventRecordQPS:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">evictionHard:</span></span><br><span class="line">  imagefs.available: <span class="number">15</span>%</span><br><span class="line">  memory.available: <span class="number">100</span>Mi</span><br><span class="line">  nodefs.available: <span class="number">10</span>%</span><br><span class="line">  nodefs.inodesFree: <span class="number">5</span>%</span><br><span class="line"><span class="attr">evictionPressureTransitionPeriod:</span> <span class="number">5</span>m0s</span><br><span class="line"><span class="attr">failSwapOn:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">fileCheckFrequency:</span> <span class="number">20</span>s</span><br><span class="line"><span class="attr">hairpinMode:</span> promiscuous-bridge</span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">healthzPort:</span> <span class="number">10248</span></span><br><span class="line"><span class="attr">httpCheckFrequency:</span> <span class="number">20</span>s</span><br><span class="line"><span class="attr">imageGCHighThresholdPercent:</span> <span class="number">85</span></span><br><span class="line"><span class="attr">imageGCLowThresholdPercent:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">imageMinimumGCAge:</span> <span class="number">2</span>m0s</span><br><span class="line"><span class="attr">iptablesDropBit:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">iptablesMasqueradeBit:</span> <span class="number">14</span></span><br><span class="line"><span class="attr">kubeAPIBurst:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">kubeAPIQPS:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">makeIPTablesUtilChains:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">maxOpenFiles:</span> <span class="number">1000000</span></span><br><span class="line"><span class="attr">maxPods:</span> <span class="number">110</span></span><br><span class="line"><span class="attr">nodeLeaseDurationSeconds:</span> <span class="number">40</span></span><br><span class="line"><span class="attr">nodeStatusUpdateFrequency:</span> <span class="number">10</span>s</span><br><span class="line"><span class="attr">oomScoreAdj:</span> <span class="bullet">-999</span></span><br><span class="line"><span class="attr">podPidsLimit:</span> <span class="bullet">-1</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">10250</span></span><br><span class="line"><span class="attr">registryBurst:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">registryPullQPS:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">resolvConf:</span> /etc/resolv.conf</span><br><span class="line"><span class="attr">rotateCertificates:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">runtimeRequestTimeout:</span> <span class="number">2</span>m0s</span><br><span class="line"><span class="attr">serializeImagePulls:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">staticPodPath:</span> /etc/kubernetes/manifests</span><br><span class="line"><span class="attr">streamingConnectionIdleTimeout:</span> <span class="number">4</span>h0m0s</span><br><span class="line"><span class="attr">syncFrequency:</span> <span class="number">1</span>m0s</span><br><span class="line"><span class="attr">volumeStatsAggPeriod:</span> <span class="number">1</span>m0s</span><br></pre></td></tr></table></figure>
<h2 id="traefikå¦‚ä½•è®¾ç½®è·¯ç”±"><a href="#traefikå¦‚ä½•è®¾ç½®è·¯ç”±" class="headerlink" title="traefikå¦‚ä½•è®¾ç½®è·¯ç”±"></a>traefikå¦‚ä½•è®¾ç½®è·¯ç”±</h2><p><a href="http://yunke.science/2018/03/28/Ingress-traefik/" target="_blank" rel="external">http://yunke.science/2018/03/28/Ingress-traefik/</a></p>
<h2 id="etcd-3-2-x-gt-3-3-x"><a href="#etcd-3-2-x-gt-3-3-x" class="headerlink" title="etcd 3.2.x -&gt; 3.3.x"></a>etcd 3.2.x -&gt; 3.3.x</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å…ˆè¿›è¡Œå¤‡ä»½</span></span><br><span class="line">ETCDCTL_API=3 etcdctl --endpoints 127.0.0.1:2379 --cacert=/etc/etcd/ssl/etcd-ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem snapshot save snapshot.db</span><br><span class="line"></span><br><span class="line"><span class="comment">#åœæ­¢etcd çŠ¶æ€</span></span><br><span class="line">systemctl stop etcd</span><br><span class="line"></span><br><span class="line"><span class="comment">#å‡çº§</span></span><br><span class="line">wget http://mirror.centos.org/centos/7/extras/x86_64/Packages/etcd-3.3.11-2.el7.centos.x86_64.rpm</span><br><span class="line">yum localinstall -y etcd-3.2.22-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯åŠ¨</span></span><br><span class="line">systemctl start etcd</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒèµ„æ–™ï¼š<br><a href="https://www.jianshu.com/p/aa528c57f3be" target="_blank" rel="external">https://www.jianshu.com/p/aa528c57f3be</a></p>
<h2 id="Coredns-ç›¸å…³æ“ä½œ"><a href="#Coredns-ç›¸å…³æ“ä½œ" class="headerlink" title="Coredns ç›¸å…³æ“ä½œ"></a>Coredns ç›¸å…³æ“ä½œ</h2><h3 id="å¦‚ä½•ä½¿ç”¨å¤–éƒ¨dnsè§£æ"><a href="#å¦‚ä½•ä½¿ç”¨å¤–éƒ¨dnsè§£æ" class="headerlink" title="å¦‚ä½•ä½¿ç”¨å¤–éƒ¨dnsè§£æ"></a>å¦‚ä½•ä½¿ç”¨å¤–éƒ¨dnsè§£æ</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> ConfigMap</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> coredns</span><br><span class="line"><span class="attr">  namespace:</span> kube-system</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">      addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  Corefile:</span> <span class="string">|</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        health</span><br><span class="line">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class="line">            pods insecure</span><br><span class="line">            # é»˜è®¤</span><br><span class="line">            upstream</span><br><span class="line">            # ç”¨äºè§£æå¤–éƒ¨ä¸»æœºä¸»æœºï¼ˆå¤–éƒ¨æœåŠ¡ï¼‰</span><br><span class="line">            # upstream 114.114.114.114 223.5.5.5</span><br><span class="line">            fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9153</span><br><span class="line">        # é»˜è®¤ä½¿ç”¨ä¸»æœºçš„</span><br><span class="line">        proxy . /etc/resolv.conf</span><br><span class="line">        # ä»»ä½•ä¸åœ¨é›†ç¾¤åŸŸå†…çš„æŸ¥è¯¢å°†è½¬å‘åˆ°é¢„å®šä¹‰çš„è§£æå™¨ï¼Œé»˜è®¤ï¼š/etc/resolv.confï¼›</span><br><span class="line">        # åœ¨coredns â€œDeploymentâ€èµ„æºä¸­â€œdnsPolicyâ€œè®¾ç½®ä¸ºâ€Defaultâ€ï¼Œå³æä¾›dnsæœåŠ¡çš„podä»æ‰€åœ¨èŠ‚ç‚¹ç»§æ‰¿/etc/resolv.confï¼Œå¦‚æœèŠ‚ç‚¹çš„ä¸Šæ¸¸è§£æåœ°å€ä¸â€upstreamâ€ä¸€è‡´ï¼Œåˆ™è®¾ç½®ä»»æ„ä¸€ä¸ªå‚æ•°å³å¯</span><br><span class="line">        #proxy . 114.114.114.114 223.5.5.5</span><br><span class="line">        cache 30</span><br><span class="line">        loop</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">&#125;</span><br><span class="line">#è‡ªå®šä¹‰dnsè®°å½•ï¼Œå¯¹åº”kube-dnsä¸­çš„stubdomainsï¼›</span><br><span class="line">#æ¯æ¡è®°å½•ï¼Œå•ç‹¬è®¾ç½®1å„zone</span><br><span class="line">    patsnap.local:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        cache 30</span><br><span class="line">        proxy . 192.168.3.108</span><br><span class="line">    &#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="å¦‚ä½•ç»™kubernetes-serviceåšcnameè§£æ"><a href="#å¦‚ä½•ç»™kubernetes-serviceåšcnameè§£æ" class="headerlink" title="å¦‚ä½•ç»™kubernetes serviceåšcnameè§£æ"></a>å¦‚ä½•ç»™kubernetes serviceåšcnameè§£æ</h3><h4 id="coredns-é…ç½®æ–‡ä»¶"><a href="#coredns-é…ç½®æ–‡ä»¶" class="headerlink" title="coredns é…ç½®æ–‡ä»¶"></a>coredns é…ç½®æ–‡ä»¶</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">  "kind":</span> <span class="string">"ConfigMap"</span>,</span><br><span class="line"><span class="attr">  "apiVersion":</span> <span class="string">"v1"</span>,</span><br><span class="line"><span class="attr">  "metadata":</span> &#123;</span><br><span class="line"><span class="attr">    "name":</span> <span class="string">"coredns"</span>,</span><br><span class="line"><span class="attr">    "namespace":</span> <span class="string">"kube-system"</span>,</span><br><span class="line"><span class="attr">    "selfLink":</span> <span class="string">"/api/v1/namespaces/kube-system/configmaps/coredns"</span>,</span><br><span class="line"><span class="attr">    "uid":</span> <span class="string">"aa45aaab-4c79-11e9-9629-00163e022859"</span>,</span><br><span class="line"><span class="attr">    "resourceVersion":</span> <span class="string">"118616"</span>,</span><br><span class="line"><span class="attr">    "creationTimestamp":</span> <span class="string">"2019-03-22T08:08:24Z"</span></span><br><span class="line">  &#125;,</span><br><span class="line"><span class="attr">  "data":</span> &#123;</span><br><span class="line">    //æ ¼å¼åŒ–å†…å®¹å¦‚ä¸‹</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ ¼å¼åŒ–åçš„æ•ˆæœï¼š</span></span><br><span class="line"><span class="attr">Corefile:</span></span><br><span class="line">.:<span class="number">53</span> &#123;</span><br><span class="line">    errors</span><br><span class="line">    health</span><br><span class="line">    kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class="line">       pods insecure</span><br><span class="line">       upstream</span><br><span class="line">       fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">    &#125;</span><br><span class="line">    prometheus :<span class="number">9153</span></span><br><span class="line">    proxy . /etc/resolv.conf</span><br><span class="line">    cache <span class="number">30</span></span><br><span class="line">    autopath @kubernetes</span><br><span class="line">    reload</span><br><span class="line">    file /etc/coredns/patsnap.io.zone  nexus.patsnap.io &#123;</span><br><span class="line">        upstream</span><br><span class="line">    &#125;</span><br><span class="line">    file /etc/coredns/patsnap.local.zone  patsnap.local &#123;</span><br><span class="line">        upstream</span><br><span class="line">    &#125;</span><br><span class="line">    file /etc/coredns/patsnap.com.zone  nexus.patsnap.com &#123;</span><br><span class="line">        upstream</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">patsnap.com.zone:</span><br><span class="line">;@ å½“å‰åŸŸå nexus.patsnap.com</span><br><span class="line">;<span class="number">900</span> è¡¨ç¤ºttl</span><br><span class="line">;ns<span class="bullet">-1304.</span>awsdns<span class="bullet">-35.</span>org. è¡¨ç¤ºæ ¹</span><br><span class="line">;icyboy.jiunile.com. è¡¨ç¤ºé‚®ç®± icyboy@jiunile.com</span><br><span class="line">@                   <span class="number">900</span>     IN      SOA         ns<span class="bullet">-1304.</span>awsdns<span class="bullet">-35.</span>org. icyboy.jiunile.com. (</span><br><span class="line">    <span class="number">2017033001</span> ; serial</span><br><span class="line">    <span class="number">7200</span>       ; refresh (<span class="number">2</span> hour)</span><br><span class="line">    <span class="number">900</span>        ; retry (<span class="number">15</span> min)</span><br><span class="line">    <span class="number">1209600</span>    ; expire</span><br><span class="line">    <span class="number">86400</span>      ; min TTL (<span class="number">1</span> day)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">;@ ç­‰ä»·äºnexus.patsnap.com CNAME åé¢çš„åŸŸåå¿…é¡»å†™å…¨</span><br><span class="line">@                            IN        CNAME       s-ops-maven-nexus.ops-qa.svc.cluster.local.</span><br><span class="line"></span><br><span class="line">patsnap.io.zone:</span><br><span class="line">@                   <span class="number">900</span>      IN      SOA         ns<span class="bullet">-196.</span>awsdns<span class="bullet">-24.</span>com. icyboy.jiunile.com. (</span><br><span class="line">    <span class="number">1</span></span><br><span class="line">    <span class="number">7200</span></span><br><span class="line">    <span class="number">900</span></span><br><span class="line">    <span class="number">1209600</span></span><br><span class="line">    <span class="number">86400</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">;npm ç­‰ä»·äºnpm.nexus.patsnap.io.</span><br><span class="line">npm                         IN      CNAME       s-ops-npm-pypi-nexus.ops-qa.svc.cluster.local.</span><br><span class="line">pypi                        IN      CNAME       s-ops-npm-pypi-nexus.ops-qa.svc.cluster.local.</span><br><span class="line"></span><br><span class="line">patsnap.local.zone:</span><br><span class="line">;@ å½“å‰åŸŸå patsnap.local</span><br><span class="line">;<span class="number">900</span> è¡¨ç¤ºttl</span><br><span class="line">;<span class="number">192.168</span><span class="number">.3</span><span class="number">.108</span>. è¡¨ç¤ºæ ¹</span><br><span class="line">;icyboy.jiunile.com. è¡¨ç¤ºé‚®ç®± icyboy@jiunile.com</span><br><span class="line">@                   <span class="number">900</span>     IN      SOA         <span class="number">192.168</span><span class="number">.3</span><span class="number">.108</span>. icyboy.jiunile.com. (</span><br><span class="line">    <span class="number">2019092202</span></span><br><span class="line">    <span class="number">21600</span></span><br><span class="line">    <span class="number">3600</span></span><br><span class="line">    <span class="number">604800</span></span><br><span class="line">    <span class="number">86400</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">ï¼›npm.nexus ç­‰ä»·äº npm.nexus.patsnap.local.</span><br><span class="line">npm.nexus                   IN      CNAME       s-ops-npm-pypi-nexus.ops-qa.svc.cluster.local.</span><br><span class="line">pypi.nexus                  IN      CNAME       s-ops-npm-pypi-nexus.ops-qa.svc.cluster.local.</span><br></pre></td></tr></table></figure>
<h4 id="coredns-deployment"><a href="#coredns-deployment" class="headerlink" title="coredns deployment"></a>coredns deployment</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">"volumes":</span> [</span><br><span class="line">          &#123;</span><br><span class="line"><span class="attr">            "name":</span> <span class="string">"config-volume"</span>,</span><br><span class="line"><span class="attr">            "configMap":</span> &#123;</span><br><span class="line"><span class="attr">              "name":</span> <span class="string">"coredns"</span>,</span><br><span class="line"><span class="attr">              "items":</span> [</span><br><span class="line">                &#123;</span><br><span class="line"><span class="attr">                  "key":</span> <span class="string">"Corefile"</span>,</span><br><span class="line"><span class="attr">                  "path":</span> <span class="string">"Corefile"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line"><span class="attr">                  "key":</span> <span class="string">"patsnap.io.zone"</span>,</span><br><span class="line"><span class="attr">                  "path":</span> <span class="string">"patsnap.io.zone"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line"><span class="attr">                  "key":</span> <span class="string">"patsnap.local.zone"</span>,</span><br><span class="line"><span class="attr">                  "path":</span> <span class="string">"patsnap.local.zone"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line"><span class="attr">                  "key":</span> <span class="string">"patsnap.com.zone"</span>,</span><br><span class="line"><span class="attr">                  "path":</span> <span class="string">"patsnap.com.zone"</span></span><br><span class="line">                &#125;</span><br><span class="line">              ],</span><br><span class="line"><span class="attr">              "defaultMode":</span> <span class="number">420</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒé“¾æ¥ï¼š<br><a href="https://www.cnblogs.com/netonline/p/9935228.html" target="_blank" rel="external">https://www.cnblogs.com/netonline/p/9935228.html</a><br><a href="https://yuerblog.cc/2018/12/29/k8s-dns/#post-4008-_Toc533670192" target="_blank" rel="external">https://yuerblog.cc/2018/12/29/k8s-dns/#post-4008-_Toc533670192</a><br><a href="https://github.com/coredns/coredns.io/blob/master/content/blog/custom-dns-and-kubernetes.md" target="_blank" rel="external">https://github.com/coredns/coredns.io/blob/master/content/blog/custom-dns-and-kubernetes.md</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Kubernetes æœåŠ¡è´¨é‡ Qos è§£æ]]></title>
      <url>http://team.jiunile.com/blog/2019/03/k8s-pod-qos.html</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>QoS</code>æ˜¯ Quality of Service çš„ç¼©å†™ï¼Œå³æœåŠ¡è´¨é‡ã€‚ä¸ºäº†å®ç°èµ„æºè¢«æœ‰æ•ˆè°ƒåº¦å’Œåˆ†é…çš„åŒæ—¶æé«˜èµ„æºåˆ©ç”¨ç‡ï¼Œ<code>kubernetes</code>é’ˆå¯¹ä¸åŒæœåŠ¡è´¨é‡çš„é¢„æœŸï¼Œé€šè¿‡ QoSï¼ˆQuality of Serviceï¼‰æ¥å¯¹ pod è¿›è¡ŒæœåŠ¡è´¨é‡ç®¡ç†ã€‚å¯¹äºä¸€ä¸ª pod æ¥è¯´ï¼ŒæœåŠ¡è´¨é‡ä½“ç°åœ¨ä¸¤ä¸ªå…·ä½“çš„æŒ‡æ ‡ï¼š<code>CPU å’Œå†…å­˜</code>ã€‚å½“èŠ‚ç‚¹ä¸Šå†…å­˜èµ„æºç´§å¼ æ—¶ï¼Œkubernetes ä¼šæ ¹æ®é¢„å…ˆè®¾ç½®çš„ä¸åŒ QoS ç±»åˆ«è¿›è¡Œç›¸åº”å¤„ç†ã€‚</p>
<p>QoS ä¸»è¦åˆ†ä¸º<code>Guaranteed</code>ã€<code>Burstable</code> å’Œ <code>Best-Effort</code>ä¸‰ç±»ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½ã€‚</p>
<h2 id="Guaranteed-æœ‰ä¿è¯çš„"><a href="#Guaranteed-æœ‰ä¿è¯çš„" class="headerlink" title="Guaranteed(æœ‰ä¿è¯çš„)"></a>Guaranteed(æœ‰ä¿è¯çš„)</h2><p>å¯¹äºç»‘å®š CPU å’Œå…·æœ‰ç›¸å¯¹å¯é¢„æµ‹æ€§çš„å·¥ä½œè´Ÿè½½ï¼ˆä¾‹å¦‚ï¼Œç”¨æ¥å¤„ç†è¯·æ±‚çš„ Web æœåŠ¡ï¼‰æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ QoS ç­‰çº§ã€‚å±äºè¯¥çº§åˆ«çš„podæœ‰ä»¥ä¸‹ä¸¤ç§ï¼š</p>
<ul>
<li><strong>Podä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½ä¸”ä»…è®¾ç½®äº† CPU å’Œå†…å­˜çš„ limits</strong></li>
<li><strong>podä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½è®¾ç½®äº† CPU å’Œå†…å­˜çš„ requests å’Œ limits ï¼Œä¸”å•ä¸ªå®¹å™¨å†…çš„requests==limitsï¼ˆrequestsä¸ç­‰äº0ï¼‰</strong><a id="more"></a>
<strong>ç¤ºä¾‹1ï¼špodä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½ä¸”ä»…è®¾ç½®äº†limits</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="attr">  name:</span> foo</span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">10</span>m</span><br><span class="line"><span class="attr">        memory:</span> <span class="number">1</span>Gi</span><br><span class="line"><span class="attr">  name:</span> bar</span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">100</span>m</span><br><span class="line"><span class="attr">        memory:</span> <span class="number">100</span>Mi</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>ç¤ºä¾‹2ï¼š pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½è®¾ç½®äº† requests å’Œ limitsï¼Œä¸”å•ä¸ªå®¹å™¨å†…çš„<code>requests==limits</code></strong><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="attr">  name:</span> foo</span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">10</span>m</span><br><span class="line"><span class="attr">        memory:</span> <span class="number">1</span>Gi</span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">10</span>m</span><br><span class="line"><span class="attr">        memory:</span> <span class="number">1</span>Gi</span><br><span class="line"></span><br><span class="line"><span class="attr">  name:</span> bar</span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">100</span>m</span><br><span class="line"><span class="attr">        memory:</span> <span class="number">100</span>Mi</span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">100</span>m</span><br><span class="line"><span class="attr">        memory:</span> <span class="number">100</span>Mi</span><br></pre></td></tr></table></figure></p>
<p>å®¹å™¨fooå’Œbarå†…resourcesçš„requestså’Œlimitså‡ç›¸ç­‰ï¼Œè¯¥podçš„QoSçº§åˆ«å±äº<code>Guaranteed</code>ã€‚</p>
<h2 id="Burstable-ä¸ç¨³å®šçš„"><a href="#Burstable-ä¸ç¨³å®šçš„" class="headerlink" title="Burstable(ä¸ç¨³å®šçš„)"></a>Burstable(ä¸ç¨³å®šçš„)</h2><p>è¿™å¯¹çŸ­æ—¶é—´å†…éœ€è¦æ¶ˆè€—å¤§é‡èµ„æºæˆ–è€…åˆå§‹åŒ–è¿‡ç¨‹å¾ˆå¯†é›†çš„å·¥ä½œè´Ÿè½½éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚ï¼šç”¨æ¥æ„å»º Docker å®¹å™¨çš„ Worker å’Œè¿è¡Œæœªä¼˜åŒ–çš„ JVM è¿›ç¨‹çš„å®¹å™¨éƒ½å¯ä»¥ä½¿ç”¨è¯¥ QoS ç­‰çº§ã€‚<strong>podä¸­åªè¦æœ‰ä¸€ä¸ªå®¹å™¨çš„requestså’Œlimitsçš„è®¾ç½®ä¸ç›¸åŒ</strong>ï¼Œè¯¥podçš„QoSå³ä¸º<code>Burstable</code>ã€‚</p>
<p><strong>ç¤ºä¾‹1ï¼šå®¹å™¨fooæŒ‡å®šäº†resourceï¼Œè€Œå®¹å™¨baræœªæŒ‡å®š</strong><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="attr">  name:</span> foo</span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">10</span>m</span><br><span class="line"><span class="attr">        memory:</span> <span class="number">1</span>Gi</span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">10</span>m</span><br><span class="line"><span class="attr">        memory:</span> <span class="number">1</span>Gi</span><br><span class="line"></span><br><span class="line"><span class="attr">  name:</span> bar</span><br></pre></td></tr></table></figure></p>
<p><strong>ç¤ºä¾‹2ï¼šå®¹å™¨fooè®¾ç½®äº†å†…å­˜limitsï¼Œè€Œå®¹å™¨barè®¾ç½®äº†CPU limits</strong><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="attr">  name:</span> foo</span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">1</span>Gi</span><br><span class="line"></span><br><span class="line"><span class="attr">  name:</span> bar</span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">100</span>m</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong><code>æ³¨æ„ï¼šè‹¥å®¹å™¨æŒ‡å®šäº†requestsè€ŒæœªæŒ‡å®šlimitsï¼Œåˆ™limitsçš„å€¼ç­‰äºèŠ‚ç‚¹resourceçš„æœ€å¤§å€¼ï¼›è‹¥å®¹å™¨æŒ‡å®šäº†limitsè€ŒæœªæŒ‡å®šrequestsï¼Œåˆ™requestsçš„å€¼ç­‰äºlimitsã€‚</code></strong></p>
</blockquote>
<h2 id="Best-Effort-å°½æœ€å¤§åŠªåŠ›"><a href="#Best-Effort-å°½æœ€å¤§åŠªåŠ›" class="headerlink" title="Best-Effort(å°½æœ€å¤§åŠªåŠ›)"></a>Best-Effort(å°½æœ€å¤§åŠªåŠ›)</h2><p>è¿™å¯¹äºå¯ä¸­æ–­å’Œä½ä¼˜å…ˆçº§çš„å·¥ä½œè´Ÿè½½éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚ï¼šè¿­ä»£è¿è¡Œçš„å¹‚ç­‰ä¼˜åŒ–è¿‡ç¨‹ã€‚<strong>å¦‚æœPodä¸­æ‰€æœ‰å®¹å™¨çš„resourceså‡æœªè®¾ç½®requestsä¸limits</strong>ï¼Œè¯¥podçš„QoSå³ä¸º<code>Best-Effort</code>ã€‚</p>
<p><strong>ç¤ºä¾‹1ï¼šå®¹å™¨fooå’Œå®¹å™¨barå‡æœªè®¾ç½®requestså’Œlimits</strong><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="attr">  name:</span> foo</span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">  name:</span> bar</span><br><span class="line"><span class="attr">    resources:</span></span><br></pre></td></tr></table></figure></p>
<h2 id="æ ¹æ®QoSè¿›è¡Œèµ„æºå›æ”¶ç­–ç•¥"><a href="#æ ¹æ®QoSè¿›è¡Œèµ„æºå›æ”¶ç­–ç•¥" class="headerlink" title="æ ¹æ®QoSè¿›è¡Œèµ„æºå›æ”¶ç­–ç•¥"></a>æ ¹æ®QoSè¿›è¡Œèµ„æºå›æ”¶ç­–ç•¥</h2><p>Kubernetes é€šè¿‡<code>cgroup</code>ç»™podè®¾ç½®QoSçº§åˆ«ï¼Œå½“èµ„æºä¸è¶³æ—¶å…ˆ<code>kill</code>ä¼˜å…ˆçº§ä½çš„ podï¼Œåœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡<code>OOM</code>åˆ†æ•°å€¼æ¥å®ç°ï¼Œ<code>OOM</code>åˆ†æ•°å€¼èŒƒå›´ä¸º0-1000ã€‚OOM åˆ†æ•°å€¼æ ¹æ®<code>OOM_ADJ</code>å‚æ•°è®¡ç®—å¾—å‡ºã€‚</p>
<p>å¯¹äº<code>Guaranteed</code>çº§åˆ«çš„ Podï¼ŒOOM_ADJå‚æ•°è®¾ç½®æˆäº†-998ï¼Œå¯¹äº<code>Best-Effort</code>çº§åˆ«çš„ Podï¼ŒOOM_ADJå‚æ•°è®¾ç½®æˆäº†1000ï¼Œå¯¹äº<code>Burstable</code>çº§åˆ«çš„ Podï¼ŒOOM_ADJå‚æ•°å–å€¼ä»2åˆ°999ã€‚</p>
<p>å¯¹äº kuberntes ä¿ç•™èµ„æºï¼Œæ¯”å¦‚kubeletï¼Œdockerï¼ŒOOM_ADJå‚æ•°è®¾ç½®æˆäº†-999ï¼Œè¡¨ç¤ºä¸ä¼šè¢«OOM killæ‰ã€‚<strong>OOM_ADJå‚æ•°è®¾ç½®çš„è¶Šå¤§ï¼Œè®¡ç®—å‡ºæ¥çš„OOMåˆ†æ•°è¶Šé«˜ï¼Œè¡¨æ˜è¯¥podä¼˜å…ˆçº§å°±è¶Šä½ï¼Œå½“å‡ºç°èµ„æºç«äº‰æ—¶ä¼šè¶Šæ—©è¢«killæ‰</strong>ï¼Œå¯¹äºOOM_ADJå‚æ•°æ˜¯-999çš„è¡¨ç¤ºkubernetesæ°¸è¿œä¸ä¼šå› ä¸ºOOMå°†å…¶killæ‰ã€‚</p>
<h2 id="QoS-podsè¢«killæ‰åœºæ™¯ä¸é¡ºåº"><a href="#QoS-podsè¢«killæ‰åœºæ™¯ä¸é¡ºåº" class="headerlink" title="QoS podsè¢«killæ‰åœºæ™¯ä¸é¡ºåº"></a>QoS podsè¢«killæ‰åœºæ™¯ä¸é¡ºåº</h2><ul>
<li><code>Best-Effort pods</code>ï¼šç³»ç»Ÿç”¨å®Œäº†å…¨éƒ¨å†…å­˜æ—¶ï¼Œè¯¥ç±»å‹ pods ä¼šæœ€å…ˆè¢«killæ‰ã€‚</li>
<li><code>Burstable pods</code>ï¼šç³»ç»Ÿç”¨å®Œäº†å…¨éƒ¨å†…å­˜ï¼Œä¸”æ²¡æœ‰ Best-Effort ç±»å‹çš„å®¹å™¨å¯ä»¥è¢« kill æ—¶ï¼Œè¯¥ç±»å‹çš„ pods ä¼šè¢« kill æ‰ã€‚</li>
<li><code>Guaranteed pods</code>ï¼šç³»ç»Ÿç”¨å®Œäº†å…¨éƒ¨å†…å­˜ï¼Œä¸”æ²¡æœ‰ Burstable ä¸ Best-Effort ç±»å‹çš„å®¹å™¨å¯ä»¥è¢« kill æ—¶ï¼Œè¯¥ç±»å‹çš„ pods ä¼šè¢« kill æ‰ã€‚</li>
</ul>
<h2 id="QoSä½¿ç”¨å»ºè®®"><a href="#QoSä½¿ç”¨å»ºè®®" class="headerlink" title="QoSä½¿ç”¨å»ºè®®"></a>QoSä½¿ç”¨å»ºè®®</h2><p>å¦‚æœèµ„æºå……è¶³ï¼Œå¯å°† QoS pods ç±»å‹å‡è®¾ç½®ä¸º<code>Guaranteed</code>ã€‚ç”¨è®¡ç®—èµ„æºæ¢ä¸šåŠ¡æ€§èƒ½å’Œç¨³å®šæ€§ï¼Œå‡å°‘æ’æŸ¥é—®é¢˜æ—¶é—´å’Œæˆæœ¬ã€‚å¦‚æœæƒ³æ›´å¥½çš„æé«˜èµ„æºåˆ©ç”¨ç‡ï¼Œ<strong>ä¸šåŠ¡æœåŠ¡</strong>å¯ä»¥è®¾ç½®ä¸º<code>Guaranteed</code>ï¼Œè€Œå…¶ä»–æœåŠ¡æ ¹æ®é‡è¦ç¨‹åº¦å¯åˆ†åˆ«è®¾ç½®ä¸º<code>Burstable</code>æˆ–<code>Best-Effort</code>ã€‚</p>
<p>åœ¨ææ¸…æ¥šæœåŠ¡ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°æ•…éšœä»¥åŠä¸ºä»€ä¹ˆä¼šå‡ºç°æ•…éšœä¹‹å‰ï¼Œéƒ½ä¸åº”è¯¥å°†å…¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ã€‚å¯é€šè¿‡ä¸€äº›æŠ€æœ¯æ‰‹æ®µï¼ˆ<strong>è´Ÿè½½å‹æµ‹ç­‰</strong>ï¼‰æ¥è®¾ç½®åº”ç”¨çš„èµ„æº limits å’Œ requestsã€‚è¿™å°†ä¼šä¸ºä½ çš„ç³»ç»Ÿå¢åŠ å¼¹æ€§èƒ½åŠ›å’Œå¯é¢„æµ‹æ€§ã€‚</p>
<p>åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œè®°å½•æœåŠ¡å¤±è´¥æ—¶åšäº†å“ªäº›æ“ä½œæ˜¯è‡³å…³é‡è¦çš„ã€‚å¯ä»¥å°†å‘ç°çš„æ•…éšœæ¨¡å¼æ·»åŠ åˆ°ç›¸å…³çš„ä¹¦ç±å’Œæ–‡æ¡£ä¸­ï¼Œè¿™å¯¹åˆ†ç±»ç”Ÿäº§ç¯å¢ƒä¸­å‡ºç°çš„é—®é¢˜å¾ˆæœ‰ç”¨ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°çš„ä¸€äº›æ•…éšœæ¨¡å¼ï¼š</p>
<ul>
<li>å†…å­˜ç¼“æ…¢å¢åŠ </li>
<li>CPU ä½¿ç”¨ç‡è¾¾åˆ° 100%</li>
<li>å“åº”æ—¶é—´å¤ªé•¿</li>
<li>è¯·æ±‚è¢«ä¸¢å¼ƒ</li>
<li>ä¸åŒè¯·æ±‚çš„å“åº”æ—¶é—´å·®å¼‚å¾ˆå¤§</li>
</ul>
<p>ä½ æœ€å¥½å°†è¿™äº›å‘ç°éƒ½æ”¶é›†èµ·æ¥ï¼Œä»¥å¤‡ä¸æ—¶ä¹‹éœ€ï¼Œå› ä¸ºæœ‰ä¸€å¤©å®ƒä»¬å¯èƒ½ä¼šä¸ºä½ æˆ–å›¢é˜ŸèŠ‚çœä¸€æ•´å¤©çš„æ—¶é—´ã€‚</p>
<h2 id="ä¸€äº›æœ‰ç”¨çš„å·¥å…·"><a href="#ä¸€äº›æœ‰ç”¨çš„å·¥å…·" class="headerlink" title="ä¸€äº›æœ‰ç”¨çš„å·¥å…·"></a>ä¸€äº›æœ‰ç”¨çš„å·¥å…·</h2><h3 id="Loader-io"><a href="#Loader-io" class="headerlink" title="Loader.io"></a>Loader.io</h3><p><a href="http://loader.io/" target="_blank" rel="external">Loader.io</a> æ˜¯ä¸€ä¸ªåœ¨çº¿è´Ÿè½½æµ‹è¯•å·¥å…·ï¼Œå®ƒå…è®¸ä½ é…ç½®è´Ÿè½½å¢åŠ æµ‹è¯•å’Œè´Ÿè½½ä¸å˜æµ‹è¯•ï¼Œåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å¯è§†åŒ–åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œè´Ÿè½½ï¼Œå¹¶èƒ½å¿«é€Ÿå¯åŠ¨å’Œåœæ­¢æµ‹è¯•ã€‚å®ƒä¹Ÿä¼šä¿å­˜æµ‹è¯•ç»“æœçš„å†å²è®°å½•ï¼Œå› æ­¤åœ¨èµ„æºé™åˆ¶å‘ç”Ÿå˜åŒ–æ—¶å¾ˆå®¹æ˜“å¯¹ç»“æœè¿›è¡Œæ¯”è¾ƒã€‚<br><img src="/images/k8s/loader.jpg" alt="Loader"></p>
<h3 id="Kubescope-cli"><a href="#Kubescope-cli" class="headerlink" title="Kubescope cli"></a>Kubescope cli</h3><p><a href="https://github.com/hharnisc/kubescope-cli" target="_blank" rel="external">Kubescope cli</a> æ˜¯ä¸€ä¸ªå¯ä»¥è¿è¡Œåœ¨æœ¬åœ°æˆ– Kubernetes ä¸­çš„å·¥å…·ï¼Œå¯ç›´æ¥ä» Docker Daemon ä¸­æ”¶é›†å®¹å™¨æŒ‡æ ‡å¹¶å¯è§†åŒ–ã€‚å’Œ <code>cAdvisor</code> ç­‰å…¶ä»–é›†ç¾¤æŒ‡æ ‡æ”¶é›†æœåŠ¡ä¸€æ ·ï¼Œ <code>kubescope cli</code> æ”¶é›†æŒ‡æ ‡çš„å‘¨æœŸæ˜¯ 1 ç§’ï¼ˆè€Œä¸æ˜¯ 10-15 ç§’ï¼‰ã€‚å¦‚æœå‘¨æœŸæ˜¯ 10-15 ç§’ï¼Œä½ å¯èƒ½ä¼šåœ¨æµ‹è¯•æœŸé—´é”™è¿‡ä¸€äº›å¼•å‘æ€§èƒ½ç“¶é¢ˆçš„é—®é¢˜ã€‚å¦‚æœä½ ä½¿ç”¨ cAdvisor è¿›è¡Œæµ‹è¯•ï¼Œæ¯æ¬¡éƒ½è¦ä½¿ç”¨æ–°çš„ Pod ä½œä¸ºæµ‹è¯•å¯¹è±¡ï¼Œå› ä¸º Kubernetes åœ¨è¶…è¿‡èµ„æºé™åˆ¶æ—¶å°±ä¼šå°† Pod æ€æ­»ï¼Œç„¶åé‡æ–°å¯åŠ¨ä¸€ä¸ªå…¨æ–°çš„ Podã€‚è€Œ <code>kubescope cli</code> å°±æ²¡æœ‰è¿™æ–¹é¢çš„å¿§è™‘ï¼Œå®ƒç›´æ¥ä» Docker Daemon ä¸­æ”¶é›†å®¹å™¨æŒ‡æ ‡ï¼ˆä½ å¯ä»¥è‡ªå®šä¹‰æ”¶é›†æŒ‡æ ‡çš„æ—¶é—´é—´éš”ï¼‰ï¼Œå¹¶ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥é€‰æ‹©å’Œè¿‡æ»¤ä½ æƒ³è¦æ˜¾ç¤ºçš„å®¹å™¨ã€‚<br><img src="/images/k8s/kubescope-cli.gif" alt="kubescope-cli"></p>
<p>æ¥æºï¼š</p>
<ul>
<li>é˜³æ˜çš„åšå®¢</li>
<li>Ryan Yang</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ç†è§£ kubernetes äº²å’Œæ€§è°ƒåº¦]]></title>
      <url>http://team.jiunile.com/blog/2019/03/k8s-affinity.html</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éƒ¨ç½²çš„ Pod æ˜¯é€šè¿‡é›†ç¾¤çš„è‡ªåŠ¨è°ƒåº¦ç­–ç•¥æ¥é€‰æ‹©èŠ‚ç‚¹çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹è°ƒåº¦å™¨è€ƒè™‘çš„æ˜¯èµ„æºè¶³å¤Ÿï¼Œå¹¶ä¸”è´Ÿè½½å°½é‡å¹³å‡ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™æˆ‘ä»¬éœ€è¦èƒ½å¤Ÿæ›´åŠ ç»†ç²’åº¦çš„å»æ§åˆ¶ Pod çš„è°ƒåº¦ï¼Œæ¯”å¦‚æˆ‘ä»¬å†…éƒ¨çš„ä¸€äº›æœåŠ¡ gitlab ä¹‹ç±»çš„ä¹Ÿæ˜¯è·‘åœ¨<code>Kubernetes</code>é›†ç¾¤ä¸Šçš„ï¼Œæˆ‘ä»¬å°±ä¸å¸Œæœ›å¯¹å¤–çš„ä¸€äº›æœåŠ¡å’Œå†…éƒ¨çš„æœåŠ¡è·‘åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šäº†ï¼Œå®³æ€•å†…éƒ¨æœåŠ¡å¯¹å¤–éƒ¨çš„æœåŠ¡äº§ç”Ÿå½±å“ï¼›ä½†æ˜¯æœ‰çš„æ—¶å€™æˆ‘ä»¬çš„æœåŠ¡ä¹‹é—´äº¤æµæ¯”è¾ƒé¢‘ç¹ï¼Œåˆå¸Œæœ›èƒ½å¤Ÿå°†è¿™ä¸¤ä¸ªæœåŠ¡çš„ Pod è°ƒåº¦åˆ°åŒä¸€ä¸ªçš„èŠ‚ç‚¹ä¸Šã€‚è¿™å°±éœ€è¦ç”¨åˆ° Kubernetes é‡Œé¢çš„ä¸€ä¸ªæ¦‚å¿µï¼šäº²å’Œæ€§å’Œåäº²å’Œæ€§ã€‚</p>
<p>äº²å’Œæ€§æœ‰åˆ†æˆèŠ‚ç‚¹äº²å’Œæ€§(<code>nodeAffinity</code>)å’Œ Pod äº²å’Œæ€§(<code>podAffinity</code>)ã€‚</p>
<h2 id="nodeSelector"><a href="#nodeSelector" class="headerlink" title="nodeSelector"></a>nodeSelector</h2><p>åœ¨äº†è§£äº²å’Œæ€§ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„è°ƒåº¦æ–¹å¼ï¼šnodeSelectorã€‚æˆ‘ä»¬çŸ¥é“labelæ˜¯kubernetesä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œç”¨æˆ·å¯ä»¥éå¸¸çµæ´»çš„åˆ©ç”¨ label æ¥ç®¡ç†é›†ç¾¤ä¸­çš„èµ„æºï¼Œæ¯”å¦‚æœ€å¸¸è§çš„ä¸€ä¸ªå°±æ˜¯ service é€šè¿‡åŒ¹é… label å»åŒ¹é… Pod èµ„æºï¼Œè€Œ Pod çš„è°ƒåº¦ä¹Ÿå¯ä»¥æ ¹æ®èŠ‚ç‚¹çš„ label æ¥è¿›è¡Œè°ƒåº¦ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹æˆ‘ä»¬çš„ node çš„ labelï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes --show-labels</span><br><span class="line">NAME      STATUS    ROLES     AGE       VERSION   LABELS</span><br><span class="line">master    Ready     master    147d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=master,node-role.kubernetes.io/master=</span><br><span class="line">node02    Ready     &lt;none&gt;    67d       v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,course=k8s,kubernetes.io/hostname=node02</span><br><span class="line">node03    Ready     &lt;none&gt;    127d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,jnlp=haimaxy,kubernetes.io/hostname=node03</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨æˆ‘ä»¬å…ˆç»™èŠ‚ç‚¹node02å¢åŠ ä¸€ä¸ªcom=youdianzhishiçš„æ ‡ç­¾ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl label nodes node02 com=youdianzhishi</span><br><span class="line">node <span class="string">"node02"</span> labeled</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šé¢çš„<code>--show-labels</code>å‚æ•°å¯ä»¥æŸ¥çœ‹ä¸Šè¿°æ ‡ç­¾æ˜¯å¦ç”Ÿæ•ˆã€‚å½“ node è¢«æ‰“ä¸Šäº†ç›¸å…³æ ‡ç­¾åï¼Œåœ¨è°ƒåº¦çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨è¿™äº›æ ‡ç­¾äº†ï¼Œåªéœ€è¦åœ¨ Pod çš„<code>spec</code>å­—æ®µä¸­æ·»åŠ nodeSelectorå­—æ®µï¼Œé‡Œé¢æ˜¯æˆ‘ä»¬éœ€è¦è¢«è°ƒåº¦çš„èŠ‚ç‚¹çš„ label å³å¯ã€‚æ¯”å¦‚ï¼Œä¸‹é¢çš„ Pod æˆ‘ä»¬è¦å¼ºåˆ¶è°ƒåº¦åˆ° node02 è¿™ä¸ªèŠ‚ç‚¹ä¸Šå»ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ nodeSelector æ¥è¡¨ç¤ºäº†ï¼š(node-selector-demo.yaml)<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Pod</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> busybox-pod</span><br><span class="line"><span class="attr">  name:</span> test-busybox</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - command:</span></span><br><span class="line"><span class="bullet">    -</span> sleep</span><br><span class="line"><span class="bullet">    -</span> <span class="string">"3600"</span></span><br><span class="line"><span class="attr">    image:</span> busybox</span><br><span class="line"><span class="attr">    imagePullPolicy:</span> Always</span><br><span class="line"><span class="attr">    name:</span> test-busybox</span><br><span class="line"><span class="attr">  nodeSelector:</span></span><br><span class="line"><span class="attr">    com:</span> youdianzhishi</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡ describe å‘½ä»¤æŸ¥çœ‹è°ƒåº¦ç»“æœï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create <span class="_">-f</span> node-selector-demo.yaml</span><br><span class="line">pod <span class="string">"test-busybox"</span> created</span><br><span class="line">$ kubectl describe pod <span class="built_in">test</span>-busybox</span><br><span class="line">Name:         <span class="built_in">test</span>-busybox</span><br><span class="line">Namespace:    default</span><br><span class="line">Node:         node02/10.151.30.63</span><br><span class="line">......</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  com=youdianzhishi</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason                 Age   From               Message</span><br><span class="line">  ----    ------                 ----  ----               -------</span><br><span class="line">  Normal  SuccessfulMountVolume  55s   kubelet, node02    MountVolume.SetUp succeeded <span class="keyword">for</span> volume <span class="string">"default-token-n9w2d"</span></span><br><span class="line">  Normal  Scheduled              54s   default-scheduler  Successfully assigned <span class="built_in">test</span>-busybox to node02</span><br><span class="line">  Normal  Pulling                54s   kubelet, node02    pulling image <span class="string">"busybox"</span></span><br><span class="line">  Normal  Pulled                 40s   kubelet, node02    Successfully pulled image <span class="string">"busybox"</span></span><br><span class="line">  Normal  Created                40s   kubelet, node02    Created container</span><br><span class="line">  Normal  Started                40s   kubelet, node02    Started container</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Events ä¸‹é¢çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬çš„ Pod é€šè¿‡é»˜è®¤çš„ default-scheduler è°ƒåº¦å™¨è¢«ç»‘å®šåˆ°äº†node02èŠ‚ç‚¹ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯<code>nodeSelector</code>å±äºå¼ºåˆ¶æ€§çš„ï¼Œå¦‚æœæˆ‘ä»¬çš„ç›®æ ‡èŠ‚ç‚¹æ²¡æœ‰å¯ç”¨çš„èµ„æºï¼Œæˆ‘ä»¬çš„ Pod å°±ä¼šä¸€ç›´å¤„äº Pending çŠ¶æ€ï¼Œè¿™å°±æ˜¯<code>nodeSelector</code>çš„ç”¨æ³•ã€‚</p>
<p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥æ„Ÿå—åˆ°<code>nodeSelector</code>çš„æ–¹å¼æ¯”è¾ƒç›´è§‚ï¼Œä½†æ˜¯è¿˜å¤Ÿçµæ´»ï¼Œæ§åˆ¶ç²’åº¦åå¤§ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†å’Œå¤§å®¶äº†è§£ä¸‹æ›´åŠ çµæ´»çš„æ–¹å¼ï¼šèŠ‚ç‚¹äº²å’Œæ€§(<code>nodeAffinity</code>)ã€‚</p>
<h2 id="äº²å’Œæ€§å’Œåäº²å’Œæ€§è°ƒåº¦"><a href="#äº²å’Œæ€§å’Œåäº²å’Œæ€§è°ƒåº¦" class="headerlink" title="äº²å’Œæ€§å’Œåäº²å’Œæ€§è°ƒåº¦"></a>äº²å’Œæ€§å’Œåäº²å’Œæ€§è°ƒåº¦</h2><p>æˆ‘ä»¬äº†è§£äº† kubernetes è°ƒåº¦å™¨çš„ä¸€ä¸ªè°ƒåº¦æµç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“é»˜è®¤çš„è°ƒåº¦å™¨åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œç»è¿‡äº† predicates å’Œ priorities ä¸¤ä¸ªé˜¶æ®µï¼Œä½†æ˜¯åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¾€å¾€æˆ‘ä»¬éœ€è¦æ ¹æ®è‡ªå·±çš„ä¸€äº›å®é™…éœ€æ±‚æ¥æ§åˆ¶ pod çš„è°ƒåº¦ï¼Œè¿™å°±éœ€è¦ç”¨åˆ° nodeAffinity(èŠ‚ç‚¹äº²å’Œæ€§)ã€podAffinity(pod äº²å’Œæ€§) ä»¥åŠ podAntiAffinity(pod åäº²å’Œæ€§)ã€‚</p>
<p>äº²å’Œæ€§è°ƒåº¦å¯ä»¥åˆ†æˆè½¯ç­–ç•¥å’Œç¡¬ç­–ç•¥ä¸¤ç§æ–¹å¼:</p>
<ul>
<li><code>è½¯ç­–ç•¥</code>å°±æ˜¯å¦‚æœä½ æ²¡æœ‰æ»¡è¶³è°ƒåº¦è¦æ±‚çš„èŠ‚ç‚¹çš„è¯ï¼Œpod å°±ä¼šå¿½ç•¥è¿™æ¡è§„åˆ™ï¼Œç»§ç»­å®Œæˆè°ƒåº¦è¿‡ç¨‹ï¼Œè¯´ç™½äº†å°±æ˜¯æ»¡è¶³æ¡ä»¶æœ€å¥½äº†ï¼Œæ²¡æœ‰çš„è¯ä¹Ÿæ— æ‰€è°“äº†çš„ç­–ç•¥</li>
<li><code>ç¡¬ç­–ç•¥</code>å°±æ¯”è¾ƒå¼ºç¡¬äº†ï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹çš„è¯ï¼Œå°±ä¸æ–­é‡è¯•ç›´åˆ°æ»¡è¶³æ¡ä»¶ä¸ºæ­¢ï¼Œç®€å•è¯´å°±æ˜¯ä½ å¿…é¡»æ»¡è¶³æˆ‘çš„è¦æ±‚ï¼Œä¸ç„¶æˆ‘å°±ä¸å¹²çš„ç­–ç•¥ã€‚</li>
</ul>
<p>å¯¹äºäº²å’Œæ€§å’Œåäº²å’Œæ€§éƒ½æœ‰è¿™ä¸¤ç§è§„åˆ™å¯ä»¥è®¾ç½®ï¼š <code>preferredDuringSchedulingIgnoredDuringExecution</code>å’Œ<code>requiredDuringSchedulingIgnoredDuringExecution</code>ï¼Œå‰é¢çš„å°±æ˜¯è½¯ç­–ç•¥ï¼Œåé¢çš„å°±æ˜¯ç¡¬ç­–ç•¥ã€‚</p>
<blockquote>
<p>è¿™å‘½åä¸è§‰å¾—æœ‰ç‚¹åäººç±»å—ï¼Ÿæœ‰ç‚¹æ— è¯­â€¦â€¦</p>
</blockquote>
<h2 id="nodeAffinity"><a href="#nodeAffinity" class="headerlink" title="nodeAffinity"></a>nodeAffinity</h2><p>èŠ‚ç‚¹äº²å’Œæ€§ä¸»è¦æ˜¯ç”¨æ¥æ§åˆ¶ pod è¦éƒ¨ç½²åœ¨å“ªäº›ä¸»æœºä¸Šï¼Œä»¥åŠä¸èƒ½éƒ¨ç½²åœ¨å“ªäº›ä¸»æœºä¸Šçš„ã€‚å®ƒå¯ä»¥è¿›è¡Œä¸€äº›ç®€å•çš„é€»è¾‘ç»„åˆäº†ï¼Œä¸åªæ˜¯ç®€å•çš„ç›¸ç­‰åŒ¹é…ã€‚</p>
<p>æ¯”å¦‚ç°åœ¨æˆ‘ä»¬ç”¨ä¸€ä¸ª Deployment æ¥ç®¡ç†3ä¸ª pod å‰¯æœ¬ï¼Œç°åœ¨æˆ‘ä»¬æ¥æ§åˆ¶ä¸‹è¿™äº› pod çš„è°ƒåº¦ï¼Œå¦‚ä¸‹ä¾‹å­ï¼šï¼ˆnode-affinity-demo.yamlï¼‰<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> apps/v1beta1</span><br><span class="line"><span class="attr">kind:</span> Deployment</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> affinity</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> affinity</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  revisionHistoryLimit:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> affinity</span><br><span class="line"><span class="attr">        role:</span> test</span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> nginx</span><br><span class="line"><span class="attr">        image:</span> nginx:<span class="number">1.7</span><span class="number">.9</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          name:</span> nginxweb</span><br><span class="line"><span class="attr">      affinity:</span></span><br><span class="line"><span class="attr">        nodeAffinity:</span></span><br><span class="line"><span class="attr">          requiredDuringSchedulingIgnoredDuringExecution:</span>  <span class="comment"># ç¡¬ç­–ç•¥</span></span><br><span class="line"><span class="attr">            nodeSelectorTerms:</span></span><br><span class="line"><span class="attr">            - matchExpressions:</span></span><br><span class="line"><span class="attr">              - key:</span> kubernetes.io/hostname</span><br><span class="line"><span class="attr">                operator:</span> NotIn</span><br><span class="line"><span class="attr">                values:</span></span><br><span class="line"><span class="bullet">                -</span> node03</span><br><span class="line"><span class="attr">          preferredDuringSchedulingIgnoredDuringExecution:</span>  <span class="comment"># è½¯ç­–ç•¥</span></span><br><span class="line"><span class="attr">          - weight:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">            preference:</span></span><br><span class="line"><span class="attr">              matchExpressions:</span></span><br><span class="line"><span class="attr">              - key:</span> com</span><br><span class="line"><span class="attr">                operator:</span> In</span><br><span class="line"><span class="attr">                values:</span></span><br><span class="line"><span class="bullet">                -</span> youdianzhishi</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢è¿™ä¸ª pod é¦–å…ˆæ˜¯è¦æ±‚ä¸èƒ½è¿è¡Œåœ¨ node03 è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæœ‰ä¸ªèŠ‚ç‚¹æ»¡è¶³<code>com=youdianzhishi</code>çš„è¯å°±ä¼˜å…ˆè°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šã€‚</p>
<p>ä¸‹é¢æ˜¯æˆ‘ä»¬æµ‹è¯•çš„èŠ‚ç‚¹åˆ—è¡¨ä¿¡æ¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes --show-labels</span><br><span class="line">NAME      STATUS    ROLES     AGE       VERSION   LABELS</span><br><span class="line">master    Ready     master    154d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=master,node-role.kubernetes.io/master=</span><br><span class="line">node02    Ready     &lt;none&gt;    74d       v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,com=youdianzhishi,course=k8s,kubernetes.io/hostname=node02</span><br><span class="line">node03    Ready     &lt;none&gt;    134d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,jnlp=haimaxy,kubernetes.io/hostname=node03</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ° node02 èŠ‚ç‚¹æœ‰<code>com=youdianzhishi</code>è¿™æ ·çš„ labelï¼ŒæŒ‰è¦æ±‚ä¼šä¼˜å…ˆè°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹æ¥çš„ï¼Œç°åœ¨æˆ‘ä»¬æ¥åˆ›å»ºè¿™ä¸ª podï¼Œç„¶åä½¿ç”¨descirbeå‘½ä»¤æŸ¥çœ‹å…·ä½“çš„è°ƒåº¦æƒ…å†µæ˜¯å¦æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create <span class="_">-f</span> node-affinity-demo.yaml</span><br><span class="line">deployment.apps <span class="string">"affinity"</span> created</span><br><span class="line">$ kubectl get pods <span class="_">-l</span> app=affinity -o wide</span><br><span class="line">NAME                        READY     STATUS    RESTARTS   AGE       IP             NODE</span><br><span class="line">affinity-7b4c946854-5gfln   1/1       Running   0          47s       10.244.4.214   node02</span><br><span class="line">affinity-7b4c946854<span class="_">-l</span>8b47   1/1       Running   0          47s       10.244.4.215   node02</span><br><span class="line">affinity-7b4c946854-r86p5   1/1       Running   0          47s       10.244.4.213   node02</span><br></pre></td></tr></table></figure></p>
<p>ä»ç»“æœå¯ä»¥çœ‹å‡º pod éƒ½è¢«éƒ¨ç½²åˆ°äº† node02ï¼Œå…¶ä»–èŠ‚ç‚¹ä¸Šæ²¡æœ‰éƒ¨ç½² podï¼Œè¿™é‡Œçš„åŒ¹é…é€»è¾‘æ˜¯ label çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­ï¼Œç°åœ¨<code>Kubernetes</code>æä¾›çš„æ“ä½œç¬¦æœ‰ä¸‹é¢çš„å‡ ç§ï¼š</p>
<ul>
<li>Inï¼šlabel çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­</li>
<li>NotInï¼šlabel çš„å€¼ä¸åœ¨æŸä¸ªåˆ—è¡¨ä¸­</li>
<li>Gtï¼šlabel çš„å€¼å¤§äºæŸä¸ªå€¼</li>
<li>Ltï¼šlabel çš„å€¼å°äºæŸä¸ªå€¼</li>
<li>Existsï¼šæŸä¸ª label å­˜åœ¨</li>
<li>DoesNotExistï¼šæŸä¸ª label ä¸å­˜åœ¨</li>
</ul>
<blockquote>
<p>å¦‚æœ<code>nodeSelectorTerms</code>ä¸‹é¢æœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œæ»¡è¶³ä»»ä½•ä¸€ä¸ªæ¡ä»¶å°±å¯ä»¥äº†ï¼›å¦‚æœ<code>matchExpressions</code>æœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œåˆ™å¿…é¡»åŒæ—¶æ»¡è¶³è¿™äº›æ¡ä»¶æ‰èƒ½æ­£å¸¸è°ƒåº¦ PODã€‚</p>
</blockquote>
<h2 id="podAffinity"><a href="#podAffinity" class="headerlink" title="podAffinity"></a>podAffinity</h2><p>pod äº²å’Œæ€§ä¸»è¦è§£å†³ pod å¯ä»¥å’Œå“ªäº› pod éƒ¨ç½²åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸­çš„é—®é¢˜ï¼ˆå…¶ä¸­æ‹“æ‰‘åŸŸç”¨ä¸»æœºæ ‡ç­¾å®ç°ï¼Œå¯ä»¥æ˜¯å•ä¸ªä¸»æœºï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªä¸»æœºç»„æˆçš„ clusterã€zone ç­‰ç­‰ï¼‰ï¼Œè€Œ pod åäº²å’Œæ€§ä¸»è¦æ˜¯è§£å†³ pod ä¸èƒ½å’Œå“ªäº› pod éƒ¨ç½²åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸­çš„é—®é¢˜ï¼Œå®ƒä»¬éƒ½æ˜¯å¤„ç†çš„ pod ä¸ pod ä¹‹é—´çš„å…³ç³»ï¼Œæ¯”å¦‚ä¸€ä¸ª pod åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šäº†ï¼Œé‚£ä¹ˆæˆ‘è¿™ä¸ªä¹Ÿå¾—åœ¨è¿™ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…ä½ è¿™ä¸ª pod åœ¨èŠ‚ç‚¹ä¸Šäº†ï¼Œé‚£ä¹ˆæˆ‘å°±ä¸æƒ³å’Œä½ å¾…åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚</p>
<p>ç”±äºæˆ‘ä»¬è¿™é‡Œåªæœ‰ä¸€ä¸ªé›†ç¾¤ï¼Œå¹¶æ²¡æœ‰åŒºåŸŸæˆ–è€…æœºæˆ¿çš„æ¦‚å¿µï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç›´æ¥ä½¿ç”¨ä¸»æœºåæ¥ä½œä¸ºæ‹“æ‰‘åŸŸï¼ŒæŠŠ pod åˆ›å»ºåœ¨åŒä¸€ä¸ªä¸»æœºä¸Šé¢ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes --show-labels</span><br><span class="line">NAME      STATUS    ROLES     AGE       VERSION   LABELS</span><br><span class="line">master    Ready     master    154d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=master,node-role.kubernetes.io/master=</span><br><span class="line">node02    Ready     &lt;none&gt;    74d       v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,com=youdianzhishi,course=k8s,kubernetes.io/hostname=node02</span><br><span class="line">node03    Ready     &lt;none&gt;    134d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,jnlp=haimaxy,kubernetes.io/hostname=node03</span><br></pre></td></tr></table></figure></p>
<p>åŒæ ·ï¼Œè¿˜æ˜¯é’ˆå¯¹ä¸Šé¢çš„èµ„æºå¯¹è±¡ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸‹ pod çš„äº²å’Œæ€§ï¼šï¼ˆpod-affinity-demo.yamlï¼‰<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> apps/v1beta1</span><br><span class="line"><span class="attr">kind:</span> Deployment</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> affinity</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> affinity</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  revisionHistoryLimit:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> affinity</span><br><span class="line"><span class="attr">        role:</span> test</span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> nginx</span><br><span class="line"><span class="attr">        image:</span> nginx:<span class="number">1.7</span><span class="number">.9</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          name:</span> nginxweb</span><br><span class="line"><span class="attr">      affinity:</span></span><br><span class="line"><span class="attr">        podAffinity:</span></span><br><span class="line"><span class="attr">          requiredDuringSchedulingIgnoredDuringExecution:</span>  <span class="comment"># ç¡¬ç­–ç•¥</span></span><br><span class="line"><span class="attr">          - labelSelector:</span></span><br><span class="line"><span class="attr">              matchExpressions:</span></span><br><span class="line"><span class="attr">              - key:</span> app</span><br><span class="line"><span class="attr">                operator:</span> In</span><br><span class="line"><span class="attr">                values:</span></span><br><span class="line"><span class="bullet">                -</span> busybox-pod</span><br><span class="line"><span class="attr">            topologyKey:</span> kubernetes.io/hostname</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­çš„ pod éœ€è¦è°ƒåº¦åˆ°æŸä¸ªæŒ‡å®šçš„ä¸»æœºä¸Šï¼Œè‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†è¿™æ ·çš„ podï¼šè¿™ä¸ª pod æœ‰ä¸€ä¸ª<code>app=busybox-pod</code>çš„ labelã€‚</p>
<p>æˆ‘ä»¬æŸ¥çœ‹æœ‰æ ‡ç­¾<code>app=busybox-pod</code>çš„ pod åˆ—è¡¨ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -o wide <span class="_">-l</span> app=busybox-pod</span><br><span class="line">NAME           READY     STATUS    RESTARTS   AGE       IP             NODE</span><br><span class="line"><span class="built_in">test</span>-busybox   1/1       Running   164        7d        10.244.4.205   node02</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ª pod è¿è¡Œåœ¨äº† node02 çš„èŠ‚ç‚¹ä¸Šé¢ï¼Œæ‰€ä»¥æŒ‰ç…§ä¸Šé¢çš„äº²å’Œæ€§æ¥è¯´ï¼Œä¸Šé¢æˆ‘ä»¬éƒ¨ç½²çš„3ä¸ª pod å‰¯æœ¬ä¹Ÿåº”è¯¥è¿è¡Œåœ¨ node02 èŠ‚ç‚¹ä¸Šï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -o wide <span class="_">-l</span> app=affinity</span><br><span class="line">NAME                        READY     STATUS    RESTARTS   AGE       IP             NODE</span><br><span class="line">affinity-564f9d7db9-lzzvq   1/1       Running   0          3m        10.244.4.216   node02</span><br><span class="line">affinity-564f9d7db9-p79cq   1/1       Running   0          3m        10.244.4.217   node02</span><br><span class="line">affinity-564f9d7db9-spfzs   1/1       Running   0          3m        10.244.4.218   node02</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœæˆ‘ä»¬æŠŠä¸Šé¢çš„ test-busybox å’Œ affinity è¿™ä¸ª Deployment éƒ½åˆ é™¤ï¼Œç„¶åé‡æ–°åˆ›å»º affinity è¿™ä¸ªèµ„æºï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ­£å¸¸è°ƒåº¦å‘¢ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete <span class="_">-f</span> node-selector-demo.yaml</span><br><span class="line">pod <span class="string">"test-busybox"</span> deleted</span><br><span class="line">$ kubectl delete <span class="_">-f</span> pod-affinity-demo.yaml</span><br><span class="line">deployment.apps <span class="string">"affinity"</span> deleted</span><br><span class="line">$ kubectl create <span class="_">-f</span> pod-affinity-demo.yaml</span><br><span class="line">deployment.apps <span class="string">"affinity"</span> created</span><br><span class="line">$ kubectl get pods -o wide <span class="_">-l</span> app=affinity</span><br><span class="line">NAME                        READY     STATUS    RESTARTS   AGE       IP        NODE</span><br><span class="line">affinity-564f9d7db9-fbc8w   0/1       Pending   0          2m        &lt;none&gt;    &lt;none&gt;</span><br><span class="line">affinity-564f9d7db9-n8gcf   0/1       Pending   0          2m        &lt;none&gt;    &lt;none&gt;</span><br><span class="line">affinity-564f9d7db9-qc7x6   0/1       Pending   0          2m        &lt;none&gt;    &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤„äº<code>Pending</code>çŠ¶æ€äº†ï¼Œè¿™æ˜¯å› ä¸ºç°åœ¨æ²¡æœ‰ä¸€ä¸ªèŠ‚ç‚¹ä¸Šé¢æ‹¥æœ‰<code>busybox-pod</code>è¿™ä¸ª label çš„ podï¼Œè€Œä¸Šé¢æˆ‘ä»¬çš„è°ƒåº¦ä½¿ç”¨çš„æ˜¯ç¡¬ç­–ç•¥ï¼Œæ‰€ä»¥å°±æ²¡åŠæ³•è¿›è¡Œè°ƒåº¦äº†ï¼Œå¤§å®¶å¯ä»¥å»å°è¯•ä¸‹é‡æ–°å°† test-busybox è¿™ä¸ª pod è°ƒåº¦åˆ° node03 è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼Œçœ‹çœ‹ä¸Šé¢çš„ affinity çš„3ä¸ªå‰¯æœ¬ä¼šä¸ä¼šä¹Ÿè¢«è°ƒåº¦åˆ° node03 è¿™ä¸ªèŠ‚ç‚¹ä¸Šå»ï¼Ÿ</p>
<p>æˆ‘ä»¬è¿™ä¸ªåœ°æ–¹ä½¿ç”¨çš„æ˜¯<code>kubernetes.io/hostname</code>è¿™ä¸ªæ‹“æ‰‘åŸŸï¼Œæ„æ€å°±æ˜¯æˆ‘ä»¬å½“å‰è°ƒåº¦çš„ pod è¦å’Œç›®æ ‡çš„ pod å¤„äºåŒä¸€ä¸ªä¸»æœºä¸Šé¢ï¼Œå› ä¸ºè¦å¤„äºåŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸‹é¢ï¼Œä¸ºäº†è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æŠŠæ‹“æ‰‘åŸŸæ”¹æˆ<code>beta.kubernetes.io/os</code>ï¼ŒåŒæ ·çš„æˆ‘ä»¬å½“å‰è°ƒåº¦çš„ pod è¦å’Œç›®æ ‡çš„ pod å¤„äºåŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸­ï¼Œç›®æ ‡çš„ pod æ˜¯ä¸æ˜¯æ‹¥æœ‰<code>beta.kubernetes.io/os=linux</code>çš„æ ‡ç­¾ï¼Œè€Œæˆ‘ä»¬è¿™é‡Œ3ä¸ªèŠ‚ç‚¹éƒ½æœ‰è¿™æ ·çš„æ ‡ç­¾ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬3ä¸ªèŠ‚ç‚¹éƒ½åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œçš„ pod å¯èƒ½ä¼šè¢«è°ƒåº¦åˆ°ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME                                      READY     STATUS      RESTARTS   AGE       IP             NODE</span><br><span class="line">affinity-7d86749984-glkhz                 1/1       Running     0          3m        10.244.2.16    node03</span><br><span class="line">affinity-7d86749984-h4fb9                 1/1       Running     0          3m        10.244.4.219   node02</span><br><span class="line">affinity-7d86749984-tj7k2                 1/1       Running     0          3m        10.244.2.14    node03</span><br></pre></td></tr></table></figure></p>
<h2 id="podAntiAffinity"><a href="#podAntiAffinity" class="headerlink" title="podAntiAffinity"></a>podAntiAffinity</h2><p>è¿™å°±æ˜¯ pod äº²å’Œæ€§çš„ç”¨æ³•ï¼Œè€Œ pod åäº²å’Œæ€§åˆ™æ˜¯åç€æ¥çš„ï¼Œæ¯”å¦‚ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†æŸä¸ª podï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ pod åˆ™å¸Œæœ›è¢«è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šå»ï¼ŒåŒæ ·æˆ‘ä»¬æŠŠä¸Šé¢çš„ podAffinity ç›´æ¥æ”¹æˆ podAntiAffinityï¼Œ(pod-antiaffinity-demo.yaml)<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> apps/v1beta1</span><br><span class="line"><span class="attr">kind:</span> Deployment</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> affinity</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> affinity</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  revisionHistoryLimit:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> affinity</span><br><span class="line"><span class="attr">        role:</span> test</span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> nginx</span><br><span class="line"><span class="attr">        image:</span> nginx:<span class="number">1.7</span><span class="number">.9</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          name:</span> nginxweb</span><br><span class="line"><span class="attr">      affinity:</span></span><br><span class="line"><span class="attr">        podAntiAffinity:</span></span><br><span class="line"><span class="attr">          requiredDuringSchedulingIgnoredDuringExecution:</span>  <span class="comment"># ç¡¬ç­–ç•¥</span></span><br><span class="line"><span class="attr">          - labelSelector:</span></span><br><span class="line"><span class="attr">              matchExpressions:</span></span><br><span class="line"><span class="attr">              - key:</span> app</span><br><span class="line"><span class="attr">                operator:</span> In</span><br><span class="line"><span class="attr">                values:</span></span><br><span class="line"><span class="bullet">                -</span> busybox-pod</span><br><span class="line"><span class="attr">            topologyKey:</span> kubernetes.io/hostname</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œçš„æ„æ€å°±æ˜¯å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ä¸Šé¢æœ‰ä¸€ä¸ª<code>app=busybox-pod</code>è¿™æ ·çš„ pod çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ pod å°±åˆ«è°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šé¢æ¥ï¼Œä¸Šé¢æˆ‘ä»¬æŠŠ<code>app=busybox-pod</code>è¿™ä¸ª pod å›ºå®šåˆ°äº† node03 è¿™ä¸ªèŠ‚ç‚¹ä¸Šé¢æ¥ï¼Œæ‰€ä»¥æ­£å¸¸æ¥è¯´æˆ‘ä»¬è¿™é‡Œçš„ pod ä¸ä¼šå‡ºç°åœ¨ node03 èŠ‚ç‚¹ä¸Šï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create <span class="_">-f</span> pod-antiaffinity-demo.yaml</span><br><span class="line">deployment.apps <span class="string">"affinity"</span> created</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME                                      READY     STATUS      RESTARTS   AGE       IP             NODE</span><br><span class="line">affinity-bcbd8854f-br8z8                  1/1       Running     0          5s        10.244.4.222   node02</span><br><span class="line">affinity-bcbd8854f-cdffh                  1/1       Running     0          5s        10.244.4.223   node02</span><br><span class="line">affinity-bcbd8854f-htb52                  1/1       Running     0          5s        10.244.4.224   node02</span><br><span class="line"><span class="built_in">test</span>-busybox                              1/1       Running     0          23m       10.244.2.10    node03</span><br></pre></td></tr></table></figure></p>
<p>è¿™å°±æ˜¯ pod åäº²å’Œæ€§çš„ç”¨æ³•ã€‚</p>
<h2 id="æ±¡ç‚¹ï¼ˆtaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰"><a href="#æ±¡ç‚¹ï¼ˆtaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰" class="headerlink" title="æ±¡ç‚¹ï¼ˆtaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰"></a>æ±¡ç‚¹ï¼ˆtaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰</h2><p>å¯¹äº<code>nodeAffinity</code>æ— è®ºæ˜¯ç¡¬ç­–ç•¥è¿˜æ˜¯è½¯ç­–ç•¥æ–¹å¼ï¼Œéƒ½æ˜¯è°ƒåº¦ pod åˆ°é¢„æœŸèŠ‚ç‚¹ä¸Šï¼Œè€Œ<code>Taints</code>æ°å¥½ä¸ä¹‹ç›¸åï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ ‡è®°ä¸º Taints ï¼Œé™¤é pod ä¹Ÿè¢«æ ‡è¯†ä¸ºå¯ä»¥å®¹å¿æ±¡ç‚¹èŠ‚ç‚¹ï¼Œå¦åˆ™è¯¥ Taints èŠ‚ç‚¹ä¸ä¼šè¢«è°ƒåº¦ podã€‚</p>
<p>æ¯”å¦‚ç”¨æˆ·å¸Œæœ›æŠŠ Master èŠ‚ç‚¹ä¿ç•™ç»™ Kubernetes ç³»ç»Ÿç»„ä»¶ä½¿ç”¨ï¼Œæˆ–è€…æŠŠä¸€ç»„å…·æœ‰ç‰¹æ®Šèµ„æºé¢„ç•™ç»™æŸäº› podï¼Œåˆ™æ±¡ç‚¹å°±å¾ˆæœ‰ç”¨äº†ï¼Œpod ä¸ä¼šå†è¢«è°ƒåº¦åˆ° taint æ ‡è®°è¿‡çš„èŠ‚ç‚¹ã€‚æˆ‘ä»¬ä½¿ç”¨<code>kubeadm</code>æ­å»ºçš„é›†ç¾¤é»˜è®¤å°±ç»™ master èŠ‚ç‚¹æ·»åŠ äº†ä¸€ä¸ªæ±¡ç‚¹æ ‡è®°ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬å¹³æ—¶çš„ pod éƒ½æ²¡æœ‰è¢«è°ƒåº¦åˆ° master ä¸Šå»ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe node master</span><br><span class="line">Name:               master</span><br><span class="line">Roles:              master</span><br><span class="line">Labels:             beta.kubernetes.io/arch=amd64</span><br><span class="line">                    beta.kubernetes.io/os=linux</span><br><span class="line">                    kubernetes.io/hostname=master</span><br><span class="line">                    node-role.kubernetes.io/master=</span><br><span class="line">......</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">Unschedulable:      <span class="literal">false</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤æŸ¥çœ‹ master èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå…¶ä¸­æœ‰ä¸€æ¡å…³äº Taints çš„ä¿¡æ¯ï¼šnode-role.kubernetes.io/master:NoScheduleï¼Œå°±è¡¨ç¤ºç»™ master èŠ‚ç‚¹æ‰“äº†ä¸€ä¸ªæ±¡ç‚¹çš„æ ‡è®°ï¼Œå…¶ä¸­å½±å“çš„å‚æ•°æ˜¯<code>NoSchedule</code>ï¼Œè¡¨ç¤º pod ä¸ä¼šè¢«è°ƒåº¦åˆ°æ ‡è®°ä¸º taints çš„èŠ‚ç‚¹ï¼Œé™¤äº† NoSchedule å¤–ï¼Œè¿˜æœ‰å¦å¤–ä¸¤ä¸ªé€‰é¡¹ï¼š</p>
<ul>
<li><code>PreferNoSchedule</code>ï¼šNoSchedule çš„è½¯ç­–ç•¥ç‰ˆæœ¬ï¼Œè¡¨ç¤ºå°½é‡ä¸è°ƒåº¦åˆ°æ±¡ç‚¹èŠ‚ç‚¹ä¸Šå»</li>
<li><code>NoExecute</code>ï¼šè¯¥é€‰é¡¹æ„å‘³ç€ä¸€æ—¦ Taint ç”Ÿæ•ˆï¼Œå¦‚è¯¥èŠ‚ç‚¹å†…æ­£åœ¨è¿è¡Œçš„ pod æ²¡æœ‰å¯¹åº” Tolerate è®¾ç½®ï¼Œä¼šç›´æ¥è¢«é€å‡º</li>
</ul>
<p>æ±¡ç‚¹ taint æ ‡è®°èŠ‚ç‚¹çš„å‘½ä»¤å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint nodes node02 <span class="built_in">test</span>=node02:NoSchedule</span><br><span class="line">node <span class="string">"node02"</span> tainted</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„å‘½åå°† node02 èŠ‚ç‚¹æ ‡è®°ä¸ºäº†æ±¡ç‚¹ï¼Œå½±å“ç­–ç•¥æ˜¯ NoScheduleï¼Œåªä¼šå½±å“æ–°çš„ pod è°ƒåº¦ï¼Œå¦‚æœä»ç„¶å¸Œæœ›æŸä¸ª pod è°ƒåº¦åˆ° taint èŠ‚ç‚¹ä¸Šï¼Œåˆ™å¿…é¡»åœ¨ Spec ä¸­åšå‡º<code>Toleration</code>å®šä¹‰ï¼Œæ‰èƒ½è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œæ¯”å¦‚ç°åœ¨æˆ‘ä»¬æƒ³è¦å°†ä¸€ä¸ª pod è°ƒåº¦åˆ° master èŠ‚ç‚¹ï¼š(taint-demo.yaml)<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> apps/v1beta1</span><br><span class="line"><span class="attr">kind:</span> Deployment</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> taint</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> taint</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> taint</span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> nginx</span><br><span class="line"><span class="attr">        image:</span> nginx:<span class="number">1.7</span><span class="number">.9</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> http</span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">      - key:</span> <span class="string">"node-role.kubernetes.io/master"</span></span><br><span class="line"><span class="attr">        operator:</span> <span class="string">"Exists"</span></span><br><span class="line"><span class="attr">        effect:</span> <span class="string">"NoSchedule"</span></span><br></pre></td></tr></table></figure></p>
<p>ç”±äº master èŠ‚ç‚¹è¢«æ ‡è®°ä¸ºäº†æ±¡ç‚¹èŠ‚ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œè¦æƒ³ pod èƒ½å¤Ÿè°ƒåº¦åˆ° master èŠ‚ç‚¹å»ï¼Œå°±éœ€è¦å¢åŠ å®¹å¿çš„å£°æ˜ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="attr">- key:</span> <span class="string">"node-role.kubernetes.io/master"</span></span><br><span class="line"><span class="attr">  operator:</span> <span class="string">"Exists"</span></span><br><span class="line"><span class="attr">  effect:</span> <span class="string">"NoSchedule"</span></span><br></pre></td></tr></table></figure></p>
<p>ç„¶ååˆ›å»ºä¸Šé¢çš„èµ„æºï¼ŒæŸ¥çœ‹ç»“æœï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create <span class="_">-f</span> taint-demo.yaml</span><br><span class="line">deployment.apps <span class="string">"taint"</span> created</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME                                      READY     STATUS             RESTARTS   AGE       IP             NODE</span><br><span class="line">......</span><br><span class="line">taint-845d8bb4fb-57mhm                    1/1       Running            0          1m        10.244.4.247   node02</span><br><span class="line">taint-845d8bb4fb-bbvmp                    1/1       Running            0          1m        10.244.0.33    master</span><br><span class="line">taint-845d8bb4fb-zb78x                    1/1       Running            0          1m        10.244.4.246   node02</span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª pod å‰¯æœ¬è¢«è°ƒåº¦åˆ°äº† master èŠ‚ç‚¹ï¼Œè¿™å°±æ˜¯å®¹å¿çš„ä½¿ç”¨æ–¹æ³•ã€‚</p>
<p>å¯¹äº tolerations å±æ€§çš„å†™æ³•ï¼Œå…¶ä¸­çš„ keyã€valueã€effect ä¸ Node çš„ Taint è®¾ç½®éœ€ä¿æŒä¸€è‡´ï¼Œ è¿˜æœ‰ä»¥ä¸‹å‡ ç‚¹è¯´æ˜ï¼š</p>
<ul>
<li>1.å¦‚æœ operator çš„å€¼æ˜¯ Existsï¼Œåˆ™ value å±æ€§å¯çœç•¥</li>
<li>2.å¦‚æœ operator çš„å€¼æ˜¯ Equalï¼Œåˆ™è¡¨ç¤ºå…¶ key ä¸ value ä¹‹é—´çš„å…³ç³»æ˜¯ equal(ç­‰äº)</li>
<li>3.å¦‚æœä¸æŒ‡å®š operator å±æ€§ï¼Œåˆ™é»˜è®¤å€¼ä¸º Equal</li>
</ul>
<p>å¦å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªç‰¹æ®Šå€¼ï¼š</p>
<ul>
<li>1.ç©ºçš„ key å¦‚æœå†é…åˆ Exists å°±èƒ½åŒ¹é…æ‰€æœ‰çš„ key ä¸ valueï¼Œä¹Ÿæ˜¯æ˜¯èƒ½å®¹å¿æ‰€æœ‰ node çš„æ‰€æœ‰ Taints</li>
<li>2.ç©ºçš„ effect åŒ¹é…æ‰€æœ‰çš„ effect</li>
</ul>
<p>æœ€åï¼Œå¦‚æœæˆ‘ä»¬è¦å–æ¶ˆèŠ‚ç‚¹çš„æ±¡ç‚¹æ ‡è®°ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint nodes node02 <span class="built_in">test</span>-</span><br><span class="line">node <span class="string">"node02"</span> untainted</span><br></pre></td></tr></table></figure></p>
<p>è¿™å°±æ˜¯æ±¡ç‚¹å’Œå®¹å¿çš„ä½¿ç”¨æ–¹æ³•ã€‚                                                                                             </p>
<p>æ¥æºï¼šwww.qikqiak.com</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[åœ¨é˜¿é‡Œäº‘ä½¿ç”¨Kubeadm 1.13.x éƒ¨ç½²å¤šMasteré›†ç¾¤]]></title>
      <url>http://team.jiunile.com/blog/2019/02/k8s-kubeadm-ha-1-13-x.html</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€ï¼ˆå‘ï¼‰"><a href="#å‰è¨€ï¼ˆå‘ï¼‰" class="headerlink" title="å‰è¨€ï¼ˆå‘ï¼‰"></a>å‰è¨€ï¼ˆå‘ï¼‰</h2><p><strong>è´Ÿè½½å‡è¡¡é—®é¢˜</strong></p>
<ul>
<li>é˜¿é‡Œä¸æ”¯æŒLVSï¼Œæ²¡æœ‰vipå¯ç”¨ï¼Œå¿…é¡»é€šè¿‡ç”³è¯·SLBæ¥å›ºå®šVIP</li>
<li>å› Kubernetes apiserverä¸ºhttpsåè®®ï¼Œé˜¿é‡ŒSLBä¸­èƒ½è´Ÿè½½å‡è¡¡HTTPSçš„åªæœ‰TCPæ–¹å¼ï¼Œä½†TCPåè®®ä¸èƒ½è½¬å‘åˆ°å‘èµ·ä¸»æœºï¼ˆ<code>apiserver éœ€è¦æœ‰å›ç¯è·¯è®¿é—®ï¼Œç®€å•è¯´å°±æ˜¯è‡ªå·±ç»™è‡ªå·±å‘è¯·æ±‚</code>ï¼‰</li>
</ul>
<p>ä¸ºäº†è§£å†³kubernets apiserveré«˜å¯ç”¨é—®é¢˜ï¼Œæ•…ç”¨ä»¥ä¸‹æ–¹å¼æ¥è§£å†³ï¼š</p>
<ul>
<li>ç”³è¯·ä¸€ä¸ªå†…ç½‘çš„SLBï¼ˆè·å–VIPï¼‰ï¼Œ8443ä¸ºç›‘å¬ç«¯å£ï¼Œ6443ä¸ºapiserverçš„åç«¯ç«¯å£</li>
<li>åœ¨æ¯å°masteræœºå™¨ä¸Šæ­å»ºkeepalived+haproxyï¼ŒVIP ç”¨SLBçš„VIP</li>
</ul>
<h2 id="ç¯å¢ƒä»‹ç»"><a href="#ç¯å¢ƒä»‹ç»" class="headerlink" title="ç¯å¢ƒä»‹ç»"></a>ç¯å¢ƒä»‹ç»</h2><table>
<thead>
<tr>
<th style="text-align:left">IP</th>
<th style="text-align:left">Hostname</th>
<th style="text-align:left">å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">172.19.170.183</td>
<td style="text-align:left">master-1</td>
<td style="text-align:left">å®‰è£…keepalived + haproxy</td>
</tr>
<tr>
<td style="text-align:left">172.19.170.184</td>
<td style="text-align:left">master-2</td>
<td style="text-align:left">å®‰è£…keepalived + haproxy</td>
</tr>
<tr>
<td style="text-align:left">172.19.170.185</td>
<td style="text-align:left">master-3</td>
<td style="text-align:left">å®‰è£…keepalived + haproxy</td>
</tr>
<tr>
<td style="text-align:left">172.19.170.186</td>
<td style="text-align:left">node-1</td>
<td style="text-align:left">æ— </td>
</tr>
<tr>
<td style="text-align:left">172.19.170.187</td>
<td style="text-align:left">node-2</td>
<td style="text-align:left">æ— </td>
</tr>
<tr>
<td style="text-align:left">172.19.170.100</td>
<td style="text-align:left">vip</td>
<td style="text-align:left">ç”³è¯·é˜¿é‡Œäº‘çš„SLBè·å–åˆ°</td>
</tr>
</tbody>
</table>
<h2 id="ç¯å¢ƒåˆå§‹åŒ–"><a href="#ç¯å¢ƒåˆå§‹åŒ–" class="headerlink" title="ç¯å¢ƒåˆå§‹åŒ–"></a>ç¯å¢ƒåˆå§‹åŒ–</h2><h3 id="ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ"><a href="#ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ" class="headerlink" title="ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ"></a>ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;&gt; /etc/hosts</span><br><span class="line">172.19.170.183 master-1</span><br><span class="line">172.19.170.184 master-2</span><br><span class="line">172.19.170.185 master-3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨master-1-æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"><a href="#åœ¨master-1-æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š" class="headerlink" title="åœ¨master-1 æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"></a>åœ¨master-1 æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id root@master-2</span><br><span class="line">ssh-copy-id root@master-3</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="ä¼˜åŒ–æ‰€æœ‰master-amp-node-èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ"><a href="#ä¼˜åŒ–æ‰€æœ‰master-amp-node-èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ" class="headerlink" title="ä¼˜åŒ–æ‰€æœ‰master &amp; node èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ"></a>ä¼˜åŒ–æ‰€æœ‰master &amp; node èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ</h3><blockquote>
<p><code>åœ¨æ‰€æœ‰master &amp; node æœºå™¨ä¸Šéƒ½è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment"># å®‰è£…4.18ç‰ˆæœ¬å†…æ ¸</span></span><br><span class="line"><span class="comment"># ç”±äºæœ€æ–°ç¨³å®šç‰ˆ4.19å†…æ ¸å°†nf_conntrack_ipv4æ›´åä¸ºnf_conntrackï¼Œç›®å‰çš„kube-proxyä¸æ”¯æŒåœ¨4.19ç‰ˆæœ¬å†…æ ¸ä¸‹å¼€å¯ipvs</span></span><br><span class="line"><span class="comment"># è¯¦æƒ…å¯ä»¥æŸ¥çœ‹ï¼šhttps://github.com/kubernetes/kubernetes/issues/70304</span></span><br><span class="line"><span class="comment"># å¯¹äºè¯¥é—®é¢˜çš„ä¿®å¤10æœˆ30æ—¥åˆšåˆšåˆå¹¶åˆ°ä»£ç ä¸»å¹²ï¼Œæ‰€ä»¥ç›®å‰è¿˜æ²¡æœ‰åŒ…å«æ­¤ä¿®å¤çš„kubernetesç‰ˆæœ¬å‘å‡º</span></span><br><span class="line"><span class="comment"># å¯ä»¥é€‰æ‹©å®‰è£…4.18ç‰ˆæœ¬å†…æ ¸ï¼Œæˆ–è€…ä¸å¼€å¯IPVS</span></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment">############################# start #############################</span></span><br><span class="line"><span class="comment"># å‡çº§å†…æ ¸</span></span><br><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm ;yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml -y</span><br><span class="line"> </span><br><span class="line"><span class="comment"># æ£€æŸ¥é»˜è®¤å†…æ ¸ç‰ˆæœ¬æ˜¯å¦å¤§äº4.14ï¼Œå¦åˆ™è¯·è°ƒæ•´é»˜è®¤å¯åŠ¨å‚æ•°</span></span><br><span class="line">grub2-editenv list</span><br><span class="line"> </span><br><span class="line"><span class="comment">#é‡å¯ä»¥æ›´æ¢å†…æ ¸</span></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯ip_vs</span></span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">ipvs_modules_dir=<span class="string">"/usr/lib/modules/\`uname -r\`/kernel/net/netfilter/ipvs"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> \`ls \<span class="variable">$ipvs_modules_dir</span> | sed  -r <span class="string">'s#(.*).ko.*#\1#'</span>\`; <span class="keyword">do</span></span><br><span class="line">    /sbin/modinfo -F filename \<span class="variable">$i</span>  &amp;&gt; /dev/null</span><br><span class="line">    <span class="keyword">if</span> [ \$? <span class="_">-eq</span> 0 ]; <span class="keyword">then</span></span><br><span class="line">        /sbin/modprobe \<span class="variable">$i</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ£€æŸ¥æ˜¯å¦å¼€å¯äº†ip_vs</span></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vs</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# end #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼˜åŒ–å†…æ ¸</span></span><br><span class="line">cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.inotify.max_user_instances = 8192</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">vm.swappiness = 0</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡ŒsysctlæŠ¥é”™è¯·å‚è€ƒcentos7æ·»åŠ bridge-nf-call-ip6tableså‡ºç°No such file or directory: https://blog.csdn.net/airuozhaoyang/article/details/40534953</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼˜åŒ–æ–‡ä»¶æ‰“å¼€æ•°</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* soft nofile 65536"</span> &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* hard nofile 65536"</span> &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* soft nproc 65536"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* hard nproc 65536"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* soft  memlock  unlimited"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* hard memlock  unlimited"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­Selinux/firewalld</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­äº¤æ¢åˆ†åŒº</span></span><br><span class="line">swapoff <span class="_">-a</span></span><br><span class="line">yes | cp /etc/fstab /etc/fstab_bak</span><br><span class="line">cat /etc/fstab_bak |grep -v swap &gt; /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒæ­¥æ—¶é—´</span></span><br><span class="line">yum install -y ntpdate</span><br><span class="line">ntpdate -u ntp.api.bz</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®kubernet yumæº</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…kubernet</span></span><br><span class="line">yum install kubeadm-1.13.3-0 kubelet-1.13.3-0 kubectl-1.13.3-0 --disableexcludes=kubernetes -y</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®dockeræº</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/docker.repo &lt;&lt;EOF</span><br><span class="line">[docker]</span><br><span class="line">name=Docker Repository</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/repo/centos7</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…docker-engine</span></span><br><span class="line">yum -y install docker-engine-1.13.1 --disableexcludes=docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®kubeletå¯åŠ¨é…ç½®</span></span><br><span class="line">cgroupDriver=$(docker info|grep Cg)</span><br><span class="line">driver=<span class="variable">$&#123;cgroupDriver##*: &#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"driver is <span class="variable">$&#123;driver&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_NETWORK_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_DNS_ARGS=--cluster-dns=10.96.0.10 --cluster-domain=cluster.local"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_AUTHZ_ARGS=--authorization-mode=Webhook --client-ca-file=/etc/kubernetes/pki/ca.crt"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CGROUP_ARGS=--cgroup-driver=<span class="variable">$&#123;driver&#125;</span>"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CERTIFICATE_ARGS=--rotate-certificates=true --cert-dir=/var/lib/kubelet/pki"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_EXTRA_ARGS=--system-reserved=cpu=200m,memory=250Mi --kube-reserved=cpu=200m,memory=250Mi --eviction-soft=memory.available&lt;500Mi,nodefs.available&lt;2Gi --eviction-soft-grace-period=memory.available=1m30s,nodefs.available=1m30s --eviction-max-pod-grace-period=120 --eviction-hard=memory.available&lt;500Mi,nodefs.available&lt;1Gi --eviction-minimum-reclaim=memory.available=0Mi,nodefs.available=500Mi,imagefs.available=2Gi --node-status-update-frequency=10s --eviction-pressure-transition-period=30s"</span></span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet \<span class="variable">$KUBELET_KUBECONFIG_ARGS</span> \<span class="variable">$KUBELET_SYSTEM_PODS_ARGS</span> \<span class="variable">$KUBELET_NETWORK_ARGS</span> \<span class="variable">$KUBELET_DNS_ARGS</span> \<span class="variable">$KUBELET_AUTHZ_ARGS</span> \<span class="variable">$KUBELET_CGROUP_ARGS</span> \<span class="variable">$KUBELET_CERTIFICATE_ARGS</span> \<span class="variable">$KUBELET_EXTRA_ARGS</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="æ­å»ºkeepalived-haproxy"><a href="#æ­å»ºkeepalived-haproxy" class="headerlink" title="æ­å»ºkeepalived + haproxy"></a>æ­å»ºkeepalived + haproxy</h2><h3 id="åœ¨master-1ä¸Šé…ç½®"><a href="#åœ¨master-1ä¸Šé…ç½®" class="headerlink" title="åœ¨master-1ä¸Šé…ç½®"></a>åœ¨master-1ä¸Šé…ç½®</h3><h4 id="keepalived-å®‰è£…é…ç½®"><a href="#keepalived-å®‰è£…é…ç½®" class="headerlink" title="keepalived å®‰è£…é…ç½®"></a>keepalived å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run --net=host --cap-add=NET_ADMIN \</span><br><span class="line"><span class="_">-e</span> KEEPALIVED_INTERFACE=eth0 \  <span class="comment">#ç½‘å¡åç§°</span></span><br><span class="line"><span class="_">-e</span> KEEPALIVED_VIRTUAL_IPS=<span class="string">"#PYTHON2BASH:['172.19.170.100']"</span> \  <span class="comment">#VIPåœ°å€</span></span><br><span class="line"><span class="_">-e</span> KEEPALIVED_UNICAST_PEERS=<span class="string">"#PYTHON2BASH:['172.19.170.183']"</span> \ <span class="comment">#master-1åœ°å€</span></span><br><span class="line"><span class="_">-e</span> KEEPALIVED_PASSWORD=k8s \</span><br><span class="line">--name k8s-keepalived \</span><br><span class="line">--restart always \</span><br><span class="line"><span class="_">-d</span> osixia/keepalived:2.0.12</span><br></pre></td></tr></table></figure>
<h4 id="haproxy-å®‰è£…é…ç½®"><a href="#haproxy-å®‰è£…é…ç½®" class="headerlink" title="haproxy å®‰è£…é…ç½®"></a>haproxy å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/haproxy</span><br><span class="line">cat &gt;/etc/haproxy/haproxy.cfg&lt;&lt;EOF</span><br><span class="line">global</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 <span class="built_in">local</span>0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  uid 99</span><br><span class="line">  gid 99</span><br><span class="line">  <span class="comment">#daemon</span></span><br><span class="line">  nbproc 1</span><br><span class="line">  pidfile haproxy.pid</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 <span class="built_in">local</span>0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  retries 3</span><br><span class="line">  timeout connect 5s</span><br><span class="line">  timeout client 30s</span><br><span class="line">  timeout server 30s</span><br><span class="line">  timeout check 2s</span><br><span class="line"></span><br><span class="line">listen admin_stats</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:1080</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 <span class="built_in">local</span>0 err</span><br><span class="line">  stats refresh 30s</span><br><span class="line">  stats uri     /haproxy-status</span><br><span class="line">  stats realm   Haproxy\ Statistics</span><br><span class="line">  stats auth    admin:k8s</span><br><span class="line">  stats hide-version</span><br><span class="line">  stats admin <span class="keyword">if</span> TRUE</span><br><span class="line"></span><br><span class="line">frontend k8s-https</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  <span class="comment">#maxconn 50000</span></span><br><span class="line">  default_backend k8s-https</span><br><span class="line"></span><br><span class="line">backend k8s-https</span><br><span class="line">  mode tcp</span><br><span class="line">  balance roundrobin</span><br><span class="line">  server master-1 172.19.170.183:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3</span><br><span class="line">  server master-2 172.19.170.184:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3</span><br><span class="line">  server master-3 172.19.170.185:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">docker run <span class="_">-d</span> --name k8s-haproxy \</span><br><span class="line">-v /etc/haproxy:/usr/<span class="built_in">local</span>/etc/haproxy:ro \</span><br><span class="line">-p 8443:8443 \</span><br><span class="line">-p 1080:1080 \</span><br><span class="line">--restart always \</span><br><span class="line">haproxy:1.7.8-alpine</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨master-2ä¸Šé…ç½®"><a href="#åœ¨master-2ä¸Šé…ç½®" class="headerlink" title="åœ¨master-2ä¸Šé…ç½®"></a>åœ¨master-2ä¸Šé…ç½®</h3><h4 id="keepalived-å®‰è£…é…ç½®-1"><a href="#keepalived-å®‰è£…é…ç½®-1" class="headerlink" title="keepalived å®‰è£…é…ç½®"></a>keepalived å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run --net=host --cap-add=NET_ADMIN \</span><br><span class="line"><span class="_">-e</span> KEEPALIVED_INTERFACE=eth0 \  <span class="comment">#ç½‘å¡åç§°</span></span><br><span class="line"><span class="_">-e</span> KEEPALIVED_VIRTUAL_IPS=<span class="string">"#PYTHON2BASH:['172.19.170.100']"</span> \  <span class="comment">#VIPåœ°å€</span></span><br><span class="line"><span class="_">-e</span> KEEPALIVED_UNICAST_PEERS=<span class="string">"#PYTHON2BASH:['172.19.170.184']"</span> \ <span class="comment">#master-2åœ°å€</span></span><br><span class="line"><span class="_">-e</span> KEEPALIVED_PASSWORD=k8s \</span><br><span class="line">--name k8s-keepalived \</span><br><span class="line">--restart always \</span><br><span class="line"><span class="_">-d</span> osixia/keepalived:2.0.12</span><br></pre></td></tr></table></figure>
<h4 id="haproxy-å®‰è£…é…ç½®-1"><a href="#haproxy-å®‰è£…é…ç½®-1" class="headerlink" title="haproxy å®‰è£…é…ç½®"></a>haproxy å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/haproxy</span><br><span class="line">cat &gt;/etc/haproxy/haproxy.cfg&lt;&lt;EOF</span><br><span class="line">global</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 <span class="built_in">local</span>0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  uid 99</span><br><span class="line">  gid 99</span><br><span class="line">  <span class="comment">#daemon</span></span><br><span class="line">  nbproc 1</span><br><span class="line">  pidfile haproxy.pid</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 <span class="built_in">local</span>0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  retries 3</span><br><span class="line">  timeout connect 5s</span><br><span class="line">  timeout client 30s</span><br><span class="line">  timeout server 30s</span><br><span class="line">  timeout check 2s</span><br><span class="line"></span><br><span class="line">listen admin_stats</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:1080</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 <span class="built_in">local</span>0 err</span><br><span class="line">  stats refresh 30s</span><br><span class="line">  stats uri     /haproxy-status</span><br><span class="line">  stats realm   Haproxy\ Statistics</span><br><span class="line">  stats auth    admin:k8s</span><br><span class="line">  stats hide-version</span><br><span class="line">  stats admin <span class="keyword">if</span> TRUE</span><br><span class="line"></span><br><span class="line">frontend k8s-https</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  <span class="comment">#maxconn 50000</span></span><br><span class="line">  default_backend k8s-https</span><br><span class="line"></span><br><span class="line">backend k8s-https</span><br><span class="line">  mode tcp</span><br><span class="line">  balance roundrobin</span><br><span class="line">  server master-1 172.19.170.183:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3</span><br><span class="line">  server master-2 172.19.170.184:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3</span><br><span class="line">  server master-3 172.19.170.185:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">docker run <span class="_">-d</span> --name k8s-haproxy \</span><br><span class="line">-v /etc/haproxy:/usr/<span class="built_in">local</span>/etc/haproxy:ro \</span><br><span class="line">-p 8443:8443 \</span><br><span class="line">-p 1080:1080 \</span><br><span class="line">--restart always \</span><br><span class="line">haproxy:1.7.8-alpine</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨master-3ä¸Šé…ç½®"><a href="#åœ¨master-3ä¸Šé…ç½®" class="headerlink" title="åœ¨master-3ä¸Šé…ç½®"></a>åœ¨master-3ä¸Šé…ç½®</h3><h4 id="keepalived-å®‰è£…é…ç½®-2"><a href="#keepalived-å®‰è£…é…ç½®-2" class="headerlink" title="keepalived å®‰è£…é…ç½®"></a>keepalived å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run --net=host --cap-add=NET_ADMIN \</span><br><span class="line"><span class="_">-e</span> KEEPALIVED_INTERFACE=eth0 \  <span class="comment">#ç½‘å¡åç§°</span></span><br><span class="line"><span class="_">-e</span> KEEPALIVED_VIRTUAL_IPS=<span class="string">"#PYTHON2BASH:['172.19.170.100']"</span> \  <span class="comment">#VIPåœ°å€</span></span><br><span class="line"><span class="_">-e</span> KEEPALIVED_UNICAST_PEERS=<span class="string">"#PYTHON2BASH:['172.19.170.185']"</span> \ <span class="comment">#master-3åœ°å€</span></span><br><span class="line"><span class="_">-e</span> KEEPALIVED_PASSWORD=k8s \</span><br><span class="line">--name k8s-keepalived \</span><br><span class="line">--restart always \</span><br><span class="line"><span class="_">-d</span> osixia/keepalived:2.0.12</span><br></pre></td></tr></table></figure>
<h4 id="haproxy-å®‰è£…é…ç½®-2"><a href="#haproxy-å®‰è£…é…ç½®-2" class="headerlink" title="haproxy å®‰è£…é…ç½®"></a>haproxy å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/haproxy</span><br><span class="line">cat &gt;/etc/haproxy/haproxy.cfg&lt;&lt;EOF</span><br><span class="line">global</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 <span class="built_in">local</span>0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  uid 99</span><br><span class="line">  gid 99</span><br><span class="line">  <span class="comment">#daemon</span></span><br><span class="line">  nbproc 1</span><br><span class="line">  pidfile haproxy.pid</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 <span class="built_in">local</span>0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  retries 3</span><br><span class="line">  timeout connect 5s</span><br><span class="line">  timeout client 30s</span><br><span class="line">  timeout server 30s</span><br><span class="line">  timeout check 2s</span><br><span class="line"></span><br><span class="line">listen admin_stats</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:1080</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 <span class="built_in">local</span>0 err</span><br><span class="line">  stats refresh 30s</span><br><span class="line">  stats uri     /haproxy-status</span><br><span class="line">  stats realm   Haproxy\ Statistics</span><br><span class="line">  stats auth    admin:k8s</span><br><span class="line">  stats hide-version</span><br><span class="line">  stats admin <span class="keyword">if</span> TRUE</span><br><span class="line"></span><br><span class="line">frontend k8s-https</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  <span class="comment">#maxconn 50000</span></span><br><span class="line">  default_backend k8s-https</span><br><span class="line"></span><br><span class="line">backend k8s-https</span><br><span class="line">  mode tcp</span><br><span class="line">  balance roundrobin</span><br><span class="line">  server master-1 172.19.170.183:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3</span><br><span class="line">  server master-2 172.19.170.184:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3</span><br><span class="line">  server master-3 172.19.170.185:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">docker run <span class="_">-d</span> --name k8s-haproxy \</span><br><span class="line">-v /etc/haproxy:/usr/<span class="built_in">local</span>/etc/haproxy:ro \</span><br><span class="line">-p 8443:8443 \</span><br><span class="line">-p 1080:1080 \</span><br><span class="line">--restart always \</span><br><span class="line">haproxy:1.7.8-alpine</span><br></pre></td></tr></table></figure>
<h2 id="æ­å»ºkubernetes-master-é›†ç¾¤"><a href="#æ­å»ºkubernetes-master-é›†ç¾¤" class="headerlink" title="æ­å»ºkubernetes master é›†ç¾¤"></a>æ­å»ºkubernetes master é›†ç¾¤</h2><h3 id="é…ç½®é˜¿é‡Œäº‘-SLB"><a href="#é…ç½®é˜¿é‡Œäº‘-SLB" class="headerlink" title="é…ç½®é˜¿é‡Œäº‘ SLB"></a>é…ç½®é˜¿é‡Œäº‘ SLB</h3><blockquote>
<p>åœ¨é˜¿é‡Œäº‘SLB ç®¡ç†ç•Œé¢æ·»åŠ 8443ç›‘å¬ç«¯å£ï¼Œä½¿ç”¨<code>TCP</code>åè®®ï¼Œåç«¯æœåŠ¡å™¨é€‰æ‹©ä¸€å°ä½ å³å°†åˆå§‹åŒ–çš„masteræœºå™¨ï¼Œåç«¯æœåŠ¡å™¨ç«¯å£ä¸º6443ï¼Œå¥åº·æ£€æŸ¥é»˜è®¤é…ç½®å³å¯ï¼Œä¿å­˜é…ç½®ã€‚æ­¤æ—¶ä½ çš„SLBæ˜¯ä¸è¿›è¡Œå·¥ä½œçš„ï¼Œå› ä¸ºåç«¯æœåŠ¡å™¨çš„6443ç«¯å£è¿˜æœªç›‘å¬ã€‚</p>
</blockquote>
<h3 id="åˆå§‹åŒ–master-1"><a href="#åˆå§‹åŒ–master-1" class="headerlink" title="åˆå§‹åŒ–master-1"></a>åˆå§‹åŒ–master-1</h3><blockquote>
<p> <code>åœ¨master-1 ä¸Šæ‰§è¡Œ</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; $HOME/kubeadm<span class="bullet">-1.</span>yaml</span><br><span class="line"><span class="attr">apiVersion:</span> kubeadm.k8s.io/v1beta1</span><br><span class="line"><span class="attr">kind:</span> ClusterConfiguration</span><br><span class="line"><span class="attr">kubernetesVersion:</span> v1<span class="number">.13</span><span class="number">.3</span></span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="number">172.19</span><span class="number">.170</span><span class="number">.100</span>:<span class="number">8443</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line"><span class="attr">  certSANs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">172.19</span><span class="number">.170</span><span class="number">.183</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">172.19</span><span class="number">.170</span><span class="number">.184</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">172.19</span><span class="number">.170</span><span class="number">.185</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">172.19</span><span class="number">.170</span><span class="number">.100</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="comment"># This CIDR is a Calico default. Substitute or remove for your CNI provider.</span></span><br><span class="line"><span class="attr">  podSubnet:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span></span><br><span class="line"><span class="attr">imageRepository:</span> registry.cn-hangzhou.aliyuncs.com/google_containers  <span class="comment"># imageçš„ä»“åº“æº</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line"><span class="attr">kind:</span> KubeProxyConfiguration</span><br><span class="line"><span class="attr">mode:</span> iptables</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubeadm config images pull --config $HOME/kubeadm<span class="bullet">-1.</span>yaml</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:<span class="number">3.1</span>  k8s.gcr.io/pause:<span class="number">3.1</span></span><br><span class="line">kubeadm init --config $HOME/kubeadm<span class="bullet">-1.</span>yaml</span><br><span class="line"></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">cp -f /etc/kubernetes/admin.conf $&#123;HOME&#125;/.kube/config</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…calico-ç½‘ç»œæ’ä»¶"><a href="#å®‰è£…calico-ç½‘ç»œæ’ä»¶" class="headerlink" title="å®‰è£…calico ç½‘ç»œæ’ä»¶"></a>å®‰è£…calico ç½‘ç»œæ’ä»¶</h3><blockquote>
<p> <code>åœ¨master-1 ä¸Šæ‰§è¡Œ</code></p>
</blockquote>
<p>ç¡®ä¿ <code>Kubernetes controller manager (/etc/kubernetes/manifests/kube-controller-manager.yaml)</code> è®¾ç½®äº†ä»¥ä¸‹æ ‡å¿—ï¼š<code>--cluster-cidr=192.168.0.0/16å’Œ--allocate-node-cidrs=true</code>ã€‚</p>
<p>æç¤ºï¼šåœ¨kubeadmä¸Šï¼Œæ‚¨å¯ä»¥ä¼ é€’<code>--pod-network-cidr=192.168.0.0/16</code> ç»™kubeadmä»¥è®¾ç½®ä¸¤ä¸ªKubernetesæ§åˆ¶å™¨æ ‡å¿—ã€‚</p>
<p>åœ¨ConfigMapå‘½åä¸­<code>calico-config</code>ï¼Œæ‰¾åˆ°<code>typha_service_name</code>ï¼Œåˆ é™¤<code>none</code>å€¼ï¼Œå¹¶æ›¿æ¢ä¸º<code>calico-typha</code></p>
<p>æˆ‘ä»¬å»ºè®®æ¯<code>200</code>ä¸ªèŠ‚ç‚¹è‡³å°‘<code>å¤åˆ¶ä¸€ä¸ªå‰¯æœ¬</code>ï¼Œä¸è¶…è¿‡20ä¸ªå‰¯æœ¬ã€‚åœ¨ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬å»ºè®®è‡³å°‘ä½¿ç”¨<code>ä¸‰ä¸ªå‰¯æœ¬</code>æ¥å‡å°‘æ»šåŠ¨å‡çº§å’Œæ•…éšœçš„å½±å“ã€‚</p>
<p><strong><code>è­¦å‘Šï¼šå¦‚æœæ‚¨è®¾ç½®typha_service_nameè€Œä¸å¢åŠ å…¶é»˜è®¤å€¼ä¸º0 Felixçš„å‰¯æœ¬è®¡æ•°å°†å°è¯•è¿æ¥åˆ°Typhaï¼Œæ‰¾ä¸åˆ°è¦è¿æ¥çš„Typhaå®ä¾‹ï¼Œå¹¶ä¸”æ— æ³•å¯åŠ¨ã€‚</code></strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="_">-f</span> www.jiunile.com/k8s/plugin/1.12.3/calico.yaml</span><br></pre></td></tr></table></figure></p>
<h3 id="åˆå§‹åŒ–å…¶å®ƒmasterèŠ‚ç‚¹"><a href="#åˆå§‹åŒ–å…¶å®ƒmasterèŠ‚ç‚¹" class="headerlink" title="åˆå§‹åŒ–å…¶å®ƒmasterèŠ‚ç‚¹"></a>åˆå§‹åŒ–å…¶å®ƒmasterèŠ‚ç‚¹</h3><blockquote>
<p> <code>åœ¨master-1 ä¸Šæ‰§è¡Œ</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åˆå§‹åŒ–master-2</span></span><br><span class="line">ssh master-2 <span class="string">"kubeadm reset -f </span><br><span class="line">rm -rf /etc/kubernetes/pki/</span><br><span class="line">mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube/</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆå§‹åŒ–master-3</span></span><br><span class="line">ssh master-3 <span class="string">"kubeadm reset -f </span><br><span class="line">rm -rf /etc/kubernetes/pki/ </span><br><span class="line">mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube/</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‹·è´æ–‡ä»¶åˆ°master-2</span></span><br><span class="line">scp /etc/kubernetes/pki/ca.crt master-2:/etc/kubernetes/pki/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/ca.key master-2:/etc/kubernetes/pki/ca.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.key master-2:/etc/kubernetes/pki/sa.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.pub master-2:/etc/kubernetes/pki/sa.pub</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.crt master-2:/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.key master-2:/etc/kubernetes/pki/front-proxy-ca.key</span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.crt master-2:/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.key master-2:/etc/kubernetes/pki/etcd/ca.key</span><br><span class="line">scp /etc/kubernetes/admin.conf master-2:/etc/kubernetes/admin.conf</span><br><span class="line">scp /etc/kubernetes/admin.conf master-2:~/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‹·è´æ–‡ä»¶åˆ°master-3</span></span><br><span class="line">scp /etc/kubernetes/pki/ca.crt master-3:/etc/kubernetes/pki/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/ca.key master-3:/etc/kubernetes/pki/ca.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.key master-3:/etc/kubernetes/pki/sa.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.pub master-3:/etc/kubernetes/pki/sa.pub</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.crt master-3:/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.key master-3:/etc/kubernetes/pki/front-proxy-ca.key</span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.crt master-3:/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.key master-3:/etc/kubernetes/pki/etcd/ca.key</span><br><span class="line">scp /etc/kubernetes/admin.conf master-3:/etc/kubernetes/admin.conf</span><br><span class="line">scp /etc/kubernetes/admin.conf master-3:~/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment">#è·å–åŠ å…¥å£ä»¤</span></span><br><span class="line">JOIN_CMD=`kubeadm token create --print-join-command`</span><br><span class="line"></span><br><span class="line"><span class="comment">#å°†master-2 åŠ å…¥</span></span><br><span class="line">ssh master-2 <span class="string">"<span class="variable">$&#123;JOIN_CMD&#125;</span> --experimental-control-plane"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å°†master-3 åŠ å…¥</span></span><br><span class="line">ssh master-3 <span class="string">"<span class="variable">$&#123;JOIN_CMD&#125;</span> --experimental-control-plane"</span></span><br></pre></td></tr></table></figure>
<h3 id="å†æ¬¡é…ç½®é˜¿é‡Œäº‘-SLB"><a href="#å†æ¬¡é…ç½®é˜¿é‡Œäº‘-SLB" class="headerlink" title="å†æ¬¡é…ç½®é˜¿é‡Œäº‘ SLB"></a>å†æ¬¡é…ç½®é˜¿é‡Œäº‘ SLB</h3><blockquote>
<p>åŒæ ·è¿›å…¥é˜¿é‡Œäº‘SLBç®¡ç†ç•Œé¢ï¼Œå°†å…¶ä½™çš„ä¸¤å°masteræœºå™¨åŠ å…¥åˆ°åç«¯æœåŠ¡å™¨ä¸­ã€‚è¿™æ ·ä½ çš„apiserver å°±é«˜å¯ç”¨äº†</p>
</blockquote>
<h2 id="å¼€å¯kubernetes-æ’ä»¶"><a href="#å¼€å¯kubernetes-æ’ä»¶" class="headerlink" title="å¼€å¯kubernetes æ’ä»¶"></a>å¼€å¯kubernetes æ’ä»¶</h2><blockquote>
<p>åœ¨éšæ„ä¸€å°masteræ‰§è¡Œ</p>
</blockquote>
<h3 id="å®‰è£…heapster-ç›‘æ§æ’ä»¶"><a href="#å®‰è£…heapster-ç›‘æ§æ’ä»¶" class="headerlink" title="å®‰è£…heapster ç›‘æ§æ’ä»¶"></a>å®‰è£…heapster ç›‘æ§æ’ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="_">-f</span> www.jiunile.com/k8s/plugin/1.12.3/heapster.yaml</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…dashboard-æ’ä»¶"><a href="#å®‰è£…dashboard-æ’ä»¶" class="headerlink" title="å®‰è£…dashboard æ’ä»¶"></a>å®‰è£…dashboard æ’ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="_">-f</span> www.jiunile.com/k8s/plugin/1.12.3/dashboard.yaml</span><br></pre></td></tr></table></figure>
<h3 id="è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤"><a href="#è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤" class="headerlink" title="è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤"></a>è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>
<h2 id="åˆå§‹åŒ–æ‰€æœ‰kubernetes-node"><a href="#åˆå§‹åŒ–æ‰€æœ‰kubernetes-node" class="headerlink" title="åˆå§‹åŒ–æ‰€æœ‰kubernetes node"></a>åˆå§‹åŒ–æ‰€æœ‰kubernetes node</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–calicoç½‘ç»œå¯¹åº”éœ€è¦çš„é•œåƒï¼Œæ‹‰å–æ¯”æ•™ç¼“æ…¢</span></span><br><span class="line">docker pull quay.io/calico/typha:v3.3.2</span><br><span class="line">docker pull quay.io/calico/node:v3.3.2</span><br><span class="line">docker pull quay.io/calico/cni:v3.3.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ å…¥é›†ç¾¤</span></span><br><span class="line">kubeadm join 172.19.170.100:8443 --token mrvxeb.mfr1wx6upq5bbwqt --discovery-token-ca-cert-hash sha256:8ee893d8bf69f1f622f55a983f1401a9f2a236ffa9248894cb614c972de47f48</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¯ä»¥åœ¨masteræœºå™¨ä¸ŠæŸ¥çœ‹å¯¹åº”çš„nodeçŠ¶æ€</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">kubectl get pod -n kube-system</span><br></pre></td></tr></table></figure>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><h3 id="æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸"><a href="#æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸" class="headerlink" title="æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸"></a>æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸</h3><blockquote>
<p>åœ¨éšæ„ä¸€å°masteræœºå™¨ä¸Šè¿è¡Œ</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éƒ¨ç½²ä¸€ä¸ªæœåŠ¡</span></span><br><span class="line"><span class="built_in">cd</span> /root &amp;&amp; mkdir nginx &amp;&amp; <span class="built_in">cd</span> nginx</span><br><span class="line">cat &lt;&lt; EOF &gt; nginx.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    nodePort: 31000</span><br><span class="line">    name: nginx-port</span><br><span class="line">    targetPort: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply <span class="_">-f</span> nginx.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªPODæ¥æµ‹è¯•DNSè§£æ</span></span><br><span class="line">kubectl run curl --image=radial/busyboxplus:curl -i --tty</span><br><span class="line">nslookup kubernetes</span><br><span class="line"><span class="comment"># Server:    10.96.0.10</span></span><br><span class="line"><span class="comment"># Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Name:      kubernetes</span></span><br><span class="line"><span class="comment"># Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span></span><br><span class="line">curl nginx</span><br><span class="line"><span class="comment"># æœ‰è¿”å›ç»“æœè¡¨æ˜ok</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">kubectl delete deployment curl</span><br></pre></td></tr></table></figure>
<h3 id="æµ‹è¯•master-amp-Haproxyé«˜å¯ç”¨"><a href="#æµ‹è¯•master-amp-Haproxyé«˜å¯ç”¨" class="headerlink" title="æµ‹è¯•master &amp; Haproxyé«˜å¯ç”¨"></a>æµ‹è¯•master &amp; Haproxyé«˜å¯ç”¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#éšæœºå…³æ‰ä¸€å°masteræœºå™¨</span></span><br><span class="line">init 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨åˆ«çš„masteræœºå™¨ä¸Šæ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">kubectl get node</span><br><span class="line"><span class="comment">#NAME      STATUS     ROLES     AGE       VERSION</span></span><br><span class="line"><span class="comment">#master-1   NotReady   master    1h        v1.13.3</span></span><br><span class="line"><span class="comment">#master-2   Ready      master    59m       v1.13.3</span></span><br><span class="line"><span class="comment">#master-3   Ready      master    59m       v1.13.3</span></span><br><span class="line"><span class="comment">#node-1     Ready      &lt;none&gt;    58m       v1.13.3</span></span><br><span class="line"><span class="comment">#node-2     Ready      &lt;none&gt;    58m       v1.13.3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡æ–°åˆ›å»ºä¸€ä¸ªpodï¼Œçœ‹çœ‹æ˜¯å¦èƒ½åˆ›å»ºæˆåŠŸ</span></span><br><span class="line">kubectl run curl --image=radial/busyboxplus:curl -i --tty</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">kubectl delete deployment curl</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Kubernetes è°ƒåº¦å™¨ä»‹ç»]]></title>
      <url>http://team.jiunile.com/blog/2019/02/k8s-scheduler.html</url>
      <content type="html"><![CDATA[<h3 id="kube-scheduler-ç®€ä»‹"><a href="#kube-scheduler-ç®€ä»‹" class="headerlink" title="kube-scheduler ç®€ä»‹"></a>kube-scheduler ç®€ä»‹</h3><blockquote>
<p><code>kube-scheduler</code>æ˜¯ kubernetes ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œä¸»è¦è´Ÿè´£æ•´ä¸ªé›†ç¾¤èµ„æºçš„è°ƒåº¦åŠŸèƒ½ï¼Œæ ¹æ®ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œç­–ç•¥ï¼Œå°† Pod è°ƒåº¦åˆ°æœ€ä¼˜çš„å·¥ä½œèŠ‚ç‚¹ä¸Šé¢å»ï¼Œä»è€Œæ›´åŠ åˆç†ã€æ›´åŠ å……åˆ†çš„åˆ©ç”¨é›†ç¾¤çš„èµ„æºï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ kubernetes ä¸€ä¸ªéå¸¸é‡è¦çš„ç†ç”±ã€‚å¦‚æœä¸€é—¨æ–°çš„æŠ€æœ¯ä¸èƒ½å¸®åŠ©ä¼ä¸šèŠ‚çº¦æˆæœ¬ã€æä¾›æ•ˆç‡ï¼Œæˆ‘ç›¸ä¿¡æ˜¯å¾ˆéš¾æ¨è¿›çš„ã€‚</p>
</blockquote>
<h3 id="è°ƒåº¦æµç¨‹"><a href="#è°ƒåº¦æµç¨‹" class="headerlink" title="è°ƒåº¦æµç¨‹"></a>è°ƒåº¦æµç¨‹</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œkube-scheduler æä¾›çš„é»˜è®¤è°ƒåº¦å™¨èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬ç»å¤§å¤šæ•°çš„è¦æ±‚ï¼Œæˆ‘ä»¬å‰é¢å’Œå¤§å®¶æ¥è§¦çš„ç¤ºä¾‹ä¹ŸåŸºæœ¬ä¸Šç”¨çš„é»˜è®¤çš„ç­–ç•¥ï¼Œéƒ½å¯ä»¥ä¿è¯æˆ‘ä»¬çš„ Pod å¯ä»¥è¢«åˆ†é…åˆ°èµ„æºå……è¶³çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ä½†æ˜¯åœ¨å®é™…çš„çº¿ä¸Šé¡¹ç›®ä¸­ï¼Œå¯èƒ½æˆ‘ä»¬è‡ªå·±ä¼šæ¯” kubernetes æ›´åŠ äº†è§£æˆ‘ä»¬è‡ªå·±çš„åº”ç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸Œæœ›ä¸€ä¸ª Pod åªèƒ½è¿è¡Œåœ¨ç‰¹å®šçš„å‡ ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…è¿™å‡ ä¸ªèŠ‚ç‚¹åªèƒ½ç”¨æ¥è¿è¡Œç‰¹å®šç±»å‹çš„åº”ç”¨ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬çš„è°ƒåº¦å™¨èƒ½å¤Ÿå¯æ§ã€‚</p>
<p><code>kube-scheduler</code> æ˜¯ kubernetes çš„è°ƒåº¦å™¨ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨å°±æ˜¯æ ¹æ®ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œè°ƒåº¦ç­–ç•¥å°† Pod è°ƒåº¦åˆ°åˆé€‚çš„ Node èŠ‚ç‚¹ä¸Šå»ï¼Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äºŒè¿›åˆ¶ç¨‹åºï¼Œå¯åŠ¨ä¹‹åä¼šä¸€ç›´ç›‘å¬ API Serverï¼Œè·å–åˆ° PodSpec.NodeName ä¸ºç©ºçš„ Podï¼Œå¯¹æ¯ä¸ª Pod éƒ½ä¼šåˆ›å»ºä¸€ä¸ª bindingã€‚<br><img src="/images/k8s/kube-scheduler-structrue.jpg" alt="K8s scheduler structure"><br><a id="more"></a><br>è¿™ä¸ªè¿‡ç¨‹åœ¨æˆ‘ä»¬çœ‹æ¥å¥½åƒæ¯”è¾ƒç®€å•ï¼Œä½†åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéœ€è¦è€ƒè™‘çš„é—®é¢˜å°±æœ‰å¾ˆå¤šäº†ï¼š</p>
<ul>
<li>å¦‚ä½•ä¿è¯å…¨éƒ¨çš„èŠ‚ç‚¹è°ƒåº¦çš„å…¬å¹³æ€§ï¼Ÿè¦çŸ¥é“å¹¶ä¸æ˜¯è¯´æœ‰èŠ‚ç‚¹èµ„æºé…ç½®éƒ½æ˜¯ä¸€æ ·çš„</li>
<li>å¦‚ä½•ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½è¢«åˆ†é…èµ„æºï¼Ÿ</li>
<li>é›†ç¾¤èµ„æºå¦‚ä½•èƒ½å¤Ÿè¢«é«˜æ•ˆåˆ©ç”¨ï¼Ÿ</li>
<li>é›†ç¾¤èµ„æºå¦‚ä½•æ‰èƒ½è¢«æœ€å¤§åŒ–ä½¿ç”¨ï¼Ÿ</li>
<li>å¦‚ä½•ä¿è¯ Pod è°ƒåº¦çš„æ€§èƒ½å’Œæ•ˆç‡ï¼Ÿ</li>
<li>ç”¨æˆ·æ˜¯å¦å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚å®šåˆ¶è‡ªå·±çš„è°ƒåº¦ç­–ç•¥ï¼Ÿ</li>
</ul>
<p>è€ƒè™‘åˆ°å®é™…ç¯å¢ƒä¸­çš„å„ç§å¤æ‚æƒ…å†µï¼Œkubernetes çš„è°ƒåº¦å™¨é‡‡ç”¨æ’ä»¶åŒ–çš„å½¢å¼å®ç°ï¼Œå¯ä»¥æ–¹ä¾¿ç”¨æˆ·è¿›è¡Œå®šåˆ¶æˆ–è€…äºŒæ¬¡å¼€å‘ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªè°ƒåº¦å™¨å¹¶ä»¥æ’ä»¶å½¢å¼å’Œ kubernetes è¿›è¡Œé›†æˆã€‚</p>
<p>kubernetes è°ƒåº¦å™¨çš„æºç ä½äº kubernetes/pkg/scheduler ä¸­ï¼Œå¤§ä½“çš„ä»£ç ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š(ä¸åŒçš„ç‰ˆæœ¬ç›®å½•ç»“æ„å¯èƒ½ä¸å¤ªä¸€æ ·)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubernetes/pkg/scheduler</span><br><span class="line">-- scheduler.go         <span class="comment">#è°ƒåº¦ç›¸å…³çš„å…·ä½“å®ç°</span></span><br><span class="line">|-- algorithm</span><br><span class="line">|   |-- predicates      <span class="comment">#èŠ‚ç‚¹ç­›é€‰ç­–ç•¥</span></span><br><span class="line">|   |-- priorities      <span class="comment">#èŠ‚ç‚¹æ‰“åˆ†ç­–ç•¥</span></span><br><span class="line">|-- algorithmprovider</span><br><span class="line">|   |-- defaults        <span class="comment">#å®šä¹‰é»˜è®¤çš„è°ƒåº¦å™¨</span></span><br></pre></td></tr></table></figure></p>
<p>å…¶ä¸­ Scheduler åˆ›å»ºå’Œè¿è¡Œçš„æ ¸å¿ƒç¨‹åºï¼Œå¯¹åº”çš„ä»£ç åœ¨ pkg/scheduler/scheduler.goï¼Œå¦‚æœè¦æŸ¥çœ‹<code>kube-scheduler</code>çš„å…¥å£ç¨‹åºï¼Œå¯¹åº”çš„ä»£ç åœ¨ cmd/kube-scheduler/scheduler.goã€‚</p>
<p>è°ƒåº¦ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>é¦–å…ˆæ˜¯é¢„é€‰è¿‡ç¨‹ï¼Œè¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º<code>Predicates</code></li>
<li>ç„¶åæ˜¯ä¼˜é€‰è¿‡ç¨‹ï¼Œå¯¹é€šè¿‡çš„èŠ‚ç‚¹æŒ‰ç…§ä¼˜å…ˆçº§æ’åºï¼Œç§°ä¹‹ä¸º<code>Priorities</code></li>
<li>æœ€åä»ä¸­é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„èŠ‚ç‚¹ï¼Œå¦‚æœä¸­é—´ä»»ä½•ä¸€æ­¥éª¤æœ‰é”™è¯¯ï¼Œå°±ç›´æ¥è¿”å›é”™è¯¯</li>
</ul>
<p><code>Predicates</code>é˜¶æ®µé¦–å…ˆéå†å…¨éƒ¨èŠ‚ç‚¹ï¼Œè¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå±äºå¼ºåˆ¶æ€§è§„åˆ™ï¼Œè¿™ä¸€é˜¶æ®µè¾“å‡ºçš„æ‰€æœ‰æ»¡è¶³è¦æ±‚çš„ Node å°†è¢«è®°å½•å¹¶ä½œä¸ºç¬¬äºŒé˜¶æ®µçš„è¾“å…¥ï¼Œå¦‚æœæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½ä¸æ»¡è¶³æ¡ä»¶ï¼Œé‚£ä¹ˆ Pod å°†ä¼šä¸€ç›´å¤„äº Pending çŠ¶æ€ï¼Œç›´åˆ°æœ‰èŠ‚ç‚¹æ»¡è¶³æ¡ä»¶ï¼Œåœ¨è¿™æœŸé—´è°ƒåº¦å™¨ä¼šä¸æ–­çš„é‡è¯•ã€‚</p>
<blockquote>
<p>æ‰€ä»¥æˆ‘ä»¬åœ¨éƒ¨ç½²åº”ç”¨çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°æœ‰ Pod ä¸€ç›´å¤„äº Pending çŠ¶æ€ï¼Œé‚£ä¹ˆå°±æ˜¯æ²¡æœ‰æ»¡è¶³è°ƒåº¦æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å»æ£€æŸ¥ä¸‹èŠ‚ç‚¹èµ„æºæ˜¯å¦å¯ç”¨ã€‚</p>
</blockquote>
<p><code>Priorities</code>é˜¶æ®µå³å†æ¬¡å¯¹èŠ‚ç‚¹è¿›è¡Œç­›é€‰ï¼Œå¦‚æœæœ‰å¤šä¸ªèŠ‚ç‚¹éƒ½æ»¡è¶³æ¡ä»¶çš„è¯ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šæŒ‰ç…§èŠ‚ç‚¹çš„ä¼˜å…ˆçº§(priorites)å¤§å°å¯¹èŠ‚ç‚¹è¿›è¡Œæ’åºï¼Œæœ€åé€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„èŠ‚ç‚¹æ¥éƒ¨ç½² Pod åº”ç”¨ã€‚</p>
<p>ä¸‹é¢æ˜¯è°ƒåº¦è¿‡ç¨‹çš„ç®€å•ç¤ºæ„å›¾ï¼š<br><img src="/images/k8s/kube-scheduler-filter.jpg" alt="K8s scheduler filter"></p>
<p>æ›´è¯¦ç»†çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>é¦–å…ˆï¼Œå®¢æˆ·ç«¯é€šè¿‡ API Server çš„ REST API æˆ–è€… kubectl å·¥å…·åˆ›å»º Pod èµ„æº</li>
<li>API Server æ”¶åˆ°ç”¨æˆ·è¯·æ±‚åï¼Œå­˜å‚¨ç›¸å…³æ•°æ®åˆ° etcd æ•°æ®åº“ä¸­</li>
<li>è°ƒåº¦å™¨ç›‘å¬ API Server æŸ¥çœ‹ä¸ºè°ƒåº¦(bind)çš„ Pod åˆ—è¡¨ï¼Œå¾ªç¯éå†åœ°ä¸ºæ¯ä¸ª Pod å°è¯•åˆ†é…èŠ‚ç‚¹ï¼Œè¿™ä¸ªåˆ†é…è¿‡ç¨‹å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªé˜¶æ®µï¼š<ul>
<li>é¢„é€‰é˜¶æ®µ(Predicates)ï¼Œè¿‡æ»¤èŠ‚ç‚¹ï¼Œè°ƒåº¦å™¨ç”¨ä¸€ç»„è§„åˆ™è¿‡æ»¤æ‰ä¸ç¬¦åˆè¦æ±‚çš„ Node èŠ‚ç‚¹ï¼Œæ¯”å¦‚ Pod è®¾ç½®äº†èµ„æºçš„ requestï¼Œé‚£ä¹ˆå¯ç”¨èµ„æºæ¯” Pod éœ€è¦çš„èµ„æºå°‘çš„ä¸»æœºæ˜¾ç„¶å°±ä¼šè¢«è¿‡æ»¤æ‰</li>
<li>ä¼˜é€‰é˜¶æ®µ(Priorities)ï¼Œä¸ºèŠ‚ç‚¹çš„ä¼˜å…ˆçº§æ‰“åˆ†ï¼Œå°†ä¸Šä¸€é˜¶æ®µè¿‡æ»¤å‡ºæ¥çš„ Node åˆ—è¡¨è¿›è¡Œæ‰“åˆ†ï¼Œè°ƒåº¦å™¨ä¼šè€ƒè™‘ä¸€äº›æ•´ä½“çš„ä¼˜åŒ–ç­–ç•¥ï¼Œæ¯”å¦‚æŠŠ Deployment æ§åˆ¶çš„å¤šä¸ª Pod å‰¯æœ¬åˆ†å¸ƒåˆ°ä¸åŒçš„ä¸»æœºä¸Šï¼Œä½¿ç”¨æœ€ä½è´Ÿè½½çš„ä¸»æœºç­‰ç­‰ç­–ç•¥</li>
</ul>
</li>
<li>ç»è¿‡ä¸Šé¢çš„é˜¶æ®µè¿‡æ»¤åé€‰æ‹©æ‰“åˆ†æœ€é«˜çš„ Node èŠ‚ç‚¹å’Œ Pod è¿›è¡Œ binding æ“ä½œï¼Œç„¶åå°†ç»“æœå­˜å‚¨åˆ° etcd ä¸­</li>
<li>æœ€åè¢«é€‰æ‹©å‡ºæ¥çš„ Node èŠ‚ç‚¹å¯¹åº”çš„ kubelet å»æ‰§è¡Œåˆ›å»º Pod çš„ç›¸å…³æ“ä½œ</li>
</ul>
<p>å…¶ä¸­<code>Predicates</code>è¿‡æ»¤æœ‰ä¸€ç³»åˆ—çš„ç®—æ³•å¯ä»¥ä½¿ç”¨ï¼Œæˆ‘ä»¬è¿™é‡Œç®€å•åˆ—ä¸¾å‡ ä¸ªï¼š</p>
<ul>
<li>PodFitsResourcesï¼šèŠ‚ç‚¹ä¸Šå‰©ä½™çš„èµ„æºæ˜¯å¦å¤§äº Pod è¯·æ±‚çš„èµ„æº</li>
<li>PodFitsHostï¼šå¦‚æœ Pod æŒ‡å®šäº† NodeNameï¼Œæ£€æŸ¥èŠ‚ç‚¹åç§°æ˜¯å¦å’Œ NodeName åŒ¹é…</li>
<li>PodFitsHostPortsï¼šèŠ‚ç‚¹ä¸Šå·²ç»ä½¿ç”¨çš„ port æ˜¯å¦å’Œ Pod ç”³è¯·çš„ port å†²çª</li>
<li>PodSelectorMatchesï¼šè¿‡æ»¤æ‰å’Œ Pod æŒ‡å®šçš„ label ä¸åŒ¹é…çš„èŠ‚ç‚¹</li>
<li>NoDiskConflictï¼šå·²ç» mount çš„ volume å’Œ Pod æŒ‡å®šçš„ volume ä¸å†²çªï¼Œé™¤éå®ƒä»¬éƒ½æ˜¯åªè¯»çš„</li>
<li>CheckNodeDiskPressureï¼šæ£€æŸ¥èŠ‚ç‚¹ç£ç›˜ç©ºé—´æ˜¯å¦ç¬¦åˆè¦æ±‚</li>
<li>CheckNodeMemoryPressureï¼šæ£€æŸ¥èŠ‚ç‚¹å†…å­˜æ˜¯å¦å¤Ÿç”¨</li>
</ul>
<p>é™¤äº†è¿™äº›è¿‡æ»¤ç®—æ³•ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„ç®—æ³•ï¼Œæ›´å¤šæ›´è¯¦ç»†çš„æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹æºç æ–‡ä»¶ï¼šk8s.io/kubernetes/pkg/scheduler/algorithm/predicates/predicates.goã€‚</p>
<p>è€Œ<code>Priorities</code>ä¼˜å…ˆçº§æ˜¯ç”±ä¸€ç³»åˆ—é”®å€¼å¯¹ç»„æˆçš„ï¼Œé”®æ˜¯è¯¥ä¼˜å…ˆçº§çš„åç§°ï¼Œå€¼æ˜¯å®ƒçš„æƒé‡å€¼ï¼ŒåŒæ ·ï¼Œæˆ‘ä»¬è¿™é‡Œç»™å¤§å®¶åˆ—ä¸¾å‡ ä¸ªå…·æœ‰ä»£è¡¨æ€§çš„é€‰é¡¹ï¼š</p>
<ul>
<li>LeastRequestedPriorityï¼šé€šè¿‡è®¡ç®— CPU å’Œå†…å­˜çš„ä½¿ç”¨ç‡æ¥å†³å®šæƒé‡ï¼Œä½¿ç”¨ç‡è¶Šä½æƒé‡è¶Šé«˜ï¼Œå½“ç„¶æ­£å¸¸è‚¯å®šä¹Ÿæ˜¯èµ„æºæ˜¯ä½¿ç”¨ç‡è¶Šä½æƒé‡è¶Šé«˜ï¼Œèƒ½ç»™åˆ«çš„ Pod è¿è¡Œçš„å¯èƒ½æ€§å°±è¶Šå¤§</li>
<li>SelectorSpreadPriorityï¼šä¸ºäº†æ›´å¥½çš„é«˜å¯ç”¨ï¼Œå¯¹åŒå±äºä¸€ä¸ª Deployment æˆ–è€… RC ä¸‹é¢çš„å¤šä¸ª Pod å‰¯æœ¬ï¼Œå°½é‡è°ƒåº¦åˆ°å¤šä¸ªä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œå½“ä¸€ä¸ª Pod è¢«è°ƒåº¦çš„æ—¶å€™ï¼Œä¼šå…ˆå»æŸ¥æ‰¾è¯¥ Pod å¯¹åº”çš„ controllerï¼Œç„¶åæŸ¥çœ‹è¯¥ controller ä¸‹é¢çš„å·²å­˜åœ¨çš„ Podï¼Œè¿è¡Œ Pod è¶Šå°‘çš„èŠ‚ç‚¹æƒé‡è¶Šé«˜</li>
<li>ImageLocalityPriorityï¼šå°±æ˜¯å¦‚æœåœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šå·²ç»æœ‰è¦ä½¿ç”¨çš„é•œåƒèŠ‚ç‚¹äº†ï¼Œé•œåƒæ€»å¤§å°å€¼è¶Šå¤§ï¼Œæƒé‡å°±è¶Šé«˜</li>
<li>NodeAffinityPriorityï¼šè¿™ä¸ªå°±æ˜¯æ ¹æ®èŠ‚ç‚¹çš„äº²å’Œæ€§æ¥è®¡ç®—ä¸€ä¸ªæƒé‡å€¼ï¼Œåé¢æˆ‘ä»¬ä¼šè¯¦ç»†è®²è§£äº²å’Œæ€§çš„ä½¿ç”¨æ–¹æ³•</li>
</ul>
<p>é™¤äº†è¿™äº›ç­–ç•¥ä¹‹å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ç­–ç•¥ï¼ŒåŒæ ·æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹æºç æ–‡ä»¶ï¼šk8s.io/kubernetes/pkg/scheduler/algorithm/priorities/ äº†è§£æ›´å¤šä¿¡æ¯ã€‚æ¯ä¸€ä¸ªä¼˜å…ˆçº§å‡½æ•°ä¼šè¿”å›ä¸€ä¸ª0-10çš„åˆ†æ•°ï¼Œåˆ†æ•°è¶Šé«˜è¡¨ç¤ºèŠ‚ç‚¹è¶Šä¼˜ï¼ŒåŒæ—¶æ¯ä¸€ä¸ªå‡½æ•°ä¹Ÿä¼šå¯¹åº”ä¸€ä¸ªè¡¨ç¤ºæƒé‡çš„å€¼ã€‚æœ€ç»ˆä¸»æœºçš„å¾—åˆ†ç”¨ä»¥ä¸‹å…¬å¼è®¡ç®—å¾—å‡ºï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">finalScoreNode = (weight1 * priorityFunc1) + (weight2 * priorityFunc2) + â€¦ + (weightn * priorityFuncn)</span><br></pre></td></tr></table></figure></p>
<h3 id="è‡ªå®šä¹‰è°ƒåº¦"><a href="#è‡ªå®šä¹‰è°ƒåº¦" class="headerlink" title="è‡ªå®šä¹‰è°ƒåº¦"></a>è‡ªå®šä¹‰è°ƒåº¦</h3><p>ä¸Šé¢å°±æ˜¯ kube-scheduler é»˜è®¤è°ƒåº¦çš„åŸºæœ¬æµç¨‹ï¼Œé™¤äº†ä½¿ç”¨é»˜è®¤çš„è°ƒåº¦å™¨ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰è°ƒåº¦ç­–ç•¥ã€‚</p>
<h4 id="è°ƒåº¦å™¨æ‰©å±•"><a href="#è°ƒåº¦å™¨æ‰©å±•" class="headerlink" title="è°ƒåº¦å™¨æ‰©å±•"></a>è°ƒåº¦å™¨æ‰©å±•</h4><p><code>kube-scheduler</code>åœ¨å¯åŠ¨çš„æ—¶å€™å¯ä»¥é€šè¿‡ <code>--policy-config-file</code>å‚æ•°æ¥æŒ‡å®šè°ƒåº¦ç­–ç•¥æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æˆ‘ä»¬è‡ªå·±çš„éœ€è¦æ¥ç»„è£…<code>Predicates</code>å’Œ<code>Priority</code>å‡½æ•°ã€‚é€‰æ‹©ä¸åŒçš„è¿‡æ»¤å‡½æ•°å’Œä¼˜å…ˆçº§å‡½æ•°ã€æ§åˆ¶ä¼˜å…ˆçº§å‡½æ•°çš„æƒé‡ã€è°ƒæ•´è¿‡æ»¤å‡½æ•°çš„é¡ºåºéƒ½ä¼šå½±å“è°ƒåº¦è¿‡ç¨‹ã€‚</p>
<p>ä¸‹é¢æ˜¯å®˜æ–¹çš„ Policy æ–‡ä»¶ç¤ºä¾‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"kind"</span> : <span class="string">"Policy"</span>,</span><br><span class="line">    <span class="string">"apiVersion"</span> : <span class="string">"v1"</span>,</span><br><span class="line">    <span class="string">"predicates"</span> : [</span><br><span class="line">        &#123;<span class="string">"name"</span> : <span class="string">"PodFitsHostPorts"</span>&#125;,</span><br><span class="line">        &#123;<span class="string">"name"</span> : <span class="string">"PodFitsResources"</span>&#125;,</span><br><span class="line">        &#123;<span class="string">"name"</span> : <span class="string">"NoDiskConflict"</span>&#125;,</span><br><span class="line">        &#123;<span class="string">"name"</span> : <span class="string">"NoVolumeZoneConflict"</span>&#125;,</span><br><span class="line">        &#123;<span class="string">"name"</span> : <span class="string">"MatchNodeSelector"</span>&#125;,</span><br><span class="line">        &#123;<span class="string">"name"</span> : <span class="string">"HostName"</span>&#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"priorities"</span> : [</span><br><span class="line">        &#123;<span class="string">"name"</span> : <span class="string">"LeastRequestedPriority"</span>, <span class="string">"weight"</span> : 1&#125;,</span><br><span class="line">        &#123;<span class="string">"name"</span> : <span class="string">"BalancedResourceAllocation"</span>, <span class="string">"weight"</span> : 1&#125;,</span><br><span class="line">        &#123;<span class="string">"name"</span> : <span class="string">"ServiceSpreadingPriority"</span>, <span class="string">"weight"</span> : 1&#125;,</span><br><span class="line">        &#123;<span class="string">"name"</span> : <span class="string">"EqualPriority"</span>, <span class="string">"weight"</span> : 1&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="å¤šè°ƒåº¦å™¨"><a href="#å¤šè°ƒåº¦å™¨" class="headerlink" title="å¤šè°ƒåº¦å™¨"></a>å¤šè°ƒåº¦å™¨</h4><p>å¦‚æœé»˜è®¤çš„è°ƒåº¦å™¨ä¸æ»¡è¶³è¦æ±‚ï¼Œè¿˜å¯ä»¥éƒ¨ç½²è‡ªå®šä¹‰çš„è°ƒåº¦å™¨ã€‚å¹¶ä¸”ï¼Œåœ¨æ•´ä¸ªé›†ç¾¤ä¸­è¿˜å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªè°ƒåº¦å™¨å®ä¾‹ï¼Œé€šè¿‡<code>podSpec.schedulerName</code> æ¥é€‰æ‹©ä½¿ç”¨å“ªä¸€ä¸ªè°ƒåº¦å™¨ï¼ˆé»˜è®¤ä½¿ç”¨å†…ç½®çš„è°ƒåº¦å™¨ï¼‰ã€‚<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Pod</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> nginx</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> nginx</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  schedulerName:</span> my-scheduler  <span class="comment"># é€‰æ‹©ä½¿ç”¨è‡ªå®šä¹‰è°ƒåº¦å™¨ my-scheduler</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> nginx</span><br><span class="line"><span class="attr">    image:</span> nginx:<span class="number">1.10</span></span><br></pre></td></tr></table></figure></p>
<p>è¦å¼€å‘æˆ‘ä»¬è‡ªå·±çš„è°ƒåº¦å™¨ä¹Ÿæ˜¯æ¯”è¾ƒå®¹æ˜“çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„ my-scheduler:</p>
<ul>
<li>é¦–å…ˆéœ€è¦é€šè¿‡æŒ‡å®šçš„ API è·å–èŠ‚ç‚¹å’Œ Pod</li>
<li>ç„¶åé€‰æ‹©<code>phase=Pending</code>å’Œ<code>schedulerName=my-scheduler</code>çš„pod</li>
<li>è®¡ç®—æ¯ä¸ª Pod éœ€è¦æ”¾ç½®çš„ä½ç½®ä¹‹åï¼Œè°ƒåº¦ç¨‹åºå°†åˆ›å»ºä¸€ä¸ª<code>Binding</code>å¯¹è±¡</li>
<li>ç„¶åæ ¹æ®æˆ‘ä»¬è‡ªå®šä¹‰çš„è°ƒåº¦å™¨çš„ç®—æ³•è®¡ç®—å‡ºæœ€é€‚åˆçš„ç›®æ ‡èŠ‚ç‚¹</li>
</ul>
<h4 id="ä¼˜å…ˆçº§è°ƒåº¦"><a href="#ä¼˜å…ˆçº§è°ƒåº¦" class="headerlink" title="ä¼˜å…ˆçº§è°ƒåº¦"></a>ä¼˜å…ˆçº§è°ƒåº¦</h4><p>ä¸å‰é¢æ‰€è®²çš„è°ƒåº¦ä¼˜é€‰ç­–ç•¥ä¸­çš„ä¼˜å…ˆçº§ï¼ˆPrioritiesï¼‰ä¸åŒï¼Œå‰é¢æ‰€è®²çš„ä¼˜å…ˆçº§æŒ‡çš„æ˜¯èŠ‚ç‚¹ä¼˜å…ˆçº§ï¼Œè€Œæˆ‘ä»¬è¿™é‡Œæ‰€è¯´çš„ä¼˜å…ˆçº§ pod priority æŒ‡çš„æ˜¯ Pod çš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜å…ˆçº§çš„ Pod ä¼šä¼˜å…ˆè¢«è°ƒåº¦ï¼Œæˆ–è€…åœ¨èµ„æºä¸è¶³ä½æƒ…å†µç‰ºç‰²ä½ä¼˜å…ˆçº§çš„ Podï¼Œä»¥ä¾¿äºé‡è¦çš„ Pod èƒ½å¤Ÿå¾—åˆ°èµ„æºéƒ¨ç½²ã€‚</p>
<p>è¦å®šä¹‰ Pod ä¼˜å…ˆçº§ï¼Œå°±éœ€è¦å…ˆå®šä¹‰<code>PriorityClass</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ²¡æœ‰ Namespace çš„é™åˆ¶ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> PriorityClass</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> high-priority</span><br><span class="line"><span class="attr">value:</span> <span class="number">1000000</span></span><br><span class="line"><span class="attr">globalDefault:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">"This priority class should be used for XYZ service pods only."</span></span><br></pre></td></tr></table></figure></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><code>value</code>ä¸º 32 ä½æ•´æ•°çš„ä¼˜å…ˆçº§ï¼Œè¯¥å€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜</li>
<li><code>globalDefault</code>ç”¨äºæœªé…ç½® PriorityClassName çš„ Podï¼Œæ•´ä¸ªé›†ç¾¤ä¸­åº”è¯¥åªæœ‰ä¸€ä¸ª<code>PriorityClass</code>å°†å…¶è®¾ç½®ä¸º true</li>
</ul>
<p>ç„¶åé€šè¿‡åœ¨ Pod çš„<code>spec.priorityClassName</code>ä¸­æŒ‡å®šå·²å®šä¹‰çš„<code>PriorityClass</code>åç§°å³å¯ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Pod</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> nginx</span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> nginx</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> nginx</span><br><span class="line"><span class="attr">    image:</span> nginx</span><br><span class="line"><span class="attr">    imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="attr">  priorityClassName:</span> high-priority</span><br></pre></td></tr></table></figure></p>
<p>å¦å¤–ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„æ˜¯å½“èŠ‚ç‚¹æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºä¾›è°ƒåº¦å™¨è°ƒåº¦ Podï¼Œå¯¼è‡´ Pod å¤„äº pending æ—¶ï¼ŒæŠ¢å ï¼ˆpreemptionï¼‰é€»è¾‘å°±ä¼šè¢«è§¦å‘ã€‚<code>Preemption</code>ä¼šå°è¯•ä»ä¸€ä¸ªèŠ‚ç‚¹åˆ é™¤ä½ä¼˜å…ˆçº§çš„ Podï¼Œä»è€Œé‡Šæ”¾èµ„æºä½¿é«˜ä¼˜å…ˆçº§çš„ Pod å¾—åˆ°èŠ‚ç‚¹èµ„æºè¿›è¡Œéƒ¨ç½²ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„å›¾å†å»å›é¡¾ä¸‹ kubernetes çš„è°ƒåº¦è¿‡ç¨‹æ˜¯ä¸æ˜¯å°±æ¸…æ™°å¾ˆå¤šäº†ï¼š<br><img src="/images/k8s/kube-scheduler-detail.png" alt="K8s scheduler detail"></p>
<p>æ¥æº: k8sæŠ€æœ¯åœˆ</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ä½¿ç”¨Kubeadm 1.11.x + etcdé›†ç¾¤ éƒ¨ç½²å¤šMasteré›†ç¾¤]]></title>
      <url>http://team.jiunile.com/blog/2018/12/k8s-kubeadm-etcd-ha-1-11-x.html</url>
      <content type="html"><![CDATA[<h2 id="ç¯å¢ƒä»‹ç»"><a href="#ç¯å¢ƒä»‹ç»" class="headerlink" title="ç¯å¢ƒä»‹ç»"></a>ç¯å¢ƒä»‹ç»</h2><table>
<thead>
<tr>
<th style="text-align:left">IP</th>
<th style="text-align:left">Hostname</th>
<th style="text-align:left">å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">172.19.170.183</td>
<td style="text-align:left">master-1</td>
<td style="text-align:left">ç§æœ‰äº‘å®‰è£…keepalived + haproxy + etcd</td>
</tr>
<tr>
<td style="text-align:left">172.19.170.184</td>
<td style="text-align:left">master-2</td>
<td style="text-align:left">ç§æœ‰äº‘å®‰è£…keepalived + haproxy + etcd</td>
</tr>
<tr>
<td style="text-align:left">172.19.170.185</td>
<td style="text-align:left">master-3</td>
<td style="text-align:left">ç§æœ‰äº‘å®‰è£…keepalived + haproxy + etcd</td>
</tr>
<tr>
<td style="text-align:left">172.19.170.186</td>
<td style="text-align:left">node-1</td>
<td style="text-align:left">æ— </td>
</tr>
<tr>
<td style="text-align:left">172.19.170.187</td>
<td style="text-align:left">node-2</td>
<td style="text-align:left">æ— </td>
</tr>
<tr>
<td style="text-align:left">172.19.170.100</td>
<td style="text-align:left">vip</td>
<td style="text-align:left">ç§æœ‰äº‘ä½¿ç”¨keepalive+haproxyæ­å»ºï¼Œå…¬æœ‰äº‘ä½¿ç”¨å†…éƒ¨è´Ÿè½½å‡è¡¡å™¨</td>
</tr>
</tbody>
</table>
<h2 id="ç¯å¢ƒåˆå§‹åŒ–"><a href="#ç¯å¢ƒåˆå§‹åŒ–" class="headerlink" title="ç¯å¢ƒåˆå§‹åŒ–"></a>ç¯å¢ƒåˆå§‹åŒ–</h2><h3 id="ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ"><a href="#ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ" class="headerlink" title="ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ"></a>ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;&gt; /etc/hosts</span><br><span class="line">172.19.170.183 master-1</span><br><span class="line">172.19.170.184 master-2</span><br><span class="line">172.19.170.185 master-3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨master-1-æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"><a href="#åœ¨master-1-æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š" class="headerlink" title="åœ¨master-1 æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"></a>åœ¨master-1 æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id root@master-2</span><br><span class="line">ssh-copy-id root@master-3</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="ä¼˜åŒ–æ‰€æœ‰master-amp-node-èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ"><a href="#ä¼˜åŒ–æ‰€æœ‰master-amp-node-èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ" class="headerlink" title="ä¼˜åŒ–æ‰€æœ‰master &amp; node èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ"></a>ä¼˜åŒ–æ‰€æœ‰master &amp; node èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ</h3><blockquote>
<p><code>åœ¨æ‰€æœ‰master &amp; node æœºå™¨ä¸Šéƒ½è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment"># å®‰è£…4.18ç‰ˆæœ¬å†…æ ¸</span></span><br><span class="line"><span class="comment"># ç”±äºæœ€æ–°ç¨³å®šç‰ˆ4.19å†…æ ¸å°†nf_conntrack_ipv4æ›´åä¸ºnf_conntrackï¼Œç›®å‰çš„kube-proxyä¸æ”¯æŒåœ¨4.19ç‰ˆæœ¬å†…æ ¸ä¸‹å¼€å¯ipvs</span></span><br><span class="line"><span class="comment"># è¯¦æƒ…å¯ä»¥æŸ¥çœ‹ï¼šhttps://github.com/kubernetes/kubernetes/issues/70304</span></span><br><span class="line"><span class="comment"># å¯¹äºè¯¥é—®é¢˜çš„ä¿®å¤10æœˆ30æ—¥åˆšåˆšåˆå¹¶åˆ°ä»£ç ä¸»å¹²ï¼Œæ‰€ä»¥ç›®å‰è¿˜æ²¡æœ‰åŒ…å«æ­¤ä¿®å¤çš„kubernetesç‰ˆæœ¬å‘å‡º</span></span><br><span class="line"><span class="comment"># å¯ä»¥é€‰æ‹©å®‰è£…4.18ç‰ˆæœ¬å†…æ ¸ï¼Œæˆ–è€…ä¸å¼€å¯IPVS</span></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment">############################# start #############################</span></span><br><span class="line"><span class="comment"># å‡çº§å†…æ ¸</span></span><br><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm ;yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml -y</span><br><span class="line"> </span><br><span class="line"><span class="comment"># æ£€æŸ¥é»˜è®¤å†…æ ¸ç‰ˆæœ¬æ˜¯å¦å¤§äº4.14ï¼Œå¦åˆ™è¯·è°ƒæ•´é»˜è®¤å¯åŠ¨å‚æ•°</span></span><br><span class="line">grub2-editenv list</span><br><span class="line"> </span><br><span class="line"><span class="comment">#é‡å¯ä»¥æ›´æ¢å†…æ ¸</span></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯ip_vs</span></span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">ipvs_modules_dir=<span class="string">"/usr/lib/modules/\`uname -r\`/kernel/net/netfilter/ipvs"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> \`ls \<span class="variable">$ipvs_modules_dir</span> | sed  -r <span class="string">'s#(.*).ko.*#\1#'</span>\`; <span class="keyword">do</span></span><br><span class="line">    /sbin/modinfo -F filename \<span class="variable">$i</span>  &amp;&gt; /dev/null</span><br><span class="line">    <span class="keyword">if</span> [ \$? <span class="_">-eq</span> 0 ]; <span class="keyword">then</span></span><br><span class="line">        /sbin/modprobe \<span class="variable">$i</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ£€æŸ¥æ˜¯å¦å¼€å¯äº†ip_vs</span></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vs</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# end #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼˜åŒ–å†…æ ¸</span></span><br><span class="line">cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.inotify.max_user_instances = 8192</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">vm.swappiness = 0</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡ŒsysctlæŠ¥é”™è¯·å‚è€ƒcentos7æ·»åŠ bridge-nf-call-ip6tableså‡ºç°No such file or directory: https://blog.csdn.net/airuozhaoyang/article/details/40534953</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼˜åŒ–æ–‡ä»¶æ‰“å¼€æ•°</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* soft nofile 65536"</span> &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* hard nofile 65536"</span> &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* soft nproc 65536"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* hard nproc 65536"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* soft  memlock  unlimited"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* hard memlock  unlimited"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­Selinux/firewalld</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­äº¤æ¢åˆ†åŒº</span></span><br><span class="line">swapoff <span class="_">-a</span></span><br><span class="line">yes | cp /etc/fstab /etc/fstab_bak</span><br><span class="line">cat /etc/fstab_bak |grep -v swap &gt; /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒæ­¥æ—¶é—´</span></span><br><span class="line">yum install -y ntpdate</span><br><span class="line">ntpdate -u ntp.api.bz</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®kubernet yumæº</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…kubernet</span></span><br><span class="line">yum install kubeadm-1.11.5-0 kubelet-1.11.5-0 kubectl-1.11.5-0 --disableexcludes=kubernetes -y</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®dockeræº</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/docker.repo &lt;&lt;EOF</span><br><span class="line">[docker]</span><br><span class="line">name=Docker Repository</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/repo/centos7</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…docker-engine</span></span><br><span class="line">yum -y install docker-engine-1.13.1 --disableexcludes=docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®kubeletå¯åŠ¨é…ç½®</span></span><br><span class="line">cgroupDriver=$(docker info|grep Cg)</span><br><span class="line">driver=<span class="variable">$&#123;cgroupDriver##*: &#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"driver is <span class="variable">$&#123;driver&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_NETWORK_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_DNS_ARGS=--cluster-dns=10.96.0.10 --cluster-domain=cluster.local"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_AUTHZ_ARGS=--authorization-mode=Webhook --client-ca-file=/etc/kubernetes/pki/ca.crt"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CADVISOR_ARGS=--cadvisor-port=0"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CGROUP_ARGS=--cgroup-driver=<span class="variable">$&#123;driver&#125;</span>"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CERTIFICATE_ARGS=--rotate-certificates=true --cert-dir=/var/lib/kubelet/pki"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_EXTRA_ARGS=--system-reserved=cpu=200m,memory=250Mi --kube-reserved=cpu=200m,memory=250Mi --eviction-soft=memory.available&lt;500Mi,nodefs.available&lt;2Gi --eviction-soft-grace-period=memory.available=1m30s,nodefs.available=1m30s --eviction-max-pod-grace-period=120 --eviction-hard=memory.available&lt;500Mi,nodefs.available&lt;1Gi --eviction-minimum-reclaim=memory.available=0Mi,nodefs.available=500Mi,imagefs.available=2Gi --node-status-update-frequency=10s --eviction-pressure-transition-period=30s"</span></span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet \<span class="variable">$KUBELET_KUBECONFIG_ARGS</span> \<span class="variable">$KUBELET_SYSTEM_PODS_ARGS</span> \<span class="variable">$KUBELET_NETWORK_ARGS</span> \<span class="variable">$KUBELET_DNS_ARGS</span> \<span class="variable">$KUBELET_AUTHZ_ARGS</span> \<span class="variable">$KUBELET_CADVISOR_ARGS</span> \<span class="variable">$KUBELET_CGROUP_ARGS</span> \<span class="variable">$KUBELET_CERTIFICATE_ARGS</span> \<span class="variable">$KUBELET_EXTRA_ARGS</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="æ­å»ºkeepalived-haproxy-å…¬æœ‰äº‘ä¸éœ€è¦æ­å»º"><a href="#æ­å»ºkeepalived-haproxy-å…¬æœ‰äº‘ä¸éœ€è¦æ­å»º" class="headerlink" title="æ­å»ºkeepalived + haproxy (å…¬æœ‰äº‘ä¸éœ€è¦æ­å»º)"></a>æ­å»ºkeepalived + haproxy (å…¬æœ‰äº‘ä¸éœ€è¦æ­å»º)</h2><h3 id="åœ¨master-1ä¸Šé…ç½®"><a href="#åœ¨master-1ä¸Šé…ç½®" class="headerlink" title="åœ¨master-1ä¸Šé…ç½®"></a>åœ¨master-1ä¸Šé…ç½®</h3><h4 id="keepalived-å®‰è£…é…ç½®"><a href="#keepalived-å®‰è£…é…ç½®" class="headerlink" title="keepalived å®‰è£…é…ç½®"></a>keepalived å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">    global_defs &#123;</span><br><span class="line">        notification_email &#123;</span><br><span class="line">            root@localhost      <span class="comment">#å‘é€é‚®ç®±</span></span><br><span class="line">        &#125;</span><br><span class="line">        notification_email_from keepalived@localhost    <span class="comment">#é‚®ç®±åœ°å€   </span></span><br><span class="line">        smtp_server 127.0.0.1   <span class="comment">#é‚®ä»¶æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">        smtp_connect_timeout 30 </span><br><span class="line">        router_id node1         <span class="comment">#ä¸»æœºåï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸åŒå³å¯</span></span><br><span class="line">    &#125;       </span><br><span class="line">        </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER        <span class="comment">#åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šä¸ºBACKUP</span></span><br><span class="line">    interface eth0      <span class="comment">#IPåœ°å€æ¼‚ç§»åˆ°çš„ç½‘å¡</span></span><br><span class="line">    virtual_router_id 6 <span class="comment">#å¤šä¸ªèŠ‚ç‚¹å¿…é¡»ç›¸åŒ</span></span><br><span class="line">    priority 100        <span class="comment">#ä¼˜å…ˆçº§ï¼Œå¤‡ç”¨èŠ‚ç‚¹çš„å€¼å¿…é¡»ä½äºä¸»èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">    advert_int 1        <span class="comment">#é€šå‘Šé—´éš”1ç§’</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_<span class="built_in">type</span> PASS      <span class="comment">#é¢„å…±äº«å¯†é’¥è®¤è¯</span></span><br><span class="line">        auth_pass 571f97b2  <span class="comment">#å¯†é’¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.19.170.100    <span class="comment">#VIPåœ°å€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived</span><br><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure>
<h4 id="haproxy-å®‰è£…é…ç½®"><a href="#haproxy-å®‰è£…é…ç½®" class="headerlink" title="haproxy å®‰è£…é…ç½®"></a>haproxy å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">yum install  -y haproxy</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 <span class="built_in">local</span>2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    <span class="built_in">log</span>                     global</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line"></span><br><span class="line">frontend kubernetes</span><br><span class="line">    <span class="built_in">bind</span> *:8443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend kubernetes-master</span><br><span class="line"></span><br><span class="line">backend kubernetes-master</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server master-1 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-2 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-3 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br><span class="line">systemctl start haproxy</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨master-2ä¸Šé…ç½®"><a href="#åœ¨master-2ä¸Šé…ç½®" class="headerlink" title="åœ¨master-2ä¸Šé…ç½®"></a>åœ¨master-2ä¸Šé…ç½®</h3><h4 id="keepalived-å®‰è£…é…ç½®-1"><a href="#keepalived-å®‰è£…é…ç½®-1" class="headerlink" title="keepalived å®‰è£…é…ç½®"></a>keepalived å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">    global_defs &#123;</span><br><span class="line">        notification_email &#123;</span><br><span class="line">            root@localhost      <span class="comment">#å‘é€é‚®ç®±</span></span><br><span class="line">        &#125;</span><br><span class="line">        notification_email_from keepalived@localhost    <span class="comment">#é‚®ç®±åœ°å€   </span></span><br><span class="line">        smtp_server 127.0.0.1   <span class="comment">#é‚®ä»¶æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">        smtp_connect_timeout 30 </span><br><span class="line">        router_id node2         <span class="comment">#ä¸»æœºåï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸åŒå³å¯</span></span><br><span class="line">    &#125;       </span><br><span class="line">        </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP        <span class="comment">#åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šä¸ºBACKUP</span></span><br><span class="line">    interface eth0      <span class="comment">#IPåœ°å€æ¼‚ç§»åˆ°çš„ç½‘å¡</span></span><br><span class="line">    virtual_router_id 6 <span class="comment">#å¤šä¸ªèŠ‚ç‚¹å¿…é¡»ç›¸åŒ</span></span><br><span class="line">    priority 80        <span class="comment">#ä¼˜å…ˆçº§ï¼Œå¤‡ç”¨èŠ‚ç‚¹çš„å€¼å¿…é¡»ä½äºä¸»èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">    advert_int 1        <span class="comment">#é€šå‘Šé—´éš”1ç§’</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_<span class="built_in">type</span> PASS      <span class="comment">#é¢„å…±äº«å¯†é’¥è®¤è¯</span></span><br><span class="line">        auth_pass 571f97b2  <span class="comment">#å¯†é’¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.19.170.100    <span class="comment">#VIPåœ°å€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived</span><br><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure>
<h4 id="haproxy-å®‰è£…é…ç½®-1"><a href="#haproxy-å®‰è£…é…ç½®-1" class="headerlink" title="haproxy å®‰è£…é…ç½®"></a>haproxy å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">yum install  -y haproxy</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 <span class="built_in">local</span>2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    <span class="built_in">log</span>                     global</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line"></span><br><span class="line">frontend kubernetes</span><br><span class="line">    <span class="built_in">bind</span> *:8443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend kubernetes-master</span><br><span class="line"></span><br><span class="line">backend kubernetes-master</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server master-1 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-2 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-3 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br><span class="line">systemctl start haproxy</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨master-3ä¸Šé…ç½®"><a href="#åœ¨master-3ä¸Šé…ç½®" class="headerlink" title="åœ¨master-3ä¸Šé…ç½®"></a>åœ¨master-3ä¸Šé…ç½®</h3><h4 id="keepalived-å®‰è£…é…ç½®-2"><a href="#keepalived-å®‰è£…é…ç½®-2" class="headerlink" title="keepalived å®‰è£…é…ç½®"></a>keepalived å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">    global_defs &#123;</span><br><span class="line">        notification_email &#123;</span><br><span class="line">            root@localhost      <span class="comment">#å‘é€é‚®ç®±</span></span><br><span class="line">        &#125;</span><br><span class="line">        notification_email_from keepalived@localhost    <span class="comment">#é‚®ç®±åœ°å€   </span></span><br><span class="line">        smtp_server 127.0.0.1   <span class="comment">#é‚®ä»¶æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">        smtp_connect_timeout 30 </span><br><span class="line">        router_id node3         <span class="comment">#ä¸»æœºåï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸åŒå³å¯</span></span><br><span class="line">    &#125;       </span><br><span class="line">        </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP        <span class="comment">#åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šä¸ºBACKUP</span></span><br><span class="line">    interface eth0      <span class="comment">#IPåœ°å€æ¼‚ç§»åˆ°çš„ç½‘å¡</span></span><br><span class="line">    virtual_router_id 6 <span class="comment">#å¤šä¸ªèŠ‚ç‚¹å¿…é¡»ç›¸åŒ</span></span><br><span class="line">    priority 80        <span class="comment">#ä¼˜å…ˆçº§ï¼Œå¤‡ç”¨èŠ‚ç‚¹çš„å€¼å¿…é¡»ä½äºä¸»èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">    advert_int 1        <span class="comment">#é€šå‘Šé—´éš”1ç§’</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_<span class="built_in">type</span> PASS      <span class="comment">#é¢„å…±äº«å¯†é’¥è®¤è¯</span></span><br><span class="line">        auth_pass 571f97b2  <span class="comment">#å¯†é’¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.19.170.100    <span class="comment">#VIPåœ°å€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived</span><br><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure>
<h4 id="haproxy-å®‰è£…é…ç½®-2"><a href="#haproxy-å®‰è£…é…ç½®-2" class="headerlink" title="haproxy å®‰è£…é…ç½®"></a>haproxy å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">yum install  -y haproxy</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 <span class="built_in">local</span>2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    <span class="built_in">log</span>                     global</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line"></span><br><span class="line">frontend kubernetes</span><br><span class="line">    <span class="built_in">bind</span> *:8443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend kubernetes-master</span><br><span class="line"></span><br><span class="line">backend kubernetes-master</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server master-1 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-2 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-3 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br><span class="line">systemctl start haproxy</span><br></pre></td></tr></table></figure>
<h2 id="æ­å»ºetcd"><a href="#æ­å»ºetcd" class="headerlink" title="æ­å»ºetcd"></a>æ­å»ºetcd</h2><h3 id="åœ¨master-1ä¸Šæ‰§è¡Œ"><a href="#åœ¨master-1ä¸Šæ‰§è¡Œ" class="headerlink" title="åœ¨master-1ä¸Šæ‰§è¡Œ"></a>åœ¨master-1ä¸Šæ‰§è¡Œ</h3><h4 id="å®‰è£…cfssl"><a href="#å®‰è£…cfssl" class="headerlink" title="å®‰è£…cfssl"></a>å®‰è£…cfssl</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget -O /bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">wget -O /bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">wget -O /bin/cfssl-certinfo  https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line"><span class="keyword">for</span> cfssl <span class="keyword">in</span> `ls /bin/cfssl*`;<span class="keyword">do</span> chmod +x <span class="variable">$cfssl</span>;<span class="keyword">done</span>;</span><br></pre></td></tr></table></figure>
<h4 id="é…ç½®ç”Ÿæˆetcd-è¯ä¹¦"><a href="#é…ç½®ç”Ÿæˆetcd-è¯ä¹¦" class="headerlink" title="é…ç½®ç”Ÿæˆetcd è¯ä¹¦"></a>é…ç½®ç”Ÿæˆetcd è¯ä¹¦</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é…ç½®è¯ä¹¦</span></span><br><span class="line">mkdir -pv <span class="variable">$HOME</span>/ssl &amp;&amp; <span class="built_in">cd</span> <span class="variable">$HOME</span>/ssl</span><br><span class="line"></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span> //10å¹´</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; etcd-ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"JiangSu"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"SuZhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Etcd Security"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; etcd-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"172.19.170.183"</span>,</span><br><span class="line">      <span class="string">"172.19.170.184"</span>,</span><br><span class="line">      <span class="string">"172.19.170.185"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"JiangSu"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"SuZhou"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"Etcd Security"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆè¯ä¹¦å¹¶å¤åˆ¶è¯ä¹¦è‡³å…¶ä»–etcdèŠ‚ç‚¹</span></span><br><span class="line">cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare etcd-ca</span><br><span class="line">cfssl gencert -ca=etcd-ca.pem -ca-key=etcd-ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç§»åŠ¨è¯ä¹¦</span></span><br><span class="line">mkdir -pv /etc/etcd/ssl</span><br><span class="line">cp etcd*.pem /etc/etcd/ssl</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†è¯ä¹¦æ‹·è´åˆ°å…¶å®ƒèŠ‚ç‚¹</span></span><br><span class="line">scp -r /etc/etcd master-2:/etc/</span><br><span class="line">scp -r /etc/etcd master-3:/etc/</span><br></pre></td></tr></table></figure>
<h4 id="å®‰è£…é…ç½®etcd"><a href="#å®‰è£…é…ç½®etcd" class="headerlink" title="å®‰è£…é…ç½®etcd"></a>å®‰è£…é…ç½®etcd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">yum install -y etcd </span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/etcd/etcd.conf</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/default.etcd"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.19.170.183:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://127.0.0.1:2379,https://172.19.170.183:2379"</span></span><br><span class="line">ETCD_NAME=<span class="string">"etcd1"</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.19.170.183:2380"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://127.0.0.1:2379,https://172.19.170.183:2379"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.19.170.183:2380,etcd2=https://172.19.170.184:2380,etcd3=https://172.19.170.185:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"BigBoss"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span> <span class="comment">#è¿™é‡Œè¦è®¾ç½®ä¸ºnew</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chown -R etcd.etcd /etc/etcd</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br><span class="line"><span class="comment">#å¯åŠ¨ä¼šå¡ä½ï¼Œç­‰å¾…å…¶å®ƒèŠ‚ç‚¹çš„åŠ å…¥</span></span><br><span class="line">systemctl start etcd</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨master-2-ä¸Šæ‰§è¡Œ"><a href="#åœ¨master-2-ä¸Šæ‰§è¡Œ" class="headerlink" title="åœ¨master-2 ä¸Šæ‰§è¡Œ"></a>åœ¨master-2 ä¸Šæ‰§è¡Œ</h3><h4 id="å®‰è£…é…ç½®etcd-1"><a href="#å®‰è£…é…ç½®etcd-1" class="headerlink" title="å®‰è£…é…ç½®etcd"></a>å®‰è£…é…ç½®etcd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">yum install -y etcd </span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/etcd/etcd.conf</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/default.etcd"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.19.170.184:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://127.0.0.1:2379,https://172.19.170.184:2379"</span></span><br><span class="line">ETCD_NAME=<span class="string">"etcd2"</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.19.170.184:2380"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://127.0.0.1:2379,https://172.19.170.184:2379"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.19.170.183:2380,etcd2=https://172.19.170.184:2380,etcd3=https://172.19.170.185:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"BigBoss"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"existing"</span> <span class="comment">#å¦‚æœetcd å¯åŠ¨æŠ¥é”™ï¼Œå¯å…ˆæŠŠè¿™è¡Œæ³¨é‡Šæ‰ï¼Œç„¶ååœ¨å¯åŠ¨</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chown -R etcd.etcd /etc/etcd</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br><span class="line">systemctl start etcd</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨master-3-ä¸Šæ‰§è¡Œ"><a href="#åœ¨master-3-ä¸Šæ‰§è¡Œ" class="headerlink" title="åœ¨master-3 ä¸Šæ‰§è¡Œ"></a>åœ¨master-3 ä¸Šæ‰§è¡Œ</h3><h4 id="å®‰è£…é…ç½®etcd-2"><a href="#å®‰è£…é…ç½®etcd-2" class="headerlink" title="å®‰è£…é…ç½®etcd"></a>å®‰è£…é…ç½®etcd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; /etc/etcd/etcd.conf</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/default.etcd"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.19.170.185:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://127.0.0.1:2379,https://172.19.170.185:2379"</span></span><br><span class="line">ETCD_NAME=<span class="string">"etcd3"</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.19.170.185:2380"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://127.0.0.1:2379,https://172.19.170.185:2379"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.19.170.183:2380,etcd2=https://172.19.170.184:2380,etcd3=https://172.19.170.185:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"BigBoss"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"existing"</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chown -R etcd.etcd /etc/etcd</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br><span class="line">systemctl start etcd</span><br></pre></td></tr></table></figure>
<h3 id="etcd-é›†ç¾¤éªŒè¯"><a href="#etcd-é›†ç¾¤éªŒè¯" class="headerlink" title="etcd é›†ç¾¤éªŒè¯"></a>etcd é›†ç¾¤éªŒè¯</h3><blockquote>
<p>éšæ„åœ¨ä»»ä½•ä¸€å°etcd (master) èŠ‚ç‚¹ä¸Šè¿›è¡ŒéªŒè¯</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints <span class="string">"https://172.19.170.183:2379,https://172.19.170.184:2379,https://172.19.170.185:2379"</span>   --ca-file=/etc/etcd/ssl/etcd-ca.pem  \</span><br><span class="line">--cert-file=/etc/etcd/ssl/etcd.pem   --key-file=/etc/etcd/ssl/etcd-key.pem   cluster-health</span><br></pre></td></tr></table></figure>
<h2 id="æ­å»ºkubernetes-master-é›†ç¾¤"><a href="#æ­å»ºkubernetes-master-é›†ç¾¤" class="headerlink" title="æ­å»ºkubernetes master é›†ç¾¤"></a>æ­å»ºkubernetes master é›†ç¾¤</h2><h3 id="åˆå§‹åŒ–master-1"><a href="#åˆå§‹åŒ–master-1" class="headerlink" title="åˆå§‹åŒ–master-1"></a>åˆå§‹åŒ–master-1</h3><blockquote>
<p> <code>åœ¨master-1 ä¸Šæ‰§è¡Œ</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">token=$(kubeadm token generate)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$token</span></span><br><span class="line">cat &lt;&lt; EOF &gt; <span class="variable">$HOME</span>/kubeadm-1.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha2</span><br><span class="line">kind: MasterConfiguration</span><br><span class="line">kubernetesVersion: v1.11.5</span><br><span class="line">api:</span><br><span class="line">  advertiseAddress: 172.19.170.183</span><br><span class="line">  <span class="built_in">bind</span>Port: 6443</span><br><span class="line">  controlPlaneEndpoint: 172.19.170.100:8443    </span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- 172.19.170.183</span><br><span class="line">- 172.19.170.184</span><br><span class="line">- 172.19.170.185</span><br><span class="line">- master-1</span><br><span class="line">- master-2</span><br><span class="line">- master-3</span><br><span class="line">- 172.19.170.100</span><br><span class="line">- 127.0.0.1</span><br><span class="line">kubeProxy:</span><br><span class="line">  config:</span><br><span class="line">    mode: iptables</span><br><span class="line">etcd:</span><br><span class="line">  external:</span><br><span class="line">    endpoints:</span><br><span class="line">    - <span class="string">"https://172.19.170.183:2379"</span></span><br><span class="line">    - <span class="string">"https://172.19.170.184:2379"</span></span><br><span class="line">    - <span class="string">"https://172.19.170.185:2379"</span></span><br><span class="line">    caFile: /etc/etcd/ssl/etcd-ca.pem</span><br><span class="line">    certFile: /etc/etcd/ssl/etcd.pem</span><br><span class="line">    keyFile: /etc/etcd/ssl/etcd-key.pem</span><br><span class="line">token: <span class="variable">$token</span></span><br><span class="line">tokenTTL: <span class="string">"0"</span></span><br><span class="line">networking:</span><br><span class="line">  podSubnet: 192.168.0.0/16</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubeadm config images pull --config <span class="variable">$HOME</span>/kubeadm-1.yaml</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line">kubeadm init --config <span class="variable">$HOME</span>/kubeadm-1.yaml</span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">cp <span class="_">-f</span> /etc/kubernetes/admin.conf <span class="variable">$&#123;HOME&#125;</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹etcdæ˜¯å¦å¯åŠ¨ï¼Œç­‰å¾…è¿”å›Running è¯´æ˜å¯åŠ¨æˆåŠŸ</span></span><br><span class="line">kubectl get pods -n kube-system 2&gt;&amp;1|grep etcd|awk <span class="string">'&#123;print $3&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å…¶ä»–master</span></span><br><span class="line">ssh master-2 <span class="string">"mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube"</span></span><br><span class="line">ssh master-3 <span class="string">"mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´æ–‡ä»¶è‡³ master-2</span></span><br><span class="line">scp /etc/kubernetes/pki/ca.crt master-2:/etc/kubernetes/pki/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/ca.key master-2:/etc/kubernetes/pki/ca.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.key master-2:/etc/kubernetes/pki/sa.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.pub master-2:/etc/kubernetes/pki/sa.pub</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.crt master-2:/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.key master-2:/etc/kubernetes/pki/front-proxy-ca.key</span><br><span class="line">scp /etc/kubernetes/admin.conf master-2:/etc/kubernetes/admin.conf</span><br><span class="line">scp /etc/kubernetes/admin.conf master-2:~/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‹·è´æ–‡ä»¶è‡³ master-3</span></span><br><span class="line">scp /etc/kubernetes/pki/ca.crt master-3:/etc/kubernetes/pki/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/ca.key master-3:/etc/kubernetes/pki/ca.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.key master-3:/etc/kubernetes/pki/sa.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.pub master-3:/etc/kubernetes/pki/sa.pub</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.crt master-3:/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.key master-3:/etc/kubernetes/pki/front-proxy-ca.key</span><br><span class="line">scp /etc/kubernetes/admin.conf master-3:/etc/kubernetes/admin.conf</span><br><span class="line">scp /etc/kubernetes/admin.conf master-3:~/.kube/config</span><br></pre></td></tr></table></figure>
<h3 id="åˆå§‹åŒ–master-2"><a href="#åˆå§‹åŒ–master-2" class="headerlink" title="åˆå§‹åŒ–master-2"></a>åˆå§‹åŒ–master-2</h3><blockquote>
<p> <code>åœ¨master-2 ä¸Šæ‰§è¡Œ</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha2</span><br><span class="line">kind: MasterConfiguration</span><br><span class="line">kubernetesVersion: v1.11.5</span><br><span class="line">api:</span><br><span class="line">  advertiseAddress: 172.19.170.184</span><br><span class="line">  <span class="built_in">bind</span>Port: 6443</span><br><span class="line">  controlPlaneEndpoint: 172.19.170.100:8443 </span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- 172.19.170.183</span><br><span class="line">- 172.19.170.184</span><br><span class="line">- 172.19.170.185</span><br><span class="line">- master-1</span><br><span class="line">- master-2</span><br><span class="line">- master-3</span><br><span class="line">- 172.19.170.100</span><br><span class="line">- 127.0.0.1</span><br><span class="line">kubeProxy:</span><br><span class="line">  config:</span><br><span class="line">    mode: iptables</span><br><span class="line">etcd:</span><br><span class="line">  external:</span><br><span class="line">    endpoints:</span><br><span class="line">    - <span class="string">"https://172.19.170.183:2379"</span></span><br><span class="line">    - <span class="string">"https://172.19.170.184:2379"</span></span><br><span class="line">    - <span class="string">"https://172.19.170.185:2379"</span></span><br><span class="line">    caFile: /etc/etcd/ssl/etcd-ca.pem</span><br><span class="line">    certFile: /etc/etcd/ssl/etcd.pem</span><br><span class="line">    keyFile: /etc/etcd/ssl/etcd-key.pem</span><br><span class="line">token: <span class="variable">$token</span></span><br><span class="line">tokenTTL: <span class="string">"0"</span></span><br><span class="line">networking:</span><br><span class="line">  podSubnet: 192.168.0.0/16</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubeadm alpha phase certs all --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig controller-manager --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig scheduler --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubelet config write-to-disk --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubelet write-env-file --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig kubelet --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">kubeadm alpha phase kubeconfig all --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase controlplane all --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase mark-master --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br></pre></td></tr></table></figure>
<h3 id="åˆå§‹åŒ–master-3"><a href="#åˆå§‹åŒ–master-3" class="headerlink" title="åˆå§‹åŒ–master-3"></a>åˆå§‹åŒ–master-3</h3><blockquote>
<p> <code>åœ¨master-3 ä¸Šæ‰§è¡Œ</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha2</span><br><span class="line">kind: MasterConfiguration</span><br><span class="line">kubernetesVersion: v1.11.5</span><br><span class="line">api:</span><br><span class="line">  advertiseAddress: 172.19.170.185</span><br><span class="line">  <span class="built_in">bind</span>Port: 6443</span><br><span class="line">  controlPlaneEndpoint: 172.19.170.100:8443    </span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- 172.19.170.183</span><br><span class="line">- 172.19.170.184</span><br><span class="line">- 172.19.170.185</span><br><span class="line">- master-1</span><br><span class="line">- master-2</span><br><span class="line">- master-3</span><br><span class="line">- 172.19.170.100</span><br><span class="line">- 127.0.0.1</span><br><span class="line">kubeProxy:</span><br><span class="line">  config:</span><br><span class="line">    mode: iptables</span><br><span class="line">etcd:</span><br><span class="line">  external:</span><br><span class="line">    endpoints:</span><br><span class="line">    - <span class="string">"https://172.19.170.183:2379"</span></span><br><span class="line">    - <span class="string">"https://172.19.170.184:2379"</span></span><br><span class="line">    - <span class="string">"https://172.19.170.185:2379"</span></span><br><span class="line">    caFile: /etc/etcd/ssl/etcd-ca.pem</span><br><span class="line">    certFile: /etc/etcd/ssl/etcd.pem</span><br><span class="line">    keyFile: /etc/etcd/ssl/etcd-key.pem</span><br><span class="line">token: <span class="variable">$token</span></span><br><span class="line">tokenTTL: <span class="string">"0"</span></span><br><span class="line">networking:</span><br><span class="line">  podSubnet: 192.168.0.0/16</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubeadm alpha phase certs all --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig controller-manager --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig scheduler --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubelet config write-to-disk --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubelet write-env-file --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig kubelet --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">kubeadm alpha phase kubeconfig all --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase controlplane all --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase mark-master --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment">################## è‡³æ­¤é›†ç¾¤æ­å»ºå®Œæˆ #####################</span></span><br><span class="line"><span class="comment">######################################################</span></span><br></pre></td></tr></table></figure>
<h2 id="å¼€å¯kubernetes-æ’ä»¶"><a href="#å¼€å¯kubernetes-æ’ä»¶" class="headerlink" title="å¼€å¯kubernetes æ’ä»¶"></a>å¼€å¯kubernetes æ’ä»¶</h2><blockquote>
<p>åœ¨éšæ„ä¸€å°masteræ‰§è¡Œ</p>
</blockquote>
<h3 id="å®‰è£…calico-ç½‘ç»œæ’ä»¶"><a href="#å®‰è£…calico-ç½‘ç»œæ’ä»¶" class="headerlink" title="å®‰è£…calico ç½‘ç»œæ’ä»¶"></a>å®‰è£…calico ç½‘ç»œæ’ä»¶</h3><p>ç¡®ä¿ <code>Kubernetes controller manager (/etc/kubernetes/manifests/kube-controller-manager.yaml)</code> è®¾ç½®äº†ä»¥ä¸‹æ ‡å¿—ï¼š<code>--cluster-cidr=192.168.0.0/16å’Œ--allocate-node-cidrs=true</code>ã€‚</p>
<p>æç¤ºï¼šåœ¨kubeadmä¸Šï¼Œæ‚¨å¯ä»¥ä¼ é€’<code>--pod-network-cidr=192.168.0.0/16</code> ç»™kubeadmä»¥è®¾ç½®ä¸¤ä¸ªKubernetesæ§åˆ¶å™¨æ ‡å¿—ã€‚</p>
<p>åœ¨ConfigMapå‘½åä¸­<code>calico-config</code>ï¼Œæ‰¾åˆ°<code>typha_service_name</code>ï¼Œåˆ é™¤<code>none</code>å€¼ï¼Œå¹¶æ›¿æ¢ä¸º<code>calico-typha</code></p>
<p>æˆ‘ä»¬å»ºè®®æ¯<code>200</code>ä¸ªèŠ‚ç‚¹è‡³å°‘<code>å¤åˆ¶ä¸€ä¸ªå‰¯æœ¬</code>ï¼Œä¸è¶…è¿‡20ä¸ªå‰¯æœ¬ã€‚åœ¨ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬å»ºè®®è‡³å°‘ä½¿ç”¨<code>ä¸‰ä¸ªå‰¯æœ¬</code>æ¥å‡å°‘æ»šåŠ¨å‡çº§å’Œæ•…éšœçš„å½±å“ã€‚</p>
<p><strong><code>è­¦å‘Šï¼šå¦‚æœæ‚¨è®¾ç½®typha_service_nameè€Œä¸å¢åŠ å…¶é»˜è®¤å€¼ä¸º0 Felixçš„å‰¯æœ¬è®¡æ•°å°†å°è¯•è¿æ¥åˆ°Typhaï¼Œæ‰¾ä¸åˆ°è¦è¿æ¥çš„Typhaå®ä¾‹ï¼Œå¹¶ä¸”æ— æ³•å¯åŠ¨ã€‚</code></strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="_">-f</span> www.jiunile.com/k8s/plugin/1.11.5/calico.yaml</span><br></pre></td></tr></table></figure></p>
<h3 id="å®‰è£…heapster-ç›‘æ§æ’ä»¶"><a href="#å®‰è£…heapster-ç›‘æ§æ’ä»¶" class="headerlink" title="å®‰è£…heapster ç›‘æ§æ’ä»¶"></a>å®‰è£…heapster ç›‘æ§æ’ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="_">-f</span> www.jiunile.com/k8s/plugin/1.11.5/heapster.yaml</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…dashboard-æ’ä»¶"><a href="#å®‰è£…dashboard-æ’ä»¶" class="headerlink" title="å®‰è£…dashboard æ’ä»¶"></a>å®‰è£…dashboard æ’ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="_">-f</span> www.jiunile.com/k8s/plugin/1.11.5/dashboard.yaml</span><br></pre></td></tr></table></figure>
<h3 id="è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤"><a href="#è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤" class="headerlink" title="è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤"></a>è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>
<h2 id="åˆå§‹åŒ–æ‰€æœ‰kubernetes-node"><a href="#åˆå§‹åŒ–æ‰€æœ‰kubernetes-node" class="headerlink" title="åˆå§‹åŒ–æ‰€æœ‰kubernetes node"></a>åˆå§‹åŒ–æ‰€æœ‰kubernetes node</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–calicoç½‘ç»œå¯¹åº”éœ€è¦çš„é•œåƒï¼Œæ‹‰å–æ¯”æ•™ç¼“æ…¢</span></span><br><span class="line">docker pull quay.io/calico/typha:v3.2.4</span><br><span class="line">docker pull quay.io/calico/node:v3.2.4</span><br><span class="line">docker pull quay.io/calico/cni:v3.2.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ å…¥é›†ç¾¤</span></span><br><span class="line">kubeadm join 172.19.170.100:8443 --token mrvxeb.mfr1wx6upq5bbwqt --discovery-token-ca-cert-hash sha256:8ee893d8bf69f1f622f55a983f1401a9f2a236ffa9248894cb614c972de47f48</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¯ä»¥åœ¨masteræœºå™¨ä¸ŠæŸ¥çœ‹å¯¹åº”çš„nodeçŠ¶æ€</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">kubectl get pod -n kube-system</span><br></pre></td></tr></table></figure>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><h3 id="æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸"><a href="#æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸" class="headerlink" title="æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸"></a>æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸</h3><blockquote>
<p>åœ¨éšæ„ä¸€å°masteræœºå™¨ä¸Šè¿è¡Œ</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éƒ¨ç½²ä¸€ä¸ªæœåŠ¡</span></span><br><span class="line"><span class="built_in">cd</span> /root &amp;&amp; mkdir nginx &amp;&amp; <span class="built_in">cd</span> nginx</span><br><span class="line">cat &lt;&lt; EOF &gt; nginx.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    nodePort: 31000</span><br><span class="line">    name: nginx-port</span><br><span class="line">    targetPort: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply <span class="_">-f</span> nginx.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªPODæ¥æµ‹è¯•DNSè§£æ</span></span><br><span class="line">kubectl run curl --image=radial/busyboxplus:curl -i --tty</span><br><span class="line">nslookup kubernetes</span><br><span class="line"><span class="comment"># Server:    10.96.0.10</span></span><br><span class="line"><span class="comment"># Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Name:      kubernetes</span></span><br><span class="line"><span class="comment"># Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span></span><br><span class="line">curl nginx</span><br><span class="line"><span class="comment"># æœ‰è¿”å›ç»“æœè¡¨æ˜ok</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">kubectl delete deployment curl</span><br></pre></td></tr></table></figure>
<h3 id="æµ‹è¯•master-amp-Haproxyé«˜å¯ç”¨"><a href="#æµ‹è¯•master-amp-Haproxyé«˜å¯ç”¨" class="headerlink" title="æµ‹è¯•master &amp; Haproxyé«˜å¯ç”¨"></a>æµ‹è¯•master &amp; Haproxyé«˜å¯ç”¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#éšæœºå…³æ‰ä¸€å°masteræœºå™¨</span></span><br><span class="line">init 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨åˆ«çš„masteræœºå™¨ä¸Šæ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">kubectl get node</span><br><span class="line"><span class="comment">#NAME      STATUS     ROLES     AGE       VERSION</span></span><br><span class="line"><span class="comment">#master-1   NotReady   master    1h        v1.11.5</span></span><br><span class="line"><span class="comment">#master-2   Ready      master    59m       v1.11.5</span></span><br><span class="line"><span class="comment">#master-3   Ready      master    59m       v1.11.5</span></span><br><span class="line"><span class="comment">#node-1     Ready      &lt;none&gt;    58m       v1.11.5</span></span><br><span class="line"><span class="comment">#node-2     Ready      &lt;none&gt;    58m       v1.11.5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡æ–°åˆ›å»ºä¸€ä¸ªpodï¼Œçœ‹çœ‹æ˜¯å¦èƒ½åˆ›å»ºæˆåŠŸ</span></span><br><span class="line">kubectl run curl --image=radial/busyboxplus:curl -i --tty</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">kubectl delete deployment curl</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[chrome è®¿é—®k8s dashboard å‡ºç°sslè¯ä¹¦é”™è¯¯]]></title>
      <url>http://team.jiunile.com/blog/2018/12/k8s-dashboard-chrome-err.html</url>
      <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote>
<p>æœ€è¿‘ä¸Šäº†k8såï¼Œç»™å¼€å‘æä¾›dashboardè®¿é—®ï¼Œå‘ç°æœ‰ä¸å°‘å¼€å‘æ— æ³•ä½¿ç”¨chromeè®¿é—®ï¼Œå‡ºç°é—®é¢˜çš„å¤§éƒ¨åˆ†éƒ½æ˜¯ä½¿ç”¨çš„windowsç³»ç»Ÿï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç±»é—®é¢˜ï¼Œè¿™é‡Œè®°å½•ä¸‹å¦‚ä½•è§£å†³</p>
</blockquote>
<h3 id="ERR-SSL-SERVER-CERT-BAD-FORMAT"><a href="#ERR-SSL-SERVER-CERT-BAD-FORMAT" class="headerlink" title="ERR_SSL_SERVER_CERT_BAD_FORMAT"></a>ERR_SSL_SERVER_CERT_BAD_FORMAT</h3><blockquote>
<p>è§£å†³æ–¹æ³•ï¼šé‡æ–°å®‰è£…chromeæœ€æ–°ç‰ˆæœ¬è§£å†³</p>
</blockquote>
<h3 id="NET-ERR-CERT-INVALID"><a href="#NET-ERR-CERT-INVALID" class="headerlink" title="NET::ERR_CERT_INVALID"></a>NET::ERR_CERT_INVALID</h3><p><img src="/images/k8s/chrome_err.png" alt="NET::ERR_CERT_INVALID"></p>
<blockquote>
<p>è§£å†³æ–¹æ³•ï¼šåˆ›å»ºchromeæ¡Œé¢å¿«æ·æ–¹å¼ï¼Œç„¶ååˆ°æ¡Œé¢ï¼šå³é”®chromeâ€“&gt;å±æ€§â€“&gt;åœ¨ç›®æ ‡åé¢æ·»åŠ å¦‚ä¸‹ï¼š<code>--disable-infobars --ignore-certificate-errors</code></p>
<p>ç¤ºä¾‹ï¼š<code>&quot;C:\Program Files (x86)\Google\Chrome\Application\chrome.exe&quot; --disable-infobars --ignore-certificate-errors</code></p>
</blockquote>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ä½¿ç”¨Kubeadm 1.12.x éƒ¨ç½²å¤šMasteré›†ç¾¤]]></title>
      <url>http://team.jiunile.com/blog/2018/12/k8s-kubeadm-ha-1-12-x.html</url>
      <content type="html"><![CDATA[<h2 id="ç¯å¢ƒä»‹ç»"><a href="#ç¯å¢ƒä»‹ç»" class="headerlink" title="ç¯å¢ƒä»‹ç»"></a>ç¯å¢ƒä»‹ç»</h2><table>
<thead>
<tr>
<th style="text-align:left">IP</th>
<th style="text-align:left">Hostname</th>
<th style="text-align:left">å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">172.19.170.183</td>
<td style="text-align:left">master-1</td>
<td style="text-align:left">ç§æœ‰äº‘å®‰è£…keepalived + haproxy</td>
</tr>
<tr>
<td style="text-align:left">172.19.170.184</td>
<td style="text-align:left">master-2</td>
<td style="text-align:left">ç§æœ‰äº‘å®‰è£…keepalived + haproxy</td>
</tr>
<tr>
<td style="text-align:left">172.19.170.185</td>
<td style="text-align:left">master-3</td>
<td style="text-align:left">ç§æœ‰äº‘å®‰è£…keepalived + haproxy</td>
</tr>
<tr>
<td style="text-align:left">172.19.170.186</td>
<td style="text-align:left">node-1</td>
<td style="text-align:left">æ— </td>
</tr>
<tr>
<td style="text-align:left">172.19.170.187</td>
<td style="text-align:left">node-2</td>
<td style="text-align:left">æ— </td>
</tr>
<tr>
<td style="text-align:left">172.19.170.100</td>
<td style="text-align:left">vip</td>
<td style="text-align:left">ç§æœ‰äº‘ä½¿ç”¨keepalive+haproxyæ­å»ºï¼Œå…¬æœ‰äº‘ä½¿ç”¨å†…éƒ¨è´Ÿè½½å‡è¡¡å™¨</td>
</tr>
</tbody>
</table>
<h2 id="ç¯å¢ƒåˆå§‹åŒ–"><a href="#ç¯å¢ƒåˆå§‹åŒ–" class="headerlink" title="ç¯å¢ƒåˆå§‹åŒ–"></a>ç¯å¢ƒåˆå§‹åŒ–</h2><h3 id="ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ"><a href="#ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ" class="headerlink" title="ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ"></a>ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;&gt; /etc/hosts</span><br><span class="line">172.19.170.183 master-1</span><br><span class="line">172.19.170.184 master-2</span><br><span class="line">172.19.170.185 master-3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨master-1-æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"><a href="#åœ¨master-1-æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š" class="headerlink" title="åœ¨master-1 æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"></a>åœ¨master-1 æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id root@master-2</span><br><span class="line">ssh-copy-id root@master-3</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="ä¼˜åŒ–æ‰€æœ‰master-amp-node-èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ"><a href="#ä¼˜åŒ–æ‰€æœ‰master-amp-node-èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ" class="headerlink" title="ä¼˜åŒ–æ‰€æœ‰master &amp; node èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ"></a>ä¼˜åŒ–æ‰€æœ‰master &amp; node èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ</h3><blockquote>
<p><code>åœ¨æ‰€æœ‰master &amp; node æœºå™¨ä¸Šéƒ½è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment"># å®‰è£…4.18ç‰ˆæœ¬å†…æ ¸</span></span><br><span class="line"><span class="comment"># ç”±äºæœ€æ–°ç¨³å®šç‰ˆ4.19å†…æ ¸å°†nf_conntrack_ipv4æ›´åä¸ºnf_conntrackï¼Œç›®å‰çš„kube-proxyä¸æ”¯æŒåœ¨4.19ç‰ˆæœ¬å†…æ ¸ä¸‹å¼€å¯ipvs</span></span><br><span class="line"><span class="comment"># è¯¦æƒ…å¯ä»¥æŸ¥çœ‹ï¼šhttps://github.com/kubernetes/kubernetes/issues/70304</span></span><br><span class="line"><span class="comment"># å¯¹äºè¯¥é—®é¢˜çš„ä¿®å¤10æœˆ30æ—¥åˆšåˆšåˆå¹¶åˆ°ä»£ç ä¸»å¹²ï¼Œæ‰€ä»¥ç›®å‰è¿˜æ²¡æœ‰åŒ…å«æ­¤ä¿®å¤çš„kubernetesç‰ˆæœ¬å‘å‡º</span></span><br><span class="line"><span class="comment"># å¯ä»¥é€‰æ‹©å®‰è£…4.18ç‰ˆæœ¬å†…æ ¸ï¼Œæˆ–è€…ä¸å¼€å¯IPVS</span></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment">############################# start #############################</span></span><br><span class="line"><span class="comment"># å‡çº§å†…æ ¸</span></span><br><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm ;yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml -y</span><br><span class="line"> </span><br><span class="line"><span class="comment"># æ£€æŸ¥é»˜è®¤å†…æ ¸ç‰ˆæœ¬æ˜¯å¦å¤§äº4.14ï¼Œå¦åˆ™è¯·è°ƒæ•´é»˜è®¤å¯åŠ¨å‚æ•°</span></span><br><span class="line">grub2-editenv list</span><br><span class="line"> </span><br><span class="line"><span class="comment">#é‡å¯ä»¥æ›´æ¢å†…æ ¸</span></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯ip_vs</span></span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">ipvs_modules_dir=<span class="string">"/usr/lib/modules/\`uname -r\`/kernel/net/netfilter/ipvs"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> \`ls \<span class="variable">$ipvs_modules_dir</span> | sed  -r <span class="string">'s#(.*).ko.*#\1#'</span>\`; <span class="keyword">do</span></span><br><span class="line">    /sbin/modinfo -F filename \<span class="variable">$i</span>  &amp;&gt; /dev/null</span><br><span class="line">    <span class="keyword">if</span> [ \$? <span class="_">-eq</span> 0 ]; <span class="keyword">then</span></span><br><span class="line">        /sbin/modprobe \<span class="variable">$i</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ£€æŸ¥æ˜¯å¦å¼€å¯äº†ip_vs</span></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vs</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# end #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼˜åŒ–å†…æ ¸</span></span><br><span class="line">cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.inotify.max_user_instances = 8192</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">vm.swappiness = 0</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡ŒsysctlæŠ¥é”™è¯·å‚è€ƒcentos7æ·»åŠ bridge-nf-call-ip6tableså‡ºç°No such file or directory: https://blog.csdn.net/airuozhaoyang/article/details/40534953</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼˜åŒ–æ–‡ä»¶æ‰“å¼€æ•°</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* soft nofile 65536"</span> &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* hard nofile 65536"</span> &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* soft nproc 65536"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* hard nproc 65536"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* soft  memlock  unlimited"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* hard memlock  unlimited"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­Selinux/firewalld</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­äº¤æ¢åˆ†åŒº</span></span><br><span class="line">swapoff <span class="_">-a</span></span><br><span class="line">yes | cp /etc/fstab /etc/fstab_bak</span><br><span class="line">cat /etc/fstab_bak |grep -v swap &gt; /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒæ­¥æ—¶é—´</span></span><br><span class="line">yum install -y ntpdate</span><br><span class="line">ntpdate -u ntp.api.bz</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®kubernet yumæº</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…kubernet</span></span><br><span class="line">yum install kubeadm-1.12.3-0 kubelet-1.12.3-0 kubectl-1.12.3-0 --disableexcludes=kubernetes -y</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®dockeræº</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/docker.repo &lt;&lt;EOF</span><br><span class="line">[docker]</span><br><span class="line">name=Docker Repository</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/repo/centos7</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…docker-engine</span></span><br><span class="line">yum -y install docker-engine-1.13.1 --disableexcludes=docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®kubeletå¯åŠ¨é…ç½®</span></span><br><span class="line">cgroupDriver=$(docker info|grep Cg)</span><br><span class="line">driver=<span class="variable">$&#123;cgroupDriver##*: &#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"driver is <span class="variable">$&#123;driver&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_NETWORK_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_DNS_ARGS=--cluster-dns=10.96.0.10 --cluster-domain=cluster.local"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_AUTHZ_ARGS=--authorization-mode=Webhook --client-ca-file=/etc/kubernetes/pki/ca.crt"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CGROUP_ARGS=--cgroup-driver=<span class="variable">$&#123;driver&#125;</span>"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CERTIFICATE_ARGS=--rotate-certificates=true --cert-dir=/var/lib/kubelet/pki"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_EXTRA_ARGS=--system-reserved=cpu=200m,memory=250Mi --kube-reserved=cpu=200m,memory=250Mi --eviction-soft=memory.available&lt;500Mi,nodefs.available&lt;2Gi --eviction-soft-grace-period=memory.available=1m30s,nodefs.available=1m30s --eviction-max-pod-grace-period=120 --eviction-hard=memory.available&lt;500Mi,nodefs.available&lt;1Gi --eviction-minimum-reclaim=memory.available=0Mi,nodefs.available=500Mi,imagefs.available=2Gi --node-status-update-frequency=10s --eviction-pressure-transition-period=30s"</span></span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet \<span class="variable">$KUBELET_KUBECONFIG_ARGS</span> \<span class="variable">$KUBELET_SYSTEM_PODS_ARGS</span> \<span class="variable">$KUBELET_NETWORK_ARGS</span> \<span class="variable">$KUBELET_DNS_ARGS</span> \<span class="variable">$KUBELET_AUTHZ_ARGS</span> \<span class="variable">$KUBELET_CGROUP_ARGS</span> \<span class="variable">$KUBELET_CERTIFICATE_ARGS</span> \<span class="variable">$KUBELET_EXTRA_ARGS</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="æ­å»ºkeepalived-haproxy-å…¬æœ‰äº‘ä¸éœ€è¦æ­å»º"><a href="#æ­å»ºkeepalived-haproxy-å…¬æœ‰äº‘ä¸éœ€è¦æ­å»º" class="headerlink" title="æ­å»ºkeepalived + haproxy (å…¬æœ‰äº‘ä¸éœ€è¦æ­å»º)"></a>æ­å»ºkeepalived + haproxy (å…¬æœ‰äº‘ä¸éœ€è¦æ­å»º)</h2><h3 id="åœ¨master-1ä¸Šé…ç½®"><a href="#åœ¨master-1ä¸Šé…ç½®" class="headerlink" title="åœ¨master-1ä¸Šé…ç½®"></a>åœ¨master-1ä¸Šé…ç½®</h3><h4 id="keepalived-å®‰è£…é…ç½®"><a href="#keepalived-å®‰è£…é…ç½®" class="headerlink" title="keepalived å®‰è£…é…ç½®"></a>keepalived å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">    global_defs &#123;</span><br><span class="line">        notification_email &#123;</span><br><span class="line">            root@localhost      <span class="comment">#å‘é€é‚®ç®±</span></span><br><span class="line">        &#125;</span><br><span class="line">        notification_email_from keepalived@localhost    <span class="comment">#é‚®ç®±åœ°å€   </span></span><br><span class="line">        smtp_server 127.0.0.1   <span class="comment">#é‚®ä»¶æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">        smtp_connect_timeout 30 </span><br><span class="line">        router_id node1         <span class="comment">#ä¸»æœºåï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸åŒå³å¯</span></span><br><span class="line">    &#125;       </span><br><span class="line">        </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER        <span class="comment">#åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šä¸ºBACKUP</span></span><br><span class="line">    interface eth0      <span class="comment">#IPåœ°å€æ¼‚ç§»åˆ°çš„ç½‘å¡</span></span><br><span class="line">    virtual_router_id 6 <span class="comment">#å¤šä¸ªèŠ‚ç‚¹å¿…é¡»ç›¸åŒ</span></span><br><span class="line">    priority 100        <span class="comment">#ä¼˜å…ˆçº§ï¼Œå¤‡ç”¨èŠ‚ç‚¹çš„å€¼å¿…é¡»ä½äºä¸»èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">    advert_int 1        <span class="comment">#é€šå‘Šé—´éš”1ç§’</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_<span class="built_in">type</span> PASS      <span class="comment">#é¢„å…±äº«å¯†é’¥è®¤è¯</span></span><br><span class="line">        auth_pass 571f97b2  <span class="comment">#å¯†é’¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.19.170.100    <span class="comment">#VIPåœ°å€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived</span><br><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure>
<h4 id="haproxy-å®‰è£…é…ç½®"><a href="#haproxy-å®‰è£…é…ç½®" class="headerlink" title="haproxy å®‰è£…é…ç½®"></a>haproxy å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">yum install  -y haproxy</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 <span class="built_in">local</span>2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    <span class="built_in">log</span>                     global</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line"></span><br><span class="line">frontend kubernetes</span><br><span class="line">    <span class="built_in">bind</span> *:8443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend kubernetes-master</span><br><span class="line"></span><br><span class="line">backend kubernetes-master</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server master-1 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-2 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-3 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br><span class="line">systemctl start haproxy</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨master-2ä¸Šé…ç½®"><a href="#åœ¨master-2ä¸Šé…ç½®" class="headerlink" title="åœ¨master-2ä¸Šé…ç½®"></a>åœ¨master-2ä¸Šé…ç½®</h3><h4 id="keepalived-å®‰è£…é…ç½®-1"><a href="#keepalived-å®‰è£…é…ç½®-1" class="headerlink" title="keepalived å®‰è£…é…ç½®"></a>keepalived å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">    global_defs &#123;</span><br><span class="line">        notification_email &#123;</span><br><span class="line">            root@localhost      <span class="comment">#å‘é€é‚®ç®±</span></span><br><span class="line">        &#125;</span><br><span class="line">        notification_email_from keepalived@localhost    <span class="comment">#é‚®ç®±åœ°å€   </span></span><br><span class="line">        smtp_server 127.0.0.1   <span class="comment">#é‚®ä»¶æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">        smtp_connect_timeout 30 </span><br><span class="line">        router_id node2         <span class="comment">#ä¸»æœºåï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸åŒå³å¯</span></span><br><span class="line">    &#125;       </span><br><span class="line">        </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP        <span class="comment">#åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šä¸ºBACKUP</span></span><br><span class="line">    interface eth0      <span class="comment">#IPåœ°å€æ¼‚ç§»åˆ°çš„ç½‘å¡</span></span><br><span class="line">    virtual_router_id 6 <span class="comment">#å¤šä¸ªèŠ‚ç‚¹å¿…é¡»ç›¸åŒ</span></span><br><span class="line">    priority 80        <span class="comment">#ä¼˜å…ˆçº§ï¼Œå¤‡ç”¨èŠ‚ç‚¹çš„å€¼å¿…é¡»ä½äºä¸»èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">    advert_int 1        <span class="comment">#é€šå‘Šé—´éš”1ç§’</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_<span class="built_in">type</span> PASS      <span class="comment">#é¢„å…±äº«å¯†é’¥è®¤è¯</span></span><br><span class="line">        auth_pass 571f97b2  <span class="comment">#å¯†é’¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.19.170.100    <span class="comment">#VIPåœ°å€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived</span><br><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure>
<h4 id="haproxy-å®‰è£…é…ç½®-1"><a href="#haproxy-å®‰è£…é…ç½®-1" class="headerlink" title="haproxy å®‰è£…é…ç½®"></a>haproxy å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">yum install  -y haproxy</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 <span class="built_in">local</span>2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    <span class="built_in">log</span>                     global</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line"></span><br><span class="line">frontend kubernetes</span><br><span class="line">    <span class="built_in">bind</span> *:8443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend kubernetes-master</span><br><span class="line"></span><br><span class="line">backend kubernetes-master</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server master-1 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-2 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-3 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br><span class="line">systemctl start haproxy</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨master-3ä¸Šé…ç½®"><a href="#åœ¨master-3ä¸Šé…ç½®" class="headerlink" title="åœ¨master-3ä¸Šé…ç½®"></a>åœ¨master-3ä¸Šé…ç½®</h3><h4 id="keepalived-å®‰è£…é…ç½®-2"><a href="#keepalived-å®‰è£…é…ç½®-2" class="headerlink" title="keepalived å®‰è£…é…ç½®"></a>keepalived å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">    global_defs &#123;</span><br><span class="line">        notification_email &#123;</span><br><span class="line">            root@localhost      <span class="comment">#å‘é€é‚®ç®±</span></span><br><span class="line">        &#125;</span><br><span class="line">        notification_email_from keepalived@localhost    <span class="comment">#é‚®ç®±åœ°å€   </span></span><br><span class="line">        smtp_server 127.0.0.1   <span class="comment">#é‚®ä»¶æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">        smtp_connect_timeout 30 </span><br><span class="line">        router_id node3         <span class="comment">#ä¸»æœºåï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸åŒå³å¯</span></span><br><span class="line">    &#125;       </span><br><span class="line">        </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP        <span class="comment">#åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šä¸ºBACKUP</span></span><br><span class="line">    interface eth0      <span class="comment">#IPåœ°å€æ¼‚ç§»åˆ°çš„ç½‘å¡</span></span><br><span class="line">    virtual_router_id 6 <span class="comment">#å¤šä¸ªèŠ‚ç‚¹å¿…é¡»ç›¸åŒ</span></span><br><span class="line">    priority 80        <span class="comment">#ä¼˜å…ˆçº§ï¼Œå¤‡ç”¨èŠ‚ç‚¹çš„å€¼å¿…é¡»ä½äºä¸»èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">    advert_int 1        <span class="comment">#é€šå‘Šé—´éš”1ç§’</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_<span class="built_in">type</span> PASS      <span class="comment">#é¢„å…±äº«å¯†é’¥è®¤è¯</span></span><br><span class="line">        auth_pass 571f97b2  <span class="comment">#å¯†é’¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.19.170.100    <span class="comment">#VIPåœ°å€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived</span><br><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure>
<h4 id="haproxy-å®‰è£…é…ç½®-2"><a href="#haproxy-å®‰è£…é…ç½®-2" class="headerlink" title="haproxy å®‰è£…é…ç½®"></a>haproxy å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">yum install  -y haproxy</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 <span class="built_in">local</span>2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    <span class="built_in">log</span>                     global</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line"></span><br><span class="line">frontend kubernetes</span><br><span class="line">    <span class="built_in">bind</span> *:8443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend kubernetes-master</span><br><span class="line"></span><br><span class="line">backend kubernetes-master</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server master-1 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-2 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-3 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br><span class="line">systemctl start haproxy</span><br></pre></td></tr></table></figure>
<h2 id="æ­å»ºkubernetes-master-é›†ç¾¤"><a href="#æ­å»ºkubernetes-master-é›†ç¾¤" class="headerlink" title="æ­å»ºkubernetes master é›†ç¾¤"></a>æ­å»ºkubernetes master é›†ç¾¤</h2><h3 id="åˆå§‹åŒ–master-1"><a href="#åˆå§‹åŒ–master-1" class="headerlink" title="åˆå§‹åŒ–master-1"></a>åˆå§‹åŒ–master-1</h3><blockquote>
<p> <code>åœ¨master-1 ä¸Šæ‰§è¡Œ</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; <span class="variable">$HOME</span>/kubeadm-1.yaml</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha3</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha3</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.12.3</span><br><span class="line">api:</span><br><span class="line">  advertiseAddress: 172.19.170.183</span><br><span class="line">  <span class="built_in">bind</span>Port: 6443</span><br><span class="line">  controlPlaneEndpoint: 172.19.170.100:8443    </span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- 172.19.170.183</span><br><span class="line">- 172.19.170.184</span><br><span class="line">- 172.19.170.185</span><br><span class="line">- master-1</span><br><span class="line">- master-2</span><br><span class="line">- master-3</span><br><span class="line">- 172.19.170.100</span><br><span class="line">- 127.0.0.1</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    extraArgs:</span><br><span class="line">      listen-client-urls: https://127.0.0.1:2379,https://172.19.170.183:2379</span><br><span class="line">      advertise-client-urls: https://172.19.170.183:2379</span><br><span class="line">      listen-peer-urls: https://172.19.170.183:2380</span><br><span class="line">      initial-advertise-peer-urls: https://172.19.170.183:2380</span><br><span class="line">      initial-cluster: master-1=https://172.19.170.183:2380</span><br><span class="line">      initial-cluster-state: new</span><br><span class="line">    serverCertSANs:</span><br><span class="line">      - master-1</span><br><span class="line">      - 172.19.170.183</span><br><span class="line">    peerCertSANs:</span><br><span class="line">      - master-1</span><br><span class="line">      - 172.19.170.183</span><br><span class="line">networking:</span><br><span class="line">  <span class="comment"># This CIDR is a Calico default. Substitute or remove for your CNI provider.</span></span><br><span class="line">  podSubnet: 192.168.0.0/16</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  <span class="comment"># imageçš„ä»“åº“æº </span></span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: iptables </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubeadm config images pull --config <span class="variable">$HOME</span>/kubeadm-1.yaml</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line">kubeadm init --config <span class="variable">$HOME</span>/kubeadm-1.yaml</span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">cp <span class="_">-f</span> /etc/kubernetes/admin.conf <span class="variable">$&#123;HOME&#125;</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹etcdæ˜¯å¦å¯åŠ¨ï¼Œç­‰å¾…è¿”å›Running è¯´æ˜å¯åŠ¨æˆåŠŸ</span></span><br><span class="line">kubectl get pods -n kube-system 2&gt;&amp;1|grep etcd|awk <span class="string">'&#123;print $3&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å…¶ä»–master</span></span><br><span class="line">ssh master-2 <span class="string">"mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube"</span></span><br><span class="line">ssh master-3 <span class="string">"mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´æ–‡ä»¶è‡³ master-2</span></span><br><span class="line">scp /etc/kubernetes/pki/ca.crt master-2:/etc/kubernetes/pki/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/ca.key master-2:/etc/kubernetes/pki/ca.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.key master-2:/etc/kubernetes/pki/sa.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.pub master-2:/etc/kubernetes/pki/sa.pub</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.crt master-2:/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.key master-2:/etc/kubernetes/pki/front-proxy-ca.key</span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.crt master-2:/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.key master-2:/etc/kubernetes/pki/etcd/ca.key</span><br><span class="line">scp /etc/kubernetes/admin.conf master-2:/etc/kubernetes/admin.conf</span><br><span class="line">scp /etc/kubernetes/admin.conf master-2:~/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‹·è´æ–‡ä»¶è‡³ master-3</span></span><br><span class="line">scp /etc/kubernetes/pki/ca.crt master-3:/etc/kubernetes/pki/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/ca.key master-3:/etc/kubernetes/pki/ca.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.key master-3:/etc/kubernetes/pki/sa.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.pub master-3:/etc/kubernetes/pki/sa.pub</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.crt master-3:/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.key master-3:/etc/kubernetes/pki/front-proxy-ca.key</span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.crt master-3:/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.key master-3:/etc/kubernetes/pki/etcd/ca.key</span><br><span class="line">scp /etc/kubernetes/admin.conf master-3:/etc/kubernetes/admin.conf</span><br><span class="line">scp /etc/kubernetes/admin.conf master-3:~/.kube/config</span><br></pre></td></tr></table></figure>
<h3 id="åˆå§‹åŒ–master-2"><a href="#åˆå§‹åŒ–master-2" class="headerlink" title="åˆå§‹åŒ–master-2"></a>åˆå§‹åŒ–master-2</h3><blockquote>
<p> <code>åœ¨master-2 ä¸Šæ‰§è¡Œ</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha3</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha3</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.12.3</span><br><span class="line">api:</span><br><span class="line">  advertiseAddress: 172.19.170.184</span><br><span class="line">  <span class="built_in">bind</span>Port: 6443</span><br><span class="line">  controlPlaneEndpoint: 172.19.170.100:8443 </span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- 172.19.170.183</span><br><span class="line">- 172.19.170.184</span><br><span class="line">- 172.19.170.185</span><br><span class="line">- master-1</span><br><span class="line">- master-2</span><br><span class="line">- master-3</span><br><span class="line">- 172.19.170.100</span><br><span class="line">- 127.0.0.1</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    extraArgs:</span><br><span class="line">      listen-client-urls: https://127.0.0.1:2379,https://172.19.170.184:2379</span><br><span class="line">      advertise-client-urls: https://172.19.170.184:2379</span><br><span class="line">      listen-peer-urls: https://172.19.170.184:2380</span><br><span class="line">      initial-advertise-peer-urls: https://172.19.170.184:2380</span><br><span class="line">      initial-cluster: master-1=https://172.19.170.183:2380,master-2=https://172.19.170.184:2380</span><br><span class="line">      initial-cluster-state: existing</span><br><span class="line">    serverCertSANs:</span><br><span class="line">      - master-2</span><br><span class="line">      - 172.19.170.184</span><br><span class="line">    peerCertSANs:</span><br><span class="line">      - master-2</span><br><span class="line">      - 172.19.170.184</span><br><span class="line">networking:</span><br><span class="line">  <span class="comment"># This CIDR is a Calico default. Substitute or remove for your CNI provider.</span></span><br><span class="line">  podSubnet: 192.168.0.0/16</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  <span class="comment"># imageçš„ä»“åº“æº </span></span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: iptables </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment">################## åˆ‡æ¢è‡³master-1æ‰§è¡Œ ##################</span></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line">kubectl <span class="built_in">exec</span> \</span><br><span class="line">-n kube-system etcd-master-1 -- etcdctl \</span><br><span class="line">--ca-file /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert-file /etc/kubernetes/pki/etcd/peer.crt \</span><br><span class="line">--key-file /etc/kubernetes/pki/etcd/peer.key \</span><br><span class="line">--endpoints=https://172.19.170.183:2379 \</span><br><span class="line">member add master-2 https://172.19.170.184:2380</span><br><span class="line"><span class="comment"># åœ¨master-1 æ‰§è¡Œåä¼šå¡åœ¨é‚£è¾¹ï¼Œç­‰å¾…å…¶ä»–çš„etcdèŠ‚ç‚¹åŠ å…¥</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment">################## åˆ‡æ¢è‡³master-2æ‰§è¡Œ ##################</span></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line">kubeadm alpha phase certs all --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig controller-manager --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig scheduler --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubelet config write-to-disk --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubelet write-env-file --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig kubelet --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">kubeadm alpha phase etcd <span class="built_in">local</span> --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig all --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase controlplane all --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase mark-master --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br></pre></td></tr></table></figure>
<h3 id="åˆå§‹åŒ–master-3"><a href="#åˆå§‹åŒ–master-3" class="headerlink" title="åˆå§‹åŒ–master-3"></a>åˆå§‹åŒ–master-3</h3><blockquote>
<p> <code>åœ¨master-3 ä¸Šæ‰§è¡Œ</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha3</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha3</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.12.3</span><br><span class="line">api:</span><br><span class="line">  advertiseAddress: 172.19.170.185</span><br><span class="line">  <span class="built_in">bind</span>Port: 6443</span><br><span class="line">  controlPlaneEndpoint: 172.19.170.100:8443    </span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- 172.19.170.183</span><br><span class="line">- 172.19.170.184</span><br><span class="line">- 172.19.170.185</span><br><span class="line">- master-1</span><br><span class="line">- master-2</span><br><span class="line">- master-3</span><br><span class="line">- 172.19.170.100</span><br><span class="line">- 127.0.0.1</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    extraArgs:</span><br><span class="line">      listen-client-urls: https://127.0.0.1:2379,https://172.19.170.185:2379</span><br><span class="line">      advertise-client-urls: https://172.19.170.185:2379</span><br><span class="line">      listen-peer-urls: https://172.19.170.185:2380</span><br><span class="line">      initial-advertise-peer-urls: https://172.19.170.185:2380</span><br><span class="line">      initial-cluster: master-1=https://172.19.170.183:2380,master-2=https://172.19.170.184:2380,master-3=https://172.19.170.185:2380</span><br><span class="line">      initial-cluster-state: existing</span><br><span class="line">    serverCertSANs:</span><br><span class="line">      - master-3</span><br><span class="line">      - 172.19.170.185</span><br><span class="line">    peerCertSANs:</span><br><span class="line">      - master-3</span><br><span class="line">      - 172.19.170.185</span><br><span class="line">networking:</span><br><span class="line">  <span class="comment"># This CIDR is a Calico default. Substitute or remove for your CNI provider.</span></span><br><span class="line">  podSubnet: 192.168.0.0/16</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  <span class="comment"># imageçš„ä»“åº“æº  </span></span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: iptables </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment">################## åˆ‡æ¢è‡³master-1æ‰§è¡Œ ##################</span></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line">kubectl <span class="built_in">exec</span> \</span><br><span class="line">-n kube-system etcd-master-1 -- etcdctl \</span><br><span class="line">--ca-file /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert-file /etc/kubernetes/pki/etcd/peer.crt \</span><br><span class="line">--key-file /etc/kubernetes/pki/etcd/peer.key \</span><br><span class="line">--endpoints=https://172.19.170.183:2379 \</span><br><span class="line">member add master-3 https://172.19.170.185:2380</span><br><span class="line"><span class="comment"># åœ¨master-1 æ‰§è¡Œåä¼šå¡åœ¨é‚£è¾¹ï¼Œç­‰å¾…å…¶ä»–çš„etcdèŠ‚ç‚¹åŠ å…¥</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment">################## åˆ‡æ¢è‡³master-3æ‰§è¡Œ ##################</span></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line">kubeadm alpha phase certs all --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig controller-manager --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig scheduler --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubelet config write-to-disk --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubelet write-env-file --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig kubelet --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">kubeadm alpha phase etcd <span class="built_in">local</span> --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig all --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase controlplane all --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase mark-master --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br></pre></td></tr></table></figure>
<h3 id="è°ƒæ•´é…ç½®ï¼Œä½¿ç”¨vipæ¥è¿›è¡Œè°ƒåº¦"><a href="#è°ƒæ•´é…ç½®ï¼Œä½¿ç”¨vipæ¥è¿›è¡Œè°ƒåº¦" class="headerlink" title="è°ƒæ•´é…ç½®ï¼Œä½¿ç”¨vipæ¥è¿›è¡Œè°ƒåº¦"></a>è°ƒæ•´é…ç½®ï¼Œä½¿ç”¨vipæ¥è¿›è¡Œè°ƒåº¦</h3><blockquote>
<p>åœ¨æ‰€æœ‰masteræœºå™¨ä¸Šéƒ½æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨master-1 ä¸Šæ‰§è¡Œ</span></span><br><span class="line">sed -i <span class="string">'s/etcd-servers=https:\/\/127.0.0.1:2379/etcd-servers=https:\/\/172.19.170.183:2379,https:\/\/172.19.170.184:2379,https:\/\/172.19.170.185:2379/g'</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">sed -i <span class="string">'s/172.19.170.183:6443/172.19.170.100:8443/g'</span> ~/.kube/config</span><br><span class="line">sed -i <span class="string">'s/172.19.170.183:6443/172.19.170.100:8443/g'</span> /etc/kubernetes/kubelet.conf</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨master-2 ä¸Šæ‰§è¡Œ</span></span><br><span class="line">sed -i <span class="string">'s/etcd-servers=https:\/\/127.0.0.1:2379/etcd-servers=https:\/\/172.19.170.183:2379,https:\/\/172.19.170.184:2379,https:\/\/172.19.170.185:2379/g'</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">sed -i <span class="string">'s/172.19.170.184:6443/172.19.170.100:8443/g'</span> ~/.kube/config</span><br><span class="line">sed -i <span class="string">'s/172.19.170.184:6443/172.19.170.100:8443/g'</span> /etc/kubernetes/kubelet.conf</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨master-3 ä¸Šæ‰§è¡Œ</span></span><br><span class="line">sed -i <span class="string">'s/etcd-servers=https:\/\/127.0.0.1:2379/etcd-servers=https:\/\/172.19.170.183:2379,https:\/\/172.19.170.184:2379,https:\/\/172.19.170.185:2379/g'</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">sed -i <span class="string">'s/172.19.170.185:6443/172.19.170.100:8443/g'</span> ~/.kube/config</span><br><span class="line">sed -i <span class="string">'s/172.19.170.185:6443/172.19.170.100:8443/g'</span> /etc/kubernetes/kubelet.conf</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment">################## è‡³æ­¤é›†ç¾¤æ­å»ºå®Œæˆ #####################</span></span><br><span class="line"><span class="comment">######################################################</span></span><br></pre></td></tr></table></figure>
<h2 id="å¼€å¯kubernetes-æ’ä»¶"><a href="#å¼€å¯kubernetes-æ’ä»¶" class="headerlink" title="å¼€å¯kubernetes æ’ä»¶"></a>å¼€å¯kubernetes æ’ä»¶</h2><blockquote>
<p>åœ¨éšæ„ä¸€å°masteræ‰§è¡Œ</p>
</blockquote>
<h3 id="å®‰è£…calico-ç½‘ç»œæ’ä»¶"><a href="#å®‰è£…calico-ç½‘ç»œæ’ä»¶" class="headerlink" title="å®‰è£…calico ç½‘ç»œæ’ä»¶"></a>å®‰è£…calico ç½‘ç»œæ’ä»¶</h3><p>ç¡®ä¿ <code>Kubernetes controller manager (/etc/kubernetes/manifests/kube-controller-manager.yaml)</code> è®¾ç½®äº†ä»¥ä¸‹æ ‡å¿—ï¼š<code>--cluster-cidr=192.168.0.0/16å’Œ--allocate-node-cidrs=true</code>ã€‚</p>
<p>æç¤ºï¼šåœ¨kubeadmä¸Šï¼Œæ‚¨å¯ä»¥ä¼ é€’<code>--pod-network-cidr=192.168.0.0/16</code> ç»™kubeadmä»¥è®¾ç½®ä¸¤ä¸ªKubernetesæ§åˆ¶å™¨æ ‡å¿—ã€‚</p>
<p>åœ¨ConfigMapå‘½åä¸­<code>calico-config</code>ï¼Œæ‰¾åˆ°<code>typha_service_name</code>ï¼Œåˆ é™¤<code>none</code>å€¼ï¼Œå¹¶æ›¿æ¢ä¸º<code>calico-typha</code></p>
<p>æˆ‘ä»¬å»ºè®®æ¯<code>200</code>ä¸ªèŠ‚ç‚¹è‡³å°‘<code>å¤åˆ¶ä¸€ä¸ªå‰¯æœ¬</code>ï¼Œä¸è¶…è¿‡20ä¸ªå‰¯æœ¬ã€‚åœ¨ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬å»ºè®®è‡³å°‘ä½¿ç”¨<code>ä¸‰ä¸ªå‰¯æœ¬</code>æ¥å‡å°‘æ»šåŠ¨å‡çº§å’Œæ•…éšœçš„å½±å“ã€‚</p>
<p><strong><code>è­¦å‘Šï¼šå¦‚æœæ‚¨è®¾ç½®typha_service_nameè€Œä¸å¢åŠ å…¶é»˜è®¤å€¼ä¸º0 Felixçš„å‰¯æœ¬è®¡æ•°å°†å°è¯•è¿æ¥åˆ°Typhaï¼Œæ‰¾ä¸åˆ°è¦è¿æ¥çš„Typhaå®ä¾‹ï¼Œå¹¶ä¸”æ— æ³•å¯åŠ¨ã€‚</code></strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="_">-f</span> www.jiunile.com/k8s/plugin/1.12.3/calico.yaml</span><br></pre></td></tr></table></figure></p>
<h3 id="å®‰è£…heapster-ç›‘æ§æ’ä»¶"><a href="#å®‰è£…heapster-ç›‘æ§æ’ä»¶" class="headerlink" title="å®‰è£…heapster ç›‘æ§æ’ä»¶"></a>å®‰è£…heapster ç›‘æ§æ’ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="_">-f</span> www.jiunile.com/k8s/plugin/1.12.3/heapster.yaml</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…dashboard-æ’ä»¶"><a href="#å®‰è£…dashboard-æ’ä»¶" class="headerlink" title="å®‰è£…dashboard æ’ä»¶"></a>å®‰è£…dashboard æ’ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="_">-f</span> www.jiunile.com/k8s/plugin/1.12.3/dashboard.yaml</span><br></pre></td></tr></table></figure>
<h3 id="è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤"><a href="#è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤" class="headerlink" title="è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤"></a>è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>
<h2 id="åˆå§‹åŒ–æ‰€æœ‰kubernetes-node"><a href="#åˆå§‹åŒ–æ‰€æœ‰kubernetes-node" class="headerlink" title="åˆå§‹åŒ–æ‰€æœ‰kubernetes node"></a>åˆå§‹åŒ–æ‰€æœ‰kubernetes node</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–calicoç½‘ç»œå¯¹åº”éœ€è¦çš„é•œåƒï¼Œæ‹‰å–æ¯”æ•™ç¼“æ…¢</span></span><br><span class="line">docker pull quay.io/calico/typha:v3.3.2</span><br><span class="line">docker pull quay.io/calico/node:v3.3.2</span><br><span class="line">docker pull quay.io/calico/cni:v3.3.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ å…¥é›†ç¾¤</span></span><br><span class="line">kubeadm join 172.19.170.100:8443 --token mrvxeb.mfr1wx6upq5bbwqt --discovery-token-ca-cert-hash sha256:8ee893d8bf69f1f622f55a983f1401a9f2a236ffa9248894cb614c972de47f48</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¯ä»¥åœ¨masteræœºå™¨ä¸ŠæŸ¥çœ‹å¯¹åº”çš„nodeçŠ¶æ€</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">kubectl get pod -n kube-system</span><br></pre></td></tr></table></figure>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><h3 id="æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸"><a href="#æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸" class="headerlink" title="æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸"></a>æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸</h3><blockquote>
<p>åœ¨éšæ„ä¸€å°masteræœºå™¨ä¸Šè¿è¡Œ</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éƒ¨ç½²ä¸€ä¸ªæœåŠ¡</span></span><br><span class="line"><span class="built_in">cd</span> /root &amp;&amp; mkdir nginx &amp;&amp; <span class="built_in">cd</span> nginx</span><br><span class="line">cat &lt;&lt; EOF &gt; nginx.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    nodePort: 31000</span><br><span class="line">    name: nginx-port</span><br><span class="line">    targetPort: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply <span class="_">-f</span> nginx.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªPODæ¥æµ‹è¯•DNSè§£æ</span></span><br><span class="line">kubectl run curl --image=radial/busyboxplus:curl -i --tty</span><br><span class="line">nslookup kubernetes</span><br><span class="line"><span class="comment"># Server:    10.96.0.10</span></span><br><span class="line"><span class="comment"># Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Name:      kubernetes</span></span><br><span class="line"><span class="comment"># Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span></span><br><span class="line">curl nginx</span><br><span class="line"><span class="comment"># æœ‰è¿”å›ç»“æœè¡¨æ˜ok</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">kubectl delete deployment curl</span><br></pre></td></tr></table></figure>
<h3 id="æµ‹è¯•master-amp-Haproxyé«˜å¯ç”¨"><a href="#æµ‹è¯•master-amp-Haproxyé«˜å¯ç”¨" class="headerlink" title="æµ‹è¯•master &amp; Haproxyé«˜å¯ç”¨"></a>æµ‹è¯•master &amp; Haproxyé«˜å¯ç”¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#éšæœºå…³æ‰ä¸€å°masteræœºå™¨</span></span><br><span class="line">init 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨åˆ«çš„masteræœºå™¨ä¸Šæ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">kubectl get node</span><br><span class="line"><span class="comment">#NAME      STATUS     ROLES     AGE       VERSION</span></span><br><span class="line"><span class="comment">#master-1   NotReady   master    1h        v1.12.3</span></span><br><span class="line"><span class="comment">#master-2   Ready      master    59m       v1.12.3</span></span><br><span class="line"><span class="comment">#master-3   Ready      master    59m       v1.12.3</span></span><br><span class="line"><span class="comment">#node-1     Ready      &lt;none&gt;    58m       v1.12.3</span></span><br><span class="line"><span class="comment">#node-2     Ready      &lt;none&gt;    58m       v1.12.3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡æ–°åˆ›å»ºä¸€ä¸ªpodï¼Œçœ‹çœ‹æ˜¯å¦èƒ½åˆ›å»ºæˆåŠŸ</span></span><br><span class="line">kubectl run curl --image=radial/busyboxplus:curl -i --tty</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">kubectl delete deployment curl</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ä½¿ç”¨Kubeadm 1.11.x éƒ¨ç½²å¤šMasteré›†ç¾¤]]></title>
      <url>http://team.jiunile.com/blog/2018/12/k8s-kubeadm-ha-1-11-x.html</url>
      <content type="html"><![CDATA[<h2 id="ç¯å¢ƒä»‹ç»"><a href="#ç¯å¢ƒä»‹ç»" class="headerlink" title="ç¯å¢ƒä»‹ç»"></a>ç¯å¢ƒä»‹ç»</h2><table>
<thead>
<tr>
<th style="text-align:left">IP</th>
<th style="text-align:left">Hostname</th>
<th style="text-align:left">å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">172.19.170.183</td>
<td style="text-align:left">master-1</td>
<td style="text-align:left">ç§æœ‰äº‘å®‰è£…keepalived + haproxy</td>
</tr>
<tr>
<td style="text-align:left">172.19.170.184</td>
<td style="text-align:left">master-2</td>
<td style="text-align:left">ç§æœ‰äº‘å®‰è£…keepalived + haproxy</td>
</tr>
<tr>
<td style="text-align:left">172.19.170.185</td>
<td style="text-align:left">master-3</td>
<td style="text-align:left">ç§æœ‰äº‘å®‰è£…keepalived + haproxy</td>
</tr>
<tr>
<td style="text-align:left">172.19.170.186</td>
<td style="text-align:left">node-1</td>
<td style="text-align:left">æ— </td>
</tr>
<tr>
<td style="text-align:left">172.19.170.187</td>
<td style="text-align:left">node-2</td>
<td style="text-align:left">æ— </td>
</tr>
<tr>
<td style="text-align:left">172.19.170.100</td>
<td style="text-align:left">vip</td>
<td style="text-align:left">ç§æœ‰äº‘ä½¿ç”¨keepalive+haproxyæ­å»ºï¼Œå…¬æœ‰äº‘ä½¿ç”¨å†…éƒ¨è´Ÿè½½å‡è¡¡å™¨</td>
</tr>
</tbody>
</table>
<h2 id="ç¯å¢ƒåˆå§‹åŒ–"><a href="#ç¯å¢ƒåˆå§‹åŒ–" class="headerlink" title="ç¯å¢ƒåˆå§‹åŒ–"></a>ç¯å¢ƒåˆå§‹åŒ–</h2><h3 id="åœ¨master-1-æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"><a href="#åœ¨master-1-æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š" class="headerlink" title="åœ¨master-1 æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"></a>åœ¨master-1 æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id root@master-2</span><br><span class="line">ssh-copy-id root@master-3</span><br></pre></td></tr></table></figure>
<h3 id="ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ"><a href="#ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ" class="headerlink" title="ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ"></a>ä¿®æ”¹hostsä¿¡æ¯ï¼Œåœ¨æ‰€æœ‰masteræœºå™¨ä¸Šè¿è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> &lt;&lt;EOF &gt;&gt; /etc/hosts</span><br><span class="line">172.19.170.183 master-1</span><br><span class="line">172.19.170.184 master-2</span><br><span class="line">172.19.170.185 master-3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="ä¼˜åŒ–æ‰€æœ‰master-amp-node-èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ"><a href="#ä¼˜åŒ–æ‰€æœ‰master-amp-node-èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ" class="headerlink" title="ä¼˜åŒ–æ‰€æœ‰master &amp; node èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ"></a>ä¼˜åŒ–æ‰€æœ‰master &amp; node èŠ‚ç‚¹çš„æœºå™¨ç¯å¢ƒ</h3><blockquote>
<p><code>åœ¨æ‰€æœ‰master &amp; node æœºå™¨ä¸Šéƒ½è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment"># å®‰è£…4.18ç‰ˆæœ¬å†…æ ¸</span></span><br><span class="line"><span class="comment"># ç”±äºæœ€æ–°ç¨³å®šç‰ˆ4.19å†…æ ¸å°†nf_conntrack_ipv4æ›´åä¸ºnf_conntrackï¼Œç›®å‰çš„kube-proxyä¸æ”¯æŒåœ¨4.19ç‰ˆæœ¬å†…æ ¸ä¸‹å¼€å¯ipvs</span></span><br><span class="line"><span class="comment"># è¯¦æƒ…å¯ä»¥æŸ¥çœ‹ï¼šhttps://github.com/kubernetes/kubernetes/issues/70304</span></span><br><span class="line"><span class="comment"># å¯¹äºè¯¥é—®é¢˜çš„ä¿®å¤10æœˆ30æ—¥åˆšåˆšåˆå¹¶åˆ°ä»£ç ä¸»å¹²ï¼Œæ‰€ä»¥ç›®å‰è¿˜æ²¡æœ‰åŒ…å«æ­¤ä¿®å¤çš„kubernetesç‰ˆæœ¬å‘å‡º</span></span><br><span class="line"><span class="comment"># å¯ä»¥é€‰æ‹©å®‰è£…4.18ç‰ˆæœ¬å†…æ ¸ï¼Œæˆ–è€…ä¸å¼€å¯IPVS</span></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment">############################# start #############################</span></span><br><span class="line"><span class="comment"># å‡çº§å†…æ ¸</span></span><br><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm ;yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml -y</span><br><span class="line"> </span><br><span class="line"><span class="comment"># æ£€æŸ¥é»˜è®¤å†…æ ¸ç‰ˆæœ¬æ˜¯å¦å¤§äº4.14ï¼Œå¦åˆ™è¯·è°ƒæ•´é»˜è®¤å¯åŠ¨å‚æ•°</span></span><br><span class="line">grub2-editenv list</span><br><span class="line"> </span><br><span class="line"><span class="comment">#é‡å¯ä»¥æ›´æ¢å†…æ ¸</span></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯ip_vs</span></span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">ipvs_modules_dir=<span class="string">"/usr/lib/modules/\`uname -r\`/kernel/net/netfilter/ipvs"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> \`ls \<span class="variable">$ipvs_modules_dir</span> | sed  -r <span class="string">'s#(.*).ko.*#\1#'</span>\`; <span class="keyword">do</span></span><br><span class="line">    /sbin/modinfo -F filename \<span class="variable">$i</span>  &amp;&gt; /dev/null</span><br><span class="line">    <span class="keyword">if</span> [ \$? <span class="_">-eq</span> 0 ]; <span class="keyword">then</span></span><br><span class="line">        /sbin/modprobe \<span class="variable">$i</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ£€æŸ¥æ˜¯å¦å¼€å¯äº†ip_vs</span></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vs</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# end #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼˜åŒ–å†…æ ¸</span></span><br><span class="line">cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.inotify.max_user_instances = 8192</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">vm.swappiness = 0</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡ŒsysctlæŠ¥é”™è¯·å‚è€ƒcentos7æ·»åŠ bridge-nf-call-ip6tableså‡ºç°No such file or directory: https://blog.csdn.net/airuozhaoyang/article/details/40534953</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼˜åŒ–æ–‡ä»¶æ‰“å¼€æ•°</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* soft nofile 65536"</span> &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* hard nofile 65536"</span> &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* soft nproc 65536"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* hard nproc 65536"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* soft  memlock  unlimited"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"* hard memlock  unlimited"</span>  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­Selinux/firewalld</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­äº¤æ¢åˆ†åŒº</span></span><br><span class="line">swapoff <span class="_">-a</span></span><br><span class="line">yes | cp /etc/fstab /etc/fstab_bak</span><br><span class="line">cat /etc/fstab_bak |grep -v swap &gt; /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒæ­¥æ—¶é—´</span></span><br><span class="line">yum install -y ntpdate</span><br><span class="line">ntpdate -u ntp.api.bz</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®kubernet yumæº</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…kubernet</span></span><br><span class="line">yum install kubeadm-1.11.5-0 kubelet-1.11.5-0 kubectl-1.11.5-0 --disableexcludes=kubernetes -y</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®dockeræº</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/docker.repo &lt;&lt;EOF</span><br><span class="line">[docker]</span><br><span class="line">name=Docker Repository</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/repo/centos7</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.tuna.tsinghua.edu.cn/docker/yum/gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…docker-engine</span></span><br><span class="line">yum -y install docker-engine-1.13.1 --disableexcludes=docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®kubeletå¯åŠ¨é…ç½®</span></span><br><span class="line">cgroupDriver=$(docker info|grep Cg)</span><br><span class="line">driver=<span class="variable">$&#123;cgroupDriver##*: &#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"driver is <span class="variable">$&#123;driver&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_NETWORK_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_DNS_ARGS=--cluster-dns=10.96.0.10 --cluster-domain=cluster.local"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_AUTHZ_ARGS=--authorization-mode=Webhook --client-ca-file=/etc/kubernetes/pki/ca.crt"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CADVISOR_ARGS=--cadvisor-port=0"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CGROUP_ARGS=--cgroup-driver=<span class="variable">$&#123;driver&#125;</span>"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CERTIFICATE_ARGS=--rotate-certificates=true --cert-dir=/var/lib/kubelet/pki"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_EXTRA_ARGS=--system-reserved=cpu=200m,memory=250Mi --kube-reserved=cpu=200m,memory=250Mi --eviction-soft=memory.available&lt;500Mi,nodefs.available&lt;2Gi --eviction-soft-grace-period=memory.available=1m30s,nodefs.available=1m30s --eviction-max-pod-grace-period=120 --eviction-hard=memory.available&lt;300Mi,nodefs.available&lt;1Gi --eviction-minimum-reclaim=memory.available=0Mi,nodefs.available=500Mi,imagefs.available=2Gi --node-status-update-frequency=10s --eviction-pressure-transition-period=30s"</span></span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet \<span class="variable">$KUBELET_KUBECONFIG_ARGS</span> \<span class="variable">$KUBELET_SYSTEM_PODS_ARGS</span> \<span class="variable">$KUBELET_NETWORK_ARGS</span> \<span class="variable">$KUBELET_DNS_ARGS</span> \<span class="variable">$KUBELET_AUTHZ_ARGS</span> \<span class="variable">$KUBELET_CADVISOR_ARGS</span> \<span class="variable">$KUBELET_CGROUP_ARGS</span> \<span class="variable">$KUBELET_CERTIFICATE_ARGS</span> \<span class="variable">$KUBELET_EXTRA_ARGS</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="æ­å»ºkeepalived-haproxy-å…¬æœ‰äº‘ä¸éœ€è¦æ­å»º"><a href="#æ­å»ºkeepalived-haproxy-å…¬æœ‰äº‘ä¸éœ€è¦æ­å»º" class="headerlink" title="æ­å»ºkeepalived + haproxy (å…¬æœ‰äº‘ä¸éœ€è¦æ­å»º)"></a>æ­å»ºkeepalived + haproxy (å…¬æœ‰äº‘ä¸éœ€è¦æ­å»º)</h2><h3 id="åœ¨master-1ä¸Šé…ç½®"><a href="#åœ¨master-1ä¸Šé…ç½®" class="headerlink" title="åœ¨master-1ä¸Šé…ç½®"></a>åœ¨master-1ä¸Šé…ç½®</h3><h4 id="keepalived-å®‰è£…é…ç½®"><a href="#keepalived-å®‰è£…é…ç½®" class="headerlink" title="keepalived å®‰è£…é…ç½®"></a>keepalived å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">    global_defs &#123;</span><br><span class="line">        notification_email &#123;</span><br><span class="line">            root@localhost      <span class="comment">#å‘é€é‚®ç®±</span></span><br><span class="line">        &#125;</span><br><span class="line">        notification_email_from keepalived@localhost    <span class="comment">#é‚®ç®±åœ°å€   </span></span><br><span class="line">        smtp_server 127.0.0.1   <span class="comment">#é‚®ä»¶æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">        smtp_connect_timeout 30 </span><br><span class="line">        router_id node1         <span class="comment">#ä¸»æœºåï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸åŒå³å¯</span></span><br><span class="line">    &#125;       </span><br><span class="line">        </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER        <span class="comment">#åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šä¸ºBACKUP</span></span><br><span class="line">    interface eth0      <span class="comment">#IPåœ°å€æ¼‚ç§»åˆ°çš„ç½‘å¡</span></span><br><span class="line">    virtual_router_id 6 <span class="comment">#å¤šä¸ªèŠ‚ç‚¹å¿…é¡»ç›¸åŒ</span></span><br><span class="line">    priority 100        <span class="comment">#ä¼˜å…ˆçº§ï¼Œå¤‡ç”¨èŠ‚ç‚¹çš„å€¼å¿…é¡»ä½äºä¸»èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">    advert_int 1        <span class="comment">#é€šå‘Šé—´éš”1ç§’</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_<span class="built_in">type</span> PASS      <span class="comment">#é¢„å…±äº«å¯†é’¥è®¤è¯</span></span><br><span class="line">        auth_pass 571f97b2  <span class="comment">#å¯†é’¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.19.170.100    <span class="comment">#VIPåœ°å€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived</span><br><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure>
<h4 id="haproxy-å®‰è£…é…ç½®"><a href="#haproxy-å®‰è£…é…ç½®" class="headerlink" title="haproxy å®‰è£…é…ç½®"></a>haproxy å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">yum install  -y haproxy</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 <span class="built_in">local</span>2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    <span class="built_in">log</span>                     global</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line"></span><br><span class="line">frontend kubernetes</span><br><span class="line">    <span class="built_in">bind</span> *:8443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend kubernetes-master</span><br><span class="line"></span><br><span class="line">backend kubernetes-master</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server master-1 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-2 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-3 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br><span class="line">systemctl start haproxy</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨master-2ä¸Šé…ç½®"><a href="#åœ¨master-2ä¸Šé…ç½®" class="headerlink" title="åœ¨master-2ä¸Šé…ç½®"></a>åœ¨master-2ä¸Šé…ç½®</h3><h4 id="keepalived-å®‰è£…é…ç½®-1"><a href="#keepalived-å®‰è£…é…ç½®-1" class="headerlink" title="keepalived å®‰è£…é…ç½®"></a>keepalived å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">    global_defs &#123;</span><br><span class="line">        notification_email &#123;</span><br><span class="line">            root@localhost      <span class="comment">#å‘é€é‚®ç®±</span></span><br><span class="line">        &#125;</span><br><span class="line">        notification_email_from keepalived@localhost    <span class="comment">#é‚®ç®±åœ°å€   </span></span><br><span class="line">        smtp_server 127.0.0.1   <span class="comment">#é‚®ä»¶æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">        smtp_connect_timeout 30 </span><br><span class="line">        router_id node2         <span class="comment">#ä¸»æœºåï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸åŒå³å¯</span></span><br><span class="line">    &#125;       </span><br><span class="line">        </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP        <span class="comment">#åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šä¸ºBACKUP</span></span><br><span class="line">    interface eth0      <span class="comment">#IPåœ°å€æ¼‚ç§»åˆ°çš„ç½‘å¡</span></span><br><span class="line">    virtual_router_id 6 <span class="comment">#å¤šä¸ªèŠ‚ç‚¹å¿…é¡»ç›¸åŒ</span></span><br><span class="line">    priority 80        <span class="comment">#ä¼˜å…ˆçº§ï¼Œå¤‡ç”¨èŠ‚ç‚¹çš„å€¼å¿…é¡»ä½äºä¸»èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">    advert_int 1        <span class="comment">#é€šå‘Šé—´éš”1ç§’</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_<span class="built_in">type</span> PASS      <span class="comment">#é¢„å…±äº«å¯†é’¥è®¤è¯</span></span><br><span class="line">        auth_pass 571f97b2  <span class="comment">#å¯†é’¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.19.170.100    <span class="comment">#VIPåœ°å€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived</span><br><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure>
<h4 id="haproxy-å®‰è£…é…ç½®-1"><a href="#haproxy-å®‰è£…é…ç½®-1" class="headerlink" title="haproxy å®‰è£…é…ç½®"></a>haproxy å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">yum install  -y haproxy</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 <span class="built_in">local</span>2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    <span class="built_in">log</span>                     global</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line"></span><br><span class="line">frontend kubernetes</span><br><span class="line">    <span class="built_in">bind</span> *:8443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend kubernetes-master</span><br><span class="line"></span><br><span class="line">backend kubernetes-master</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server master-1 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-2 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-3 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br><span class="line">systemctl start haproxy</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨master-3ä¸Šé…ç½®"><a href="#åœ¨master-3ä¸Šé…ç½®" class="headerlink" title="åœ¨master-3ä¸Šé…ç½®"></a>åœ¨master-3ä¸Šé…ç½®</h3><h4 id="keepalived-å®‰è£…é…ç½®-2"><a href="#keepalived-å®‰è£…é…ç½®-2" class="headerlink" title="keepalived å®‰è£…é…ç½®"></a>keepalived å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">    global_defs &#123;</span><br><span class="line">        notification_email &#123;</span><br><span class="line">            root@localhost      <span class="comment">#å‘é€é‚®ç®±</span></span><br><span class="line">        &#125;</span><br><span class="line">        notification_email_from keepalived@localhost    <span class="comment">#é‚®ç®±åœ°å€   </span></span><br><span class="line">        smtp_server 127.0.0.1   <span class="comment">#é‚®ä»¶æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">        smtp_connect_timeout 30 </span><br><span class="line">        router_id node3         <span class="comment">#ä¸»æœºåï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸åŒå³å¯</span></span><br><span class="line">    &#125;       </span><br><span class="line">        </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP        <span class="comment">#åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šä¸ºBACKUP</span></span><br><span class="line">    interface eth0      <span class="comment">#IPåœ°å€æ¼‚ç§»åˆ°çš„ç½‘å¡</span></span><br><span class="line">    virtual_router_id 6 <span class="comment">#å¤šä¸ªèŠ‚ç‚¹å¿…é¡»ç›¸åŒ</span></span><br><span class="line">    priority 80        <span class="comment">#ä¼˜å…ˆçº§ï¼Œå¤‡ç”¨èŠ‚ç‚¹çš„å€¼å¿…é¡»ä½äºä¸»èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">    advert_int 1        <span class="comment">#é€šå‘Šé—´éš”1ç§’</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_<span class="built_in">type</span> PASS      <span class="comment">#é¢„å…±äº«å¯†é’¥è®¤è¯</span></span><br><span class="line">        auth_pass 571f97b2  <span class="comment">#å¯†é’¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.19.170.100    <span class="comment">#VIPåœ°å€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived</span><br><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure>
<h4 id="haproxy-å®‰è£…é…ç½®-2"><a href="#haproxy-å®‰è£…é…ç½®-2" class="headerlink" title="haproxy å®‰è£…é…ç½®"></a>haproxy å®‰è£…é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">yum install  -y haproxy</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 <span class="built_in">local</span>2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    <span class="built_in">log</span>                     global</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line"></span><br><span class="line">frontend kubernetes</span><br><span class="line">    <span class="built_in">bind</span> *:8443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend kubernetes-master</span><br><span class="line"></span><br><span class="line">backend kubernetes-master</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server master-1 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-2 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">    server master-3 172.19.170.183:6443 check maxconn 2000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br><span class="line">systemctl start haproxy</span><br></pre></td></tr></table></figure>
<h2 id="æ­å»ºkubernetes-master-é›†ç¾¤"><a href="#æ­å»ºkubernetes-master-é›†ç¾¤" class="headerlink" title="æ­å»ºkubernetes master é›†ç¾¤"></a>æ­å»ºkubernetes master é›†ç¾¤</h2><h3 id="åˆå§‹åŒ–master-1"><a href="#åˆå§‹åŒ–master-1" class="headerlink" title="åˆå§‹åŒ–master-1"></a>åˆå§‹åŒ–master-1</h3><blockquote>
<p> <code>åœ¨master-1 ä¸Šæ‰§è¡Œ</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; <span class="variable">$HOME</span>/kubeadm-1.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha2</span><br><span class="line">kind: MasterConfiguration</span><br><span class="line">kubernetesVersion: v1.11.5</span><br><span class="line">api:</span><br><span class="line">  advertiseAddress: 172.19.170.183</span><br><span class="line">  <span class="built_in">bind</span>Port: 6443</span><br><span class="line">  controlPlaneEndpoint: 172.19.170.100:8443    </span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- 172.19.170.183</span><br><span class="line">- 172.19.170.184</span><br><span class="line">- 172.19.170.185</span><br><span class="line">- master-1</span><br><span class="line">- master-2</span><br><span class="line">- master-3</span><br><span class="line">- 172.19.170.100</span><br><span class="line">- 127.0.0.1</span><br><span class="line">kubeProxy:</span><br><span class="line">  config:</span><br><span class="line">    mode: iptables</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    extraArgs:</span><br><span class="line">      listen-client-urls: https://127.0.0.1:2379,https://172.19.170.183:2379</span><br><span class="line">      advertise-client-urls: https://172.19.170.183:2379</span><br><span class="line">      listen-peer-urls: https://172.19.170.183:2380</span><br><span class="line">      initial-advertise-peer-urls: https://172.19.170.183:2380</span><br><span class="line">      initial-cluster: master-1=https://172.19.170.183:2380</span><br><span class="line">      initial-cluster-state: new</span><br><span class="line">    serverCertSANs:</span><br><span class="line">      - master-1</span><br><span class="line">      - 172.19.170.183</span><br><span class="line">    peerCertSANs:</span><br><span class="line">      - master-1</span><br><span class="line">      - 172.19.170.183</span><br><span class="line">networking:</span><br><span class="line">  <span class="comment"># This CIDR is a Calico default. Substitute or remove for your CNI provider.</span></span><br><span class="line">  podSubnet: 192.168.0.0/16</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  <span class="comment"># imageçš„ä»“åº“æº  </span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubeadm config images pull --config <span class="variable">$HOME</span>/kubeadm-1.yaml</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line">kubeadm init --config <span class="variable">$HOME</span>/kubeadm-1.yaml</span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">cp <span class="_">-f</span> /etc/kubernetes/admin.conf <span class="variable">$&#123;HOME&#125;</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹etcdæ˜¯å¦å¯åŠ¨ï¼Œç­‰å¾…è¿”å›Running è¯´æ˜å¯åŠ¨æˆåŠŸ</span></span><br><span class="line">kubectl get pods -n kube-system 2&gt;&amp;1|grep etcd|awk <span class="string">'&#123;print $3&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å…¶ä»–master</span></span><br><span class="line">ssh master-2 <span class="string">"mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube"</span></span><br><span class="line">ssh master-3 <span class="string">"mkdir -p /etc/kubernetes/pki/etcd; mkdir -p ~/.kube"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´æ–‡ä»¶è‡³ master-2</span></span><br><span class="line">scp /etc/kubernetes/pki/ca.crt master-2:/etc/kubernetes/pki/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/ca.key master-2:/etc/kubernetes/pki/ca.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.key master-2:/etc/kubernetes/pki/sa.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.pub master-2:/etc/kubernetes/pki/sa.pub</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.crt master-2:/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.key master-2:/etc/kubernetes/pki/front-proxy-ca.key</span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.crt master-2:/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.key master-2:/etc/kubernetes/pki/etcd/ca.key</span><br><span class="line">scp /etc/kubernetes/admin.conf master-2:/etc/kubernetes/admin.conf</span><br><span class="line">scp /etc/kubernetes/admin.conf master-2:~/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‹·è´æ–‡ä»¶è‡³ master-3</span></span><br><span class="line">scp /etc/kubernetes/pki/ca.crt master-3:/etc/kubernetes/pki/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/ca.key master-3:/etc/kubernetes/pki/ca.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.key master-3:/etc/kubernetes/pki/sa.key</span><br><span class="line">scp /etc/kubernetes/pki/sa.pub master-3:/etc/kubernetes/pki/sa.pub</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.crt master-3:/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.key master-3:/etc/kubernetes/pki/front-proxy-ca.key</span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.crt master-3:/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.key master-3:/etc/kubernetes/pki/etcd/ca.key</span><br><span class="line">scp /etc/kubernetes/admin.conf master-3:/etc/kubernetes/admin.conf</span><br><span class="line">scp /etc/kubernetes/admin.conf master-3:~/.kube/config</span><br></pre></td></tr></table></figure>
<h3 id="åˆå§‹åŒ–master-2"><a href="#åˆå§‹åŒ–master-2" class="headerlink" title="åˆå§‹åŒ–master-2"></a>åˆå§‹åŒ–master-2</h3><blockquote>
<p> <code>åœ¨master-2 ä¸Šæ‰§è¡Œ</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha2</span><br><span class="line">kind: MasterConfiguration</span><br><span class="line">kubernetesVersion: v1.11.5</span><br><span class="line">api:</span><br><span class="line">  advertiseAddress: 172.19.170.184</span><br><span class="line">  <span class="built_in">bind</span>Port: 6443</span><br><span class="line">  controlPlaneEndpoint: 172.19.170.100:8443 </span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- 172.19.170.183</span><br><span class="line">- 172.19.170.184</span><br><span class="line">- 172.19.170.185</span><br><span class="line">- master-1</span><br><span class="line">- master-2</span><br><span class="line">- master-3</span><br><span class="line">- 172.19.170.100</span><br><span class="line">- 127.0.0.1</span><br><span class="line">kubeProxy:</span><br><span class="line">  config:</span><br><span class="line">    mode: iptables</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    extraArgs:</span><br><span class="line">      listen-client-urls: https://127.0.0.1:2379,https://172.19.170.184:2379</span><br><span class="line">      advertise-client-urls: https://172.19.170.184:2379</span><br><span class="line">      listen-peer-urls: https://172.19.170.184:2380</span><br><span class="line">      initial-advertise-peer-urls: https://172.19.170.184:2380</span><br><span class="line">      initial-cluster: master-1=https://172.19.170.183:2380,master-2=https://172.19.170.184:2380</span><br><span class="line">      initial-cluster-state: existing</span><br><span class="line">    serverCertSANs:</span><br><span class="line">      - master-2</span><br><span class="line">      - 172.19.170.184</span><br><span class="line">    peerCertSANs:</span><br><span class="line">      - master-2</span><br><span class="line">      - 172.19.170.184</span><br><span class="line">networking:</span><br><span class="line">  <span class="comment"># This CIDR is a Calico default. Substitute or remove for your CNI provider.</span></span><br><span class="line">  podSubnet: 192.168.0.0/16</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  <span class="comment"># imageçš„ä»“åº“æº  </span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment">################## åˆ‡æ¢è‡³master-1æ‰§è¡Œ ##################</span></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line">kubectl <span class="built_in">exec</span> \</span><br><span class="line">-n kube-system etcd-master-1 -- etcdctl \</span><br><span class="line">--ca-file /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert-file /etc/kubernetes/pki/etcd/peer.crt \</span><br><span class="line">--key-file /etc/kubernetes/pki/etcd/peer.key \</span><br><span class="line">--endpoints=https://172.19.170.183:2379 \</span><br><span class="line">member add master-2 https://172.19.170.184:2380</span><br><span class="line"><span class="comment"># åœ¨master-1 æ‰§è¡Œåä¼šå¡åœ¨é‚£è¾¹ï¼Œç­‰å¾…å…¶ä»–çš„etcdèŠ‚ç‚¹åŠ å…¥</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment">################## åˆ‡æ¢è‡³master-2æ‰§è¡Œ ##################</span></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line">kubeadm alpha phase certs all --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig controller-manager --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig scheduler --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubelet config write-to-disk --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubelet write-env-file --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig kubelet --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">kubeadm alpha phase etcd <span class="built_in">local</span> --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig all --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase controlplane all --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br><span class="line">kubeadm alpha phase mark-master --config <span class="variable">$HOME</span>/kubeadm-2.yaml</span><br></pre></td></tr></table></figure>
<h3 id="åˆå§‹åŒ–master-3"><a href="#åˆå§‹åŒ–master-3" class="headerlink" title="åˆå§‹åŒ–master-3"></a>åˆå§‹åŒ–master-3</h3><blockquote>
<p> <code>åœ¨master-3 ä¸Šæ‰§è¡Œ</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha2</span><br><span class="line">kind: MasterConfiguration</span><br><span class="line">kubernetesVersion: v1.11.5</span><br><span class="line">api:</span><br><span class="line">  advertiseAddress: 172.19.170.185</span><br><span class="line">  <span class="built_in">bind</span>Port: 6443</span><br><span class="line">  controlPlaneEndpoint: 172.19.170.100:8443    </span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- 172.19.170.183</span><br><span class="line">- 172.19.170.184</span><br><span class="line">- 172.19.170.185</span><br><span class="line">- master-1</span><br><span class="line">- master-2</span><br><span class="line">- master-3</span><br><span class="line">- 172.19.170.100</span><br><span class="line">- 127.0.0.1</span><br><span class="line">kubeProxy:</span><br><span class="line">  config:</span><br><span class="line">    mode: iptables</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    extraArgs:</span><br><span class="line">      listen-client-urls: https://127.0.0.1:2379,https://172.19.170.185:2379</span><br><span class="line">      advertise-client-urls: https://172.19.170.185:2379</span><br><span class="line">      listen-peer-urls: https://172.19.170.185:2380</span><br><span class="line">      initial-advertise-peer-urls: https://172.19.170.185:2380</span><br><span class="line">      initial-cluster: master-1=https://172.19.170.183:2380,master-2=https://172.19.170.184:2380,master-3=https://172.19.170.185:2380</span><br><span class="line">      initial-cluster-state: existing</span><br><span class="line">    serverCertSANs:</span><br><span class="line">      - master-3</span><br><span class="line">      - 172.19.170.185</span><br><span class="line">    peerCertSANs:</span><br><span class="line">      - master-3</span><br><span class="line">      - 172.19.170.185</span><br><span class="line">networking:</span><br><span class="line">  <span class="comment"># This CIDR is a Calico default. Substitute or remove for your CNI provider.</span></span><br><span class="line">  podSubnet: 192.168.0.0/16</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  <span class="comment"># imageçš„ä»“åº“æº  </span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment">################## åˆ‡æ¢è‡³master-1æ‰§è¡Œ ##################</span></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line">kubectl <span class="built_in">exec</span> \</span><br><span class="line">-n kube-system etcd-master-1 -- etcdctl \</span><br><span class="line">--ca-file /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">--cert-file /etc/kubernetes/pki/etcd/peer.crt \</span><br><span class="line">--key-file /etc/kubernetes/pki/etcd/peer.key \</span><br><span class="line">--endpoints=https://172.19.170.183:2379 \</span><br><span class="line">member add master-3 https://172.19.170.185:2380</span><br><span class="line"><span class="comment"># åœ¨master-1 æ‰§è¡Œåä¼šå¡åœ¨é‚£è¾¹ï¼Œç­‰å¾…å…¶ä»–çš„etcdèŠ‚ç‚¹åŠ å…¥</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment">################## åˆ‡æ¢è‡³master-3æ‰§è¡Œ ##################</span></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line">kubeadm alpha phase certs all --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig controller-manager --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig scheduler --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubelet config write-to-disk --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubelet write-env-file --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig kubelet --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">kubeadm alpha phase etcd <span class="built_in">local</span> --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig all --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase controlplane all --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br><span class="line">kubeadm alpha phase mark-master --config <span class="variable">$HOME</span>/kubeadm-3.yaml</span><br></pre></td></tr></table></figure>
<h3 id="è°ƒæ•´é…ç½®ï¼Œä½¿ç”¨vipæ¥è¿›è¡Œè°ƒåº¦"><a href="#è°ƒæ•´é…ç½®ï¼Œä½¿ç”¨vipæ¥è¿›è¡Œè°ƒåº¦" class="headerlink" title="è°ƒæ•´é…ç½®ï¼Œä½¿ç”¨vipæ¥è¿›è¡Œè°ƒåº¦"></a>è°ƒæ•´é…ç½®ï¼Œä½¿ç”¨vipæ¥è¿›è¡Œè°ƒåº¦</h3><blockquote>
<p>åœ¨æ‰€æœ‰masteræœºå™¨ä¸Šéƒ½æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨master-1 ä¸Šæ‰§è¡Œ</span></span><br><span class="line">sed -i <span class="string">'s/etcd-servers=https:\/\/127.0.0.1:2379/etcd-servers=https:\/\/172.19.170.183:2379,https:\/\/172.19.170.184:2379,https:\/\/172.19.170.185:2379/g'</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">sed -i <span class="string">'s/172.19.170.183:6443/172.19.170.100:8443/g'</span> ~/.kube/config</span><br><span class="line">sed -i <span class="string">'s/172.19.170.183:6443/172.19.170.100:8443/g'</span> /etc/kubernetes/kubelet.conf</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨master-2 ä¸Šæ‰§è¡Œ</span></span><br><span class="line">sed -i <span class="string">'s/etcd-servers=https:\/\/127.0.0.1:2379/etcd-servers=https:\/\/172.19.170.183:2379,https:\/\/172.19.170.184:2379,https:\/\/172.19.170.185:2379/g'</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">sed -i <span class="string">'s/172.19.170.184:6443/172.19.170.100:8443/g'</span> ~/.kube/config</span><br><span class="line">sed -i <span class="string">'s/172.19.170.184:6443/172.19.170.100:8443/g'</span> /etc/kubernetes/kubelet.conf</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨master-3 ä¸Šæ‰§è¡Œ</span></span><br><span class="line">sed -i <span class="string">'s/etcd-servers=https:\/\/127.0.0.1:2379/etcd-servers=https:\/\/172.19.170.183:2379,https:\/\/172.19.170.184:2379,https:\/\/172.19.170.185:2379/g'</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">sed -i <span class="string">'s/172.19.170.185:6443/172.19.170.100:8443/g'</span> ~/.kube/config</span><br><span class="line">sed -i <span class="string">'s/172.19.170.185:6443/172.19.170.100:8443/g'</span> /etc/kubernetes/kubelet.conf</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment">################## è‡³æ­¤é›†ç¾¤æ­å»ºå®Œæˆ #####################</span></span><br><span class="line"><span class="comment">######################################################</span></span><br></pre></td></tr></table></figure>
<h2 id="å¼€å¯kubernetes-æ’ä»¶"><a href="#å¼€å¯kubernetes-æ’ä»¶" class="headerlink" title="å¼€å¯kubernetes æ’ä»¶"></a>å¼€å¯kubernetes æ’ä»¶</h2><blockquote>
<p>åœ¨éšæ„ä¸€å°masteræ‰§è¡Œ</p>
</blockquote>
<h3 id="å®‰è£…calico-ç½‘ç»œæ’ä»¶"><a href="#å®‰è£…calico-ç½‘ç»œæ’ä»¶" class="headerlink" title="å®‰è£…calico ç½‘ç»œæ’ä»¶"></a>å®‰è£…calico ç½‘ç»œæ’ä»¶</h3><p>ç¡®ä¿ <code>Kubernetes controller manager (/etc/kubernetes/manifests/kube-controller-manager.yaml)</code> è®¾ç½®äº†ä»¥ä¸‹æ ‡å¿—ï¼š<code>--cluster-cidr=192.168.0.0/16å’Œ--allocate-node-cidrs=true</code>ã€‚</p>
<p>æç¤ºï¼šåœ¨kubeadmä¸Šï¼Œæ‚¨å¯ä»¥ä¼ é€’<code>--pod-network-cidr=192.168.0.0/16</code> ç»™kubeadmä»¥è®¾ç½®ä¸¤ä¸ªKubernetesæ§åˆ¶å™¨æ ‡å¿—ã€‚</p>
<p>åœ¨ConfigMapå‘½åä¸­<code>calico-config</code>ï¼Œæ‰¾åˆ°<code>typha_service_name</code>ï¼Œåˆ é™¤<code>none</code>å€¼ï¼Œå¹¶æ›¿æ¢ä¸º<code>calico-typha</code></p>
<p>æˆ‘ä»¬å»ºè®®æ¯<code>200</code>ä¸ªèŠ‚ç‚¹è‡³å°‘<code>å¤åˆ¶ä¸€ä¸ªå‰¯æœ¬</code>ï¼Œä¸è¶…è¿‡20ä¸ªå‰¯æœ¬ã€‚åœ¨ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬å»ºè®®è‡³å°‘ä½¿ç”¨<code>ä¸‰ä¸ªå‰¯æœ¬</code>æ¥å‡å°‘æ»šåŠ¨å‡çº§å’Œæ•…éšœçš„å½±å“ã€‚</p>
<p><strong><code>è­¦å‘Šï¼šå¦‚æœæ‚¨è®¾ç½®typha_service_nameè€Œä¸å¢åŠ å…¶é»˜è®¤å€¼ä¸º0 Felixçš„å‰¯æœ¬è®¡æ•°å°†å°è¯•è¿æ¥åˆ°Typhaï¼Œæ‰¾ä¸åˆ°è¦è¿æ¥çš„Typhaå®ä¾‹ï¼Œå¹¶ä¸”æ— æ³•å¯åŠ¨ã€‚</code></strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="_">-f</span> www.jiunile.com/k8s/plugin/1.11.5/calico.yaml</span><br></pre></td></tr></table></figure></p>
<h3 id="å®‰è£…heapster-ç›‘æ§æ’ä»¶"><a href="#å®‰è£…heapster-ç›‘æ§æ’ä»¶" class="headerlink" title="å®‰è£…heapster ç›‘æ§æ’ä»¶"></a>å®‰è£…heapster ç›‘æ§æ’ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="_">-f</span> www.jiunile.com/k8s/plugin/1.11.5/heapster.yaml</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…dashboard-æ’ä»¶"><a href="#å®‰è£…dashboard-æ’ä»¶" class="headerlink" title="å®‰è£…dashboard æ’ä»¶"></a>å®‰è£…dashboard æ’ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="_">-f</span> www.jiunile.com/k8s/plugin/1.11.5/dashboard.yaml</span><br></pre></td></tr></table></figure>
<h3 id="è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤"><a href="#è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤" class="headerlink" title="è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤"></a>è·å–åŠ å…¥masteré›†ç¾¤å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>
<h2 id="åˆå§‹åŒ–æ‰€æœ‰kubernetes-node"><a href="#åˆå§‹åŒ–æ‰€æœ‰kubernetes-node" class="headerlink" title="åˆå§‹åŒ–æ‰€æœ‰kubernetes node"></a>åˆå§‹åŒ–æ‰€æœ‰kubernetes node</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–calicoç½‘ç»œå¯¹åº”éœ€è¦çš„é•œåƒï¼Œæ‹‰å–æ¯”æ•™ç¼“æ…¢</span></span><br><span class="line">docker pull quay.io/calico/typha:v3.2.4</span><br><span class="line">docker pull quay.io/calico/node:v3.2.4</span><br><span class="line">docker pull quay.io/calico/cni:v3.2.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ å…¥é›†ç¾¤</span></span><br><span class="line">kubeadm join 172.19.170.100:8443 --token mrvxeb.mfr1wx6upq5bbwqt --discovery-token-ca-cert-hash sha256:8ee893d8bf69f1f622f55a983f1401a9f2a236ffa9248894cb614c972de47f48</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¯ä»¥åœ¨masteræœºå™¨ä¸ŠæŸ¥çœ‹å¯¹åº”çš„nodeçŠ¶æ€</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">kubectl get pod -n kube-system</span><br></pre></td></tr></table></figure>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><h3 id="æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸"><a href="#æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸" class="headerlink" title="æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸"></a>æµ‹è¯•åº”ç”¨å’Œdnsæ˜¯å¦æ­£å¸¸</h3><blockquote>
<p>åœ¨éšæ„ä¸€å°masteræœºå™¨ä¸Šè¿è¡Œ</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éƒ¨ç½²ä¸€ä¸ªæœåŠ¡</span></span><br><span class="line"><span class="built_in">cd</span> /root &amp;&amp; mkdir nginx &amp;&amp; <span class="built_in">cd</span> nginx</span><br><span class="line">cat &lt;&lt; EOF &gt; nginx.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    nodePort: 31000</span><br><span class="line">    name: nginx-port</span><br><span class="line">    targetPort: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply <span class="_">-f</span> nginx.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªPODæ¥æµ‹è¯•DNSè§£æ</span></span><br><span class="line">kubectl run curl --image=radial/busyboxplus:curl -i --tty</span><br><span class="line">nslookup kubernetes</span><br><span class="line"><span class="comment"># Server:    10.96.0.10</span></span><br><span class="line"><span class="comment"># Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Name:      kubernetes</span></span><br><span class="line"><span class="comment"># Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span></span><br><span class="line">curl nginx</span><br><span class="line"><span class="comment"># æœ‰è¿”å›ç»“æœè¡¨æ˜ok</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">kubectl delete deployment curl</span><br></pre></td></tr></table></figure>
<h3 id="æµ‹è¯•master-amp-Haproxyé«˜å¯ç”¨"><a href="#æµ‹è¯•master-amp-Haproxyé«˜å¯ç”¨" class="headerlink" title="æµ‹è¯•master &amp; Haproxyé«˜å¯ç”¨"></a>æµ‹è¯•master &amp; Haproxyé«˜å¯ç”¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#éšæœºå…³æ‰ä¸€å°masteræœºå™¨</span></span><br><span class="line">init 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨åˆ«çš„masteræœºå™¨ä¸Šæ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">kubectl get node</span><br><span class="line"><span class="comment">#NAME      STATUS     ROLES     AGE       VERSION</span></span><br><span class="line"><span class="comment">#master-1   NotReady   master    1h        v1.11.5</span></span><br><span class="line"><span class="comment">#master-2   Ready      master    59m       v1.11.5</span></span><br><span class="line"><span class="comment">#master-3   Ready      master    59m       v1.11.5</span></span><br><span class="line"><span class="comment">#node-1     Ready      &lt;none&gt;    58m       v1.11.5</span></span><br><span class="line"><span class="comment">#node-2     Ready      &lt;none&gt;    58m       v1.11.5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#é‡æ–°åˆ›å»ºä¸€ä¸ªpodï¼Œçœ‹çœ‹æ˜¯å¦èƒ½åˆ›å»ºæˆåŠŸ</span></span><br><span class="line">kubectl run curl --image=radial/busyboxplus:curl -i --tty</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">kubectl delete deployment curl</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è®¤è¯†Kubernetes Descheduler]]></title>
      <url>http://team.jiunile.com/blog/2018/12/k8s-descheduler.html</url>
      <content type="html"><![CDATA[<p><code>kube-scheduler</code> æ˜¯ Kubernetes ä¸­è´Ÿè´£è°ƒåº¦çš„ç»„ä»¶ï¼Œå®ƒæœ¬èº«çš„è°ƒåº¦åŠŸèƒ½å·²ç»å¾ˆå¼ºå¤§äº†ã€‚ä½†ç”±äº Kubernetes é›†ç¾¤éå¸¸æ´»è·ƒï¼Œå®ƒçš„çŠ¶æ€ä¼šéšæ—¶é—´è€Œæ”¹å˜ï¼Œç”±äºå„ç§åŸå› ï¼Œä½ å¯èƒ½éœ€è¦å°†å·²ç»è¿è¡Œçš„ Pod ç§»åŠ¨åˆ°å…¶ä»–èŠ‚ç‚¹ï¼š</p>
<ul>
<li>æŸäº›èŠ‚ç‚¹è´Ÿè½½è¿‡é«˜</li>
<li>æŸäº›èµ„æºå¯¹è±¡è¢«æ·»åŠ äº† <a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#node-affinity-beta-feature" target="_blank" rel="external">node äº²å’Œæ€§</a> æˆ– <a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#inter-pod-affinity-and-anti-affinity-beta-feature" target="_blank" rel="external">pod ï¼ˆåï¼‰äº²å’Œæ€§</a></li>
<li>é›†ç¾¤ä¸­åŠ å…¥äº†æ–°èŠ‚ç‚¹</li>
</ul>
<p>ä¸€æ—¦ Pod å¯åŠ¨ä¹‹å <code>kube-scheduler</code> ä¾¿ä¸ä¼šå†å°è¯•é‡æ–°è°ƒåº¦å®ƒã€‚æ ¹æ®ç¯å¢ƒçš„ä¸åŒï¼Œä½ å¯èƒ½ä¼šæœ‰å¾ˆå¤šéœ€è¦æ‰‹åŠ¨è°ƒæ•´ Pod çš„åˆ†å¸ƒï¼Œä¾‹å¦‚ï¼šå¦‚æœé›†ç¾¤ä¸­æ–°åŠ å…¥äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆå·²ç»è¿è¡Œçš„ Pod å¹¶ä¸ä¼šè¢«åˆ†æ‘Šåˆ°è¿™å°èŠ‚ç‚¹ä¸Šï¼Œè¿™å°èŠ‚ç‚¹å¯èƒ½åªè¿è¡Œäº†å°‘é‡çš„å‡ ä¸ª Podï¼Œè¿™å¹¶ä¸ç†æƒ³ï¼Œå¯¹å§ï¼Ÿ</p>
<h3 id="Descheduler-å¦‚ä½•å·¥ä½œï¼Ÿ"><a href="#Descheduler-å¦‚ä½•å·¥ä½œï¼Ÿ" class="headerlink" title="Descheduler å¦‚ä½•å·¥ä½œï¼Ÿ"></a>Descheduler å¦‚ä½•å·¥ä½œï¼Ÿ</h3><p><a href="https://github.com/kubernetes-incubator/descheduler" target="_blank" rel="external">Descheduler</a> ä¼šæ£€æŸ¥ Pod çš„çŠ¶æ€ï¼Œå¹¶æ ¹æ®è‡ªå®šä¹‰çš„ç­–ç•¥å°†ä¸æ»¡è¶³è¦æ±‚çš„ Pod ä»è¯¥èŠ‚ç‚¹ä¸Šé©±é€å‡ºå»ã€‚Descheduler å¹¶ä¸æ˜¯ <code>kube-scheduler</code> çš„æ›¿ä»£å“ï¼Œè€Œæ˜¯è¦ä¾èµ–äºå®ƒã€‚è¯¥é¡¹ç›®ç›®å‰æ”¾åœ¨ Kubernetes çš„å­µåŒ–é¡¹ç›®ä¸­ï¼Œè¿˜æ²¡å‡†å¤‡æŠ•å…¥ç”Ÿäº§ï¼Œä½†ç»è¿‡æˆ‘å®éªŒå‘ç°å®ƒçš„è¿è¡Œæ•ˆæœå¾ˆå¥½ï¼Œè€Œä¸”éå¸¸ç¨³å®šã€‚é‚£ä¹ˆè¯¥å¦‚ä½•å®‰è£…å‘¢ï¼Ÿ<br><a id="more"></a></p>
<h3 id="éƒ¨ç½²æ–¹æ³•"><a href="#éƒ¨ç½²æ–¹æ³•" class="headerlink" title="éƒ¨ç½²æ–¹æ³•"></a>éƒ¨ç½²æ–¹æ³•</h3><p>ä½ å¯ä»¥é€šè¿‡ <code>Job</code> æˆ– <code>CronJob</code> æ¥è¿è¡Œ deschedulerã€‚æˆ‘å·²ç»åˆ›å»ºäº†ä¸€ä¸ªé•œåƒ <code>komljen/descheduler:v0.5.0-4-ga7ceb671</code>ï¼ˆåŒ…å«åœ¨ä¸‹é¢çš„ yaml æ–‡ä»¶ä¸­ï¼‰ï¼Œä½†ç”±äºè¿™ä¸ªé¡¹ç›®çš„æ›´æ–°é€Ÿåº¦å¾ˆå¿«ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹çš„å‘½ä»¤åˆ›å»ºä½ è‡ªå·±çš„é•œåƒï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âš¡ git <span class="built_in">clone</span> https://github.com/kubernetes-incubator/descheduler</span><br><span class="line">âš¡ <span class="built_in">cd</span> descheduler &amp;&amp; make image</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åæ‰“å¥½æ ‡ç­¾ push åˆ°è‡ªå·±çš„é•œåƒä»“åº“ä¸­ã€‚</p>
<p>é€šè¿‡æˆ‘åˆ›å»ºçš„ chart æ¨¡æ¿ï¼Œä½ å¯ä»¥ç”¨ <code>Helm</code> æ¥éƒ¨ç½² deschedulerï¼Œè¯¥æ¨¡æ¿æ”¯æŒ RBAC å¹¶ä¸”å·²ç»åœ¨ Kubernetes v1.9 ä¸Šæµ‹è¯•é€šè¿‡ã€‚</p>
<p>æ·»åŠ æˆ‘çš„ helm ç§æœ‰ä»“åº“ï¼Œç„¶åéƒ¨ç½² deschedulerï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">âš¡ helm repo add akomljen-charts \</span><br><span class="line">    https://raw.githubusercontent.com/komljen/helm-charts/master/charts/</span><br><span class="line"></span><br><span class="line">âš¡ helm install --name ds \</span><br><span class="line">    --namespace kube-system \</span><br><span class="line">    akomljen-charts/descheduler</span><br></pre></td></tr></table></figure></p>
<p>ä½ ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ helmï¼Œé€šè¿‡æ‰‹åŠ¨éƒ¨ç½²ã€‚é¦–å…ˆåˆ›å»º serviceaccount å’Œ clusterrolebindingï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create a cluster role</span></span><br><span class="line">âš¡ cat &lt;&lt; EOF| kubectl create -n kube-system <span class="_">-f</span> -</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: descheduler</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [<span class="string">""</span>]</span><br><span class="line">  resources: [<span class="string">"nodes"</span>]</span><br><span class="line">  verbs: [<span class="string">"get"</span>, <span class="string">"watch"</span>, <span class="string">"list"</span>]</span><br><span class="line">- apiGroups: [<span class="string">""</span>]</span><br><span class="line">  resources: [<span class="string">"pods"</span>]</span><br><span class="line">  verbs: [<span class="string">"get"</span>, <span class="string">"watch"</span>, <span class="string">"list"</span>, <span class="string">"delete"</span>]</span><br><span class="line">- apiGroups: [<span class="string">""</span>]</span><br><span class="line">  resources: [<span class="string">"pods/eviction"</span>]</span><br><span class="line">  verbs: [<span class="string">"create"</span>]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a service account</span></span><br><span class="line">âš¡ kubectl create sa descheduler -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the cluster role to the service account</span></span><br><span class="line">âš¡ kubectl create clusterrolebinding descheduler \</span><br><span class="line">    -n kube-system \</span><br><span class="line">    --clusterrole=descheduler \</span><br><span class="line">    --serviceaccount=kube-system:descheduler</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åé€šè¿‡ <code>configmap</code> åˆ›å»º descheduler ç­–ç•¥ã€‚ç›®å‰åªæ”¯æŒå››ç§ç­–ç•¥ï¼š</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/descheduler#removeduplicates" target="_blank" rel="external">RemoveDuplicates</a><br>RSã€deployment ä¸­çš„ pod ä¸èƒ½åŒæ—¶å‡ºç°åœ¨ä¸€å°æœºå™¨ä¸Š</li>
<li><a href="https://github.com/kubernetes-incubator/descheduler#lownodeutilization" target="_blank" rel="external">LowNodeUtilization</a><br>æ‰¾åˆ°èµ„æºä½¿ç”¨ç‡æ¯”è¾ƒä½çš„ nodeï¼Œç„¶åé©±é€å…¶ä»–èµ„æºä½¿ç”¨ç‡æ¯”è¾ƒé«˜èŠ‚ç‚¹ä¸Šçš„ podï¼ŒæœŸæœ›è°ƒåº¦å™¨èƒ½å¤Ÿé‡æ–°è°ƒåº¦è®©èµ„æºæ›´å‡è¡¡</li>
<li><a href="https://github.com/kubernetes-incubator/descheduler#removepodsviolatinginterpodantiaffinity" target="_blank" rel="external">RemovePodsViolatingInterPodAntiAffinity</a><br>æ‰¾åˆ°å·²ç»è¿å Pod Anti Affinity è§„åˆ™çš„ pods è¿›è¡Œé©±é€ï¼Œå¯èƒ½æ˜¯å› ä¸ºåäº²å’Œæ˜¯åé¢åŠ ä¸Šå»çš„</li>
<li><a href="https://github.com/kubernetes-incubator/descheduler#removepodsviolatingnodeaffinity" target="_blank" rel="external">RemovePodsViolatingNodeAffinity</a><br>æ‰¾åˆ°è¿å Node Affinity è§„åˆ™çš„ pods è¿›è¡Œé©±é€ï¼Œå¯èƒ½æ˜¯å› ä¸º node åé¢ä¿®æ”¹äº† label</li>
</ul>
<p>é»˜è®¤è¿™å››ç§ç­–ç•¥å…¨éƒ¨å¼€å¯ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦å…³é—­å®ƒä»¬ã€‚ä¸‹é¢åœ¨ <code>kube-system</code> å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ª configmapï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">âš¡ cat &lt;&lt; EOF| kubectl create -n kube-system <span class="_">-f</span> -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: descheduler</span><br><span class="line">data:</span><br><span class="line">  policy.yaml: |-  </span><br><span class="line">    apiVersion: descheduler/v1alpha1</span><br><span class="line">    kind: DeschedulerPolicy</span><br><span class="line">    strategies:</span><br><span class="line">      RemoveDuplicates:</span><br><span class="line">         enabled: <span class="literal">false</span></span><br><span class="line">      LowNodeUtilization:</span><br><span class="line">         enabled: <span class="literal">true</span></span><br><span class="line">         params:</span><br><span class="line">           nodeResourceUtilizationThresholds:</span><br><span class="line">             thresholds:</span><br><span class="line">               cpu: 20</span><br><span class="line">               memory: 20</span><br><span class="line">               pods: 20</span><br><span class="line">             targetThresholds:</span><br><span class="line">               cpu: 50</span><br><span class="line">               memory: 50</span><br><span class="line">               pods: 50</span><br><span class="line">      RemovePodsViolatingInterPodAntiAffinity:</span><br><span class="line">        enabled: <span class="literal">true</span></span><br><span class="line">      RemovePodsViolatingNodeAffinity:</span><br><span class="line">        enabled: <span class="literal">true</span></span><br><span class="line">        params:</span><br><span class="line">          nodeAffinityType:</span><br><span class="line">          - requiredDuringSchedulingIgnoredDuringExecution</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>åœ¨ <code>kube-system</code> å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ª CronJobï¼Œè¯¥ CroJob æ¯ 30 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">âš¡ cat &lt;&lt; EOF| kubectl create -n kube-system <span class="_">-f</span> -</span><br><span class="line">apiVersion: batch/v1beta1</span><br><span class="line">kind: CronJob</span><br><span class="line">metadata:</span><br><span class="line">  name: descheduler</span><br><span class="line">spec:</span><br><span class="line">  schedule: <span class="string">"*/30 * * * *"</span></span><br><span class="line">  jobTemplate:</span><br><span class="line">    metadata:</span><br><span class="line">      name: descheduler</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">"true"</span></span><br><span class="line">    spec:</span><br><span class="line">      template:</span><br><span class="line">        spec:</span><br><span class="line">          serviceAccountName: descheduler</span><br><span class="line">          containers:</span><br><span class="line">          - name: descheduler</span><br><span class="line">            image: komljen/descheduler:v0.6.0</span><br><span class="line">            volumeMounts:</span><br><span class="line">            - mountPath: /policy-dir</span><br><span class="line">              name: policy-volume</span><br><span class="line">            <span class="built_in">command</span>:</span><br><span class="line">            - /bin/descheduler</span><br><span class="line">            - --v=4</span><br><span class="line">            - --max-pods-to-evict-per-node=10</span><br><span class="line">            - --policy-config-file=/policy-dir/policy.yaml</span><br><span class="line">          restartPolicy: <span class="string">"OnFailure"</span></span><br><span class="line">          volumes:</span><br><span class="line">          - name: policy-volume</span><br><span class="line">            configMap:</span><br><span class="line">              name: descheduler</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">âš¡ kubectl get cronjobs -n kube-system</span><br><span class="line">NAME             SCHEDULE       SUSPEND   ACTIVE    LAST SCHEDULE   AGE</span><br><span class="line">descheduler      */30 * * * *   False     0         2m              32m</span><br></pre></td></tr></table></figure></p>
<p>å½“ CronJob å¼€å§‹å·¥ä½œåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å·²ç»æˆåŠŸç»“æŸçš„ Podï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">âš¡ kubectl get pods -n kube-system <span class="_">-a</span> | grep Completed</span><br><span class="line">descheduler-1525520700-297pq          0/1       Completed   0          1h</span><br><span class="line">descheduler-1525521000-tz2ch          0/1       Completed   0          32m</span><br><span class="line">descheduler-1525521300-mrw4t          0/1       Completed   0          2m</span><br></pre></td></tr></table></figure></p>
<p>ä¹Ÿå¯ä»¥æŸ¥çœ‹è¿™äº› Pod çš„æ—¥å¿—ï¼Œç„¶åæ ¹æ®éœ€è¦è°ƒæ•´ descheduler ç­–ç•¥ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">âš¡ kubectl logs descheduler-1525521300-mrw4t -n kube-system</span><br><span class="line">I0505 11:55:07.554195       1 reflector.go:202] Starting reflector *v1.Node (1h0m0s) from github.com/kubernetes-incubator/descheduler/pkg/descheduler/node/node.go:84</span><br><span class="line">I0505 11:55:07.554255       1 reflector.go:240] Listing and watching *v1.Node from github.com/kubernetes-incubator/descheduler/pkg/descheduler/node/node.go:84</span><br><span class="line">I0505 11:55:07.767903       1 lownodeutilization.go:147] Node <span class="string">"ip-10-4-63-172.eu-west-1.compute.internal"</span> is appropriately utilized with usage: api.ResourceThresholds&#123;<span class="string">"cpu"</span>:41.5, <span class="string">"memory"</span>:1.3635487207675927, <span class="string">"pods"</span>:8.181818181818182&#125;</span><br><span class="line">I0505 11:55:07.767942       1 lownodeutilization.go:149] allPods:9, nonRemovablePods:9, bePods:0, bPods:0, gPods:0</span><br><span class="line">I0505 11:55:07.768141       1 lownodeutilization.go:144] Node <span class="string">"ip-10-4-36-223.eu-west-1.compute.internal"</span> is over utilized with usage: api.ResourceThresholds&#123;<span class="string">"cpu"</span>:48.75, <span class="string">"memory"</span>:61.05259502942694, <span class="string">"pods"</span>:30&#125;</span><br><span class="line">I0505 11:55:07.768156       1 lownodeutilization.go:149] allPods:33, nonRemovablePods:12, bePods:1, bPods:19, gPods:1</span><br><span class="line">I0505 11:55:07.768376       1 lownodeutilization.go:144] Node <span class="string">"ip-10-4-41-14.eu-west-1.compute.internal"</span> is over utilized with usage: api.ResourceThresholds&#123;<span class="string">"cpu"</span>:39.125, <span class="string">"memory"</span>:98.19259268881142, <span class="string">"pods"</span>:33.63636363636363&#125;</span><br><span class="line">I0505 11:55:07.768390       1 lownodeutilization.go:149] allPods:37, nonRemovablePods:8, bePods:0, bPods:29, gPods:0</span><br><span class="line">I0505 11:55:07.768538       1 lownodeutilization.go:147] Node <span class="string">"ip-10-4-34-29.eu-west-1.compute.internal"</span> is appropriately utilized with usage: api.ResourceThresholds&#123;<span class="string">"memory"</span>:43.19826999287199, <span class="string">"pods"</span>:30.90909090909091, <span class="string">"cpu"</span>:35.25&#125;</span><br><span class="line">I0505 11:55:07.768552       1 lownodeutilization.go:149] allPods:34, nonRemovablePods:11, bePods:8, bPods:15, gPods:0</span><br><span class="line">I0505 11:55:07.768556       1 lownodeutilization.go:65] Criteria <span class="keyword">for</span> a node under utilization: CPU: 20, Mem: 20, Pods: 20</span><br><span class="line">I0505 11:55:07.768571       1 lownodeutilization.go:69] No node is underutilized, nothing to <span class="keyword">do</span> here, you might tune your thersholds further</span><br><span class="line">I0505 11:55:07.768576       1 pod_antiaffinity.go:45] Processing node: <span class="string">"ip-10-4-63-172.eu-west-1.compute.internal"</span></span><br><span class="line">I0505 11:55:07.779313       1 pod_antiaffinity.go:45] Processing node: <span class="string">"ip-10-4-36-223.eu-west-1.compute.internal"</span></span><br><span class="line">I0505 11:55:07.796766       1 pod_antiaffinity.go:45] Processing node: <span class="string">"ip-10-4-41-14.eu-west-1.compute.internal"</span></span><br><span class="line">I0505 11:55:07.813303       1 pod_antiaffinity.go:45] Processing node: <span class="string">"ip-10-4-34-29.eu-west-1.compute.internal"</span></span><br><span class="line">I0505 11:55:07.829109       1 node_affinity.go:40] Executing <span class="keyword">for</span> nodeAffinityType: requiredDuringSchedulingIgnoredDuringExecution</span><br><span class="line">I0505 11:55:07.829133       1 node_affinity.go:45] Processing node: <span class="string">"ip-10-4-63-172.eu-west-1.compute.internal"</span></span><br><span class="line">I0505 11:55:07.840416       1 node_affinity.go:45] Processing node: <span class="string">"ip-10-4-36-223.eu-west-1.compute.internal"</span></span><br><span class="line">I0505 11:55:07.856735       1 node_affinity.go:45] Processing node: <span class="string">"ip-10-4-41-14.eu-west-1.compute.internal"</span></span><br><span class="line">I0505 11:55:07.945566       1 request.go:480] Throttling request took 88.738917ms, request: GET:https://100.64.0.1:443/api/v1/pods?fieldSelector=spec.nodeName%3Dip-10-4-41-14.eu-west-1.compute.internal%2Cstatus.phase%21%3DFailed%2Cstatus.phase%21%3DSucceeded</span><br><span class="line">I0505 11:55:07.972702       1 node_affinity.go:45] Processing node: <span class="string">"ip-10-4-34-29.eu-west-1.compute.internal"</span></span><br><span class="line">I0505 11:55:08.145559       1 request.go:480] Throttling request took 172.751657ms, request: GET:https://100.64.0.1:443/api/v1/pods?fieldSelector=spec.nodeName%3Dip-10-4-34-29.eu-west-1.compute.internal%2Cstatus.phase%21%3DFailed%2Cstatus.phase%21%3DSucceeded</span><br><span class="line">I0505 11:55:08.160964       1 node_affinity.go:72] Evicted 0 pods</span><br></pre></td></tr></table></figure></p>
<p>å“‡å“¦ï¼Œç°åœ¨ä½ çš„é›†ç¾¤ä¸­å·²ç»è¿è¡Œäº†ä¸€ä¸ª deschedulerï¼</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>Kubernetes çš„é»˜è®¤è°ƒåº¦å™¨å·²ç»åšçš„å¾ˆå¥½ï¼Œä½†ç”±äºé›†ç¾¤å¤„äºä¸æ–­å˜åŒ–çš„çŠ¶æ€ä¸­ï¼ŒæŸäº› Pod å¯èƒ½è¿è¡Œåœ¨é”™è¯¯çš„èŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…ä½ æƒ³è¦å‡è¡¡é›†ç¾¤èµ„æºçš„åˆ†é…ï¼Œè¿™æ—¶å€™å°±éœ€è¦ descheduler æ¥å¸®åŠ©ä½ å°†æŸäº›èŠ‚ç‚¹ä¸Šçš„ Pod é©±é€åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ä¸Šå»ã€‚æˆ‘å¾ˆæœŸå¾…æ­£å¼ç‰ˆçš„å‘å¸ƒï¼</p>
<p>å‚è€ƒæ–‡æ¡£:</p>
<ul>
<li>Meet a Kubernetes Descheduler</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ä½¿ç”¨Kubernetesæ­£ç¡®çš„å¤„ç†ç”¨æˆ·è¯·æ±‚]]></title>
      <url>http://team.jiunile.com/blog/2018/12/k8s-handling-client-requests-properly-with-kubernetes.html</url>
      <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote>
<p>æ¯«æ— ç–‘é—®ï¼Œæˆ‘ä»¬å¸Œæœ›æ­£ç¡®å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚å½“podæ­£åœ¨å¯åŠ¨æˆ–å…³é—­æ—¶ï¼Œæˆ‘ä»¬æ˜¾ç„¶ä¸å¸Œæœ›çœ‹åˆ°æ–­å¼€çš„è¿æ¥ã€‚Kubernetesæœ¬èº«å¹¶ä¸èƒ½ç¡®ä¿è¿™ç§æƒ…å†µæ°¸è¿œä¸ä¼šå‘ç”Ÿã€‚æ‚¨çš„åº”ç”¨éœ€è¦éµå¾ªä¸€äº›è§„åˆ™ä»¥é˜²æ­¢æ–­å¼€è¿æ¥ã€‚æœ¬æ–‡è®¨è®ºè¿™äº›è§„åˆ™ã€‚</p>
</blockquote>
<h3 id="ç¡®ä¿æ­£ç¡®å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚"><a href="#ç¡®ä¿æ­£ç¡®å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚" class="headerlink" title="ç¡®ä¿æ­£ç¡®å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚"></a>ç¡®ä¿æ­£ç¡®å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚</h3><p>æˆ‘ä»¬å…ˆä»è®¿é—®Podçš„å®¢æˆ·ç«¯çš„è§†è§’æ¥çœ‹çœ‹Podçš„ç”Ÿå‘½å‘¨æœŸï¼ˆå®¢æˆ·ç«¯ä½¿ç”¨podæä¾›çš„æœåŠ¡ï¼‰ã€‚æˆ‘ä»¬å¸Œæœ›ç¡®ä¿å®¢æˆ·çš„è¯·æ±‚å¾—åˆ°å¦¥å–„å¤„ç†ï¼Œå› ä¸ºå¦‚æœå½“podå¯åŠ¨æˆ–å…³é—­æ—¶è¿æ¥å¼€å§‹ä¸­æ–­ï¼Œæˆ‘ä»¬å°±ä¼šé‡åˆ°éº»çƒ¦ã€‚Kubernetesæœ¬èº«å¹¶ä¸ä¿è¯ä¸ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œæ‰€ä»¥è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬éœ€è¦åšäº›ä»€ä¹ˆæ¥é˜²æ­¢å®ƒå‘ç”Ÿã€‚</p>
<h3 id="å½“Podå¯åŠ¨æ—¶é˜»æ­¢è¿æ¥ä¸­æ–­"><a href="#å½“Podå¯åŠ¨æ—¶é˜»æ­¢è¿æ¥ä¸­æ–­" class="headerlink" title="å½“Podå¯åŠ¨æ—¶é˜»æ­¢è¿æ¥ä¸­æ–­"></a>å½“Podå¯åŠ¨æ—¶é˜»æ­¢è¿æ¥ä¸­æ–­</h3><p>å¦‚æœä½ ç†è§£serviceså’Œservice endpointsçš„å·¥ä½œåŸç†ï¼Œç¡®ä¿åœ¨podå¯åŠ¨æ—¶æ­£ç¡®å¤„ç†æ¯ä¸ªè¿æ¥éƒ½éå¸¸ç®€å•ã€‚å½“podå¯åŠ¨æ—¶ï¼Œå®ƒä¼šä½œä¸ºä¸€ä¸ªendpointsè¢«æ·»åŠ åˆ°æ‰€æœ‰åŒ¹é…è¯¥Podæ ‡ç­¾çš„Servicesé‡Œã€‚Podä¹Ÿä¼šå‘å‡ºä¿¡å·å‘Šè¯‰Kuberneteså®ƒå·²å°±ç»ªã€‚åªæœ‰å®ƒå˜æˆä¸€ä¸ªservice endpointsæ—¶æ‰å¯ä»¥æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</p>
<p>å¦‚æœä½ æ²¡æœ‰åœ¨Pod Specé‡ŒæŒ‡å®šreadinessæ¢é’ˆï¼Œåˆ™ä¼šå§‹ç»ˆè®¤ä¸ºè¯¥podå·²å‡†å¤‡å°±ç»ªã€‚è¿™æ„å‘³ç€å®ƒå°†ç«‹å³å¼€å§‹æ¥æ”¶è¯·æ±‚ - åªè¦ç¬¬ä¸€ä¸ªKube-Proxyåœ¨å…¶èŠ‚ç‚¹ä¸Šæ›´æ–°iptablesè§„åˆ™å¹¶ä¸”ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯podå°è¯•è¿æ¥åˆ°è¯¥æœåŠ¡ã€‚å¦‚æœé‚£ä¸ªæ—¶å€™ä½ çš„åº”ç”¨å¹¶æ²¡æœ‰åšå¥½æ¥æ”¶è¯·æ±‚çš„å‡†å¤‡ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å°†ä¼šè§åˆ°â€œconnection refusedâ€ç±»å‹çš„é”™è¯¯ã€‚</p>
<p>ä½ æ‰€éœ€è¦åšçš„å°±æ˜¯ä¿è¯ä½ çš„readinessæ¢é’ˆå½“ä¸”ä»…å½“ä½ çš„åº”ç”¨å¯ä»¥æ­£ç¡®å¤„ç†æ”¶åˆ°çš„è¯·æ±‚æ—¶æ‰è¿”å›æˆåŠŸç»“æœã€‚æ‰€ä»¥æ·»åŠ ä¸€ä¸ªHTTP GET readinessæ¢é’ˆå¹¶è®©å®ƒæŒ‡å‘ä½ åº”ç”¨çš„åŸºç¡€URLä¼šæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¼€å§‹ã€‚åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œè¿™å¯ä»¥è®©ä½ çœå»å®ç°ä¸€ä¸ªç‰¹å®šçš„readinessç«¯ç‚¹çš„å·¥ä½œé‡ã€‚<br><a id="more"></a></p>
<h3 id="åœ¨podå…³é—­æœŸé—´é˜²æ­¢æ–­å¼€è¿æ¥"><a href="#åœ¨podå…³é—­æœŸé—´é˜²æ­¢æ–­å¼€è¿æ¥" class="headerlink" title="åœ¨podå…³é—­æœŸé—´é˜²æ­¢æ–­å¼€è¿æ¥"></a>åœ¨podå…³é—­æœŸé—´é˜²æ­¢æ–­å¼€è¿æ¥</h3><p>ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å½“ä¸€ä¸ªPodç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶å‘ç”Ÿäº†ä»€ä¹ˆâ€”â€”å½“Podè¢«åˆ é™¤å’Œå®ƒé‡Œé¢çš„å®¹å™¨è¢«åœæ­¢æ—¶ã€‚ä¸€æ—¦Podçš„å®¹å™¨æ¥æ”¶åˆ°SIGTERMåå®ƒå°±ä¼šå¼€å§‹å…³é—­ï¼ˆæˆ–è€…æ˜¯åœ¨é‚£ä¹‹å‰å…ˆæ‰§è¡Œprestopé’©å­ï¼‰ï¼Œä½†è¿™æ˜¯å¦èƒ½ä¿è¯æ‰€æœ‰çš„å®¢æˆ·ç«¯è¯·æ±‚å¯ä»¥è¢«æ­£ç¡®åœ°å¤„ç†ï¼Ÿ</p>
<p>æˆ‘ä»¬çš„åº”ç”¨åœ¨æ”¶åˆ°ç»“æŸä¿¡å·æ—¶åº”è¯¥å¦‚ä½•å“åº”ï¼Ÿå®ƒæ˜¯å¦åº”è¯¥ç»§ç»­æ¥æ”¶è¯·æ±‚ï¼Ÿé‚£ä¹ˆé‚£äº›å·²ç»æ”¶åˆ°çš„è¯·æ±‚ä½†æ˜¯è¿˜æœªå®Œæˆçš„è¯·æ±‚å‘¢ï¼Ÿé‚£ä¹ˆé‚£äº›æ­£åœ¨å‘é€è¯·æ±‚çš„é—´éš”ä¸­ä¸”ä»ç„¶å¤„ç†æ‰“å¼€çŠ¶æ€çš„æŒä¹…HTTPè¿æ¥ï¼ˆè¿æ¥ä¸Šæ²¡æœ‰æ´»è·ƒçš„è¯·æ±‚ï¼‰å‘¢ï¼Ÿåœ¨å›ç­”è¿™äº›é—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ·±å…¥äº†è§£ä¸€ä¸‹å½“Podç»“æŸæ—¶é›†ç¾¤é‡Œå‘ç”Ÿçš„ä¸€ç³»åˆ—äº‹ä»¶ã€‚</p>
<h3 id="äº†è§£Podåˆ é™¤æ—¶å‘ç”Ÿçš„ä¸€ç³»åˆ—äº‹ä»¶"><a href="#äº†è§£Podåˆ é™¤æ—¶å‘ç”Ÿçš„ä¸€ç³»åˆ—äº‹ä»¶" class="headerlink" title="äº†è§£Podåˆ é™¤æ—¶å‘ç”Ÿçš„ä¸€ç³»åˆ—äº‹ä»¶"></a>äº†è§£Podåˆ é™¤æ—¶å‘ç”Ÿçš„ä¸€ç³»åˆ—äº‹ä»¶</h3><p>æ‚¨éœ€è¦å§‹ç»ˆç‰¢è®°Kubernetesçš„å„ä¸ªç»„ä»¶æ˜¯ç‹¬ç«‹è¿è¡Œåœ¨é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šçš„ã€‚å®ƒä»¬ä¹‹é—´å¹¶ä¸æ˜¯ä¸€ä¸ªå·¨å¤§çš„å•ä½“åº”ç”¨ã€‚è¿™äº›ç»„ä»¶é—´åŒæ­¥çŠ¶æ€ä¼šèŠ±è´¹ä¸€ç‚¹æ—¶é—´ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹å½“Podåˆ é™¤æ—¶å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>
<p>å½“APIserveræ”¶åˆ°ä¸€ä¸ªåœæ­¢Podçš„è¯·æ±‚æ—¶ï¼Œå®ƒé¦–å…ˆä¿®æ”¹äº†etcdé‡ŒPodçš„çŠ¶æ€ï¼Œå¹¶é€šçŸ¥å…³æ³¨è¿™ä¸ªåˆ é™¤äº‹ä»¶æ‰€æœ‰çš„watcherã€‚è¿™äº›watcheré‡ŒåŒ…æ‹¬Kubeletå’ŒEndpoint Controllerã€‚è¿™ä¸¤ä¸ªåºåˆ—çš„äº‹ä»¶æ˜¯å¹¶è¡Œå‘ç”Ÿçš„ï¼ˆæ ‡è®°ä¸ºAå’ŒBï¼‰ï¼Œå¦‚å›¾1æ‰€ç¤ºã€‚<br><img src="/images/k8s/k8s_pod_03.png" alt="podåœæ­¢æ—¶çš„äº‹ä»¶"></p>
<p>åœ¨Aç³»åˆ—äº‹ä»¶é‡Œï¼Œä½ ä¼šçœ‹åˆ°åœ¨Kubeletæ”¶åˆ°è¯¥Podè¦åœæ­¢çš„é€šçŸ¥ä»¥åä¼šå°½å¿«å¼€å§‹åœæ­¢Podçš„ä¸€ç³»åˆ—æ“ä½œï¼ˆæ‰§è¡Œprestopé’©å­ï¼Œå‘é€SIGTERMä¿¡å·ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ç„¶åå¦‚æœè¿™ä¸ªå®¹å™¨æ²¡æœ‰è‡ªåŠ¨é€€å‡ºçš„è¯å°±å¼ºè¡Œæ€æ‰è¿™ä¸ªå®¹å™¨ï¼‰ã€‚å¦‚æœåº”ç”¨å“åº”äº†SIGTERMå¹¶è¿…é€Ÿåœæ­¢æ¥æ”¶è¯·æ±‚ï¼Œé‚£ä¹ˆä»»ä½•å°è¯•è¿æ¥å®ƒçš„å®¢æˆ·ç«¯éƒ½ä¼šæ”¶åˆ°ä¸€ä¸ªConnection Refusdçš„é”™è¯¯ã€‚å› ä¸ºAPIserveræ˜¯ç›´æ¥å‘Kubeletå‘é€çš„è¯·æ±‚ï¼Œé‚£ä¹ˆä»Podè¢«åˆ é™¤å¼€å§‹è®¡ç®—ï¼ŒPodç”¨äºæ‰§è¡Œè¿™æ®µé€»è¾‘çš„æ—¶é—´ç›¸å½“çŸ­ã€‚</p>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹å¦å¤–ä¸€ç³»åˆ—äº‹ä»¶éƒ½å‘ç”Ÿäº†ä»€ä¹ˆâ€”â€”ç§»é™¤è¿™ä¸ªPodç›¸å…³çš„iptablesè§„åˆ™ï¼ˆå›¾ä¸­æ‰€ç¤ºäº‹ä»¶ç³»åˆ—Bï¼‰ã€‚å½“Endpoints Controllerï¼ˆè¿è¡Œåœ¨åœ¨Kubernetesæ§åˆ¶å¹³é¢é‡Œçš„Controller Manageré‡Œï¼‰æ”¶åˆ°è¿™ä¸ªPodè¢«åˆ é™¤çš„é€šçŸ¥ï¼Œç„¶åå®ƒä¼šæŠŠè¿™ä¸ªPodä»æ‰€æœ‰å…³è”åˆ°è¿™ä¸ªPodçš„Serviceé‡Œå‰”é™¤ã€‚å®ƒé€šè¿‡å‘APIserverå‘é€ä¸€ä¸ªRESTè¯·æ±‚å¯¹Endpointå¯¹è±¡è¿›è¡Œä¿®æ”¹æ¥å®ç°ã€‚APIserverç„¶åé€šçŸ¥æ¯ä¸ªç›‘è§†Endpointå¯¹è±¡çš„ç»„ä»¶ã€‚åœ¨è¿™äº›ç»„ä»¶é‡ŒåŒ…å«äº†æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œçš„Kubeproxyã€‚è¿™äº›ä»£ç†è´Ÿè´£æ›´æ–°å®ƒæ‰€åœ¨èŠ‚ç‚¹ä¸Šçš„iptablesè§„åˆ™ï¼Œè¿™äº›è§„åˆ™å¯ä»¥ç”¨æ¥é˜»æ­¢å¤–é¢çš„è¯·æ±‚è¢«è½¬å‘åˆ°è¦åœæ­¢çš„Podä¸Šã€‚è¿™é‡Œæœ‰ä¸ªéå¸¸é‡è¦çš„ç»†èŠ‚ï¼Œç§»é™¤è¿™äº›iptablesè§„åˆ™å¯¹äºå·²æœ‰çš„è¿æ¥ä¸ä¼šæœ‰ä»»ä½•å½±å“â€”â€”è¿æ¥åˆ°è¿™ä¸ªPodçš„å®¢æˆ·ç«¯ä»ç„¶å¯ä»¥é€šè¿‡å·²æœ‰è¿æ¥å‘å®ƒå‘é€è¯·æ±‚ã€‚</p>
<p>è¿™äº›è¯·æ±‚éƒ½æ˜¯å¹¶è¡Œå‘ç”Ÿçš„ã€‚æ›´ç¡®åˆ‡åœ°ï¼Œå…³åœåº”ç”¨æ‰€éœ€è¦çš„æ—¶é—´è¦æ¯”iptablesæ›´æ–°èŠ±è´¹æ‰€éœ€çš„æ—¶é—´ç¨çŸ­ä¸€äº›ã€‚è¿™æ˜¯å› ä¸ºiptablesä¿®æ”¹çš„äº‹ä»¶é“¾çœ‹èµ·æ¥ç¨å¾®é•¿ä¸€äº›ï¼ˆè§å›¾2ï¼‰ï¼Œå› ä¸ºè¿™äº›äº‹ä»¶éœ€è¦å…ˆåˆ°è¾¾Endpoints Controllerï¼Œç„¶åå®ƒå‘APIServerå‘é€ä¸€ä¸ªæ–°è¯·æ±‚ï¼Œæ¥ç€åœ¨Proxyæœ€ç»ˆä¿®æ”¹iptablesè§„åˆ™ä¹‹å‰ï¼ŒAPIserverå¿…é¡»é€šçŸ¥åˆ°æ¯ä¸ªKubeProxyã€‚è¿™æ„å‘³ç€SIGTERMå¯èƒ½ä¼šåœ¨æ‰€æœ‰èŠ‚ç‚¹iptablesè§„åˆ™æ›´æ–°å‰å‘é€ã€‚<br><img src="/images/k8s/k8s_pod_04.png" alt="åˆ é™¤podæ—¶çš„äº‹ä»¶æ—¶é—´çº¿"></p>
<p>ç»“æœæ˜¯podåœ¨æ”¶åˆ°ç»ˆæ­¢ä¿¡å·åä»ç„¶å¯ä»¥æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ã€‚å¦‚æœåº”ç”¨ç¨‹åºç«‹å³åœæ­¢æ¥å—è¿æ¥ï¼Œåˆ™ä¼šå¯¼è‡´å®¢æˆ·ç«¯æ”¶åˆ°â€œConnection Refusedâ€ç±»å‹çš„é”™è¯¯ï¼ˆå°±åƒåœ¨æ²¡æœ‰å®šä¹‰Readinessæ¢é’ˆæ—¶ï¼ŒPodå¯åŠ¨ä½†æ— æ³•å¯¹å¤–æä¾›æœåŠ¡æ—¶ä¸€æ ·ï¼‰ ã€‚</p>
<h3 id="è§£å†³é—®é¢˜"><a href="#è§£å†³é—®é¢˜" class="headerlink" title="è§£å†³é—®é¢˜"></a>è§£å†³é—®é¢˜</h3><p>è°·æ­Œæœç´¢æ­¤é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œä¼¼ä¹ç»™Podæ·»åŠ ä¸€ä¸ªReadinessæ¢é’ˆå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æŒ‰ç…§æ¨æµ‹ï¼Œä½ æ‰€éœ€è¦åšçš„å°±æ˜¯è®©ä½ çš„Readinessæ¢é’ˆåœ¨åº”ç”¨æ”¶åˆ°SIGTERMä¿¡å·åå°½å¿«å¤±è´¥ã€‚è¿™å¯ä»¥è®©Podä»Serviceä¸Šç§»é™¤ã€‚åªæœ‰åœ¨Readinessæ¢é’ˆè¿ç»­å¤±è´¥å‡ æ¬¡åæ‰ä¼šä»Serviceä¸Šç§»é™¤ï¼ˆè¿™å¯ä»¥åœ¨Readinessæ¢é’ˆé‡Œè¿›è¡Œé…ç½®ï¼‰ã€‚å¹¶ä¸”æ˜¾ç„¶è¿™ä¸ªç§»é™¤äº‹ä»¶ä¼šåœ¨iptablesè§„åˆ™æ›´æ–°å‰å…ˆåˆ°è¾¾Kubeproxyã€‚</p>
<p>å®é™…ä¸Šï¼ŒReadinessæ¢é’ˆåœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­å¹¶æœªèµ·åˆ°å…³é”®ä½œç”¨ã€‚ä¸€æ—¦Endpoints Controlleræ”¶åˆ°Podåˆ é™¤äº‹ä»¶åï¼ˆå½“Podé…ç½®é‡Œçš„deletionTimestampåŸŸä¸å†ä¸ºç©ºæ—¶ï¼‰ï¼Œå®ƒä¼šå°½å¿«ä»Serviceä¸Šç§»é™¤è¿™äº›Podã€‚ä»é‚£æ—¶èµ·ï¼Œè¿™å·²ç»å°±ä¸Readinessæ¢æµ‹ç»“æœä¸ç›¸å…³äº†ã€‚</p>
<p>é‚£ä¹ˆä»€ä¹ˆæ˜¯é—®é¢˜çš„æ­£ç¡®è§£å†³æ–¹æ¡ˆï¼Ÿæˆ‘ä»¬å¦‚ä½•ä¿è¯æ‰€æœ‰çš„è¯·æ±‚éƒ½å¯ä»¥è¢«æ­£ç¡®å¤„ç†ï¼Ÿ</p>
<p>å¥½å§ï¼Œå¾ˆæ˜æ˜¾ï¼Œå³ä½¿æ”¶åˆ°ç»ˆæ­¢ä¿¡å·åï¼Œpodä¹Ÿéœ€è¦ç»§ç»­æ¥å—è¿æ¥ï¼Œç›´åˆ°æ‰€æœ‰Kubeä»£ç†å®Œæˆæ›´æ–°iptablesè§„åˆ™ã€‚é‚£ä¹ˆï¼Œä¸æ­¢æ˜¯Kubeproxyã€‚å¯èƒ½æœ‰ä¸€äº›IngressControlleræˆ–è€…å…¶ä»–ç›´æ¥å‘Podè½¬å‘è¯·æ±‚çš„è´Ÿè½½å‡è¡¡è®¾å¤‡ç­‰ä¸éœ€è¦ç»è¿‡Serviceçš„ã€‚è¿™è¿˜åŒ…æ‹¬ä½¿ç”¨å®¢æˆ·ç«¯è´Ÿè½½å¹³è¡¡çš„å®¢æˆ·ç«¯ã€‚<br>ä¸ºäº†ç¡®ä¿æ²¡æœ‰ä»»ä½•å®¢æˆ·ç«¯é‡åˆ°æ–­å¼€çš„è¿æ¥ï¼Œæ‚¨å¿…é¡»ç­‰åˆ°æ‰€æœ‰å®¢æˆ·ç«¯ä»¥æŸç§æ–¹å¼é€šçŸ¥æ‚¨ä»–ä»¬å°†ä¸å†è½¬å‘åˆ°è¯¥Podçš„è¿æ¥ã€‚</p>
<p>ä½†è¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºè¿™äº›ç»„ä»¶éƒ½åˆ†å¸ƒåœ¨ä¸åŒçš„è®¡ç®—æœºä¸Šã€‚å³ä½¿ä½ çŸ¥é“å®ƒä»¬æ¯ä¸ªæ‰€åœ¨çš„ä½ç½®æˆ–è€…ç­‰ç€å®ƒä»¬æ¯ä¸ªéƒ½æ»¡è¶³åœæ­¢Podçš„éœ€æ±‚ï¼Œå¦‚æœå®ƒä»¬å…¶ä¸­ä¹‹ä¸€æ²¡æœ‰å“åº”ä½ ä¼šè¯¥æ€ä¹ˆåŠï¼Ÿä½ è¦ç­‰å¾…å¤šä¹…ï¼Ÿè®°ç€ï¼Œåœ¨é‚£æ®µæ—¶é—´é‡Œï¼Œä½ éœ€è¦æš‚åœå…³é—­è¿›ç¨‹ã€‚</p>
<p>ä½ å”¯ä¸€å¯èƒ½çš„åšäº‹æƒ…æ˜¯ä½ å¯ä»¥ç­‰å¾…è¶³å¤Ÿé•¿çš„æ—¶é—´ç›´åˆ°æ‰€æœ‰çš„ä»£ç†éƒ½å®Œæˆäº†å®ƒä»¬çš„å·¥ä½œã€‚ä½†æ˜¯å¤šé•¿æ—¶é—´æ‰ç®—å¤Ÿï¼Ÿåœ¨å¤§å¤šæ•°æƒ…å†µä¸­ï¼ŒçŸ­æš‚çš„å‡ ç§’å°±è¶³å¤Ÿäº†ï¼Œä½†æ˜¯æ˜¾ç„¶è¿™å¹¶ä¸èƒ½æ»¡è¶³å…¨éƒ¨çš„æƒ…å†µã€‚å½“APIserveræˆ–è€…Endpoints Controllerè¿‡è½½æ—¶ï¼Œå®ƒä»¬å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´æ¥é€šçŸ¥åˆ°æ¯ä¸ªä»£ç†ã€‚é‡è¦çš„æ˜¯è¦äº†è§£æ‚¨æ— æ³•å®Œç¾åœ°è§£å†³é—®é¢˜ï¼Œä½†æ˜¯å³ä½¿æ˜¯5ç§’æˆ–è€…10ç§’éƒ½å¯ä»¥æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒã€‚ä½ å¯ä»¥è®¾ç½®æ›´é•¿çš„å»¶è¿Ÿï¼Œä½†æ˜¯åˆ«å¤ªè¿‡åˆ†ï¼Œå› ä¸ºè¿™äº›å»¶è¿Ÿæ¨è¿Ÿäº†å®¹å™¨çš„åœæ­¢æ—¶é—´ï¼Œå¹¶ä¸”ä¼šå¯¼è‡´å®¹å™¨åœ¨è¢«å…³åœåä»ç„¶è¢«æ˜¾ç¤ºåœ¨åˆ—è¡¨é‡Œï¼Œè¿™ä¼šå¯¹ç”¨æˆ·å¸¦æ¥ä¸€å®šçš„å›°æ‰°ã€‚</p>
<p>æ­£ç¡®å…³é—­åº”ç”¨ç¨‹åºåŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ul>
<li>ç­‰å¾…å‡ ç§’ï¼Œç„¶ååœæ­¢æ¥æ”¶æ–°è¿æ¥</li>
<li>å…³é—­æ‰€æœ‰æœªåœ¨è¯·æ±‚ä¸­çš„keep-alivedè¿æ¥</li>
<li>ç­‰åˆ°æ‰€æœ‰æ´»è·ƒçš„è¯·æ±‚å…³é—­ï¼Œç„¶å</li>
<li>å½»åº•å…³é—­</li>
</ul>
<p>è¦äº†è§£åœ¨æ­¤è¿‡ç¨‹ä¸­è¿æ¥å’Œè¯·æ±‚å‘ç”Ÿçš„æƒ…å†µï¼Œè¯·ä»”ç»†æ£€æŸ¥å›¾3ã€‚<br><img src="/images/k8s/k8s_pod_05.png" alt="åœ¨æ”¶åˆ°ç»ˆæ­¢ä¿¡å·åæ­£ç¡®å¤„ç†ç°æœ‰å’Œæ–°è¿æ¥"></p>
<p>æ²¡æœ‰åƒæ”¶åˆ°ç»ˆæ­¢ä¿¡å·åç«‹å³é€€å‡ºè¿‡ç¨‹ä¸€æ ·ç®€å•ï¼Œå¯¹å§ï¼Ÿè¿™ä¸€åˆ‡æ˜¯å€¼å¾—çš„å—ï¼Ÿè¿™è¦é ä½ è‡ªå·±æ¥å†³å®šã€‚ä½†æ˜¯è‡³å°‘ä½ å¯ä»¥æ·»åŠ ä¸€ä¸ªprestopé’©å­å¹¶ç­‰å¾…å‡ ç§’ï¼Œå°±åƒä¸‹é¢æ‰€ç¤ºï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lifecycle:</span>  </span><br><span class="line"><span class="attr">    preStop:</span>    </span><br><span class="line"><span class="attr">        exec:</span>      </span><br><span class="line"><span class="attr">            command:</span></span><br><span class="line"><span class="bullet">             -</span> sh</span><br><span class="line"><span class="bullet">             -</span> -c</span><br><span class="line"><span class="bullet">             -</span> <span class="string">"sleep 5"</span></span><br></pre></td></tr></table></figure></p>
<p>è¿™æ ·ï¼Œæ‚¨æ ¹æœ¬ä¸éœ€è¦ä¿®æ”¹åº”ç”¨ç¨‹åºçš„ä»£ç ã€‚å¦‚æœæ‚¨çš„åº”ç”¨è¦ç¡®ä¿å®Œå…¨å¤„ç†æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ï¼Œè¿™ä¸ªpreStopé’©å­å°±å¯ä»¥æ»¡è¶³æ‰€æœ‰ä½ çš„éœ€è¦ã€‚</p>
<p>å‚è€ƒæ–‡æ¡£:</p>
<ul>
<li>handling-client-requests-properly-with-kubernetes</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Kubeadmè¯ä¹¦è¿‡æœŸæ—¶é—´è°ƒæ•´]]></title>
      <url>http://team.jiunile.com/blog/2018/12/k8s-kubeadm-ca-upgdate.html</url>
      <content type="html"><![CDATA[<blockquote>
<p> kubeadm é»˜è®¤è¯ä¹¦ä¸ºä¸€å¹´ï¼Œä¸€å¹´è¿‡æœŸåï¼Œä¼šå¯¼è‡´api serviceä¸å¯ç”¨ï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šå‡ºç°ï¼šx509: certificate has expired or is not yet valid</p>
</blockquote>
<p><strong><code>å¦‚ä½•è¿›è¡Œè°ƒæ•´ï¼Œä¸‹é¢ç»™äº†ä¸¤ä¸ªæ–¹æ¡ˆï¼Œä¾›å¤§å®¶é€‰æ‹©</code></strong></p>
<h3 id="æ–¹æ¡ˆä¸€-é€šè¿‡ä¿®æ”¹kubeadm-è°ƒæ•´è¯ä¹¦è¿‡æœŸæ—¶é—´"><a href="#æ–¹æ¡ˆä¸€-é€šè¿‡ä¿®æ”¹kubeadm-è°ƒæ•´è¯ä¹¦è¿‡æœŸæ—¶é—´" class="headerlink" title="æ–¹æ¡ˆä¸€ é€šè¿‡ä¿®æ”¹kubeadm è°ƒæ•´è¯ä¹¦è¿‡æœŸæ—¶é—´"></a>æ–¹æ¡ˆä¸€ é€šè¿‡ä¿®æ”¹kubeadm è°ƒæ•´è¯ä¹¦è¿‡æœŸæ—¶é—´</h3><a id="more"></a>
<h4 id="ä¿®æ”¹ä»£ç ï¼Œè°ƒæ•´è¿‡æœŸæ—¶é—´"><a href="#ä¿®æ”¹ä»£ç ï¼Œè°ƒæ•´è¿‡æœŸæ—¶é—´" class="headerlink" title="ä¿®æ”¹ä»£ç ï¼Œè°ƒæ•´è¿‡æœŸæ—¶é—´"></a>ä¿®æ”¹ä»£ç ï¼Œè°ƒæ•´è¿‡æœŸæ—¶é—´</h4><p> å…‹éš†ä»£ç ï¼š<code>git clone https://github.com/kubernetes/kubernetes.git</code>, åˆ‡æ¢åˆ°æŒ‡å®šçš„tagæˆ–è€…ç‰ˆæœ¬ä¿®æ”¹<code>vendor/k8s.io/client-go/util/cert/cert.go</code>æ–‡ä»¶ï¼Œ<code>git diff</code> å¯¹æ¯”å¦‚ä¸‹ï¼š<br><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/staging/src/k8s.io/client-go/util/cert/cert.go b/staging/src/k8s.io/client-go/util/cert/cert.go</span><br><span class="line">index fb7f5fa..e800962 100644</span><br><span class="line"><span class="comment">--- a/staging/src/k8s.io/client-go/util/cert/cert.go</span></span><br><span class="line"><span class="comment">+++ b/staging/src/k8s.io/client-go/util/cert/cert.go</span></span><br><span class="line">@@ -104,7 +104,7 @@ func NewSignedCert(cfg Config, key *rsa.PrivateKey, caCert *x509.Certificate, ca</span><br><span class="line">                IPAddresses:  cfg.AltNames.IPs,</span><br><span class="line">                SerialNumber: serial,</span><br><span class="line">                NotBefore:    caCert.NotBefore,</span><br><span class="line"><span class="deletion">-               NotAfter:     time.Now().Add(duration365d).UTC(),</span></span><br><span class="line"><span class="addition">+               NotAfter:     time.Now().Add(duration365d * 10).UTC(),</span></span><br><span class="line">                KeyUsage:     x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature,</span><br><span class="line">                ExtKeyUsage:  cfg.Usages,</span><br><span class="line">        &#125;</span><br><span class="line">@@ -149,7 +149,7 @@ func GenerateSelfSignedCertKey(host string, alternateIPs []net.IP, alternateDNS</span><br><span class="line">                        CommonName: fmt.Sprintf("%s-ca@%d", host, time.Now().Unix()),</span><br><span class="line">                &#125;,</span><br><span class="line">                NotBefore: time.Now(),</span><br><span class="line"><span class="deletion">-               NotAfter:  time.Now().Add(time.Hour * 24 * 365),</span></span><br><span class="line"><span class="addition">+               NotAfter:  time.Now().Add(time.Hour * 24 * 3650),</span></span><br><span class="line"></span><br><span class="line">                KeyUsage:              x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature | x509.KeyUsageCertSign,</span><br><span class="line">                BasicConstraintsValid: true,</span><br></pre></td></tr></table></figure></p>
<h4 id="ç¼–è¯‘ä»£ç "><a href="#ç¼–è¯‘ä»£ç " class="headerlink" title="ç¼–è¯‘ä»£ç "></a>ç¼–è¯‘ä»£ç </h4><p>ç¼–è¯‘ç¯å¢ƒæˆ‘å·²ç»åšäº†å¯¹åº”çš„1.11.5ã€1.12.3ã€1.13.0ã€1.13.2ã€1.13.4ã€1.14.1ã€1.15.3ï¼Œå·²ä¸Šä¼ åˆ°docker hub ä¸Šï¼Œå¤§å®¶å¯ä¸‹è½½ä½¿ç”¨ï¼Œåœ°å€å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker pull icyboy/k8s_build:v1.11.5  <span class="comment"># åŸºäº golang:1.10.3</span></span><br><span class="line">docker pull icyboy/k8s_build:v1.12.3  <span class="comment"># åŸºäº golang:1.10.4 </span></span><br><span class="line">docker pull icyboy/k8s_build:v1.13.0  <span class="comment"># åŸºäº golang:1.11.2</span></span><br><span class="line">docker pull icyboy/k8s_build:v1.13.2  <span class="comment"># åŸºäº golang:1.11.4</span></span><br><span class="line">docker pull icyboy/k8s_build:v1.13.4  <span class="comment"># åŸºäº golang:1.11.5</span></span><br><span class="line">docker pull icyboy/k8s_build:v1.14.1  <span class="comment"># åŸºäº golang:1.12.2</span></span><br><span class="line">docker pull icyboy/k8s_build:v1.15.3  <span class="comment"># åŸºäº golang:1.12.9</span></span><br><span class="line">docker pull icyboy/k8s_build:v1.16.0  <span class="comment"># åŸºäº golang:1.12.9</span></span><br><span class="line">docker pull icyboy/k8s_build:v1.16.3  <span class="comment"># åŸºäº golang:1.12.12</span></span><br><span class="line">docker pull icyboy/k8s_build:v1.17.0  <span class="comment"># åŸºäº golang:1.13.4</span></span><br><span class="line">docker pull icyboy/k8s_build:v1.17.1  <span class="comment"># åŸºäº golang:1.13.5</span></span><br><span class="line">docker pull icyboy/k8s_build:v1.17.3  <span class="comment"># åŸºäº golang:1.13.6</span></span><br></pre></td></tr></table></figure></p>
<p>ç¼–è¯‘<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -v ä½ ä¿®æ”¹åçš„ä»£ç ç›®å½•:/go/src/k8s.io/kubernetes -it icyboy/k8s_build:v1.11.5 bash</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /go/src/k8s.io/kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘kubeadm, è¿™é‡Œä¸»è¦ç¼–è¯‘kubeadm å³å¯</span></span><br><span class="line">make all WHAT=cmd/kubeadm GOFLAGS=-v</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘kubelet</span></span><br><span class="line"><span class="comment"># make all WHAT=cmd/kubelet GOFLAGS=-v</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘kubectl</span></span><br><span class="line"><span class="comment"># make all WHAT=cmd/kubectl GOFLAGS=-v</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¼–è¯‘å®Œäº§ç‰©åœ¨ _output/bin/kubeadm ç›®å½•ä¸‹</span></span><br><span class="line"><span class="comment">#å°†kubeadm æ–‡ä»¶æ‹·è´å‡ºæ¥ï¼Œæ›¿æ¢ç³»ç»Ÿä¸­çš„kubeadm</span></span><br></pre></td></tr></table></figure></p>
<p>å¯¹åº”çš„kubeadm æ–‡ä»¶æˆ‘ä¹Ÿç¼–è¯‘å¥½åæ”¾åˆ°ç™¾åº¦äº‘ä¸­ï¼Œå¤§å®¶å¯æ”¾å¿ƒä¸‹è½½ä½¿ç”¨ï¼Œå¯é€šè¿‡<code>kubeadm version</code> æŸ¥çœ‹å¯¹åº”çš„ç‰ˆæœ¬ä¿¡æ¯å’Œå®˜æ–¹çš„è¿›è¡Œæ¯”å¯¹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç¼–è¯‘è¿‡åçš„</span></span><br><span class="line">kubeadm version: &amp;version.Info&#123;Major:<span class="string">"1"</span>, Minor:<span class="string">"11+"</span>, GitVersion:<span class="string">"v1.11.5-dirty"</span>, GitCommit:<span class="string">"753b2dbc622f5cc417845f0ff8a77f539a4213ea"</span>, GitTreeState:<span class="string">"dirty"</span>, BuildDate:<span class="string">"2018-12-07T05:58:18Z"</span>, GoVersion:<span class="string">"go1.10.3"</span>, Compiler:<span class="string">"gc"</span>, Platform:<span class="string">"linux/amd64"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®˜æ–¹çš„</span></span><br><span class="line">kubeadm version: &amp;version.Info&#123;Major:<span class="string">"1"</span>, Minor:<span class="string">"11"</span>, GitVersion:<span class="string">"v1.11.5"</span>, GitCommit:<span class="string">"753b2dbc622f5cc417845f0ff8a77f539a4213ea"</span>, GitTreeState:<span class="string">"clean"</span>, BuildDate:<span class="string">"2018-11-26T14:38:30Z"</span>, GoVersion:<span class="string">"go1.10.3"</span>, Compiler:<span class="string">"gc"</span>, Platform:<span class="string">"linux/amd64"</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>kubeadm ä¸‹è½½åœ°å€ï¼š<a href="https://pan.baidu.com/s/1PplHyDkYDTusx46j9uHwDA" target="_blank" rel="external">https://pan.baidu.com/s/1PplHyDkYDTusx46j9uHwDA</a><br>æå–ç ï¼šdy6f</p>
<h4 id="æ›¿æ¢è¯ä¹¦"><a href="#æ›¿æ¢è¯ä¹¦" class="headerlink" title="æ›¿æ¢è¯ä¹¦"></a>æ›¿æ¢è¯ä¹¦</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç”¨æ–°çš„kubeadm æ›¿æ¢å®˜æ–¹çš„kubeadm</span></span><br><span class="line">chmod +x kubeadm &amp;&amp; \cp <span class="_">-f</span> kubeadm /usr/bin</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¤‡ä»½åŸæœ‰çš„è¯ä¹¦</span></span><br><span class="line">mv /etc/kubernetes/pki /etc/kubernetes/pki.old</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç”Ÿæˆæ–°çš„è¯ä¹¦ï¼Œkubeadm.yaml æŒ‡å®šä½ è‡ªå·±æœåŠ¡å™¨ä¸Šçš„</span></span><br><span class="line">kubeadm alpha phase certs all --config  ~/kubeadm.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¤‡ä»½åŸæœ‰çš„confæ–‡ä»¶</span></span><br><span class="line">mv /etc/kubernetes/*conf /etc/kubernetes/*conf-old</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ ¹æ®æ–°è¯ä¹¦é‡æ–°ç”Ÿæˆæ–°çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line">kubeadm alpha phase kubeconfig all --config ~/kubeadm.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ›¿æ¢è€çš„configæ–‡ä»¶</span></span><br><span class="line">\cp <span class="_">-f</span> /etc/kubernetes/admin.conf ~/.kube/config</span><br></pre></td></tr></table></figure>
<p><strong>éªŒè¯</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/kubernetes/pki</span><br><span class="line">openssl x509 -in apiserver-etcd-client.crt -text -noout</span><br><span class="line"><span class="comment">#Certificate:</span></span><br><span class="line"><span class="comment">#    Data:</span></span><br><span class="line"><span class="comment">#        Version: 3 (0x2)</span></span><br><span class="line"><span class="comment">#        Serial Number: 2755977466456048186 (0x263f32e76918023a)</span></span><br><span class="line"><span class="comment">#    Signature Algorithm: sha256WithRSAEncryption</span></span><br><span class="line"><span class="comment">#        Issuer: CN=kubernetes</span></span><br><span class="line"><span class="comment">#        Validity</span></span><br><span class="line"><span class="comment">#            Not Before: Dec  7 09:33:32 2018 GMT</span></span><br><span class="line">             Not After : Dec  4 09:33:32 2028 GMT  <span class="comment">#è¿™é‡Œå˜æˆ10å¹´äº†</span></span><br><span class="line"><span class="comment">#        Subject: O=system:masters, CN=kube-apiserver-etcd-client</span></span><br><span class="line"><span class="comment">#        Subject Public Key Info:</span></span><br><span class="line"><span class="comment">#        ....</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡éªŒè¯è¯ä¹¦</span></span><br><span class="line"><span class="keyword">for</span> crt <span class="keyword">in</span> $(find /etc/kubernetes/pki/ -name <span class="string">"*.crt"</span>); <span class="keyword">do</span> openssl x509 -in <span class="variable">$crt</span> -noout -dates; <span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<h3 id="æ–¹æ¡ˆäºŒ-å¯ç”¨è‡ªåŠ¨è½®æ¢kubelet-è¯ä¹¦"><a href="#æ–¹æ¡ˆäºŒ-å¯ç”¨è‡ªåŠ¨è½®æ¢kubelet-è¯ä¹¦" class="headerlink" title="æ–¹æ¡ˆäºŒ å¯ç”¨è‡ªåŠ¨è½®æ¢kubelet è¯ä¹¦"></a>æ–¹æ¡ˆäºŒ å¯ç”¨è‡ªåŠ¨è½®æ¢kubelet è¯ä¹¦</h3><blockquote>
<p>kubeletè¯ä¹¦åˆ†ä¸ºserverå’Œclientä¸¤ç§ï¼Œ <code>k8s 1.9</code>é»˜è®¤å¯ç”¨äº†clientè¯ä¹¦çš„è‡ªåŠ¨è½®æ¢ï¼Œä½†serverè¯ä¹¦è‡ªåŠ¨è½®æ¢éœ€è¦ç”¨æˆ·å¼€å¯</p>
</blockquote>
<h4 id="å¢åŠ -kubelet-å‚æ•°"><a href="#å¢åŠ -kubelet-å‚æ•°" class="headerlink" title="å¢åŠ  kubelet å‚æ•°"></a>å¢åŠ  kubelet å‚æ•°</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨/etc/systemd/system/kubelet.service.d/10-kubeadm.conf å¢åŠ å¦‚ä¸‹å‚æ•°</span></span><br><span class="line">Environment=<span class="string">"KUBELET_EXTRA_ARGS=--feature-gates=RotateKubeletServerCertificate=true"</span></span><br></pre></td></tr></table></figure>
<h4 id="å¢åŠ -controller-manager-å‚æ•°"><a href="#å¢åŠ -controller-manager-å‚æ•°" class="headerlink" title="å¢åŠ  controller-manager å‚æ•°"></a>å¢åŠ  controller-manager å‚æ•°</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨/etc/kubernetes/manifests/kube-controller-manager.yaml æ·»åŠ å¦‚ä¸‹å‚æ•°</span></span><br><span class="line">  - <span class="built_in">command</span>:</span><br><span class="line">    - kube-controller-manager</span><br><span class="line">    - --experimental-cluster-signing-duration=87600h0m0s</span><br><span class="line">    - --feature-gates=RotateKubeletServerCertificate=<span class="literal">true</span></span><br><span class="line">    - ....</span><br></pre></td></tr></table></figure>
<h4 id="åˆ›å»º-rbac-å¯¹è±¡"><a href="#åˆ›å»º-rbac-å¯¹è±¡" class="headerlink" title="åˆ›å»º rbac å¯¹è±¡"></a>åˆ›å»º rbac å¯¹è±¡</h4><p>åˆ›å»ºrbacå¯¹è±¡ï¼Œå…è®¸èŠ‚ç‚¹è½®æ¢kubelet serverè¯ä¹¦ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-update.yaml &lt;&lt; EOF</span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="attr">kind:</span> ClusterRole</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line"><span class="attr">  name:</span> system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> certificates.k8s.io</span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> certificatesigningrequests/selfnodeserver</span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> create</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="attr">kind:</span> ClusterRoleBinding</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> kubeadm:node-autoapprove-certificate-server</span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="attr">  kind:</span> ClusterRole</span><br><span class="line"><span class="attr">  name:</span> system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="attr">  kind:</span> Group</span><br><span class="line"><span class="attr">  name:</span> system:nodes</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl create â€“f ca-update.yaml</span><br></pre></td></tr></table></figure></p>
<h3 id="å¦‚æœè¯ä¹¦å·²ç»è¿‡æœŸï¼Œå¦‚ä½•è¿›è¡Œé‡æ–°ç­¾å‘è¯ä¹¦"><a href="#å¦‚æœè¯ä¹¦å·²ç»è¿‡æœŸï¼Œå¦‚ä½•è¿›è¡Œé‡æ–°ç­¾å‘è¯ä¹¦" class="headerlink" title="å¦‚æœè¯ä¹¦å·²ç»è¿‡æœŸï¼Œå¦‚ä½•è¿›è¡Œé‡æ–°ç­¾å‘è¯ä¹¦"></a>å¦‚æœè¯ä¹¦å·²ç»è¿‡æœŸï¼Œå¦‚ä½•è¿›è¡Œé‡æ–°ç­¾å‘è¯ä¹¦</h3><h4 id="é’ˆå¯¹kubeadm-1-13-x-åŠä»¥ä¸Šå¤„ç†"><a href="#é’ˆå¯¹kubeadm-1-13-x-åŠä»¥ä¸Šå¤„ç†" class="headerlink" title="é’ˆå¯¹kubeadm 1.13.x åŠä»¥ä¸Šå¤„ç†"></a>é’ˆå¯¹kubeadm 1.13.x åŠä»¥ä¸Šå¤„ç†</h4><h5 id="å‡†å¤‡kubeadm-conf-é…ç½®æ–‡ä»¶ä¸€ä»½"><a href="#å‡†å¤‡kubeadm-conf-é…ç½®æ–‡ä»¶ä¸€ä»½" class="headerlink" title="å‡†å¤‡kubeadm.conf é…ç½®æ–‡ä»¶ä¸€ä»½"></a>å‡†å¤‡kubeadm.conf é…ç½®æ–‡ä»¶ä¸€ä»½</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> kubeadm.k8s.io/v1beta1</span><br><span class="line"><span class="attr">kind:</span> ClusterConfiguration</span><br><span class="line"><span class="attr">kubernetesVersion:</span> v1<span class="number">.14</span><span class="number">.1</span> <span class="comment">#--&gt;è¿™é‡Œæ”¹æˆä½ é›†ç¾¤å¯¹åº”çš„ç‰ˆæœ¬</span></span><br><span class="line"><span class="attr">imageRepository:</span> registry.cn-hangzhou.aliyuncs.com/google_containers </span><br><span class="line"><span class="comment">#è¿™é‡Œä½¿ç”¨å›½å†…çš„é•œåƒä»“åº“ï¼Œå¦åˆ™åœ¨é‡æ–°ç­¾å‘çš„æ—¶å€™ä¼šæŠ¥é”™ï¼šcould not fetch a Kubernetes version from the internet: unable to get URL "https://dl.k8s.io/release/stable-1.txt"</span></span><br></pre></td></tr></table></figure>
<h5 id="é‡æ–°ç­¾å‘å‘½ä»¤"><a href="#é‡æ–°ç­¾å‘å‘½ä»¤" class="headerlink" title="é‡æ–°ç­¾å‘å‘½ä»¤"></a>é‡æ–°ç­¾å‘å‘½ä»¤</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kubeadm alpha certs renew all --config=/root/kubeadm.conf</span><br><span class="line"></span><br><span class="line">è¿è¡Œå¦‚ä¸Šå‘½ä»¤ä¼šé‡æ–°ç”Ÿæˆä»¥ä¸‹è¯ä¹¦</span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/apiserver.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/apiserver.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/apiserver-etcd-client.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/apiserver-etcd-client.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/apiserver-kubelet-client.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/front-proxy-client.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/front-proxy-client.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/etcd/healthcheck-client.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/etcd/healthcheck-client.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/etcd/peer.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/etcd/peer.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/etcd/server.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/etcd/server.crt</span></span><br></pre></td></tr></table></figure>
<h5 id="æ›´æ–°-etc-kubernetes-confæ–‡ä»¶"><a href="#æ›´æ–°-etc-kubernetes-confæ–‡ä»¶" class="headerlink" title="æ›´æ–°/etc/kubernetes/*.confæ–‡ä»¶"></a>æ›´æ–°/etc/kubernetes/*.confæ–‡ä»¶</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¤‡ä»½åˆ é™¤æ—§çš„/etc/kubernetes/*.confæ–‡ä»¶</span></span><br><span class="line">mkdir /etc/kubernetes/old-conf  </span><br><span class="line">mv /etc/kubernetes/*.conf /etc/kubernetes/old-conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç”Ÿæˆæ–°çš„confæ–‡ä»¶</span></span><br><span class="line">kubeadm init phase kubeconfig all --config=/root/kubeadm.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œå¦‚ä¸Šå‘½ä»¤ä¼šé‡æ–°ç”Ÿæˆä»¥ä¸‹confæ–‡ä»¶</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/admin.conf</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/controller-manager.conf</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/kubelet.conf</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/scheduler.conf</span></span><br></pre></td></tr></table></figure>
<h5 id="å®Œæˆåé‡å¯kube-apiserver-kube-controller-kube-scheduler-etcdè¿™4ä¸ªå®¹å™¨-æœ€åè¦†ç›–configæ–‡ä»¶"><a href="#å®Œæˆåé‡å¯kube-apiserver-kube-controller-kube-scheduler-etcdè¿™4ä¸ªå®¹å™¨-æœ€åè¦†ç›–configæ–‡ä»¶" class="headerlink" title="å®Œæˆåé‡å¯kube-apiserver,kube-controller,kube-scheduler,etcdè¿™4ä¸ªå®¹å™¨,æœ€åè¦†ç›–configæ–‡ä»¶"></a>å®Œæˆåé‡å¯<code>kube-apiserver</code>,<code>kube-controller</code>,<code>kube-scheduler</code>,<code>etcd</code>è¿™4ä¸ªå®¹å™¨,æœ€åè¦†ç›–configæ–‡ä»¶</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>
<h4 id="é’ˆå¯¹kubeadm-1-13-0ï¼ˆä¸åŒ…å«1-13-0ï¼‰-ä»¥ä¸‹å¤„ç†"><a href="#é’ˆå¯¹kubeadm-1-13-0ï¼ˆä¸åŒ…å«1-13-0ï¼‰-ä»¥ä¸‹å¤„ç†" class="headerlink" title="é’ˆå¯¹kubeadm 1.13.0ï¼ˆä¸åŒ…å«1.13.0ï¼‰ ä»¥ä¸‹å¤„ç†"></a>é’ˆå¯¹kubeadm 1.13.0ï¼ˆä¸åŒ…å«1.13.0ï¼‰ ä»¥ä¸‹å¤„ç†</h4><h5 id="ç§»åŠ¨è¯ä¹¦å’Œé…ç½®ã€æ³¨æ„ï¼å¿…é¡»ç§»åŠ¨ï¼Œä¸ç„¶ä¼šä½¿ç”¨ç°æœ‰çš„è¯ä¹¦ï¼Œä¸ä¼šé‡æ–°ç”Ÿæˆã€‘"><a href="#ç§»åŠ¨è¯ä¹¦å’Œé…ç½®ã€æ³¨æ„ï¼å¿…é¡»ç§»åŠ¨ï¼Œä¸ç„¶ä¼šä½¿ç”¨ç°æœ‰çš„è¯ä¹¦ï¼Œä¸ä¼šé‡æ–°ç”Ÿæˆã€‘" class="headerlink" title="ç§»åŠ¨è¯ä¹¦å’Œé…ç½®ã€æ³¨æ„ï¼å¿…é¡»ç§»åŠ¨ï¼Œä¸ç„¶ä¼šä½¿ç”¨ç°æœ‰çš„è¯ä¹¦ï¼Œä¸ä¼šé‡æ–°ç”Ÿæˆã€‘"></a>ç§»åŠ¨è¯ä¹¦å’Œé…ç½®ã€æ³¨æ„ï¼å¿…é¡»ç§»åŠ¨ï¼Œä¸ç„¶ä¼šä½¿ç”¨ç°æœ‰çš„è¯ä¹¦ï¼Œä¸ä¼šé‡æ–°ç”Ÿæˆã€‘</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/kubernetes</span><br><span class="line">mkdir ./pki_bak</span><br><span class="line">mkdir ./pki_bak/etcd</span><br><span class="line">mkdir ./conf_bak</span><br><span class="line">mv pki/apiserver* ./pki_bak/</span><br><span class="line">mv pki/front-proxy-client.* ./pki_bak/</span><br><span class="line">mv pki/etcd/healthcheck-client.* ./pki_bak/etcd/</span><br><span class="line">mv pki/etcd/peer.* ./pki_bak/etcd/</span><br><span class="line">mv pki/etcd/server.* ./pki_bak/etcd/</span><br><span class="line">mv ./admin.conf ./conf_bak/</span><br><span class="line">mv ./kubelet.conf ./conf_bak/</span><br><span class="line">mv ./controller-manager.conf ./conf_bak/</span><br><span class="line">mv ./scheduler.conf ./conf_bak/</span><br></pre></td></tr></table></figure>
<h5 id="åˆ›å»ºè¯ä¹¦"><a href="#åˆ›å»ºè¯ä¹¦" class="headerlink" title="åˆ›å»ºè¯ä¹¦"></a>åˆ›å»ºè¯ä¹¦</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">kubeadm alpha phase certs all --apiserver-advertise-address=<span class="variable">$&#123;MASTER_API_SERVER_IP&#125;</span> --apiserver-cert-extra-sans=ä¸»æœºå†…ç½‘ip,ä¸»æœºå…¬ç½‘ip</span><br><span class="line"></span><br><span class="line">è¿è¡Œå¦‚ä¸Šå‘½ä»¤ä¼šé‡æ–°ç”Ÿæˆä»¥ä¸‹è¯ä¹¦</span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/apiserver.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/apiserver.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/apiserver-etcd-client.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/apiserver-etcd-client.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/apiserver-kubelet-client.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/front-proxy-client.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/front-proxy-client.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/etcd/healthcheck-client.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/etcd/healthcheck-client.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/etcd/peer.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/etcd/peer.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/etcd/server.key</span></span><br><span class="line"><span class="comment">#-- /etc/kubernetes/pki/etcd/server.crt</span></span><br><span class="line"></span><br><span class="line">ä¸ç§»åŠ¨è¯ä¹¦ä¼šæœ‰å¦‚ä¸‹æç¤º</span><br><span class="line"><span class="comment">#[certificates] Using the existing apiserver certificate and key.</span></span><br><span class="line"><span class="comment">#[certificates] Using the existing apiserver-kubelet-client certificate and key.</span></span><br><span class="line"><span class="comment">#[certificates] Using the existing front-proxy-client certificate and key.</span></span><br><span class="line"><span class="comment">#[certificates] Using the existing etcd/server certificate and key.</span></span><br><span class="line"><span class="comment">#[certificates] Using the existing etcd/peer certificate and key.</span></span><br><span class="line"><span class="comment">#[certificates] Using the existing etcd/healthcheck-client certificate and key.</span></span><br><span class="line"><span class="comment">#[certificates] Using the existing apiserver-etcd-client certificate and key.</span></span><br><span class="line"><span class="comment">#[certificates] valid certificates and keys now exist in "/etc/kubernetes/pki"</span></span><br><span class="line"><span class="comment">#[certificates] Using the existing sa key.</span></span><br></pre></td></tr></table></figure>
<h5 id="ç”Ÿæˆæ–°é…ç½®æ–‡ä»¶"><a href="#ç”Ÿæˆæ–°é…ç½®æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆæ–°é…ç½®æ–‡ä»¶"></a>ç”Ÿæˆæ–°é…ç½®æ–‡ä»¶</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm alpha phase kubeconfig all --apiserver-advertise-address=<span class="variable">$&#123;MASTER_API_SERVER_IP&#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="å°†æ–°ç”Ÿæˆçš„adminé…ç½®æ–‡ä»¶è¦†ç›–æ‰åŸæœ¬çš„adminæ–‡ä»¶"><a href="#å°†æ–°ç”Ÿæˆçš„adminé…ç½®æ–‡ä»¶è¦†ç›–æ‰åŸæœ¬çš„adminæ–‡ä»¶" class="headerlink" title="å°†æ–°ç”Ÿæˆçš„adminé…ç½®æ–‡ä»¶è¦†ç›–æ‰åŸæœ¬çš„adminæ–‡ä»¶"></a>å°†æ–°ç”Ÿæˆçš„adminé…ç½®æ–‡ä»¶è¦†ç›–æ‰åŸæœ¬çš„adminæ–‡ä»¶</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mv <span class="variable">$HOME</span>/.kube/config <span class="variable">$HOME</span>/.kube/config.old</span><br><span class="line">cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chmod 644 <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>
<h5 id="å®Œæˆåé‡å¯kube-apiserver-kube-controller-kube-scheduler-etcdè¿™4ä¸ªå®¹å™¨"><a href="#å®Œæˆåé‡å¯kube-apiserver-kube-controller-kube-scheduler-etcdè¿™4ä¸ªå®¹å™¨" class="headerlink" title="å®Œæˆåé‡å¯kube-apiserver,kube-controller,kube-scheduler,etcdè¿™4ä¸ªå®¹å™¨"></a>å®Œæˆåé‡å¯kube-apiserver,kube-controller,kube-scheduler,etcdè¿™4ä¸ªå®¹å™¨</h5><h5 id="å¦‚æœæœ‰å¤šå°masterï¼Œåˆ™å°†ç¬¬ä¸€å°ç”Ÿæˆçš„ç›¸å…³è¯ä¹¦æ‹·è´åˆ°å…¶ä½™masterå³å¯ã€‚"><a href="#å¦‚æœæœ‰å¤šå°masterï¼Œåˆ™å°†ç¬¬ä¸€å°ç”Ÿæˆçš„ç›¸å…³è¯ä¹¦æ‹·è´åˆ°å…¶ä½™masterå³å¯ã€‚" class="headerlink" title="å¦‚æœæœ‰å¤šå°masterï¼Œåˆ™å°†ç¬¬ä¸€å°ç”Ÿæˆçš„ç›¸å…³è¯ä¹¦æ‹·è´åˆ°å…¶ä½™masterå³å¯ã€‚"></a>å¦‚æœæœ‰å¤šå°masterï¼Œåˆ™å°†ç¬¬ä¸€å°ç”Ÿæˆçš„ç›¸å…³è¯ä¹¦æ‹·è´åˆ°å…¶ä½™masterå³å¯ã€‚</h5><h3 id="ç¦»çº¿ä¸€é”®å®‰è£…åŒ…"><a href="#ç¦»çº¿ä¸€é”®å®‰è£…åŒ…" class="headerlink" title="ç¦»çº¿ä¸€é”®å®‰è£…åŒ…"></a>ç¦»çº¿ä¸€é”®å®‰è£…åŒ…</h3><blockquote>
<p>k8s ç¦»çº¿ä¸€é”®å®‰è£…åŒ…æ•™ç¨‹&amp;&amp;åœ°å€ï¼š<a href="http://team.jiunile.com/pro/k8s/">ä¸€é”®å®‰è£…</a></p>
</blockquote>
<h3 id="kubeadm-1-14-è¯ä¹¦è°ƒæ•´æ•™ç¨‹"><a href="#kubeadm-1-14-è¯ä¹¦è°ƒæ•´æ•™ç¨‹" class="headerlink" title="kubeadm 1.14 è¯ä¹¦è°ƒæ•´æ•™ç¨‹"></a>kubeadm 1.14 è¯ä¹¦è°ƒæ•´æ•™ç¨‹</h3><blockquote>
<p><a href="http://team.jiunile.com/blog/2019/05/k8s-kubeadm14-ca-upgrade.html">æ•™ç¨‹åœ°å€</a></p>
</blockquote>
<p><img src="/images/wx_dyh.png" alt="å¾®ä¿¡è®¢é˜…å·"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Kubeadm è¯ä¹¦è¯´æ˜]]></title>
      <url>http://team.jiunile.com/blog/2018/12/k8s-kubeadm-ca-desc.html</url>
      <content type="html"><![CDATA[<blockquote>
<p>å¦‚æœä½ ä½¿ç”¨è¿‡kubeadméƒ¨ç½²è¿‡Kubernetesçš„ç¯å¢ƒ, masterä¸»æœºèŠ‚ç‚¹ä¸Šå°±ä¸€å®šä¼šåœ¨ç›¸åº”çš„ç›®å½•åˆ›å»ºäº†ä¸€å¤§æ‰¹è¯ä¹¦æ–‡ä»¶, æœ¬ç¯‡æ–‡ç« å°±æ¥è¯´è¯´kubeadmåˆ°åº•ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†å“ªäº›è¯ä¹¦</p>
</blockquote>
<p>åœ¨Kubernetesçš„éƒ¨ç½²ä¸­, åˆ›å»ºè¯ä¹¦, é…ç½®è¯ä¹¦æ˜¯ä¸€é“ç»•ä¸è¿‡å»åå„¿, å¥½åœ¨æœ‰kubeadmè¿™æ ·çš„è‡ªåŠ¨åŒ–å·¥å…·, å¸®æˆ‘ä»¬å»ç”Ÿæˆ, é…ç½®è¿™äº›è¯ä¹¦. å¯¹äºåªæ˜¯æƒ³ä½“éªŒKubernetesæˆ–åªæ˜¯æƒ³æµ‹è¯•çš„äº²æ¥è¯´, è¿™å·²ç»å¤Ÿäº†, ä½†æ˜¯ä½œä¸ºKubernetesçš„é›†ç¾¤ç»´æŠ¤è€…æ¥è¯´, kubeadmæ›´åƒæ˜¯ä¸€ä¸ªé»‘ç›’, æœ¬ç¯‡æ–‡ç« å°±æ¥è¯´è¯´é»‘ç›’ä¸­å…³äºè¯ä¹¦çš„äº‹å„¿~</p>
<p>ä½¿ç”¨kubeadmåˆ›å»ºå®ŒKubernetesé›†ç¾¤å, é»˜è®¤ä¼šåœ¨<code>/etc/kubernetes/pki</code>ç›®å½•ä¸‹å­˜æ”¾é›†ç¾¤ä¸­éœ€è¦ç”¨åˆ°çš„è¯ä¹¦æ–‡ä»¶, æ•´ä½“ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:/etc/kubernetes/pki<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">|-- apiserver.crt</span><br><span class="line">|-- apiserver-etcd-client.crt</span><br><span class="line">|-- apiserver-etcd-client.key</span><br><span class="line">|-- apiserver.key</span><br><span class="line">|-- apiserver-kubelet-client.crt</span><br><span class="line">|-- apiserver-kubelet-client.key</span><br><span class="line">|-- ca.crt</span><br><span class="line">|-- ca.key</span><br><span class="line">|-- etcd</span><br><span class="line">|   |-- ca.crt</span><br><span class="line">|   |-- ca.key</span><br><span class="line">|   |-- healthcheck-client.crt</span><br><span class="line">|   |-- healthcheck-client.key</span><br><span class="line">|   |-- peer.crt</span><br><span class="line">|   |-- peer.key</span><br><span class="line">|   |-- server.crt</span><br><span class="line">|   `-- server.key</span><br><span class="line">|-- front-proxy-ca.crt</span><br><span class="line">|-- front-proxy-ca.key</span><br><span class="line">|-- front-proxy-client.crt</span><br><span class="line">|-- front-proxy-client.key</span><br><span class="line">|-- sa.key</span><br><span class="line">`-- sa.pub</span><br><span class="line"></span><br><span class="line">1 directory, 22 files</span><br></pre></td></tr></table></figure></p>
<p>ä»¥ä¸Š22ä¸ªæ–‡ä»¶å°±æ˜¯kubeadmä¸ºæˆ‘ä»¬åˆ›å»ºçš„æ‰€æœ‰è¯ä¹¦ç›¸å…³çš„æ–‡ä»¶, ä¸‹é¢æˆ‘ä»¬æ¥ä¸€ä¸€è§£æ</p>
<h3 id="è¯ä¹¦åˆ†ç»„"><a href="#è¯ä¹¦åˆ†ç»„" class="headerlink" title="è¯ä¹¦åˆ†ç»„"></a>è¯ä¹¦åˆ†ç»„</h3><p>KubernetesæŠŠè¯ä¹¦æ”¾åœ¨äº†ä¸¤ä¸ªæ–‡ä»¶å¤¹ä¸­</p>
<ul>
<li>/etc/kubernetes/pki</li>
<li>/etc/kubernetes/pki/etcd</li>
</ul>
<p>æˆ‘ä»¬å†å°†è¿™22ä¸ªæ–‡ä»¶æŒ‰ç…§æ›´ç»†çš„ç²’åº¦å»åˆ†ç»„<br><a id="more"></a></p>
<h3 id="Kubernetes-é›†ç¾¤æ ¹è¯ä¹¦"><a href="#Kubernetes-é›†ç¾¤æ ¹è¯ä¹¦" class="headerlink" title="Kubernetes é›†ç¾¤æ ¹è¯ä¹¦"></a>Kubernetes é›†ç¾¤æ ¹è¯ä¹¦</h3><p>Kubernetes é›†ç¾¤æ ¹è¯ä¹¦CA(Kubernetesé›†ç¾¤ç»„ä»¶çš„è¯ä¹¦ç­¾å‘æœºæ„)</p>
<ul>
<li>/etc/kubernetes/pki/ca.crt</li>
<li>/etc/kubernetes/pki/ca.key</li>
</ul>
<p>ä»¥ä¸Šè¿™ç»„è¯ä¹¦ä¸ºç­¾å‘å…¶ä»–Kubernetesç»„ä»¶è¯ä¹¦ä½¿ç”¨çš„æ ¹è¯ä¹¦, å¯ä»¥è®¤ä¸ºæ˜¯Kubernetesé›†ç¾¤ä¸­è¯ä¹¦ç­¾å‘æœºæ„ä¹‹ä¸€</p>
<p>ç”±æ­¤æ ¹è¯ä¹¦ç­¾å‘çš„è¯ä¹¦æœ‰:</p>
<ol>
<li>kube-apiserver ç»„ä»¶æŒæœ‰çš„æœåŠ¡ç«¯è¯ä¹¦</li>
</ol>
<ul>
<li>/etc/kubernetes/pki/apiserver.crt</li>
<li>/etc/kubernetes/pki/apiserver.key</li>
</ul>
<ol>
<li>kubelet ç»„ä»¶æŒæœ‰çš„å®¢æˆ·ç«¯è¯ä¹¦, ç”¨ä½œ kube-apiserver ä¸»åŠ¨å‘ kubelet å‘èµ·è¯·æ±‚æ—¶çš„å®¢æˆ·ç«¯è®¤è¯</li>
</ol>
<ul>
<li>/etc/kubernetes/pki/apiserver-kubelet-client.crt</li>
<li>/etc/kubernetes/pki/apiserver-kubelet-client.key</li>
</ul>
<blockquote>
<p>æ³¨æ„: Kubernetesé›†ç¾¤ç»„ä»¶ä¹‹é—´çš„äº¤äº’æ˜¯åŒå‘çš„, kubelet æ—¢éœ€è¦ä¸»åŠ¨è®¿é—® kube-apiserver, kube-apiserver ä¹Ÿéœ€è¦ä¸»åŠ¨å‘ kubelet å‘èµ·è¯·æ±‚, æ‰€ä»¥åŒæ–¹éƒ½éœ€è¦æœ‰è‡ªå·±çš„æ ¹è¯ä¹¦ä»¥åŠä½¿ç”¨è¯¥æ ¹è¯ä¹¦ç­¾å‘çš„æœåŠ¡ç«¯è¯ä¹¦å’Œå®¢æˆ·ç«¯è¯ä¹¦. åœ¨ kube-apiserver ä¸­, ä¸€èˆ¬æ˜ç¡®æŒ‡å®šç”¨äº https è®¿é—®çš„æœåŠ¡ç«¯è¯ä¹¦å’Œå¸¦æœ‰<code>CN ç”¨æˆ·å</code>ä¿¡æ¯çš„å®¢æˆ·ç«¯è¯ä¹¦. è€Œåœ¨ kubelet çš„å¯åŠ¨é…ç½®ä¸­, ä¸€èˆ¬åªæŒ‡å®šäº† ca æ ¹è¯ä¹¦, è€Œæ²¡æœ‰æ˜ç¡®æŒ‡å®šç”¨äº https è®¿é—®çš„æœåŠ¡ç«¯è¯ä¹¦, è¿™æ˜¯å› ä¸º, åœ¨ç”ŸæˆæœåŠ¡ç«¯è¯ä¹¦æ—¶, ä¸€èˆ¬ä¼šæŒ‡å®šæœåŠ¡ç«¯åœ°å€æˆ–ä¸»æœºå, kube-apiserver ç›¸å¯¹å˜åŒ–ä¸æ˜¯å¾ˆé¢‘ç¹, æ‰€ä»¥åœ¨åˆ›å»ºé›†ç¾¤ä¹‹åˆå°±å¯ä»¥é¢„å…ˆåˆ†é…å¥½ç”¨ä½œ kube-apiserver çš„ IP æˆ–ä¸»æœºå/åŸŸå, ä½†æ˜¯ç”±äºéƒ¨ç½²åœ¨ node èŠ‚ç‚¹ä¸Šçš„ kubelet ä¼šå› ä¸ºé›†ç¾¤è§„æ¨¡çš„å˜åŒ–è€Œé¢‘ç¹å˜åŒ–, è€Œæ— æ³•é¢„çŸ¥ node çš„æ‰€æœ‰ IP ä¿¡æ¯, æ‰€ä»¥ kubelet ä¸Šä¸€èˆ¬ä¸ä¼šæ˜ç¡®æŒ‡å®šæœåŠ¡ç«¯è¯ä¹¦, è€Œæ˜¯åªæŒ‡å®š ca æ ¹è¯ä¹¦, è®© kubelet æ ¹æ®æœ¬åœ°ä¸»æœºä¿¡æ¯è‡ªåŠ¨ç”ŸæˆæœåŠ¡ç«¯è¯ä¹¦å¹¶ä¿å­˜åˆ°é…ç½®çš„<code>cert-dir</code>æ–‡ä»¶å¤¹ä¸­.</p>
</blockquote>
<p>å¥½äº†, è‡³æ­¤, Kubernetesé›†ç¾¤æ ¹è¯ä¹¦æ‰€ç­¾å‘çš„è¯ä¹¦éƒ½åœ¨ä¸Šé¢äº†, ç®—ä¸Šæ ¹è¯ä¹¦ä¸€å…±æ¶‰åŠåˆ°6ä¸ªæ–‡ä»¶, 22-6=16, æˆ‘ä»¬è¿˜å‰©ä¸‹16ä¸ªæ–‡ä»¶</p>
<h3 id="æ±‡èšå±‚è¯ä¹¦"><a href="#æ±‡èšå±‚è¯ä¹¦" class="headerlink" title="æ±‡èšå±‚è¯ä¹¦"></a>æ±‡èšå±‚è¯ä¹¦</h3><p>kube-apiserver çš„å¦ä¸€ç§è®¿é—®æ–¹å¼å°±æ˜¯ä½¿ç”¨ <code>kubectl proxy</code> æ¥ä»£ç†è®¿é—®, è€Œè¯¥è¯ä¹¦å°±æ˜¯ç”¨æ¥æ”¯æŒSSLä»£ç†è®¿é—®çš„. åœ¨è¯¥ç§è®¿é—®æ¨¡å¼ä¸‹, æˆ‘ä»¬æ˜¯ä»¥httpçš„æ–¹å¼å‘èµ·è¯·æ±‚åˆ°ä»£ç†æœåŠ¡çš„, æ­¤æ—¶, ä»£ç†æœåŠ¡ä¼šå°†è¯¥è¯·æ±‚å‘é€ç»™ kube-apiserver, åœ¨æ­¤ä¹‹å‰, ä»£ç†ä¼šå°†å‘é€ç»™ kube-apiserver çš„è¯·æ±‚å¤´é‡ŒåŠ å…¥è¯ä¹¦ä¿¡æ¯, ä»¥ä¸‹ä¸¤ä¸ªé…ç½®</p>
<p>API Aggregationå…è®¸åœ¨ä¸ä¿®æ”¹Kubernetesæ ¸å¿ƒä»£ç çš„åŒæ—¶æ‰©å±•Kubernetes API. å¼€å¯ API Aggregation éœ€è¦åœ¨ kube-apiserver ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--requestheader-client-ca-file=&lt;path to aggregator CA cert&gt;</span><br><span class="line">--requestheader-allowed-names=front-proxy-client</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">--requestheader-group-headers=X-Remote-Group</span><br><span class="line">--requestheader-username-headers=X-Remote-User</span><br><span class="line">--proxy-client-cert-file=&lt;path to aggregator proxy cert&gt;</span><br><span class="line">--proxy-client-key-file=&lt;path to aggregator proxy key&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>å®˜æ–¹è­¦å‘Š: é™¤éä½ äº†è§£ä¿æŠ¤ CA ä½¿ç”¨çš„é£é™©å’Œæœºåˆ¶, å¦åˆ™ä¸è¦åœ¨ä¸é€šä¸Šä¸‹æ–‡ä¸­é‡ç”¨å·²ç»ä½¿ç”¨è¿‡çš„ CA</strong></p>
<p>å¦‚æœ kube-proxy æ²¡æœ‰å’Œ API server è¿è¡Œåœ¨åŒä¸€å°ä¸»æœºä¸Šï¼Œé‚£ä¹ˆéœ€è¦ç¡®ä¿å¯ç”¨äº†å¦‚ä¸‹ apiserver æ ‡è®°ï¼š<code>--enable-aggregator-routing=true</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å®¢æˆ·ç«¯ ---å‘èµ·è¯·æ±‚---&gt; ä»£ç† ---Add Header:å‘èµ·è¯·æ±‚---&gt; kube-apiserver</span><br><span class="line">                   (å®¢æˆ·ç«¯è¯ä¹¦)                        (æœåŠ¡ç«¯è¯ä¹¦)</span><br></pre></td></tr></table></figure>
<p>kube-apiserver ä»£ç†æ ¹è¯ä¹¦(å®¢æˆ·ç«¯è¯ä¹¦)</p>
<p>ç”¨åœ¨<code>requestheader-client-ca-file</code>é…ç½®é€‰é¡¹ä¸­, kube-apiserver ä½¿ç”¨è¯¥è¯ä¹¦æ¥éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦æ˜¯å¦ä¸ºè‡ªå·±æ‰€ç­¾å‘</p>
<ul>
<li>/etc/kubernetes/pki/front-proxy-ca.crt</li>
<li>/etc/kubernetes/pki/front-proxy-ca.key</li>
</ul>
<p>ç”±æ­¤æ ¹è¯ä¹¦ç­¾å‘çš„è¯ä¹¦åªæœ‰ä¸€ç»„:</p>
<p>ä»£ç†å±‚(å¦‚æ±‡èšå±‚aggregator)ä½¿ç”¨æ­¤å¥—ä»£ç†è¯ä¹¦æ¥å‘ kube-apiserver è¯·æ±‚è®¤è¯</p>
<ol>
<li>ä»£ç†ç«¯ä½¿ç”¨çš„å®¢æˆ·ç«¯è¯ä¹¦, ç”¨ä½œä»£ç”¨æˆ·ä¸ kube-apiserver è®¤è¯</li>
</ol>
<ul>
<li>/etc/kubernetes/pki/front-proxy-client.crt</li>
<li>/etc/kubernetes/pki/front-proxy-client.key</li>
</ul>
<p>å‚è€ƒæ–‡æ¡£:</p>
<ul>
<li>kube-apiserver é…ç½®å‚æ•°: <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver" target="_blank" rel="external">https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver</a></li>
<li>ä½¿ç”¨æ±‡èšå±‚æ‰©å±• Kubernetes API: <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/" target="_blank" rel="external">https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation</a></li>
<li>é…ç½®æ±‡èšå±‚: <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/configure-aggregation-layer/" target="_blank" rel="external">https://kubernetes.io/docs/tasks/access-kubernetes-api/configure-aggregation-layer</a></li>
</ul>
<p>è‡³æ­¤, åˆ¨é™¤ä»£ç†ä¸“ç”¨çš„è¯ä¹¦å¤–, è¿˜å‰©ä¸‹ 16-4=12 ä¸ªæ–‡ä»¶</p>
<h3 id="etcd-é›†ç¾¤æ ¹è¯ä¹¦"><a href="#etcd-é›†ç¾¤æ ¹è¯ä¹¦" class="headerlink" title="etcd é›†ç¾¤æ ¹è¯ä¹¦"></a>etcd é›†ç¾¤æ ¹è¯ä¹¦</h3><p>etcdé›†ç¾¤æ‰€ç”¨åˆ°çš„è¯ä¹¦éƒ½ä¿å­˜åœ¨<code>/etc/kubernetes/pki/etcd</code>è¿™è·¯å¾„ä¸‹, å¾ˆæ˜æ˜¾, è¿™ä¸€å¥—è¯ä¹¦æ˜¯ç”¨æ¥ä¸“é—¨ç»™etcdé›†ç¾¤æœåŠ¡ä½¿ç”¨çš„, è®¾è®¡ä»¥ä¸‹è¯ä¹¦æ–‡ä»¶</p>
<p>etcd é›†ç¾¤æ ¹è¯ä¹¦CA(etcd æ‰€ç”¨åˆ°çš„æ‰€æœ‰è¯ä¹¦çš„ç­¾å‘æœºæ„)</p>
<ul>
<li>/etc/kubernetes/pki/etcd/ca.crt</li>
<li>/etc/kubernetes/pki/etcd/ca.key</li>
</ul>
<p>ç”±æ­¤æ ¹è¯ä¹¦ç­¾å‘æœºæ„ç­¾å‘çš„è¯ä¹¦æœ‰:</p>
<ol>
<li>etcd server æŒæœ‰çš„æœåŠ¡ç«¯è¯ä¹¦</li>
</ol>
<ul>
<li>/etc/kubernetes/pki/etcd/server.crt</li>
<li>/etc/kubernetes/pki/etcd/server.key</li>
</ul>
<ol>
<li>peer é›†ç¾¤ä¸­èŠ‚ç‚¹äº’ç›¸é€šä¿¡ä½¿ç”¨çš„å®¢æˆ·ç«¯è¯ä¹¦</li>
</ol>
<ul>
<li>/etc/kubernetes/pki/etcd/peer.crt</li>
<li>/etc/kubernetes/pki/etcd/peer.key</li>
</ul>
<p>æ³¨: Peerï¼šå¯¹åŒä¸€ä¸ªetcdé›†ç¾¤ä¸­å¦å¤–ä¸€ä¸ªMemberçš„ç§°å‘¼</p>
<ol>
<li>pod ä¸­å®šä¹‰ Liveness æ¢é’ˆä½¿ç”¨çš„å®¢æˆ·ç«¯è¯ä¹¦<br> kubeadm éƒ¨ç½²çš„ Kubernetes é›†ç¾¤æ˜¯ä»¥ pod çš„æ–¹å¼è¿è¡Œ etcd æœåŠ¡çš„, åœ¨è¯¥ pod çš„å®šä¹‰ä¸­, é…ç½®äº† Liveness æ¢æ´»æ¢é’ˆ</li>
</ol>
<ul>
<li>/etc/kubernetes/pki/etcd/healthcheck-client.crt</li>
<li>/etc/kubernetes/pki/etcd/healthcheck-client.key<br>å½“ä½  describe etcd çš„ pod æ—¶, ä¼šçœ‹åˆ°å¦‚ä¸‹ä¸€è¡Œé…ç½®:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Liveness:       <span class="built_in">exec</span> [/bin/sh -ec ETCDCTL_API=3 etcdctl --endpoints=https://[127.0.0.1]:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt --key=/etc/kubernetes/pki/etcd/healthcheck-client.key get foo] delay=15s timeout=15s period=10s <span class="comment">#success=1 #failure=8</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol>
<li>é…ç½®åœ¨ kube-apiserver ä¸­ç”¨æ¥ä¸ etcd server åšåŒå‘è®¤è¯çš„å®¢æˆ·ç«¯è¯ä¹¦</li>
</ol>
<ul>
<li>/etc/kubernetes/pki/apiserver-etcd-client.crt</li>
<li>/etc/kubernetes/pki/apiserver-etcd-client.key</li>
</ul>
<p>è‡³æ­¤, ä»‹ç»äº†æ¶‰åŠåˆ° etcd æœåŠ¡çš„10ä¸ªè¯ä¹¦æ–‡ä»¶, 12-10=2, ä»…å‰©ä¸¤ä¸ªæ²¡æœ‰ä»‹ç»åˆ°çš„æ–‡ä»¶å•¦, èƒœåˆ©åœ¨æœ›, åšæŒä¸€ä¸‹~</p>
<h3 id="Serveice-Accountç§˜é’¥"><a href="#Serveice-Accountç§˜é’¥" class="headerlink" title="Serveice Accountç§˜é’¥"></a>Serveice Accountç§˜é’¥</h3><p>æœ€åä»‹ç»çš„è¿™ç»„â€è¯ä¹¦â€å…¶å®ä¸æ˜¯è¯ä¹¦, è€Œæ˜¯ä¸€ç»„ç§˜é’¥. çœ‹ç€åç¼€åæ˜¯ä¸æ˜¯æœ‰ç‚¹çœ¼ç†Ÿå‘¢, æ²¡é”™, è¿™ç»„ç§˜é’¥å¯¹å„¿å…¶å®è·Ÿæˆ‘ä»¬åœ¨Linuxä¸Šåˆ›å»º, ç”¨äºå…å¯†ç™»å½•çš„å¯†é’¥å¯¹å„¿åŸç†æ˜¯ä¸€æ ·çš„~</p>
<blockquote>
<p>è¿™ç»„çš„å¯†é’¥å¯¹å„¿ä»…æä¾›ç»™ kube-controller-manager ä½¿ç”¨. kube-controller-manager é€šè¿‡ sa.key å¯¹ token è¿›è¡Œç­¾å, master èŠ‚ç‚¹é€šè¿‡å…¬é’¥ sa.pub è¿›è¡Œç­¾åçš„éªŒè¯</p>
</blockquote>
<ul>
<li>/etc/kubernetes/pki/sa.key</li>
<li>/etc/kubernetes/pki/sa.pub</li>
</ul>
<p>è‡³æ­¤, kubeadm å·¥å…·å¸®æˆ‘ä»¬åˆ›å»ºçš„æ‰€æœ‰è¯ä¹¦æ–‡ä»¶éƒ½å·²ç»ä»‹ç»å®Œäº†, æ•´ä¸ª Kubernetes&amp;etcd é›†ç¾¤ä¸­æ‰€æ¶‰åŠåˆ°çš„ç»å¤§éƒ¨åˆ†è¯ä¹¦éƒ½å·®ä¸å¤šåœ¨è¿™é‡Œäº†. æœ‰çš„è¡Œå®¶å¯èƒ½ä¼šçœ‹å‡ºæ¥, è‡³å°‘è¿˜å°‘äº†ä¸€ç»„è¯ä¹¦å‘€, å°±æ˜¯ kube-proxy æŒæœ‰çš„è¯ä¹¦æ€ä¹ˆæ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆå‘€. å› ä¸º kubeadm åˆ›å»ºçš„é›†ç¾¤, kube-proxy æ˜¯ä»¥ pod å½¢å¼è¿è¡Œçš„, åœ¨ pod ä¸­, ç›´æ¥ä½¿ç”¨ service account ä¸ kube-apiserver è¿›è¡Œè®¤è¯, æ­¤æ—¶å°±ä¸éœ€è¦å†å•ç‹¬ä¸º kube-proxy åˆ›å»ºè¯ä¹¦äº†. å¦‚æœä½ çš„ kube-proxy æ˜¯ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼ç›´æ¥è¿è¡Œåœ¨å®¿ä¸»æœºçš„, é‚£ä¹ˆä½ å°±éœ€è¦ä¸ºå®ƒåˆ›å»ºä¸€å¥—è¯ä¹¦äº†. åˆ›å»ºçš„æ–¹å¼ä¹Ÿå¾ˆç®€å•, ç›´æ¥ä½¿ç”¨ä¸Šé¢ç¬¬ä¸€æ¡æåˆ°çš„ <code>Kubernetes é›†ç¾¤æ ¹è¯ä¹¦</code> è¿›è¡Œç­¾å‘å°±å¯ä»¥äº†(æ³¨æ„CNå’ŒOçš„è®¾ç½®)</p>
<p>å‚è€ƒæ–‡æ¡£:</p>
<ul>
<li><a href="https://kubernetes.io/docs/setup/certificates/" target="_blank" rel="external">https://kubernetes.io/docs/setup/certificates/</a></li>
<li><a href="https://kubernetes.io/docs/setup/independent/setup-ha-etcd-with-kubeadm/" target="_blank" rel="external">https://kubernetes.io/docs/setup/independent/setup-ha-etcd-with-kubeadm/</a></li>
<li>docs.lvrui.io</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Kubernetes Pod çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†]]></title>
      <url>http://team.jiunile.com/blog/2018/11/k8s-k8s-pod-life-cycle.html</url>
      <content type="html"><![CDATA[<h2 id="Podçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#Podçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Podçš„ç”Ÿå‘½å‘¨æœŸ"></a>Podçš„ç”Ÿå‘½å‘¨æœŸ</h2><hr>
<h3 id="Pod-phase"><a href="#Pod-phase" class="headerlink" title="Pod phase"></a>Pod phase</h3><p>Pod çš„ status åœ¨ä¿¡æ¯ä¿å­˜åœ¨ <a href="https://github.com/kubernetes/kubernetes/blob/3ae0b84e0b114692dc666d9486fb032d8a33bb58/pkg/api/types.go#L2471" target="_blank" rel="external">PodStatus</a> ä¸­å®šä¹‰ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª phase å­—æ®µã€‚</p>
<p>Pod çš„ç›¸ä½ï¼ˆphaseï¼‰æ˜¯ Pod åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­çš„ç®€å•å®è§‚æ¦‚è¿°ã€‚è¯¥é˜¶æ®µå¹¶ä¸æ˜¯å¯¹å®¹å™¨æˆ– Pod çš„ç»¼åˆæ±‡æ€»ï¼Œä¹Ÿä¸æ˜¯ä¸ºäº†åšä¸ºç»¼åˆçŠ¶æ€æœºã€‚</p>
<p>Pod ç›¸ä½çš„æ•°é‡å’Œå«ä¹‰æ˜¯ä¸¥æ ¼æŒ‡å®šçš„ã€‚é™¤äº†æœ¬æ–‡æ¡£ä¸­åˆ—ä¸¾çš„çŠ¶æ€å¤–ï¼Œä¸åº”è¯¥å†å‡å®š Pod æœ‰å…¶ä»–çš„ phase å€¼ã€‚</p>
<p>æ— è®ºä½ æ˜¯æ‰‹åŠ¨åˆ›å»º Podï¼Œè¿˜æ˜¯é€šè¿‡ deploymentã€daemonset æˆ– statefulsetæ¥åˆ›å»ºï¼ŒPod çš„ phase éƒ½æœ‰ä»¥ä¸‹å‡ ä¸ªå¯èƒ½çš„å€¼ï¼š</p>
<ul>
<li><strong>æŒ‚èµ·ï¼ˆPendingï¼‰</strong>ï¼šPod å·²è¢« Kubernetes ç³»ç»Ÿæ¥å—ï¼Œä½†æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨é•œåƒå°šæœªåˆ›å»ºã€‚ç­‰å¾…æ—¶é—´åŒ…æ‹¬è°ƒåº¦ Pod çš„æ—¶é—´å’Œé€šè¿‡ç½‘ç»œä¸‹è½½é•œåƒçš„æ—¶é—´ï¼Œè¿™å¯èƒ½éœ€è¦èŠ±ç‚¹æ—¶é—´ã€‚</li>
<li><strong>è¿è¡Œä¸­ï¼ˆRunningï¼‰</strong>ï¼šè¯¥ Pod å·²ç»ç»‘å®šåˆ°äº†ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼ŒPod ä¸­æ‰€æœ‰çš„å®¹å™¨éƒ½å·²è¢«åˆ›å»ºã€‚è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨æ­£åœ¨è¿è¡Œï¼Œæˆ–è€…æ­£å¤„äºå¯åŠ¨æˆ–é‡å¯çŠ¶æ€ã€‚</li>
<li><strong>æˆåŠŸï¼ˆSuccessedï¼‰</strong>ï¼šPod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½è¢«æˆåŠŸç»ˆæ­¢ï¼Œå¹¶ä¸”ä¸ä¼šå†é‡å¯ã€‚</li>
<li><strong>å¤±è´¥ï¼ˆFailedï¼‰</strong>ï¼šPod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²ç»ˆæ­¢äº†ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨æ˜¯å› ä¸ºå¤±è´¥ç»ˆæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®¹å™¨ä»¥é0çŠ¶æ€é€€å‡ºæˆ–è€…è¢«ç³»ç»Ÿç»ˆæ­¢ã€‚</li>
<li><strong>æœªçŸ¥ï¼ˆUnkonwnï¼‰</strong>ï¼šå› ä¸ºæŸäº›åŸå› æ— æ³•å–å¾— Pod çš„çŠ¶æ€ï¼Œé€šå¸¸æ˜¯å› ä¸ºä¸ Pod æ‰€åœ¨ä¸»æœºé€šä¿¡å¤±è´¥ã€‚</li>
</ul>
<p>ä¸‹å›¾æ˜¯ Pod çš„ç”Ÿå‘½å‘¨æœŸç¤ºæ„å›¾ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ° Pod çŠ¶æ€çš„å˜åŒ–ã€‚<br><img src="/images/k8s/k8s_pod_01.jpg" alt="K8s pod ç”Ÿå‘½å‘¨æœŸ"></p>
<a id="more"></a>
<h3 id="Pod-çŠ¶æ€"><a href="#Pod-çŠ¶æ€" class="headerlink" title="Pod çŠ¶æ€"></a>Pod çŠ¶æ€</h3><p>Pod æœ‰ä¸€ä¸ª PodStatus å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª <a href="https://github.com/kubernetes/kubernetes/blob/3ae0b84e0b114692dc666d9486fb032d8a33bb58/pkg/api/types.go#L1964" target="_blank" rel="external">PodCondition</a> æ•°ç»„ã€‚ PodCondition æ•°ç»„çš„æ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ª type å­—æ®µå’Œä¸€ä¸ª status å­—æ®µã€‚type å­—æ®µæ˜¯å­—ç¬¦ä¸²ï¼Œå¯èƒ½çš„å€¼æœ‰ <code>PodScheduled</code>ã€<code>Ready</code>ã€<code>Initialized</code> å’Œ <code>Unschedulable</code>ã€‚status å­—æ®µæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¯èƒ½çš„å€¼æœ‰ <code>True</code>ã€<code>False</code> å’Œ <code>Unknown</code>ã€‚</p>
<p>å½“ä½ é€šè¿‡ <code>kubectl get pod</code> æŸ¥çœ‹ Pod æ—¶ï¼Œ<code>STATUS</code> è¿™ä¸€åˆ—å¯èƒ½ä¼šæ˜¾ç¤ºä¸ä¸Šè¿°5ä¸ªçŠ¶æ€ä¸åŒçš„å€¼ï¼Œä¾‹å¦‚ <code>Init:0/1</code> å’Œ <code>CrashLoopBackOff</code>ã€‚è¿™æ˜¯å› ä¸º Pod çŠ¶æ€çš„å®šä¹‰é™¤äº†åŒ…å« phase ä¹‹å¤–ï¼Œè¿˜æœ‰ <code>InitContainerStatuses</code> å’Œ <code>containerStatuses</code> ç­‰å…¶ä»–å­—æ®µï¼Œå…·ä½“ä»£ç å‚è€ƒ <a href="https://github.com/kubernetes/kubernetes/blob/3ae0b84e0b114692dc666d9486fb032d8a33bb58/pkg/api/types.go#L2471" target="_blank" rel="external">overall status of a pod</a> .</p>
<p>å¦‚æœæƒ³çŸ¥é“ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ <code>kubectl describe pod/$PODNAME</code> æŸ¥çœ‹è¾“å‡ºä¿¡æ¯çš„ <code>Events</code> æ¡ç›®ã€‚é€šè¿‡ Events æ¡ç›®å¯ä»¥çœ‹åˆ°ä¸€äº›å…·ä½“çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ­£åœ¨æ‹‰å–å®¹å™¨é•œåƒï¼ŒPod å·²ç»è¢«è°ƒåº¦ï¼Œæˆ–è€…æŸä¸ª container å¤„äº unhealthy çŠ¶æ€ã€‚</p>
<h2 id="Pod-çš„å¯åŠ¨å…³é—­æµç¨‹"><a href="#Pod-çš„å¯åŠ¨å…³é—­æµç¨‹" class="headerlink" title="Pod çš„å¯åŠ¨å…³é—­æµç¨‹"></a>Pod çš„å¯åŠ¨å…³é—­æµç¨‹</h2><hr>
<p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªå…·ä½“çš„ç¤ºä¾‹æ¥æ¢ç©¶ä¸€ä¸‹ Pod çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæµç¨‹ã€‚ä¸ºäº†ç¡®å®šäº‹æƒ…å‘ç”Ÿçš„é¡ºåºï¼Œé€šè¿‡ä¸‹é¢çš„ manifest æ¥éƒ¨ç½²ä¸€ä¸ª deploymentã€‚<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span>                   Deployment</span><br><span class="line"><span class="attr">apiVersion:</span>             apps/v1beta1</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span>                 loap</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span>             <span class="number">1</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span>            loap</span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line"><span class="attr">      - name:</span>           init</span><br><span class="line"><span class="attr">        image:</span>          busybox</span><br><span class="line"><span class="attr">        command:</span>       [<span class="string">'sh'</span>, <span class="string">'-c'</span>, <span class="string">'echo $(date +%s): INIT &gt;&gt; /loap/timing'</span>]</span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span>    /loap</span><br><span class="line"><span class="attr">          name:</span>         timing</span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span>           main</span><br><span class="line"><span class="attr">        image:</span>          busybox</span><br><span class="line"><span class="attr">        command:</span>       [<span class="string">'sh'</span>, <span class="string">'-c'</span>, <span class="string">'echo $(date +%s): START &gt;&gt; /loap/timing;</span><br><span class="line">sleep 10; echo $(date +%s): END &gt;&gt; /loap/timing;'</span>]</span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span>    /loap</span><br><span class="line"><span class="attr">          name:</span>         timing</span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          exec:</span></span><br><span class="line"><span class="attr">            command:</span>   [<span class="string">'sh'</span>, <span class="string">'-c'</span>, <span class="string">'echo $(date +%s): LIVENESS &gt;&gt; /loap/timing'</span>]</span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          exec:</span></span><br><span class="line"><span class="attr">            command:</span>   [<span class="string">'sh'</span>, <span class="string">'-c'</span>, <span class="string">'echo $(date +%s): READINESS &gt;&gt; /loap/timing'</span>]</span><br><span class="line"><span class="attr">        lifecycle:</span></span><br><span class="line"><span class="attr">          postStart:</span></span><br><span class="line"><span class="attr">            exec:</span></span><br><span class="line"><span class="attr">              command:</span>   [<span class="string">'sh'</span>, <span class="string">'-c'</span>, <span class="string">'echo $(date +%s): POST-START &gt;&gt; /loap/timing'</span>]</span><br><span class="line"><span class="attr">          preStop:</span></span><br><span class="line"><span class="attr">            exec:</span></span><br><span class="line"><span class="attr">              command:</span>  [<span class="string">'sh'</span>, <span class="string">'-c'</span>, <span class="string">'echo $(date +%s): PRE-HOOK &gt;&gt; /loap/timing'</span>]</span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span>           timing</span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span>         /tmp/loap</span><br></pre></td></tr></table></figure></p>
<p>ç­‰å¾… Pod çŠ¶æ€å˜ä¸º <code>Running</code> ä¹‹åï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥å¼ºåˆ¶åœæ­¢ Podï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale deployment loap --replicas=0</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹ <code>/tmp/loap/timing</code> æ–‡ä»¶çš„å†…å®¹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cat /tmp/loap/timing</span><br><span class="line"></span><br><span class="line">1525334577: INIT</span><br><span class="line">1525334581: START</span><br><span class="line">1525334581: POST-START</span><br><span class="line">1525334584: READINESS</span><br><span class="line">1525334584: LIVENESS</span><br><span class="line">1525334588: PRE-HOOK</span><br><span class="line">1525334589: END</span><br></pre></td></tr></table></figure></p>
<p><code>/tmp/loap/timing</code> æ–‡ä»¶çš„å†…å®¹å¾ˆå¥½åœ°ä½“ç°äº† Pod çš„å¯åŠ¨å’Œå…³é—­æµç¨‹ï¼Œå…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š<br><img src="/images/k8s/k8s_pod_02.jpg" alt="Pod çš„å¯åŠ¨å’Œå…³é—­æµç¨‹"></p>
<ol>
<li>é¦–å…ˆå¯åŠ¨ä¸€ä¸ª Infra å®¹å™¨ï¼ˆåˆå« Pause å®¹å™¨ï¼‰ï¼Œç”¨æ¥å’Œ Pod ä¸­çš„å…¶ä»–å®¹å™¨å…±äº« linux å‘½åç©ºé—´ï¼Œå¹¶å¼€å¯ init è¿›ç¨‹ã€‚ï¼ˆä¸Šå›¾ä¸­å¿½ç•¥äº†è¿™ä¸€æ­¥ï¼‰</li>
<li>ç„¶åå¯åŠ¨ Init å®¹å™¨ï¼Œå®ƒæ˜¯ä¸€ç§ä¸“ç”¨çš„å®¹å™¨ï¼Œåœ¨åº”ç”¨ç¨‹åºå®¹å™¨å¯åŠ¨ä¹‹å‰è¿è¡Œï¼Œç”¨æ¥å¯¹ Pod è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œå¹¶åŒ…æ‹¬ä¸€äº›åº”ç”¨é•œåƒä¸­ä¸å­˜åœ¨çš„å®ç”¨å·¥å…·å’Œå®‰è£…è„šæœ¬ã€‚</li>
<li>4 ç§’ä¹‹åï¼Œåº”ç”¨ç¨‹åºå®¹å™¨å’Œ <code>post-start hook</code> åŒæ—¶å¯åŠ¨ã€‚</li>
<li>7 ç§’ä¹‹åå¼€å§‹å¯åŠ¨ <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/" target="_blank" rel="external">liveness å’Œ readiness æ¢é’ˆ</a>ã€‚</li>
<li>11 ç§’ä¹‹åï¼Œé€šè¿‡æ‰‹åŠ¨æ€æ‰ Podï¼Œ<code>pre-stop hook</code> æ‰§è¡Œï¼Œä¼˜é›…åˆ é™¤æœŸé™è¿‡æœŸåï¼ˆé»˜è®¤æ˜¯ 30 ç§’ï¼‰ï¼Œåº”ç”¨ç¨‹åºå®¹å™¨åœæ­¢ã€‚å®é™…çš„ Pod ç»ˆæ­¢è¿‡ç¨‹è¦æ›´å¤æ‚ï¼Œå…·ä½“å‚è€ƒ <a href="https://jimmysong.io/kubernetes-handbook/concepts/pod.html" target="_blank" rel="external">Pod çš„ç»ˆæ­¢</a>ã€‚</li>
</ol>
<blockquote>
<p>å¿…é¡»ä¸»åŠ¨æ€æ‰ Pod æ‰ä¼šè§¦å‘ <code>pre-stop hook</code>ï¼Œå¦‚æœæ˜¯ Pod è‡ªå·± Down æ‰ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œ <code>pre-stop hook</code>ã€‚</p>
</blockquote>
<h2 id="å¦‚ä½•å¿«é€Ÿ-DEBUG"><a href="#å¦‚ä½•å¿«é€Ÿ-DEBUG" class="headerlink" title="å¦‚ä½•å¿«é€Ÿ DEBUG"></a>å¦‚ä½•å¿«é€Ÿ DEBUG</h2><hr>
<p>å½“ Pod å‡ºç°è‡´å‘½çš„é”™è¯¯æ—¶ï¼Œå¦‚æœèƒ½å¤Ÿå¿«é€Ÿ DEBUGï¼Œå°†ä¼šå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½é—®é¢˜ã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„ï¼Œå¯ä»¥æŠŠæŠŠè‡´å‘½äº‹ä»¶çš„ä¿¡æ¯é€šè¿‡ <code>.spec.terminationMessagePath</code> é…ç½®å†™å…¥æŒ‡å®šä½ç½®çš„æ–‡ä»¶ï¼Œå°±åƒæ‰“å°é”™è¯¯ã€å¼‚å¸¸å’Œå †æ ˆä¿¡æ¯ä¸€æ ·ã€‚è¯¥ä½ç½®çš„å†…å®¹å¯ä»¥å¾ˆæ–¹ä¾¿çš„é€šè¿‡ dashboardsã€ç›‘æ§è½¯ä»¶ç­‰å·¥å…·æ£€ç´¢å’Œå±•ç¤ºï¼Œé»˜è®¤è·¯å¾„ä¸º <code>/dev/termination-log</code>ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå°ä¾‹å­ï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># termination-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> v1</span><br><span class="line"><span class="attr">kind:</span> Pod</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> termination-demo</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> termination-demo-container</span><br><span class="line"><span class="attr">    image:</span> alpine</span><br><span class="line"><span class="attr">    command:</span> [<span class="string">"/bin/sh"</span>]</span><br><span class="line"><span class="attr">    args:</span> [<span class="string">"-c"</span>, <span class="string">"sleep 10 &amp;&amp; echo Sleep expired &gt; /dev/termination-log"</span>]</span><br></pre></td></tr></table></figure></p>
<p>è¿™äº›æ¶ˆæ¯çš„æœ€åéƒ¨åˆ†ä¼šä½¿ç”¨å…¶ä»–çš„è§„å®šæ¥å•ç‹¬å­˜å‚¨ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create <span class="_">-f</span> termination-demo.yaml</span><br><span class="line"></span><br><span class="line">$ sleep 20</span><br><span class="line"></span><br><span class="line">$ kubectl get pod termination-demo -o go-template=<span class="string">'&#123;&#123;range .status.containerStatuses&#125;&#125;&#123;&#123;.lastState.terminated.message&#125;&#125;&#123;&#123;end&#125;&#125;'</span></span><br><span class="line"></span><br><span class="line">Sleep expired</span><br><span class="line"></span><br><span class="line">$ kubectl get pod termination-demo -o go-template=<span class="string">'&#123;&#123;range .status.containerStatuses&#125;&#125;&#123;&#123;.lastState.terminated.exitCode&#125;&#125;&#123;&#123;end&#125;&#125;'</span></span><br><span class="line"></span><br><span class="line">0</span><br></pre></td></tr></table></figure></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><hr>
<ul>
<li><a href="https://jimmysong.io/kubernetes-handbook/concepts/pod-hook.html" target="_blank" rel="external">Pod hook</a></li>
<li><a href="https://blog.openshift.com/kubernetes-pods-life/" target="_blank" rel="external">Kubernetes: A Podâ€™s Life</a></li>
<li><a href="https://k8smeetup.github.io/docs/tasks/debug-application-cluster/determine-reason-pod-failure/" target="_blank" rel="external">ç¡®å®š Pod å¤±è´¥çš„åŸå› </a></li>
<li>Ryan Yang </li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Javaå’ŒDockeré™åˆ¶çš„é‚£äº›äº‹å„¿]]></title>
      <url>http://team.jiunile.com/blog/2018/07/docker-java%E4%B8%8Edocker%E7%9A%84%E9%82%A3%E7%82%B9%E4%BA%8B.html</url>
      <content type="html"><![CDATA[<h2 id="æ­ç§˜"><a href="#æ­ç§˜" class="headerlink" title="æ­ç§˜"></a>æ­ç§˜</h2><p>Javaå’ŒDockerä¸æ˜¯å¤©ç„¶çš„æœ‹å‹ã€‚ Dockerå¯ä»¥è®¾ç½®å†…å­˜å’ŒCPUé™åˆ¶ï¼Œè€ŒJavaä¸èƒ½è‡ªåŠ¨æ£€æµ‹åˆ°ã€‚ä½¿ç”¨Javaçš„Xmxæ ‡è¯†ï¼ˆç¹ç/é‡å¤ï¼‰æˆ–æ–°çš„å®éªŒæ€§JVMæ ‡è¯†ï¼Œæˆ‘ä»¬å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="è™šæ‹ŸåŒ–ä¸­çš„ä¸åŒ¹é…"><a href="#è™šæ‹ŸåŒ–ä¸­çš„ä¸åŒ¹é…" class="headerlink" title="è™šæ‹ŸåŒ–ä¸­çš„ä¸åŒ¹é…"></a>è™šæ‹ŸåŒ–ä¸­çš„ä¸åŒ¹é…</h2><p>Javaå’ŒDockerçš„ç»“åˆå¹¶ä¸æ˜¯å®Œç¾åŒ¹é…çš„ï¼Œæœ€åˆçš„æ—¶å€™ç¦»å®Œç¾åŒ¹é…æœ‰ç›¸å½“å¤§çš„è·ç¦»ã€‚å¯¹äºåˆå­¦è€…æ¥è¯´ï¼ŒJVMçš„å…¨éƒ¨è®¾æƒ³å°±æ˜¯ï¼Œè™šæ‹Ÿæœºå¯ä»¥è®©ç¨‹åºä¸åº•å±‚ç¡¬ä»¶æ— å…³ã€‚</p>
<p>é‚£ä¹ˆï¼ŒæŠŠæˆ‘ä»¬çš„Javaåº”ç”¨æ‰“åŒ…åˆ°JVMä¸­ï¼Œç„¶åæ•´ä¸ªå†å¡è¿›Dockerå®¹å™¨ä¸­ï¼Œèƒ½ç»™æˆ‘ä»¬å¸¦æ¥ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ åªæ˜¯åœ¨å¤åˆ¶JVMså’ŒLinuxå®¹å™¨ï¼Œé™¤äº†æµªè´¹æ›´å¤šçš„å†…å­˜ï¼Œæ²¡ä»»ä½•å¥½å¤„ã€‚æ„Ÿè§‰è¿™æ ·å­æŒºå‚»çš„ã€‚</p>
<p>ä¸è¿‡ï¼ŒDockerå¯ä»¥æŠŠä½ çš„ç¨‹åºï¼Œè®¾ç½®ï¼Œç‰¹å®šçš„JDKï¼ŒLinuxè®¾ç½®å’Œåº”ç”¨æœåŠ¡å™¨ï¼Œè¿˜æœ‰å…¶ä»–å·¥å…·æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œå½“åšä¸€ä¸ªä¸œè¥¿ã€‚ç«™åœ¨DevOps/Cloudçš„è§’åº¦æ¥çœ‹ï¼Œè¿™æ ·ä¸€ä¸ªå®Œæ•´çš„å®¹å™¨æœ‰ç€æ›´é«˜å±‚æ¬¡çš„å°è£…ã€‚</p>
<h3 id="é—®é¢˜ä¸€ï¼šå†…å­˜"><a href="#é—®é¢˜ä¸€ï¼šå†…å­˜" class="headerlink" title="é—®é¢˜ä¸€ï¼šå†…å­˜"></a>é—®é¢˜ä¸€ï¼šå†…å­˜</h3><p>æ—¶è‡³ä»Šæ—¥ï¼Œç»å¤§å¤šæ•°äº§å“çº§åº”ç”¨ä»ç„¶åœ¨ä½¿ç”¨Java 8ï¼ˆæˆ–è€…æ›´æ—§çš„ç‰ˆæœ¬ï¼‰ï¼Œè€Œè¿™å¯èƒ½ä¼šå¸¦æ¥é—®é¢˜ã€‚Java 8ï¼ˆupdate 131ä¹‹å‰çš„ç‰ˆæœ¬ï¼‰è·ŸDockeræ— æ³•å¾ˆå¥½åœ°ä¸€èµ·å·¥ä½œã€‚é—®é¢˜æ˜¯åœ¨ä½ çš„æœºå™¨ä¸Šï¼ŒJVMçš„å¯ç”¨å†…å­˜å’ŒCPUæ•°é‡å¹¶ä¸æ˜¯Dockerå…è®¸ä½ ä½¿ç”¨çš„å¯ç”¨å†…å­˜å’ŒCPUæ•°é‡ã€‚</p>
<p>æ¯”å¦‚ï¼Œå¦‚æœä½ é™åˆ¶äº†ä½ çš„Dockerå®¹å™¨åªèƒ½ä½¿ç”¨100MBå†…å­˜ï¼Œä½†æ˜¯å‘¢ï¼Œæ—§ç‰ˆæœ¬çš„Javaå¹¶ä¸èƒ½è¯†åˆ«è¿™ä¸ªé™åˆ¶ã€‚Javaçœ‹ä¸åˆ°è¿™ä¸ªé™åˆ¶ã€‚JVMä¼šè¦æ±‚æ›´å¤šå†…å­˜ï¼Œè€Œä¸”è¿œè¶…è¿™ä¸ªé™åˆ¶ã€‚å¦‚æœä½¿ç”¨å¤ªå¤šå†…å­˜ï¼ŒDockerå°†é‡‡å–è¡ŒåŠ¨å¹¶æ€æ­»å®¹å™¨å†…çš„è¿›ç¨‹ï¼JAVAè¿›ç¨‹è¢«å¹²æ‰äº†ï¼Œå¾ˆæ˜æ˜¾ï¼Œè¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½ éœ€è¦ç»™JavaæŒ‡å®šä¸€ä¸ªæœ€å¤§å†…å­˜é™åˆ¶ã€‚åœ¨æ—§ç‰ˆæœ¬çš„Javaï¼ˆ8u131ä¹‹å‰ï¼‰ï¼Œä½ éœ€è¦åœ¨å®¹å™¨ä¸­é€šè¿‡è®¾ç½®-Xmxæ¥é™åˆ¶å †å¤§å°ã€‚è¿™æ„Ÿè§‰ä¸å¤ªå¯¹ï¼Œä½ å¯ä¸æƒ³å®šä¹‰è¿™äº›é™åˆ¶ä¸¤æ¬¡ï¼Œä¹Ÿä¸å¤ªæƒ³åœ¨ä½ çš„å®¹å™¨ä¸­æ¥å®šä¹‰ã€‚</p>
<p>å¹¸è¿çš„æ˜¯æˆ‘ä»¬ç°åœ¨æœ‰äº†æ›´å¥½çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä»Java 9ä¹‹åï¼ˆ8u131+ï¼‰ï¼ŒJVMå¢åŠ äº†å¦‚ä¸‹æ ‡å¿—ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap</span><br></pre></td></tr></table></figure></p>
<p>è¿™äº›æ ‡å¿—å¼ºåˆ¶JVMæ£€æŸ¥Linuxçš„cgroupé…ç½®ï¼ŒDockeræ˜¯é€šè¿‡cgroupæ¥å®ç°æœ€å¤§å†…å­˜è®¾ç½®çš„ã€‚ç°åœ¨ï¼Œå¦‚æœä½ çš„åº”ç”¨åˆ°è¾¾äº†Dockerè®¾ç½®çš„é™åˆ¶ï¼ˆæ¯”å¦‚500MBï¼‰ï¼ŒJVMæ˜¯å¯ä»¥çœ‹åˆ°è¿™ä¸ªé™åˆ¶çš„ã€‚JVMå°†ä¼šå°è¯•GCæ“ä½œã€‚å¦‚æœä»ç„¶è¶…è¿‡å†…å­˜é™åˆ¶ï¼ŒJVMå°±ä¼šåšå®ƒè¯¥åšçš„äº‹æƒ…ï¼ŒæŠ›å‡ºOutOfMemoryExceptionã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒJVMèƒ½å¤Ÿçœ‹åˆ°Dockerçš„è¿™äº›è®¾ç½®ã€‚</p>
<p>ä»Java 10ä¹‹åï¼ˆå‚è€ƒä¸‹é¢çš„æµ‹è¯•ï¼‰ï¼Œè¿™äº›ä½“éªŒæ ‡å¿—ä½æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨-XX:+UseContainerSupportæ¥ä½¿èƒ½ï¼ˆä½ å¯ä»¥é€šè¿‡è®¾ç½®-XX:-UseContainerSupportæ¥ç¦æ­¢è¿™äº›è¡Œä¸ºï¼‰ã€‚</p>
<h3 id="é—®é¢˜äºŒï¼šCPU"><a href="#é—®é¢˜äºŒï¼šCPU" class="headerlink" title="é—®é¢˜äºŒï¼šCPU"></a>é—®é¢˜äºŒï¼šCPU</h3><p>ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ç±»ä¼¼çš„ï¼Œä½†å®ƒä¸CPUæœ‰å…³ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒJVMå°†æŸ¥çœ‹ç¡¬ä»¶å¹¶æ£€æµ‹CPUçš„æ•°é‡ã€‚å®ƒä¼šä¼˜åŒ–ä½ çš„runtimeä»¥ä½¿ç”¨è¿™äº›CPUsã€‚ä½†æ˜¯åŒæ ·çš„æƒ…å†µï¼Œè¿™é‡Œè¿˜æœ‰å¦ä¸€ä¸ªä¸åŒ¹é…ï¼ŒDockerå¯èƒ½ä¸å…è®¸ä½ ä½¿ç”¨æ‰€æœ‰è¿™äº›CPUsã€‚å¯æƒœçš„æ˜¯ï¼Œè¿™åœ¨Java 8æˆ–Java 9ä¸­å¹¶æ²¡æœ‰ä¿®å¤ï¼Œä½†æ˜¯åœ¨Java 10ä¸­å¾—åˆ°äº†è§£å†³ã€‚</p>
<p>ä»Java 10å¼€å§‹ï¼Œå¯ç”¨çš„CPUsçš„è®¡ç®—å°†é‡‡ç”¨ä»¥ä¸åŒçš„æ–¹å¼ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼‰è§£å†³æ­¤é—®é¢˜ï¼ˆåŒæ ·æ˜¯é€šè¿‡UseContainerSupportï¼‰ã€‚<br><a id="more"></a></p>
<h2 id="Javaå’ŒDockerçš„å†…å­˜å¤„ç†æµ‹è¯•"><a href="#Javaå’ŒDockerçš„å†…å­˜å¤„ç†æµ‹è¯•" class="headerlink" title="Javaå’ŒDockerçš„å†…å­˜å¤„ç†æµ‹è¯•"></a>Javaå’ŒDockerçš„å†…å­˜å¤„ç†æµ‹è¯•</h2><p>ä½œä¸ºä¸€ä¸ªæœ‰è¶£çš„ç»ƒä¹ ï¼Œè®©æˆ‘ä»¬éªŒè¯å¹¶æµ‹è¯•Dockerå¦‚ä½•ä½¿ç”¨å‡ ä¸ªä¸åŒçš„JVMç‰ˆæœ¬/æ ‡å¿—ç”šè‡³ä¸åŒçš„JVMæ¥å¤„ç†å†…å­˜ä¸è¶³ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµ‹è¯•åº”ç”¨ç¨‹åºï¼Œå®ƒåªæ˜¯ç®€å•åœ°â€œåƒâ€å†…å­˜å¹¶ä¸”ä¸é‡Šæ”¾å®ƒã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemEat</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List l = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">byte</span> b[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1048576</span>];</span><br><span class="line">            l.add(b);</span><br><span class="line">            Runtime rt = Runtime.getRuntime();</span><br><span class="line">            System.out.println( <span class="string">"free memory: "</span> + rt.freeMemory() );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥å¯åŠ¨Dockerå®¹å™¨å¹¶è¿è¡Œè¿™ä¸ªåº”ç”¨ç¨‹åºæ¥æŸ¥çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p>
<h3 id="æµ‹è¯•ä¸€ï¼šJava-8u111"><a href="#æµ‹è¯•ä¸€ï¼šJava-8u111" class="headerlink" title="æµ‹è¯•ä¸€ï¼šJava 8u111"></a>æµ‹è¯•ä¸€ï¼šJava 8u111</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä»å…·æœ‰æ—§ç‰ˆæœ¬Java 8çš„å®¹å™¨å¼€å§‹ï¼ˆupdate 111ï¼‰ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 100m -it java:openjdk-8u111 /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬ç¼–è¯‘å¹¶è¿è¡ŒMemEat.javaæ–‡ä»¶ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">javac MemEat.java</span><br><span class="line">java MemEat</span><br><span class="line">...</span><br><span class="line">free memory: 67194416</span><br><span class="line">free memory: 66145824</span><br><span class="line">free memory: 65097232</span><br><span class="line">Killed</span><br></pre></td></tr></table></figure></p>
<p>æ­£å¦‚æ‰€æ–™ï¼ŒDockerå·²ç»æ€æ­»äº†æˆ‘ä»¬çš„Javaè¿›ç¨‹ã€‚ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼ˆï¼ï¼‰ã€‚ä½ ä¹Ÿå¯ä»¥çœ‹åˆ°è¾“å‡ºï¼ŒJavaè®¤ä¸ºå®ƒä»ç„¶æœ‰å¤§é‡çš„å†…å­˜éœ€è¦åˆ†é…ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨-Xmxæ ‡å¿—ä¸ºJavaæä¾›æœ€å¤§å†…å­˜æ¥è§£å†³æ­¤é—®é¢˜ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">javac MemEat.java</span><br><span class="line">java -Xmx100m MemEat</span><br><span class="line">...</span><br><span class="line">free memory: 1155664</span><br><span class="line">free memory: 1679936</span><br><span class="line">free memory: 2204208</span><br><span class="line">free memory: 1315752</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">    at MemEat.main(MemEat.java:8)</span><br></pre></td></tr></table></figure></p>
<p>åœ¨æä¾›äº†æˆ‘ä»¬è‡ªå·±çš„å†…å­˜é™åˆ¶ä¹‹åï¼Œè¿›ç¨‹æ­£å¸¸åœæ­¢ï¼ŒJVMç†è§£å®ƒæ­£åœ¨è¿è¡Œçš„é™åˆ¶ã€‚ç„¶è€Œï¼Œé—®é¢˜åœ¨äºä½ ç°åœ¨å°†è¿™äº›å†…å­˜é™åˆ¶è®¾ç½®äº†ä¸¤æ¬¡ï¼ŒDockerä¸€æ¬¡ï¼ŒJVMä¸€æ¬¡ã€‚</p>
<h3 id="æµ‹è¯•äºŒï¼šJava-8u144"><a href="#æµ‹è¯•äºŒï¼šJava-8u144" class="headerlink" title="æµ‹è¯•äºŒï¼šJava 8u144"></a>æµ‹è¯•äºŒï¼šJava 8u144</h3><p>å¦‚å‰æ‰€è¿°ï¼Œéšç€å¢åŠ æ–°æ ‡å¿—æ¥ä¿®å¤é—®é¢˜ï¼ŒJVMç°åœ¨å¯ä»¥éµå¾ªDockeræ‰€æä¾›çš„è®¾ç½®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç‰ˆæœ¬æ–°ä¸€ç‚¹çš„JVMæ¥æµ‹è¯•å®ƒã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 100m -it adoptopenjdk/openjdk8 /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>ï¼ˆåœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œæ­¤OpenJDK Javaé•œåƒçš„ç‰ˆæœ¬æ˜¯Java 8u144ï¼‰</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¬¡ç¼–è¯‘å¹¶è¿è¡ŒMemEat.javaæ–‡ä»¶ï¼Œä¸å¸¦ä»»ä½•æ ‡å¿—ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">javac MemEat.java</span><br><span class="line">java MemEat</span><br><span class="line">...</span><br><span class="line">free memory: 67194416</span><br><span class="line">free memory: 66145824</span><br><span class="line">free memory: 65097232</span><br><span class="line">Killed</span><br></pre></td></tr></table></figure></p>
<p>ä¾ç„¶å­˜åœ¨åŒæ ·çš„é—®é¢˜ã€‚ä½†æ˜¯æˆ‘ä»¬ç°åœ¨å¯ä»¥æä¾›ä¸Šé¢æåˆ°çš„å®éªŒæ€§æ ‡å¿—æ¥è¯•è¯•çœ‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">javac MemEat.java</span><br><span class="line">java -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap MemEat</span><br><span class="line">...</span><br><span class="line">free memory: 1679936</span><br><span class="line">free memory: 2204208</span><br><span class="line">free memory: 1155616</span><br><span class="line">free memory: 1155600</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">   at MemEat.main(MemEat.java:8)</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸€æ¬¡æˆ‘ä»¬æ²¡æœ‰å‘Šè¯‰JVMé™åˆ¶çš„æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬åªæ˜¯å‘Šè¯‰JVMå»æ£€æŸ¥æ­£ç¡®çš„é™åˆ¶è®¾ç½®ï¼ç°åœ¨æ„Ÿè§‰å¥½å¤šäº†ã€‚</p>
<h3 id="æµ‹è¯•ä¸‰ï¼šJava-10u23"><a href="#æµ‹è¯•ä¸‰ï¼šJava-10u23" class="headerlink" title="æµ‹è¯•ä¸‰ï¼šJava 10u23"></a>æµ‹è¯•ä¸‰ï¼šJava 10u23</h3><p>æœ‰äº›äººåœ¨è¯„è®ºå’ŒRedditä¸Šæåˆ°Java 10é€šè¿‡ä½¿å®éªŒæ ‡å¿—æˆä¸ºæ–°çš„é»˜è®¤å€¼æ¥è§£å†³æ‰€æœ‰é—®é¢˜ã€‚è¿™ç§è¡Œä¸ºå¯ä»¥é€šè¿‡ç¦ç”¨æ­¤æ ‡å¿—æ¥å…³é—­ï¼š-XXï¼š-UseContainerSupportã€‚</p>
<p>å½“æˆ‘æµ‹è¯•å®ƒæ—¶ï¼Œå®ƒæœ€åˆä¸èµ·ä½œç”¨ã€‚åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼ŒAdoptAJDK OpenJDK10é•œåƒä¸jdk-10+23ä¸€èµ·æ‰“åŒ…ã€‚è¿™ä¸ªJVMæ˜¾ç„¶è¿˜æ˜¯ä¸ç†è§£UseContainerSupportæ ‡å¿—ï¼Œè¯¥è¿›ç¨‹ä»ç„¶è¢«Dockeræ€æ­»ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 100m -it adoptopenjdk/openjdk10 /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>æµ‹è¯•äº†ä»£ç ï¼ˆç”šè‡³æ‰‹åŠ¨æä¾›éœ€è¦çš„æ ‡å¿—ï¼‰ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">javac MemEat.java</span><br><span class="line">java MemEat</span><br><span class="line">...</span><br><span class="line">free memory: 96262112</span><br><span class="line">free memory: 94164960</span><br><span class="line">free memory: 92067808</span><br><span class="line">free memory: 89970656</span><br><span class="line">Killed</span><br><span class="line">java -XX:+UseContainerSupport MemEat</span><br><span class="line">Unrecognized VM option <span class="string">'UseContainerSupport'</span></span><br><span class="line">Error: Could not create the Java Virtual Machine.</span><br><span class="line">Error: A fatal exception has occurred. Program will exit.</span><br></pre></td></tr></table></figure></p>
<h3 id="æµ‹è¯•å››ï¼šJava-10u46ï¼ˆNightlyï¼‰"><a href="#æµ‹è¯•å››ï¼šJava-10u46ï¼ˆNightlyï¼‰" class="headerlink" title="æµ‹è¯•å››ï¼šJava 10u46ï¼ˆNightlyï¼‰"></a>æµ‹è¯•å››ï¼šJava 10u46ï¼ˆNightlyï¼‰</h3><p>æˆ‘å†³å®šå°è¯•AdoptAJDK OpenJDK 10çš„æœ€æ–°nightlyæ„å»ºã€‚å®ƒåŒ…å«çš„ç‰ˆæœ¬æ˜¯Java 10+46ï¼Œè€Œä¸æ˜¯Java 10+23ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 100m -it adoptopenjdk/openjdk10:nightly /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>ç„¶è€Œï¼Œåœ¨è¿™ä¸ªngithlyæ„å»ºä¸­æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¯¼å‡ºçš„PATHæŒ‡å‘æ—§çš„Java 10+23ç›®å½•ï¼Œè€Œä¸æ˜¯10+46ï¼Œæˆ‘ä»¬éœ€è¦ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/opt/java/openjdk/jdk-10+46/bin/</span><br><span class="line">javac MemEat.java</span><br><span class="line">java MemEat</span><br><span class="line">...</span><br><span class="line">free memory: 3566824</span><br><span class="line">free memory: 2796008</span><br><span class="line">free memory: 1480320</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">  at MemEat.main(MemEat.java:8)</span><br></pre></td></tr></table></figure></p>
<p>æˆåŠŸï¼ä¸æä¾›ä»»ä½•æ ‡å¿—ï¼ŒJava 10ä¾ç„¶å¯ä»¥æ­£ç¡®æ£€æµ‹åˆ°Dockerså†…å­˜é™åˆ¶ã€‚</p>
<h3 id="æµ‹è¯•äº”ï¼šOpenJ9"><a href="#æµ‹è¯•äº”ï¼šOpenJ9" class="headerlink" title="æµ‹è¯•äº”ï¼šOpenJ9"></a>æµ‹è¯•äº”ï¼šOpenJ9</h3><p>æˆ‘æœ€è¿‘ä¹Ÿåœ¨è¯•ç”¨OpenJ9ï¼Œè¿™ä¸ªå…è´¹çš„æ›¿ä»£JVMå·²ç»ä»IBM J9å¼€æºï¼Œç°åœ¨ç”±Eclipseç»´æŠ¤ã€‚</p>
<p>è¯·åœ¨æˆ‘çš„ä¸‹ä¸€ç¯‡åšæ–‡<a href="http://royvanrijn.com/blog/2018/05/openj9-jvm-shootout/" target="_blank" rel="external">http://royvanrijn.com/blog/2018/05/openj9-jvm-shootout/</a>é˜…è¯»å…³äºOpenJ9çš„æ›´å¤šä¿¡æ¯ã€‚</p>
<p>å®ƒè¿è¡Œé€Ÿåº¦å¿«ï¼Œå†…å­˜ç®¡ç†éå¸¸å¥½ï¼Œæ€§èƒ½å“è¶Šï¼Œç»å¸¸å¯ä»¥ä¸ºæˆ‘ä»¬çš„å¾®æœåŠ¡èŠ‚çœå¤šè¾¾30-50ï¼…çš„å†…å­˜ã€‚è¿™å‡ ä¹å¯ä»¥å°†Spring Bootåº”ç”¨ç¨‹åºå®šä¹‰ä¸ºâ€™microâ€™äº†ï¼Œå…¶è¿è¡Œæ—¶é—´åªæœ‰100-200mbï¼Œè€Œä¸æ˜¯300mb+ã€‚æˆ‘æ‰“ç®—å°½å¿«å°±æ­¤å†™ä¸€ç¯‡å…³äºè¿™æ–¹é¢çš„æ–‡ç« ã€‚</p>
<p>ä½†ä»¤æˆ‘æƒŠè®¶çš„æ˜¯ï¼ŒOpenJ9è¿˜æ²¡æœ‰ç±»ä¼¼äºJava 8/9/10+ä¸­é’ˆå¯¹cgroupå†…å­˜é™åˆ¶çš„æ ‡å¿—ï¼ˆbackportedï¼‰çš„é€‰é¡¹ã€‚å¦‚æœæˆ‘ä»¬å°†ä»¥å‰çš„æµ‹è¯•ç”¨ä¾‹åº”ç”¨åˆ°æœ€æ–°çš„AdoptAJDK OpenJDK 9 + OpenJ9 buildï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 100m -it adoptopenjdk/openjdk9-openj9 /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬æ·»åŠ OpenJDKæ ‡å¿—ï¼ˆOpenJ9ä¼šå¿½ç•¥çš„æ ‡å¿—ï¼‰ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap MemEat</span><br><span class="line">...</span><br><span class="line">free memory: 83988984</span><br><span class="line">free memory: 82940400</span><br><span class="line">free memory: 81891816</span><br><span class="line">Killed</span><br></pre></td></tr></table></figure></p>
<p>Oopsï¼ŒJVMå†æ¬¡è¢«Dockeræ€æ­»ã€‚</p>
<p>æˆ‘çœŸçš„å¸Œæœ›ç±»ä¼¼çš„é€‰é¡¹å°†å¾ˆå¿«æ·»åŠ åˆ°OpenJ9ä¸­ï¼Œå› ä¸ºæˆ‘å¸Œæœ›åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œè¿™ä¸ªé€‰é¡¹ï¼Œè€Œä¸å¿…æŒ‡å®šæœ€å¤§å†…å­˜ä¸¤æ¬¡ã€‚ Eclipse/IBMæ­£åœ¨åŠªåŠ›ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œå·²ç»æäº†issuesï¼Œç”šè‡³å·²ç»é’ˆå¯¹issuesæäº¤äº†PRã€‚</p>
<h3 id="æ›´æ–°ï¼šï¼ˆä¸æ¨èHackï¼‰"><a href="#æ›´æ–°ï¼šï¼ˆä¸æ¨èHackï¼‰" class="headerlink" title="æ›´æ–°ï¼šï¼ˆä¸æ¨èHackï¼‰"></a>æ›´æ–°ï¼šï¼ˆä¸æ¨èHackï¼‰</h3><p>ä¸€ä¸ªç¨å¾®ä¸‘é™‹/hackyçš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜æ˜¯ä½¿ç”¨ä¸‹é¢çš„ç»„åˆæ ‡å¿—ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">java -Xmx`cat /sys/fs/cgroup/memory/memory.limit_<span class="keyword">in</span>_bytes` MemEat</span><br><span class="line">...</span><br><span class="line">free memory: 3171536</span><br><span class="line">free memory: 2127048</span><br><span class="line">free memory: 2397632</span><br><span class="line">free memory: 1344952</span><br><span class="line">JVMDUMP039I Processing dump event <span class="string">"systhrow"</span>, detail <span class="string">"java/lang/OutOfMemoryError"</span> at 2018/05/15 14:04:26 - please wait.</span><br><span class="line">JVMDUMP032I JVM requested System dump using <span class="string">'//core.20180515.140426.125.0001.dmp'</span> <span class="keyword">in</span> response to an event</span><br><span class="line">JVMDUMP010I System dump written to //core.20180515.140426.125.0001.dmp</span><br><span class="line">JVMDUMP032I JVM requested Heap dump using <span class="string">'//heapdump.20180515.140426.125.0002.phd'</span> <span class="keyword">in</span> response to an event</span><br><span class="line">JVMDUMP010I Heap dump written to //heapdump.20180515.140426.125.0002.phd</span><br><span class="line">JVMDUMP032I JVM requested Java dump using <span class="string">'//javacore.20180515.140426.125.0003.txt'</span> <span class="keyword">in</span> response to an event</span><br><span class="line">JVMDUMP010I Java dump written to //javacore.20180515.140426.125.0003.txt</span><br><span class="line">JVMDUMP032I JVM requested Snap dump using <span class="string">'//Snap.20180515.140426.125.0004.trc'</span> <span class="keyword">in</span> response to an event</span><br><span class="line">JVMDUMP010I Snap dump written to //Snap.20180515.140426.125.0004.trc</span><br><span class="line">JVMDUMP013I Processed dump event <span class="string">"systhrow"</span>, detail <span class="string">"java/lang/OutOfMemoryError"</span>.</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">  at MemEat.main(MemEat.java:8)</span><br></pre></td></tr></table></figure></p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå †å¤§å°å—é™äºåˆ†é…ç»™Dockerå®ä¾‹çš„å†…å­˜ï¼Œè¿™é€‚ç”¨äºè¾ƒæ—§çš„JVMå’ŒOpenJ9ã€‚è¿™å½“ç„¶æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºå®¹å™¨æœ¬èº«å’Œå †å¤–çš„JVMçš„å…¶ä»–éƒ¨åˆ†ä¹Ÿä½¿ç”¨å†…å­˜ã€‚ä½†å®ƒä¼¼ä¹å·¥ä½œï¼Œæ˜¾ç„¶Dockeråœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯å®½æ¾çš„ã€‚ä¹Ÿè®¸æŸäº›bashå¤§ç¥ä¼šåšå‡ºæ›´å¥½çš„ç‰ˆæœ¬ï¼Œä»å…¶ä»–è¿›ç¨‹çš„å­—èŠ‚ä¸­å‡å»ä¸€éƒ¨åˆ†ã€‚</p>
<p>æ— è®ºå¦‚ä½•ï¼Œä¸è¦è¿™æ ·åšï¼Œå®ƒå¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚</p>
<h3 id="æµ‹è¯•å…­ï¼šOpenJ9ï¼ˆNightlyï¼‰"><a href="#æµ‹è¯•å…­ï¼šOpenJ9ï¼ˆNightlyï¼‰" class="headerlink" title="æµ‹è¯•å…­ï¼šOpenJ9ï¼ˆNightlyï¼‰"></a>æµ‹è¯•å…­ï¼šOpenJ9ï¼ˆNightlyï¼‰</h3><p>æœ‰äººå»ºè®®ä½¿ç”¨OpenJ9çš„æœ€æ–°nightlyç‰ˆæœ¬ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -m 100m -it adoptopenjdk/openjdk9-openj9:nightly /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>æœ€æ–°çš„OpenJ9å¤œé—´ç‰ˆæœ¬ï¼Œå®ƒæœ‰ä¸¤ä¸ªä¸œè¥¿ï¼š</p>
<ol>
<li>å¦ä¸€ä¸ªæœ‰é—®é¢˜çš„PATHå‚æ•°ï¼Œéœ€è¦å…ˆè§£å†³è¿™ä¸ªé—®é¢˜</li>
<li>JVMæ”¯æŒæ–°æ ‡å¿—UseContainerSupportï¼ˆå°±åƒJava 10ä¸€æ ·ï¼‰</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/opt/java/openjdk/jdk-9.0.4+12/bin/</span><br><span class="line">javac MemEat.java</span><br><span class="line">java -XX:+UseContainerSupport MemEat</span><br><span class="line">...</span><br><span class="line">free memory: 5864464</span><br><span class="line">free memory: 4815880</span><br><span class="line">free memory: 3443712</span><br><span class="line">free memory: 2391032</span><br><span class="line">JVMDUMP039I Processing dump event <span class="string">"systhrow"</span>, detail <span class="string">"java/lang/OutOfMemoryError"</span> at 2018/05/15 21:32:07 - please wait.</span><br><span class="line">JVMDUMP032I JVM requested System dump using <span class="string">'//core.20180515.213207.62.0001.dmp'</span> <span class="keyword">in</span> response to an event</span><br><span class="line">JVMDUMP010I System dump written to //core.20180515.213207.62.0001.dmp</span><br><span class="line">JVMDUMP032I JVM requested Heap dump using <span class="string">'//heapdump.20180515.213207.62.0002.phd'</span> <span class="keyword">in</span> response to an event</span><br><span class="line">JVMDUMP010I Heap dump written to //heapdump.20180515.213207.62.0002.phd</span><br><span class="line">JVMDUMP032I JVM requested Java dump using <span class="string">'//javacore.20180515.213207.62.0003.txt'</span> <span class="keyword">in</span> response to an event</span><br><span class="line">JVMDUMP010I Java dump written to //javacore.20180515.213207.62.0003.txt</span><br><span class="line">JVMDUMP032I JVM requested Snap dump using <span class="string">'//Snap.20180515.213207.62.0004.trc'</span> <span class="keyword">in</span> response to an event</span><br><span class="line">JVMDUMP010I Snap dump written to //Snap.20180515.213207.62.0004.trc</span><br><span class="line">JVMDUMP013I Processed dump event <span class="string">"systhrow"</span>, detail <span class="string">"java/lang/OutOfMemoryError"</span>.</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.OutOfMemoryError: Java heap space</span><br></pre></td></tr></table></figure>
<p>TADAAAï¼Œæ­£åœ¨ä¿®å¤ä¸­ï¼</p>
<p>å¥‡æ€ªçš„æ˜¯ï¼Œè¿™ä¸ªæ ‡å¿—åœ¨OpenJ9ä¸­é»˜è®¤æ²¡æœ‰å¯ç”¨ï¼Œå°±åƒå®ƒåœ¨Java 10ä¸­ä¸€æ ·ã€‚å†è¯´ä¸€æ¬¡ï¼šç¡®ä¿ä½ æµ‹è¯•äº†è¿™æ˜¯ä½ æƒ³åœ¨ä¸€ä¸ªDockerå®¹å™¨ä¸­è¿è¡ŒJavaã€‚</p>
<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>ç®€è¨€ä¹‹ï¼šæ³¨æ„èµ„æºé™åˆ¶çš„ä¸åŒ¹é…ã€‚æµ‹è¯•ä½ çš„å†…å­˜è®¾ç½®å’ŒJVMæ ‡å¿—ï¼Œä¸è¦å‡è®¾ä»»ä½•ä¸œè¥¿ã€‚</p>
<p>å¦‚æœæ‚¨åœ¨Dockerå®¹å™¨ä¸­è¿è¡ŒJavaï¼Œè¯·ç¡®ä¿ä½ è®¾ç½®äº†Dockerå†…å­˜é™åˆ¶å’Œåœ¨JVMä¸­ä¹Ÿåšäº†é™åˆ¶ï¼Œæˆ–è€…ä½ çš„JVMèƒ½å¤Ÿç†è§£è¿™äº›é™åˆ¶ã€‚</p>
<p>å¦‚æœæ‚¨æ— æ³•å‡çº§æ‚¨çš„Javaç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨-Xmxè®¾ç½®æ‚¨è‡ªå·±çš„é™åˆ¶ã€‚</p>
<p>å¯¹äºJava 8å’ŒJava 9ï¼Œè¯·æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬å¹¶ä½¿ç”¨ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XXï¼š+UnlockExperimentalVMOptions -XXï¼š+UseCGroupMemoryLimitForHeap</span><br></pre></td></tr></table></figure></p>
<p>å¯¹äºJava 10ï¼Œç¡®ä¿å®ƒæ”¯æŒâ€™UseContainerSupportâ€™ï¼ˆæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼‰ã€‚</p>
<p>å¯¹äºOpenJ9ï¼ˆæˆ‘å¼ºçƒˆå»ºè®®ä½¿ç”¨ï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æœ‰æ•ˆå‡å°‘å†…å­˜å ç”¨é‡ï¼‰ï¼Œç°åœ¨ä½¿ç”¨-Xmxè®¾ç½®é™åˆ¶ï¼Œä½†å¾ˆå¿«ä¼šå‡ºç°ä¸€ä¸ªæ”¯æŒUseContainerSupportæ ‡å¿—çš„ç‰ˆæœ¬ã€‚</p>
<p>åŸæ–‡é“¾æ¥ï¼š<a href="http://royvanrijn.com/blog/2018/05/java-and-docker-memory-limits/" target="_blank" rel="external">http://royvanrijn.com/blog/2018/05/java-and-docker-memory-limits/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Centos 6.x ä¸Šå‡çº§go 1.10.3]]></title>
      <url>http://team.jiunile.com/blog/2018/07/go-%E5%8D%87%E7%BA%A7go1-10-x%E9%97%AE%E9%A2%98.html</url>
      <content type="html"><![CDATA[<h2 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h2><blockquote>
<p>ç›®å‰æœ¬åœ°Linux (Centos 6.x) ç¼–è¯‘ç¯å¢ƒè¿˜æ»ç•™åœ¨1.8.xä¸Šï¼Œä¸ºäº†æå‡goæ€§èƒ½ï¼Œæƒ³å°†goå‡çº§åˆ°æœ€æ–°ç‰ˆï¼Œä½†åœ¨å‡çº§è¿‡ç¨‹ä¸­é‡åˆ°å¦‚ä¸‹é—®é¢˜ï¼Œæ•…æ­¤è®°å½•ä¸‹ï¼å¿˜åç»­çš„goå‹èƒ½è·³è¿‡æ­¤å‘ï¼</p>
</blockquote>
<h2 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h2><p>åœ¨Centos 6.x å‡çº§go 1.10.xè¿‡ç¨‹ä¸­é‡åˆ°å¦‚ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>step1.  ä¸‹è½½go 1.10.x æºç </li>
<li>step2.  è§£å‹ï¼Œè¿›å…¥go/src</li>
<li>step3.  æ‰§è¡Œ./all.bash</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Building Go cmd/dist using /root/go1.4.</span><br><span class="line">Building Go toolchain1 using /root/go1.4.</span><br><span class="line">Building Go bootstrap cmd/go (go_bootstrap) using Go toolchain1.</span><br><span class="line">Building Go toolchain2 using go_bootstrap and Go toolchain1.</span><br><span class="line">Building Go toolchain3 using go_bootstrap and Go toolchain2.</span><br><span class="line">Building packages and commands <span class="keyword">for</span> linux/amd64.</span><br><span class="line"></span><br><span class="line"><span class="comment">##### Testing packages.</span></span><br><span class="line">.... è¿‡ç¨‹ç•¥é•¿ï¼Œç‰¹æ­¤çœç•¥</span><br><span class="line">ok      cmd/internal/src    0.001s</span><br><span class="line">ok      cmd/internal/<span class="built_in">test</span>2json    0.097s</span><br><span class="line">ok      cmd/link    1.988s</span><br><span class="line">ok      cmd/link/internal/ld    43.529s</span><br><span class="line">ok      cmd/nm    3.417s</span><br><span class="line">ok      cmd/objdump    1.588s</span><br><span class="line">ok      cmd/pack    1.217s</span><br><span class="line">ok      cmd/trace    0.007s</span><br><span class="line">--- FAIL: TestObjFile (0.01s)</span><br><span class="line">    binutils_test.go:231: SourceLine: unexpected error write |1: broken pipe</span><br><span class="line">FAIL</span><br><span class="line">FAIL    cmd/vendor/github.com/google/pprof/internal/binutils    0.018s</span><br><span class="line">ok      cmd/vendor/github.com/google/pprof/internal/driver    12.194s</span><br><span class="line">ok      cmd/vendor/github.com/google/pprof/internal/elfexec    0.002s</span><br><span class="line">ok      cmd/vendor/github.com/google/pprof/internal/graph    0.002s</span><br><span class="line">ok      cmd/vendor/github.com/google/pprof/internal/measurement    0.002s</span><br><span class="line">ok      cmd/vendor/github.com/google/pprof/internal/report    0.048s</span><br><span class="line">ok      cmd/vendor/github.com/google/pprof/internal/symbolizer    0.004s</span><br><span class="line">ok      cmd/vendor/github.com/google/pprof/internal/symbolz    0.004s</span><br><span class="line">ok      cmd/vendor/github.com/google/pprof/profile    0.045s</span><br><span class="line">ok      cmd/vendor/github.com/ianlancetaylor/demangle    0.012s</span><br><span class="line">ok      cmd/vendor/golang.org/x/arch/arm/armasm    0.007s</span><br><span class="line">ok      cmd/vendor/golang.org/x/arch/arm64/arm64asm    0.043s</span><br><span class="line">ok      cmd/vendor/golang.org/x/arch/ppc64/ppc64asm    0.003s</span><br><span class="line">ok      cmd/vendor/golang.org/x/arch/x86/x86asm    0.064s</span><br><span class="line">ok      cmd/vet    1.205s</span><br><span class="line">ok      cmd/vet/internal/cfg    0.002s</span><br><span class="line">2018/07/18 17:59:22 Failed: <span class="built_in">exit</span> status 1</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="é—®é¢˜åˆ†æ"><a href="#é—®é¢˜åˆ†æ" class="headerlink" title="é—®é¢˜åˆ†æ"></a>é—®é¢˜åˆ†æ</h2><p>ä¸ºä»€ä¹ˆåœ¨æ‰§è¡Œbinutils_test.go ä¼šFailedï¼Œæœ€ç»ˆæŸ¥çœ‹ä»£ç åŸå› æ˜¯å› ä¸ºå¦‚ä¸‹å‘½ä»¤å¼•èµ·ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">120807 3650  execve(<span class="string">"/usr/bin/addr2line"</span>, [<span class="string">"/usr/bin/addr2line"</span>, <span class="string">"-aif"</span>, <span class="string">"-e"</span>, <span class="string">"testdata/exe_linux_64"</span>], [/* 15 vars */] &lt;unfinished ...&gt;</span><br></pre></td></tr></table></figure></p>
<p>æœ‰å…³ç”Ÿæˆæ­¤å‘½ä»¤çš„æºä»£ç å¯æŸ¥çœ‹å¦‚ä¸‹åœ°å€ï¼š<a href="https://github.com/google/pprof/blob/a74ae6fb3cd7047c79272e3ea0814b08154a2d3c/internal/binutils/addr2liner.go#L92" target="_blank" rel="external">addr2line</a></p>
<p>add2lineæ–‡ä»¶æ¥è‡ªäºåŒ…ï¼šbinutils</p>
<p>æ‰§è¡Œå‘½ä»¤å¤±è´¥ï¼Œæ˜¯å› ä¸ºåœ¨CentOS 6.xä¸Šï¼Œbinutilsçš„ç‰ˆæœ¬æ˜¯2.20ï¼Œ<a href="https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;a=blob_plain;f=binutils/NEWS;hb=refs/tags/binutils-2_27" target="_blank" rel="external">å‚è€ƒæ–‡çŒ®</a> ï¼Œç„¶åaddr2lineå‘½ä»¤ä¸­çš„-aå‚æ•°åœ¨binutils 2.21ç‰ˆä¸­æ‰æ·»åŠ </p>
<p>å› æ­¤ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»æºç é‡æ–°è¿›è¡Œç¼–è¯‘binutilså¹¶å°†å…¶æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶æ·»åŠ åˆ°PATHä¸­ï¼Œç„¶åè¿è¡Œæµ‹è¯•ï¼Œå¹¶æˆåŠŸé€šè¿‡ã€‚</p>
<p>ç¼–è¯‘å®‰è£…binutilsè¿‡ç¨‹å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://ftp.gnu.org/gnu/binutils/binutils-2.27.tar.gz</span><br><span class="line">tar zxvf binutils-2.27.tar.gz </span><br><span class="line"><span class="built_in">cd</span> binutils-2.27</span><br><span class="line">./configure --prefix=/usr</span><br><span class="line">make </span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong><code>ç‰¹æ­¤è¯´æ˜ï¼Œåœ¨Centos 7.x ä¸Šèƒ½æˆåŠŸé¿å…æ­¤å‘ï¼ï¼</code></strong></p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Logstash filteræ’ä»¶å¼€å‘]]></title>
      <url>http://team.jiunile.com/blog/2017/08/log-logstash-filter.html</url>
      <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Logstashæ˜¯ä¸€ä¸ªå…·æœ‰å®æ—¶ç®¡çº¿èƒ½åŠ›çš„å¼€æºæ•°æ®æ”¶é›†å¼•æ“ã€‚åœ¨ELK Stackä¸­ï¼Œé€šå¸¸é€‰æ‹©æ›´è½»é‡çº§çš„Filebeatæ”¶é›†æ—¥å¿—ï¼Œç„¶åå°†æ—¥å¿—è¾“å‡ºåˆ°Logstashè¿›è¡ŒåŠ å·¥å¤„ç†ï¼Œå†å°†å¤„ç†åçš„æ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šçš„ç›®æ ‡ï¼ˆElasticSearchï¼ŒKafkaç­‰ï¼‰å½“ä¸­ã€‚</p>
<p>Logstashäº‹ä»¶çš„å¤„ç†ç®¡çº¿æ˜¯inputs â†’ filters â†’ outputsï¼Œä¸‰ä¸ªé˜¶æ®µéƒ½å¯ä»¥è‡ªå®šä¹‰æ’ä»¶ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•å¼€å‘è‡ªå®šä¹‰éœ€æ±‚æœ€å¤šçš„filteræ’ä»¶ã€‚</p>
<p>Logstashçš„å®‰è£…å°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œä¸‹è½½ä¼ é€é—¨ï¼š<a href="https://www.elastic.co/downloads/logstash" target="_blank" rel="external">https://www.elastic.co/downloads/logstash</a>ã€‚</p>
<h2 id="å‰ç½®å‡†å¤‡"><a href="#å‰ç½®å‡†å¤‡" class="headerlink" title="å‰ç½®å‡†å¤‡"></a>å‰ç½®å‡†å¤‡</h2><p>æˆ‘ä»¬ä½¿ç”¨dockeræ¥è®²è§£å¦‚ä½•ç»™logstashå®šåˆ¶ä¸€ä¸ªfilteræ’ä»¶ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬ä¸‹è½½logstashå®˜æ–¹æœ€æ–°ç‰ˆæœ¬çš„é•œåƒã€‚ä¸‹è½½æ–¹å¼: <code>docker pull logstash</code>ï¼Œä¸‹è½½å¥½åæˆ‘ä»¬å°±æ¥Runè¿™ä¸ªé•œåƒï¼Œå‘½ä»¤ï¼š<code>docker run -it logstash bash</code>ï¼Œè¿™æ ·æˆ‘ä»¬å°±è¿›å…¥åˆ°logstashå®¹å™¨ä¸­äº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±å®‰è£…ä¸‹ä¸¤ä¸ªåŸºæœ¬çš„è½¯ä»¶åŒ…ï¼Œä¸€ä¸ªvimï¼Œä¸€ä¸ªrsyslogï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š<code>apt-get update &amp;&amp; apt-get -y install vim rsyslog &amp;&amp; /etc/init.d/rsysylog start</code>ã€‚åˆ°æ­¤æˆ‘ä»¬çš„å‡†å¤‡å·¥ä½œå°±å®Œæ¯•äº†ã€‚</p>
<a id="more"></a>
<h2 id="ç”Ÿæˆfilteræ’ä»¶"><a href="#ç”Ÿæˆfilteræ’ä»¶" class="headerlink" title="ç”Ÿæˆfilteræ’ä»¶"></a>ç”Ÿæˆfilteræ’ä»¶</h2><p>cdåˆ°Logstashçš„è·Ÿç›®å½•ï¼Œä½¿ç”¨<code>bin/logstash-plugin</code>ç”Ÿæˆfilteræ’ä»¶æ¨¡æ¿ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/share/logstash</span><br><span class="line">mkdir -p vendor/localgems</span><br><span class="line">bin/logstash-plugin generate --type filter --name <span class="built_in">test</span> --path vendor/localgems</span><br><span class="line"><span class="comment">#vendor/localgems å¯ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„è·¯å¾„</span></span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹filteræ’ä»¶çš„ç›®å½•ç»“æ„ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@c11787c4cef3:/usr/share/logstash/vendor/localgems<span class="comment"># tree .</span></span><br><span class="line">.</span><br><span class="line">â””â”€â”€ logstash-filter-test</span><br><span class="line">    â”œâ”€â”€ CHANGELOG.md</span><br><span class="line">    â”œâ”€â”€ CONTRIBUTORS</span><br><span class="line">    â”œâ”€â”€ DEVELOPER.md</span><br><span class="line">    â”œâ”€â”€ Gemfile</span><br><span class="line">    â”œâ”€â”€ LICENSE</span><br><span class="line">    â”œâ”€â”€ README.md</span><br><span class="line">    â”œâ”€â”€ Rakefile</span><br><span class="line">    â”œâ”€â”€ lib</span><br><span class="line">    â”‚Â Â  â””â”€â”€ logstash</span><br><span class="line">    â”‚Â Â      â””â”€â”€ filters</span><br><span class="line">    â”‚Â Â          â””â”€â”€ test.rb</span><br><span class="line">    â”œâ”€â”€ logstash-filter-test.gemspec</span><br><span class="line">    â”œâ”€â”€ spec</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ filters</span><br><span class="line">    â”‚Â Â  â”‚Â Â  â””â”€â”€ <span class="built_in">test</span>_spec.rb</span><br><span class="line">    â”‚Â Â  â””â”€â”€ spec_helper.rb</span><br><span class="line">    â””â”€â”€ test.conf</span><br><span class="line"></span><br><span class="line">6 directories, 12 files</span><br></pre></td></tr></table></figure></p>
<h2 id="filteræ’ä»¶åˆæ¢"><a href="#filteræ’ä»¶åˆæ¢" class="headerlink" title="filteræ’ä»¶åˆæ¢"></a>filteræ’ä»¶åˆæ¢</h2><p>Logstashæ’ä»¶æ˜¯ç”¨rubyå†™çš„ï¼ŒæŸ¥çœ‹<code>logstash-filter-test/lib/logstash/filters/test.rb</code>æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># logstashä¾èµ–äºUTF-8ç¼–ç ï¼Œéœ€è¦åœ¨æ’ä»¶ä»£ç å¼€å§‹å¤„æ·»åŠ </span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¼•å…¥äº†æ’ä»¶å¿…å¤‡çš„åŒ…</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">"logstash/filters/base"</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">"logstash/namespace"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’ä»¶ç»§æ‰¿è‡ªBaseåŸºç±»ï¼Œå¹¶é…ç½®æ’ä»¶çš„ä½¿ç”¨åç§°</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogStash::Filters::Test</span> &lt; LogStash::Filters::<span class="title">Base</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># æ’ä»¶åç§°ï¼Œåœ¨Logstashé…ç½®çš„filterå—ä¸­ä½¿ç”¨</span></span><br><span class="line">  <span class="comment">#filter&#123;</span></span><br><span class="line">  <span class="comment">#  test&#123;</span></span><br><span class="line">  <span class="comment">#      source =&gt; "message"</span></span><br><span class="line">  <span class="comment">#  &#125;</span></span><br><span class="line">  <span class="comment">#&#125;</span></span><br><span class="line">  config_name <span class="string">"test"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># æ’ä»¶å‚æ•°é…ç½®</span></span><br><span class="line">  <span class="comment"># sourceæ˜¯æ’ä»¶testçš„å¯é€‰å‚æ•°ï¼Œé»˜è®¤å€¼æ˜¯"Hello World!"ã€‚</span></span><br><span class="line">  config <span class="symbol">:source</span>, <span class="symbol">:validate</span> =&gt; <span class="symbol">:string</span>, <span class="symbol">:default</span> =&gt; <span class="string">"Hello World!"</span></span><br><span class="line">  <span class="comment"># ä¸‹é¢æ˜¯å‚æ•°çš„é€šç”¨é…ç½®ä»£ç </span></span><br><span class="line">  <span class="comment"># config :variable_name, :validate =&gt; :variable_type, :default =&gt; "Default value", :required =&gt; boolean, :deprecated =&gt; boolean, :obsolete =&gt; string</span></span><br><span class="line">  <span class="comment"># :variable_nameï¼šå‚æ•°åç§°</span></span><br><span class="line">  <span class="comment"># :validateï¼šéªŒè¯å‚æ•°ç±»å‹ï¼Œå¦‚:string, :password, :boolean, :number, :array, :hash, :pathç­‰</span></span><br><span class="line">  <span class="comment"># :requiredï¼šæ˜¯å¦å¿…é¡»é…ç½®</span></span><br><span class="line">  <span class="comment"># :defaultï¼šé»˜è®¤å€¼</span></span><br><span class="line">  <span class="comment"># :deprecatedï¼šæ˜¯å¦åºŸå¼ƒ</span></span><br><span class="line">  <span class="comment"># :obsoleteï¼šå£°æ˜è¯¥é…ç½®ä¸å†ä½¿ç”¨ï¼Œé€šå¸¸æä¾›å‡çº§æ–¹æ¡ˆ</span></span><br><span class="line"></span><br><span class="line">  public</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">register</span></span></span><br><span class="line">    <span class="comment"># æ–¹æ³•ç›¸å½“äºåˆå§‹åŒ–æ–¹æ³•ï¼Œä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ï¼Œå¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢è°ƒç”¨é…ç½®å˜é‡ï¼Œå¦‚<span class="doctag">@message</span>ï¼Œä¹Ÿå¯ä»¥åˆå§‹åŒ–è‡ªå·±çš„å®ä¾‹å˜é‡ã€‚</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  public</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    <span class="comment"># æ–¹æ³•æ˜¯æ’ä»¶çš„æ•°æ®å¤„ç†é€»è¾‘ï¼Œå…¶ä¸­eventå˜é‡å°è£…äº†æ•°æ®æµï¼Œå¯ä»¥é€šè¿‡æ¥å£è®¿é—®eventä¸­çš„å†…å®¹ï¼Œå…·ä½“å‚è§ https://www.elastic.co/guide/en/logstash/5.1/event-api.htmlã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (source = event.get(@source))      </span><br><span class="line">      datas = source.split(<span class="string">"|"</span>)</span><br><span class="line">      event.set(<span class="string">"data"</span>, datas[<span class="number">0</span>])</span><br><span class="line">      event.set(<span class="string">"data2"</span>, datas[<span class="number">1</span>])</span><br><span class="line">      event.set(<span class="string">"user"</span>, <span class="string">"xp"</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#è¿™ä¸ªæ–¹æ³•ç”¨äºä¿è¯Logstashçš„é…ç½®`add_field`, `remove_field`, `add_tag`å’Œ`remove_tag`ä¼šè¢«æ­£ç¡®æ‰§è¡Œã€‚</span></span><br><span class="line">    filter_matched(event)</span><br><span class="line">  <span class="keyword">end</span> <span class="comment"># def filter</span></span><br><span class="line"><span class="keyword">end</span> <span class="comment"># class LogStash::Filters::Test</span></span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹<code>logstash-filter-test/logstash-filter-test.gemspec</code>æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Gem::Specification.new <span class="keyword">do</span> <span class="params">|s|</span></span><br><span class="line">  s.name          = <span class="string">'logstash-filter-test'</span>  </span><br><span class="line">  s.version       = <span class="string">'0.1.0'</span></span><br><span class="line">  s.licenses      = [<span class="string">'Apache License (2.0)'</span>]</span><br><span class="line">  s.summary       = <span class="string">'æè¿°è¿™ä¸ªæ’ä»¶çš„æ¦‚è¦'</span></span><br><span class="line">  s.description   = <span class="string">'è¿™ä¸ªæ’ä»¶çš„è¯¦ç»†è¯´æ˜'</span></span><br><span class="line">  s.homepage      = <span class="string">'http://icyxp.github.io'</span></span><br><span class="line">  s.authors       = [<span class="string">'icyboy'</span>]</span><br><span class="line">  s.email         = <span class="string">'icyboy@me.com'</span></span><br><span class="line">  s.require_paths = [<span class="string">'lib'</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Files</span></span><br><span class="line">  s.files = Dir[<span class="string">'lib/**/*'</span>,<span class="string">'spec/**/*'</span>,<span class="string">'vendor/**/*'</span>,<span class="string">'*.gemspec'</span>,<span class="string">'*.md'</span>,<span class="string">'CONTRIBUTORS'</span>,<span class="string">'Gemfile'</span>,<span class="string">'LICENSE'</span>,<span class="string">'NOTICE.TXT'</span>]</span><br><span class="line">   <span class="comment"># Tests</span></span><br><span class="line">  s.test_files = s.files.grep(<span class="regexp">%r&#123;^(test|spec|features)/&#125;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Special flag to let us know this is actually a logstash plugin</span></span><br><span class="line">  s.metadata = &#123; <span class="string">"logstash_plugin"</span> =&gt; <span class="string">"true"</span>, <span class="string">"logstash_group"</span> =&gt; <span class="string">"filter"</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Gem dependencies</span></span><br><span class="line">  s.add_runtime_dependency <span class="string">"logstash-core-plugin-api"</span>, <span class="string">"~&gt; 2.0"</span></span><br><span class="line">  s.add_development_dependency <span class="string">'logstash-devutils'</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<h2 id="åœ¨Logstashä¸­é…ç½®å®šåˆ¶çš„æ’ä»¶"><a href="#åœ¨Logstashä¸­é…ç½®å®šåˆ¶çš„æ’ä»¶" class="headerlink" title="åœ¨Logstashä¸­é…ç½®å®šåˆ¶çš„æ’ä»¶"></a>åœ¨Logstashä¸­é…ç½®å®šåˆ¶çš„æ’ä»¶</h2><p>cdåˆ°Logstashæ ¹ç›®å½•ä¸‹<code>cd /usr/shar/logstash</code>ï¼Œåœ¨<code>Gemfile</code>æœ«å°¾æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem <span class="string">"logstash-filter-test"</span>, <span class="symbol">:path</span> =&gt; <span class="string">"vendor/localgems/logstash-filter-test"</span></span><br></pre></td></tr></table></figure></p>
<h2 id="å¯åŠ¨Logstash"><a href="#å¯åŠ¨Logstash" class="headerlink" title="å¯åŠ¨Logstash"></a>å¯åŠ¨Logstash</h2><p>å…ˆç¼–å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶<code>test.conf</code>ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨äº†rsyslog<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ¥æºrsyslog</span></span><br><span class="line">input&#123;</span><br><span class="line">    file&#123;</span><br><span class="line">	    path =&gt; <span class="string">"/var/log/messages"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#æˆ–è€…å¯ä»¥è®¾ç½®ä¸ºç»ˆç«¯è¾“å…¥</span></span><br><span class="line"><span class="comment">#input&#123;</span></span><br><span class="line"><span class="comment">#    stdin&#123;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line">filter&#123;</span><br><span class="line">    <span class="comment"># å®šåˆ¶çš„filteræ’ä»¶</span></span><br><span class="line">    <span class="built_in">test</span>&#123;</span><br><span class="line">	    <span class="built_in">source</span> =&gt; <span class="string">"message"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#è¾“å‡ºåˆ°ç»ˆç«¯</span></span><br><span class="line">output&#123;</span><br><span class="line">    stdout&#123;</span><br><span class="line">        codec =&gt; rubydebug</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿è¡Œèµ·æ¥<code>logstash -f test.conf</code>ï¼Œç„¶åå¾€rsyslogé‡Œå†™æ—¥å¿—ä½ å°±å¯ä»¥çœ‹ä¸‹å¦‚ä¸‹æƒ…å†µå°±è¯´æ˜okäº†ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#logger "æµ‹è¯•ä¸€ä¸‹"</span></span><br><span class="line">&#123;</span><br><span class="line">          <span class="string">"path"</span> =&gt; <span class="string">"/var/log/messages"</span>,</span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; 2017-08-16T15:27:46.606Z,</span><br><span class="line">          <span class="string">"data"</span> =&gt; <span class="string">"Aug 16 15:27:45 c11787c4cef3 root: æµ‹è¯•ä¸€ä¸‹"</span>,</span><br><span class="line">         <span class="string">"data2"</span> =&gt; nil,</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"c11787c4cef3"</span>,</span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"Aug 16 15:27:45 c11787c4cef3 root: æµ‹è¯•ä¸€ä¸‹"</span>,</span><br><span class="line">          <span class="string">"user"</span> =&gt; <span class="string">"xp"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#logger "æµ‹è¯•ä¸€ä¸‹|from by icyboy"</span></span><br><span class="line">&#123;</span><br><span class="line">          <span class="string">"path"</span> =&gt; <span class="string">"/var/log/messages"</span>,</span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; 2017-08-16T15:28:17.661Z,</span><br><span class="line">          <span class="string">"data"</span> =&gt; <span class="string">"Aug 16 15:28:16 c11787c4cef3 root: æµ‹è¯•ä¸€ä¸‹"</span>,</span><br><span class="line">         <span class="string">"data2"</span> =&gt; <span class="string">"from by icyboy"</span>,</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"c11787c4cef3"</span>,</span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"Aug 16 15:28:16 c11787c4cef3 root: æµ‹è¯•ä¸€ä¸‹|from by icyboy"</span>,</span><br><span class="line">          <span class="string">"user"</span> =&gt; <span class="string">"xp"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ä¸€è¯­ç‚¹é†’æŠ€æœ¯äººï¼šä½ ä¸æ˜¯Google]]></title>
      <url>http://team.jiunile.com/blog/2017/07/gossip-%E4%BD%A0%E4%B8%8D%E6%98%AFGoogle.html</url>
      <content type="html"><![CDATA[<p><img src="/images/gossip/01/cover.png" alt="01"></p>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>åœ¨ä¸ºé—®é¢˜å¯»æ‰¾è§£å†³æ–¹æ¡ˆæ—¶è¦å…ˆå……åˆ†äº†è§£é—®é¢˜æœ¬èº«ï¼Œè€Œä¸æ˜¯ä¸€å‘³åœ°ç›²ç›®å´‡æ‹œé‚£äº›å·¨å¤´å…¬å¸ã€‚Ozan Onayä»¥Amazonã€LinkedInå’ŒGoogleä¸ºä¾‹ï¼Œä¸ºæ‰§è¿·ä¸æ‚Ÿçš„äººæ•²å“è­¦é’Ÿã€‚ä»¥ä¸‹å†…å®¹å·²è·å¾—ä½œè€…ç¿»è¯‘æˆæƒï¼ŒæŸ¥çœ‹åŸæ–‡ï¼š<a href="https://blog.bradfieldcs.com/you-are-not-google-84912cf44afb" target="_blank" rel="external">You Are Not Google</a>ã€‚</p>
<p>è½¯ä»¶å·¥ç¨‹å¸ˆæ€»æ˜¯ç€è¿·äºè’å”å¤æ€ªçš„äº‹ã€‚æˆ‘ä»¬çœ‹èµ·æ¥ä¼¼ä¹å¾ˆç†æ€§ï¼Œä½†åœ¨é¢å¯¹æŠ€æœ¯é€‰å‹æ—¶ï¼Œæ€»æ˜¯é™·å…¥æŠ“ç‹‚â€”â€”ä»Hacker Newsåˆ°å„ç§åšå®¢ï¼Œåƒä¸€åªé£è›¾ä¸€æ ·ï¼Œæ¥å›æŠ˜è…¾ï¼Œæœ€åç²¾ç–²åŠ›å°½ï¼Œæ— åŠ©åœ°é£å‘ä¸€å›¢äº®å…‰ï¼Œè·ªå€’åœ¨å®ƒçš„å‰é¢â€”â€”é‚£å°±æ˜¯æˆ‘ä»¬ä¸€ç›´åœ¨å¯»æ‰¾çš„ä¸œè¥¿ã€‚</p>
<p>çœŸæ­£ç†æ€§çš„äººä¸æ˜¯è¿™æ ·åšå†³å®šçš„ã€‚ä¸è¿‡å·¥ç¨‹å¸ˆä¸€è´¯å¦‚æ­¤ï¼Œæ¯”å¦‚å†³å®šæ˜¯å¦ä½¿ç”¨MapReduceã€‚</p>
<p>Joe Hellersteinåœ¨ä»–çš„å¤§å­¦æ•°æ®åº“æ•™ç¨‹è§†é¢‘ä¸­è¯´é“ï¼š</p>
<blockquote>
<p>ä¸–ç•Œä¸Šåªæœ‰å·®ä¸å¤š5ä¸ªå…¬å¸éœ€è¦è¿è¡Œè¿™ä¹ˆå¤§è§„æ¨¡çš„ä½œä¸šã€‚è‡³äºå…¶ä»–å…¬å¸â€¦â€¦ä»–ä»¬ä½¿ç”¨äº†æ‰€æœ‰çš„IOæ¥å®ç°ä¸å¿…è¦çš„å®¹é”™ã€‚åœ¨2000å¹´ä»£ï¼Œäººä»¬ç‹‚çƒ­åœ°è¿½éšç€Googleï¼šâ€œæˆ‘ä»¬è¦åšGoogleåšè¿‡çš„æ¯ä¸€ä»¶äº‹ï¼Œå› ä¸ºæˆ‘ä»¬ä¹Ÿè¿è¡Œç€ä¸–ç•Œä¸Šæœ€å¤§çš„äº’è”ç½‘æ•°æ®æœåŠ¡ã€‚â€</p>
</blockquote>
<p>è¶…å‡ºå®é™…éœ€æ±‚çš„å®¹é”™æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æˆ‘ä»¬å´ä¸ºæ­¤ä»˜å‡ºäº†çš„æƒ¨é‡çš„ä»£ä»·ï¼šä¸ä»…å¢åŠ äº†IOï¼Œè¿˜æœ‰å¯èƒ½è®©åŸå…ˆæˆç†Ÿçš„ç³»ç»Ÿâ€”â€”åŒ…å«äº†äº‹åŠ¡ã€ç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–å™¨â€”â€”å˜å¾—ç ´ç¢ä¸å ªã€‚è¿™æ˜¯ä¸€ä¸ªå¤šä¹ˆä¸¥é‡çš„å†å²å€’é€€ï¼æœ‰å¤šå°‘ä¸ªHadoopç”¨æˆ·æ˜¯æœ‰æ„è¯†åœ°åšå‡ºè¿™ç§å†³å®šçš„ï¼Ÿæœ‰å¤šå°‘äººçŸ¥é“ä»–ä»¬çš„å†³å®šåˆ°åº•æ˜¯ä¸æ˜¯ä¸€ä¸ªæ˜æ™ºä¹‹ä¸¾ï¼Ÿ</p>
<p>MapReduceå·²ç»æˆä¸ºä¸€ä¸ªä¼—çŸ¢ä¹‹çš„ï¼Œé‚£äº›ç›²ç›®å´‡æ‹œè€…ä¹Ÿæ„è¯†åˆ°äº‹æƒ…ä¸å¯¹åŠ²ã€‚ä½†è¿™ç§æƒ…å†µå´æ™®éå­˜åœ¨ï¼šè™½ç„¶ä½ ä½¿ç”¨äº†å¤§å…¬å¸çš„æŠ€æœ¯ï¼Œä½†ä½ çš„æƒ…å†µå´ä¸ä»–ä»¬å¤§ä¸ä¸€æ ·ï¼Œè€Œä¸”ä½ çš„å†³å®šå¹¶æ²¡æœ‰ç»è¿‡æ·±æ€ç†Ÿè™‘ï¼Œä½ åªæ˜¯ä¹ ä»¥ä¸ºå¸¸åœ°è®¤ä¸ºï¼Œæ¨¡ä»¿å·¨å¤´å…¬å¸å°±ä¸€å®šä¹Ÿèƒ½ç»™ä½ å¸¦æ¥åŒæ ·çš„è´¢å¯Œã€‚</p>
<p>æ˜¯çš„ï¼Œè¿™åˆæ˜¯ä¸€ç¯‡åŠå¤§å®¶â€œä¸è¦ç›²ç›®å´‡æ‹œâ€çš„æ–‡ç« ã€‚ä¸è¿‡è¿™æ¬¡æˆ‘åˆ—å‡ºäº†ä¸€é•¿ä¸²æœ‰ç”¨çš„æ¸…å•ï¼Œæˆ–è®¸èƒ½å¤Ÿå¸®åŠ©ä½ ä»¬åšå‡ºæ›´å¥½çš„å†³å®šã€‚</p>
<a id="more"></a>
<h2 id="å¾ˆé…·çš„æŠ€æœ¯ï¼ŸUNPHAT"><a href="#å¾ˆé…·çš„æŠ€æœ¯ï¼ŸUNPHAT" class="headerlink" title="å¾ˆé…·çš„æŠ€æœ¯ï¼ŸUNPHAT"></a>å¾ˆé…·çš„æŠ€æœ¯ï¼ŸUNPHAT</h2><p>å¦‚æœä½ è¿˜åœ¨ä½¿ç”¨Googleæœç´¢æ–°æŠ€æœ¯æ¥é‡å»ºä½ çš„è½¯ä»¶æ¶æ„ï¼Œé‚£ä¹ˆæˆ‘å»ºè®®ä½ ä¸è¦å†è¿™ä¹ˆåšäº†ã€‚ç›¸åï¼Œä½ å¯ä»¥è€ƒè™‘åº”ç”¨UNPHATåŸåˆ™ã€‚</p>
<ol>
<li>åœ¨å½»åº•äº†è§£ï¼ˆUnderstandï¼‰ä½ çš„é—®é¢˜ä¹‹å‰ï¼Œä¸è¦æ€¥ç€å»å¯»æ‰¾è§£å†³æ–¹æ¡ˆã€‚ä½ çš„ç›®æ ‡åº”è¯¥æ˜¯åœ¨é—®é¢˜é¢†åŸŸå†…â€œè§£å†³â€é—®é¢˜ï¼Œè€Œä¸æ˜¯åœ¨æ–¹æ¡ˆé¢†åŸŸå†…è§£å†³é—®é¢˜ã€‚</li>
<li>åˆ—å‡ºï¼ˆeNumerateï¼‰å¤šç§æ–¹æ¡ˆï¼Œä¸è¦åªæŠŠçœ¼ç›ç›¯åœ¨ä½ æœ€å–œæ¬¢çš„æ–¹æ¡ˆä¸Šã€‚</li>
<li>é€‰æ‹©ä¸€ä¸ªå€™é€‰æ–¹æ¡ˆï¼Œå¹¶é˜…è¯»ç›¸å…³è®ºæ–‡ï¼ˆPaperï¼‰ã€‚</li>
<li>äº†è§£å€™é€‰æ–¹æ¡ˆçš„äº§ç”ŸèƒŒæ™¯ï¼ˆHistorical contextï¼‰ã€‚</li>
<li>æ¯”è¾ƒä¼˜ç‚¹ï¼ˆAdvantagesï¼‰å’Œç¼ºç‚¹ï¼Œæ‰¬é•¿é¿çŸ­ã€‚</li>
<li>æ€è€ƒï¼ˆThinkï¼‰ï¼å†·é™åœ°æ€è€ƒå€™é€‰æ–¹æ¡ˆæ˜¯å¦é€‚åˆç”¨äºè§£å†³ä½ çš„é—®é¢˜ã€‚è¦å‡ºç°æ€æ ·å¼‚å¸¸çš„æƒ…å†µæ‰ä¼šè®©ä½ æ”¹å˜æ³¨æ„ï¼Ÿä¾‹å¦‚ï¼Œæ•°æ®è¦å°‘åˆ°ä»€ä¹ˆç¨‹åº¦æ‰ä¼šè®©ä½ æ‰“æ¶ˆä½¿ç”¨Hadoopçš„å¿µå¤´ï¼Ÿ</li>
</ol>
<h2 id="ä½ ä¸æ˜¯Amazon"><a href="#ä½ ä¸æ˜¯Amazon" class="headerlink" title="ä½ ä¸æ˜¯Amazon"></a>ä½ ä¸æ˜¯Amazon</h2><p>UNPHATåŸåˆ™ååˆ†ç›´æˆªäº†å½“ã€‚æœ€è¿‘æˆ‘ä¸ä¸€ä¸ªå…¬å¸æœ‰è¿‡ä¸€æ¬¡å¯¹è¯ï¼Œè¿™ä¸ªå…¬å¸æ‰“ç®—åœ¨ä¸€ä¸ªè¯»å¯†é›†çš„ç³»ç»Ÿé‡Œä½¿ç”¨Cassandraï¼Œä»–ä»¬çš„æ•°æ®æ˜¯åœ¨å¤œé—´åŠ è½½åˆ°ç³»ç»Ÿé‡Œçš„ã€‚</p>
<p>ä»–ä»¬é˜…è¯»äº†Dynamoçš„ç›¸å…³è®ºæ–‡ï¼Œå¹¶ä¸”çŸ¥é“Cassandraæ˜¯æœ€æ¥è¿‘Dynamoçš„ä¸€ä¸ªäº§å“ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œè¿™äº›åˆ†å¸ƒå¼æ•°æ®åº“ä¼˜å…ˆä¿è¯å†™å¯ç”¨æ€§ï¼ˆAmazonæ˜¯ä¸ä¼šè®©â€œæ·»åŠ åˆ°è´­ç‰©è½¦â€è¿™ç§æ“ä½œå‡ºç°å¤±è´¥çš„ï¼‰ã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œä»–ä»¬åœ¨ä¸€è‡´æ€§ä»¥åŠå‡ ä¹æ‰€æœ‰åœ¨ä¼ ç»ŸRDBMSä¸­å‡ºç°è¿‡çš„ç‰¹æ€§ä¸Šåšå‡ºäº†å¦¥åã€‚ä½†è¿™å®¶å…¬å¸å…¶å®æ²¡æœ‰å¿…è¦ä¼˜å…ˆè€ƒè™‘å†™å¯ç”¨æ€§ï¼Œå› ä¸ºä»–ä»¬æ¯å¤©åªæœ‰ä¸€æ¬¡å†™å…¥æ“ä½œï¼Œåªæ˜¯æ•°æ®é‡æ¯”è¾ƒå¤§ã€‚</p>
<p>ä»–ä»¬ä¹‹æ‰€ä»¥è€ƒè™‘ä½¿ç”¨Cassandraï¼Œæ˜¯å› ä¸ºPostgreSQLæŸ¥è¯¢éœ€è¦è€—è´¹å‡ åˆ†é’Ÿçš„æ—¶é—´ã€‚ä»–ä»¬è®¤ä¸ºæ˜¯ç¡¬ä»¶çš„é—®é¢˜ï¼Œç»è¿‡æ’æŸ¥ï¼Œæˆ‘ä»¬å‘ç°æ•°æ®è¡¨é‡Œæœ‰5000ä¸‡æ¡æ•°æ®ï¼Œæ¯æ¡æ•°æ®æœ€å¤š80ä¸ªå­—èŠ‚ã€‚å¦‚æœä»SSDä¸Šæ•´å—åœ°è¯»å–æ‰€æœ‰æ•°æ®å¤§æ¦‚éœ€è¦5ç§’é’Ÿï¼Œè¿™ä¸ªä¸ç®—å¿«ï¼Œä½†æ¯”èµ·å®é™…çš„æŸ¥è¯¢ï¼Œå®ƒè¦å¿«ä¸Šä¸¤ä¸ªæ•°é‡çº§ã€‚</p>
<p>æˆ‘çœŸçš„å¾ˆæƒ³å¤šé—®ä»–ä»¬å‡ ä¸ªé—®é¢˜ï¼ˆäº†è§£é—®é¢˜ï¼ï¼‰ï¼Œåœ¨é—®é¢˜å˜å¾—æ„ˆåŠ ä¸¥é‡æ—¶ï¼Œæˆ‘ä¸ºä»–ä»¬å‡†å¤‡äº†5ä¸ªæ–¹æ¡ˆï¼ˆåˆ—å‡ºå¤šä¸ªå€™é€‰æ–¹æ¡ˆï¼ï¼‰ï¼Œä¸è¿‡å¾ˆæ˜¾ç„¶ï¼ŒCassandraå¯¹äºä»–ä»¬æ¥è¯´å®Œå…¨æ˜¯ä¸€ä¸ªé”™è¯¯çš„æ–¹æ¡ˆã€‚ä»–ä»¬åªéœ€è¦è€å¿ƒåœ°åšä¸€äº›è°ƒä¼˜ï¼Œæ¯”å¦‚å¯¹éƒ¨åˆ†æ•°æ®é‡æ–°å»ºæ¨¡ï¼Œæˆ–è®¸å¯ä»¥è€ƒè™‘ä½¿ç”¨ï¼ˆå½“ç„¶ä¹Ÿæœ‰å¯èƒ½æ²¡æœ‰ï¼‰å…¶ä»–æŠ€æœ¯â€¦â€¦ä½†ä¸€å®šä¸æ˜¯è¿™ç§å†™é«˜å¯ç”¨çš„é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼ŒAmazonå½“åˆåˆ›å»ºCassandraæ˜¯ç”¨æ¥è§£å†³ä»–ä»¬çš„è´­ç‰©è½¦é—®é¢˜çš„ï¼</p>
<h2 id="ä½ ä¸æ˜¯LinkedIn"><a href="#ä½ ä¸æ˜¯LinkedIn" class="headerlink" title="ä½ ä¸æ˜¯LinkedIn"></a>ä½ ä¸æ˜¯LinkedIn</h2><p>æˆ‘å‘ç°ä¸€ä¸ªå­¦ç”Ÿåˆ›åŠçš„å°å…¬å¸å±…ç„¶åœ¨ä»–ä»¬çš„ç³»ç»Ÿé‡Œä½¿ç”¨Kafkaï¼Œè¿™è®©æˆ‘æ„Ÿåˆ°å¾ˆæƒŠè®¶ã€‚å› ä¸ºæ®æˆ‘æ‰€çŸ¥ï¼Œä»–ä»¬æ¯å¤©åªæœ‰å¾ˆå°‘çš„äº‹åŠ¡éœ€è¦å¤„ç†â€”â€”æœ€å¥½çš„æƒ…å†µä¸‹ï¼Œä¸€å¤©æœ€å¤šåªæœ‰å‡ ç™¾ä¸ªã€‚è¿™æ ·çš„ååé‡å‡ ä¹å¯ä»¥ç›´æ¥è®°åœ¨è®°äº‹æœ¬ä¸Šã€‚</p>
<p>Kafkaè¢«è®¾è®¡ç”¨äºå¤„ç†LinkedInå†…éƒ¨çš„ååé‡ï¼Œé‚£å¯æ˜¯ä¸€ä¸ªå¤©æ–‡æ•°å­—ã€‚å³ä½¿æ˜¯åœ¨å‡ å¹´å‰ï¼Œè¿™ä¸ªæ•°å­—å·²ç»è¾¾åˆ°äº†æ¯å¤©æ•°ä¸‡äº¿ï¼Œåœ¨é«˜å³°æ—¶æ®µæ¯ç§’é’Ÿéœ€è¦å¤„ç†1000ä¸‡ä¸ªæ¶ˆæ¯ã€‚ä¸è¿‡Kafkaä¹Ÿå¯ä»¥ç”¨äºå¤„ç†ä½ååé‡çš„è´Ÿè½½ï¼Œæˆ–è®¸å†ä½10ä¸ªæ•°é‡çº§ï¼Ÿ</p>
<p>æˆ–è®¸å·¥ç¨‹å¸ˆä»¬åœ¨åšå†³å®šæ—¶ç¡®å®æ˜¯åŸºäºä»–ä»¬çš„é¢„æœŸéœ€æ±‚ï¼Œå¹¶ä¸”ä¹Ÿå¾ˆäº†è§£Kafkaçš„é€‚ç”¨åœºæ™¯ã€‚ä½†æˆ‘çŒœæµ‹ä»–ä»¬æ˜¯æŠµæŒ¡ä¸ä½ç¤¾åŒºå¯¹Kafkaçš„è¿½æ§ï¼Œå¹¶æ²¡æœ‰ä»”ç»†æƒ³è¿‡Kafkaæ˜¯å¦é€‚åˆä»–ä»¬ã€‚è¦çŸ¥é“ï¼Œé‚£å¯æ˜¯10ä¸ªæ•°é‡çº§çš„å·®è·ï¼</p>
<h2 id="å†ä¸€æ¬¡ï¼Œä½ ä¸æ˜¯Amazon"><a href="#å†ä¸€æ¬¡ï¼Œä½ ä¸æ˜¯Amazon" class="headerlink" title="å†ä¸€æ¬¡ï¼Œä½ ä¸æ˜¯Amazon"></a>å†ä¸€æ¬¡ï¼Œä½ ä¸æ˜¯Amazon</h2><p>æ¯”Amazonçš„åˆ†å¸ƒå¼æ•°æ®åº“æ›´ä¸ºè‘—åçš„æ˜¯å®ƒçš„å¯ä¼¸ç¼©æ¶æ„æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯é¢å‘æœåŠ¡æ¶æ„ã€‚Werner Vogelsåœ¨2006å¹´çš„ä¸€æ¬¡è®¿è°ˆä¸­æŒ‡å‡ºï¼ŒAmazonåœ¨2001å¹´æ—¶å°±æ„è¯†åˆ°ä»–ä»¬çš„å‰ç«¯éœ€è¦æ¨ªå‘ä¼¸ç¼©ï¼Œè€Œé¢å‘æœåŠ¡æ¶æ„æœ‰åŠ©äºä»–ä»¬å®ç°å‰ç«¯ä¼¸ç¼©ã€‚å·¥ç¨‹å¸ˆä»¬é¢é¢ç›¸è§‘ï¼Œæœ€ååªæœ‰å°‘æ•°å‡ ä¸ªå·¥ç¨‹å¸ˆç€æ‰‹å»åšè¿™ä»¶äº‹æƒ…ï¼Œè€Œå‡ ä¹æ²¡æœ‰äººæ„¿æ„å°†ä»–ä»¬çš„é™æ€ç½‘é¡µæ‹†åˆ†æˆå°å‹çš„æœåŠ¡ã€‚</p>
<p>ä¸è¿‡Amazonè¿˜æ˜¯å†³å®šå‘SOAè½¬å‹ï¼Œä»–ä»¬å½“æ—¶æœ‰7800ä¸ªå‘˜å·¥å’Œ30äº¿ç¾å…ƒçš„é”€å”®è§„æ¨¡ã€‚</p>
<p>å½“ç„¶ï¼Œå¹¶ä¸æ˜¯è¯´ä½ ä¹Ÿè¦ç­‰åˆ°æœ‰7800ä¸ªå‘˜å·¥çš„æ—¶å€™æ‰èƒ½è½¬å‘SOAâ€¦â€¦åªæ˜¯ä½ è¦å¤šæƒ³æƒ³ï¼Œå®ƒçœŸçš„èƒ½è§£å†³ä½ çš„é—®é¢˜å—ï¼Ÿä½ çš„é—®é¢˜çš„æ ¹æºæ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥é€šè¿‡å…¶ä»–çš„æ–¹å¼è§£å†³å®ƒä»¬å—ï¼Ÿ</p>
<p>å¦‚æœä½ å‘Šè¯‰æˆ‘è¯´ï¼Œä½ é‚£50ä¸ªäººçš„å…¬å¸æ‰“ç®—è½¬å‘SOAï¼Œé‚£ä¹ˆæˆ‘ä¸ç¦æ„Ÿåˆ°ç–‘æƒ‘ï¼šä¸ºä»€ä¹ˆå¾ˆå¤šå¤§å‹çš„å…¬å¸ä»ç„¶åœ¨ä¹æ­¤ä¸å½¼åœ°ä½¿ç”¨å…·æœ‰æ¨¡å—åŒ–çš„å¤§å‹å•ä½“åº”ç”¨ï¼Ÿ</p>
<h2 id="ç”šè‡³Googleä¹Ÿä¸æ˜¯Google"><a href="#ç”šè‡³Googleä¹Ÿä¸æ˜¯Google" class="headerlink" title="ç”šè‡³Googleä¹Ÿä¸æ˜¯Google"></a>ç”šè‡³Googleä¹Ÿä¸æ˜¯Google</h2><p>ä½¿ç”¨Hadoopå’ŒSparkè¿™æ ·çš„å¤§è§„æ¨¡æ•°æ®æµå¼•æ“ä¼šéå¸¸æœ‰è¶£ï¼Œä½†åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œä¼ ç»Ÿçš„DBMSæ›´é€‚åˆå½“å‰çš„è´Ÿè½½ï¼Œæœ‰æ—¶å€™æ•°æ®é‡å°åˆ°å¯ä»¥ç›´æ¥æ”¾è¿›å†…å­˜ã€‚ä½ æ˜¯å¦æ„¿æ„èŠ±10,000ç¾é‡‘å»è´­ä¹°1TBçš„å†…å­˜ï¼Ÿå¦‚æœä½ æœ‰åäº¿ä¸ªç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·ä»…èƒ½ä½¿ç”¨1KBçš„å†…å­˜ï¼Œæ‰€ä»¥ä½ çš„æŠ•å…¥è¿œè¿œä¸å¤Ÿã€‚</p>
<p>æˆ–è®¸ä½ çš„è´Ÿè½½å¤§åˆ°éœ€è¦æŠŠæ•°æ®å†™å›ç£ç›˜ã€‚é‚£ä¹ˆä½ éœ€è¦å¤šå°‘ç£ç›˜ï¼Ÿä½ åˆ°åº•æœ‰å¤šå°‘æ•°æ®é‡ï¼ŸGoogleä¹‹æ‰€ä»¥è¦åˆ›å»ºGFSå’ŒMapReduceï¼Œæ˜¯è¦è§£å†³æ•´ä¸ªWebçš„è®¡ç®—é—®é¢˜ï¼Œæ¯”å¦‚é‡å»ºæ•´ä¸ªWebçš„æœç´¢ç´¢å¼•ã€‚</p>
<p>æˆ–è®¸ä½ å·²ç»é˜…è¯»è¿‡GFSå’ŒMapReduceçš„è®ºæ–‡ï¼ŒGoogleçš„éƒ¨åˆ†é—®é¢˜åœ¨äºååé‡ï¼Œè€Œä¸æ˜¯å®¹é‡ï¼Œä»–ä»¬ä¹‹æ‰€ä»¥éœ€è¦åˆ†å¸ƒå¼çš„å­˜å‚¨ï¼Œæ˜¯å› ä¸ºä»ç£ç›˜è¯»å–å­—èŠ‚æµè¦èŠ±è´¹å¤ªå¤šçš„æ—¶é—´ã€‚é‚£ä¹ˆä½ åœ¨2017å¹´éœ€è¦ä½¿ç”¨å¤šå°‘è®¾å¤‡ååé‡ï¼Ÿä½ ä¸€å®šä¸éœ€è¦åƒGoogleé‚£ä¹ˆå¤§çš„ååé‡ï¼Œæ‰€ä»¥ä½ å¯èƒ½ä¼šè€ƒè™‘ä½¿ç”¨æ›´å¥½çš„è®¾å¤‡ã€‚å¦‚æœéƒ½ç”¨ä¸ŠSSDä¼šç»™ä½ å¢åŠ å¤šå°‘æˆæœ¬ï¼Ÿ</p>
<p>æˆ–è®¸ä½ è¿˜æƒ³è¦ä¼¸ç¼©æ€§ã€‚ä½†ä½ æœ‰ä»”ç»†ç®—è¿‡å—ï¼Œä½ çš„æ•°æ®å¢é•¿é€Ÿåº¦ä¼šå¿«è¿‡SSDé™ä»·çš„é€Ÿåº¦å—ï¼Ÿåœ¨ä½ çš„æ•°æ®æ’‘çˆ†æ‰€æœ‰çš„æœºå™¨ä¹‹å‰ï¼Œä½ çš„ä¸šåŠ¡ä¼šæœ‰å¤šå°‘å¢é•¿ï¼Ÿæˆªæ­¢2016å¹´ï¼ŒStack Exchangeæ¯å¤©è¦å¤„ç†2äº¿ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯ä»–ä»¬åªç”¨äº†4ä¸ªSQL Serverï¼Œä¸€ä¸ªç”¨äºStack Overflowï¼Œä¸€ä¸ªç”¨äºå…¶ä»–ç”¨é€”ï¼Œå¦å¤–ä¸¤ä¸ªä½œä¸ºå¤‡ä»½å¤æœ¬ã€‚</p>
<p>æˆ–è®¸ä½ åœ¨åº”ç”¨UNPHATåŸåˆ™ä¹‹åï¼Œä»ç„¶å†³å®šè¦ä½¿ç”¨Hadoopæˆ–Sparkã€‚æˆ–è®¸ä½ çš„å†³å®šæ˜¯å¯¹çš„ï¼Œä½†å…³é”®çš„æ˜¯ä½ è¦ç”¨å¯¹å·¥å…·ã€‚Googleéå¸¸æ˜ç™½è¿™ä¸ªé“ç†ï¼Œå½“ä»–ä»¬æ„è¯†åˆ°MapReduceä¸å†é€‚åˆç”¨äºæ„å»ºç´¢å¼•ä¹‹åï¼Œä»–ä»¬å°±ä¸å†ä½¿ç”¨å®ƒã€‚</p>
<h2 id="å…ˆäº†è§£ä½ çš„é—®é¢˜"><a href="#å…ˆäº†è§£ä½ çš„é—®é¢˜" class="headerlink" title="å…ˆäº†è§£ä½ çš„é—®é¢˜"></a>å…ˆäº†è§£ä½ çš„é—®é¢˜</h2><p>æˆ‘æ‰€è¯´çš„ä¹Ÿä¸æ˜¯ä»€ä¹ˆæ–°è§‚ç‚¹ï¼Œä¸è¿‡æˆ–è®¸UNPHATå¯¹äºä½ ä»¬æ¥è¯´å·²ç»è¶³å¤Ÿäº†ã€‚å¦‚æœä½ è§‰å¾—è¿˜ä¸å¤Ÿï¼Œå¯ä»¥å¬å¬Rich Hickeyçš„æ¼”è®²â€œ<a href="https://www.youtube.com/watch?v=f84n5oFoZBc" target="_blank" rel="external">åŠåºŠé©±åŠ¨å¼€å‘</a>â€ï¼Œæˆ–è€…çœ‹çœ‹Polyaçš„ä¹¦ã€Š<a href="https://www.amazon.com/How-Solve-Mathematical-Princeton-Science/dp/069111966X?ie=UTF8&amp;%2aVersion%2a=1&amp;%2aentries%2a=0" target="_blank" rel="external">How to Solve It</a>ã€‹ï¼Œ æˆ–è€…å­¦ä¹ ä¸€ä¸‹Hammingçš„è¯¾ç¨‹â€œ<a href="https://www.youtube.com/playlist?list=PL2FF649D0C4407B30" target="_blank" rel="external">The Art of Doing Science and Engineering</a>â€ã€‚æˆ‘æ³è¯·ä½ ä»¬ä¸€å®šè¦å¤šæ€è€ƒï¼åœ¨å°è¯•è§£å†³é—®é¢˜ä¹‹å‰å…ˆå¯¹å®ƒä»¬æœ‰å……åˆ†çš„äº†è§£ã€‚æœ€åé€ä¸ŠPolyaçš„ä¸€ä¸ªé‡‘å¥åè¨€ï¼š</p>
<blockquote>
<p>å›ç­”ä¸€ä¸ªä½ ä¸äº†è§£çš„é—®é¢˜æ˜¯æ„šè ¢çš„ï¼Œåˆ°è¾¾ä¸€ä¸ªä½ ä¸æœŸæœ›çš„ç»ˆç‚¹æ˜¯æ‚²å“€çš„ã€‚</p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[é«˜è´Ÿè½½å¾®æœåŠ¡ç³»ç»Ÿçš„è¯ç”Ÿè¿‡ç¨‹]]></title>
      <url>http://team.jiunile.com/blog/2017/07/microservice-%E9%AB%98%E8%B4%9F%E8%BD%BD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%B3%BB%E7%BB%9F%E7%9A%84%E8%AF%9E%E7%94%9F%E8%BF%87%E7%A8%8B.html</url>
      <content type="html"><![CDATA[<p><img src="/images/ms/02/cover.png" alt="å°é¢"></p>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>åœ¨2016 <a href="http://highload.co/" target="_blank" rel="external">LighLoad++</a>å¤§ä¼šä¸Šï¼Œâ€œM-Texâ€çš„å¼€å‘ç»ç†Vadim Madisonè®²è¿°äº†ä»ä¸€ä¸ªç”±æ•°ç™¾ä¸ªå¾®æœåŠ¡ç»„æˆçš„ç³»ç»Ÿåˆ°åŒ…å«æ•°åƒä¸ªå¾®æœåŠ¡çš„é«˜è´Ÿè½½é¡¹ç›®çš„å‘å±•å†ç¨‹ã€‚æœ¬æ–‡å·²è·å¾—ç¿»è¯‘æˆæƒï¼ŒæŸ¥çœ‹è‹±æ–‡åŸæ–‡ï¼š<a href="https://kukuruku.co/post/microservices-in-a-high-load-project/" target="_blank" rel="external">Microservices in a High-Load Project</a> ã€‚</p>
<p>æˆ‘å°†å‘Šè¯‰å¤§å®¶æˆ‘ä»¬æ˜¯å¦‚ä½•å¼€å§‹ä¸€ä¸ªé«˜è´Ÿè½½å¾®æœåŠ¡é¡¹ç›®çš„ã€‚åœ¨è®²è¿°æˆ‘ä»¬çš„ç»å†ä¹‹å‰ï¼Œå…ˆè®©æˆ‘ä»¬ç®€å•åœ°è‡ªæˆ‘ä»‹ç»ä¸€ä¸‹ã€‚</p>
<p>ç®€å•åœ°è¯´ï¼Œæˆ‘ä»¬ä»äº‹è§†é¢‘è¾“å‡ºæ–¹é¢çš„å·¥ä½œâ€”â€”æˆ‘ä»¬æä¾›å®æ—¶çš„è§†é¢‘ã€‚æˆ‘ä»¬è´Ÿè´£â€œNTV-Plusâ€å’Œâ€œMatch TVâ€é¢‘é“çš„è§†é¢‘å¹³å°ã€‚è¯¥å¹³å°æœ‰30ä¸‡çš„å¹¶å‘ç”¨æˆ·ï¼Œæ¯å°æ—¶è¾“å‡º300TBçš„å†…å®¹ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ä»»åŠ¡ã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p>
<p>è¿™èƒŒåéƒ½æœ‰å“ªäº›æ•…äº‹ï¼Ÿè¿™äº›æ•…äº‹éƒ½æ˜¯å…³äºé¡¹ç›®çš„å¼€å‘å’Œæˆé•¿ï¼Œå…³äºæˆ‘ä»¬å¯¹é¡¹ç›®çš„æ€è€ƒã€‚æ€»è€Œè¨€ä¹‹ï¼Œæ˜¯å…³äºå¦‚ä½•æå‡é¡¹ç›®çš„ä¼¸ç¼©èƒ½åŠ›ï¼Œæ‰¿å—æ›´å¤§çš„è´Ÿè½½ï¼Œåœ¨ä¸å®•æœºå’Œä¸ä¸¢å¤±å…³é”®ç‰¹æ€§çš„æƒ…å†µä¸‹ä¸ºå®¢æˆ·æä¾›æ›´å¤šçš„åŠŸèƒ½ã€‚æˆ‘ä»¬æ€»æ˜¯å¸Œæœ›èƒ½å¤Ÿæ»¡è¶³å®¢æˆ·çš„éœ€æ±‚ã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿæ¶‰åŠåˆ°æˆ‘ä»¬æ˜¯å¦‚ä½•å®ç°è¿™ä¸€åˆ‡ï¼Œä»¥åŠè¿™ä¸€åˆ‡æ˜¯å¦‚ä½•å¼€å§‹çš„ã€‚</p>
<a id="more"></a>
<p><strong>åœ¨æœ€å¼€å§‹ï¼Œæˆ‘ä»¬æœ‰ä¸¤å°è¿è¡Œåœ¨Dockeré›†ç¾¤é‡Œçš„æœåŠ¡å™¨ï¼Œæ•°æ®åº“è¿è¡Œåœ¨ç›¸åŒæœºå™¨çš„å®¹å™¨é‡Œã€‚æ²¡æœ‰ä¸“ç”¨çš„å­˜å‚¨ï¼ŒåŸºç¡€è®¾æ–½éå¸¸ç®€å•ã€‚</strong></p>
<p>æˆ‘ä»¬å°±æ˜¯è¿™æ ·å¼€å§‹çš„ï¼Œåªæœ‰ä¸¤å°è¿è¡Œåœ¨Dockeré›†ç¾¤é‡Œçš„æœåŠ¡å™¨ã€‚é‚£ä¸ªæ—¶å€™ï¼Œæ•°æ®åº“ä¹Ÿè¿è¡Œåœ¨åŒä¸€ä¸ªé›†ç¾¤é‡Œã€‚æˆ‘ä»¬çš„åŸºç¡€è®¾æ–½é‡Œæ²¡æœ‰ä»€ä¹ˆä¸“ç”¨çš„ç»„ä»¶ï¼Œååˆ†ç®€å•ã€‚<br><img src="/images/ms/02/00.jpg" alt="00"></p>
<p>æˆ‘ä»¬çš„åŸºç¡€è®¾æ–½æœ€ä¸»è¦çš„ç»„ä»¶å°±æ˜¯Dockerå’ŒTeamCityï¼Œæˆ‘ä»¬ç”¨å®ƒä»¬æ¥äº¤ä»˜å’Œæ„å»ºä»£ç ã€‚</p>
<p>åœ¨æ¥ä¸‹æ¥çš„æ—¶æœŸâ€”â€”æˆ‘ç§°å…¶ä¸ºæˆ‘ä»¬çš„å‘å±•ä¸­æœŸâ€”â€”æ˜¯æˆ‘ä»¬é¡¹ç›®å‘å±•çš„å…³é”®æ—¶æœŸã€‚æˆ‘ä»¬æ‹¥æœ‰äº†80å°æœåŠ¡å™¨ï¼Œå¹¶åœ¨ä¸€ç»„ç‰¹æ®Šçš„æœºå™¨ä¸Šä¸ºæ•°æ®åº“æ­å»ºäº†ä¸€ä¸ªå•ç‹¬çš„ä¸“ç”¨é›†ç¾¤ã€‚æˆ‘ä»¬å¼€å§‹ä½¿ç”¨åŸºäºCEPHçš„åˆ†å¸ƒå¼å­˜å‚¨ï¼Œå¹¶å¼€å§‹æ€è€ƒæœåŠ¡ä¹‹é—´çš„äº¤äº’é—®é¢˜ï¼ŒåŒæ—¶è¦æ›´æ–°æˆ‘ä»¬çš„ç›‘æ§ç³»ç»Ÿã€‚</p>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘ä»¬åœ¨è¿™ä¸€æ—¶æœŸéƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚Dockeré›†ç¾¤é‡Œå·²ç»æœ‰æ•°ç™¾å°æœåŠ¡å™¨ï¼Œå¾®æœåŠ¡å°±è¿è¡Œåœ¨å®ƒä»¬ä¸Šé¢ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¼€å§‹æ ¹æ®æ•°æ®æ€»çº¿å’Œé€»è¾‘åˆ†ç¦»åŸåˆ™å°†æˆ‘ä»¬çš„ç³»ç»Ÿæ‹†åˆ†æˆæœåŠ¡å­ç³»ç»Ÿã€‚å½“å¾®æœåŠ¡è¶Šæ¥è¶Šå¤šæ—¶ï¼Œæˆ‘ä»¬å†³å®šæ‹†åˆ†æˆ‘ä»¬çš„ç³»ç»Ÿï¼Œè¿™æ ·ç»´æŠ¤èµ·æ¥å°±å®¹æ˜“å¾—å¤šï¼ˆä¹Ÿæ›´å®¹æ˜“ç†è§£ï¼‰ã€‚<br><img src="/images/ms/02/01.jpg" alt="01"></p>
<p>è¿™å¼ å›¾å±•ç¤ºçš„æ˜¯æˆ‘ä»¬ç³»ç»Ÿå…¶ä¸­çš„ä¸€å°éƒ¨åˆ†ã€‚è¿™éƒ¨åˆ†ç³»ç»Ÿè´Ÿè´£è§†é¢‘å‰ªåˆ‡ã€‚åŠå¹´å‰ï¼Œæˆ‘åœ¨â€œRIT++â€ä¹Ÿå±•ç¤ºè¿‡ç±»ä¼¼çš„å›¾ç‰‡ã€‚é‚£ä¸ªæ—¶å€™åªæœ‰17ä¸ªç»¿è‰²çš„å¾®æœåŠ¡ï¼Œè€Œç°åœ¨æœ‰28ä¸ªç»¿è‰²çš„å¾®æœåŠ¡ã€‚è¿™äº›æœåŠ¡åªå æˆ‘ä»¬æ•´ä¸ªç³»ç»Ÿçš„äºŒååˆ†ä¹‹ä¸€ï¼Œæ‰€ä»¥å¯ä»¥æƒ³è±¡æˆ‘ä»¬ç³»ç»Ÿå¤§è‡´çš„è§„æ¨¡æœ‰å¤šå¤§ã€‚</p>
<h2 id="æ·±å…¥ç»†èŠ‚"><a href="#æ·±å…¥ç»†èŠ‚" class="headerlink" title="æ·±å…¥ç»†èŠ‚"></a>æ·±å…¥ç»†èŠ‚</h2><p>æœåŠ¡é—´çš„é€šä¿¡æ˜¯ä¸€ä»¶å¾ˆæœ‰è¶£çš„äº‹æƒ…ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬åº”è¯¥å°½å¯èƒ½æå‡æœåŠ¡é—´é€šä¿¡æ•ˆç‡ã€‚æˆ‘ä»¬ä½¿ç”¨äº†<a href="https://developers.google.com/protocol-buffers/" target="_blank" rel="external">protobuf</a>ï¼Œæˆ‘ä»¬è®¤ä¸ºå®ƒå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ä¸œè¥¿ã€‚</p>
<p>å®ƒçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š<br><img src="/images/ms/02/02.jpg" alt="02"></p>
<p>å¾®æœåŠ¡çš„å‰é¢æœ‰ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ã€‚è¯·æ±‚åˆ°è¾¾å‰ç«¯ï¼Œæˆ–è€…ç›´æ¥å‘é€ç»™æä¾›äº†JSON APIçš„æœåŠ¡ã€‚protobufè¢«ç”¨äºå†…éƒ¨æœåŠ¡ä¹‹é—´çš„äº¤äº’ã€‚</p>
<p>protobufçœŸæ˜¯ä¸€ä¸ªå¥½ä¸œè¥¿ã€‚å®ƒä¸ºæ¶ˆæ¯æä¾›äº†å¾ˆå¥½çš„å‹ç¼©ç‡ã€‚ç°å¦‚ä»Šæœ‰å¾ˆå¤šæ¡†æ¶ï¼Œåªè¦ä½¿ç”¨å¾ˆå°çš„å¼€é”€å°±èƒ½å®ç°åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚æˆ‘ä»¬å¯ä»¥å°†å…¶è§†ä¸ºæœ‰æ¡ä»¶çš„è¯·æ±‚ç±»å‹ã€‚</p>
<p>ä½†å¦‚æœä»å¾®æœåŠ¡è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œå¾®æœåŠ¡ä¹‹é—´ä¹Ÿå­˜åœ¨æŸç§ç§æœ‰çš„åè®®ã€‚å¦‚æœåªæœ‰ä¸€ä¸¤ä¸ªæˆ–è€…äº”ä¸ªå¾®æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªå¾®æœåŠ¡æ‰“å¼€ä¸€ä¸ªæ§åˆ¶å°ï¼Œé€šè¿‡å®ƒä»¬æ¥è®¿é—®å¾®æœåŠ¡ï¼Œå¹¶è·å¾—å“åº”ç»“æœã€‚å¦‚æœå‡ºç°äº†é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å…¶è¿›è¡Œè¯Šæ–­ã€‚ä¸è¿‡è¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šè®©å¾®æœåŠ¡çš„æ”¯æŒå·¥ä½œå˜å¾—å¤æ‚ã€‚</p>
<p>åœ¨ä¸€å®šæ—¶æœŸå†…ï¼Œè¿™å€’ä¸æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸ºå¹¶æ²¡æœ‰å¤ªå¤šçš„å¾®æœåŠ¡ã€‚å¦å¤–ï¼ŒGoogleå‘å¸ƒäº†<a href="https://grpc.io/" target="_blank" rel="external">gRPC</a>ã€‚åœ¨é‚£ä¸ªæ—¶å€™ï¼ŒgRPCæ»¡è¶³äº†æ‰€æœ‰æˆ‘ä»¬æƒ³åšçš„äº‹æƒ…ã€‚äºæ˜¯æˆ‘ä»¬é€æ¸è¿ç§»åˆ°gRPCã€‚äºæ˜¯æˆ‘ä»¬çš„æŠ€æœ¯æ ˆé‡Œå‡ºç°äº†å¦ä¸€ä¸ªç»„ä»¶ã€‚<br><img src="/images/ms/02/03.jpg" alt="03"></p>
<p>å®ç°çš„ç»†èŠ‚ä¹Ÿæ˜¯å¾ˆæœ‰è¶£çš„ã€‚gRPCé»˜è®¤æ˜¯åŸºäºHTTP/2çš„ã€‚å¦‚æœä½ çš„ç¯å¢ƒç›¸å¯¹ç¨³å®šï¼Œåº”ç”¨ç¨‹åºä¸æ€ä¹ˆå‘ç”Ÿå˜æ›´ï¼Œä¹Ÿä¸éœ€è¦åœ¨æœºå™¨é—´è¿ç§»ï¼Œé‚£ä¹ˆgRCPå¯¹äºä½ æ¥è¯´å°±æ˜¯ä¸ªä¸é”™çš„ä¸œè¥¿ã€‚å¦å¤–ï¼ŒgRPCæ”¯æŒå¾ˆå¤šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„ç¼–ç¨‹è¯­è¨€ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬ä»å¾®æœåŠ¡è§’åº¦æ¥çœ‹å¾…è¿™ä¸ªé—®é¢˜ã€‚ä»ä¸€æ–¹é¢æ¥çœ‹ï¼ŒgRPCæ˜¯ä¸€ä¸ªå¥½ä¸œè¥¿ï¼Œä½†ä»å¦ä¸€æ–¹é¢æ¥çœ‹ï¼Œå®ƒä¹Ÿæœ‰ä¸è¶³ä¹‹å¤„ã€‚å½“æˆ‘ä»¬å¼€å§‹å¯¹æ—¥å¿—è¿›è¡Œæ ‡å‡†åŒ–ï¼ˆè¿™æ ·å°±å¯ä»¥å°†å®ƒä»¬èšåˆåˆ°ä¸€ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿé‡Œï¼‰æ—¶ï¼Œæˆ‘ä»¬å‘ç°ï¼Œä»gRPCä¸­æŠ½å–æ—¥å¿—éå¸¸éº»çƒ¦ã€‚</p>
<p>äºæ˜¯ï¼Œæˆ‘ä»¬å†³å®šå¼€å‘è‡ªå·±çš„æ—¥å¿—ç³»ç»Ÿã€‚å®ƒè§£ææ¶ˆæ¯ï¼Œå¹¶å°†å®ƒä»¬è½¬æˆæˆ‘ä»¬éœ€è¦çš„æ ¼å¼ã€‚è¿™æ ·æˆ‘ä»¬æ‰å¯ä»¥è·å¾—æˆ‘ä»¬æƒ³è¦çš„æ—¥å¿—ã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ·»åŠ æ–°çš„å¾®æœåŠ¡ä¼šè®©æœåŠ¡é—´çš„ä¾èµ–å˜å¾—æ›´åŠ å¤æ‚ã€‚è¿™æ˜¯å¾®æœåŠ¡ä¸€ç›´å­˜åœ¨çš„é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯é™¤ç‰ˆæœ¬é—®é¢˜ä¹‹å¤–çš„å¦ä¸€ä¸ªå…·æœ‰ä¸€å®šå¤æ‚æ€§çš„é—®é¢˜ã€‚</p>
<p>äºæ˜¯ï¼Œæˆ‘ä»¬å¼€å§‹è€ƒè™‘ä½¿ç”¨JSONã€‚åœ¨å¾ˆé•¿çš„ä¸€æ®µæ—¶é—´é‡Œï¼Œæˆ‘ä»¬æ— æ³•ç›¸ä¿¡ï¼Œåœ¨ä½¿ç”¨äº†ç´§å‡‘çš„äºŒè¿›åˆ¶åè®®ä¹‹åä¼šè½¬å›ä½¿ç”¨JSONã€‚æœ‰ä¸€å¤©ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€ç¯‡æ–‡ç« ï¼Œæ¥è‡ª<a href="http://engineering.dailymotion.com/" target="_blank" rel="external">DailyMotion</a>çš„ä¸€ä¸ªå®¶ä¼™åœ¨æ–‡ç« é‡Œæåˆ°äº†åŒæ ·çš„äº‹æƒ…ï¼šâ€œæˆ‘ä»¬çŸ¥é“è¯¥å¦‚ä½•ä½¿ç”¨JSONï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥ä½¿ç”¨JSONã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è‡ªå¯»çƒ¦æ¼å‘¢ï¼Ÿâ€<br><img src="/images/ms/02/04.jpg" alt="04"></p>
<p>äºæ˜¯ï¼Œæˆ‘ä»¬é€æ¸ä»gRPCè½¬å‘æˆ‘ä»¬è‡ªå·±å®ç°çš„JSONã€‚æˆ‘ä»¬ä¿ç•™äº†HTTP/2ï¼Œå®ƒä¸JSONç»„åˆèµ·æ¥å¯ä»¥å¸¦æ¥æ›´å¿«çš„é€Ÿåº¦ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å…·å¤‡äº†æ‰€æœ‰å¿…è¦çš„ç‰¹æ€§ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡cURLè®¿é—®æˆ‘ä»¬çš„æœåŠ¡ã€‚æˆ‘ä»¬çš„QAå›¢é˜Ÿä½¿ç”¨<a href="https://www.getpostman.com/" target="_blank" rel="external">Postman</a>ï¼Œæ‰€ä»¥ä»–ä»¬ä¹Ÿæ„Ÿè§‰å¾ˆæ»¡æ„ã€‚ä¸€åˆ‡éƒ½å˜å¾—ç®€å•èµ·æ¥ã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰äº‰è®®æ€§çš„å†³å®šï¼Œä½†å´ä¸ºæˆ‘ä»¬å¸¦æ¥äº†å¾ˆå¤šå¥½å¤„ã€‚</p>
<p>JSONå”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯å®ƒçš„ç´§å‡‘æ€§ä¸è¶³ã€‚æ ¹æ®æˆ‘ä»¬çš„æµ‹è¯•ç»“æœï¼Œå®ƒä¸MessagePackä¹‹é—´æœ‰30%çš„å·®è·ã€‚ä¸è¿‡å¯¹äºä¸€ä¸ªæ”¯æŒç³»ç»Ÿæ¥è¯´ï¼Œè¿™ä¸ç®—æ˜¯ä¸ªå¤§é—®é¢˜ã€‚</p>
<p>å†µä¸”ï¼Œæˆ‘ä»¬åœ¨è½¬åˆ°JSONä¹‹åè¿˜è·å¾—äº†æ›´å¤šçš„ç‰¹æ€§ï¼Œæ¯”å¦‚åè®®ç‰ˆæœ¬ã€‚æœ‰æ—¶å€™ï¼Œå½“æˆ‘ä»¬åœ¨æ–°ç‰ˆæœ¬çš„åè®®ä¸Šä½¿ç”¨protobufæ—¶ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¿…é¡»æ”¹ç”¨protobufã€‚å¦‚æœä½ æœ‰æ•°ç™¾ä¸ªæœåŠ¡ï¼Œå°±ç®—åªæœ‰10%çš„æœåŠ¡è¿›è¡Œäº†è¿ç§»ï¼Œè¿™ä¹Ÿä¼šå¼•èµ·å¾ˆå¤§çš„è¿é”ååº”ã€‚ä½ åœ¨ä¸€ä¸ªæœåŠ¡ä¸Šåšäº†ä¸€äº›å˜æ›´ï¼Œå°±ä¼šæœ‰åå¤šä¸ªæœåŠ¡ä¹Ÿéœ€è¦è·Ÿç€æ”¹åŠ¨ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å°±ä¼šé¢ä¸´è¿™æ ·çš„ä¸€ç§æƒ…å†µï¼Œä¸€ä¸ªæœåŠ¡çš„å¼€å‘äººå‘˜å·²ç»å‘å¸ƒäº†ç¬¬äº”ä¸ªã€ç¬¬å…­ä¸ªï¼Œç”šè‡³ç¬¬ä¸ƒä¸ªç‰ˆæœ¬ï¼Œä½†ç”Ÿäº§ç¯å¢ƒé‡Œä»ç„¶åœ¨è¿è¡Œç¬¬å››ä¸ªç‰ˆæœ¬ï¼Œå°±å› ä¸ºå…¶ä»–ç›¸å…³æœåŠ¡çš„å¼€å‘äººå‘˜æœ‰ä»–ä»¬è‡ªå·±çš„ä¼˜å…ˆçº§å’Œæˆªæ­¢æ—¥æœŸã€‚ä»–ä»¬æ— æ³•æŒç»­åœ°æ›´æ–°ä»–ä»¬çš„æœåŠ¡ï¼Œå¹¶ä½¿ç”¨æ–°ç‰ˆæœ¬çš„åè®®ã€‚æ‰€ä»¥ï¼Œæ–°ç‰ˆæœ¬çš„æœåŠ¡è™½ç„¶å‘å¸ƒäº†ï¼Œä½†è¿˜æ´¾ä¸ä¸Šç”¨åœºã€‚ç„¶åï¼Œæˆ‘ä»¬å´è¦ä»¥ä¸€ç§å¾ˆå¥‡æ€ªçš„æ–¹å¼æ¥ä¿®å¤æ—§ç‰ˆæœ¬çš„bugï¼Œè¿™è®©æ”¯æŒå·¥ä½œå˜å¾—æ›´åŠ å¤æ‚ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬å†³å®šåœæ­¢å‘å¸ƒæ–°ç‰ˆæœ¬çš„åè®®ã€‚æˆ‘ä»¬æä¾›åè®®çš„åŸºç¡€ç‰ˆæœ¬ï¼Œå¯ä»¥å¾€é‡Œé¢æ·»åŠ å°‘é‡çš„å±æ€§ã€‚æœåŠ¡çš„æ¶ˆè´¹è€…å¼€å§‹ä½¿ç”¨JSON schemaã€‚</p>
<p>æ ‡å‡†çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š<br><img src="/images/ms/02/05.jpg" alt="05"></p>
<p>æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ç‰ˆæœ¬1ã€2å’Œ3ï¼Œè€Œæ˜¯åªä½¿ç”¨ç‰ˆæœ¬1å’ŒæŒ‡å‘å®ƒçš„schemaã€‚<br><img src="/images/ms/02/06.jpg" alt="06"></p>
<p>è¿™æ˜¯ä»æˆ‘ä»¬æœåŠ¡è¿”å›çš„ä¸€ä¸ªå…¸å‹çš„å“åº”ç»“æœã€‚å®ƒæ˜¯ä¸€ä¸ªå†…å®¹ç®¡ç†å™¨ï¼Œè¿”å›æœ‰å…³å¹¿æ’­çš„ä¿¡æ¯ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…schemaçš„ä¾‹å­ã€‚<br><img src="/images/ms/02/07.jpg" alt="07"></p>
<p>æœ€åº•ä¸‹çš„å­—ç¬¦ä¸²æœ€æœ‰æ„æ€ï¼Œä¹Ÿå°±æ˜¯â€requiredâ€é‚£å—ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæœåŠ¡åªéœ€è¦4ä¸ªå­—æ®µâ€”â€”idã€contentã€dateå’Œstatusã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨äº†è¿™ä¸ªschemaï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…å°±åªä¼šå¾—åˆ°è¿™æ ·çš„æ•°æ®ã€‚<br><img src="/images/ms/02/08.jpg" alt="08"></p>
<p>å®ƒä»¬å¯ä»¥è¢«ç”¨åœ¨æ¯ä¸€ä¸ªåè®®ç‰ˆæœ¬é‡Œï¼Œä»ç¬¬ä¸€ä¸ªç‰ˆæœ¬åˆ°åæ¥çš„æ¯ä¸€ä¸ªå˜æ›´ç‰ˆæœ¬ã€‚è¿™æ ·ï¼Œåœ¨ç‰ˆæœ¬ä¹‹é—´è¿ç§»å°±å®¹æ˜“å¾ˆå¤šã€‚åœ¨æˆ‘ä»¬å‘å¸ƒæ–°ç‰ˆæœ¬ä¹‹åï¼Œå®¢æˆ·ç«¯çš„è¿ç§»å°±ä¼šç®€å•å¾ˆå¤šã€‚</p>
<p>ä¸‹ä¸€ä¸ªé‡è¦çš„è®®é¢˜æ˜¯ç³»ç»Ÿçš„ç¨³å®šæ€§é—®é¢˜ã€‚è¿™æ˜¯å¾®æœåŠ¡å’Œå…¶ä»–ä»»ä½•ä¸€ä¸ªç³»ç»Ÿéƒ½éœ€è¦é¢ä¸´çš„é—®é¢˜ï¼ˆåœ¨å¾®æœåŠ¡æ¶æ„é‡Œï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¼ºçƒˆåœ°æ„Ÿè§‰åˆ°å®ƒçš„é‡è¦æ€§ï¼‰ã€‚ç³»ç»Ÿæ€»ä¼šåœ¨æŸä¸ªæ—¶å€™å˜å¾—ä¸ç¨³å®šã€‚</p>
<p>å¦‚æœæœåŠ¡é—´çš„è°ƒç”¨é“¾åªåŒ…å«äº†ä¸€ä¸¤ä¸ªæœåŠ¡ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ çœ‹ä¸å‡ºå•ä½“å’Œåˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é—´æœ‰å¤šå¤§åŒºåˆ«ã€‚ä½†å½“è°ƒç”¨é“¾é‡ŒåŒ…å«äº†5åˆ°7ä¸ªè°ƒç”¨ï¼Œé‚£ä¹ˆé—®é¢˜å°±ä¼šæ¥è¸µè€Œè‡³ã€‚ä½ æ ¹æœ¬ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Œä¹Ÿä¸çŸ¥é“èƒ½åšäº›ä»€ä¹ˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè°ƒè¯•ä¼šå˜å¾—å¾ˆå›°éš¾ã€‚åœ¨å•ä½“ç³»ç»Ÿé‡Œï¼Œä½ å¯ä»¥é€šè¿‡é€æ­¥è°ƒè¯•æ¥æ‰¾å‡ºé”™è¯¯ã€‚ä½†å¯¹äºå¾®æœåŠ¡æ¥è¯´ï¼Œç½‘ç»œä¸ç¨³å®šæ€§æˆ–é«˜è´Ÿè½½ä¸‹çš„æ€§èƒ½ä¸ç¨³å®šæ€§ä¹Ÿä¼šå¯¹å¾®æœåŠ¡é€ æˆå½±å“ã€‚ç‰¹åˆ«æ˜¯å¯¹äºæ‹¥æœ‰å¤§é‡èŠ‚ç‚¹çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼Œè¿™äº›æƒ…å†µå°±æ›´åŠ æ˜¾è€Œæ˜“è§äº†ã€‚<br><img src="/images/ms/02/09.jpg" alt="09"></p>
<p>åœ¨ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ä¼ ç»Ÿçš„åŠæ³•ã€‚æˆ‘ä»¬ç›‘æ§æ‰€æœ‰çš„ä¸œè¥¿ï¼ŒæŸ¥çœ‹é—®é¢˜å’Œé—®é¢˜çš„å‘ç”Ÿç‚¹ï¼Œç„¶åå°è¯•å°½å¿«ä¿®å¤å®ƒä»¬ã€‚æˆ‘ä»¬å°†å¾®æœåŠ¡çš„åº¦é‡æŒ‡æ ‡æ”¶é›†åˆ°ä¸€ä¸ªç‹¬ç«‹çš„æ•°æ®åº“é‡Œã€‚æˆ‘ä»¬ä½¿ç”¨<a href="https://github.com/python-diamond/Diamond" target="_blank" rel="external">Diamond</a>æ¥æ”¶é›†ç³»ç»Ÿåº¦é‡æŒ‡æ ‡ã€‚æˆ‘ä»¬ä½¿ç”¨<a href="https://github.com/google/cadvisor" target="_blank" rel="external">cAdvisor</a>æ¥åˆ†æå®¹å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µå’Œæ€§èƒ½ç‰¹å¾ã€‚æ‰€æœ‰çš„ç»“æœéƒ½è¢«ä¿å­˜åˆ°<a href="https://github.com/influxdata/influxdb" target="_blank" rel="external">InfluxDB</a>ï¼Œç„¶åæˆ‘ä»¬åœ¨Grafanaé‡Œåˆ›å»ºä»ªè¡¨ç›˜ã€‚<br><img src="/images/ms/02/10.jpg" alt="10"></p>
<p>äºæ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨çš„åŸºç¡€è®¾æ–½é‡Œåˆå¤šäº†ä¸‰ä¸ªç»„ä»¶ã€‚</p>
<p>æˆ‘ä»¬æ¯”ä»¥å¾€æ›´åŠ å…³æ³¨æ‰€å‘ç”Ÿçš„ä¸€åˆ‡ã€‚æˆ‘ä»¬å¯¹é—®é¢˜çš„ååº”é€Ÿåº¦æ›´å¿«äº†ã€‚ä¸è¿‡ï¼Œè¿™å¹¶æ²¡æœ‰é˜»æ­¢é—®é¢˜çš„å‡ºç°ã€‚</p>
<p>å¥‡æ€ªçš„æ˜¯ï¼Œå¾®æœåŠ¡æ¶æ„çš„ä¸»è¦é—®é¢˜å‡ºåœ¨é‚£äº›ä¸ç¨³å®šçš„æœåŠ¡ä¸Šã€‚å®ƒä»¬æœ‰çš„ä»Šå¤©è¿è¡Œæ­£å¸¸ï¼Œæ˜å¤©å°±ä¸è¡Œï¼Œè€Œä¸”æœ‰å„ç§å„æ ·çš„åŸå› ã€‚å¦‚æœæœåŠ¡å‡ºç°è¶…è½½ï¼Œè€Œä½ ç»§ç»­å‘å®ƒå‘é€è´Ÿè½½ï¼Œå®ƒå°±ä¼šå®•æœºä¸€æ®µæ—¶é—´ã€‚å¦‚æœå®ƒåœ¨ä¸€æ®µæ—¶é—´ä¸æä¾›æœåŠ¡ï¼Œè´Ÿè½½å°±ä¼šä¸‹é™ï¼Œç„¶åå®ƒå°±åˆæ´»è¿‡æ¥äº†ã€‚è¿™ç±»ç³»ç»Ÿå¾ˆéš¾ç»´æŠ¤ï¼Œä¹Ÿå¾ˆéš¾çŸ¥é“åˆ°åº•å‡ºäº†ä»€ä¹ˆé—®é¢˜ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬å†³å®šæŠŠè¿™äº›æœåŠ¡åœæ‰ï¼Œè€Œä¸æ˜¯è®©å®ƒä»¬æ¥å›æŠ˜è…¾ã€‚æˆ‘ä»¬å› æ­¤éœ€è¦æ”¹å˜æœåŠ¡çš„å®ç°æ–¹å¼ã€‚</p>
<p>æˆ‘ä»¬åšäº†ä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…ã€‚æˆ‘ä»¬å¯¹æ¯ä¸ªæœåŠ¡æ¥æ”¶çš„è¯·æ±‚æ•°é‡è®¾å®šäº†ä¸€ä¸ªä¸Šé™ã€‚æ¯ä¸ªæœåŠ¡çŸ¥é“è‡ªå·±å¯ä»¥å¤„ç†å¤šå°‘ä¸ªæ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼ˆæˆ‘ä»¬ç¨åä¼šè¯¦ç»†è¯´æ˜ï¼‰ã€‚å¦‚æœè¯·æ±‚æ•°é‡è¾¾åˆ°ä¸Šé™ï¼ŒæœåŠ¡å°†æŠ›å‡º503 Service Unavailableå¼‚å¸¸ã€‚å®¢æˆ·ç«¯çŸ¥é“è¿™ä¸ªèŠ‚ç‚¹æ— æ³•æä¾›æœåŠ¡ï¼Œå°±ä¼šé€‰æ‹©å¦ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>
<p>å½“ç³»ç»Ÿå‡ºç°é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥å‡å°‘è¯·æ±‚æ—¶é—´ã€‚å¦å¤–ï¼Œæˆ‘ä»¬ä¹Ÿæå‡äº†æœåŠ¡çš„ç¨³å®šæ€§ã€‚</p>
<p>æˆ‘ä»¬å¼•å…¥äº†ç¬¬äºŒç§æ¨¡å¼â€”â€”<strong>å›è·¯æ–­è·¯å™¨</strong>ï¼ˆCircuit Breakerï¼‰ã€‚æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯å®ç°äº†è¿™ç§æ¨¡å¼ã€‚</p>
<p>å‡è®¾æœ‰ä¸€ä¸ªæœåŠ¡Aï¼Œå®ƒæœ‰4ä¸ªå¯ä»¥è®¿é—®çš„æœåŠ¡Bçš„å®ä¾‹ã€‚å®ƒå‘æ³¨å†Œä¸­å¿ƒç´¢è¦æœåŠ¡Bçš„åœ°å€ï¼šâ€œç»™æˆ‘è¿™äº›æœåŠ¡çš„åœ°å€â€ã€‚å®ƒå¾—åˆ°äº†æœåŠ¡Bçš„4ä¸ªåœ°å€ã€‚æœåŠ¡Aå‘ç¬¬ä¸€ä¸ªæœåŠ¡Bçš„å®ä¾‹å‘èµ·äº†è¯·æ±‚ã€‚ç¬¬ä¸€ä¸ªæœåŠ¡Bå®ä¾‹æ­£å¸¸è¿”å›å“åº”ã€‚æœåŠ¡Aå°†å…¶æ ‡è®°ä¸ºå¯è®¿é—®ï¼šâ€œæ˜¯çš„ï¼Œæˆ‘å¯ä»¥è®¿é—®å®ƒâ€ã€‚ç„¶åï¼ŒæœåŠ¡Aå‘ç¬¬äºŒä¸ªæœåŠ¡Bå®ä¾‹å‘èµ·è¯·æ±‚ï¼Œä¸è¿‡å®ƒæ²¡æœ‰åœ¨æœŸæœ›çš„æ—¶é—´å†…å¾—åˆ°å“åº”ã€‚æˆ‘ä»¬ç¦ç”¨äº†è¿™ä¸ªå®ä¾‹ï¼Œç„¶åå‘ä¸‹ä¸€ä¸ªå®ä¾‹å‘èµ·è¯·æ±‚ã€‚ä¸‹ä¸€ä¸ªå®ä¾‹å› ä¸ºæŸäº›åŸå› è¿”å›äº†ä¸æ­£ç¡®çš„åè®®ç‰ˆæœ¬ã€‚äºæ˜¯æˆ‘ä»¬ä¹Ÿå°†å…¶ç¦ç”¨ï¼Œç„¶åè½¬å‘ç¬¬å››ä¸ªå®ä¾‹ã€‚</p>
<p>æ€»å¾—æ¥è¯´ï¼Œåªæœ‰ä¸€åŠçš„æœåŠ¡èƒ½å¤Ÿä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚äºæ˜¯æœåŠ¡Aå°†ä¼šå‘èƒ½å¤Ÿæ­£å¸¸è¿”å›å“åº”çš„ä¸¤ä¸ªæœåŠ¡å‘èµ·è¯·æ±‚ã€‚è€Œå¦å¤–ä¸¤ä¸ªæ— æ³•æ»¡è¶³è¦æ±‚çš„å®ä¾‹è¢«ç¦ç”¨äº†ä¸€æ®µæ—¶é—´ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡è¿™ç§æ–¹å¼æ¥æå‡æ€§èƒ½çš„ç¨³å®šæ€§ã€‚å¦‚æœæœåŠ¡å‡ºç°äº†é—®é¢˜ï¼Œæˆ‘ä»¬å°±å°†å…¶å…³é—­ï¼Œå¹¶å‘å‡ºå‘Šè­¦ï¼Œç„¶åå°è¯•æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ã€‚</p>
<p>å› ä¸ºå¼•å…¥äº†å›è·¯æ–­è·¯å™¨æ¨¡å¼ï¼Œæˆ‘ä»¬çš„åŸºç¡€è®¾æ–½é‡Œåˆå¤šäº†ä¸€ä¸ªç»„ä»¶â€”â€”<a href="https://github.com/Netflix/Hystrix" target="_blank" rel="external">Hystrix</a>ã€‚<br><img src="/images/ms/02/11.jpg" alt="11"></p>
<p>Hystrixä¸ä»…å®ç°äº†å›è·¯æ–­è·¯å™¨æ¨¡å¼ï¼Œå®ƒä¹Ÿæœ‰åŠ©äºæˆ‘ä»¬äº†è§£ç³»ç»Ÿé‡Œå‡ºç°äº†å“ªäº›é—®é¢˜ï¼š<br><img src="/images/ms/02/12.jpg" alt="12"></p>
<p>åœ†ç¯çš„å¤§å°è¡¨ç¤ºæœåŠ¡ä¸å…¶ä»–ç»„ä»¶ä¹‹é—´çš„æµé‡å¤§å°ã€‚é¢œè‰²è¡¨ç¤ºç³»ç»Ÿçš„å¥åº·çŠ¶å†µã€‚å¦‚æœåœ†ç¯æ˜¯ç»¿è‰²çš„ï¼Œé‚£ä¹ˆè¯´æ˜ä¸€åˆ‡æ­£å¸¸ã€‚å¦‚æœåœ†ç¯æ˜¯çº¢è‰²çš„ï¼Œé‚£ä¹ˆå°±æœ‰é—®é¢˜äº†ã€‚</p>
<p>å¦‚æœä¸€ä¸ªæœåŠ¡åº”è¯¥è¢«åœæ‰ï¼Œé‚£ä¹ˆå®ƒçœ‹èµ·æ¥æ˜¯è¿™ä¸ªæ ·å­çš„ã€‚åœ†ç¯æ˜¯æ‰“å¼€çš„ã€‚<br><img src="/images/ms/02/13.jpg" alt="13"></p>
<p>æˆ‘ä»¬çš„ç³»ç»Ÿå˜å¾—ç›¸å¯¹ç¨³å®šã€‚æ¯ä¸ªæœåŠ¡è‡³å°‘éƒ½æœ‰ä¸¤ä¸ªå¯ç”¨çš„å®ä¾‹ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€‰æ‹©åœæ‰å…¶ä¸­çš„ä¸€ä¸ªã€‚ä¸è¿‡ï¼Œå°½ç®¡æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬ä»ç„¶ä¸çŸ¥é“æˆ‘ä»¬çš„ç³»ç»Ÿç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆé—®é¢˜ã€‚åœ¨å¤„ç†è¯·æ±‚æœŸé—´å¦‚æœå‡ºç°äº†é—®é¢˜ï¼Œæˆ‘ä»¬åº”è¯¥æ€æ ·æ‰èƒ½çŸ¥é“é—®é¢˜çš„æ ¹æºæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„è¯·æ±‚ï¼š<br><img src="/images/ms/02/14.jpg" alt="14"></p>
<p>è¿™æ˜¯ä¸€ä¸ªå¤„ç†é“¾æ¡ã€‚ç”¨æˆ·å‘é€è¯·æ±‚åˆ°ç¬¬ä¸€ä¸ªæœåŠ¡ï¼Œç„¶åæ˜¯ç¬¬äºŒä¸ªã€‚ä»ç¬¬äºŒä¸ªæœåŠ¡å¼€å§‹ï¼Œé“¾æ¡å°†è¯·æ±‚å‘é€åˆ°ç¬¬ä¸‰ä¸ªå’Œç¬¬å››ä¸ªæœåŠ¡ã€‚</p>
<p>ç„¶åä¸€ä¸ªåˆ†æ”¯ä¸æ˜åŸå› åœ°æ¶ˆå¤±äº†ã€‚åœ¨ç»å†äº†è¿™ç±»åœºæ™¯ä¹‹åï¼Œæˆ‘ä»¬å°è¯•ç€æå‡è¿™ç§åœºæ™¯çš„å¯è§æ€§ï¼Œäºæ˜¯æˆ‘ä»¬æ‰¾åˆ°äº†Appdashã€‚Appdashæ˜¯ä¸€ä¸ªè·Ÿè¸ªæœåŠ¡ã€‚<br><img src="/images/ms/02/16.jpg" alt="16"></p>
<p>å®ƒçœ‹èµ·æ¥æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š<br><img src="/images/ms/02/17.jpg" alt="17"></p>
<p>å¯ä»¥è¿™ä¹ˆè¯´ï¼Œæˆ‘ä»¬åªæ˜¯æƒ³å°è¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦é€‚åˆæˆ‘ä»¬ã€‚å°†å®ƒç”¨åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿé‡Œæ˜¯ä¸€ä»¶å¾ˆå®¹æ˜“çš„äº‹æƒ…ï¼Œå› ä¸ºæˆ‘ä»¬é‚£ä¸ªæ—¶å€™ä½¿ç”¨çš„æ˜¯Goè¯­è¨€ã€‚Appdashæä¾›äº†ä¸€ä¸ªå¼€ç®±å³ç”¨çš„åŒ…ã€‚æˆ‘ä»¬è®¤ä¸ºAppdashæ˜¯ä¸€ä¸ªå¥½ä¸œè¥¿ï¼Œåªæ˜¯å®ƒçš„å®ç°å¹¶ä¸æ˜¯å¾ˆé€‚åˆæˆ‘ä»¬ã€‚<br><img src="/images/ms/02/18.jpg" alt="18"></p>
<p>äºæ˜¯ï¼Œæˆ‘ä»¬å†³å®šä½¿ç”¨<a href="http://zipkin.io/" target="_blank" rel="external">Zipkin</a>æ¥ä»£æ›¿Appdashã€‚Zipkinæ˜¯ç”±Twitterå¼€æºçš„ã€‚å®ƒçœ‹èµ·æ¥æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š<br><img src="/images/ms/02/19.jpg" alt="19"></p>
<p>æˆ‘è®¤ä¸ºè¿™æ ·ä¼šæ›´æ¸…æ¥šä¸€äº›ã€‚æˆ‘ä»¬å¯ä»¥ä»ä¸­çœ‹åˆ°ä¸€äº›æœåŠ¡ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„è¯·æ±‚æ˜¯å¦‚ä½•é€šè¿‡è¯·æ±‚é“¾çš„ï¼Œè¿˜å¯ä»¥çœ‹åˆ°è¯·æ±‚åœ¨æ¯ä¸ªæœåŠ¡é‡Œéƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœåŠ¡çš„æ€»æ—¶é•¿å’Œæ¯ä¸ªåˆ†æ®µçš„æ—¶é•¿ï¼Œå¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æ·»åŠ æè¿°æœåŠ¡å†…å®¹çš„ä¿¡æ¯ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€äº›ä¸æ•°æ®åº“çš„è°ƒç”¨ã€æ–‡ä»¶ç³»ç»Ÿçš„è¯»å–ã€ç¼“å­˜çš„è®¿é—®æœ‰å…³çš„ä¿¡æ¯ï¼Œè¿™æ ·å°±å¯ä»¥çŸ¥é“è¯·æ±‚é‡Œå“ªä¸€éƒ¨åˆ†ä½¿ç”¨äº†æœ€å¤šçš„æ—¶é—´ã€‚TraceIDå¯ä»¥å¸®åŠ©æˆ‘ä»¬åšåˆ°è¿™ä¸€ç‚¹ã€‚ç¨åæˆ‘ä¼šä»‹ç»æ›´å¤šç»†èŠ‚ã€‚<br><img src="/images/ms/02/20.jpg" alt="20"></p>
<p>æˆ‘ä»¬å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼çŸ¥é“è¯·æ±‚åœ¨å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä»€ä¹ˆé—®é¢˜ï¼Œä»¥åŠä¸ºä»€ä¹ˆæœ‰æ—¶å€™æ— æ³•è¢«æ­£å¸¸å¤„ç†ã€‚åˆšå¼€å§‹ä¸€åˆ‡éƒ½æ­£å¸¸ï¼Œç„¶åçªç„¶é—´ï¼Œå…¶ä¸­çš„ä¸€ä¸ªå‡ºç°äº†é—®é¢˜ã€‚æˆ‘ä»¬ç¨ä½œæ’æŸ¥ï¼Œå°±çŸ¥é“å‡ºé—®é¢˜çš„æœåŠ¡å‘ç”Ÿäº†ä»€ä¹ˆã€‚<br><img src="/images/ms/02/21.jpg" alt="21"></p>
<p>ä¸ä¹…å‰ï¼Œä¸€äº›å‚å•†æ¨å‡ºäº†ä¸€ä¸ªè·Ÿè¸ªç³»ç»Ÿçš„æ ‡å‡†ã€‚ä¸ºäº†ç®€åŒ–ç³»ç»Ÿçš„å®ç°ï¼Œä¸»è¦çš„å‡ ä¸ªè·Ÿè¸ªç³»ç»Ÿå‚å•†åœ¨å¦‚ä½•è®¾è®¡å®¢æˆ·ç«¯APIå’Œå®¢æˆ·ç«¯ç±»åº“ä¸Šè¾¾æˆäº†ä¸€è‡´ã€‚ç°åœ¨å·²ç»æœ‰äº†<a href="http://opentracing.io/" target="_blank" rel="external">OpenTracing</a>çš„å®ç°ï¼Œæ”¯æŒå‡ ä¹æ‰€æœ‰çš„ä¸»æµå¼€å‘è¯­è¨€ã€‚ç°åœ¨å°±å¯ä»¥ä½¿ç”¨å®ƒäº†ã€‚</p>
<p>æˆ‘ä»¬å·²ç»æœ‰åŠæ³•çŸ¥é“é‚£äº›çªç„¶é—´å´©æºƒçš„æœåŠ¡ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶ä¸­çš„æŸéƒ¨åˆ†åœ¨å‚æ­»æŒ£æ‰ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚å…‰æœ‰ç¯å¢ƒä¿¡æ¯æ˜¯ä¸å¤Ÿçš„ï¼Œ</p>
<p>æˆ‘ä»¬è¿˜éœ€è¦æ—¥å¿—ã€‚æ˜¯çš„ï¼Œè¿™åº”è¯¥æˆä¸ºæ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå°±æ˜¯Elasticsearchã€Logstashå’ŒKibanaï¼ˆELKï¼‰ã€‚ä¸è¿‡æˆ‘ä»¬å¯¹å®ƒä»¬åšäº†ä¸€äº›æ”¹åŠ¨ã€‚<br><img src="/images/ms/02/22.jpg" alt="22"></p>
<p>æˆ‘ä»¬å¹¶æ²¡æœ‰å°†å¤§é‡çš„æ—¥å¿—ç›´æ¥é€šè¿‡forwardä¼ ç»™Logstashï¼Œè€Œæ˜¯å…ˆä¼ ç»™syslogï¼Œè®©å®ƒæŠŠæ—¥å¿—èšåˆåˆ°æ„å»ºæœºå™¨ä¸Šï¼Œç„¶åå†é€šè¿‡forwardå¯¼å…¥åˆ°<strong>Elasticsearch</strong>å’Œ<strong>Kibana</strong>ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆæ ‡å‡†çš„æµç¨‹ï¼Œé‚£ä¹ˆå·§å¦™çš„åœ°æ–¹åœ¨å“ªé‡Œå‘¢ï¼Ÿ<br><img src="/images/ms/02/23.jpg" alt="23"></p>
<p>å·§å¦™çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•å¯èƒ½çš„åœ°æ–¹å¾€æ—¥å¿—é‡ŒåŠ å…¥Zipkinçš„TraceIDã€‚</p>
<p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨Kibanaä»ªè¡¨ç›˜ä¸Šçœ‹åˆ°å®Œæ•´çš„ç”¨æˆ·è¯·æ±‚æ‰§è¡Œæƒ…å†µã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦æœåŠ¡è¿›å…¥ç”Ÿäº§ç¯å¢ƒï¼Œå°±ä¸ºè¿è¥åšå¥½äº†å‡†å¤‡ã€‚å®ƒå·²ç»é€šè¿‡äº†è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œå¦‚æœæœ‰å¿…è¦ï¼ŒQAå¯ä»¥å†è¿›è¡Œæ‰‹åŠ¨æ£€æŸ¥ã€‚å®ƒåº”è¯¥æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚å¦‚æœå®ƒå‡ºç°äº†é—®é¢˜ï¼Œé‚£è¯´æ˜æœ‰ä¸€äº›å…ˆå†³æ¡ä»¶æ²¡æœ‰å¾—åˆ°æ»¡è¶³ã€‚æ—¥å¿—é‡Œè¯¦ç»†åœ°è®°å½•äº†è¿™äº›å…ˆå†³æ¡ä»¶ï¼Œé€šè¿‡è¿‡æ»¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æŸä¸ªè¯·æ±‚çš„è·Ÿè¸ªä¿¡æ¯ã€‚æˆ‘ä»¬å› æ­¤å¯ä»¥å¿«é€Ÿåœ°æŸ¥å‡ºé—®é¢˜çš„æ ¹æºï¼Œä¸ºæˆ‘ä»¬èŠ‚çœäº†å¾ˆå¤šæ—¶é—´ã€‚</p>
<p>æˆ‘ä»¬åæ¥å¼•å…¥äº†åŠ¨æ€è°ƒè¯•æ¨¡å¼ã€‚ç°åœ¨çš„æ—¥å¿—æ•°é‡è¿˜ä¸æ˜¯å¾ˆå¤§ï¼Œå¤§æ¦‚åªæœ‰100 GBåˆ°150 GBï¼Œæˆ‘è®°ä¸å¤ªæ¸…æ¥šå…·ä½“æ•°å­—äº†ã€‚ä¸è¿‡ï¼Œè¿™äº›æ—¥å¿—æ˜¯åœ¨æ­£å¸¸çš„æ—¥å¿—æ¨¡å¼ä¸‹ç”Ÿæˆçš„ã€‚å¦‚æœæˆ‘ä»¬æ·»åŠ æ›´å¤šçš„ç»†èŠ‚ï¼Œé‚£ä¹ˆæ—¥å¿—å°±å¯èƒ½å˜æˆTBçº§åˆ«çš„ï¼Œå¤„ç†èµ·æ¥å°±å¾ˆè€—è´¹èµ„æºã€‚</p>
<p>å½“æˆ‘ä»¬å‘ç°æŸäº›æœåŠ¡å‡ºç°é—®é¢˜ï¼Œå°±æ‰“å¼€è°ƒè¯•æ¨¡å¼ï¼ˆé€šè¿‡ä¸€ä¸ªAPIï¼‰ï¼Œçœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ã€‚æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬æ‰¾åˆ°å‡ºç°é—®é¢˜çš„æœåŠ¡ï¼Œåœ¨ä¸å°†å®ƒå…³é—­çš„æƒ…å†µä¸‹æ‰“å¼€è°ƒè¯•æ¨¡å¼ï¼Œå°è¯•æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬åœ¨ELKç«¯æŸ¥æ‰¾é—®é¢˜ã€‚æˆ‘ä»¬è¿˜å¯¹å…³é”®æœåŠ¡çš„é”™è¯¯è¿›è¡Œèšåˆã€‚æœåŠ¡çŸ¥é“å“ªäº›é”™è¯¯æ˜¯å…³é”®æ€§çš„ï¼Œå“ªäº›ä¸æ˜¯å…³é”®æ€§çš„ï¼Œç„¶åå°†å®ƒä»¬ä¼ ç»™<a href="https://sentry.io/" target="_blank" rel="external">Sentry</a>ã€‚<br><img src="/images/ms/02/24.jpg" alt="24"></p>
<p>Sentryèƒ½å¤Ÿæ™ºèƒ½åœ°æ”¶é›†é”™è¯¯æ—¥å¿—ï¼Œå¹¶å½¢æˆåº¦é‡æŒ‡æ ‡ï¼Œè¿˜ä¼šè¿›è¡Œä¸€äº›åŸºæœ¬çš„è¿‡æ»¤ã€‚æˆ‘ä»¬åœ¨å¾ˆå¤šæœåŠ¡ä¸Šä½¿ç”¨äº†Sentryã€‚æˆ‘ä»¬ä»å•ä½“åº”ç”¨æ—¶æœŸå°±å¼€å§‹ä½¿ç”¨å®ƒäº†ã€‚</p>
<p>é‚£ä¹ˆæœ€æœ‰è¶£çš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬æ˜¯å¦‚ä½•è¿›è¡Œä¼¸ç¼©çš„ï¼Ÿè¿™é‡Œéœ€è¦å…ˆä»‹ç»ä¸€äº›æ¦‚å¿µã€‚æˆ‘ä»¬æŠŠæ¯ä¸ªæœºå™¨çœ‹æˆä¸€ä¸ªé»‘ç›’ã€‚<br><img src="/images/ms/02/25.jpg" alt="25"></p>
<p>æˆ‘ä»¬æœ‰ä¸€ä¸ªç¼–æ’ç³»ç»Ÿï¼Œæœ€å¼€å§‹ä½¿ç”¨<a href="https://www.nomadproject.io/" target="_blank" rel="external">Nomad</a>ã€‚ç¡®åˆ‡åœ°è¯´ï¼Œåº”è¯¥æ˜¯<a href="https://www.ansible.com/" target="_blank" rel="external">Ansible</a>ã€‚æˆ‘ä»¬è‡ªå·±ç¼–å†™è„šæœ¬ï¼Œä½†å…‰æ˜¯è¿™äº›è¿˜ä¸èƒ½æ»¡è¶³è¦æ±‚ã€‚é‚£ä¸ªæ—¶å€™ï¼ŒNomadçš„æŸäº›ç‰ˆæœ¬å¯ä»¥ç®€åŒ–æˆ‘ä»¬çš„å·¥ä½œï¼Œäºæ˜¯æˆ‘ä»¬å†³å®šè¿ç§»åˆ°Nomadã€‚<br><img src="/images/ms/02/26.jpg" alt="26"></p>
<p>åŒæ—¶è¿˜ä½¿ç”¨äº†<a href="https://www.consul.io/" target="_blank" rel="external">Consul</a>ï¼Œå°†å®ƒä½œä¸ºæœåŠ¡å‘ç°çš„æ³¨å†Œä¸­å¿ƒã€‚è¿˜æœ‰Vaultï¼Œç”¨äºå­˜å‚¨æ•æ„Ÿæ•°æ®ï¼Œæ¯”å¦‚å¯†ç ã€ç§˜é’¥å’Œå…¶ä»–æ‰€æœ‰ä¸èƒ½ä¿å­˜åœ¨Gitä¸Šçš„ä¸œè¥¿ã€‚</p>
<p>è¿™æ ·ï¼Œæ‰€æœ‰çš„æœºå™¨å‡ ä¹éƒ½å˜å¾—ä¸€æ¨¡ä¸€æ ·ã€‚æ¯ä¸ªæœºå™¨ä¸Šéƒ½å®‰è£…äº†<strong>Docker</strong>ï¼Œè¿˜æœ‰<strong>Consul</strong>å’Œ<strong>Nomad</strong>ä»£ç†ã€‚æ€»çš„æ¥è¯´ï¼Œæ¯ä¸€ä¸ªæœºå™¨éƒ½å¤„äºå¤‡ç”¨çŠ¶æ€ï¼Œå¯ä»¥åœ¨ä»»ä½•æ—¶å€™æŠ•å…¥ä½¿ç”¨ã€‚å¦‚æœä¸ç”¨äº†ï¼Œæˆ‘ä»¬å°±è®©å®ƒä»¬ä¸‹çº¿ã€‚å¦‚æœä½ æ„å»ºäº†äº‘å¹³å°ï¼Œä½ å°±å¯ä»¥å…ˆå‡†å¤‡å¥½æœºå™¨ï¼Œåœ¨é«˜å³°æœŸæ—¶å°†å®ƒä»¬æ‰“å¼€ï¼Œåœ¨è´Ÿè½½ä¸‹é™æ—¶å°†å®ƒä»¬å…³é—­ã€‚è¿™ä¼šèŠ‚çœå¤§é‡çš„æˆæœ¬ã€‚<br><img src="/images/ms/02/27.jpg" alt="27"></p>
<p>åæ¥ï¼Œæˆ‘ä»¬å†³å®šä»<strong>Nomad</strong>è¿ç§»åˆ°<a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="external">Kubernetes</a>ï¼Œ<strong>Consul</strong>ä¹Ÿå› æ­¤æˆä¸ºäº†é›†ä¸­å¼çš„é…ç½®ç³»ç»Ÿã€‚</p>
<p>è¿™æ ·ä¸€æ¥ï¼Œéƒ¨åˆ†æ ˆå¯ä»¥è¿›è¡Œè‡ªåŠ¨ä¼¸ç¼©ã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ</p>
<p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å¯¹å†…å­˜ã€CPUå’Œç½‘ç»œè¿›è¡Œé™åˆ¶ã€‚<br><img src="/images/ms/02/28.jpg" alt="28"></p>
<p>æˆ‘ä»¬åˆ†åˆ«å°†è¿™ä¸‰ä¸ªå…ƒç´ åˆ†æˆä¸‰ä¸ªç­‰çº§ï¼Œç æ‰å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼Œ<br><img src="/images/ms/02/29.jpg" alt="29"></p>
<p>R3-C2-N1ï¼Œæˆ‘ä»¬å·²ç»é™å®šåªç»™æŸä¸ªæœåŠ¡ä¸€å°éƒ¨åˆ†ç½‘ç»œæµé‡ã€å¤šä¸€ç‚¹ç‚¹çš„CPUå’Œæ›´å¤šçš„å†…å­˜ã€‚è¿™ä¸ªæœåŠ¡çœŸçš„å¾ˆè€—è´¹èµ„æºã€‚</p>
<p>æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨äº†åŠ©è®°ç¬¦ï¼Œæˆ‘ä»¬çš„å†³ç­–æœåŠ¡å¯ä»¥è®¾ç½®å¾ˆå¤šçš„ç»„åˆå€¼ï¼Œè¿™äº›å€¼çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š<br><img src="/images/ms/02/30.jpg" alt="30"></p>
<p>äº‹å®ä¸Šï¼Œæˆ‘ä»¬è¿˜æœ‰C4å’ŒR4ï¼Œä¸è¿‡å®ƒä»¬å·²ç»è¶…å‡ºäº†è¿™äº›æ ‡å‡†çš„é™åˆ¶ã€‚æ ‡å‡†çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š<br><img src="/images/ms/02/31.jpg" alt="31"></p>
<p>ä¸‹ä¸€æ­¥å¼€å§‹åšä¸€äº›é¢„å¤‡å·¥ä½œã€‚æˆ‘ä»¬å…ˆç¡®å®šæœåŠ¡çš„ä¼¸ç¼©ç±»å‹ã€‚</p>
<p>ç‹¬ç«‹çš„æœåŠ¡æœ€å®¹æ˜“ä¼¸ç¼©ï¼Œå®ƒå¯ä»¥è¿›è¡Œçº¿æ€§åœ°ä¼¸ç¼©ã€‚å¦‚æœç”¨æˆ·å¢é•¿äº†ä¸¤å€ï¼Œæˆ‘ä»¬å°±è¿è¡Œä¸¤å€çš„æœåŠ¡å®ä¾‹ã€‚è¿™å°±ä¸‡äº‹å¤§å‰äº†ã€‚</p>
<p>ç¬¬äºŒç§ä¼¸ç¼©ç±»å‹ï¼šæœåŠ¡ä¾èµ–äº†å¤–éƒ¨çš„èµ„æºï¼Œæ¯”å¦‚é‚£äº›ä½¿ç”¨äº†æ•°æ®åº“çš„æœåŠ¡ã€‚æ•°æ®åº“æœ‰å®ƒè‡ªå·±çš„å®¹é‡ä¸Šé™ï¼Œè¿™ä¸ªä¸€å®šè¦æ³¨æ„ã€‚ä½ è¿˜è¦çŸ¥é“ï¼Œå¦‚æœç³»ç»Ÿæ€§èƒ½å‡ºç°è¡°é€€ï¼Œå°±ä¸åº”è¯¥å†å¢åŠ æ›´å¤šçš„å®ä¾‹ï¼Œè€Œä¸”ä½ è¦çŸ¥é“è¿™ç§æƒ…å†µä¼šåœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿã€‚</p>
<p>ç¬¬ä¸‰ç§æƒ…å†µæ˜¯ï¼ŒæœåŠ¡å—åˆ°å¤–éƒ¨ç³»ç»Ÿçš„ç‰µåˆ¶ã€‚ä¾‹å¦‚ï¼Œå¤–éƒ¨çš„è´¦å•ç³»ç»Ÿã€‚å°±ç®—è¿è¡Œäº†100ä¸ªæœåŠ¡å®ä¾‹ï¼Œå®ƒä¹Ÿæ²¡åŠæ³•å¤„ç†è¶…è¿‡500ä¸ªè¯·æ±‚ã€‚æˆ‘ä»¬è¦è€ƒè™‘åˆ°è¿™äº›é™åˆ¶ã€‚åœ¨ç¡®å®šäº†æœåŠ¡ç±»å‹å¹¶è®¾ç½®äº†ç›¸åº”çš„æ ‡è®°ä¹‹åï¼Œæ˜¯æ—¶å€™çœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•é€šè¿‡æˆ‘ä»¬çš„æ„å»ºç®¡é“çš„ã€‚<br><img src="/images/ms/02/32.jpg" alt="32"></p>
<p>æˆ‘ä»¬åœ¨CIæœåŠ¡å™¨ä¸Šè¿è¡Œäº†ä¸€äº›å•å…ƒæµ‹è¯•ï¼Œç„¶ååœ¨æµ‹è¯•ç¯å¢ƒè¿è¡Œé›†æˆæµ‹è¯•ï¼Œæˆ‘ä»¬çš„QAå›¢é˜Ÿä¼šå¯¹å®ƒä»¬åšä¸€äº›æ£€æŸ¥ã€‚åœ¨è¿™ä¹‹åï¼Œæˆ‘ä»¬å°±è¿›å…¥äº†é¢„ç”Ÿäº§ç¯å¢ƒçš„è´Ÿè½½æµ‹è¯•ã€‚<br><img src="/images/ms/02/33.jpg" alt="33"></p>
<p>å¦‚æœæ˜¯ç¬¬ä¸€ç§ç±»å‹çš„æœåŠ¡ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶åœ¨è¿™ä¸ªç¯å¢ƒé‡Œè¿è¡Œå®ƒï¼Œç»™å®ƒæœ€å¤§çš„è´Ÿè½½ã€‚åœ¨è¿è¡Œäº†å‡ è½®ä¹‹åï¼Œæˆ‘ä»¬å–å…¶ä¸­çš„æœ€å°å€¼ï¼Œå°†å®ƒå­˜å…¥<strong>InfluxDB</strong>ï¼Œå°†å®ƒä½œä¸ºè¯¥æœåŠ¡çš„è´Ÿè½½ä¸Šé™ã€‚</p>
<p>å¦‚æœæ˜¯ç¬¬äºŒç§ç±»å‹çš„æœåŠ¡ï¼Œæˆ‘ä»¬é€æ¸åŠ å¤§è´Ÿè½½ï¼Œç›´åˆ°å‡ºç°äº†æ€§èƒ½è¡°é€€ã€‚æˆ‘ä»¬å¯¹è¿™ä¸ªè¿‡ç¨‹è¿›è¡Œè¯„ä¼°ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“è¯¥ç³»ç»Ÿçš„è´Ÿè½½ï¼Œé‚£ä¹ˆå°±æ¯”è¾ƒå½“å‰è´Ÿè½½æ˜¯å¦å·²ç»è¶³å¤Ÿï¼Œå¦åˆ™ï¼Œæˆ‘ä»¬å°±ä¼šè®¾ç½®å‘Šè­¦ï¼Œä¸ä¼šæŠŠè¿™ä¸ªæœåŠ¡å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒã€‚æˆ‘ä»¬ä¼šå‘Šè¯‰å¼€å‘äººå‘˜ï¼šâ€œä½ ä»¬éœ€è¦åˆ†ç¦»å‡ºä¸€äº›ä¸œè¥¿ï¼Œæˆ–è€…åŠ è¿›å»å¦ä¸€ä¸ªå·¥å…·ï¼Œè®©è¿™ä¸ªæœåŠ¡å¯ä»¥æ›´å¥½åœ°ä¼¸ç¼©ã€‚â€<br><img src="/images/ms/02/34.jpg" alt="34"></p>
<p>å› ä¸ºæˆ‘ä»¬çŸ¥é“ç¬¬ä¸‰ç§ç±»å‹æœåŠ¡çš„ä¸Šé™ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¿è¡Œä¸€ä¸ªå®ä¾‹ã€‚æˆ‘ä»¬ä¹Ÿä¼šç»™å®ƒä¸€äº›è´Ÿè½½ï¼Œçœ‹çœ‹å®ƒå¯ä»¥æœåŠ¡å¤šå°‘ä¸ªç”¨æˆ·ã€‚å¦‚æœæˆ‘ä»¬çŸ¥é“è´¦å•ç³»ç»Ÿçš„ä¸Šé™æ˜¯1000ä¸ªè¯·æ±‚ï¼Œå¹¶ä¸”æ¯ä¸ªæœåŠ¡å®ä¾‹å¯ä»¥å¤„ç†200ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆå°±éœ€è¦5ä¸ªå®ä¾‹ã€‚</p>
<p>æˆ‘ä»¬æŠŠè¿™äº›ä¿¡æ¯éƒ½ä¿å­˜åˆ°äº†InfluxDBã€‚æˆ‘ä»¬çš„å†³ç­–æœåŠ¡å¼€å§‹æ´¾ä¸Šç”¨åœºäº†ã€‚å®ƒä¼šæ£€æŸ¥ä¸¤ä¸ªè¾¹ç•Œï¼šä¸Šé™å’Œä¸‹é™ã€‚å¦‚æœè¶…å‡ºäº†ä¸Šé™ï¼Œé‚£ä¹ˆå°±åº”è¯¥å¢åŠ æœåŠ¡å®ä¾‹ã€‚å¦‚æœè¶…å‡ºä¸‹é™ï¼Œé‚£ä¹ˆå°±å‡å°‘å®ä¾‹ã€‚å¦‚æœè´Ÿè½½ä¸‹é™ï¼ˆæ¯”å¦‚æ™šä¸Šçš„æ—¶å€™ï¼‰ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦è¿™ä¹ˆå¤šæœºå™¨ï¼Œå¯ä»¥å‡å°‘å®ƒä»¬çš„æ•°é‡ï¼Œå¹¶å…³æ‰ä¸€éƒ¨åˆ†æœºå™¨ï¼Œçœä¸‹ä¸€äº›è´¹ç”¨ã€‚</p>
<p>æ•´ä½“çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š<br><img src="/images/ms/02/35.jpg" alt="35"></p>
<p>æ¯ä¸ªæœåŠ¡çš„åº¦é‡æŒ‡æ ‡è¡¨æ˜äº†å®ƒä»¬å½“å‰çš„è´Ÿè½½ã€‚è´Ÿè½½ä¿¡æ¯è¢«ä¿å­˜åˆ°InfluxDBï¼Œå¦‚æœå†³ç­–æœåŠ¡å‘ç°æœåŠ¡å®ä¾‹è¾¾åˆ°äº†ä¸Šé™ï¼Œå®ƒä¼šå‘Nomadå’ŒKuberneteså‘é€å‘½ä»¤ï¼Œè¦æ±‚å¢åŠ æœåŠ¡å®ä¾‹ã€‚æœ‰å¯èƒ½åœ¨äº‘ç«¯å·²ç»æœ‰å¯ç”¨çš„å®ä¾‹ï¼Œæˆ–è€…å¼€å§‹åšä¸€äº›å‡†å¤‡å·¥ä½œã€‚ä¸ç®¡æ€æ ·ï¼Œå‘å‡ºè¦æ±‚å¢åŠ æ–°æœåŠ¡å®ä¾‹çš„å‘Šè­¦æ‰æ˜¯å…³é”®æ‰€åœ¨ã€‚</p>
<p>ä¸€äº›å—é™çš„æœåŠ¡å¦‚æœè¾¾åˆ°ä¸Šé™ï¼Œä¹Ÿä¼šå‘å‡ºç›¸å…³çš„å‘Šè­¦ã€‚å¯¹äºè¿™ç±»æƒ…å†µï¼Œæˆ‘ä»¬é™¤äº†åŠ å¤§ç­‰å¾…é˜Ÿåˆ—ï¼Œä¹Ÿåšä¸äº†å…¶ä»–ä»€ä¹ˆäº‹æƒ…ã€‚ä¸è¿‡æœ€èµ·ç æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬å¾ˆå¿«å°±ä¼šé¢ä¸´è¿™æ ·çš„é—®é¢˜ï¼Œå¹¶å¼€å§‹åšå¥½åº”å¯¹æªæ–½ã€‚</p>
<p>è¿™å°±æ˜¯æˆ‘æƒ³å‘Šè¯‰å¤§å®¶æœ‰å…³ä¼¸ç¼©æ€§æ–¹é¢çš„äº‹æƒ…ã€‚é™¤äº†è¿™äº›ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªä¸œè¥¿â€”â€”<a href="https://about.gitlab.com/gitlab-ci/" target="_blank" rel="external">Gitlab CI</a>ã€‚<br><img src="/images/ms/02/36.jpg" alt="36"></p>
<p>æˆ‘ä»¬ä¸€èˆ¬æ˜¯é€šè¿‡TeamCityæ¥å¼€å‘æœåŠ¡çš„ã€‚åæ¥ï¼Œæˆ‘ä»¬æ„è¯†åˆ°ï¼Œæ‰€æœ‰çš„æœåŠ¡éƒ½æœ‰ä¸€ä¸ªå…±æ€§ï¼Œè¿™äº›æœåŠ¡éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¹¶ä¸”çŸ¥é“è‡ªå·±è¯¥å¦‚ä½•éƒ¨ç½²åˆ°å®¹å™¨é‡Œã€‚è¦ç”Ÿæˆè¿™ä¹ˆçš„é¡¹ç›®çœŸçš„å¾ˆå›°éš¾ï¼Œä¸è¿‡å¦‚æœä½¿ç”¨ymlæ–‡ä»¶æ¥æè¿°å®ƒä»¬ï¼Œå¹¶æŠŠè¿™ä¸ªæ–‡ä»¶ä¸æœåŠ¡æ”¾åœ¨ä¸€èµ·ï¼Œå°±ä¼šæ–¹ä¾¿å¾ˆå¤šã€‚è™½ç„¶æˆ‘ä»¬åªåšäº†ä¸€äº›å°çš„æ”¹å˜ï¼Œä¸è¿‡å´ä¸ºæˆ‘ä»¬å¸¦æ¥äº†éå¸¸å¤šçš„å¯èƒ½æ€§ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘æƒ³è¯´ä¸€äº›ä¸€ç›´æƒ³å¯¹è‡ªå·±è¯´çš„è¯ã€‚</p>
<p>å…³äºå¾®æœåŠ¡å¼€å‘ï¼Œæˆ‘å»ºè®®åœ¨ä¸€å¼€å§‹å°±ä½¿ç”¨<strong>ç¼–æ’ç³»ç»Ÿ</strong>ã€‚å¯ä»¥ä½¿ç”¨æœ€ç®€å•çš„ç¼–æ’ç³»ç»Ÿï¼Œæ¯”å¦‚Nomadï¼Œé€šè¿‡nomad agent -devå‘½ä»¤å¯åŠ¨ä¸€ä¸ªç¼–æ’ç³»ç»Ÿï¼ŒåŒ…æ‹¬Consulå’Œå…¶ä»–ä¸œè¥¿ã€‚</p>
<p>æˆ‘ä»¬ä»¿ä½›æ˜¯åœ¨ä¸€ä¸ªé»‘ç›’å­å·¥ä½œã€‚ä½ è¯•å›¾é¿å…è¢«ç»‘å®šåˆ°æŸå°ç‰¹å®šçš„æœºå™¨ä¸Šï¼Œæˆ–è€…è¢«é™„åŠ åˆ°æŸå°ç‰¹å®šæœºå™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸Šã€‚è¿™äº›äº‹æƒ…ä¼šè®©ä½ å¼€å§‹é‡æ–°æ€è€ƒã€‚</p>
<p>åœ¨å¼€å‘é˜¶æ®µï¼Œ<strong>æ¯ä¸ªæœåŠ¡è‡³å°‘éœ€è¦ä¸¤ä¸ªå®ä¾‹</strong>ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªå‡ºç°é—®é¢˜ï¼Œå°±å¯ä»¥å…³æ‰å®ƒï¼Œç”±å¦ä¸€ä¸ªæ¥ç®¡ç»§ç»­æœåŠ¡ã€‚</p>
<p>è¿˜æœ‰ä¸€äº›æœ‰å…³æ¶æ„çš„é—®é¢˜ã€‚åœ¨å¾®æœåŠ¡æ¶æ„é‡Œï¼Œ<strong>æ¶ˆæ¯æ€»çº¿</strong>æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç»„ä»¶ã€‚</p>
<p>å‡è®¾ä½ æœ‰ä¸€ä¸ªç”¨æˆ·æ³¨å†Œç³»ç»Ÿï¼Œé‚£ä¹ˆå¦‚ä½•ä»¥æœ€ç®€å•çš„æ–¹å¼å®ç°å®ƒå‘¢ï¼Ÿå¯¹äºæ³¨å†Œç³»ç»Ÿæ¥è¯´ï¼Œéœ€è¦åˆ›å»ºè´¦æˆ·ï¼Œç„¶ååœ¨è´¦å•ç³»ç»Ÿé‡Œåˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Œå¹¶ä¸ºä»–åˆ›å»ºå¤´åƒå’Œå…¶ä»–ä¸œè¥¿ã€‚ä½ æœ‰ä¸€ç»„æœåŠ¡ï¼Œå…¶ä¸­çš„è¶…çº§æœåŠ¡æ”¶åˆ°äº†ä¸€ä¸ªè¯·æ±‚ï¼Œå®ƒå°†è¯·æ±‚åˆ†å‘ç»™å…¶ä»–æœåŠ¡ã€‚ç»è¿‡å‡ æ¬¡ä¹‹åï¼Œå®ƒå°±çŸ¥é“è¯¥è§¦å‘å“ªäº›æœåŠ¡æ¥å®Œæˆæ³¨å†Œã€‚</p>
<p>ä¸è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ç§æ›´ç®€å•ã€æ›´å¯é ã€æ›´é«˜æ•ˆçš„æ–¹å¼æ¥å®ç°ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæœåŠ¡æ¥å¤„ç†æ³¨å†Œï¼Œå®ƒæ³¨å†Œäº†ä¸€ä¸ªç”¨æˆ·ï¼Œç„¶åå‘é€ä¸€ä¸ªäº‹ä»¶åˆ°æ¶ˆæ¯æ€»çº¿ï¼Œæ¯”å¦‚â€œæˆ‘å·²ç»æ³¨å†Œäº†ä¸€ä¸ªyoghurtï¼ŒIDæ˜¯â€¦â€¦â€ã€‚ç›¸å…³çš„æœåŠ¡ä¼šæ”¶åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œå…¶ä¸­çš„ä¸€ä¸ªæœåŠ¡ä¼šåœ¨è´¦å•ç³»ç»Ÿé‡Œåˆ›å»ºä¸€ä¸ªè´¦æˆ·ï¼Œå¦ä¸€ä¸ªæœåŠ¡ä¼šå‘é€ä¸€å°æ¬¢è¿é‚®ä»¶ã€‚</p>
<p>ä¸è¿‡ï¼Œç³»ç»Ÿä¼šå› æ­¤å¤±å»å¼ºä¸€è‡´æ€§ã€‚è¿™ä¸ªæ—¶å€™ä½ æ²¡æœ‰è¶…çº§æœåŠ¡ï¼Œä¹Ÿä¸çŸ¥é“æ¯ä¸ªæœåŠ¡çš„çŠ¶æ€ã€‚ä¸è¿‡ï¼Œè¿™æ ·çš„ç³»ç»Ÿå¾ˆå®¹æ˜“ç»´æŠ¤ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘å†è¯´ä¸€äº›ä¹‹å‰æåˆ°è¿‡çš„é—®é¢˜ã€‚<strong>ä¸è¦è¯•å›¾ä¿®å¤</strong>å‡ºé—®é¢˜çš„æœåŠ¡ã€‚å¦‚æœæŸäº›æœåŠ¡å®ä¾‹å‡ºç°äº†é—®é¢˜ï¼Œå°†å®ƒæ‰¾å‡ºæ¥ï¼Œç„¶åæŠŠæµé‡å®šå‘åˆ°å…¶ä»–æœåŠ¡å®ä¾‹ï¼ˆå¯èƒ½æ˜¯æ–°å¢çš„å®ä¾‹ï¼‰ä¸Šï¼Œç„¶åå†è¯Šæ–­é—®é¢˜ã€‚è¿™æ ·å¯ä»¥æ˜¾è‘—æå‡ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚</p>
<p>é€šè¿‡<strong>æ”¶é›†åº¦é‡æŒ‡æ ‡</strong>æ¥äº†è§£ç³»ç»Ÿçš„çŠ¶æ€è‡ªç„¶ä¸åœ¨è¯ä¸‹ã€‚</p>
<p>ä¸è¿‡è¦æ³¨æ„ï¼Œå¦‚æœä½ å¯¹æŸä¸ªåº¦é‡æŒ‡æ ‡ä¸äº†è§£ï¼Œä¸çŸ¥é“æ€ä¹ˆä½¿ç”¨å®ƒï¼Œæˆ–è€…å®ƒå¯¹ä½ æ¥è¯´æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œå°±ä¸è¦æ”¶é›†å®ƒã€‚å› ä¸ºæœ‰æ—¶å€™ï¼Œè¿™æ ·çš„åº¦é‡æŒ‡æ ‡ä¼šæœ‰æ•°ç™¾ä¸‡ä¸ªã€‚ä½ åœ¨è¿™äº›æ— ç”¨çš„åº¦é‡æŒ‡æ ‡ä¸Šé¢æµªè´¹äº†å¾ˆå¤šèµ„æºå’Œæ—¶é—´ã€‚è¿™äº›æ˜¯æ— æ•ˆçš„è´Ÿè½½ã€‚</p>
<p>å¦‚æœä½ è®¤ä¸ºä½ éœ€è¦æŸäº›åº¦é‡æŒ‡æ ‡ï¼Œé‚£ä¹ˆå°±æ”¶é›†å®ƒä»¬ã€‚å¦‚æœä¸éœ€è¦ï¼Œå°±ä¸è¦æ”¶é›†ã€‚</p>
<p>å¦‚æœä½ å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œä¸è¦æ€¥ç€å»ä¿®å¤ã€‚åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œ<strong>ç³»ç»Ÿä¼šå¯¹æ­¤ä½œå‡ºååº”</strong>ã€‚å½“ç³»ç»Ÿéœ€è¦ä½ é‡‡å–è¡ŒåŠ¨çš„æ—¶å€™ï¼Œå®ƒä¼šç»™ä½ å‘å‡ºå‘Šè­¦ã€‚å¦‚æœå®ƒä¸è¦æ±‚ä½ åœ¨åŠå¤œè·‘å»ä¿®å¤é—®é¢˜ï¼Œé‚£ä¹ˆå®ƒå°±ä¸ç®—æ˜¯ä¸€ä¸ªå‘Šè­¦ã€‚å®ƒåªä¸è¿‡æ˜¯ä¸€ç§è­¦å‘Šï¼Œä½ å¯ä»¥åœ¨æŠŠå®ƒå½“æˆä¸€èˆ¬çš„é—®é¢˜æ¥å¤„ç†ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[å¾®æœåŠ¡ï¼Œå¤Ÿäº†]]></title>
      <url>http://team.jiunile.com/blog/2017/07/microservice-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%A4%9F%E4%BA%86.html</url>
      <content type="html"><![CDATA[<p><img src="/images/ms/01/cover.png" alt="01"></p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>  èµ„æ·±æ¶æ„å¸ˆ<a href="https://twitter.com/aadrake" target="_blank" rel="external">Adam Drake</a>åœ¨ä»–çš„åšå®¢ä¸Šåˆ†äº«äº†ä»–å¯¹å¾®æœåŠ¡çš„çœ‹æ³•,ä»– ä»è‡ªå·±çš„ç»éªŒå‡ºå‘,ç»“åˆMartin Fowlerå¯¹å¾®æœåŠ¡çš„è§è§£,å¸®åŠ©æƒ³è¦é‡‡ç”¨ å¾®æœåŠ¡çš„å…¬å¸é‡æ–°å®¡è§†å¾®æœåŠ¡ã€‚ä»¥ä¸‹å†…å®¹å·²è·å¾—ä½œè€…ç¿»è¯‘æˆæƒ,æŸ¥çœ‹è‹±æ–‡ åŸæ–‡ <a href="https://aadrake.com/posts/2017-05-20-enough-with-the-microservices.html" target="_blank" rel="external">Enough with the microservices</a>ã€‚</p>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>  å…³äºå¾®æœåŠ¡çš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿å·²ç»æœ‰è¿‡å¤ªå¤šçš„è®¨è®º,ä¸è¿‡æˆ‘ä»ç„¶çœ‹åˆ°å¾ˆå¤š æˆé•¿å‹åˆåˆ›å…¬å¸å¯¹å®ƒè¿›è¡Œç€ç›²ç›®å´‡æ‹œã€‚å†’ç€â€œé‡å¤å‘æ˜è½®å­â€çš„é£é™©(Martin Fowlerå·²ç»å†™è¿‡â€œMicroservice Premiumâ€çš„æ–‡ç« ),æˆ‘æƒ³æŠŠæˆ‘çš„ä¸€äº› æƒ³æ³•å†™ä¸‹æ¥,åœ¨å¿…è¦çš„æ—¶å€™å¯ä»¥å‘ç»™å®¢æˆ·,ä¹Ÿå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©äººä»¬é¿å…çŠ¯ä¸‹æˆ‘ä¹‹å‰è§è¿‡çš„é‚£äº›é”™è¯¯ã€‚åœ¨è¿›è¡Œæ¶æ„æˆ–æŠ€æœ¯é€‰å‹æ—¶,å°†ç½‘ç»œä¸Šæ‰¾åˆ°çš„ä¸€äº›æ‰€è°“çš„æœ€ä½³å®è·µæ–‡ç« ä½œä¸ºæŒ‡å—,ä¸€æ—¦åšå‡ºäº†é”™è¯¯çš„å†³å®š,å°±è¦ä»˜å‡ºæƒ¨é‡çš„ä»£ä»·ã€‚å¦‚æœèƒ½å¤Ÿå¸®åŠ©å“ªæ€•ä¸€ä¸ªå…¬å¸é¿å…çŠ¯ä¸‹è¿™ç§é”™è¯¯,é‚£ä¹ˆå†™è¿™ç¯‡æ–‡ç« éƒ½æ˜¯å€¼å¾—çš„ã€‚</p>
<p>  å¦‚ä»Šå¾®æœåŠ¡æ˜¯ä¸ªçƒ­é—¨æŠ€æœ¯,å¾®æœåŠ¡æ¶æ„ä¸€ç›´ä»¥æ¥éƒ½å­˜åœ¨(é¢å‘æœåŠ¡æ¶æ„ä¹Ÿç®—æ˜¯å§?),ä½†å¯¹äºæˆ‘æ‰€è§è¿‡çš„å¤§éƒ¨åˆ†å…¬å¸æ¥è¯´,å¾®æœåŠ¡ä¸ä»…æµªè´¹äº†ä»–ä»¬çš„æ—¶é—´,åˆ†æ•£äº†ä»–ä»¬çš„æ³¨æ„åŠ›,è€Œä¸”è®©äº‹æƒ…å˜å¾—æ›´ç³Ÿç³•ã€‚</p>
<p>  è¿™å¬èµ·æ¥ä¼¼ä¹å¾ˆå¥‡æ€ª,å› ä¸ºå¤§éƒ¨åˆ†å…³äºå¾®æœåŠ¡çš„æ–‡ç« éƒ½ä¼šè‚¯å®šå¾®æœåŠ¡ çš„å„ç§å¥½å¤„,æ¯”å¦‚è§£è€¦ç³»ç»Ÿã€æ›´å¥½çš„ä¼¸ç¼©æ€§ã€æ¶ˆé™¤å¼€å‘å›¢é˜Ÿä¹‹é—´çš„ä¾èµ–, ç­‰ç­‰ã€‚å¦‚æœä½ çš„å…¬å¸æœ‰ Uberã€Airbnbã€Facebook æˆ– Twitter é‚£æ ·çš„è§„æ¨¡, é‚£ä¹ˆå°±æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚æˆ‘æ›¾ç»å¸®åŠ©ä¸€äº›å¤§å‹ç»„ç»‡è½¬å‹åˆ°å¾®æœåŠ¡æ¶æ„,åŒ…æ‹¬ æ­å»ºæ¶ˆæ¯ç³»ç»Ÿå’Œé‡‡ç”¨ä¸€äº›èƒ½å¤Ÿæå‡ä¼¸ç¼©æ€§çš„æŠ€æœ¯ã€‚ä¸è¿‡,å¯¹äºæˆé•¿å‹åˆåˆ› å…¬å¸æ¥è¯´,å¾ˆå°‘éœ€è¦è¿™äº›æŠ€æœ¯å’ŒæœåŠ¡ã€‚</p>
<p>  Russ Milesåœ¨ä»–çš„ã€Š<a href="http://www.russmiles.com/essais/8-ways-to-lose-at-microservices-adoption" target="_blank" rel="external">è®©å¾®æœåŠ¡å¤±æ•ˆçš„å…«ç§æ–¹å¼</a>ã€‹è¿™ç¯‡æ–‡ç« ä¸­è¡¨è¾¾äº† ä»–çš„é¦–è¦è§‚ç‚¹,è€Œåœ¨æˆ‘çœ‹æ¥,è¿™äº›åœºæ™¯å´åˆ°å¤„å¯è§ã€‚æˆé•¿å‹åˆåˆ›å…¬å¸æ€»æ˜¯ æƒ³æ¨¡ä»¿é‚£äº›å¤§å…¬å¸çš„æœ€ä½³å®è·µ,ç”¨å®ƒä»¬æ¥å¼¥è¡¥è‡ªèº«çš„ä¸è¶³ã€‚ä½†æ˜¯,æœ€ä½³å® è·µæ˜¯è¦è§†æƒ…å†µè€Œå®šçš„ã€‚æœ‰äº›ä¸œè¥¿å¯¹äº Facebook æ¥è¯´æ˜¯æœ€ä½³å®è·µ,ä½†å¯¹äº åªæœ‰ä¸åˆ°ç™¾äººçš„åˆåˆ›å…¬å¸æ¥è¯´,å®ƒä»¬å°±ä¸ä¸€å®šä¹Ÿæ˜¯æœ€ä½³å®è·µã€‚</p>
<p>  å¦‚æœä½ çš„å…¬å¸æ¯”é‚£äº›å¤§å…¬å¸å°ä¸€äº›,åœ¨ä¸€å®šç¨‹åº¦ä¸Šä½ ä»ç„¶èƒ½å¤Ÿä»å¾®æœåŠ¡æ¶æ„ä¸­è·ç›Šã€‚ä½†æ˜¯,å¯¹äºæˆé•¿å‹åˆåˆ›å…¬å¸æ¥è¯´,å¤§è§„æ¨¡åœ°è¿ç§»åˆ°å¾®æœåŠ¡æ˜¯ä¸€ç§è¿‡é”™,è€Œä¸”å¯¹æŠ€æœ¯äººæ¥è¯´æ˜¯ä¸å…¬å¹³çš„ã€‚</p>
<a id="more"></a>
<h2 id="ä¸ºä»€ä¹ˆé€‰æ‹©å¾®æœåŠ¡"><a href="#ä¸ºä»€ä¹ˆé€‰æ‹©å¾®æœåŠ¡" class="headerlink" title="ä¸ºä»€ä¹ˆé€‰æ‹©å¾®æœåŠ¡?"></a>ä¸ºä»€ä¹ˆé€‰æ‹©å¾®æœåŠ¡?</h2><p>  ä¸€èˆ¬æ¥è¯´,æˆé•¿å‹åˆåˆ›å…¬å¸é‡‡ç”¨å¾®æœåŠ¡æ¶æ„æœ€ä¸»è¦çš„ç›®çš„ä¸ºäº†å‡å°‘æˆ–æ¶ˆé™¤å¼€å‘å›¢é˜Ÿä¹‹é—´çš„ä¾èµ–,æˆ–è€…æå‡ç³»ç»Ÿå¤„ç†å¤§æµé‡è´Ÿè½½çš„èƒ½åŠ›(æ¯”å¦‚ä¼¸ç¼©æ€§)ã€‚å¼€å‘äººå‘˜ç»å¸¸æŠ±æ€¨çš„é—®é¢˜å’Œå¸¸è§çš„ç—‡çŠ¶åŒ…æ‹¬åˆå¹¶å†²çªã€ç”±æœªå®Œæ•´å®ç°çš„åŠŸèƒ½å¼•èµ·çš„éƒ¨ç½²é”™è¯¯ä»¥åŠä¼¸ç¼©æ€§é—®é¢˜ã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬é€ä¸ªè¯´æ˜è¿™äº›é—®é¢˜ã€‚</p>
<h2 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h2><p>  åœ¨åˆåˆ›å…¬å¸çš„æ—©æœŸé˜¶æ®µ,å¼€å‘å›¢é˜Ÿè§„æ¨¡ä¸å¤§,ä½¿ç”¨çš„æŠ€æœ¯ä¹Ÿå¾ˆç®€å•ã€‚äººä»¬åœ¨ä¸€èµ·å·¥ä½œ,ä¸ä¼šå‡ºç°æ··ä¹±,è¦å®ç°ä¸€äº›åŠŸèƒ½ä¹Ÿæ¯”è¾ƒå¿«ã€‚ä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆç¾å¥½ã€‚</p>
<p>  éšç€å…¬å¸çš„ä¸æ–­å‘å±•,å¼€å‘å›¢é˜Ÿä¹Ÿåœ¨å£®å¤§,ä»£ç åº“ä¹Ÿåœ¨å¢é•¿,ç„¶åå°±å‡ºç°äº†å¤šä¸ªå›¢é˜Ÿåœ¨åŒä¸€ä¸ªä»£ç åº“ä¸Šå·¥ä½œçš„æƒ…å†µã€‚è¿™äº›å›¢é˜Ÿçš„å¤§éƒ¨åˆ†æˆå‘˜éƒ½æ˜¯å…¬å¸æ—©æœŸçš„å‘˜å·¥ã€‚å› ä¸ºåˆåˆ›å…¬å¸çš„æ—©æœŸå‘˜å·¥ä¸€èˆ¬éƒ½æ˜¯åˆçº§å¼€å‘äººå‘˜,ä»–ä»¬å¹¶æ²¡æœ‰æ„è¯†åˆ°ä¸€ä¸ªé—®é¢˜,é‚£å°±æ˜¯åœ¨å›¢é˜Ÿè§„æ¨¡å¢é•¿å’Œä»£ç åº“å¢é•¿çš„åŒæ—¶,æ²Ÿé€šæ•ˆç‡ä¹Ÿéœ€è¦éšä¹‹æå‡ã€‚å¯¹äºç¼ºä¹ç»éªŒçš„æŠ€æœ¯äººå‘˜æ¥è¯´,ä»–ä»¬å€¾å‘äºé€šè¿‡æŠ€æœ¯é—®é¢˜æ¥è§£å†³äººçš„é—®é¢˜,å¹¶å¸Œæœ›é€šè¿‡å¾®æœåŠ¡æ¥å‡å°‘å¼€å‘å›¢é˜Ÿä¹‹é—´çš„ä¾èµ–å’Œè€¦åˆã€‚</p>
<p>  å®é™…ä¸Š,ä»–ä»¬çœŸæ­£éœ€è¦åšçš„æ˜¯é€šè¿‡æœ‰æ•ˆçš„æ²Ÿé€šæ¥è§£å†³äººçš„é—®é¢˜ã€‚å½“ä¸€ä¸ªåˆåˆ›å…¬å¸æœ‰å¤šä¸ªå¼€å‘å›¢é˜Ÿæ—¶,å›¢é˜Ÿä¹‹é—´éœ€è¦åè°ƒ,å›¢é˜Ÿæˆå‘˜éœ€è¦çŸ¥é“æ¯ä¸ªäººéƒ½åœ¨åšä»€ä¹ˆ,ä»–ä»¬éœ€è¦åä½œã€‚åœ¨è¿™æ ·è§„æ¨¡çš„ä¼ä¸šé‡Œ,è½¯ä»¶å¼€å‘å…¶å®å…·å¤‡äº†ç¤¾äº¤çš„æ€§è´¨ã€‚å¦‚æœå›¢é˜Ÿä¹‹é—´ç¼ºä¹æ²Ÿé€šæˆ–è€…ç¼ºä¹ä¿¡æ¯åˆ†äº«,ä¸ç®¡ç”¨ä¸ç”¨å¾®æœåŠ¡,ä¸€æ ·å­˜åœ¨ä¾èµ–é—®é¢˜,è€Œå°±ç®—ä½¿ç”¨äº†å¾®æœåŠ¡,ä¹Ÿä»ç„¶å­˜åœ¨è´Ÿé¢çš„æŠ€æœ¯é—®é¢˜ã€‚</p>
<p>  å°†ä»£ç æ¨¡å—åŒ–ä½œä¸ºè§£å†³è¿™ä¸ªé—®é¢˜çš„æŠ€æœ¯æ–¹æ¡ˆ,ç¡®å®èƒ½å¤Ÿç¼“è§£è½¯ä»¶å¼€å‘å›ºæœ‰çš„å›¢é˜Ÿä¾èµ–é—®é¢˜,ä½†å›¢é˜Ÿé—´çš„æ²Ÿé€šä»ç„¶è¦éšç€å›¢é˜Ÿè§„æ¨¡çš„å¢é•¿è€Œä¸æ–­æ”¹è¿›ã€‚</p>
<p>  ä¸è¦æ··æ·†äº†è§£è€¦å’Œåˆ†å¸ƒå¼äºŒè€…çš„å«ä¹‰ã€‚ç”±æ¨¡å—å’Œæ¥å£ç»„æˆçš„å•ä½“å¯ä»¥å¸®åŠ©ä½ è¾¾åˆ°è§£è€¦çš„ç›®çš„,è€Œä¸”ä½ ä¹Ÿåº”è¯¥è¿™ä¹ˆåšã€‚ä½ æ²¡æœ‰å¿…è¦æŠŠåº”ç”¨ç¨‹åºæ‹†åˆ†æˆåˆ†å¸ƒå¼çš„å¤šä¸ªç‹¬ç«‹æœåŠ¡,åœ¨æ¨¡å—é—´å®šä¹‰æ¸…æ™°çš„æ¥å£åŒæ ·èƒ½è¾¾åˆ°è§£è€¦çš„ç›®çš„ã€‚</p>
<h2 id="éƒ¨åˆ†åŠŸèƒ½å®ç°"><a href="#éƒ¨åˆ†åŠŸèƒ½å®ç°" class="headerlink" title="éƒ¨åˆ†åŠŸèƒ½å®ç°"></a>éƒ¨åˆ†åŠŸèƒ½å®ç°</h2><p>  å¾®æœåŠ¡é‡Œéœ€è¦ç”¨åˆ°<a href="https://en.wikipedia.org/wiki/Feature_toggle" target="_blank" rel="external">åŠŸèƒ½æ ‡å¿—</a> (feature flag),å¾®æœåŠ¡å¼€å‘äººå‘˜éœ€è¦ç†Ÿæ‚‰è¿™ç§æŠ€æœ¯ã€‚ç‰¹åˆ«æ˜¯åœ¨è¿›è¡Œå¿«é€Ÿå¼€å‘(ä¸‹é¢ä¼šæ·±å…¥è®¨è®º)çš„æ—¶å€™,ä½ å¯èƒ½éœ€è¦éƒ¨ç½²ä¸€äº›åŠŸèƒ½,è¿™äº›åŠŸèƒ½åœ¨æŸäº›å¹³å°ä¸Šè¿˜æ²¡æœ‰å®ç°,æˆ–è€…å‰ç«¯å·²ç»å®Œå…¨å®ç°,ä½†åç«¯è¿˜æ²¡æœ‰ã€‚éšç€å…¬å¸çš„å‘å±•,éƒ¨ç½²å’Œè¿ç»´ç³»ç»Ÿå˜å¾—è¶Šæ¥è¶Šè‡ªåŠ¨åŒ–å’Œå¤æ‚,åŠŸèƒ½æ ‡å¿—ä¹Ÿå˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚</p>
<h2 id="æ°´å¹³ä¼¸ç¼©"><a href="#æ°´å¹³ä¼¸ç¼©" class="headerlink" title="æ°´å¹³ä¼¸ç¼©"></a>æ°´å¹³ä¼¸ç¼©</h2><p>  é€šè¿‡éƒ¨ç½²åŒä¸€ä¸ªå¾®æœåŠ¡çš„å¤šä¸ªå®ä¾‹æ¥è·å¾—ä¼¸ç¼©æ€§,è¿™æ˜¯å¾®æœåŠ¡çš„ä¼˜ç‚¹ ä¹‹ä¸€ã€‚ä¸è¿‡,å¤§å¤šæ•°è¿‡æ—©é‡‡ç”¨å¾®æœåŠ¡çš„å…¬å¸åœ¨è¿™äº›å¾®æœåŠ¡èƒŒåä½¿ç”¨äº†åŒä¸€ ä¸ªå­˜å‚¨ç³»ç»Ÿã€‚ä¹Ÿå°±æ˜¯è¯´,è¿™äº›æœåŠ¡å…·å¤‡äº†ä¼¸ç¼©æ€§,ä½†æ•´ä¸ªåº”ç”¨å¹¶ä¸å…·å¤‡ä¼¸ ç¼©æ€§ã€‚å¦‚æœä½ æ­£æ‰“ç®—ä½¿ç”¨è¿™æ ·çš„ä¼¸ç¼©æ–¹å¼,é‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨è´Ÿè½½å‡è¡¡å™¨ åé¢éƒ¨ç½²å¤šä¸ªå•ä½“å®ä¾‹å‘¢?ä½ å¯ä»¥ç”¨æ›´ç®€å•çš„æ–¹å¼è¾¾åˆ°ç›¸åŒçš„ç›®çš„ã€‚å†è€…, æ°´å¹³ä¼¸ç¼©åº”è¯¥è¢«ä½œä¸ºæ€æ‰‹é”æ¥ä½¿ç”¨ã€‚ä½ é¦–å…ˆè¦å…³æ³¨çš„åº”è¯¥æ˜¯å¦‚ä½•æå‡åº”ç”¨ ç¨‹åºçš„æ€§èƒ½ã€‚ä¸€äº›ç®€å•çš„ä¼˜åŒ–å¸¸å¸¸èƒ½å¸¦æ¥æ•°ç™¾å€çš„æ€§èƒ½æå‡,è¿™é‡Œä¹ŸåŒ…æ‹¬ å¦‚ä½•æ­£ç¡®åœ°ä½¿ç”¨å…¶ä»–æœåŠ¡ã€‚ä¾‹å¦‚,æˆ‘åœ¨ä¸€ç¯‡åšæ–‡é‡Œæåˆ°çš„<a href="https://aadrake.com/posts/2017-05-15-redis-performance-triage-handbook.html" target="_blank" rel="external">Redisæ€§èƒ½è¯Šæ–­</a>ã€‚</p>
<h2 id="æˆ‘ä»¬ä¸ºå¾®æœåŠ¡åšå¥½å‡†å¤‡äº†å—"><a href="#æˆ‘ä»¬ä¸ºå¾®æœåŠ¡åšå¥½å‡†å¤‡äº†å—" class="headerlink" title="æˆ‘ä»¬ä¸ºå¾®æœåŠ¡åšå¥½å‡†å¤‡äº†å—?"></a>æˆ‘ä»¬ä¸ºå¾®æœåŠ¡åšå¥½å‡†å¤‡äº†å—?</h2><p>  åœ¨è®¨è®ºæ¶æ„é€‰å‹æ—¶,äººä»¬ç»å¸¸ä¼šå¿½ç•¥è¿™ä¸ªé—®é¢˜,ä½†å…¶å®å´æ˜¯æœ€é‡è¦çš„ã€‚ é«˜çº§æŠ€æœ¯äººå‘˜åœ¨äº†è§£äº†å¼€å‘äººå‘˜æˆ–ä¸šåŠ¡äººå‘˜çš„æŠ±æ€¨æˆ–ç—›ç‚¹ä¹‹å,åœ¨ç½‘ä¸Šæ‰¾ å¯»æ‰¾è§£å†³æ–¹æ¡ˆ,ä»–ä»¬æ€»æ˜¯å®£ç§°èƒ½è§£å†³è¿™äº›é—®é¢˜ã€‚ä½†åœ¨è¿™äº›ä¿¡èª“æ—¦æ—¦çš„è§‚ç‚¹ èƒŒå,æœ‰å¾ˆå¤šéœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚å¾®æœåŠ¡æœ‰åˆ©ä¹Ÿæœ‰å¼Šã€‚å¦‚æœä½ çš„ä¼ä¸šè¶³å¤Ÿæˆ ç†Ÿ,å¹¶ä¸”å…·æœ‰ä¸€å®šçš„æŠ€æœ¯ç§¯ç´¯,é‚£ä¹ˆé‡‡ç”¨å¾®æœåŠ¡æ‰€é¢ä¸´çš„æŒ‘æˆ˜ä¼šå°å¾ˆå¤š, å¹¶ä¸”èƒ½å¤Ÿå¸¦æ¥æ›´å¤šæ­£é¢å¥½å¤„ã€‚é‚£ä¹ˆæ€æ ·æ‰ç®—å·²ç»ä¸ºå¾®æœåŠ¡åšå¥½å‡†å¤‡äº†å‘¢? Martin Fowleråœ¨å¤šå¹´å‰è¡¨è¾¾äº†ä»–å¯¹<a href="https://martinfowler.com/bliki/MicroservicePrerequisites.html" target="_blank" rel="external">å¾®æœåŠ¡å…ˆå†³æ¡ä»¶</a>çš„çœ‹æ³•,ä½†æ˜¯ä»æˆ‘çš„ ç»éªŒæ¥çœ‹,å¤§å¤šæ•°æˆé•¿å‹åˆåˆ›å…¬å¸å®Œå…¨å¿½ç•¥äº†ä»–çš„è§‚ç‚¹ã€‚Martin çš„è§‚ç‚¹ æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åˆ‡å…¥ç‚¹,è®©æˆ‘ä»¬æ¥é€ä¸ªè¯´æ˜ã€‚</p>
<p>  æˆ‘æ•¢è¯´,å¤§éƒ¨åˆ†æˆé•¿å‹åˆåˆ›å…¬å¸å‡ ä¹è¿ä¸€ä¸ªå…ˆå†³æ¡ä»¶éƒ½æ— æ³•æ»¡è¶³,æ›´ä¸ç”¨è¯´æ»¡è¶³æ‰€æœ‰çš„æ¡ä»¶äº†ã€‚å¦‚æœä½ çš„æŠ€æœ¯å›¢é˜Ÿä¸å…·å¤‡å¿«é€Ÿé…ç½®ã€éƒ¨ç½²å’Œç›‘æ§èƒ½åŠ›,é‚£ä¹ˆåœ¨è¿ç§»åˆ°å¾®æœåŠ¡å‰å¿…é¡»å…ˆè·å¾—è¿™äº›èƒ½åŠ›ã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬æ›´è¯¦ç»†åœ°è®¨è®ºè¿™äº›å…ˆå†³æ¡ä»¶ã€‚</p>
<h2 id="å¿«é€Ÿé…ç½®"><a href="#å¿«é€Ÿé…ç½®" class="headerlink" title="å¿«é€Ÿé…ç½®"></a>å¿«é€Ÿé…ç½®</h2><p>  å¦‚æœä½ çš„å¼€å‘å›¢é˜Ÿé‡Œåªæœ‰å°‘æ•°å‡ ä¸ªäººå¯ä»¥é…ç½®æ–°æœåŠ¡ã€è™šæ‹Ÿç¯å¢ƒæˆ–å…¶ ä»–é…å¥—è®¾æ–½,é‚£è¯´æ˜ä½ ä»¬è¿˜æ²¡æœ‰ä¸ºå¾®æœåŠ¡åšå¥½å‡†å¤‡ã€‚ä½ çš„æ¯ä¸ªå›¢é˜Ÿé‡Œéƒ½åº” è¯¥è¦æœ‰å‡ ä¸ªè¿™æ ·çš„äºº,ä»–ä»¬å…·å¤‡äº†é…ç½®åŸºç¡€è®¾æ–½å’Œéƒ¨ç½²æœåŠ¡çš„èƒ½åŠ›,è€Œä¸” ä¸éœ€è¦æ±‚åŠ©äºå¤–éƒ¨ã€‚è¦æ³¨æ„,å…‰æ˜¯æœ‰ä¸€ä¸ª DevOps å›¢é˜Ÿå¹¶ä¸æ„å‘³ç€ä½ åœ¨å® æ–½ DevOpsã€‚å¼€å‘äººå‘˜åº”è¯¥å‚ä¸ç®¡ç†ä¸åº”ç”¨ç¨‹åºç›¸å…³çš„ç»„ä»¶,åŒ…æ‹¬åŸºç¡€è®¾æ–½ã€‚</p>
<p>  ç±»ä¼¼çš„,å¦‚æœä½ æ²¡æœ‰çµæ´»çš„åŸºç¡€è®¾æ–½(æ˜“äºä¼¸ç¼©å¹¶ä¸”å¯ä»¥ç”±å›¢é˜Ÿé‡Œçš„ä¸åŒäººå‘˜æ¥ç®¡ç†)æ¥æ”¯æ’‘å½“å‰çš„æ¶æ„,é‚£ä¹ˆåœ¨è¿ç§»åˆ°å¾®æœåŠ¡å‰å¿…é¡»å…ˆè§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä½ å½“ç„¶å¯ä»¥åœ¨è£¸æœºä¸Šè¿è¡Œå¾®æœåŠ¡,ä»¥æ›´ä½çš„æˆæœ¬è·å¾—å‡ºä¼—çš„æ€§èƒ½,ä½†åœ¨æœåŠ¡çš„è¿ç»´å’Œéƒ¨ç½²æ–¹é¢ä¹Ÿå¿…é¡»å…·å¤‡çµæ´»æ€§ã€‚</p>
<h2 id="åŸºæœ¬çš„ç›‘æ§"><a href="#åŸºæœ¬çš„ç›‘æ§" class="headerlink" title="åŸºæœ¬çš„ç›‘æ§"></a>åŸºæœ¬çš„ç›‘æ§</h2><p>  å¦‚æœä½ ä¸æ›¾å¯¹ä½ çš„å•ä½“åº”ç”¨è¿›è¡Œè¿‡æ€§èƒ½ç›‘æ§,é‚£ä¹ˆåœ¨è¿ç§»åˆ°å¾®æœåŠ¡æ—¶, ä½ çš„æ—¥å­ä¼šå¾ˆéš¾è¿‡ã€‚ä½ éœ€è¦ç†Ÿæ‚‰ç³»ç»Ÿçº§åˆ«çš„åº¦é‡æŒ‡æ ‡(æ¯”å¦‚ CPU å’Œå†…å­˜)ã€ åº”ç”¨çº§åˆ«çš„åº¦é‡æŒ‡æ ‡(æ¯”å¦‚ç«¯ç‚¹çš„è¯·æ±‚å»¶è¿Ÿæˆ–ç«¯ç‚¹çš„é”™è¯¯)å’Œä¸šåŠ¡çº§åˆ«çš„ åº¦é‡æŒ‡æ ‡(æ¯”å¦‚æ¯ç§’äº‹åŠ¡æ•°æˆ–æ¯ç§’æ”¶ç›Š),è¿™æ ·æ‰å¯ä»¥æ›´å¥½åœ°ç†è§£ç³»ç»Ÿçš„ æ€§èƒ½ã€‚åœ¨æ€§èƒ½æ–¹é¢,å¾®æœåŠ¡ç”Ÿæ€ç³»ç»Ÿæ¯”å•ä½“ç³»ç»Ÿè¦å¤æ‚å¾—å¤š,å°±æ›´ä¸ç”¨æ è¯Šæ–­é—®é¢˜çš„å¤æ‚æ€§äº†ã€‚ä½ å¯ä»¥æ­å»ºä¸€ä¸ªç›‘æ§ç³»ç»Ÿ(å¦‚ Prometheus),åœ¨ å°†å•ä½“åº”ç”¨æ‹†åˆ†æˆå¾®æœåŠ¡ä¹‹å‰å¯¹åº”ç”¨åšä¸€äº›å¢å¼º,ä»¥ä¾¿è¿›è¡Œç›‘æ§ã€‚</p>
<h2 id="å¿«é€Ÿéƒ¨ç½²"><a href="#å¿«é€Ÿéƒ¨ç½²" class="headerlink" title="å¿«é€Ÿéƒ¨ç½²"></a>å¿«é€Ÿéƒ¨ç½²</h2><p>  å¦‚æœä½ çš„å•ä½“ç³»ç»Ÿæ²¡æœ‰ä¸€ä¸ªå¾ˆå¥½çš„æŒç»­é›†æˆæµç¨‹å’Œéƒ¨ç½²ç³»ç»Ÿ,é‚£ä¹ˆè¦ é›†æˆå’Œéƒ¨ç½²å¥½ä½ çš„å¾®æœåŠ¡å‡ ä¹æ˜¯ä»¶ä¸å¯èƒ½çš„äº‹ã€‚æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯:10 ä¸ªå›¢é˜Ÿå’Œ 100 ä¸ªæœåŠ¡,å®ƒä»¬éƒ½éœ€è¦è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•å’Œéƒ¨ç½²,ç„¶åå†å°†è¿™äº›å·¥ ä½œä¸æµ‹è¯•å’Œéƒ¨ç½²ä¸€ä¸ªå•ä½“æ‰€éœ€è¦çš„å·¥ä½œè¿›è¡Œå¯¹æ¯”ã€‚100 ä¸ªæœåŠ¡ä¼šå‡ºç°å¤šå°‘ ç§é—®é¢˜?è€Œå•ä½“ç³»ç»Ÿå‘¢?è¿™äº›å…ˆå†³æ¡ä»¶å¾ˆå¥½åœ°è¯´æ˜äº†å¾®æœåŠ¡çš„å¤æ‚æ€§ã€‚</p>
<p>  Phil Calcadoåœ¨Fowlerçš„å…ˆå†³æ¡ä»¶æ¸…å•é‡Œæ·»åŠ äº†ä¸€äº›ä¸œè¥¿,ä¸è¿‡æˆ‘ è®¤ä¸ºå®ƒä»¬æ›´åƒæ˜¯é‡è¦çš„æ‰©å±•,è€Œä¸æ˜¯çœŸæ­£çš„å…ˆå†³æ¡ä»¶ã€‚</p>
<h2 id="å¦‚æœæˆ‘ä»¬å…·å¤‡äº†è¿™äº›å…ˆå†³æ¡ä»¶å‘¢"><a href="#å¦‚æœæˆ‘ä»¬å…·å¤‡äº†è¿™äº›å…ˆå†³æ¡ä»¶å‘¢" class="headerlink" title="å¦‚æœæˆ‘ä»¬å…·å¤‡äº†è¿™äº›å…ˆå†³æ¡ä»¶å‘¢?"></a>å¦‚æœæˆ‘ä»¬å…·å¤‡äº†è¿™äº›å…ˆå†³æ¡ä»¶å‘¢?</h2><p>  å°±ç®—å…·å¤‡äº†è¿™äº›æ¡ä»¶,ä»ç„¶éœ€è¦æ³¨æ„å¾®æœåŠ¡çš„è´Ÿé¢å› ç´ ,ç¡®ä¿å¾®æœåŠ¡èƒ½å¤Ÿä¸ºä½ çš„ä¸šåŠ¡å¸¦æ¥çœŸæ­£çš„ä»·å€¼ã€‚äº‹å®ä¸Š,å¾ˆå¤šæŠ€æœ¯äººå‘˜å¯¹å¾®æœåŠ¡ä¸­å­˜åœ¨çš„<a href="https://en.wikipedia.org/wiki/Fallacies_of_distributed_computing" target="_blank" rel="external">åˆ†å¸ƒå¼è®¡ç®—è°¬è®º</a>è§†è€Œä¸è§,ä½†ä¸ºäº†ç¡®ä¿èƒ½å¤ŸæˆåŠŸ,è¿™äº›é—®é¢˜æ˜¯å¿…é¡»è¦è€ƒè™‘åˆ°çš„ã€‚å¯¹äºå¤§éƒ¨åˆ†æˆé•¿å‹åˆåˆ›å…¬å¸æ¥è¯´,åŸºäºå„ç§åŸå› ,ä»–ä»¬åº”è¯¥é¿å…ä½¿ç”¨å¾®æœåŠ¡ã€‚</p>
<h2 id="è¿è¥æˆæœ¬çš„å¢åŠ "><a href="#è¿è¥æˆæœ¬çš„å¢åŠ " class="headerlink" title="è¿è¥æˆæœ¬çš„å¢åŠ "></a>è¿è¥æˆæœ¬çš„å¢åŠ </h2><p>  å¿«é€Ÿéƒ¨ç½²è¿™ä¸€å…ˆå†³æ¡ä»¶å·²ç»æ¶µç›–äº†ä¸€éƒ¨åˆ†æˆæœ¬,é™¤æ­¤ä¹‹å¤–,å¯¹ å¾®æœåŠ¡è¿›è¡Œå®¹å™¨åŒ–(å¯èƒ½ä½¿ç”¨ Docker)å’Œä½¿ç”¨å®¹å™¨ç¼–æ’ç³»ç»Ÿ(æ¯”å¦‚ Kubernetes)ä¹Ÿéœ€è¦è€—è´¹å¾ˆå¤šæˆæœ¬ã€‚Docker å’Œ Kubernetes éƒ½æ˜¯å¾ˆä¼˜ç§€çš„ æŠ€æœ¯,ä½†æ˜¯å¯¹äºå¤§éƒ¨åˆ†æˆé•¿å‹åˆåˆ›å…¬å¸æ¥è¯´,å®ƒä»¬éƒ½æ˜¯ä¸€ç§è´Ÿæ‹…ã€‚æˆ‘è§è¿‡ åˆåˆ›å…¬å¸ä½¿ç”¨ rsync ä½œä¸ºéƒ¨ç½²å’Œç¼–æ’å·¥å…·,æˆ‘ä¹Ÿè§è¿‡å¾ˆå¤šçš„åˆåˆ›å…¬å¸é™·å…¥ è¿ç»´å·¥å…·çš„å¤æ‚æ€§æ³¥æ½­é‡Œ,ä»–ä»¬å› æ­¤æµªè´¹äº†å¾ˆå¤šæ—¶é—´,è€Œè¿™äº›æ—¶é—´æœ¬æ¥å¯ ä»¥ç”¨äºä¸ºç”¨æˆ·å¼€å‘æ›´å¤šçš„åŠŸèƒ½ã€‚</p>
<h2 id="ä½ çš„åº”ç”¨ä¼šè¢«æ‹–æ…¢"><a href="#ä½ çš„åº”ç”¨ä¼šè¢«æ‹–æ…¢" class="headerlink" title="ä½ çš„åº”ç”¨ä¼šè¢«æ‹–æ…¢"></a>ä½ çš„åº”ç”¨ä¼šè¢«æ‹–æ…¢</h2><p>  å¦‚æœä½ çš„å•ä½“ç³»ç»Ÿé‡ŒåŒ…å«äº†å¤šä¸ªæ¨¡å—,å¹¶ä¸”åœ¨æ¨¡å—é—´å®šä¹‰äº†è‰¯å¥½çš„ API,é‚£ä¹ˆ API ä¹‹é—´çš„äº¤äº’å°±å‡ ä¹æ²¡æœ‰ä»€ä¹ˆé¢å¤–å¼€é”€ã€‚ä½†å¯¹äºå¾®æœåŠ¡æ¥è¯´ å°±ä¸æ˜¯è¿™ä¹ˆä¸€å›äº‹äº†,å› ä¸ºå®ƒä»¬ä¸€èˆ¬è¿è¡Œåœ¨ä¸åŒçš„æœºå™¨ä¸Š,å®ƒä»¬ä¹‹é—´éœ€è¦ é€šè¿‡ç½‘ç»œè¿›è¡Œäº¤äº’ã€‚è¿™æ ·ä¼šåœ¨ä¸€å®šç¨‹åº¦ä¸Šæ‹–æ…¢æ•´ä¸ªç³»ç»Ÿã€‚å¦‚æœä¸€ä¸ªè¯·æ±‚éœ€ è¦å¤šä¸ªæœåŠ¡è¿›è¡ŒåŒæ­¥äº¤äº’,é‚£ä¹ˆæƒ…å†µä¼šå˜å¾—æ›´åŠ ç³Ÿç³•ã€‚æˆ‘æ›¾ç»å·¥ä½œè¿‡çš„ä¸€ ä¸ªå…¬å¸,ä»–ä»¬éœ€è¦è°ƒç”¨å°†è¿‘ 10 ä¸ªæœåŠ¡æ‰èƒ½å¤„ç†å®ŒæŸäº›è¯·æ±‚ã€‚å¤„ç†è¯·æ±‚çš„ æ¯ä¸€ä¸ªæ­¥éª¤éƒ½éœ€è¦é¢å¤–çš„ç½‘ç»œå¼€é”€å’Œå»¶è¿Ÿ,ä½†å®é™…ä¸Š,ä»–ä»¬å¯ä»¥æŠŠè¿™äº›æœ åŠ¡æ”¾åœ¨å•ä¸ªè½¯ä»¶åŒ…é‡Œ,æŒ‰ç…§ä¸åŒçš„æ¨¡å—æ¥åŒºåˆ†,æˆ–è€…æŠŠå®ƒä»¬è®¾è®¡æˆå¼‚æ­¥çš„ã€‚è¿™æ ·å¯ä»¥ä¸ºä»–ä»¬èŠ‚çœå¤§é‡çš„åŸºç¡€è®¾æ–½æˆæœ¬ã€‚</p>
<h2 id="æœ¬åœ°å¼€å‘å˜å¾—æ›´åŠ å›°éš¾"><a href="#æœ¬åœ°å¼€å‘å˜å¾—æ›´åŠ å›°éš¾" class="headerlink" title="æœ¬åœ°å¼€å‘å˜å¾—æ›´åŠ å›°éš¾"></a>æœ¬åœ°å¼€å‘å˜å¾—æ›´åŠ å›°éš¾</h2><p>  å¦‚æœä½ æœ‰ä¸€ä¸ªå•ä½“åº”ç”¨,åç«¯åªæœ‰ä¸€ä¸ªæ•°æ®åº“,é‚£ä¹ˆåœ¨å¼€å‘è¿‡ç¨‹ä¸­, åœ¨æœ¬åœ°è¿è¡Œè¿™ä¸ªåº”ç”¨æ˜¯å¾ˆå®¹æ˜“çš„ã€‚å¦‚æœä½ æœ‰ 100 ä¸ªæœåŠ¡,å¹¶ä½¿ç”¨äº†å¤šä¸ªæ•° æ®å­˜å‚¨ç³»ç»Ÿ,è€Œä¸”å®ƒä»¬ä¹‹é—´äº’ç›¸ä¾èµ–,é‚£ä¹ˆæœ¬åœ°å¼€å‘å°±ä¼šå˜æˆä¸€ä¸ªå™©æ¢¦ã€‚å³ä½¿æ˜¯ Docker ä¹Ÿæ— æ³•æŠŠä½ ä»è¿™ç§å¤æ‚æ€§æ³¥æ½­ä¸­æ‹¯æ•‘å‡ºæ¥ã€‚è™½ç„¶äº‹æƒ…åŸæœ¬ å¯ä»¥ç®€å•ä¸€äº›,ä¸è¿‡ä»ç„¶éœ€è¦å¤„ç†ä¾èµ–é—®é¢˜ã€‚ç†è®ºä¸Šè¯´,å¾®æœåŠ¡ä¸å­˜åœ¨è¿™ äº›é—®é¢˜,å› ä¸ºå¾®æœåŠ¡è¢«è®¤ä¸ºæ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚ä¸è¿‡,å¯¹äºæˆé•¿å‹åˆåˆ›å…¬å¸æ¥è¯´,å°±ä¸æ˜¯è¿™ä¹ˆä¸€å›äº‹äº†ã€‚æŠ€æœ¯äººå‘˜ä¸€èˆ¬éœ€è¦åœ¨æœ¬åœ°è¿è¡Œæ‰€æœ‰(æˆ–è€…å‡ ä¹ æ‰€æœ‰)çš„æœåŠ¡æ‰èƒ½è¿›è¡Œæ–°åŠŸèƒ½çš„å¼€å‘å’Œæµ‹è¯•ã€‚è¿™ç§å¤æ‚æ€§æ˜¯å¯¹èµ„æºçš„å·¨å¤§æµªè´¹ã€‚</p>
<h2 id="éš¾ä»¥ä¼¸ç¼©"><a href="#éš¾ä»¥ä¼¸ç¼©" class="headerlink" title="éš¾ä»¥ä¼¸ç¼©"></a>éš¾ä»¥ä¼¸ç¼©</h2><p>  å¯¹å•ä½“ç³»ç»Ÿè¿›è¡Œä¼¸ç¼©çš„æœ€ç®€å•æ–¹å¼æ˜¯åœ¨è´Ÿè½½å‡è¡¡å™¨åé¢éƒ¨ç½²å•ä½“ç³» ç»Ÿçš„å¤šä¸ªå®ä¾‹ã€‚åœ¨æµé‡å¢é•¿çš„æƒ…å†µä¸‹,è¿™æ˜¯ä¸€ç§éå¸¸ç®€å•çš„ä¼¸ç¼©æ–¹å¼, è€Œä¸”ä»è¿ç»´è§’åº¦æ¥è®²,å®ƒçš„å¤æ‚æ€§æ˜¯æœ€ä½çš„ã€‚ä½ çš„ç³»ç»Ÿåœ¨ç¼–æ’å¹³å°(å¦‚ <a href="https://aws.amazon.com/cn/elasticbeanstalk/" target="_blank" rel="external">Elastic Beanstalk</a>)ä¸Šè¿è¡Œçš„æ—¶é—´è¶Šé•¿è¶Šå¥½,ä½ å’Œä½ çš„å›¢é˜Ÿå°±å¯ä»¥é›†ä¸­ ç²¾åŠ›å¼€å‘å®¢æˆ·éœ€è¦çš„ä¸œè¥¿,è€Œä¸æ˜¯å¿™äºè§£å†³éƒ¨ç½²ç®¡é“é—®é¢˜ã€‚ä½¿ç”¨åˆé€‚çš„ CI/CD ç³»ç»Ÿå¯ä»¥ç¼“è§£è¿™ä¸ªé—®é¢˜,ä½†åœ¨å¾®æœåŠ¡ç”Ÿæ€ç³»ç»Ÿé‡Œ,äº‹æƒ…è¦å¤æ‚å¾—å¤š, è€Œä¸”è¿™äº›å¤æ‚æ€§æ‰€é€ æˆçš„éº»çƒ¦å·²ç»è¶…è¿‡äº†å®ƒä»¬æ‰€èƒ½å¸¦æ¥çš„å¥½å¤„ã€‚</p>
<h2 id="ç„¶åå‘¢"><a href="#ç„¶åå‘¢" class="headerlink" title="ç„¶åå‘¢?"></a>ç„¶åå‘¢?</h2><p>  å¦‚æœä½ åˆšå¥½èº«å¤„ä¸€ä¸ªæˆé•¿å‹åˆåˆ›å…¬å¸é‡Œ,éœ€è¦å¯¹æ¶æ„åšä¸€äº›è°ƒæ•´,è€Œå¾®æœåŠ¡ä¼¼ä¹ä¸èƒ½è§£å†³ä½ çš„é—®é¢˜,è¿™ä¸ªæ—¶å€™åº”è¯¥æ€ä¹ˆåŠ?</p>
<p>  Fowler æå‡ºçš„å…ˆå†³æ¡ä»¶å¯ä»¥è¯´æ˜¯æŠ€æœ¯é¢†åŸŸçš„<a href="https://en.wikipedia.org/wiki/Capability_Maturity_Model" target="_blank" rel="external">èƒ½åŠ›æˆç†Ÿåº¦æ¨¡å‹</a>, Fowler åœ¨ä»–çš„æ–‡ç« é‡Œå¯¹æˆç†Ÿåº¦æ¨¡å‹è¿›è¡Œè¿‡ä»‹ç»ã€‚å¦‚æœè¿™ç§æˆç†Ÿåº¦æ¨¡å‹å¯¹äºå…¬å¸æ¥è¯´æ˜¯è¯´å¾—é€šçš„,é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ Fowler æå‡ºçš„å…ˆå†³æ¡ä»¶,å¹¶ä½¿ç”¨å…¶ä»–çš„ä¸€äº›ä¸­é—´æ­¥éª¤ä¸ºå‘å¾®æœåŠ¡è¿ç§»åšå¥½å‡†å¤‡ã€‚ä¸‹é¢çš„å†…å®¹å¼•ç”¨è‡ª Fowler çš„æ–‡ç« ã€‚</p>
<p>  å…³é”®æ˜¯ä½ è¦è®¤è¯†åˆ°,æˆç†Ÿåº¦æ¨¡å‹çš„è¯„ä¼°ç»“æœå¹¶ä¸ä»£è¡¨ä½ çš„å½“å‰æ°´å¹³,å®ƒä»¬åªæ˜¯åœ¨å‘Šè¯‰ä½ éœ€è¦åšå“ªäº›å·¥ä½œæ‰èƒ½æœç€æ”¹è¿›çš„ç›®æ ‡å‰è¿›ã€‚ä½ å½“å‰çš„æ°´å¹³åªæ˜¯ä¸€ç§ä¸­é—´å·¥ä½œ,ç”¨äºç¡®å®šä¸‹ä¸€æ­¥è¯¥è·å¾—ä»€ä¹ˆæ ·çš„æŠ€èƒ½ã€‚</p>
<p>  é‚£ä¹ˆ,æˆ‘ä»¬è¯¥åšå‡ºæ€æ ·çš„æ”¹è¿›,ä»¥åŠå¦‚ä½•è¾¾æˆè¿™äº›ç›®æ ‡?æˆ‘ä»¬éœ€è¦ç»è¿‡ä¸€äº›ç®€å•çš„æ­¥éª¤,å…¶ä¸­å‰é¢ä¸¤æ­¥å°±å¯ä»¥è§£å†³å¾ˆå¤šåœ¨å‘å¾®æœåŠ¡è¿ç§»è¿‡ç¨‹ä¸­ä¼šå‡ºç°çš„é—®é¢˜,è€Œä¸”ä¸ä¼šå¸¦æ¥ç›¸å…³çš„å¤æ‚æ€§ã€‚</p>
<ul>
<li>æ¸…ç†åº”ç”¨ç¨‹åºã€‚ç¡®ä¿åº”ç”¨ç¨‹åºå…·æœ‰è‰¯å¥½çš„è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶,å¹¶ä½¿ ç”¨äº†æœ€æ–°ç‰ˆæœ¬çš„è½¯ä»¶åŒ…ã€æ¡†æ¶å’Œç¼–ç¨‹è¯­è¨€ã€‚</li>
<li>é‡æ„åº”ç”¨ç¨‹åº,æŠŠå®ƒæ‹†åˆ†æˆå¤šä¸ªæ¨¡å—,ä¸ºæ¨¡å—å®šä¹‰æ¸…æ™°çš„APIã€‚ä¸ è¦è®©å¤–éƒ¨ä»£ç ç›´æ¥è§¦åŠæ¨¡å—å†…éƒ¨,æ‰€æœ‰çš„äº¤äº’éƒ½åº”è¯¥é€šè¿‡æ¨¡å—æ ä¾›çš„APIæ¥è¿›è¡Œã€‚</li>
<li>ä»åº”ç”¨ç¨‹åºä¸­é€‰æ‹©ä¸€ä¸ªæ¨¡å—,å¹¶æŠŠå®ƒæ‹†åˆ†æˆç‹¬ç«‹çš„åº”ç”¨ç¨‹åº,éƒ¨ ç½²åœ¨ç›¸åŒçš„ä¸»æœºä¸Šã€‚ä½ å¯ä»¥ä»ä¸­è·å¾—ä¸€äº›å¥½å¤„,è€Œä¸ä¼šå¸¦æ¥å¤ªå¤š çš„è¿ç»´éº»çƒ¦ã€‚ä¸è¿‡,ä½ ä»ç„¶éœ€è¦è§£å†³è¿™ä¸¤ä¸ªåº”ç”¨ä¹‹é—´çš„äº¤äº’é—® é¢˜,è™½ç„¶å®ƒä»¬éƒ½éƒ¨ç½²åœ¨åŒä¸€ä¸ªä¸»æœºä¸Šã€‚ä¸è¿‡ä½ å¯ä»¥æ— è§†å¾®æœåŠ¡æ¶ æ„é‡Œå›ºæœ‰çš„ç½‘ç»œåˆ†åŒºé—®é¢˜å’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„å¯ç”¨æ€§é—®é¢˜ã€‚</li>
<li>æŠŠç‹¬ç«‹å‡ºæ¥çš„æ¨¡å—ç§»åŠ¨åˆ°ä¸åŒçš„ä¸»æœºä¸Šã€‚ç°åœ¨,ä½ éœ€è¦å¤„ç†è·¨ç½‘ ç»œäº¤äº’é—®é¢˜,ä¸è¿‡è¿™æ ·å¯ä»¥è®©è¿™ä¸¤ä¸ªç³»ç»Ÿä¹‹é—´çš„è€¦åˆé™å¾—æ›´ä½ã€‚</li>
<li>å¦‚æœæœ‰å¯èƒ½,å¯ä»¥é‡æ„æ•°æ®å­˜å‚¨ç³»ç»Ÿ,è®©å¦ä¸€ä¸ªä¸»æœºä¸Šçš„æ¨¡å—è´Ÿ è´£è‡ªå·±çš„æ•°æ®å­˜å‚¨ã€‚</li>
</ul>
<p>åœ¨æˆ‘æ‰€è§è¿‡çš„å…¬å¸é‡Œ,å¦‚æœä»–ä»¬èƒ½å¤Ÿå®Œæˆå‰é¢ä¸¤ä¸ªæ­¥éª¤å°±ç®—ä¸‡äº‹å¤§å‰äº†ã€‚å¦‚æœä»–ä»¬èƒ½å¤Ÿå®Œæˆå‰é¢ä¸¤ä¸ªæ­¥éª¤,é‚£ä¹ˆå‰©ä¸‹çš„æ­¥éª¤ä¸€èˆ¬ä¸ä¼šåƒä»–ä»¬æœ€åˆæƒ³è±¡çš„é‚£ä¹ˆé‡è¦äº†ã€‚å¦‚æœä½ å†³å®šåœ¨è¿™ä¸ªè¿‡ç¨‹çš„æŸä¸ªç‚¹ä¸Šåœä¸‹æ¥,è€Œç³»ç»Ÿä»ç„¶å…·æœ‰å¯ç»´æŠ¤æ€§å’Œæ¯”åˆšå¼€å§‹æ—¶æ›´å¥½çš„çŠ¶æ€,é‚£ä¹ˆå°±å†å¥½ä¸è¿‡äº†ã€‚</p>
<h2 id="ç»“å°¾"><a href="#ç»“å°¾" class="headerlink" title="ç»“å°¾"></a>ç»“å°¾</h2><p>  æˆ‘ä¸èƒ½è¯´è¿™äº›æƒ³æ³•éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„,ä¹Ÿä¸èƒ½è¯´æ˜¯æˆ‘æ‰€ç‹¬æœ‰çš„ã€‚æˆ‘åªæ˜¯ ä»å…¶ä»–é­é‡äº†ç›¸åŒé—®é¢˜çš„äººé‚£é‡Œæ”¶é›†æƒ³æ³•,å¹¶è¿åŒè§‚å¯Ÿåˆ°çš„ç°è±¡åœ¨è¿™é‡Œä½œ äº†ä¸€æ¬¡æ€»ç»“ã€‚è¿˜æœ‰å…¶ä»–å¾ˆå¤šæ¯”æˆ‘æ›´æœ‰ç»éªŒçš„äººä¹Ÿå†™è¿‡è¿™æ–¹é¢çš„æ–‡ç« ,ä»–ä»¬ å‰–æåœ°æ›´åŠ æ·±å…¥,æ¯”å¦‚Sander Makå†™çš„æœ‰å…³æ¨¡å—å’Œ<a href="https://www.oreilly.com/ideas/modules-vs-microservices" target="_blank" rel="external">å¾®æœåŠ¡çš„æ–‡ç« </a>ã€‚ä¸ç®¡ æ€æ ·,å¯¹äºæ­£åœ¨è€ƒè™‘å¯¹ä»–ä»¬çš„æœªæ¥æ¶æ„åšå‡ºè°ƒæ•´çš„å…¬å¸æ¥è¯´,è¿™äº›ç»éªŒéƒ½ æ˜¯éå¸¸é‡è¦çš„ã€‚è®¤çœŸåœ°æ€è€ƒæ¯ä¸€ä¸ªé—®é¢˜,ç¡®ä¿å¾®æœåŠ¡å¯¹ä½ ä»¬çš„ç»„ç»‡æ¥è¯´æ˜¯ ä¸€ä¸ªæ­£ç¡®çš„é€‰æ‹©ã€‚</p>
<p>  æœ€èµ·ç åœ¨å®Œæˆäº†ä¸Šè¿°çš„å‰é¢ä¸¤ä¸ªæ­¥éª¤ä¹‹å,å†æ…é‡è€ƒè™‘ä¸€ä¸‹å¾®æœåŠ¡å¯¹äºä½ çš„ç»„ç»‡æ¥è¯´æ˜¯å¦æ˜¯æ­£ç¡®çš„æ–¹å‘ã€‚ä½ ä¹‹å‰çš„å¾ˆå¤šé—®é¢˜å¯èƒ½ä¼šè¿åˆƒè€Œè§£ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQLæ€§èƒ½ç›‘æ§æ…¢æ—¥å¿—åˆ†æåˆ©å™¨]]></title>
      <url>http://team.jiunile.com/blog/2017/07/mysql-mysql-performance-monitoring.html</url>
      <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>å…¥é¢˜ä¹‹å‰å…ˆè®²è®²ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ï¼Œè¿™å°±ä¸å¾—ä¸æèµ·MySQLä¸perconaï¼Œé˜¿é‡ŒåŸºäºmysqlå¼€å‘äº†AliSQLï¼Œå†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™é˜¿é‡Œå·²ç»å°†å…¶å¼€æºï¼Œperconaæ˜¯ä¸€å®¶é¢†å…ˆçš„MySQLå’¨è¯¢å…¬å¸ï¼Œè¯¥å…¬å¸åŸºäºmysqlå¼€å‘äº†Percona Serverï¼ŒPercona Serveræ˜¯ä¸€æ¬¾ç‹¬ç«‹çš„æ•°æ®åº“äº§å“ï¼Œä¸ºç”¨æˆ·æä¾›äº†æ¢å‡ºå…¶MySQLå®‰è£…å¹¶æ¢å…¥Percona Serveräº§å“çš„èƒ½åŠ›ã€‚perconaé™¤äº†å¼€å‘äº†å¤šæ¬¾æ•°æ®åº“äº§å“ï¼Œè¿˜å¼€å‘äº†æ•°æ®åº“ç›‘æ§ç¨‹åºï¼špmmï¼ˆPercona Monitoring and Managementï¼‰æœåŠ¡å™¨ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“mysqlè‡ªèº«ç¼ºä¹å®æ—¶çš„ç›‘æ§åŠŸèƒ½ï¼Œè€Œæ­¤æ—¶pmm-serverå°±æ°å¥½è§£å†³äº†æˆ‘ä»¬è¿™ä¸€éš¾é¢˜ï¼Œå¥½äº†åºŸè¯ä¸å¤šè¯´ï¼Œå…ˆçœ‹ä¸€å¼ pmm serverçš„ç›‘æ§å›¾ã€‚<br><img src="/images/mysql_pmm_1.png" alt="PMM"></p>
<p>å¸¸è§„çš„ç›‘æµ‹é¡¹ç›®éƒ½æœ‰äº†ï¼Œæœ€å¸å¼•æˆ‘çš„ä¸€ç‚¹åœ¨äºå®ƒçš„æ…¢æ—¥å¿—åˆ†æåŠŸèƒ½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="/images/mysql_pmm_2.png" alt="PMM"></p>
<a id="more"></a>
<h2 id="å®‰è£…æ­¥éª¤"><a href="#å®‰è£…æ­¥éª¤" class="headerlink" title="å®‰è£…æ­¥éª¤"></a>å®‰è£…æ­¥éª¤</h2><h3 id="1-åœ¨vmwareæˆ–è€…virtualboxä¸Šå®‰è£…ubuntu14-04-Serveré•œåƒï¼Œå¯ä»¥é€‰æ‹©æ¸…åå¤§å­¦çš„é•œåƒï¼Œä¸‹è½½é€Ÿåº¦å¿«"><a href="#1-åœ¨vmwareæˆ–è€…virtualboxä¸Šå®‰è£…ubuntu14-04-Serveré•œåƒï¼Œå¯ä»¥é€‰æ‹©æ¸…åå¤§å­¦çš„é•œåƒï¼Œä¸‹è½½é€Ÿåº¦å¿«" class="headerlink" title="1. åœ¨vmwareæˆ–è€…virtualboxä¸Šå®‰è£…ubuntu14.04 Serveré•œåƒï¼Œå¯ä»¥é€‰æ‹©æ¸…åå¤§å­¦çš„é•œåƒï¼Œä¸‹è½½é€Ÿåº¦å¿«"></a>1. åœ¨vmwareæˆ–è€…virtualboxä¸Šå®‰è£…ubuntu14.04 Serveré•œåƒï¼Œå¯ä»¥é€‰æ‹©æ¸…åå¤§å­¦çš„é•œåƒï¼Œä¸‹è½½é€Ÿåº¦å¿«</h3><h3 id="2-ç³»ç»Ÿè£…å®Œåæ¥ä¸‹æ¥å°±è¦åœ¨ubuntuä¸Šå®‰è£…dockeräº†ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š"><a href="#2-ç³»ç»Ÿè£…å®Œåæ¥ä¸‹æ¥å°±è¦åœ¨ubuntuä¸Šå®‰è£…dockeräº†ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š" class="headerlink" title="2. ç³»ç»Ÿè£…å®Œåæ¥ä¸‹æ¥å°±è¦åœ¨ubuntuä¸Šå®‰è£…dockeräº†ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š"></a>2. ç³»ç»Ÿè£…å®Œåæ¥ä¸‹æ¥å°±è¦åœ¨ubuntuä¸Šå®‰è£…dockeräº†ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="_">-s</span>SL https://get.daocloud.io/docker | sh</span><br></pre></td></tr></table></figure>
<p>ç­‰å¾…å®Œæˆå³å¯ï¼Œè¿™æ˜¯ä¸€ç§å®‰è£…dockeræ¯”è¾ƒå¿«çš„æ–¹å¼ï¼Œè€Œä¸”å®‰è£…çš„dockerç‰ˆæœ¬ä¹Ÿæ¯”è¾ƒé«˜ï¼Œå®‰è£…å®Œæˆåè¾“å…¥docker -vçœ‹åˆ°ä¸‹é¢ä¿¡æ¯è¯´æ˜å®‰è£…å®Œæˆï¼š<br><code>Docker version 17.04.0-ce, build 4845c56</code></p>
<h3 id="3-å®‰è£…å®Œdockerï¼Œæ¥ä¸‹æ¥å°±éœ€è¦ä¸‹è½½pmm-serverçš„é•œåƒï¼Œç”±äºä¸‹è½½å›½å¤–é•œåƒé€Ÿåº¦æ…¢è€Œä¸”ç½‘ç»œä¸ç¨³å®šï¼Œè¿™é‡Œæ¨èä¸€ä¸ªä¸­ç§‘å¤§çš„å¼€æºdockeré•œåƒï¼š"><a href="#3-å®‰è£…å®Œdockerï¼Œæ¥ä¸‹æ¥å°±éœ€è¦ä¸‹è½½pmm-serverçš„é•œåƒï¼Œç”±äºä¸‹è½½å›½å¤–é•œåƒé€Ÿåº¦æ…¢è€Œä¸”ç½‘ç»œä¸ç¨³å®šï¼Œè¿™é‡Œæ¨èä¸€ä¸ªä¸­ç§‘å¤§çš„å¼€æºdockeré•œåƒï¼š" class="headerlink" title="3. å®‰è£…å®Œdockerï¼Œæ¥ä¸‹æ¥å°±éœ€è¦ä¸‹è½½pmm serverçš„é•œåƒï¼Œç”±äºä¸‹è½½å›½å¤–é•œåƒé€Ÿåº¦æ…¢è€Œä¸”ç½‘ç»œä¸ç¨³å®šï¼Œè¿™é‡Œæ¨èä¸€ä¸ªä¸­ç§‘å¤§çš„å¼€æºdockeré•œåƒï¼š"></a>3. å®‰è£…å®Œdockerï¼Œæ¥ä¸‹æ¥å°±éœ€è¦ä¸‹è½½pmm serverçš„é•œåƒï¼Œç”±äºä¸‹è½½å›½å¤–é•œåƒé€Ÿåº¦æ…¢è€Œä¸”ç½‘ç»œä¸ç¨³å®šï¼Œè¿™é‡Œæ¨èä¸€ä¸ªä¸­ç§‘å¤§çš„å¼€æºdockeré•œåƒï¼š</h3><p>åœ¨ Docker çš„å¯åŠ¨å‚æ•°ä¸­åŠ å…¥:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--registry-mirror=https://docker.mirrors.ustc.edu.cn</span><br></pre></td></tr></table></figure></p>
<p>Ubuntu ç”¨æˆ·ï¼ˆåŒ…æ‹¬ä½¿ç”¨ systemd çš„ Ubuntu 15.04ï¼‰å¯ä»¥ä¿®æ”¹ /etc/default/docker æ–‡ä»¶ï¼ŒåŠ å…¥å¦‚ä¸‹å‚æ•°ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOCKER_OPTS=<span class="string">"--registry-mirror=https://docker.mirrors.ustc.edu.cn"</span></span><br></pre></td></tr></table></figure></p>
<p>å…¶ä»– systemd ç”¨æˆ·å¯ä»¥é€šè¿‡æ‰§è¡Œ sudo systemctl edit docker.service æ¥ä¿®æ”¹è®¾ç½®, è¦†ç›–é»˜è®¤çš„å¯åŠ¨å‚æ•°:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/docker <span class="_">-d</span> -H fd:// --registry-mirror=https://docker.mirrors.ustc.edu.cn</span><br></pre></td></tr></table></figure></p>
<h3 id="4-æ¥ä¸‹æ¥ä¸‹è½½pmmé•œåƒçš„é€Ÿåº¦å°±ä¼šå¤§å¤§æå‡ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š"><a href="#4-æ¥ä¸‹æ¥ä¸‹è½½pmmé•œåƒçš„é€Ÿåº¦å°±ä¼šå¤§å¤§æå‡ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š" class="headerlink" title="4. æ¥ä¸‹æ¥ä¸‹è½½pmmé•œåƒçš„é€Ÿåº¦å°±ä¼šå¤§å¤§æå‡ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š"></a>4. æ¥ä¸‹æ¥ä¸‹è½½pmmé•œåƒçš„é€Ÿåº¦å°±ä¼šå¤§å¤§æå‡ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull percona/pmm-server:1.2.0</span><br></pre></td></tr></table></figure>
<p>ç„¶åç­‰å¾…å®Œæˆå³å¯ã€‚</p>
<h3 id="5-åˆ›å»ºPMM-æ•°æ®å®¹å™¨ï¼š"><a href="#5-åˆ›å»ºPMM-æ•°æ®å®¹å™¨ï¼š" class="headerlink" title="5. åˆ›å»ºPMM æ•°æ®å®¹å™¨ï¼š"></a>5. åˆ›å»ºPMM æ•°æ®å®¹å™¨ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker create \</span><br><span class="line">   -v /opt/prometheus/data \</span><br><span class="line">   -v /opt/consul-data \</span><br><span class="line">   -v /var/lib/mysql \</span><br><span class="line">   -v /var/lib/grafana \</span><br><span class="line">   --name pmm-data \</span><br><span class="line">   percona/pmm-server:1.2.0 /bin/<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h3 id="6-è¿è¡ŒPMM-serverå®¹å™¨"><a href="#6-è¿è¡ŒPMM-serverå®¹å™¨" class="headerlink" title="6. è¿è¡ŒPMM serverå®¹å™¨:"></a>6. è¿è¡ŒPMM serverå®¹å™¨:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="_">-d</span> \</span><br><span class="line">   -p 80:80 \</span><br><span class="line">   --volumes-from pmm-data \</span><br><span class="line">   --name pmm-server \</span><br><span class="line">   --restart always \</span><br><span class="line">   percona/pmm-server:1.2.0</span><br></pre></td></tr></table></figure>
<h3 id="7-å®‰è£…PMMå®¢æˆ·ç«¯ï¼š"><a href="#7-å®‰è£…PMMå®¢æˆ·ç«¯ï¼š" class="headerlink" title="7. å®‰è£…PMMå®¢æˆ·ç«¯ï¼š"></a>7. å®‰è£…PMMå®¢æˆ·ç«¯ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh https://www.percona.com/downloads/pmm-client/pmm-client-1.2.0/binary/redhat/7/x86_64/pmm-client-1.2.0-1.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h3 id="8-è¿æ¥PMMæœåŠ¡å™¨ï¼š"><a href="#8-è¿æ¥PMMæœåŠ¡å™¨ï¼š" class="headerlink" title="8. è¿æ¥PMMæœåŠ¡å™¨ï¼š"></a>8. è¿æ¥PMMæœåŠ¡å™¨ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pmm-admin config --server pmmæœåŠ¡å™¨ä¸»æœºåœ°å€</span><br></pre></td></tr></table></figure>
<h3 id="9-é…ç½®mysqlç›‘æ§ï¼š"><a href="#9-é…ç½®mysqlç›‘æ§ï¼š" class="headerlink" title="9. é…ç½®mysqlç›‘æ§ï¼š"></a>9. é…ç½®mysqlç›‘æ§ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pmm-admin add mysql --user root --password 123456 --host mysql ipåœ°å€ --port 3306 instace3306</span><br></pre></td></tr></table></figure>
<p><code>æ³¨ï¼špmm-clientæ”¶çš„ç›‘æ§æ•°æ®æ¥æºæœ‰è¿™ä¹ˆå‡ æ–¹é¢</code></p>
<ul>
<li>MySQLæ‰€åœ¨æœºå™¨çš„ç³»ç»ŸæŒ‡æ ‡</li>
<li>MySQLçš„performance_schemaåº“</li>
<li>slow-log(æ…¢æŸ¥è¯¢æ—¥å¿—â€“mysqlè¦å¼€å¯æ…¢æ—¥å¿—åŠŸèƒ½)</li>
</ul>
<p><code>å¦‚æœæˆ‘ä»¬æƒ³æ”¶é›†aå’Œcä¸­çš„æŒ‡æ ‡çš„è¯ï¼Œæœ€å¥½è¿˜æ˜¯å°†pmm-clientéƒ¨ç½²åœ¨MySQLæ‰€åœ¨æœºå™¨</code></p>
<h3 id="10-è‡³æ­¤è®¿é—®pmmæœåŠ¡å™¨ipåœ°å€å³å¯æŸ¥çœ‹æ¥å£"><a href="#10-è‡³æ­¤è®¿é—®pmmæœåŠ¡å™¨ipåœ°å€å³å¯æŸ¥çœ‹æ¥å£" class="headerlink" title="10. è‡³æ­¤è®¿é—®pmmæœåŠ¡å™¨ipåœ°å€å³å¯æŸ¥çœ‹æ¥å£"></a>10. è‡³æ­¤è®¿é—®pmmæœåŠ¡å™¨ipåœ°å€å³å¯æŸ¥çœ‹æ¥å£</h3>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQL too many connection é—®é¢˜åˆ†æ]]></title>
      <url>http://team.jiunile.com/blog/2016/09/mysql-mysql-sleep.html</url>
      <content type="html"><![CDATA[<h2 id="é—®é¢˜ç¼˜ç”±"><a href="#é—®é¢˜ç¼˜ç”±" class="headerlink" title="é—®é¢˜ç¼˜ç”±"></a>é—®é¢˜ç¼˜ç”±</h2><p>çº¿ä¸Šä¸€ä¸ªç½‘ç«™åœ¨è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œé¡µé¢æ‰“å¼€é€Ÿåº¦å˜æ…¢éšä¹‹å‡ºç°<code>502 bad gateway</code>çš„é”™è¯¯ã€‚</p>
<h2 id="é—®é¢˜åˆ†æ"><a href="#é—®é¢˜åˆ†æ" class="headerlink" title="é—®é¢˜åˆ†æ"></a>é—®é¢˜åˆ†æ</h2><p>ç”±<code>502 bad gateway</code>çš„é”™è¯¯ï¼Œæˆ‘ä»¬çŸ¥é“å°±æ˜¯nginxé“¾æ¥åç«¯çš„phpï¼Œè€Œphpç¨‹åºæ²¡æœ‰åŠæ—¶è¿”å›ï¼Œé€ æˆäº†è¶…æ—¶ã€‚<br>é‚£ä¹ˆé€ æˆphpè¶…æ—¶çš„åŸå› ä¹Ÿæœ‰å¤šç§ï¼Œæ¯”å¦‚ï¼š</p>
<ol>
<li>php-fpmèµ„æºæ¶ˆè€—å…‰</li>
<li>è°ƒç”¨å¤–éƒ¨èµ„æºè¶…æ—¶ï¼Œæ¯”å¦‚å¤–éƒ¨çš„web serviceã€æ•°æ®åº“ç­‰ç­‰</li>
<li>â€¦.</li>
</ol>
<p>å‡ºç°é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆç™»å½•æœåŠ¡å™¨æŸ¥çœ‹ç›¸å…³æ—¥å¿—ã€‚</p>
<p>ç»“åˆæˆ‘ä»¬çš„ä¸šåŠ¡ï¼Œé¦–å…ˆæƒ³åˆ°äº†mysqlæ•°æ®åº“ï¼Œå…ˆæŸ¥çœ‹äº†ä¸€ä¸‹mysqlæ•°æ®åº“çš„çŠ¶æ€ï¼Œé€šè¿‡show full processlistå‘½ä»¤å‘ç°æœ‰å¤§é‡çš„é“¾æ¥å¤„äºsleepçŠ¶æ€ã€‚</p>
<p><code>sleep</code>çŠ¶æ€çš„æ„æ€å°±æ˜¯è¯´ï¼ŒæŸä¸ªå®¢æˆ·ç«¯ä¸€ç›´å ç€è¿™ä¸ªé“¾æ¥ï¼Œä½†æ˜¯ä»€ä¹ˆäº‹ä¹Ÿä¸å¹²ï¼Œæˆ–è€…æ˜¯å®¢æˆ·ç«¯å‹æ ¹å„¿å°±å·²ç»æ–­å¼€äº†ï¼Œè€ŒæœåŠ¡ç«¯å´ä¸çŸ¥é“ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œmysqlçš„è¿æ¥æ•°æ˜¯æœ‰é™åˆ¶çš„ï¼Œæ¯”å¦‚é»˜è®¤æ˜¯151ä¸ªï¼Œé‚£ä¹ˆå½“å¤§é‡çš„é“¾æ¥å¤„äºsleepçŠ¶æ€æ—¶ï¼Œphpç¨‹åºå°±æ— æ³•åŒmysqlå»ºç«‹é“¾æ¥ï¼Œå°±ä¼šå‘ç”Ÿè¶…æ—¶ç°è±¡ã€‚</p>
<a id="more"></a>
<p>é‚£ä¹ˆé€ æˆsleepçš„åŸå› ï¼Œæœ‰ä¸‰ä¸ªï¼Œä¸‹é¢æ˜¯mysqlæ‰‹å†Œç»™å‡ºçš„è§£é‡Šï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯ç¨‹åºåœ¨é€€å‡ºä¹‹å‰æ²¡æœ‰è°ƒç”¨<code>mysql_close()</code>ã€‚[å†™ç¨‹åºçš„ç–å¿½ï¼Œæˆ–è€…æ•°æ®åº“çš„dbç±»åº“æ²¡æœ‰è‡ªåŠ¨å…³é—­æ¯æ¬¡çš„è¿æ¥ã€‚ã€‚ã€‚]</li>
<li>å®¢æˆ·ç«¯sleepçš„æ—¶é—´åœ¨<code>wait_timeout</code>æˆ–<code>interactive_timeout</code>è§„å®šçš„ç§’å†…æ²¡æœ‰å‘å‡ºä»»ä½•è¯·æ±‚åˆ°æœåŠ¡å™¨. [ç±»ä¼¼å¸¸è¿ï¼Œç±»ä¼¼äºä¸å®Œæ•´çš„tcp ipåè®®æ„é€ ï¼ŒæœåŠ¡ç«¯ä¸€ç›´è®¤ä¸ºå®¢æˆ·ç«¯ä»ç„¶å­˜åœ¨ï¼ˆæœ‰å¯èƒ½å®¢æˆ·ç«¯å·²ç»æ–­æ‰äº†ï¼‰]</li>
<li>å®¢æˆ·ç«¯ç¨‹åºåœ¨ç»“æŸä¹‹å‰å‘æœåŠ¡å™¨å‘é€äº†è¯·æ±‚è¿˜æ²¡å¾—åˆ°è¿”å›ç»“æœå°±ç»“æŸæ‰äº†ã€‚ [å‚çœ‹ï¼štcp ipåè®®çš„ä¸‰æ¬¡æ¡æ‰‹]</li>
</ol>
<p>é‚£ä¹ˆçŸ¥é“äº†é—®é¢˜æ‰€åœ¨ï¼Œå°±è¦æ‰¾åˆ°æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„sleepçº¿ç¨‹çš„å­˜åœ¨ï¼Œ</p>
<p>é€šè¿‡ä¸Šé¢çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬çŸ¥é“æ˜¯ 192.168.1.2è¿™ä¸ªIPçš„20318ç«¯å£å’Œmysqlå»ºç«‹çš„é“¾æ¥ï¼Œè€Œ192.168.1.2æ­£æ˜¯æˆ‘ä»¬çš„webæœåŠ¡å™¨ï¼Œ</p>
<p>äºæ˜¯sshç™»å½•æœåŠ¡å™¨ï¼Œé€šè¿‡<code>netstat -tunp</code>æ‰¾åˆ°ç«¯å£20318æ‰€å¯¹åº”çš„è¿›ç¨‹å’Œpidï¼Œä¸€çœ‹å°±æ˜¯php-fpmå¼•èµ·çš„ã€‚</p>
<p>ä¸‹é¢å°±æ˜¯è¦çœ‹ä¸€ä¸‹è¿™ä¸ªphp-fpmæ˜¯è°ƒç”¨çš„å“ªä¸€ä¸ªphpæ–‡ä»¶ï¼Œæ‰¾åˆ°äº†å…·ä½“çš„phpæ–‡ä»¶å°±å¥½åŠäº†ã€‚</p>
<p>å…·ä½“å¯ä»¥é€šè¿‡<code>lsof</code>åˆ—å‡ºè¿™ä¸ª<code>pid</code>æ‰“å¼€çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡<code>strace</code>è·Ÿè¸ªè¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p>ä¸‹é¢æ˜¯lsofçš„éƒ¨åˆ†è¾“å‡ºï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lsof -p 23018</span></span><br><span class="line">COMMAND   PID   USER   FD   TYPE     DEVICE     SIZE       NODE NAME</span><br><span class="line">php-fpm 15687 daemon  cwd    DIR      104,2     4096   69437193 /xxx/daemon.php</span><br><span class="line">php-fpm 15687 daemon  rtd    DIR      104,6     4096          2 /</span><br><span class="line">php-fpm 15687 daemon  txt    REG      104,5 27714205    3466635 /app/php/sbin/php-fpm</span><br></pre></td></tr></table></figure></p>
<p>ä»ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯æˆ‘ä»¬çš„<code>daemon.php</code>å¼•èµ·çš„ï¼Œè¿™ä¸ªç¨‹åºæ˜¯æˆ‘ä»¬å‘iosè®¾å¤‡æ¨é€é€šçŸ¥çš„ç¨‹åºï¼Œå…¶ä¸­è¦è·Ÿè‹¹æœï¼ˆAppleï¼‰çš„æœåŠ¡å™¨å»ºç«‹é“¾æ¥ï¼Œå¯èƒ½æ˜¯è‹¹æœæœåŠ¡å™¨ä¸ç¨³å®š,è¶…æ—¶å¼•èµ·çš„ã€‚</p>
<p>ç¨‹åºå¤§è‡´æµç¨‹ï¼š<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql_connect();  <span class="comment">//å»ºç«‹é“¾æ¥</span></span><br><span class="line"></span><br><span class="line">$queryBid = mysql_query(<span class="string">"select bundleId from apps"</span>);</span><br><span class="line"><span class="keyword">while</span> ($row = mysql_fetch_assoc($queryBid)) &#123;</span><br><span class="line">	<span class="comment">//å–å‡ºé€šçŸ¥å†…å®¹ï¼Œè¿æ¥è‹¹æœæœåŠ¡å™¨ï¼Œè¿›è¡Œæ¨é€</span></span><br><span class="line">	<span class="comment">//è¿™é‡Œæœ‰æ—¶å€™ä¼šèŠ±ä¸€äºŒååˆ†é’Ÿï¼Œæ­¤æ—¶mysqlæœåŠ¡å™¨é‚£é‡Œçš„è¿æ¥ä¸€ç›´æ˜¯sleepçŠ¶æ€</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mysql_close();</span><br></pre></td></tr></table></figure></p>
<h2 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h2><p>æ–¹æ¡ˆä¸€ï¼šä¿®æ”¹çš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡mysqlæŠŠæ•°æ®å–å‡ºæ¥ï¼Œä¹‹åé©¬ä¸Šå…³æ‰mysqlè¿æ¥ï¼Œé‡Šæ”¾mysqlèµ„æºï¼Œå‰©ä¸‹çš„å°±æ…¢æ…¢å¹²å¥½äº†ã€‚ ä¿®æ”¹åçš„ç¨‹åºæ˜¯è¿™æ ·çš„ï¼š<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql_connect();  <span class="comment">//å»ºç«‹é“¾æ¥</span></span><br><span class="line"></span><br><span class="line">$arr_bid=<span class="keyword">array</span>();</span><br><span class="line">$queryBid = mysql_query(<span class="string">"select bundleId from apps"</span>);</span><br><span class="line"><span class="keyword">while</span>($row = mysql_fetch_assoc($queryBid)) &#123;</span><br><span class="line">	$arr_bid[] = $row;</span><br><span class="line">&#125;</span><br><span class="line">mysql_close(); <span class="comment">//ä»mysqlä¸­å–å®Œæ•°æ®å°±é©¬ä¸Šå…³é—­è¿æ¥</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($arr_bid <span class="keyword">as</span> $row)&#123;</span><br><span class="line">	<span class="comment">//å–å‡ºé€šçŸ¥å†…å®¹ï¼Œè¿æ¥è‹¹æœæœåŠ¡å™¨ï¼Œè¿›è¡Œæ¨é€</span></span><br><span class="line">	<span class="comment">//è¿™é‡Œæœ‰æ—¶å€™ä¼šèŠ±ä¸€äºŒååˆ†é’Ÿ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ–¹æ¡ˆäºŒï¼š[ä¸æ²»æœ¬ï¼Œæœ‰å¼Šç«¯]<br>å†™ä¸€ä¸ªå®šæ—¶è„šæœ¬ï¼Œæ¯åˆ†é’Ÿæ£€æŸ¥ä¸‹mysqlè¿æ¥æ•°ï¼Œè¶…è¿‡sleepæ—¶é—´çš„è‡ªåŠ¨killæ‰<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">define(<span class="string">'MAX_SLEEP_TIME'</span>ï¼Œ <span class="number">120</span>);  </span><br><span class="line">  </span><br><span class="line">$hostname = <span class="string">"localhost"</span>;  </span><br><span class="line">$username = <span class="string">"root"</span>;  </span><br><span class="line">$password = <span class="string">"password"</span>;  </span><br><span class="line">  </span><br><span class="line">$connect = mysql_connect($hostnameï¼Œ $usernameï¼Œ $password);  </span><br><span class="line">$result = mysql_query(<span class="string">"SHOW PROCESSLIST"</span>ï¼Œ $connect);  </span><br><span class="line"><span class="keyword">while</span> ($proc = mysql_fetch_assoc($result)) &#123;  </span><br><span class="line">	<span class="keyword">if</span> ($proc[<span class="string">"Command"</span>] == <span class="string">"Sleep"</span> &amp;&amp; $proc[<span class="string">"Time"</span>] &gt; MAX_SLEEP_TIME) &#123;  </span><br><span class="line">	@mysql_query(<span class="string">"KILL "</span> . $proc[<span class="string">"Id"</span>]ï¼Œ $connect);  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;</span><br><span class="line">mysql_close($connect);</span><br></pre></td></tr></table></figure></p>
<p>åŠ å…¥åˆ°crontabå®šæ—¶è®¡åˆ’é‡Œ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * php /usr/<span class="built_in">local</span>/sbin/<span class="built_in">kill</span>-mysql-sleep-proc.php</span><br></pre></td></tr></table></figure></p>
<p>æ–¹æ¡ˆä¸‰ï¼š[ä¸æ¨è]<br>ä¿®æ”¹mysqlé…ç½®<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="built_in">wait</span>_timeout=10</span><br><span class="line"></span><br><span class="line"><span class="comment">#æˆ–è€…</span></span><br><span class="line">mysql&gt; <span class="built_in">set</span> global <span class="built_in">wait</span>_timeout=10;</span><br></pre></td></tr></table></figure></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MaxScale åœ¨ slave æœ‰æ•…éšœåå¦‚ä½•å¤„ç†ï¼Ÿ]]></title>
      <url>http://team.jiunile.com/blog/2016/08/mysql-maxscale-02.html</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¹‹å‰ä»‹ç»äº† <a href="/blog/2016/08/maxscale-01.html">MaxScale</a> å¯ä»¥å®ç° Mysql çš„è¯»å†™åˆ†ç¦»å’Œè¯»è´Ÿè½½å‡è¡¡ï¼Œé‚£ä¹ˆå½“ slave å‡ºç°æ•…éšœåï¼ŒMaxScale ä¼šå¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p>
<p>ä¾‹å¦‚æœ‰ 3 å°æ•°æ®åº“æœåŠ¡å™¨ï¼Œä¸€ä¸»äºŒä»çš„ç»“æ„ï¼Œæ•°æ®åº“åç§°åˆ†åˆ«ä¸º master, slave1, slave2</p>
<p>ç°åœ¨æˆ‘ä»¬å®éªŒä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>å½“ä¸€å°ä»æœåŠ¡å™¨ï¼ˆ slave1 æˆ–è€… slave2 ï¼‰å‡ºç°æ•…éšœåï¼ŒæŸ¥çœ‹ MaxScale å¦‚ä½•åº”å¯¹ï¼ŒåŠæ•…éšœæœåŠ¡å™¨é‡æ–°ä¸Šçº¿åçš„æƒ…å†µ</li>
<li>å½“ä¸¤å°ä»æœåŠ¡å™¨ï¼ˆ slave1 å’Œ slave2 ï¼‰éƒ½å‡ºç°æ•…éšœåï¼ŒæŸ¥çœ‹ MaxScale å¦‚ä½•åº”å¯¹ï¼ŒåŠæ•…éšœæœåŠ¡å™¨é‡æ–°ä¸Šçº¿åçš„æƒ…å†µ</li>
</ol>
<h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><p>ä¸ºäº†æ›´æ·±å…¥çš„æŸ¥çœ‹ MaxScale çš„çŠ¶æ€ï¼Œéœ€è¦æŠŠ MaxScale çš„æ—¥å¿—æ‰“å¼€</p>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/maxscale.cnf</span><br></pre></td></tr></table></figure></p>
<p>æ‰¾åˆ° [maxscale] éƒ¨åˆ†ï¼Œè¿™é‡Œç”¨æ¥è¿›è¡Œå…¨å±€è®¾ç½®ï¼Œåœ¨å…¶ä¸­æ·»åŠ æ—¥å¿—é…ç½®<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">log_info</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">logdir</span>=/tmp/</span><br></pre></td></tr></table></figure></p>
<p>é€šè¿‡å¼€å¯ log_info çº§åˆ«ï¼Œå¯ä»¥çœ‹åˆ° MaxScale çš„è·¯ç”±æ—¥å¿—</p>
<p>ä¿®æ”¹é…ç½®åï¼Œé‡å¯ MaxScale </p>
<h2 id="å®éªŒè¿‡ç¨‹"><a href="#å®éªŒè¿‡ç¨‹" class="headerlink" title="å®éªŒè¿‡ç¨‹"></a>å®éªŒè¿‡ç¨‹</h2><a id="more"></a>
<h3 id="å•ä¸ª-slave-æ•…éšœçš„æƒ…å†µ"><a href="#å•ä¸ª-slave-æ•…éšœçš„æƒ…å†µ" class="headerlink" title="å•ä¸ª slave æ•…éšœçš„æƒ…å†µ"></a>å•ä¸ª slave æ•…éšœçš„æƒ…å†µ</h3><p>åˆå§‹çŠ¶æ€æ˜¯ä¸€åˆ‡æ­£å¸¸<br><img src="/images/maxscale_08.png" alt="Maxscale"></p>
<p>åœæ‰ slave2 çš„å¤åˆ¶ï¼Œç™»å½• slave2 çš„ mysql æ‰§è¡Œ<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop slave;</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹ MaxScale æœåŠ¡å™¨çŠ¶æ€<br><img src="/images/maxscale_09.png" alt="Maxscale"></p>
<p>slave2 å·²ç»å¤±æ•ˆäº†</p>
<p>æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /tmp/maxscale1.log</span><br><span class="line"><span class="comment">#å°¾éƒ¨æ˜¾ç¤ºï¼š</span></span><br><span class="line">2016-08-15 12:26:02   notice : Server changed state: slave2[172.17.0.4:3306]: lost_slave</span><br></pre></td></tr></table></figure></p>
<p>æç¤º slave2 å·²ç»ä¸¢å¤±</p>
<p>æŸ¥çœ‹å®¢æˆ·ç«¯æŸ¥è¯¢ç»“æœ<br><img src="/images/maxscale_10.png" alt="Maxscale"></p>
<p>æŸ¥è¯¢æ“ä½œå…¨éƒ½è½¬åˆ°äº† <code>slave1</code></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ åœ¨æœ‰ slave æ•…éšœåï¼ŒMaxScale ä¼šè‡ªåŠ¨è¿›è¡Œæ’é™¤ï¼Œä¸å†å‘å…¶è½¬å‘è¯·æ±‚</p>
<p>ä¸‹é¢çœ‹ä¸‹ slave2 å†æ¬¡<strong>ä¸Šçº¿åçš„æƒ…å†µ</strong></p>
<p>ç™»å½• slave2 çš„ mysql æ‰§è¡Œ<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹ MaxScale æœåŠ¡å™¨çŠ¶æ€<br><img src="/images/maxscale_11.png" alt="Maxscale"></p>
<p>æ¢å¤äº†æ­£å¸¸çŠ¶æ€ï¼Œé‡æ–°è¯†åˆ«åˆ°äº† slave2</p>
<p>æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯ï¼Œæ˜¾ç¤ºï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2016-08-15 12:32:36   notice : Server changed state: slave2[172.17.0.4:3306]: new_slave</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹å®¢æˆ·ç«¯æŸ¥è¯¢ç»“æœ<br><img src="/images/maxscale_12.png" alt="Maxscale"></p>
<p>slave2 åˆå¯ä»¥æ­£å¸¸æ¥å—æŸ¥è¯¢è¯·æ±‚</p>
<p>é€šè¿‡å®éªŒå¯ä»¥çœ‹åˆ°ï¼Œåœ¨éƒ¨åˆ† slave å‘ç”Ÿæ•…éšœæ—¶ï¼ŒMaxScale å¯ä»¥è‡ªåŠ¨è¯†åˆ«å‡ºæ¥ï¼Œå¹¶ç§»é™¤è·¯ç”±åˆ—è¡¨ï¼Œå½“æ•…éšœæ¢å¤é‡æ–°ä¸Šçº¿åï¼ŒMaxScale ä¹Ÿèƒ½è‡ªåŠ¨å°†å…¶åŠ å…¥è·¯ç”±ï¼Œè¿‡ç¨‹é€æ˜</p>
<h3 id="å…¨éƒ¨-slave-æ•…éšœçš„æƒ…å†µ"><a href="#å…¨éƒ¨-slave-æ•…éšœçš„æƒ…å†µ" class="headerlink" title="å…¨éƒ¨ slave æ•…éšœçš„æƒ…å†µ"></a>å…¨éƒ¨ slave æ•…éšœçš„æƒ…å†µ</h3><p>åˆ†åˆ«ç™»é™† slave1 å’Œ slave2 çš„ mysqlï¼Œæ‰§è¡Œåœæ­¢å¤åˆ¶çš„å‘½ä»¤<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop slave;</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹ MaxScale æœåŠ¡å™¨çŠ¶æ€<br><img src="/images/maxscale_13.png" alt="Maxscale"></p>
<p>å‘ç°å„ä¸ªæœåŠ¡å™¨çš„è§’è‰²éƒ½è¯†åˆ«ä¸å‡ºæ¥äº†</p>
<p>æŸ¥çœ‹æ—¥å¿—<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2016-08-15 12:44:11   notice : Server changed state: master[172.17.0.2:3306]: lost_master</span><br><span class="line">2016-08-15 12:44:11   notice : Server changed state: slave1[172.17.0.3:3306]: lost_slave</span><br><span class="line">2016-08-15 12:44:11   notice : Server changed state: slave2[172.17.0.4:3306]: lost_slave</span><br><span class="line">2016-08-15 12:44:11   error  : No Master can be determined. Last known was 172.17.0.2:3306</span><br></pre></td></tr></table></figure></p>
<p>ä»æ—¥å¿—ä¸­çœ‹åˆ°ï¼ŒMaxScale å‘ç°2ä¸ªslave å’Œ master éƒ½ä¸¢äº†ï¼Œç„¶åæŠ¥é”™ï¼šæ²¡æœ‰ master äº†</p>
<p>å®¢æˆ·ç«¯è¿æ¥ MaxScale æ—¶ä¹Ÿå¤±è´¥äº†<br><img src="/images/maxscale_14.png" alt="Maxscale"></p>
<p>è¯´æ˜ä»æœåŠ¡å™¨å…¨éƒ¨å¤±æ•ˆåï¼Œä¼šå¯¼è‡´ master ä¹Ÿæ— æ³•è¯†åˆ«ï¼Œä½¿æ•´ä¸ªæ•°æ®åº“æœåŠ¡éƒ½å¤±æ•ˆäº†</p>
<p>å¯¹äº slave å…¨éƒ¨å¤±æ•ˆçš„æƒ…å†µï¼Œèƒ½å¦è®© master è¿˜å¯ç”¨ï¼Ÿè¿™æ ·è‡³å°‘å¯ä»¥æ­£å¸¸æä¾›æ•°æ®åº“æœåŠ¡</p>
<p>è¿™éœ€è¦ä¿®æ”¹ MaxScale çš„é…ç½®ï¼Œå‘Šè¯‰ MaxScale æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç¨³å®šçš„ master</p>
<h4 id="å¤„ç†è¿‡ç¨‹"><a href="#å¤„ç†è¿‡ç¨‹" class="headerlink" title="å¤„ç†è¿‡ç¨‹"></a>å¤„ç†è¿‡ç¨‹</h4><p>å…ˆæ¢å¤ä¸¤ä¸ª slaveï¼Œè®©é›†ç¾¤å›åˆ°æ­£å¸¸çŠ¶æ€ï¼Œç™»é™†ä¸¤ä¸ª slave çš„mysql<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure></p>
<p>ä¿®æ”¹ MaxScale é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ æ–°çš„é…ç½®<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/maxscale.cnf</span><br></pre></td></tr></table></figure></p>
<p>æ‰¾åˆ° [MySQL Monitor] éƒ¨åˆ†ï¼Œæ·»åŠ ï¼š<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">detect_stale_master</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p>ä¿å­˜é€€å‡ºï¼Œç„¶åé‡å¯ MaxScale</p>
<h4 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h4><p>åœæ‰ä¸¤å° slave ï¼ŒæŸ¥çœ‹ MaxScale æœåŠ¡å™¨çŠ¶æ€<br><img src="/images/maxscale_15.png" alt="Maxscale"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶ slave éƒ½æ— æ³•è¯†åˆ«äº†ï¼Œä½† master è¿˜åœ¨ï¼Œå¹¶æç¤ºå¤„äºç¨³å®šçŠ¶æ€</p>
<p>å®¢æˆ·ç«¯æ‰§è¡Œè¯·æ±‚<br><img src="/images/maxscale_16.png" alt="Maxscale"></p>
<p>å®¢æˆ·ç«¯å¯ä»¥è¿æ¥ MaxScaleï¼Œè€Œä¸”è¯·æ±‚éƒ½è½¬åˆ°äº† master ä¸Šï¼Œè¯´æ˜ slave å…¨éƒ¨å¤±æ•ˆæ—¶ï¼Œç”± master æ”¯æ’‘äº†å…¨éƒ¨è¯·æ±‚</p>
<p>å½“æ¢å¤ä¸¤ä¸ª slave åï¼Œæ•´ä½“çŠ¶æ€è‡ªåŠ¨æ¢å¤æ­£å¸¸ï¼Œä»å®¢æˆ·ç«¯æ‰§è¡Œè¯·æ±‚æ—¶ï¼Œåˆå¯ä»¥è½¬åˆ° slave ä¸Š<br><img src="/images/maxscale_17.png" alt="Maxscale"></p>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>é€šè¿‡æµ‹è¯•å‘ç°ï¼Œåœ¨éƒ¨åˆ† slave æ•…éšœæƒ…å†µä¸‹ï¼Œå¯¹äºå®¢æˆ·ç«¯æ˜¯å®Œå…¨é€æ˜çš„ï¼Œå½“å…¨éƒ¨ slave æ•…éšœæ—¶ï¼Œç»è¿‡ç®€å•çš„é…ç½®ï¼ŒMaxScale ä¹Ÿå¯ä»¥å¾ˆå¥½çš„å¤„ç†</p>
<hr>
<p>æ¥æºï¼šæœäº¦èˆ’</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Mysql è¯»å†™åˆ†ç¦»ä¸­é—´ä»¶ MaxScale]]></title>
      <url>http://team.jiunile.com/blog/2016/08/mysql-maxscale-01.html</url>
      <content type="html"><![CDATA[<h2 id="MaxScale-æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ"><a href="#MaxScale-æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ" class="headerlink" title="MaxScale æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ"></a>MaxScale æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ</h2><p>é…ç½®å¥½äº† Mysql çš„ä¸»ä»å¤åˆ¶ç»“æ„åï¼Œæˆ‘ä»¬å¸Œæœ›å®ç°è¯»å†™åˆ†ç¦»ï¼ŒæŠŠè¯»æ“ä½œåˆ†æ•£åˆ°ä»æœåŠ¡å™¨ä¸­ï¼Œå¹¶ä¸”å¯¹å¤šä¸ªä»æœåŠ¡å™¨èƒ½å®ç°è´Ÿè½½å‡è¡¡</p>
<p><strong>è¯»å†™åˆ†ç¦»</strong>å’Œ<strong>è´Ÿè½½å‡è¡¡</strong>æ˜¯ Mysql é›†ç¾¤çš„åŸºç¡€éœ€æ±‚ï¼Œ<strong>MaxScale</strong> å°±å¯ä»¥å¸®ç€æˆ‘ä»¬æ–¹ä¾¿çš„å®ç°è¿™äº›åŠŸèƒ½<br><img src="/images/maxscale_01.png" alt="Maxscale"></p>
<h2 id="MaxScale-çš„åŸºç¡€æ„æˆ"><a href="#MaxScale-çš„åŸºç¡€æ„æˆ" class="headerlink" title="MaxScale çš„åŸºç¡€æ„æˆ"></a>MaxScale çš„åŸºç¡€æ„æˆ</h2><ul>
<li>MaxScale æ˜¯ Mysql çš„å…„å¼Ÿå…¬å¸ MariaDB å¼€å‘çš„ï¼Œç°åœ¨å·²ç»å‘å±•å¾—éå¸¸æˆç†Ÿ</li>
<li>MaxScale æ˜¯æ’ä»¶å¼ç»“æ„ï¼Œå…è®¸ç”¨æˆ·å¼€å‘é€‚åˆè‡ªå·±çš„æ’ä»¶</li>
<li>MaxScale ç›®å‰æä¾›çš„æ’ä»¶åŠŸèƒ½åˆ†ä¸º<strong>5ç±»</strong></li>
</ul>
<h3 id="è®¤è¯æ’ä»¶"><a href="#è®¤è¯æ’ä»¶" class="headerlink" title="è®¤è¯æ’ä»¶"></a>è®¤è¯æ’ä»¶</h3><p>æä¾›äº†ç™»å½•è®¤è¯åŠŸèƒ½ï¼ŒMaxScale ä¼šè¯»å–å¹¶ç¼“å­˜æ•°æ®åº“ä¸­ user è¡¨ä¸­çš„ä¿¡æ¯ï¼Œå½“æœ‰è¿æ¥è¿›æ¥æ—¶ï¼Œå…ˆä»ç¼“å­˜ä¿¡æ¯ä¸­è¿›è¡ŒéªŒè¯ï¼Œå¦‚æœæ²¡æœ‰æ­¤ç”¨æˆ·ï¼Œä¼šä»åç«¯æ•°æ®åº“ä¸­æ›´æ–°ä¿¡æ¯ï¼Œå†æ¬¡è¿›è¡ŒéªŒè¯</p>
<h3 id="åè®®æ’ä»¶"><a href="#åè®®æ’ä»¶" class="headerlink" title="åè®®æ’ä»¶"></a>åè®®æ’ä»¶</h3><p>åŒ…æ‹¬å®¢æˆ·ç«¯è¿æ¥åè®®ï¼Œå’Œè¿æ¥æ•°æ®åº“çš„åè®®</p>
<h3 id="è·¯ç”±æ’ä»¶"><a href="#è·¯ç”±æ’ä»¶" class="headerlink" title="è·¯ç”±æ’ä»¶"></a>è·¯ç”±æ’ä»¶</h3><p>å†³å®šå¦‚ä½•æŠŠå®¢æˆ·ç«¯çš„è¯·æ±‚è½¬å‘ç»™åç«¯æ•°æ®åº“æœåŠ¡å™¨ï¼Œè¯»å†™åˆ†ç¦»å’Œè´Ÿè½½å‡è¡¡çš„åŠŸèƒ½å°±æ˜¯ç”±è¿™ä¸ªæ¨¡å—å®ç°çš„</p>
<h3 id="ç›‘æ§æ’ä»¶"><a href="#ç›‘æ§æ’ä»¶" class="headerlink" title="ç›‘æ§æ’ä»¶"></a>ç›‘æ§æ’ä»¶</h3><p>å¯¹å„ä¸ªæ•°æ®åº“æœåŠ¡å™¨è¿›è¡Œç›‘æ§ï¼Œä¾‹å¦‚å‘ç°æŸä¸ªæ•°æ®åº“æœåŠ¡å™¨å“åº”å¾ˆæ…¢ï¼Œé‚£ä¹ˆå°±ä¸å‘å…¶è½¬å‘è¯·æ±‚äº†</p>
<h3 id="æ—¥å¿—å’Œè¿‡æ»¤æ’ä»¶"><a href="#æ—¥å¿—å’Œè¿‡æ»¤æ’ä»¶" class="headerlink" title="æ—¥å¿—å’Œè¿‡æ»¤æ’ä»¶"></a>æ—¥å¿—å’Œè¿‡æ»¤æ’ä»¶</h3><p>æä¾›ç®€å•çš„æ•°æ®åº“é˜²ç«å¢™åŠŸèƒ½ï¼Œå¯ä»¥å¯¹SQLè¿›è¡Œè¿‡æ»¤å’Œå®¹é”™</p>
<a id="more"></a>
<h2 id="MaxScale-çš„å®‰è£…ä½¿ç”¨"><a href="#MaxScale-çš„å®‰è£…ä½¿ç”¨" class="headerlink" title="MaxScale çš„å®‰è£…ä½¿ç”¨"></a>MaxScale çš„å®‰è£…ä½¿ç”¨</h2><p>ä¾‹å¦‚æœ‰ 3 å°æ•°æ®åº“æœåŠ¡å™¨ï¼Œæ˜¯ä¸€ä¸»äºŒä»çš„ç»“æ„</p>
<h3 id="è¿‡ç¨‹æ¦‚è¿°"><a href="#è¿‡ç¨‹æ¦‚è¿°" class="headerlink" title="è¿‡ç¨‹æ¦‚è¿°"></a>è¿‡ç¨‹æ¦‚è¿°</h3><ol>
<li>é…ç½®å¥½é›†ç¾¤ç¯å¢ƒ</li>
<li>ä¸‹è½½å®‰è£… MaxScale</li>
<li>é…ç½® MaxScaleï¼Œæ·»åŠ å„æ•°æ®åº“ä¿¡æ¯</li>
<li>å¯åŠ¨ MaxScaleï¼ŒæŸ¥çœ‹æ˜¯å¦æ­£ç¡®è¿æ¥æ•°æ®åº“</li>
<li>å®¢æˆ·ç«¯è¿æ¥ MaxScaleï¼Œè¿›è¡Œæµ‹è¯•</li>
</ol>
<h3 id="è¯¦ç»†è¿‡ç¨‹"><a href="#è¯¦ç»†è¿‡ç¨‹" class="headerlink" title="è¯¦ç»†è¿‡ç¨‹"></a>è¯¦ç»†è¿‡ç¨‹</h3><h4 id="é…ç½®ä¸€ä¸»äºŒä»çš„é›†ç¾¤ç¯å¢ƒ"><a href="#é…ç½®ä¸€ä¸»äºŒä»çš„é›†ç¾¤ç¯å¢ƒ" class="headerlink" title="é…ç½®ä¸€ä¸»äºŒä»çš„é›†ç¾¤ç¯å¢ƒ"></a>é…ç½®ä¸€ä¸»äºŒä»çš„é›†ç¾¤ç¯å¢ƒ</h4><p>å‡†å¤‡3å°æœåŠ¡å™¨ï¼Œå®‰è£… Mysqlï¼Œé…ç½®ä¸€ä¸»äºŒä»çš„å¤åˆ¶ç»“æ„<br>ä¸»ä»å¤åˆ¶çš„é…ç½®è¿‡ç¨‹ç•¥è¿‡</p>
<h4 id="å®‰è£…-MaxScale"><a href="#å®‰è£…-MaxScale" class="headerlink" title="å®‰è£… MaxScale"></a>å®‰è£… MaxScale</h4><p>æœ€å¥½åœ¨å¦ä¸€å°æœåŠ¡å™¨ä¸Šå®‰è£…ï¼Œå¦‚æœèµ„æºä¸è¶³ï¼Œå¯ä»¥å’ŒæŸä¸ª Mysql æ”¾åœ¨ä¸€èµ·</p>
<p>MaxScale çš„ä¸‹è½½åœ°å€<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://downloads.mariadb.com/files/MaxScale</span><br></pre></td></tr></table></figure></p>
<p>æ ¹æ®è‡ªå·±çš„æœåŠ¡å™¨é€‰æ‹©åˆé€‚çš„å®‰è£…åŒ…</p>
<p>ä»¥ centos 7 ä¸ºä¾‹ å®‰è£…æ­¥éª¤å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install libaio.x86_64 libaio-devel.x86_64 novacom-server.x86_64 libedit -y</span><br><span class="line">rpm -ivh maxscale-1.4.3-1.centos.7.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<h4 id="é…ç½®-MaxScale"><a href="#é…ç½®-MaxScale" class="headerlink" title="é…ç½® MaxScale"></a>é…ç½® MaxScale</h4><p>åœ¨å¼€å§‹é…ç½®ä¹‹å‰ï¼Œéœ€è¦åœ¨ master ä¸­ä¸º MaxScale åˆ›å»ºä¸¤ä¸ªç”¨æˆ·ï¼Œç”¨äºç›‘æ§æ¨¡å—å’Œè·¯ç”±æ¨¡å—</p>
<p>åˆ›å»ºç›‘æ§ç”¨æˆ·<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user scalemon@'%' identified by "111111";</span><br><span class="line">mysql&gt; grant replication slave, replication client on *.* to scalemon@'%';</span><br></pre></td></tr></table></figure></p>
<p>åˆ›å»ºè·¯ç”±ç”¨æˆ·<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user maxscale@'%' identified by "111111";</span><br><span class="line">mysql&gt; grant select on mysql.* to maxscale@'%';</span><br></pre></td></tr></table></figure></p>
<p>ç”¨æˆ·åˆ›å»ºå®Œæˆåï¼Œå¼€å§‹é…ç½®<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/maxscale.cnf</span><br></pre></td></tr></table></figure></p>
<p>æ‰¾åˆ° [server1] éƒ¨åˆ†ï¼Œä¿®æ”¹å…¶ä¸­çš„ address å’Œ portï¼ŒæŒ‡å‘ master çš„ IP å’Œç«¯å£</p>
<p>å¤åˆ¶2æ¬¡ [server1] çš„æ•´å—å„¿å†…å®¹ï¼Œæ”¹ä¸º [server2] ä¸ [server3]ï¼ŒåŒæ ·ä¿®æ”¹å…¶ä¸­çš„ address å’Œ portï¼Œåˆ†åˆ«æŒ‡å‘ slave1 å’Œ slave2<br><img src="/images/maxscale_02.png" alt="Maxscale"></p>
<p>æ‰¾åˆ° <code>[MySQL Monitor]</code> éƒ¨åˆ†ï¼Œä¿®æ”¹ servers ä¸º server1,server2,server3ï¼Œä¿®æ”¹ user å’Œ passwd ä¸ºä¹‹å‰åˆ›å»ºçš„ç›‘æ§ç”¨æˆ·çš„ä¿¡æ¯ï¼ˆscalemon,111111ï¼‰<br><img src="/images/maxscale_03.png" alt="Maxscale"></p>
<p>æ‰¾åˆ° <code>[Read-Write Service]</code> éƒ¨åˆ†ï¼Œä¿®æ”¹ servers ä¸º server1,server2,server3ï¼Œä¿®æ”¹ user å’Œ passwd ä¸ºä¹‹å‰åˆ›å»ºçš„è·¯ç”±ç”¨æˆ·çš„ä¿¡æ¯ï¼ˆmaxscale,111111ï¼‰<br><img src="/images/maxscale_04.png" alt="Maxscale"></p>
<p>ç”±äºæˆ‘ä»¬ä½¿ç”¨äº† <code>[Read-Write Service]</code>ï¼Œéœ€è¦åˆ é™¤å¦ä¸€ä¸ªæœåŠ¡ <code>[Read-Only Service]</code>ï¼Œåˆ é™¤å…¶æ•´å—å„¿å†…å®¹å³å¯</p>
<p>é…ç½®å®Œæˆï¼Œä¿å­˜å¹¶é€€å‡ºç¼–è¾‘å™¨</p>
<h4 id="å¯åŠ¨-MaxScale"><a href="#å¯åŠ¨-MaxScale" class="headerlink" title="å¯åŠ¨ MaxScale"></a>å¯åŠ¨ MaxScale</h4><p>æ‰§è¡Œå¯åŠ¨å‘½ä»¤<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maxscale --config=/etc/maxscale.cnf</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹ MaxScale çš„å“åº”ç«¯å£æ˜¯å¦å·²ç»å°±ç»ª<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ntelp</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/maxscale_05.png" alt="Maxscale"></p>
<ul>
<li>4006 æ˜¯è¿æ¥ MaxScale æ—¶ä½¿ç”¨çš„ç«¯å£</li>
<li>6603 æ˜¯ MaxScale ç®¡ç†å™¨çš„ç«¯å£</li>
</ul>
<p>ç™»å½• MaxScale ç®¡ç†å™¨ï¼ŒæŸ¥çœ‹ä¸€ä¸‹æ•°æ®åº“è¿æ¥çŠ¶æ€ï¼Œé»˜è®¤çš„ç”¨æˆ·åå’Œå¯†ç æ˜¯ admin/mariadb<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">maxadmin --user=admin --password=mariadb</span><br><span class="line">MaxScale&gt; list servers</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/maxscale_06.png" alt="Maxscale"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒMaxScale å·²ç»è¿æ¥åˆ°äº† master å’Œ slave</p>
<h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><p>å…ˆåœ¨ master ä¸Šåˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨æˆ·<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant ALL PRIVILEGES on *.* to rtest@"%" Identified by "111111";</span><br></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨ Mysql å®¢æˆ·ç«¯åˆ°è¿æ¥ MaxScale<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h MaxScaleæ‰€åœ¨çš„IP -P 4006 -u rtest -p111111</span><br></pre></td></tr></table></figure></p>
<p>æ‰§è¡ŒæŸ¥çœ‹æ•°æ®åº“æœåŠ¡å™¨åçš„æ“ä½œæ¥çŸ¥é“å½“å‰å®é™…æ‰€åœ¨çš„æ•°æ®åº“<br><img src="/images/maxscale_07.png" alt="Maxscale"></p>
<p>å¼€å¯äº‹åŠ¡åï¼Œå°±è‡ªåŠ¨è·¯ç”±åˆ°äº† masterï¼Œæ™®é€šçš„æŸ¥è¯¢æ“ä½œï¼Œæ˜¯åœ¨ slaveä¸Š</p>
<p>MaxScale çš„é…ç½®å®Œæˆäº†</p>
<hr>
<p>æ¥æºï¼šæœäº¦èˆ’</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[åŒæœºé«˜å¯ç”¨-è´Ÿè½½å‡è¡¡-MySQL(è¯»å†™åˆ†ç¦»ã€ä¸»ä»è‡ªåŠ¨åˆ‡æ¢)æ¶æ„è®¾è®¡]]></title>
      <url>http://team.jiunile.com/blog/2016/08/ha-load-balance-mysql-master-slave-architecture.html</url>
      <content type="html"><![CDATA[<h2 id="æ¶æ„ç®€ä»‹"><a href="#æ¶æ„ç®€ä»‹" class="headerlink" title="æ¶æ„ç®€ä»‹"></a>æ¶æ„ç®€ä»‹</h2><p>åªæœ‰ä¸¤å°æœºå™¨ï¼Œéœ€è¦å®ç°å…¶ä¸­ä¸€å°æ­»æœºä¹‹åå¦ä¸€å°èƒ½æ¥ç®¡è¿™å°æœºå™¨çš„æœåŠ¡ï¼Œå¹¶ä¸”åœ¨ä¸¤å°æœºå™¨æ­£å¸¸æœåŠ¡æ—¶ï¼Œä¸¤å°æœºå™¨éƒ½èƒ½ç”¨ä¸Šã€‚å¦‚ä½•è®¾è®¡è¿™æ ·çš„æ¶æ„åœºæ™¯ã€‚<br><img src="/images/high_availability.png" alt="High Availability"></p>
<p>æ­¤æ¶æ„ä¸»è¦æ˜¯ç”±keepalivedå®ç°åŒæœºé«˜å¯ç”¨ï¼Œç»´æŠ¤äº†ä¸€ä¸ªå¤–ç½‘VIPï¼Œä¸€ä¸ªå†…ç½‘VIPã€‚æ­£å¸¸æƒ…å†µæ—¶ï¼Œå¤–ç½‘VIPå’Œå†…ç½‘VIPéƒ½ç»‘å®šåœ¨server1æœåŠ¡å™¨ï¼Œwebè¯·æ±‚å‘é€åˆ°server1çš„nginxï¼Œnginxå¯¹äºé™æ€èµ„æºè¯·æ±‚å°±ç›´æ¥åœ¨æœ¬æœºæ£€ç´¢å¹¶è¿”å›ï¼Œå¯¹äºphpçš„åŠ¨æ€è¯·æ±‚ï¼Œåˆ™è´Ÿè½½å‡è¡¡åˆ°server1å’Œserver2ã€‚å¯¹äºSQLè¯·æ±‚ï¼Œä¼šå°†æ­¤ç±»è¯·æ±‚å‘é€åˆ°Atlas MySQLä¸­é—´ä»¶ï¼ŒAtlasæ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼ŒæŠŠæ¶‰åŠå†™æ“ä½œçš„è¯·æ±‚å‘é€åˆ°å†…ç½‘VIPï¼Œè¯»è¯·æ±‚æ“ä½œå‘é€åˆ°mysqlä»ï¼Œè¿™æ ·å°±å®ç°äº†è¯»å†™åˆ†ç¦»ã€‚</p>
<p>å½“ä¸»æœåŠ¡å™¨server1å®•æœºæ—¶ï¼Œkeepalivedæ£€æµ‹åˆ°åï¼Œç«‹å³æŠŠå¤–ç½‘VIPå’Œå†…ç½‘VIPç»‘å®šåˆ°server2ï¼Œå¹¶æŠŠserver2çš„mysqlåˆ‡æ¢æˆä¸»åº“ã€‚æ­¤æ—¶ç”±äºå¤–ç½‘VIPå·²ç»è½¬ç§»åˆ°äº†server2ï¼Œwebè¯·æ±‚å°†å‘é€ç»™server2çš„nginxã€‚nginxæ£€æµ‹åˆ°server1å®•æœºï¼Œä¸å†æŠŠè¯·æ±‚è½¬å‘åˆ°server1çš„php-fpmã€‚ä¹‹åçš„sqlè¯·æ±‚ç…§å¸¸å‘é€ç»™æœ¬åœ°çš„atlasï¼ŒatlasæŠŠå†™æ“ä½œå‘é€ç»™å†…ç½‘VIPï¼Œè¯»æ“ä½œå‘é€ç»™mysqlä»ï¼Œç”±äºå†…ç½‘VIPå·²ç»ç»‘å®šåˆ°server2äº†ï¼Œserver2çš„mysqlåŒæ—¶æ¥å—å†™æ“ä½œå’Œè¯»æ“ä½œã€‚</p>
<p>å½“ä¸»æœåŠ¡å™¨server1æ¢å¤åï¼Œserver1çš„mysqlè‡ªåŠ¨è®¾ç½®ä¸ºä»ï¼Œä¸server2çš„mysqlä¸»åŒæ­¥ã€‚keepalivedä¸æŠ¢å server2çš„VIPï¼Œç»§ç»­æ­£å¸¸æœåŠ¡ã€‚</p>
<h2 id="æ¶æ„è¦æ±‚"><a href="#æ¶æ„è¦æ±‚" class="headerlink" title="æ¶æ„è¦æ±‚"></a>æ¶æ„è¦æ±‚</h2><p>è¦å®ç°æ­¤æ¶æ„ï¼Œéœ€è¦ä¸‰ä¸ªæ¡ä»¶ï¼š</p>
<ol>
<li>æœåŠ¡å™¨å¯ä»¥è®¾ç½®å†…ç½‘IPï¼Œå¹¶ä¸”è®¾ç½®çš„å†…ç½‘IPäº’é€šã€‚</li>
<li>æœåŠ¡å™¨å¯ä»¥éšæ„ç»‘å®šIDCåˆ†é…ç»™æˆ‘ä»¬ä½¿ç”¨çš„å¤–ç½‘IPï¼Œå³å¤–ç½‘IPæ²¡æœ‰ç»‘å®šMACåœ°å€ã€‚</li>
<li>MySQLæœåŠ¡å™¨æ”¯æŒGTIDï¼Œå³MySQL-5.6.5ä»¥ä¸Šç‰ˆæœ¬ã€‚</li>
</ol>
<h2 id="ç¯å¢ƒè¯´æ˜"><a href="#ç¯å¢ƒè¯´æ˜" class="headerlink" title="ç¯å¢ƒè¯´æ˜"></a>ç¯å¢ƒè¯´æ˜</h2><blockquote>
<p><strong>å¯¹å¤–VIP</strong>ï¼š10.96.153.239<br><strong>å¯¹å†…VIP</strong>ï¼š192.168.1.150</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">æè¿°</th>
<th style="text-align:left">ç½‘å¡1ï¼šeth0(å…¬ç½‘IP)</th>
<th style="text-align:left">ç½‘å¡2ï¼šeth1(å†…ç½‘IP)</th>
<th style="text-align:left">æ“ä½œç³»ç»Ÿ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">server1</td>
<td style="text-align:left">10.96.153.110</td>
<td style="text-align:left">192.168.1.100</td>
<td style="text-align:left">Centos 6.X</td>
</tr>
<tr>
<td style="text-align:left">server2</td>
<td style="text-align:left">10.96.153.114</td>
<td style="text-align:left">192.168.1.101</td>
<td style="text-align:left">Centos 6.X</td>
</tr>
</tbody>
</table>
<h2 id="æ¶æ„é…ç½®"><a href="#æ¶æ„é…ç½®" class="headerlink" title="æ¶æ„é…ç½®"></a>æ¶æ„é…ç½®</h2><a id="more"></a>
<h3 id="hostsè®¾ç½®"><a href="#hostsè®¾ç½®" class="headerlink" title="hostsè®¾ç½®"></a>hostsè®¾ç½®</h3><p>Server1ä¸Server2 hostsè®¾ç½®å¦‚ä¸‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/hosts</span></span><br><span class="line">192.168.1.100 server1</span><br><span class="line">192.168.1.101 server2</span><br></pre></td></tr></table></figure></p>
<h3 id="è½¯ä»¶å®‰è£…"><a href="#è½¯ä»¶å®‰è£…" class="headerlink" title="è½¯ä»¶å®‰è£…"></a>è½¯ä»¶å®‰è£…</h3><p>Nginxã€PHPã€MySQLã€Memcachedå®‰è£…ç•¥</p>
<h3 id="è§£å†³sessionå…±äº«é—®é¢˜"><a href="#è§£å†³sessionå…±äº«é—®é¢˜" class="headerlink" title="è§£å†³sessionå…±äº«é—®é¢˜"></a>è§£å†³sessionå…±äº«é—®é¢˜</h3><p>phpé»˜è®¤çš„sessionå­˜å‚¨æ˜¯åœ¨/tmpç›®å½•ä¸‹ï¼Œç°åœ¨æˆ‘ä»¬æ˜¯ç”¨ä¸¤å°æœåŠ¡å™¨ä½œphpè¯·æ±‚çš„è´Ÿè½½ï¼Œè¿™æ ·ä¼šé€ æˆsessionåˆ†å¸ƒåœ¨ä¸¤å°æœåŠ¡å™¨çš„/tmpç›®å½•ä¸‹ï¼Œå¯¼è‡´ä¾èµ–äºsessionçš„åŠŸèƒ½ä¸æ­£å¸¸ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨memcachedæ¥è§£å†³æ­¤é—®é¢˜ã€‚</p>
<p>ä¸Šä¸€æ­¥æˆ‘ä»¬å·²ç»å®‰è£…å¥½äº†memcachedï¼Œç°åœ¨åªéœ€è¦é…ç½®php.iniæ¥ä½¿ç”¨memcachedï¼Œé…ç½®å¦‚ä¸‹ï¼Œæ‰“å¼€php.inié…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹ä¸ºå¦‚ä¸‹ä¸¤è¡Œçš„å€¼ï¼š<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session.save_handler = memcache</span><br><span class="line">session.save_path = "tcp://192.168.1.100:11211,tcp://192.168.1.101:11211"</span><br></pre></td></tr></table></figure></p>
<p>ä¹‹åé‡å¯php-fpmç”Ÿæ•ˆã€‚</p>
<h3 id="Nginxé…ç½®"><a href="#Nginxé…ç½®" class="headerlink" title="Nginxé…ç½®"></a>Nginxé…ç½®</h3><h4 id="Server1é…ç½®"><a href="#Server1é…ç½®" class="headerlink" title="Server1é…ç½®"></a>Server1é…ç½®</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    [...]</span><br><span class="line">    upstream php-server &#123;</span><br><span class="line">        server 192.168.1.101:9000;</span><br><span class="line">        server 127.0.0.1:9000;</span><br><span class="line">        keepalive 100;</span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">    server &#123;</span><br><span class="line">        [...]</span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">            fastcgi_pass   php-server;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">        [...]</span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Server2é…ç½®"><a href="#Server2é…ç½®" class="headerlink" title="Server2é…ç½®"></a>Server2é…ç½®</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    [...]</span><br><span class="line">    upstream php-server &#123;</span><br><span class="line">        server 192.168.1.100:9000;</span><br><span class="line">        server 127.0.0.1:9000;</span><br><span class="line">        keepalive 100;</span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">    server &#123;</span><br><span class="line">        [...]</span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">            fastcgi_pass   php-server;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">        [...]</span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸¤ä¸ªé…ç½®ä¸»è¦çš„ä½œç”¨æ˜¯è®¾ç½®phpè¯·æ±‚çš„è´Ÿè½½å‡è¡¡ã€‚</p>
<h3 id="MySQLé…ç½®"><a href="#MySQLé…ç½®" class="headerlink" title="MySQLé…ç½®"></a>MySQLé…ç½®</h3><h4 id="mysql-utilå®‰è£…"><a href="#mysql-utilå®‰è£…" class="headerlink" title="mysql utilå®‰è£…"></a>mysql utilå®‰è£…</h4><p>æˆ‘ä»¬éœ€è¦å®‰è£…mysql utilé‡Œçš„ä¸»ä»é…ç½®å·¥å…·æ¥å®ç°ä¸»ä»åˆ‡æ¢ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">wget http://dev.mysql.com/get/Downloads/MySQLGUITools/mysql-utilities-1.5.3.tar.gz</span><br><span class="line">tar xzf mysql-utilities-1.5.3.tar.gz</span><br><span class="line"><span class="built_in">cd</span> mysql-utilities-1.5.3</span><br><span class="line">python setup.py build</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure></p>
<h4 id="mysql-my-cnfé…ç½®"><a href="#mysql-my-cnfé…ç½®" class="headerlink" title="mysql my.cnfé…ç½®"></a>mysql my.cnfé…ç½®</h4><p><strong>server1ï¼š</strong><br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="section">[...]</span></span><br><span class="line"><span class="attr">protocol</span> = tcp</span><br><span class="line"><span class="section">[...]</span></span><br><span class="line"><span class="section">[...]</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="section">[...]</span></span><br><span class="line"><span class="comment"># BINARY LOGGING</span></span><br><span class="line"><span class="attr">log-bin</span> = /usr/local/mysql/data/mysql-bin</span><br><span class="line"><span class="attr">expire-logs-days</span> = <span class="number">14</span></span><br><span class="line"><span class="attr">binlog-format</span> = row</span><br><span class="line"><span class="attr">log-slave-updates</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">gtid-mode</span> = <span class="literal">on</span></span><br><span class="line"><span class="attr">enforce-gtid-consistency</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">master-info-repository</span> = TABLE</span><br><span class="line"><span class="attr">relay-log-info-repository</span> = TABLE</span><br><span class="line"><span class="attr">server-id</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">report-host</span> = server1</span><br><span class="line"><span class="attr">report-port</span> = <span class="number">3306</span></span><br><span class="line"><span class="section">[...]</span></span><br></pre></td></tr></table></figure></p>
<p><strong>server2ï¼š</strong><br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="section">[...]</span></span><br><span class="line"><span class="attr">protocol</span> = tcp</span><br><span class="line"><span class="section">[...]</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="section">[...]</span></span><br><span class="line"><span class="comment"># BINARY LOGGING</span></span><br><span class="line"><span class="attr">log-bin</span> = /usr/local/mysql/data/mysql-bin</span><br><span class="line"><span class="attr">expire-logs-days</span> = <span class="number">14</span></span><br><span class="line"><span class="attr">binlog-format</span> = row</span><br><span class="line"><span class="attr">log-slave-updates</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">gtid-mode</span> = <span class="literal">on</span></span><br><span class="line"><span class="attr">enforce-gtid-consistency</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">master-info-repository</span> = TABLE</span><br><span class="line"><span class="attr">relay-log-info-repository</span> = TABLE</span><br><span class="line"><span class="attr">server-id</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">report-host</span> = server2</span><br><span class="line"><span class="attr">report-port</span> = <span class="number">3306</span></span><br><span class="line"><span class="section">[...]</span></span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸¤ä¸ªé…ç½®ä¸»è¦æ˜¯è®¾ç½®äº†binlogå’Œå¯ç”¨gtid-modeï¼Œå¹¶ä¸”éœ€è¦è®¾ç½®ä¸åŒçš„server-idå’Œreport-hostã€‚</p>
<h4 id="å¼€æ”¾rootå¸å·è¿œç¨‹æƒé™"><a href="#å¼€æ”¾rootå¸å·è¿œç¨‹æƒé™" class="headerlink" title="å¼€æ”¾rootå¸å·è¿œç¨‹æƒé™"></a>å¼€æ”¾rootå¸å·è¿œç¨‹æƒé™</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant all on *.* to 'root'@'192.168.1.%' identified by 'Xp29at5F37' with grant option;</span><br><span class="line">mysql&gt; grant all on *.* to 'root'@'server1' identified by 'Xp29at5F37' with grant option;</span><br><span class="line">mysql&gt; grant all on *.* to 'root'@'server2' identified by 'Xp29at5F37' with grant option;</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure>
<h4 id="è®¾ç½®mysqlä¸»ä»"><a href="#è®¾ç½®mysqlä¸»ä»" class="headerlink" title="è®¾ç½®mysqlä¸»ä»"></a>è®¾ç½®mysqlä¸»ä»</h4><p>åœ¨ä»»æ„ä¸€å°æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysqlreplicate --master=root:Xp29at5F37@server1:3306 --slave=root:Xp29at5F37@server2:3306 --rpl-user=rpl:o67DhtaW</span><br><span class="line"></span><br><span class="line"><span class="comment"># master on server1: â€¦ connected.</span></span><br><span class="line"><span class="comment"># slave on server2: â€¦ connected.</span></span><br><span class="line"><span class="comment"># Checking for binary logging on masterâ€¦</span></span><br><span class="line"><span class="comment"># Setting up replicationâ€¦</span></span><br><span class="line"><span class="comment"># â€¦done.</span></span><br></pre></td></tr></table></figure></p>
<h4 id="æ˜¾ç¤ºä¸»ä»å…³ç³»"><a href="#æ˜¾ç¤ºä¸»ä»å…³ç³»" class="headerlink" title="æ˜¾ç¤ºä¸»ä»å…³ç³»"></a>æ˜¾ç¤ºä¸»ä»å…³ç³»</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysqlrplshow --master=root:Xp29at5F37@server1 --discover-slaves-login=root:Xp29at5F37</span><br><span class="line"></span><br><span class="line"><span class="comment"># master on server1: â€¦ connected.</span></span><br><span class="line"><span class="comment"># Finding slaves for master: server1:3306</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Replication Topology Graph</span></span><br><span class="line">server1:3306 (MASTER)</span><br><span class="line">|</span><br><span class="line">+â€” server2:3306 â€“ (SLAVE)</span><br></pre></td></tr></table></figure>
<h4 id="æ£€æŸ¥ä¸»ä»çŠ¶æ€"><a href="#æ£€æŸ¥ä¸»ä»çŠ¶æ€" class="headerlink" title="æ£€æŸ¥ä¸»ä»çŠ¶æ€"></a>æ£€æŸ¥ä¸»ä»çŠ¶æ€</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysqlrplcheck --master=root:Xp29at5F37@server1 --slave=root:Xp29at5F37@server2</span><br><span class="line"></span><br><span class="line"><span class="comment"># master on server1: â€¦ connected.</span></span><br><span class="line"><span class="comment"># slave on server2: â€¦ connected.</span></span><br><span class="line">Test Description Status</span><br><span class="line">â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span><br><span class="line">Checking <span class="keyword">for</span> binary logging on master [pass]</span><br><span class="line">Are there binlog exceptions? [pass]</span><br><span class="line">Replication user exists? [pass]</span><br><span class="line">Checking server_id values [pass]</span><br><span class="line">Checking server_uuid values [pass]</span><br><span class="line">Is slave connected to master? [pass]</span><br><span class="line">Check master information file [pass]</span><br><span class="line">Checking InnoDB compatibility [pass]</span><br><span class="line">Checking storage engines compatibility [pass]</span><br><span class="line">Checking lower_<span class="keyword">case</span>_table_names settings [pass]</span><br><span class="line">Checking slave delay (seconds behind master) [pass]</span><br><span class="line"><span class="comment"># â€¦done.</span></span><br></pre></td></tr></table></figure>
<h3 id="Keepalivedé…ç½®"><a href="#Keepalivedé…ç½®" class="headerlink" title="Keepalivedé…ç½®"></a>Keepalivedé…ç½®</h3><h4 id="å®‰è£…-ä¸¤å°éƒ½è£…"><a href="#å®‰è£…-ä¸¤å°éƒ½è£…" class="headerlink" title="å®‰è£…(ä¸¤å°éƒ½è£…)"></a>å®‰è£…(ä¸¤å°éƒ½è£…)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install keepalived</span><br><span class="line">chkconfig keepalived on</span><br></pre></td></tr></table></figure>
<h4 id="keepalivedé…ç½®-server1"><a href="#keepalivedé…ç½®-server1" class="headerlink" title="keepalivedé…ç½®(server1)"></a>keepalivedé…ç½®(server1)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">vrrp_sync_group VG_1 &#123;</span><br><span class="line">	group &#123;</span><br><span class="line">		inside_network</span><br><span class="line">		outside_network</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">vrrp_instance inside_network &#123;</span><br><span class="line">	state BACKUP</span><br><span class="line">	interface eth1</span><br><span class="line">	virtual_router_id 51</span><br><span class="line">	priority 101</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_<span class="built_in">type</span> PASS</span><br><span class="line">		auth_pass 3489</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		192.168.1.150/24</span><br><span class="line">	&#125;</span><br><span class="line">	nopreempt</span><br><span class="line">	notify /data/sh/mysqlfailover-server1.sh</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">vrrp_instance outside_network &#123;</span><br><span class="line">	state BACKUP</span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 50</span><br><span class="line">	priority 101</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">	auth_<span class="built_in">type</span> PASS</span><br><span class="line">	auth_pass 3489</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.96.153.239/24</span><br><span class="line">	&#125;</span><br><span class="line">	nopreempt</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="keepalivedé…ç½®-server2"><a href="#keepalivedé…ç½®-server2" class="headerlink" title="keepalivedé…ç½®(server2)"></a>keepalivedé…ç½®(server2)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">vrrp_sync_group VG_1 &#123;</span><br><span class="line">	group &#123;</span><br><span class="line">		inside_network</span><br><span class="line">		outside_network</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">vrrp_instance inside_network &#123;</span><br><span class="line">	state BACKUP</span><br><span class="line">	interface eth1</span><br><span class="line">	virtual_router_id 51</span><br><span class="line">	priority 100</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_<span class="built_in">type</span> PASS</span><br><span class="line">		auth_pass 3489</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		192.168.1.150</span><br><span class="line">	&#125;</span><br><span class="line">	notify /data/sh/mysqlfailover-server2.sh</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">vrrp_instance outside_network &#123;</span><br><span class="line">	state BACKUP</span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 50</span><br><span class="line">	priority 100</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_<span class="built_in">type</span> PASS</span><br><span class="line">		auth_pass 3489</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.96.153.239/24</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤keepalivedé…ç½®éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<ol>
<li>ä¸¤å°serverçš„stateéƒ½è®¾ç½®ä¸ºbackupï¼Œserver1å¢åŠ nopreempté…ç½®ï¼Œå¹¶ä¸”server1 priorityæ¯”server2é«˜ï¼Œè¿™æ ·ç”¨æ¥å®ç°å½“server1ä»å®•æœºæ¢å¤æ—¶ï¼Œä¸æŠ¢å VIP;</li>
<li>server1è®¾ç½®notify /data/sh/mysqlfailover-server1.sh,server2è®¾ç½®notify /data/sh/mysqlfailover-server2.sh,ä½œç”¨æ˜¯è‡ªåŠ¨åˆ‡æ¢ä¸»ä»</li>
</ol>
<p>/data/sh/mysqlfailover-server1.shè„šæœ¬å†…å®¹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span><br><span class="line"> </span></span><br><span class="line">sleep 10</span><br><span class="line">state=<span class="variable">$3</span></span><br><span class="line">result=`mysql -h127.0.0.1 -P3306 -uroot -pXp29at5F37 <span class="_">-e</span> <span class="string">'show slave status;'</span>`</span><br><span class="line">[[ <span class="string">"<span class="variable">$result</span>"</span> == <span class="string">""</span> ]] &amp;&amp; mysqlState=<span class="string">"master"</span> || mysqlState=<span class="string">"slave"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$state</span>"</span> == <span class="string">"MASTER"</span> ]];<span class="keyword">then</span></span><br><span class="line">	<span class="keyword">if</span> [[ <span class="string">"<span class="variable">$mysqlState</span>"</span> == <span class="string">"slave"</span> ]];<span class="keyword">then</span></span><br><span class="line">		mysqlrpladmin --slave=root:Xp29at5F37@server1:3306 failover</span><br><span class="line">	<span class="keyword">fi</span> </span><br><span class="line"><span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$state</span>"</span> == <span class="string">"BACKUP"</span> ]];<span class="keyword">then</span></span><br><span class="line">	<span class="keyword">if</span> [[ <span class="string">"<span class="variable">$mysqlState</span>"</span> == <span class="string">"master"</span> ]];<span class="keyword">then</span></span><br><span class="line">		mysqlreplicate --master=root:Xp29at5F37@server2:3306 --slave=root:Xp29at5F37@server1:3306 --rpl-user=rpl:o67DhtaW</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'s/proxy-read-only-backend-addresses.*/proxy-read-only-backend-addresses = 192.168.1.150:3306/'</span> /usr/<span class="built_in">local</span>/mysql-proxy/conf/my.cnf</span><br><span class="line">mysql -h127.0.0.1 -P2345 -uuser -ppwd <span class="_">-e</span> <span class="string">"REMOVE BACKEND 2;"</span></span><br></pre></td></tr></table></figure></p>
<p>/data/sh/mysqlfailover-server2.shè„šæœ¬å†…å®¹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span><br><span class="line"></span></span><br><span class="line">sleep 10</span><br><span class="line">state=<span class="variable">$3</span></span><br><span class="line">result=`mysql -h127.0.0.1 -P3306 -uroot -pXp29at5F37 <span class="_">-e</span> <span class="string">'show slave status;'</span>`</span><br><span class="line">[[ <span class="string">"<span class="variable">$result</span>"</span> == <span class="string">""</span> ]] &amp;&amp; mysqlState=<span class="string">"master"</span> || mysqlState=<span class="string">"slave"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$state</span>"</span> == <span class="string">"MASTER"</span> ]];<span class="keyword">then</span></span><br><span class="line">	<span class="keyword">if</span> [[ <span class="string">"<span class="variable">$mysqlState</span>"</span> == <span class="string">"slave"</span> ]];<span class="keyword">then</span></span><br><span class="line">		mysqlrpladmin --slave=root:Xp29at5F37@server2:3306 failover</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$state</span>"</span> == <span class="string">"BACKUP"</span> ]];<span class="keyword">then</span></span><br><span class="line">	<span class="keyword">if</span> [[ <span class="string">"<span class="variable">$mysqlState</span>"</span> == <span class="string">"master"</span> ]];<span class="keyword">then</span></span><br><span class="line">		mysqlreplicate --master=root:Xp29at5F37@server1:3306 --slave=root:Xp29at5F37@server2:3306 --rpl-user=rpl:o67DhtaW</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'s/proxy-read-only-backend-addresses.*/proxy-read-only-backend-addresses = 192.168.1.150:3306/'</span> /usr/<span class="built_in">local</span>/mysql-proxy/conf/my.cnf</span><br><span class="line">mysql -h127.0.0.1 -P2345 -uuser -ppwd <span class="_">-e</span> <span class="string">"REMOVE BACKEND 2;"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Atlasè®¾ç½®"><a href="#Atlasè®¾ç½®" class="headerlink" title="Atlasè®¾ç½®"></a>Atlasè®¾ç½®</h3><h4 id="atlaså®‰è£…ï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰"><a href="#atlaså®‰è£…ï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰" class="headerlink" title="atlaså®‰è£…ï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰"></a>atlaså®‰è£…ï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰</h4><p>åˆ°è¿™é‡Œä¸‹è½½æœ€æ–°ç‰ˆæœ¬ï¼Œ<a href="https://github.com/Qihoo360/Atlas/releases" target="_blank" rel="external">https://github.com/Qihoo360/Atlas/releases</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">wget https://github.com/Qihoo360/Atlas/releases/download/2.2.1/Atlas-2.2.1.el6.x86_64.rpm</span><br><span class="line">rpm -i Atlas-2.2.1.el6.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<h4 id="atlasé…ç½®ï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰"><a href="#atlasé…ç½®ï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰" class="headerlink" title="atlasé…ç½®ï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰"></a>atlasé…ç½®ï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/mysql-proxy/conf</span><br><span class="line">cp test.cnf my.cnf</span><br><span class="line">vi my.cnf</span><br><span class="line">#è°ƒæ•´å¦‚ä¸‹å‚æ•°</span><br><span class="line">proxy-backend-addresses = 192.168.1.150:3306</span><br><span class="line">proxy-read-only-backend-addresses = 192.168.1.101:3306</span><br><span class="line">pwds = root:qtyU1btXOo074Itvx0UR9Q==</span><br><span class="line">event-threads = 8</span><br></pre></td></tr></table></figure>
<p><strong><code>æ³¨æ„</code></strong>ï¼š</p>
<ul>
<li>proxy-backend-addresseè®¾ç½®ä¸ºå†…ç½‘VIP</li>
<li>proxy-read-only-backend-addressesè®¾ç½®ä¸ºserver2çš„IP</li>
<li>root:qtyU1btXOo074Itvx0UR9Q==è®¾ç½®æ•°æ®åº“çš„ç”¨æˆ·å’Œå¯†ç ï¼Œå¯†ç æ˜¯é€šè¿‡/usr/local/mysql-proxy/bin/encrypt Xp29at5F37ç”Ÿæˆã€‚</li>
<li>æ›´è¯¦ç»†å‚æ•°è§£é‡Šè¯·æŸ¥çœ‹ï¼Œ<a href="https://github.com/Qihoo360/Atlas/wiki/Atlas%E9%83%A8%E5%88%86%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3" target="_blank" rel="external">Atlasé…ç½®è¯¦è§£</a>ã€‚</li>
</ul>
<h4 id="å¯åŠ¨atlasï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰"><a href="#å¯åŠ¨atlasï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰" class="headerlink" title="å¯åŠ¨atlasï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰"></a>å¯åŠ¨atlasï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/mysql-proxy/bin/mysql-proxy --defaults-file=/usr/<span class="built_in">local</span>/mysql-proxy/conf/my.cnf</span><br></pre></td></tr></table></figure>
<p>ä¹‹åç¨‹åºé‡Œé…ç½®mysqlå°±é…ç½®127.0.0.1:1234å°±å¥½ã€‚</p>
<h4 id="éƒ¨ç½²atlasè‡ªåŠ¨ç»´æŠ¤è„šæœ¬ï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰"><a href="#éƒ¨ç½²atlasè‡ªåŠ¨ç»´æŠ¤è„šæœ¬ï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰" class="headerlink" title="éƒ¨ç½²atlasè‡ªåŠ¨ç»´æŠ¤è„šæœ¬ï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰"></a>éƒ¨ç½²atlasè‡ªåŠ¨ç»´æŠ¤è„šæœ¬ï¼ˆä¸¤å°æœåŠ¡å™¨ï¼‰</h4><p>æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚æ¯2åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼‰æˆ‘ä»¬æŠŠè„šæœ¬æ”¾åœ¨/data/sh/auto_maintain_atlas.sh,è„šæœ¬å†…å®¹ä¸ºï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span><br><span class="line"> </span></span><br><span class="line">count=`mysql -N -h127.0.0.1 -P2345 -uuser -ppwd <span class="_">-e</span> <span class="string">"select * from backends;"</span> | wc <span class="_">-l</span>`</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$count</span>"</span> == <span class="string">"1"</span> ]];<span class="keyword">then</span></span><br><span class="line">    result=`mysql -hserver1 -P3306 -uroot -pXp29at5F37 <span class="_">-e</span> <span class="string">'show slave status\G'</span>`</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">echo</span> <span class="string">"<span class="variable">$result</span>"</span> | grep Slave_IO_State;<span class="keyword">then</span></span><br><span class="line">        slaveIP=192.168.1.100</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        result=`mysql -hserver2 -P3306 -uroot -pXp29at5F37 <span class="_">-e</span> <span class="string">'show slave status\G'</span>`</span><br><span class="line">        slaveIP=192.168.1.101</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    slaveIORunning=`<span class="built_in">echo</span> <span class="string">"<span class="variable">$result</span>"</span> | awk -F<span class="string">':'</span> <span class="string">'/Slave_IO_Running:/&#123;print $2&#125;'</span>`</span><br><span class="line">    slaveSQLRunning=`<span class="built_in">echo</span> <span class="string">"<span class="variable">$result</span>"</span> | awk -F<span class="string">':'</span> <span class="string">'/Slave_SQL_Running:/&#123;print $2&#125;'</span>`</span><br><span class="line">    SlaveSQLRunning_State=`<span class="built_in">echo</span> <span class="string">"<span class="variable">$result</span>"</span> | awk -F<span class="string">':'</span> <span class="string">'/Slave_SQL_Running_State:/&#123;print $2&#125;'</span>`</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$slaveIORunning</span>"</span> =~ <span class="string">"Yes"</span> &amp;&amp; <span class="string">"<span class="variable">$slaveSQLRunning</span>"</span> =~ <span class="string">"Yes"</span> &amp;&amp; <span class="string">"<span class="variable">$SlaveSQLRunning_State</span>"</span> =~ <span class="string">"Slave has read all relay log"</span> ]];<span class="keyword">then</span></span><br><span class="line">        mysql -h127.0.0.1 -P2345 -uuser -ppwd <span class="_">-e</span> <span class="string">"add slave <span class="variable">$&#123;slaveIP&#125;</span>:3306;"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p>
<p>ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªè„šæœ¬å‘¢ï¼Ÿå‡è®¾ç›®å‰mysqlä¸»æœåŠ¡å™¨åœ¨s1ï¼Œs1å®•æœºåï¼Œs2æ¥ç®¡VIPï¼Œæ¥ç€åˆ é™¤atlasä¸­è®¾ç½®çš„slave backendï¼Œå°†mysqlæå‡ä¸ºä¸»ã€‚è¿‡ä¸€æ®µæ—¶é—´åï¼Œs1ä»å®•æœºä¸­æ¢å¤ï¼Œè¿™æ—¶å€™s1çš„mysqlè‡ªåŠ¨åˆ‡æ¢ä¸ºä»ï¼Œæ¥ç€åˆ é™¤atlasä¸­è®¾ç½®çš„slave backendï¼Œå¼€å§‹è¿æ¥s2çš„mysqlä¸»åŒæ­¥æ•°æ®ã€‚åˆ°è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å‘ç°ï¼Œå·²ç»ä¸å­˜åœ¨è¯»å†™åˆ†ç¦»äº†ï¼Œæ‰€æœ‰çš„sqléƒ½å‘é€ç»™äº†s2çš„mysqlã€‚auto_maintain_atlas.shè„šæœ¬å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œæ­¤è„šæœ¬ä¼šå®šæ—¶çš„æ£€æŸ¥ä¸»ä»æ˜¯å¦å·²ç»åŒæ­¥å®Œæˆï¼Œå¦‚æœå®Œæˆå°±è‡ªåŠ¨å¢åŠ slave backendï¼Œè¿™æ ·è¯»å†™åˆ†ç¦»åˆæ¢å¤äº†ï¼Œå®Œå…¨ä¸éœ€è¦äººå·¥å¹²é¢„ã€‚</p>
<h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><h4 id="æµ‹è¯•keepalivedæ˜¯å¦å·¥ä½œæ­£å¸¸"><a href="#æµ‹è¯•keepalivedæ˜¯å¦å·¥ä½œæ­£å¸¸" class="headerlink" title="æµ‹è¯•keepalivedæ˜¯å¦å·¥ä½œæ­£å¸¸"></a>æµ‹è¯•keepalivedæ˜¯å¦å·¥ä½œæ­£å¸¸</h4><p>æˆ‘ä»¬æ¥æ¨¡æ‹Ÿserver1å®•æœºã€‚<br>åœ¨server1ä¸Šæ‰§è¡Œshutdownå…³æœºå‘½ä»¤ã€‚<br>æ­¤æ—¶æˆ‘ä»¬ç™»å½•server2ï¼Œæ‰§è¡Œip addrå‘½ä»¤ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1: lo: mtu 16436 qdisc noqueue state UNKNOWN</span><br><span class="line">link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">inet 127.0.0.1/8 scope host lo</span><br><span class="line">inet6 ::1/128 scope host</span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">link/ether 00:0c:29:81:9d:42 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">inet 10.96.153.114/24 brd 10.96.153.255 scope global eth0</span><br><span class="line">inet 10.96.153.239/24 scope global secondary eth0</span><br><span class="line">inet6 fe80::20c:29ff:fe81:9d42/64 scope link</span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line">3: eth1: mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">link/ether 00:0c:29:81:9d:4c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">inet 192.168.1.101/24 brd 192.168.1.255 scope global eth1</span><br><span class="line">inet 192.168.1.150/32 scope global eth1</span><br><span class="line">inet6 fe80::20c:29ff:fe81:9d4c/64 scope link</span><br><span class="line">valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬çœ‹åˆ°å¯¹å¤–VIP 10.96.153.239å’Œå¯¹å†…IP 192.168.1.150å·²ç»è½¬ç§»åˆ°server2äº†ï¼Œè¯æ˜keepalivedè¿è¡Œæ­£å¸¸ã€‚</p>
<h4 id="æµ‹è¯•æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢äº†ä¸»ä»"><a href="#æµ‹è¯•æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢äº†ä¸»ä»" class="headerlink" title="æµ‹è¯•æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢äº†ä¸»ä»"></a>æµ‹è¯•æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢äº†ä¸»ä»</h4><p>ç™»å½•server2çš„mysqlæœåŠ¡å™¨ï¼Œæ‰§è¡Œshow slave status;å‘½ä»¤ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å‘ç°ä»çŠ¶æ€å·²ç»ä¸ºç©ºï¼Œè¯æ˜å·²ç»åˆ‡æ¢ä¸ºä¸»äº†ã€‚</p>
<h4 id="æµ‹è¯•server1æ˜¯å¦æŠ¢å VIP"><a href="#æµ‹è¯•server1æ˜¯å¦æŠ¢å VIP" class="headerlink" title="æµ‹è¯•server1æ˜¯å¦æŠ¢å VIP"></a>æµ‹è¯•server1æ˜¯å¦æŠ¢å VIP</h4><p>ä¸ºä»€ä¹ˆè¦æµ‹è¯•è¿™ä¸ªå‘¢ï¼Ÿå¦‚æœserver1æ¢å¤ä¹‹åæŠ¢å äº†VIPï¼Œè€Œæˆ‘ä»¬çš„Atlasé‡Œåç«¯è®¾ç½®çš„æ˜¯VIPï¼Œè¿™æ ·server1å¯åŠ¨ä¹‹åï¼Œsqlçš„å†™æ“ä½œå°±ä¼šå‘server1çš„mysqlå‘é€ï¼Œè€Œserver1çš„mysqlæ•°æ®æ˜¯æ—§äºserver2çš„ï¼Œæ‰€ä»¥è¿™æ ·ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´ï¼Œè¿™ä¸ªæ˜¯éå¸¸é‡è¦çš„æµ‹è¯•ã€‚<br>æˆ‘ä»¬å…ˆæ¥å¯åŠ¨server1ï¼Œä¹‹åæ‰§è¡Œip addrï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1: lo: mtu 16436 qdisc noqueue state UNKNOWN</span><br><span class="line">link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">inet 127.0.0.1/8 scope host lo</span><br><span class="line">inet6 ::1/128 scope host</span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">link/ether 00:0c:29:f1:4f:4e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">inet 10.96.153.110/24 brd 10.96.153.255 scope global eth0</span><br><span class="line">inet6 fe80::20c:29ff:fef1:4f4e/64 scope link</span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line">3: eth1: mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">link/ether 00:0c:29:f1:4f:58 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">inet 192.168.1.100/24 brd 192.168.1.255 scope global eth1</span><br><span class="line">inet6 fe80::20c:29ff:fef1:4f58/64 scope link</span><br><span class="line">valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œserver1å¹¶æ²¡æœ‰æŠ¢å VIPï¼Œæµ‹è¯•æ­£å¸¸ã€‚ä¸è¿‡å¦äººéƒé—·çš„æ˜¯ï¼Œåœ¨è™šæ‹Ÿæœºçš„ç¯å¢ƒå¹¶æ²¡æœ‰æµ‹è¯•æˆåŠŸï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚</p>
<h4 id="æµ‹è¯•server2çš„atlasæ˜¯å¦å·²ç»åˆ é™¤slave-backend"><a href="#æµ‹è¯•server2çš„atlasæ˜¯å¦å·²ç»åˆ é™¤slave-backend" class="headerlink" title="æµ‹è¯•server2çš„atlasæ˜¯å¦å·²ç»åˆ é™¤slave backend"></a>æµ‹è¯•server2çš„atlasæ˜¯å¦å·²ç»åˆ é™¤slave backend</h4><p>æˆ‘ä»¬æµ‹è¯•è¿™ä¸ªæ˜¯ä¸ºäº†ä¿è¯atlaså·²ç»æ²¡æœ‰slave backendï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ä»åº“çš„è®¾ç½®äº†ï¼Œå¦åˆ™å½“server1æ¢å¤æ—¶ï¼Œæœ‰å¯èƒ½ä¼šæŠŠè¯»è¯·æ±‚å‘é€ç»™server1çš„mysqlï¼Œé€ æˆè¯»å–äº†æ—§æ•°æ®çš„é—®é¢˜ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]<span class="comment"># mysql -h127.0.0.1 -P2345 -uuser -ppwd</span></span><br><span class="line">mysql&gt; select * from backends;</span><br><span class="line">+â€”â€”â€”â€”-+â€”â€”â€”â€”â€”â€”â€“+â€”â€”-+â€”â€”+</span><br><span class="line">| backend_ndx | address | state | <span class="built_in">type</span> |</span><br><span class="line">+â€”â€”â€”â€”-+â€”â€”â€”â€”â€”â€”â€“+â€”â€”-+â€”â€”+</span><br><span class="line">| 1 | 192.168.1.150:3306 | up | rw |</span><br><span class="line">+â€”â€”â€”â€”-+â€”â€”â€”â€”â€”â€”â€“+â€”â€”-+â€”â€”+</span><br><span class="line">1 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœçœ‹åˆ°åªæœ‰ä¸€ä¸ªåç«¯ï¼Œè¯æ˜è¿ä½œæ­£å¸¸ã€‚</p>
<h4 id="æµ‹è¯•server1-mysqlæ˜¯å¦è®¾ç½®ä¸ºä»"><a href="#æµ‹è¯•server1-mysqlæ˜¯å¦è®¾ç½®ä¸ºä»" class="headerlink" title="æµ‹è¯•server1 mysqlæ˜¯å¦è®¾ç½®ä¸ºä»"></a>æµ‹è¯•server1 mysqlæ˜¯å¦è®¾ç½®ä¸ºä»</h4><p>serve1æ¢å¤åï¼Œç™»å½•server1çš„mysqlæœåŠ¡å™¨ï¼Œæ‰§è¡Œshow slave status;å‘½ä»¤ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Slave_IO_State: Opening tables</span><br><span class="line">Master_Host: server1</span><br><span class="line">Master_User: rpl</span><br><span class="line">Master_Port: 3306</span><br><span class="line">Connect_Retry: 60</span><br><span class="line">Master_Log_File: mysql-bin.000015</span><br><span class="line">Read_Master_Log_Pos: 48405991</span><br><span class="line">Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">Relay_Log_Pos: 361</span><br><span class="line">Relay_Master_Log_File: mysql-bin.000015</span><br><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: yes</span><br></pre></td></tr></table></figure></p>
<h4 id="æµ‹è¯•æ˜¯å¦è‡ªåŠ¨æ¢å¤è¯»å†™åˆ†ç¦»"><a href="#æµ‹è¯•æ˜¯å¦è‡ªåŠ¨æ¢å¤è¯»å†™åˆ†ç¦»" class="headerlink" title="æµ‹è¯•æ˜¯å¦è‡ªåŠ¨æ¢å¤è¯»å†™åˆ†ç¦»"></a>æµ‹è¯•æ˜¯å¦è‡ªåŠ¨æ¢å¤è¯»å†™åˆ†ç¦»</h4><p>server1æ¢å¤åä¸€æ®µæ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹æ˜¯è¯»å†™åˆ†ç¦»æ˜¯å¦å·²ç»æ¢å¤ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]<span class="comment"># mysql -h127.0.0.1 -P2345 -uuser -ppwd</span></span><br><span class="line">Warning: Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor. Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 1</span><br><span class="line">Server version: 5.0.99-agent-admin</span><br><span class="line">Copyright (c) 2000, 2014, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line">Type â€˜<span class="built_in">help</span>;â€™ or â€˜\hâ€™ <span class="keyword">for</span> help. Type â€˜\câ€™ to clear the current input statement.</span><br><span class="line">mysql&gt; select * from backends;</span><br><span class="line">+â€”â€”â€”â€”-+â€”â€”â€”â€”â€”â€”â€“+â€”â€”-+â€”â€”+</span><br><span class="line">| backend_ndx | address | state | <span class="built_in">type</span> |</span><br><span class="line">+â€”â€”â€”â€”-+â€”â€”â€”â€”â€”â€”â€“+â€”â€”-+â€”â€”+</span><br><span class="line">| 1 | 192.168.1.150:3306 | up | rw |</span><br><span class="line">| 2 | 192.168.1.100:3306 | up | ro |</span><br><span class="line">+â€”â€”â€”â€”-+â€”â€”â€”â€”â€”â€”â€“+â€”â€”-+â€”â€”+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬çœ‹åˆ°server1å·²ç»è¢«æ·»åŠ ä¸ºslave backendäº†ã€‚è¿™è¡¨ç¤ºå·²ç»æˆåŠŸæ¢å¤è¯»å†™åˆ†ç¦»ã€‚</p>
<hr>
<p>æ¥è‡ªï¼š<a href="https://www.centos.bz" target="_blank" rel="external">https://www.centos.bz</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ä½¿ç”¨lsyncdå®æ—¶åŒæ­¥æ–‡ä»¶]]></title>
      <url>http://team.jiunile.com/blog/2016/07/lsyncd.html</url>
      <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Lysncd å®é™…ä¸Šæ˜¯luaè¯­è¨€å°è£…äº† inotify å’Œ rsync å·¥å…·ï¼Œé‡‡ç”¨äº† Linux å†…æ ¸ï¼ˆ2.6.13 åŠä»¥åï¼‰é‡Œçš„ inotify è§¦å‘æœºåˆ¶ï¼Œç„¶åé€šè¿‡rsyncå»å·®å¼‚åŒæ­¥ï¼Œè¾¾åˆ°å®æ—¶çš„æ•ˆæœã€‚æˆ‘è®¤ä¸ºå®ƒæœ€ä»¤äººç§°é“çš„ç‰¹æ€§æ˜¯ï¼Œå®Œç¾è§£å†³äº† inotify + rsyncæµ·é‡æ–‡ä»¶åŒæ­¥å¸¦æ¥çš„æ–‡ä»¶é¢‘ç¹å‘é€æ–‡ä»¶åˆ—è¡¨çš„é—®é¢˜ â€”â€” é€šè¿‡æ—¶é—´å»¶è¿Ÿæˆ–ç´¯è®¡è§¦å‘äº‹ä»¶æ¬¡æ•°å®ç°ã€‚å¦å¤–ï¼Œå®ƒçš„é…ç½®æ–¹å¼å¾ˆç®€å•ï¼Œluaæœ¬èº«å°±æ˜¯ä¸€ç§é…ç½®è¯­è¨€ï¼Œå¯è¯»æ€§éå¸¸å¼ºã€‚lsyncdä¹Ÿæœ‰å¤šç§å·¥ä½œæ¨¡å¼å¯ä»¥é€‰æ‹©ï¼Œæœ¬åœ°ç›®å½•cpï¼Œæœ¬åœ°ç›®å½•rsyncï¼Œè¿œç¨‹ç›®å½•rsyncsshã€‚</p>
<p>å®ç°ç®€å•é«˜æ•ˆçš„æœ¬åœ°ç›®å½•åŒæ­¥å¤‡ä»½ï¼ˆç½‘ç»œå­˜å‚¨æŒ‚è½½ä¹Ÿå½“ä½œæœ¬åœ°ç›®å½•ï¼‰ï¼Œä¸€ä¸ªå‘½ä»¤æå®šã€‚</p>
<p>githubåœ°å€ï¼š<a href="https://github.com/axkibe/lsyncd" target="_blank" rel="external">https://github.com/axkibe/lsyncd</a> </p>
<h2 id="ä½¿ç”¨-lsyncd-æœ¬åœ°ç›®å½•å®æ—¶å¤‡ä»½"><a href="#ä½¿ç”¨-lsyncd-æœ¬åœ°ç›®å½•å®æ—¶å¤‡ä»½" class="headerlink" title="ä½¿ç”¨ lsyncd æœ¬åœ°ç›®å½•å®æ—¶å¤‡ä»½"></a>ä½¿ç”¨ lsyncd æœ¬åœ°ç›®å½•å®æ—¶å¤‡ä»½</h2><p>è¿™ä¸€èŠ‚å®ç°çš„åŠŸèƒ½æ˜¯ï¼Œæœ¬åœ°ç›®å½•sourceå®æ—¶åŒæ­¥åˆ°å¦ä¸€ä¸ªç›®å½•targetï¼Œè€Œåœ¨sourceä¸‹æœ‰å¤§é‡çš„æ–‡ä»¶ï¼Œå¹¶ä¸”æœ‰éƒ¨åˆ†ç›®å½•å’Œä¸´æ—¶æ–‡ä»¶ä¸éœ€è¦åŒæ­¥ã€‚</p>
<h3 id="å®‰è£…lsyncd"><a href="#å®‰è£…lsyncd" class="headerlink" title="å®‰è£…lsyncd"></a>å®‰è£…lsyncd</h3><p>å®‰è£…<code>lsyncd</code>æä¸ºç®€å•ï¼Œå·²ç»æ”¶å½•åœ¨ubuntuçš„å®˜æ–¹é•œåƒæºé‡Œï¼Œç›´æ¥é€šè¿‡<code>apt-get install lsyncd</code>å°±å¯ä»¥ã€‚<br>åœ¨Redhatç³»ï¼ˆæˆ‘çš„ç¯å¢ƒæ˜¯CentOS 6.2 x86_64 ï¼‰ï¼Œå¯ä»¥æ‰‹åŠ¨å»ä¸‹è½½ <a href="ftp://195.220.108.108/linux/fedora/linux/updates/21/x86_64/l/lsyncd-2.1.5-6.fc21.x86_64.rpm" target="_blank" rel="external">lsyncd-2.1.5-6.fc21.x86_64.rpm</a>ï¼Œä½†é¦–å…ˆä½ å¾—å®‰è£…ä¸¤ä¸ªä¾èµ–<code>yum install lua lua-devel</code>ã€‚ä¹Ÿå¯ä»¥é€šè¿‡åœ¨çº¿å®‰è£…ï¼Œéœ€è¦<code>epel-release</code>æ‰©å±•åŒ…ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span><br><span class="line">yum install lsyncd</span><br></pre></td></tr></table></figure></p>
<p><strong>æºç ç¼–è¯‘å®‰è£…</strong><br>ä»æºç ç¼–è¯‘å®‰è£…å¯ä»¥ä½¿ç”¨æœ€æ–°ç‰ˆçš„lsyncdç¨‹åºï¼Œä½†å¿…é¡»è¦ç›¸åº”çš„ä¾èµ–åº“æ–‡ä»¶å’Œç¼–è¯‘å·¥å…·ï¼š<code>yum install lua lua-devel asciidoc cmake</code>ã€‚</p>
<p>ä» <a href="http://code.google.com/p/lsyncd/downloads/list" target="_blank" rel="external">googlecode lsyncd</a> ä¸Šä¸‹è½½çš„<code>lsyncd-2.1.5.tar.gz</code>ï¼Œç›´æ¥<code>./configureã€make &amp;&amp; make install</code>å°±å¯ä»¥äº†ã€‚</p>
<p>ä»githubä¸Šä¸‹è½½<a href="https://github.com/axkibe/lsyncd/archive/master.zip" target="_blank" rel="external">lsyncd-master.zip</a> çš„2.1.5ç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯ cmake ç¼–è¯‘å·¥å…·ï¼Œæ— æ³•<code>./configure</code>ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uzip lsyncd-master.zip</span><br><span class="line"><span class="built_in">cd</span> lsyncd-master</span><br><span class="line">cmake -DCMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span>/lsyncd-2.1.5</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘è¿™ä¸ªç‰ˆæœ¬ç¼–è¯‘æ—¶æœ‰ä¸ªå°bugï¼Œå¦‚æœæŒ‰ç…§<code>INSTALL</code>åœ¨    <code>build</code>ç›®å½•ä¸­makeï¼Œä¼šæç¤ºï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[100%] Generating doc/lsyncd.1</span><br><span class="line">Updating the manpage</span><br><span class="line">a2x: failed: <span class="built_in">source</span> file not found: doc/lsyncd.1.txt</span><br><span class="line">make[2]: *** [doc/lsyncd.1] Error 1</span><br><span class="line">make[1]: *** [CMakeFiles/manpage.dir/all] Error 2</span><br><span class="line">make: *** [all] Error 2</span><br></pre></td></tr></table></figure></p>
<p>è§£å†³åŠæ³•æ˜¯è¦ä¹ˆç›´æ¥åœ¨è§£å‹ç›®å½•ä¸‹cmakeï¼Œä¸è¦<code>mkdir build</code>ï¼Œè¦ä¹ˆåœ¨<code>CMakeList.txt</code>ä¸­æœç´¢docå­—ç¬¦ä¸²ï¼Œåœ¨å‰é¢åŠ ä¸Š<code>${PROJECT_SOURCE_DIR}</code>ã€‚</p>
<a id="more"></a>
<h3 id="lsyncd-conf"><a href="#lsyncd-conf" class="headerlink" title="lsyncd.conf"></a>lsyncd.conf</h3><p>ä¸‹é¢éƒ½æ˜¯åœ¨ç¼–è¯‘å®‰è£…çš„æƒ…å†µä¸‹æ“ä½œã€‚</p>
<h4 id="lsyncdåŒæ­¥é…ç½®"><a href="#lsyncdåŒæ­¥é…ç½®" class="headerlink" title="lsyncdåŒæ­¥é…ç½®"></a>lsyncdåŒæ­¥é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd /usr/local/lsyncd-2.1.5</span></span><br><span class="line"><span class="comment"># mkdir etc var</span></span><br><span class="line"><span class="comment"># vi etc/lsyncd.conf</span></span><br><span class="line">settings &#123;</span><br><span class="line">    logfile      =<span class="string">"/usr/local/lsyncd-2.1.5/var/lsyncd.log"</span>,</span><br><span class="line">    statusFile   =<span class="string">"/usr/local/lsyncd-2.1.5/var/lsyncd.status"</span>,</span><br><span class="line">    inotifyMode  = <span class="string">"CloseWrite"</span>,</span><br><span class="line">    maxProcesses = 7,</span><br><span class="line">    -- nodaemon =<span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">sync &#123;</span><br><span class="line">    default.rsync,</span><br><span class="line">    <span class="built_in">source</span>    = <span class="string">"/tmp/src"</span>,</span><br><span class="line">    target    = <span class="string">"/tmp/dest"</span>,</span><br><span class="line">    -- excludeFrom = <span class="string">"/etc/rsyncd.d/rsync_exclude.lst"</span>,</span><br><span class="line">    rsync     = &#123;</span><br><span class="line">        binary    = <span class="string">"/usr/bin/rsync"</span>,</span><br><span class="line">        archive   = <span class="literal">true</span>,</span><br><span class="line">        compress  = <span class="literal">true</span>,</span><br><span class="line">        verbose   = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™å¯åŠ¨ lsycnd å°±å¯ä»¥å®Œæˆå®æ—¶åŒæ­¥äº†ï¼Œé»˜è®¤çš„è®¸å¤šå‚æ•°å¯ä»¥æ»¡è¶³ç»å¤§éƒ¨åˆ†éœ€æ±‚ï¼Œéå¸¸ç®€å•ã€‚</p>
<h4 id="lsyncd-confé…ç½®é€‰é¡¹è¯´æ˜"><a href="#lsyncd-confé…ç½®é€‰é¡¹è¯´æ˜" class="headerlink" title="lsyncd.confé…ç½®é€‰é¡¹è¯´æ˜"></a>lsyncd.confé…ç½®é€‰é¡¹è¯´æ˜</h4><p><strong>settings</strong><br>é‡Œé¢æ˜¯å…¨å±€è®¾ç½®ï¼Œ<code>--</code>å¼€å¤´è¡¨ç¤ºæ³¨é‡Šï¼Œä¸‹é¢æ˜¯å‡ ä¸ªå¸¸ç”¨é€‰é¡¹è¯´æ˜ï¼š</p>
<ul>
<li><code>logfile</code> å®šä¹‰æ—¥å¿—æ–‡ä»¶</li>
<li><code>stausFile</code> å®šä¹‰çŠ¶æ€æ–‡ä»¶</li>
<li><code>nodaemon=true</code> è¡¨ç¤ºä¸å¯ç”¨å®ˆæŠ¤æ¨¡å¼ï¼Œé»˜è®¤</li>
<li><code>statusInterval</code> å°†lsyncdçš„çŠ¶æ€å†™å…¥ä¸Šé¢çš„statusFileçš„é—´éš”ï¼Œé»˜è®¤10ç§’</li>
<li><code>inotifyMode</code> æŒ‡å®šinotifyç›‘æ§çš„äº‹ä»¶ï¼Œé»˜è®¤æ˜¯<code>CloseWrite</code>ï¼Œè¿˜å¯ä»¥æ˜¯<code>Modify</code>æˆ–<code>CloseWrite or Modify</code></li>
<li><code>maxProcesses</code> åŒæ­¥è¿›ç¨‹çš„æœ€å¤§ä¸ªæ•°ã€‚å‡å¦‚åŒæ—¶æœ‰20ä¸ªæ–‡ä»¶éœ€è¦åŒæ­¥ï¼Œè€Œ<code>maxProcesses = 8</code>ï¼Œåˆ™æœ€å¤§èƒ½çœ‹åˆ°æœ‰8ä¸ªrysncè¿›ç¨‹</li>
<li><code>maxDelays</code> ç´¯è®¡åˆ°å¤šå°‘æ‰€ç›‘æ§çš„äº‹ä»¶æ¿€æ´»ä¸€æ¬¡åŒæ­¥ï¼Œå³ä½¿åé¢çš„<code>delay</code>å»¶è¿Ÿæ—¶é—´è¿˜æœªåˆ°</li>
</ul>
<p><strong>sync</strong><br>é‡Œé¢æ˜¯å®šä¹‰åŒæ­¥å‚æ•°ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨<code>maxDelays</code>æ¥é‡å†™settingsçš„å…¨å±€å˜é‡ã€‚ä¸€èˆ¬ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šlsyncdä»¥ä»€ä¹ˆæ¨¡å¼è¿è¡Œï¼š<code>rsync</code>ã€<code>rsyncssh</code>ã€<code>direct</code>ä¸‰ç§æ¨¡å¼ï¼š</p>
<ul>
<li><p><code>default.rsync</code>ï¼šæœ¬åœ°ç›®å½•é—´åŒæ­¥ï¼Œä½¿ç”¨rsyncï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°ä½¿ç”¨sshå½¢å¼çš„è¿œç¨‹rsyncæ•ˆæœï¼Œæˆ–daemonæ–¹å¼è¿æ¥è¿œç¨‹rsyncdè¿›ç¨‹ï¼›<br><code>default.direct</code> ï¼šæœ¬åœ°ç›®å½•é—´åŒæ­¥ï¼Œä½¿ç”¨<code>cp</code>ã€<code>rm</code>ç­‰å‘½ä»¤å®Œæˆå·®å¼‚æ–‡ä»¶å¤‡ä»½ï¼›<br><code>default.rsyncssh</code> ï¼šåŒæ­¥åˆ°è¿œç¨‹ä¸»æœºç›®å½•ï¼Œrsyncçš„sshæ¨¡å¼ï¼Œéœ€è¦ä½¿ç”¨keyæ¥è®¤è¯</p>
</li>
<li><p><code>source</code> åŒæ­¥çš„æºç›®å½•ï¼Œä½¿ç”¨ç»å¯¹è·¯å¾„ã€‚</p>
</li>
<li><p><code>target</code> å®šä¹‰ç›®çš„åœ°å€.å¯¹åº”ä¸åŒçš„æ¨¡å¼æœ‰å‡ ç§å†™æ³•ï¼š<br><code>/tmp/dest</code> ï¼šæœ¬åœ°ç›®å½•åŒæ­¥ï¼Œå¯ç”¨äº<code>direct</code>å’Œ<code>rsync</code>æ¨¡å¼<br><code>172.29.88.223:/tmp/dest</code> ï¼šåŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨ç›®å½•ï¼Œå¯ç”¨äº<code>rsync</code>å’Œ<code>rsyncssh</code>æ¨¡å¼ï¼Œæ‹¼æ¥çš„å‘½ä»¤ç±»ä¼¼äº<code>/usr/bin/rsync -ltsd --delete --include-from=- --exclude=* SOURCE TARGET</code>ï¼Œå‰©ä¸‹çš„å°±æ˜¯rsyncçš„å†…å®¹äº†ï¼Œæ¯”å¦‚æŒ‡å®šusernameï¼Œå…å¯†ç åŒæ­¥<br><code>172.29.88.223::module</code> ï¼šåŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨ç›®å½•ï¼Œç”¨äº<code>rsync</code>æ¨¡å¼<br>ä¸‰ç§æ¨¡å¼çš„ç¤ºä¾‹ä¼šåœ¨åé¢ç»™å‡ºã€‚</p>
</li>
<li><p><code>init</code> è¿™æ˜¯ä¸€ä¸ªä¼˜åŒ–é€‰é¡¹ï¼Œå½“<code>init = false</code>ï¼ŒåªåŒæ­¥è¿›ç¨‹å¯åŠ¨ä»¥åå‘ç”Ÿæ”¹åŠ¨äº‹ä»¶çš„æ–‡ä»¶ï¼ŒåŸæœ‰çš„ç›®å½•å³ä½¿æœ‰å·®å¼‚ä¹Ÿä¸ä¼šåŒæ­¥ã€‚é»˜è®¤æ˜¯<code>true</code></p>
</li>
<li><p><code>delay</code> ç´¯è®¡äº‹ä»¶ï¼Œç­‰å¾…rsyncåŒæ­¥å»¶æ—¶æ—¶é—´ï¼Œé»˜è®¤15ç§’ï¼ˆæœ€å¤§ç´¯è®¡åˆ°1000ä¸ªä¸å¯åˆå¹¶çš„äº‹ä»¶ï¼‰ã€‚ä¹Ÿå°±æ˜¯15så†…ç›‘æ§ç›®å½•ä¸‹å‘ç”Ÿçš„æ”¹åŠ¨ï¼Œä¼šç´¯ç§¯åˆ°ä¸€æ¬¡rsyncåŒæ­¥ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„åŒæ­¥ã€‚ï¼ˆå¯åˆå¹¶çš„æ„æ€æ˜¯ï¼Œ15så†…ä¸¤æ¬¡ä¿®æ”¹äº†åŒä¸€æ–‡ä»¶ï¼Œæœ€ååªåŒæ­¥æœ€æ–°çš„æ–‡ä»¶ï¼‰</p>
</li>
<li><p><code>excludeFrom</code> æ’é™¤é€‰é¡¹ï¼Œåé¢æŒ‡å®šæ’é™¤çš„åˆ—è¡¨æ–‡ä»¶ï¼Œå¦‚<code>excludeFrom = &quot;/etc/lsyncd.exclude&quot;</code>ï¼Œå¦‚æœæ˜¯ç®€å•çš„æ’é™¤ï¼Œå¯ä»¥ä½¿ç”¨<code>exclude = LIST</code>ã€‚<br>è¿™é‡Œçš„æ’é™¤è§„åˆ™å†™æ³•ä¸åŸç”Ÿrsyncæœ‰ç‚¹ä¸åŒï¼Œæ›´ä¸ºç®€å•ï¼š</p>
<ul>
<li>ç›‘æ§è·¯å¾„é‡Œçš„ä»»ä½•éƒ¨åˆ†åŒ¹é…åˆ°ä¸€ä¸ªæ–‡æœ¬ï¼Œéƒ½ä¼šè¢«æ’é™¤ï¼Œä¾‹å¦‚<code>/bin/foo/bar</code>å¯ä»¥åŒ¹é…è§„åˆ™<code>foo</code></li>
<li>å¦‚æœè§„åˆ™ä»¥æ–œçº¿<code>/</code>å¼€å¤´ï¼Œåˆ™ä»å¤´å¼€å§‹è¦åŒ¹é…å…¨éƒ¨</li>
<li>å¦‚æœè§„åˆ™ä»¥<code>/</code>ç»“å°¾ï¼Œåˆ™è¦åŒ¹é…ç›‘æ§è·¯å¾„çš„æœ«å°¾</li>
<li><code>?</code>åŒ¹é…ä»»ä½•å­—ç¬¦ï¼Œä½†ä¸åŒ…æ‹¬<code>/</code></li>
<li><code>*</code>åŒ¹é…0æˆ–å¤šä¸ªå­—ç¬¦ï¼Œä½†ä¸åŒ…æ‹¬<code>/</code></li>
<li><code>**</code>åŒ¹é…0æˆ–å¤šä¸ªå­—ç¬¦ï¼Œå¯ä»¥æ˜¯<code>/</code></li>
</ul>
</li>
<li><p><code>delete</code> ä¸ºäº†ä¿æŒtargetä¸souceå®Œå…¨åŒæ­¥ï¼ŒLsyncdé»˜è®¤ä¼š<code>delete = true</code>æ¥å…è®¸åŒæ­¥åˆ é™¤ã€‚å®ƒé™¤äº†<code>false</code>ï¼Œè¿˜æœ‰<code>startup</code>ã€<code>running</code>å€¼ï¼Œè¯·å‚è€ƒ <a href="https://github.com/axkibe/lsyncd/wiki/Lsyncd%202.1.x%20%E2%80%96%20Layer%204%20Config%20%E2%80%96%20Default%20Behavior" target="_blank" rel="external">Lsyncd 2.1.x â€– Layer 4 Config â€– Default Behavior</a>ã€‚</p>
</li>
</ul>
<p><strong>rsync</strong><br>ï¼ˆæç¤ºä¸€ä¸‹ï¼Œ<code>delete</code>å’Œ<code>exclude</code>æœ¬æ¥éƒ½æ˜¯<strong>rsync</strong>çš„é€‰é¡¹ï¼Œä¸Šé¢æ˜¯é…ç½®åœ¨syncä¸­çš„ï¼Œæˆ‘æƒ³è¿™æ ·åšçš„åŸå› æ˜¯ä¸ºäº†å‡å°‘rsyncçš„å¼€é”€ï¼‰</p>
<ul>
<li><code>bwlimit</code> é™é€Ÿï¼Œå•ä½kb/sï¼Œä¸rsyncç›¸åŒï¼ˆè¿™ä¹ˆé‡è¦çš„é€‰é¡¹åœ¨æ–‡æ¡£é‡Œç«Ÿç„¶æ²¡æœ‰æ ‡å‡ºï¼‰</li>
<li><code>compress</code> å‹ç¼©ä¼ è¾“é»˜è®¤ä¸ºtrueã€‚åœ¨å¸¦å®½ä¸cpuè´Ÿè½½ä¹‹é—´æƒè¡¡ï¼Œæœ¬åœ°ç›®å½•åŒæ­¥å¯ä»¥è€ƒè™‘æŠŠå®ƒè®¾ä¸º<code>false</code></li>
<li><code>perms</code> é»˜è®¤ä¿ç•™æ–‡ä»¶æƒé™ã€‚</li>
<li>å…¶å®ƒrsyncçš„é€‰é¡¹</li>
</ul>
<p>å…¶å®ƒè¿˜æœ‰rsyncsshæ¨¡å¼ç‹¬æœ‰çš„é…ç½®é¡¹ï¼Œå¦‚<code>host</code>ã€<code>targetdir</code>ã€<code>rsync_path</code>ã€<code>password_file</code>ï¼Œè§åæ–‡ç¤ºä¾‹ã€‚<code>rsyncOps={&quot;-avz&quot;,&quot;--delete&quot;}</code>è¿™æ ·çš„å†™æ³•åœ¨2.1.*ç‰ˆæœ¬å·²ç»ä¸æ”¯æŒã€‚</p>
<p><code>lsyncd.conf</code>å¯ä»¥æœ‰å¤šä¸ª<code>sync</code>ï¼Œå„è‡ªçš„sourceï¼Œå„è‡ªçš„targetï¼Œå„è‡ªçš„æ¨¡å¼ï¼Œäº’ä¸å½±å“ã€‚</p>
<h3 id="å¯åŠ¨lsyncd"><a href="#å¯åŠ¨lsyncd" class="headerlink" title="å¯åŠ¨lsyncd"></a>å¯åŠ¨lsyncd</h3><p>ä½¿ç”¨å‘½ä»¤åŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼Œè‡ªåŠ¨åŒæ­¥ç›®å½•æ“ä½œã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsyncd -log Exec /usr/<span class="built_in">local</span>/lsyncd-2.1.5/etc/lsyncd.conf</span><br></pre></td></tr></table></figure></p>
<h3 id="lsyncd-confå…¶å®ƒæ¨¡å¼ç¤ºä¾‹"><a href="#lsyncd-confå…¶å®ƒæ¨¡å¼ç¤ºä¾‹" class="headerlink" title="lsyncd.confå…¶å®ƒæ¨¡å¼ç¤ºä¾‹"></a>lsyncd.confå…¶å®ƒæ¨¡å¼ç¤ºä¾‹</h3><p>ä»¥ä¸‹é…ç½®æœ¬äººéƒ½å·²ç»è¿‡éªŒè¯å¯è¡Œï¼Œå¿…é¡»æ ¹æ®å®é™…éœ€è¦è£å‰ªé…ç½®ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">settings &#123;</span><br><span class="line">    logfile =<span class="string">"/usr/local/lsyncd-2.1.5/var/lsyncd.log"</span>,</span><br><span class="line">    statusFile =<span class="string">"/usr/local/lsyncd-2.1.5/var/lsyncd.status"</span>,</span><br><span class="line">    inotifyMode = <span class="string">"CloseWrite"</span>,</span><br><span class="line">    maxProcesses = 8,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- I. æœ¬åœ°ç›®å½•åŒæ­¥ï¼Œdirectï¼šcp/rm/mvã€‚ é€‚ç”¨ï¼š500+ä¸‡æ–‡ä»¶ï¼Œå˜åŠ¨ä¸å¤§</span><br><span class="line">sync &#123;</span><br><span class="line">    default.direct,</span><br><span class="line">    <span class="built_in">source</span>    = <span class="string">"/tmp/src"</span>,</span><br><span class="line">    target    = <span class="string">"/tmp/dest"</span>,</span><br><span class="line">    delay = 1</span><br><span class="line">    maxProcesses = 1</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">-- II. æœ¬åœ°ç›®å½•åŒæ­¥ï¼Œrsyncæ¨¡å¼ï¼šrsync</span><br><span class="line">sync &#123;</span><br><span class="line">    default.rsync,</span><br><span class="line">    <span class="built_in">source</span>    = <span class="string">"/tmp/src"</span>,</span><br><span class="line">    target    = <span class="string">"/tmp/dest1"</span>,</span><br><span class="line">    excludeFrom = <span class="string">"/etc/rsyncd.d/rsync_exclude.lst"</span>,</span><br><span class="line">    rsync     = &#123;</span><br><span class="line">        binary = <span class="string">"/usr/bin/rsync"</span>,</span><br><span class="line">        archive = <span class="literal">true</span>,</span><br><span class="line">        compress = <span class="literal">true</span>,</span><br><span class="line">        bwlimit   = 2000</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">-- III. è¿œç¨‹ç›®å½•åŒæ­¥ï¼Œrsyncæ¨¡å¼ + rsyncd daemon</span><br><span class="line">sync &#123;</span><br><span class="line">    default.rsync,</span><br><span class="line">    <span class="built_in">source</span>    = <span class="string">"/tmp/src"</span>,</span><br><span class="line">    target    = <span class="string">"syncuser@172.29.88.223::module1"</span>,</span><br><span class="line">    delete=<span class="string">"running"</span>,</span><br><span class="line">    exclude = &#123; <span class="string">".*"</span>, <span class="string">".tmp"</span> &#125;,</span><br><span class="line">    delay = 30,</span><br><span class="line">    init = <span class="literal">false</span>,</span><br><span class="line">    rsync     = &#123;</span><br><span class="line">        binary = <span class="string">"/usr/bin/rsync"</span>,</span><br><span class="line">        archive = <span class="literal">true</span>,</span><br><span class="line">        compress = <span class="literal">true</span>,</span><br><span class="line">        verbose   = <span class="literal">true</span>,</span><br><span class="line">        password_file = <span class="string">"/etc/rsyncd.d/rsync.pwd"</span>,</span><br><span class="line">        _extra    = &#123;<span class="string">"--bwlimit=200"</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">-- IV. è¿œç¨‹ç›®å½•åŒæ­¥ï¼Œrsyncæ¨¡å¼ + ssh shell</span><br><span class="line">sync &#123;</span><br><span class="line">    default.rsync,</span><br><span class="line">    <span class="built_in">source</span>    = <span class="string">"/tmp/src"</span>,</span><br><span class="line">    target    = <span class="string">"172.29.88.223:/tmp/dest"</span>,</span><br><span class="line">    -- target    = <span class="string">"root@172.29.88.223:/remote/dest"</span>,</span><br><span class="line">    -- ä¸Šé¢targetï¼Œæ³¨æ„å¦‚æœæ˜¯æ™®é€šç”¨æˆ·ï¼Œå¿…é¡»æ‹¥æœ‰å†™æƒé™</span><br><span class="line">    maxDelays = 5,</span><br><span class="line">    delay = 30,</span><br><span class="line">    -- init = <span class="literal">true</span>,</span><br><span class="line">    rsync     = &#123;</span><br><span class="line">        binary = <span class="string">"/usr/bin/rsync"</span>,</span><br><span class="line">        archive = <span class="literal">true</span>,</span><br><span class="line">        compress = <span class="literal">true</span>,</span><br><span class="line">        bwlimit   = 2000</span><br><span class="line">        -- rsh = <span class="string">"/usr/bin/ssh -p 22 -o StrictHostKeyChecking=no"</span></span><br><span class="line">        -- å¦‚æœè¦æŒ‡å®šå…¶å®ƒç«¯å£ï¼Œè¯·ç”¨ä¸Šé¢çš„rsh</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">-- V. è¿œç¨‹ç›®å½•åŒæ­¥ï¼Œrsyncæ¨¡å¼ + rsyncsshï¼Œæ•ˆæœä¸ä¸Šé¢ç›¸åŒ</span><br><span class="line">sync &#123;</span><br><span class="line">    default.rsyncssh,</span><br><span class="line">    <span class="built_in">source</span>    = <span class="string">"/tmp/src2"</span>,</span><br><span class="line">    host      = <span class="string">"172.29.88.223"</span>,</span><br><span class="line">    targetdir = <span class="string">"/remote/dir"</span>,</span><br><span class="line">    excludeFrom = <span class="string">"/etc/rsyncd.d/rsync_exclude.lst"</span>,</span><br><span class="line">    -- maxDelays = 5,</span><br><span class="line">    delay = 0,</span><br><span class="line">    -- init = <span class="literal">false</span>,</span><br><span class="line">    rsync    = &#123;</span><br><span class="line">        binary = <span class="string">"/usr/bin/rsync"</span>,</span><br><span class="line">        archive = <span class="literal">true</span>,</span><br><span class="line">        compress = <span class="literal">true</span>,</span><br><span class="line">        verbose   = <span class="literal">true</span>,</span><br><span class="line">        _extra = &#123;<span class="string">"--bwlimit=2000"</span>&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    ssh      = &#123;</span><br><span class="line">        port  =  1234</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„å†…å®¹å‡ ä¹æ¶µç›–äº†æ‰€æœ‰åŒæ­¥çš„æ¨¡å¼ï¼Œå…¶ä¸­ç¬¬IIIä¸ªè¦æ±‚åƒrsyncä¸€æ ·é…ç½®rsyncdæœåŠ¡ç«¯ï¼Œè§æœ¬æ–‡å¼€å¤´ã€‚ç¬¬IVã€Vé…ç½®sshæ–¹å¼åŒæ­¥ï¼Œè¾¾åˆ°çš„æ•ˆæœç›¸åŒï¼Œä½†å®é™…åŒæ­¥æ—¶ä½ ä¼šå‘ç°æ¯æ¬¡åŒæ­¥éƒ½ä¼šæç¤ºè¾“å…¥sshçš„å¯†ç ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•è§£å†³ï¼š</p>
<p>åœ¨è¿œç«¯è¢«åŒæ­¥çš„æœåŠ¡å™¨ä¸Šå¼€å¯sshæ— å¯†ç ç™»å½•ï¼Œè¯·æ³¨æ„ç”¨æˆ·èº«ä»½ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user$ ssh-keygen -t rsa</span><br><span class="line">ä¸€è·¯å›è½¦...</span><br><span class="line">user$ <span class="built_in">cd</span> ~/.ssh</span><br><span class="line">user$ cat id_rsa.pub &gt;&gt; authorized_keys</span><br></pre></td></tr></table></figure></p>
<p>æŠŠ<code>id_rsa</code>ç§é’¥æ‹·è´åˆ°æ‰§è¡Œlsyncdçš„æœºå™¨ä¸Š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user$ chmod 600 ~/.ssh/id_rsa</span><br><span class="line">æµ‹è¯•èƒ½å¦æ— å¯†ç ç™»å½•</span><br><span class="line">user$ ssh user@172.29.88.223</span><br></pre></td></tr></table></figure></p>
<h2 id="lsyncdçš„å…¶å®ƒåŠŸèƒ½"><a href="#lsyncdçš„å…¶å®ƒåŠŸèƒ½" class="headerlink" title="lsyncdçš„å…¶å®ƒåŠŸèƒ½"></a>lsyncdçš„å…¶å®ƒåŠŸèƒ½</h2><p><code>lsyncd</code>çš„åŠŸèƒ½ä¸ä»…ä»…æ˜¯åŒæ­¥ï¼Œå®˜æ–¹æ‰‹å†Œ <a href="https://github.com/axkibe/lsyncd/wiki/Lsyncd%202.1.x%20%E2%80%96%20Layer%202%20Config%20%E2%80%96%20Advanced%20onAction" target="_blank" rel="external">Lsyncd 2.1.x â€– Layer 2 Config â€– Advanced onAction</a> é«˜çº§åŠŸèƒ½æåˆ°ï¼Œè¿˜å¯ä»¥ç›‘æ§æŸä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œæ ¹æ®è§¦å‘çš„äº‹ä»¶è‡ªå·±å®šä¹‰è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œexampleæ˜¯ç›‘æ§æŸä¸ªæŸä¸ªç›®å½•ï¼Œåªè¦æ˜¯æœ‰jpgã€gifã€pngæ ¼å¼çš„æ–‡ä»¶å‚æ•°ï¼Œå°±æŠŠå®ƒä»¬è½¬æˆpdfï¼Œç„¶ååŒæ­¥åˆ°å¦ä¸€ä¸ªç›®å½•ã€‚æ­£å¥½åœ¨æˆ‘è¿ç»´çš„ä¸€ä¸ªé¡¹ç›®ä¸­æœ‰è¿™ä¸ªéœ€æ±‚ï¼Œç°åœ¨éƒ½æ˜¯åœ¨javaä»£ç é‡Œè½¬æ¢ï¼Œè¿˜å®¹æ˜“å‡ºç°å¼‚å¸¸ï¼Œé€šè¿‡lsyncdå¯ä»¥ä»£æ›¿è¿™æ ·çš„åŠŸèƒ½ã€‚ä½†ï¼Œé—¨æ§›åœ¨äºè¦ä¼šä¸€ç‚¹ç‚¹luaè¯­è¨€ï¼ˆæ ¹æ®å®˜æ–¹exampleè¿˜æ˜¯å¯ä»¥å†™å‡ºæ¥ï¼‰ã€‚</p>
<p>å¦å¤–å¶ç„¶æƒ³åˆ°ä¸ªé—®é¢˜ï¼ŒåŒæ—¶è®¾ç½®äº†<code>maxDelays</code>å’Œ<code>delay</code>ï¼Œå½“ç›‘æ§ç›®å½•ä¸€ç›´æ²¡æœ‰æ–‡ä»¶å˜åŒ–äº†ï¼Œä¹Ÿä¼šå‘ç”ŸåŒæ­¥æ“ä½œï¼Œè™½ç„¶æ²¡æœ‰å¯rsyncçš„æ–‡ä»¶ã€‚</p>
<hr>
<p>æ¥æºï¼š<a href="http://seanlook.com/" target="_blank" rel="external">http://seanlook.com/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQLæ•°æ®åº“å¼€å‘è§„èŒƒ]]></title>
      <url>http://team.jiunile.com/blog/2016/07/mysql-mysql-develop-standard.html</url>
      <content type="html"><![CDATA[<h2 id="å‘½åè§„èŒƒ"><a href="#å‘½åè§„èŒƒ" class="headerlink" title="å‘½åè§„èŒƒ"></a>å‘½åè§„èŒƒ</h2><h3 id="åº“åã€è¡¨åã€å­—æ®µåå¿…é¡»ä½¿ç”¨å°å†™å­—æ¯ï¼Œå¹¶é‡‡ç”¨ä¸‹åˆ’çº¿åˆ†å‰²"><a href="#åº“åã€è¡¨åã€å­—æ®µåå¿…é¡»ä½¿ç”¨å°å†™å­—æ¯ï¼Œå¹¶é‡‡ç”¨ä¸‹åˆ’çº¿åˆ†å‰²" class="headerlink" title="åº“åã€è¡¨åã€å­—æ®µåå¿…é¡»ä½¿ç”¨å°å†™å­—æ¯ï¼Œå¹¶é‡‡ç”¨ä¸‹åˆ’çº¿åˆ†å‰²"></a>åº“åã€è¡¨åã€å­—æ®µåå¿…é¡»ä½¿ç”¨å°å†™å­—æ¯ï¼Œå¹¶é‡‡ç”¨ä¸‹åˆ’çº¿åˆ†å‰²</h3><ul>
<li>MySQLæœ‰é…ç½®å‚æ•°lower_case_table_names=1ï¼Œå³åº“è¡¨åä»¥å°å†™å­˜å‚¨ï¼Œå¤§å°å†™ä¸æ•æ„Ÿã€‚å¦‚æœæ˜¯0ï¼Œåˆ™åº“è¡¨åä»¥å®é™…æƒ…å†µå­˜å‚¨ï¼Œå¤§å°å†™æ•æ„Ÿï¼›å¦‚æœæ˜¯2ï¼Œä»¥å®é™…æƒ…å†µå­˜å‚¨ï¼Œä½†ä»¥å°å†™æ¯”è¾ƒã€‚</li>
<li>å¦‚æœå¤§å°å†™æ··åˆä½¿ç”¨ï¼Œå¯èƒ½å­˜åœ¨abcï¼ŒAbcï¼ŒABCç­‰å¤šä¸ªè¡¨å…±å­˜ï¼Œå®¹æ˜“å¯¼è‡´æ··ä¹±ã€‚</li>
<li>å­—æ®µåæ˜¾ç¤ºåŒºåˆ†å¤§å°å†™ï¼Œä½†å®é™…ä½¿â½¤æ—¶ä¸åŒºåˆ†ï¼Œå³ä¸å¯ä»¥å»ºç«‹ä¸¤ä¸ªåå­—ä¸€æ ·ä½†å¤§å°å†™ä¸ä¸€æ ·çš„å­—æ®µã€‚</li>
<li>ä¸ºäº†ç»Ÿä¸€è§„èŒƒï¼Œ åº“åã€è¡¨åã€å­—æ®µåä½¿ç”¨å°å†™å­—æ¯ã€‚</li>
</ul>
<h3 id="åº“åä»¥-d-å¼€å¤´ï¼Œè¡¨åä»¥-t-å¼€å¤´ï¼Œå­—æ®µåä»¥-f-å¼€å¤´"><a href="#åº“åä»¥-d-å¼€å¤´ï¼Œè¡¨åä»¥-t-å¼€å¤´ï¼Œå­—æ®µåä»¥-f-å¼€å¤´" class="headerlink" title="åº“åä»¥ d å¼€å¤´ï¼Œè¡¨åä»¥ t å¼€å¤´ï¼Œå­—æ®µåä»¥ f_ å¼€å¤´"></a>åº“åä»¥ d å¼€å¤´ï¼Œè¡¨åä»¥ t å¼€å¤´ï¼Œå­—æ®µåä»¥ f_ å¼€å¤´</h3><ul>
<li>æ¯”å¦‚è¡¨ <code>t_crm_relation</code>ï¼Œä¸­é—´çš„ crm ä»£è¡¨ä¸šåŠ¡æ¨¡å—å</li>
<li>è§†å›¾ä»¥<code>view_</code>å¼€å¤´ï¼Œäº‹ä»¶ä»¥<code>event_</code>å¼€å¤´ï¼Œè§¦å‘å™¨ä»¥<code>trig_</code>å¼€å¤´ï¼Œå­˜å‚¨è¿‡ç¨‹ä»¥<code>proc_</code>å¼€å¤´ï¼Œå‡½æ•°ä»¥<code>func_</code>å¼€å¤´</li>
<li>æ™®é€šç´¢å¼•ä»¥<code>idx_col1_col2</code>å‘½åï¼Œå”¯ä¸€ç´¢å¼•ä»¥<code>uk_col1_col2</code>å‘½åï¼ˆå¯å»æ‰f_å…¬å…±éƒ¨åˆ†ï¼‰ã€‚å¦‚ <code>idx_companyid_corpid_contacttime</code>(f_company_id, f_corp_id, f_contact_time)</li>
</ul>
<h3 id="åº“åã€è¡¨åã€å­—æ®µåç¦æ­¢è¶…è¿‡32ä¸ªå­—ç¬¦ï¼Œéœ€è§åçŸ¥æ„"><a href="#åº“åã€è¡¨åã€å­—æ®µåç¦æ­¢è¶…è¿‡32ä¸ªå­—ç¬¦ï¼Œéœ€è§åçŸ¥æ„" class="headerlink" title="åº“åã€è¡¨åã€å­—æ®µåç¦æ­¢è¶…è¿‡32ä¸ªå­—ç¬¦ï¼Œéœ€è§åçŸ¥æ„"></a>åº“åã€è¡¨åã€å­—æ®µåç¦æ­¢è¶…è¿‡32ä¸ªå­—ç¬¦ï¼Œéœ€è§åçŸ¥æ„</h3><p>åº“åã€è¡¨åã€å­—æ®µåæ”¯æŒæœ€å¤š64ä¸ªå­—ç¬¦ï¼Œä½†ä¸ºäº†ç»Ÿä¸€è§„èŒƒã€æ˜“äºè¾¨è¯†ä»¥åŠå‡å°‘ä¼ è¾“é‡ï¼Œç¦æ­¢è¶…è¿‡32ä¸ªå­—ç¬¦</p>
<h3 id="ä¸´æ—¶åº“ã€è¡¨åé¡»ä»¥tmpåŠ æ—¥æœŸä¸ºåç¼€"><a href="#ä¸´æ—¶åº“ã€è¡¨åé¡»ä»¥tmpåŠ æ—¥æœŸä¸ºåç¼€" class="headerlink" title="ä¸´æ—¶åº“ã€è¡¨åé¡»ä»¥tmpåŠ æ—¥æœŸä¸ºåç¼€"></a>ä¸´æ—¶åº“ã€è¡¨åé¡»ä»¥tmpåŠ æ—¥æœŸä¸ºåç¼€</h3><p>å¦‚ t_crm_relation_tmp0425ã€‚å¤‡ä»½è¡¨ä¹Ÿç±»ä¼¼ï¼Œå½¢å¦‚ <code>_bak20160425</code> ã€‚</p>
<h3 id="æŒ‰æ—¥æœŸæ—¶é—´åˆ†è¡¨é¡»ç¬¦åˆ-YYYY-MM-DD-æ ¼å¼"><a href="#æŒ‰æ—¥æœŸæ—¶é—´åˆ†è¡¨é¡»ç¬¦åˆ-YYYY-MM-DD-æ ¼å¼" class="headerlink" title="æŒ‰æ—¥æœŸæ—¶é—´åˆ†è¡¨é¡»ç¬¦åˆ_YYYY[MM][DD]æ ¼å¼"></a>æŒ‰æ—¥æœŸæ—¶é—´åˆ†è¡¨é¡»ç¬¦åˆ_YYYY[MM][DD]æ ¼å¼</h3><p>è¿™ä¹Ÿæ˜¯ä¸ºå°†æ¥æœ‰å¯èƒ½åˆ†è¡¨åšå‡†å¤‡çš„ï¼Œæ¯”å¦‚<code>t_crm_ec_record_201403</code>ï¼Œä½†åƒ t_crm_contact_at201506å°±æ‰“ç ´äº†è¿™ç§è§„èŒƒã€‚<br>ä¸å…·æœ‰æ—¶é—´ç‰¹æ€§çš„ï¼Œç›´æ¥ä»¥ <code>t_tbname_001</code> è¿™æ ·çš„æ–¹å¼å‘½åã€‚</p>
<h2 id="åº“è¡¨åŸºç¡€è§„èŒƒ"><a href="#åº“è¡¨åŸºç¡€è§„èŒƒ" class="headerlink" title="åº“è¡¨åŸºç¡€è§„èŒƒ"></a>åº“è¡¨åŸºç¡€è§„èŒƒ</h2><h3 id="ä½¿ç”¨Innodbå­˜å‚¨å¼•æ“"><a href="#ä½¿ç”¨Innodbå­˜å‚¨å¼•æ“" class="headerlink" title="ä½¿ç”¨Innodbå­˜å‚¨å¼•æ“"></a>ä½¿ç”¨Innodbå­˜å‚¨å¼•æ“</h3><p>5.5ç‰ˆæœ¬å¼€å§‹mysqlé»˜è®¤å­˜å‚¨å¼•æ“å°±æ˜¯InnoDBï¼Œ5.7ç‰ˆæœ¬å¼€å§‹ï¼Œç³»ç»Ÿè¡¨éƒ½æ”¾å¼ƒMyISAMäº†ã€‚</p>
<a id="more"></a>
<h3 id="è¡¨å­—ç¬¦é›†ç»Ÿä¸€ä½¿ç”¨UTF8"><a href="#è¡¨å­—ç¬¦é›†ç»Ÿä¸€ä½¿ç”¨UTF8" class="headerlink" title="è¡¨å­—ç¬¦é›†ç»Ÿä¸€ä½¿ç”¨UTF8"></a>è¡¨å­—ç¬¦é›†ç»Ÿä¸€ä½¿ç”¨UTF8</h3><ul>
<li>UTF8å­—ç¬¦é›†å­˜å‚¨æ±‰å­—å ç”¨3ä¸ªå­—èŠ‚ï¼Œå­˜å‚¨è‹±æ–‡å­—ç¬¦å ç”¨ä¸€ä¸ªå­—èŠ‚</li>
<li>æ ¡å¯¹å­—ç¬¦é›†ä½¿ç”¨é»˜è®¤çš„ utf8_general_ci</li>
<li>è¿æ¥çš„å®¢æˆ·ç«¯ä¹Ÿä½¿ç”¨utf8ï¼Œå»ºç«‹è¿æ¥æ—¶æŒ‡å®šcharsetæˆ–SET NAMES UTF8;ã€‚ï¼ˆå¯¹äºå·²ç»åœ¨é¡¹ç›®ä¸­é•¿æœŸä½¿ç”¨latin1çš„ï¼Œæ•‘ä¸äº†äº†ï¼‰</li>
<li>å¦‚æœé‡åˆ°EMOJç­‰è¡¨æƒ…ç¬¦å·çš„å­˜å‚¨éœ€æ±‚ï¼Œå¯ç”³è¯·ä½¿ç”¨UTF8MB4å­—ç¬¦é›†</li>
</ul>
<h3 id="æ‰€æœ‰è¡¨éƒ½è¦æ·»åŠ æ³¨é‡Š"><a href="#æ‰€æœ‰è¡¨éƒ½è¦æ·»åŠ æ³¨é‡Š" class="headerlink" title="æ‰€æœ‰è¡¨éƒ½è¦æ·»åŠ æ³¨é‡Š"></a>æ‰€æœ‰è¡¨éƒ½è¦æ·»åŠ æ³¨é‡Š</h3><ul>
<li>å°½é‡ç»™å­—æ®µä¹Ÿæ·»åŠ æ³¨é‡Š</li>
<li>ç±»statuså‹éœ€æŒ‡æ˜ä¸»è¦å€¼çš„å«ä¹‰ï¼Œå¦‚â€0-ç¦»çº¿ï¼Œ1-åœ¨çº¿â€</li>
</ul>
<h3 id="æ§åˆ¶å•è¡¨å­—æ®µæ•°é‡"><a href="#æ§åˆ¶å•è¡¨å­—æ®µæ•°é‡" class="headerlink" title="æ§åˆ¶å•è¡¨å­—æ®µæ•°é‡"></a>æ§åˆ¶å•è¡¨å­—æ®µæ•°é‡</h3><ul>
<li>å•è¡¨å­—æ®µæ•°ä¸Šé™30å·¦å³ï¼Œå†å¤šçš„è¯è€ƒè™‘å‚ç›´åˆ†è¡¨ï¼Œä¸€æ˜¯å†·çƒ­æ•°æ®åˆ†ç¦»ï¼ŒäºŒæ˜¯å¤§å­—æ®µåˆ†ç¦»ï¼Œä¸‰æ˜¯å¸¸åœ¨ä¸€èµ·åšæ¡ä»¶å’Œè¿”å›åˆ—çš„ä¸åˆ†ç¦»ã€‚</li>
<li>è¡¨å­—æ®µæ§åˆ¶å°‘è€Œç²¾ï¼Œå¯ä»¥æé«˜IOæ•ˆç‡ï¼Œå†…å­˜ç¼“å­˜æ›´å¤šæœ‰æ•ˆæ•°æ®ï¼Œä»è€Œæé«˜å“åº”é€Ÿåº¦å’Œå¹¶å‘èƒ½åŠ›ï¼Œåç»­ alter table ä¹Ÿæ›´å¿«ã€‚</li>
</ul>
<h3 id="æ‰€æœ‰è¡¨éƒ½å¿…é¡»è¦æ˜¾å¼æŒ‡å®šä¸»é”®"><a href="#æ‰€æœ‰è¡¨éƒ½å¿…é¡»è¦æ˜¾å¼æŒ‡å®šä¸»é”®" class="headerlink" title="æ‰€æœ‰è¡¨éƒ½å¿…é¡»è¦æ˜¾å¼æŒ‡å®šä¸»é”®"></a>æ‰€æœ‰è¡¨éƒ½å¿…é¡»è¦æ˜¾å¼æŒ‡å®šä¸»é”®</h3><ul>
<li>ä¸»é”®å°½é‡é‡‡ç”¨è‡ªå¢æ–¹å¼ï¼ŒInnoDBè¡¨å®é™…æ˜¯ä¸€æ£µç´¢å¼•ç»„ç»‡è¡¨ï¼Œé¡ºåºå­˜å‚¨å¯ä»¥æé«˜å­˜å–æ•ˆç‡ï¼Œå……åˆ†åˆ©ç”¨ç£ç›˜ç©ºé—´ã€‚è¿˜æœ‰å¯¹ä¸€äº›å¤æ‚æŸ¥è¯¢å¯èƒ½éœ€è¦è‡ªè¿æ¥æ¥ä¼˜åŒ–æ—¶éœ€è¦ç”¨åˆ°ã€‚</li>
<li>éœ€è¦å…¨å±€å”¯ä¸€ä¸»é”®æ—¶ï¼Œä½¿ç”¨å¤–éƒ¨å‘å·å™¨ticket serverï¼ˆå»ºè®¾ä¸­ï¼‰</li>
<li>å¦‚æœæ²¡æœ‰ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•ï¼Œupdate/deleteæ˜¯é€šè¿‡æ‰€æœ‰å­—æ®µæ¥å®šä½æ“ä½œçš„è¡Œï¼Œç›¸å½“äºæ¯è¡Œå°±æ˜¯ä¸€æ¬¡å…¨è¡¨æ‰«æ</li>
<li>å°‘æ•°æƒ…å†µå¯ä»¥ä½¿ç”¨è”åˆå”¯ä¸€ä¸»é”®ï¼Œéœ€ä¸DBAåå•†</li>
</ul>
<h3 id="ä¸å¼ºåˆ¶ä½¿ç”¨å¤–é”®å‚è€ƒ"><a href="#ä¸å¼ºåˆ¶ä½¿ç”¨å¤–é”®å‚è€ƒ" class="headerlink" title="ä¸å¼ºåˆ¶ä½¿ç”¨å¤–é”®å‚è€ƒ"></a>ä¸å¼ºåˆ¶ä½¿ç”¨å¤–é”®å‚è€ƒ</h3><p>å³ä½¿2ä¸ªè¡¨çš„å­—æ®µæœ‰æ˜ç¡®çš„å¤–é”®å‚è€ƒå…³ç³»ï¼Œä¹Ÿä¸ä½¿ç”¨ FOREIGN KEY ï¼Œå› ä¸ºæ–°çºªå½•ä¼šå»ä¸»é”®è¡¨åšæ ¡éªŒï¼Œå½±å“æ€§èƒ½ã€‚</p>
<h3 id="é€‚åº¦ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ã€è§†å›¾ï¼Œç¦æ­¢ä½¿ç”¨è§¦å‘å™¨ã€äº‹ä»¶"><a href="#é€‚åº¦ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ã€è§†å›¾ï¼Œç¦æ­¢ä½¿ç”¨è§¦å‘å™¨ã€äº‹ä»¶" class="headerlink" title="é€‚åº¦ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ã€è§†å›¾ï¼Œç¦æ­¢ä½¿ç”¨è§¦å‘å™¨ã€äº‹ä»¶"></a>é€‚åº¦ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ã€è§†å›¾ï¼Œç¦æ­¢ä½¿ç”¨è§¦å‘å™¨ã€äº‹ä»¶</h3><ul>
<li>å­˜å‚¨è¿‡ç¨‹ï¼ˆprocedureï¼‰è™½ç„¶å¯ä»¥ç®€åŒ–ä¸šåŠ¡ç«¯ä»£ç ï¼Œåœ¨ä¼ ç»Ÿä¼ä¸šå†™å¤æ‚é€»è¾‘æ—¶å¯èƒ½ä¼šç”¨åˆ°ï¼Œè€Œåœ¨äº’è”ç½‘ä¼ä¸šå˜æ›´æ˜¯å¾ˆé¢‘ç¹çš„ï¼Œåœ¨åˆ†åº“åˆ†è¡¨çš„æƒ…å†µä¸‹è¦å‡çº§ä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹ç›¸å½“éº»çƒ¦ã€‚åˆå› ä¸ºå®ƒæ˜¯ä¸è®°å½•logçš„ï¼Œæ‰€ä»¥ä¹Ÿä¸æ–¹ä¾¿debugæ€§èƒ½é—®é¢˜ã€‚å¦‚æœä½¿ç”¨è¿‡ç¨‹ï¼Œä¸€å®šè€ƒè™‘å¦‚æœæ‰§è¡Œå¤±è´¥çš„æƒ…å†µã€‚</li>
<li>ä½¿ç”¨è§†å›¾ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿæ˜¯ä¸ºäº†é™ä½ä»£ç é‡ŒSQLçš„å¤æ‚åº¦ï¼Œä½†æœ‰æ—¶å€™ä¸ºäº†è§†å›¾çš„é€šç”¨æ€§ä¼šæŸå¤±æ€§èƒ½ï¼ˆæ¯”å¦‚è¿”å›ä¸å¿…è¦çš„å­—æ®µï¼‰ã€‚</li>
<li>è§¦å‘å™¨ï¼ˆtriggerï¼‰ä¹Ÿæ˜¯åŒæ ·ï¼Œä½†ä¹Ÿä¸åº”è¯¥é€šè¿‡å®ƒå»çº¦æŸæ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œmysqlåªæ”¯æŒâ€œåŸºäºè¡Œçš„è§¦å‘â€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè§¦å‘å™¨å§‹ç»ˆæ˜¯é’ˆå¯¹ä¸€æ¡è®°å½•çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ•´ä¸ªsqlè¯­å¥çš„ï¼Œå¦‚æœå˜æ›´çš„æ•°æ®é›†éå¸¸å¤§çš„è¯ï¼Œæ•ˆç‡ä¼šå¾ˆä½ã€‚æ©ç›–ä¸€æ¡sqlèƒŒåçš„å·¥ä½œï¼Œä¸€æ—¦å‡ºç°é—®é¢˜å°†æ˜¯ç¾éš¾æ€§çš„ï¼Œä½†åˆå¾ˆéš¾å¿«é€Ÿåˆ†æå’Œå®šä½ã€‚å†è€…éœ€è¦ddlæ—¶æ— æ³•ä½¿ç”¨pt-oscå·¥å…·ã€‚æ”¾åœ¨transactionæ‰§è¡Œã€‚</li>
<li>äº‹ä»¶ï¼ˆeventï¼‰ä¹Ÿæ˜¯ä¸€ç§å·æ‡’çš„è¡¨ç°ï¼Œç›®å‰å·²ç»é‡åˆ°æ•°æ¬¡ç”±äºå®šæ—¶ä»»åŠ¡æ‰§è¡Œå¤±è´¥å½±å“ä¸šåŠ¡çš„æƒ…å†µï¼Œè€Œä¸”mysqlæ— æ³•å¯¹å®ƒåšå¤±è´¥é¢„è­¦ã€‚å»ºç«‹ä¸“é—¨çš„ job scheduler å¹³å°ã€‚</li>
</ul>
<h3 id="å•è¡¨æ•°æ®é‡æ§åˆ¶åœ¨5000wä»¥å†…"><a href="#å•è¡¨æ•°æ®é‡æ§åˆ¶åœ¨5000wä»¥å†…" class="headerlink" title="å•è¡¨æ•°æ®é‡æ§åˆ¶åœ¨5000wä»¥å†…"></a>å•è¡¨æ•°æ®é‡æ§åˆ¶åœ¨5000wä»¥å†…</h3><h3 id="æ•°æ®åº“ä¸­ä¸å…è®¸å­˜å‚¨æ˜æ–‡å¯†ç "><a href="#æ•°æ®åº“ä¸­ä¸å…è®¸å­˜å‚¨æ˜æ–‡å¯†ç " class="headerlink" title="æ•°æ®åº“ä¸­ä¸å…è®¸å­˜å‚¨æ˜æ–‡å¯†ç "></a>æ•°æ®åº“ä¸­ä¸å…è®¸å­˜å‚¨æ˜æ–‡å¯†ç </h3><h2 id="å­—æ®µè§„èŒƒ"><a href="#å­—æ®µè§„èŒƒ" class="headerlink" title="å­—æ®µè§„èŒƒ"></a>å­—æ®µè§„èŒƒ</h2><h3 id="charã€varcharã€textç­‰å­—ç¬¦ä¸²ç±»å‹å®šä¹‰"><a href="#charã€varcharã€textç­‰å­—ç¬¦ä¸²ç±»å‹å®šä¹‰" class="headerlink" title="charã€varcharã€textç­‰å­—ç¬¦ä¸²ç±»å‹å®šä¹‰"></a>charã€varcharã€textç­‰å­—ç¬¦ä¸²ç±»å‹å®šä¹‰</h3><ul>
<li>å¯¹äºé•¿åº¦åŸºæœ¬å›ºå®šçš„åˆ—ï¼Œå¦‚æœè¯¥åˆ—æ°å¥½æ›´æ–°åˆç‰¹åˆ«é¢‘ç¹ï¼Œé€‚åˆchar</li>
<li>varcharè™½ç„¶å­˜å‚¨å˜é•¿å­—ç¬¦ä¸²ï¼Œä½†ä¸å¯å¤ªå°ä¹Ÿä¸å¯å¤ªå¤§ã€‚UTF8æœ€å¤šèƒ½å­˜21844ä¸ªæ±‰å­—ï¼Œæˆ–65532ä¸ªè‹±æ–‡</li>
<li>varbinary(M)ä¿å­˜çš„æ˜¯äºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼Œå®ƒä¿å­˜çš„æ˜¯å­—èŠ‚è€Œä¸æ˜¯å­—ç¬¦ï¼Œæ‰€ä»¥æ²¡æœ‰å­—ç¬¦é›†çš„æ¦‚å¿µï¼ŒMé•¿åº¦0-255ï¼ˆå­—èŠ‚ï¼‰ã€‚åªç”¨äºæ’åºæˆ–æ¯”è¾ƒæ—¶å¤§å°å†™æ•æ„Ÿçš„ç±»å‹ï¼Œä¸åŒ…æ‹¬å¯†ç å­˜å‚¨</li>
<li>TEXTç±»å‹ä¸VARCHARéƒ½ç±»ä¼¼ï¼Œå­˜å‚¨å¯å˜é•¿åº¦ï¼Œæœ€å¤§é™åˆ¶ä¹Ÿæ˜¯2^16ï¼Œä½†æ˜¯å®ƒ20bytesä»¥åçš„å†…å®¹æ˜¯åœ¨æ•°æ®é¡µä»¥å¤–çš„ç©ºé—´å­˜å‚¨ï¼ˆrow_format=dynamicï¼‰ï¼Œå¯¹å®ƒçš„ä½¿ç”¨éœ€è¦å¤šä¸€æ¬¡å¯»å€ï¼Œæ²¡æœ‰é»˜è®¤å€¼ã€‚<br>ä¸€èˆ¬ç”¨äºå­˜æ”¾å®¹é‡å¹³å‡éƒ½å¾ˆå¤§ã€æ“ä½œæ²¡æœ‰å…¶å®ƒå­—æ®µé‚£æ ·é¢‘ç¹çš„å€¼ã€‚<br>ç½‘ä¸Šéƒ¨åˆ†æ–‡ç« è¯´è¦é¿å…ä½¿ç”¨textå’Œblobï¼Œè¦çŸ¥é“å¦‚æœçº¯ç”¨varcharå¯èƒ½ä¼šå¯¼è‡´è¡Œæº¢å‡ºï¼Œæ•ˆæœå·®ä¸å¤šï¼Œä½†å› ä¸ºæ¯è¡Œå ç”¨å­—èŠ‚æ•°è¿‡å¤šï¼Œä¼šå¯¼è‡´buffer_poolèƒ½ç¼“å­˜çš„æ•°æ®è¡Œã€é¡µä¸‹é™ã€‚å¦å¤–textå’Œblobä¸Šé¢ä¸€èˆ¬ä¸ä¼šå»å»ºç´¢å¼•ï¼Œè€Œæ˜¯åˆ©ç”¨sphinxä¹‹ç±»çš„ç¬¬ä¸‰æ–¹å…¨æ–‡æœç´¢å¼•æ“ï¼Œå¦‚æœç¡®å®è¦åˆ›å»ºï¼ˆå‰ç¼€ï¼‰ç´¢å¼•ï¼Œé‚£å°±ä¼šå½±å“æ€§èƒ½ã€‚å‡¡äº‹çœ‹å…·ä½“åœºæ™¯ã€‚<br>å¦å¤–å°½å¯èƒ½æŠŠtext/blobæ‹†åˆ°å¦ä¸€ä¸ªè¡¨ä¸­</li>
<li>BLOBå¯ä»¥çœ‹å‡ºvarbinaryçš„æ‰©å±•ç‰ˆæœ¬ï¼Œå†…å®¹ä»¥äºŒè¿›åˆ¶å­—ç¬¦ä¸²å­˜å‚¨ï¼Œæ— å­—ç¬¦é›†ï¼ŒåŒºåˆ†å¤§å°å†™ï¼Œæœ‰ä¸€ç§ç»å¸¸æä½†ä¸ç”¨çš„åœºæ™¯ï¼šä¸è¦åœ¨æ•°æ®åº“é‡Œå­˜å‚¨å›¾ç‰‡ã€‚</li>
</ul>
<h3 id="intã€tinyintã€decimalç­‰æ•°å­—ç±»å‹å®šä¹‰"><a href="#intã€tinyintã€decimalç­‰æ•°å­—ç±»å‹å®šä¹‰" class="headerlink" title="intã€tinyintã€decimalç­‰æ•°å­—ç±»å‹å®šä¹‰"></a>intã€tinyintã€decimalç­‰æ•°å­—ç±»å‹å®šä¹‰</h3><ul>
<li>ä½¿ç”¨tinyintæ¥ä»£æ›¿ enumå’Œboolean<br>ENUMç±»å‹åœ¨éœ€è¦ä¿®æ”¹æˆ–å¢åŠ æšä¸¾å€¼æ—¶ï¼Œéœ€è¦åœ¨çº¿DDLï¼Œæˆæœ¬è¾ƒé«˜ï¼›ENUMåˆ—å€¼å¦‚æœå«æœ‰æ•°å­—ç±»å‹ï¼Œå¯èƒ½ä¼šå¼•èµ·é»˜è®¤å€¼æ··æ·†<br>tinyintä½¿ç”¨1ä¸ªå­—èŠ‚ï¼Œä¸€èˆ¬ç”¨äºstatus,type,flagçš„åˆ—</li>
<li>å»ºè®®ä½¿ç”¨ UNSIGNED å­˜å‚¨éè´Ÿæ•°å€¼<br>ç›¸æ¯”ä¸ä½¿ç”¨ unsignedï¼Œå¯ä»¥æ‰©å¤§ä¸€å€ä½¿ç”¨æ•°å€¼èŒƒå›´</li>
<li>intä½¿ç”¨å›ºå®š4ä¸ªå­—èŠ‚å­˜å‚¨ï¼Œint(11)ä¸int(4)åªæ˜¯æ˜¾ç¤ºå®½åº¦çš„åŒºåˆ«</li>
<li>ä½¿ç”¨Decimal ä»£æ›¿float/doubleå­˜å‚¨ç²¾ç¡®æµ®ç‚¹æ•°<br>å¯¹äºè´§å¸ã€é‡‘é¢è¿™æ ·çš„ç±»å‹ï¼Œä½¿ç”¨decimalï¼Œå¦‚ decimal(9,2)ã€‚floaté»˜è®¤åªèƒ½èƒ½ç²¾ç¡®åˆ°6ä½æœ‰æ•ˆæ•°å­—</li>
</ul>
<h3 id="timestampä¸datetimeé€‰æ‹©"><a href="#timestampä¸datetimeé€‰æ‹©" class="headerlink" title="timestampä¸datetimeé€‰æ‹©"></a>timestampä¸datetimeé€‰æ‹©</h3><ul>
<li>datetime å’Œ timestampç±»å‹æ‰€å çš„å­˜å‚¨ç©ºé—´ä¸åŒï¼Œå‰è€…8ä¸ªå­—èŠ‚ï¼Œåè€…4ä¸ªå­—èŠ‚ï¼Œè¿™æ ·é€ æˆçš„åæœæ˜¯ä¸¤è€…èƒ½è¡¨ç¤ºçš„æ—¶é—´èŒƒå›´ä¸åŒã€‚å‰è€…èŒƒå›´ä¸º1000-01-01 00:00:00 ~ 9999-12-31 23:59:59ï¼Œåè€…èŒƒå›´ä¸º 1970-01-01 08:00:01 åˆ° 2038-01-19 11:14:07 ã€‚æ‰€ä»¥ TIMESTAMP æ”¯æŒçš„èŒƒå›´æ¯” DATATIME è¦å°ã€‚</li>
<li>timestampå¯ä»¥åœ¨insert/updateè¡Œæ—¶ï¼Œè‡ªåŠ¨æ›´æ–°æ—¶é—´å­—æ®µï¼ˆå¦‚ f_set_time timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMPï¼‰ï¼Œä½†ä¸€ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªè¿™æ ·çš„å®šä¹‰ã€‚</li>
<li>timestampæ˜¾ç¤ºä¸æ—¶åŒºæœ‰å…³ï¼Œå†…éƒ¨æ€»æ˜¯ä»¥ UTC æ¯«ç§’ æ¥å­˜çš„ã€‚è¿˜å—åˆ°ä¸¥æ ¼æ¨¡å¼çš„é™åˆ¶</li>
<li>ä¼˜å…ˆä½¿ç”¨timestampï¼Œdatetimeä¹Ÿæ²¡é—®é¢˜</li>
<li>whereæ¡ä»¶é‡Œä¸è¦å¯¹æ—¶é—´åˆ—ä¸Šä½¿ç”¨æ—¶é—´å‡½æ•°</li>
</ul>
<h3 id="å»ºè®®å­—æ®µéƒ½å®šä¹‰ä¸ºNOT-NULL"><a href="#å»ºè®®å­—æ®µéƒ½å®šä¹‰ä¸ºNOT-NULL" class="headerlink" title="å»ºè®®å­—æ®µéƒ½å®šä¹‰ä¸ºNOT NULL"></a>å»ºè®®å­—æ®µéƒ½å®šä¹‰ä¸ºNOT NULL</h3><ul>
<li>å¦‚æœæ˜¯ç´¢å¼•å­—æ®µï¼Œä¸€å®šè¦å®šä¹‰ä¸ºnot null ã€‚å› ä¸ºnullå€¼ä¼šå½±å“cordinateç»Ÿè®¡ï¼Œå½±å“ä¼˜åŒ–å™¨å¯¹ç´¢å¼•çš„é€‰æ‹©</li>
<li>å¦‚æœä¸èƒ½ä¿è¯insertæ—¶ä¸€å®šæœ‰å€¼è¿‡æ¥ï¼Œå®šä¹‰æ—¶ä½¿ç”¨default â€˜â€™ ï¼Œæˆ– 0</li>
</ul>
<h3 id="åŒä¸€æ„ä¹‰çš„å­—æ®µå®šä¹‰å¿…é¡»ç›¸åŒ"><a href="#åŒä¸€æ„ä¹‰çš„å­—æ®µå®šä¹‰å¿…é¡»ç›¸åŒ" class="headerlink" title="åŒä¸€æ„ä¹‰çš„å­—æ®µå®šä¹‰å¿…é¡»ç›¸åŒ"></a>åŒä¸€æ„ä¹‰çš„å­—æ®µå®šä¹‰å¿…é¡»ç›¸åŒ</h3><p>æ¯”å¦‚ä¸åŒè¡¨ä¸­éƒ½æœ‰ f_user_id å­—æ®µï¼Œé‚£ä¹ˆå®ƒçš„ç±»å‹ã€å­—æ®µé•¿åº¦è¦è®¾è®¡æˆä¸€æ ·</p>
<h2 id="ç´¢å¼•è§„èŒƒ"><a href="#ç´¢å¼•è§„èŒƒ" class="headerlink" title="ç´¢å¼•è§„èŒƒ"></a>ç´¢å¼•è§„èŒƒ</h2><h3 id="ä»»ä½•æ–°çš„select-update-deleteä¸Šçº¿ï¼Œéƒ½è¦å…ˆexplainï¼Œçœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ"><a href="#ä»»ä½•æ–°çš„select-update-deleteä¸Šçº¿ï¼Œéƒ½è¦å…ˆexplainï¼Œçœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ" class="headerlink" title="ä»»ä½•æ–°çš„select,update,deleteä¸Šçº¿ï¼Œéƒ½è¦å…ˆexplainï¼Œçœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ"></a>ä»»ä½•æ–°çš„select,update,deleteä¸Šçº¿ï¼Œéƒ½è¦å…ˆexplainï¼Œçœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ</h3><p>å°½é‡é¿å…extraåˆ—å‡ºç°ï¼šUsing File Sortï¼ŒUsing Temporaryï¼Œrowsè¶…è¿‡1000çš„è¦è°¨æ…ä¸Šçº¿ã€‚<br><strong><code>explainè§£è¯»</code></strong></p>
<ul>
<li><code>type</code>ï¼šALL, index, range, ref, eq_ref, const, system, NULLï¼ˆä»å·¦åˆ°å³ï¼Œæ€§èƒ½ä»å·®åˆ°å¥½ï¼‰</li>
<li><code>possible_keys</code>ï¼šæŒ‡å‡ºMySQLèƒ½ä½¿ç”¨å“ªä¸ªç´¢å¼•åœ¨è¡¨ä¸­æ‰¾åˆ°è®°å½•ï¼ŒæŸ¥è¯¢æ¶‰åŠåˆ°çš„å­—æ®µä¸Šè‹¥å­˜åœ¨ç´¢å¼•ï¼Œåˆ™è¯¥ç´¢å¼•å°†è¢«åˆ—å‡ºï¼Œä½†ä¸ä¸€å®šè¢«æŸ¥è¯¢ä½¿ç”¨</li>
<li><code>key</code>ï¼šè¡¨ç¤ºMySQLå®é™…å†³å®šä½¿ç”¨çš„é”®ï¼ˆç´¢å¼•ï¼‰<br>å¦‚æœæ²¡æœ‰é€‰æ‹©ç´¢å¼•ï¼Œé”®æ˜¯NULLã€‚è¦æƒ³å¼ºåˆ¶MySQLä½¿ç”¨æˆ–å¿½è§†possible_keysåˆ—ä¸­çš„ç´¢å¼•ï¼Œåœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨FORCE INDEXã€USE INDEXæˆ–è€…IGNORE INDEX</li>
<li><code>ref</code>ï¼šè¡¨ç¤ºé€‰æ‹© key åˆ—ä¸Šçš„ç´¢å¼•ï¼Œå“ªäº›åˆ—æˆ–å¸¸é‡è¢«ç”¨äºæŸ¥æ‰¾ç´¢å¼•åˆ—ä¸Šçš„å€¼</li>
<li><code>rows</code>ï¼šæ ¹æ®è¡¨ç»Ÿè®¡ä¿¡æ¯åŠç´¢å¼•é€‰ç”¨æƒ…å†µï¼Œä¼°ç®—çš„æ‰¾åˆ°æ‰€éœ€çš„è®°å½•æ‰€éœ€è¦è¯»å–çš„è¡Œæ•°</li>
<li><code>Extra</code><ul>
<li><code>Using temporary</code>ï¼šè¡¨ç¤ºMySQLéœ€è¦ä½¿ç”¨ä¸´æ—¶è¡¨æ¥å­˜å‚¨ç»“æœé›†ï¼Œå¸¸è§äºæ’åºå’Œåˆ†ç»„æŸ¥è¯¢</li>
<li><code>Using filesort</code>ï¼šMySQLä¸­æ— æ³•åˆ©ç”¨ç´¢å¼•å®Œæˆçš„æ’åºæ“ä½œç§°ä¸ºâ€œæ–‡ä»¶æ’åºâ€</li>
</ul>
</li>
</ul>
<h3 id="ç´¢å¼•ä¸ªæ•°é™åˆ¶"><a href="#ç´¢å¼•ä¸ªæ•°é™åˆ¶" class="headerlink" title="ç´¢å¼•ä¸ªæ•°é™åˆ¶"></a>ç´¢å¼•ä¸ªæ•°é™åˆ¶</h3><ul>
<li>ç´¢å¼•æ˜¯åŒåˆƒå‰‘ï¼Œä¼šå¢åŠ ç»´æŠ¤è´Ÿæ‹…ï¼Œå¢å¤§IOå‹åŠ›ï¼Œç´¢å¼•å ç”¨ç©ºé—´æ˜¯æˆå€å¢åŠ çš„</li>
<li>å•å¼ è¡¨çš„ç´¢å¼•æ•°é‡æ§åˆ¶åœ¨5ä¸ªä»¥å†…ï¼Œæˆ–ä¸è¶…è¿‡è¡¨å­—æ®µä¸ªæ•°çš„20%ã€‚è‹¥å•å¼ è¡¨å¤šä¸ªå­—æ®µåœ¨æŸ¥è¯¢éœ€æ±‚ä¸Šéƒ½è¦å•ç‹¬ç”¨åˆ°ç´¢å¼•ï¼Œéœ€è¦ç»è¿‡DBAè¯„ä¼°ã€‚</li>
</ul>
<h3 id="é¿å…å†—ä½™ç´¢å¼•"><a href="#é¿å…å†—ä½™ç´¢å¼•" class="headerlink" title="é¿å…å†—ä½™ç´¢å¼•"></a>é¿å…å†—ä½™ç´¢å¼•</h3><ul>
<li>InnoDBè¡¨æ˜¯ä¸€æ£µç´¢å¼•ç»„ç»‡è¡¨ï¼Œä¸»é”®æ˜¯å’Œæ•°æ®æ”¾åœ¨ä¸€èµ·çš„èšé›†ç´¢å¼•ï¼Œæ™®é€šç´¢å¼•æœ€ç»ˆæŒ‡å‘çš„æ˜¯ä¸»é”®åœ°å€ï¼Œæ‰€ä»¥æŠŠä¸»é”®åšæœ€åä¸€åˆ—æ˜¯å¤šä½™çš„ã€‚å¦‚f_crm_idä½œä¸ºä¸»é”®ï¼Œè”åˆç´¢å¼•(f_user_id,f_crm_id)ä¸Šçš„f_crm_idå°±å®Œå…¨å¤šä½™</li>
<li>(a,b,c)ã€(a,b)ï¼Œåè€…ä¸ºå†—ä½™ç´¢å¼•ã€‚å¯ä»¥åˆ©ç”¨å‰ç¼€ç´¢å¼•æ¥è¾¾åˆ°åŠ é€Ÿç›®çš„ï¼Œå‡è½»ç»´æŠ¤è´Ÿæ‹…</li>
</ul>
<h3 id="æ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œä½¿ç”¨è‡ªå¢idä½œä¸ºä¸»é”®"><a href="#æ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œä½¿ç”¨è‡ªå¢idä½œä¸ºä¸»é”®" class="headerlink" title="æ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œä½¿ç”¨è‡ªå¢idä½œä¸ºä¸»é”®"></a>æ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œä½¿ç”¨è‡ªå¢idä½œä¸ºä¸»é”®</h3><ul>
<li>ä¸»é”®æ˜¯ä¸€ç§èšé›†ç´¢å¼•ï¼Œé¡ºåºå†™å…¥ã€‚ç»„åˆå”¯ä¸€ç´¢å¼•ä½œä¸ºä¸»é”®çš„è¯ï¼Œæ˜¯éšæœºå†™å…¥ï¼Œé€‚åˆå†™å°‘è¯»å¤šçš„è¡¨</li>
<li>ä¸»é”®ä¸å…è®¸æ›´æ–°</li>
</ul>
<h3 id="ç´¢å¼•å°½é‡å»ºåœ¨é€‰æ‹©æ€§é«˜çš„åˆ—ä¸Š"><a href="#ç´¢å¼•å°½é‡å»ºåœ¨é€‰æ‹©æ€§é«˜çš„åˆ—ä¸Š" class="headerlink" title="ç´¢å¼•å°½é‡å»ºåœ¨é€‰æ‹©æ€§é«˜çš„åˆ—ä¸Š"></a>ç´¢å¼•å°½é‡å»ºåœ¨é€‰æ‹©æ€§é«˜çš„åˆ—ä¸Š</h3><ul>
<li>ä¸åœ¨ä½åŸºæ•°åˆ—ä¸Šå»ºç«‹ç´¢å¼•ï¼Œä¾‹å¦‚æ€§åˆ«ã€ç±»å‹ã€‚ä½†æœ‰ä¸€ç§æƒ…å†µï¼Œidx_feedbackid_type (f_feedback_id,f_type)ï¼Œå¦‚æœç»å¸¸ç”¨ f_type=1 æ¯”è¾ƒï¼Œè€Œä¸”èƒ½è¿‡æ»¤æ‰90%è¡Œï¼Œé‚£è¿™ä¸ªç»„åˆç´¢å¼•å°±å€¼å¾—åˆ›å»ºã€‚æœ‰æ—¶å€™åŒæ ·çš„æŸ¥è¯¢è¯­å¥ï¼Œç”±äºæ¡ä»¶å–å€¼ä¸åŒå¯¼è‡´ä½¿ç”¨ä¸åŒçš„ç´¢å¼•ï¼Œä¹Ÿæ˜¯è¿™ä¸ªé“ç†ã€‚</li>
<li>ç´¢å¼•é€‰æ‹©æ€§è®¡ç®—æ–¹æ³•ï¼ˆåŸºæ•° Ã· æ•°æ®è¡Œæ•°ï¼‰<br>Selectivity = Cardinality / Total Rows = select count(distinct col1)/count(*) from tbnameï¼Œè¶Šæ¥è¿‘1è¯´æ˜col1ä¸Šä½¿ç”¨ç´¢å¼•çš„è¿‡æ»¤æ•ˆæœè¶Šå¥½</li>
<li>èµ°ç´¢å¼•æ‰«æè¡Œæ•°è¶…è¿‡30%æ—¶ï¼Œæ”¹å…¨è¡¨æ‰«æ</li>
</ul>
<h3 id="æœ€å·¦å‰ç¼€åŸåˆ™"><a href="#æœ€å·¦å‰ç¼€åŸåˆ™" class="headerlink" title="æœ€å·¦å‰ç¼€åŸåˆ™"></a>æœ€å·¦å‰ç¼€åŸåˆ™</h3><ul>
<li>mysqlä½¿ç”¨è”åˆç´¢å¼•æ—¶ï¼Œä»å·¦å‘å³åŒ¹é…ï¼Œé‡åˆ°æ–­å¼€æˆ–è€…èŒƒå›´æŸ¥è¯¢æ—¶ï¼Œæ— æ³•ç”¨åˆ°åç»­çš„ç´¢å¼•åˆ—<br>æ¯”å¦‚ç´¢å¼•idx_c1_c2_c3 (c1,c2,c3)ï¼Œç›¸å½“äºåˆ›å»ºäº†(c1)ã€(c1,c2)ã€(c1,c2,c3)ä¸‰ä¸ªç´¢å¼•ï¼Œwhereæ¡ä»¶åŒ…å«ä¸Šé¢ä¸‰ç§æƒ…å†µçš„å­—æ®µæ¯”è¾ƒåˆ™å¯ä»¥ç”¨åˆ°ç´¢å¼•ï¼Œä½†åƒ where c1=a and c3=c åªèƒ½ç”¨åˆ°c1åˆ—çš„ç´¢å¼•ï¼Œåƒ c2=b and c3=cç­‰æƒ…å†µå°±å®Œå…¨ç”¨ä¸åˆ°è¿™ä¸ªç´¢å¼•</li>
<li>é‡åˆ°èŒƒå›´æŸ¥è¯¢(&gt;ã€&lt;ã€betweenã€like)ä¹Ÿä¼šåœæ­¢ç´¢å¼•åŒ¹é…ï¼Œæ¯”å¦‚ c1=a and c2 &gt; 2 and c3=cï¼Œåªæœ‰c1,c2åˆ—ä¸Šçš„æ¯”è¾ƒèƒ½ç”¨åˆ°ç´¢å¼•ï¼Œ(c1,c2,c3)æ’åˆ—çš„ç´¢å¼•æ‰å¯èƒ½ä¼šéƒ½ç”¨ä¸Š</li>
<li>whereæ¡ä»¶é‡Œé¢å­—æ®µçš„é¡ºåºä¸ç´¢å¼•é¡ºåºæ— å…³ï¼Œmysqlä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨è°ƒæ•´é¡ºåº</li>
</ul>
<h3 id="å‰ç¼€ç´¢å¼•"><a href="#å‰ç¼€ç´¢å¼•" class="headerlink" title="å‰ç¼€ç´¢å¼•"></a>å‰ç¼€ç´¢å¼•</h3><ul>
<li>å¯¹è¶…è¿‡30ä¸ªå­—ç¬¦é•¿åº¦çš„åˆ—åˆ›å»ºç´¢å¼•æ—¶ï¼Œè€ƒè™‘ä½¿ç”¨å‰ç¼€ç´¢å¼•ï¼Œå¦‚ idx_cs_guid2 (f_cs_guid(26))è¡¨ç¤ºæˆªå–å‰26ä¸ªå­—ç¬¦åšç´¢å¼•ï¼Œæ—¢å¯ä»¥æé«˜æŸ¥æ‰¾æ•ˆç‡ï¼Œä¹Ÿå¯ä»¥èŠ‚çœç©ºé—´</li>
<li>å‰ç¼€ç´¢å¼•ä¹Ÿæœ‰å®ƒçš„ç¼ºç‚¹æ˜¯ï¼Œå¦‚æœåœ¨è¯¥åˆ—ä¸Š ORDER BY æˆ– GROUP BY æ—¶æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œä¹Ÿä¸èƒ½æŠŠå®ƒä»¬ç”¨ä½œè¦†ç›–ç´¢å¼•(Covering Index)</li>
<li>å¦‚æœåœ¨varbinaryæˆ–blobè¿™ç§ä»¥äºŒè¿›åˆ¶å­˜å‚¨çš„åˆ—ä¸Šå»ºç«‹å‰ç¼€ç´¢å¼•ï¼Œè¦è€ƒè™‘å­—ç¬¦é›†ï¼Œæ‹¬å·é‡Œè¡¨ç¤ºçš„æ˜¯å­—èŠ‚æ•°</li>
</ul>
<h3 id="åˆç†ä½¿ç”¨è¦†ç›–ç´¢å¼•å‡å°‘IO"><a href="#åˆç†ä½¿ç”¨è¦†ç›–ç´¢å¼•å‡å°‘IO" class="headerlink" title="åˆç†ä½¿ç”¨è¦†ç›–ç´¢å¼•å‡å°‘IO"></a>åˆç†ä½¿ç”¨è¦†ç›–ç´¢å¼•å‡å°‘IO</h3><p>INNODBå­˜å‚¨å¼•æ“ä¸­ï¼Œsecondary index(éä¸»é”®ç´¢å¼•ï¼Œåˆç§°ä¸ºè¾…åŠ©ç´¢å¼•ã€äºŒçº§ç´¢å¼•)æ²¡æœ‰ç›´æ¥å­˜å‚¨è¡Œåœ°å€ï¼Œè€Œæ˜¯å­˜å‚¨ä¸»é”®å€¼ã€‚<br>å¦‚æœç”¨æˆ·éœ€è¦æŸ¥è¯¢secondary indexä¸­æ‰€ä¸åŒ…å«çš„æ•°æ®åˆ—ï¼Œåˆ™éœ€è¦å…ˆé€šè¿‡secondary indexæŸ¥æ‰¾åˆ°ä¸»é”®å€¼ï¼Œç„¶åå†é€šè¿‡ä¸»é”®æŸ¥è¯¢åˆ°å…¶ä»–æ•°æ®åˆ—ï¼Œå› æ­¤éœ€è¦æŸ¥è¯¢ä¸¤æ¬¡ã€‚è¦†ç›–ç´¢å¼•åˆ™å¯ä»¥åœ¨ä¸€ä¸ªç´¢å¼•ä¸­è·å–æ‰€æœ‰éœ€è¦çš„æ•°æ®åˆ—ï¼Œä»è€Œé¿å…å›è¡¨è¿›è¡ŒäºŒæ¬¡æŸ¥æ‰¾ï¼ŒèŠ‚çœIOå› æ­¤æ•ˆç‡è¾ƒé«˜ã€‚<br>ä¾‹å¦‚SELECT emailï¼Œuid FROM user_email WHERE uid=xxï¼Œå¦‚æœuidä¸æ˜¯ä¸»é”®ï¼Œé€‚å½“æ—¶å€™å¯ä»¥å°†ç´¢å¼•æ·»åŠ ä¸ºindex(uidï¼Œemail)ï¼Œä»¥è·å¾—æ€§èƒ½æå‡ã€‚</p>
<h3 id="å°½é‡ä¸è¦åœ¨é¢‘ç¹æ›´æ–°çš„åˆ—ä¸Šåˆ›å»ºç´¢å¼•"><a href="#å°½é‡ä¸è¦åœ¨é¢‘ç¹æ›´æ–°çš„åˆ—ä¸Šåˆ›å»ºç´¢å¼•" class="headerlink" title="å°½é‡ä¸è¦åœ¨é¢‘ç¹æ›´æ–°çš„åˆ—ä¸Šåˆ›å»ºç´¢å¼•"></a>å°½é‡ä¸è¦åœ¨é¢‘ç¹æ›´æ–°çš„åˆ—ä¸Šåˆ›å»ºç´¢å¼•</h3><p>å¦‚ä¸åœ¨å®šä¹‰äº† ON UPDATE CURRENT_STAMP çš„åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼Œç»´æŠ¤æˆæœ¬å¤ªé«˜ï¼ˆå¥½åœ¨mysqlæœ‰insert bufferï¼Œä¼šåˆå¹¶ç´¢å¼•çš„æ’å…¥ï¼‰</p>
<h2 id="SQLè®¾è®¡"><a href="#SQLè®¾è®¡" class="headerlink" title="SQLè®¾è®¡"></a>SQLè®¾è®¡</h2><h3 id="æœç»ç›´æ¥-SELECT-è¯»å–å…¨éƒ¨å­—æ®µ"><a href="#æœç»ç›´æ¥-SELECT-è¯»å–å…¨éƒ¨å­—æ®µ" class="headerlink" title="æœç»ç›´æ¥ SELECT * è¯»å–å…¨éƒ¨å­—æ®µ"></a>æœç»ç›´æ¥ SELECT * è¯»å–å…¨éƒ¨å­—æ®µ</h3><p>å³ä½¿éœ€è¦æ‰€æœ‰å­—æ®µï¼Œå‡å°‘ç½‘ç»œå¸¦å®½æ¶ˆè€—ï¼Œèƒ½æœ‰æ•ˆåˆ©ç”¨è¦†ç›–ç´¢å¼•ï¼Œè¡¨ç»“æ„å˜æ›´å¯¹ç¨‹åºåŸºæœ¬æ— å½±å“</p>
<h3 id="èƒ½ç¡®å®šè¿”å›ç»“æœåªæœ‰ä¸€æ¡æ—¶ï¼Œä½¿ç”¨-limit-1"><a href="#èƒ½ç¡®å®šè¿”å›ç»“æœåªæœ‰ä¸€æ¡æ—¶ï¼Œä½¿ç”¨-limit-1" class="headerlink" title="èƒ½ç¡®å®šè¿”å›ç»“æœåªæœ‰ä¸€æ¡æ—¶ï¼Œä½¿ç”¨ limit 1"></a>èƒ½ç¡®å®šè¿”å›ç»“æœåªæœ‰ä¸€æ¡æ—¶ï¼Œä½¿ç”¨ limit 1</h3><p><strong>åœ¨ä¿è¯æ•°æ®ä¸ä¼šæœ‰è¯¯çš„å‰æä¸‹</strong>ï¼Œèƒ½ç¡®å®šç»“æœé›†æ•°é‡æ—¶ï¼Œå¤šä½¿ç”¨limitï¼Œå°½å¿«çš„è¿”å›ç»“æœã€‚</p>
<h3 id="å°å¿ƒéšå¼ç±»å‹è½¬æ¢"><a href="#å°å¿ƒéšå¼ç±»å‹è½¬æ¢" class="headerlink" title="å°å¿ƒéšå¼ç±»å‹è½¬æ¢"></a>å°å¿ƒéšå¼ç±»å‹è½¬æ¢</h3><ul>
<li><p>è½¬æ¢è§„åˆ™</p>
<blockquote>
<p>a. ä¸¤ä¸ªå‚æ•°è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯ NULL æ—¶ï¼Œæ¯”è¾ƒçš„ç»“æœä¹Ÿæ˜¯ NULLï¼Œä¾‹å¤–æ˜¯ä½¿ç”¨ &lt;=&gt; å¯¹ä¸¤ä¸ª NULL åšæ¯”è¾ƒæ—¶ä¼šè¿”å› 1ï¼Œè¿™ä¸¤ç§æƒ…å†µéƒ½ä¸éœ€è¦åšç±»å‹è½¬æ¢<br>b. ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œä¼šæŒ‰ç…§å­—ç¬¦ä¸²æ¥æ¯”è¾ƒï¼Œä¸åšç±»å‹è½¬æ¢<br>c. ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯æ•´æ•°ï¼ŒæŒ‰ç…§æ•´æ•°æ¥æ¯”è¾ƒï¼Œä¸åšç±»å‹è½¬æ¢<br>d. åå…­è¿›åˆ¶çš„å€¼å’Œéæ•°å­—åšæ¯”è¾ƒæ—¶ï¼Œä¼šè¢«å½“åšäºŒè¿›åˆ¶ä¸²<br>e. æœ‰ä¸€ä¸ªå‚æ•°æ˜¯ TIMESTAMP æˆ– DATETIMEï¼Œå¹¶ä¸”å¦å¤–ä¸€ä¸ªå‚æ•°æ˜¯å¸¸é‡ï¼Œå¸¸é‡ä¼šè¢«è½¬æ¢ä¸º timestamp<br>f. æœ‰ä¸€ä¸ªå‚æ•°æ˜¯ decimal ç±»å‹ï¼Œå¦‚æœå¦å¤–ä¸€ä¸ªå‚æ•°æ˜¯ decimal æˆ–è€…æ•´æ•°ï¼Œä¼šå°†æ•´æ•°è½¬æ¢ä¸º decimal åè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå¦å¤–ä¸€ä¸ªå‚æ•°æ˜¯æµ®ç‚¹æ•°ï¼Œåˆ™ä¼šæŠŠ decimal è½¬æ¢ä¸ºæµ®ç‚¹æ•°è¿›è¡Œæ¯”è¾ƒ<br>g. æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªå‚æ•°éƒ½ä¼šè¢«è½¬æ¢ä¸ºæµ®ç‚¹æ•°å†è¿›è¡Œæ¯”è¾ƒã€‚</p>
</blockquote>
</li>
<li><p>å¦‚æœä¸€ä¸ªç´¢å¼•å»ºç«‹åœ¨stringç±»å‹ä¸Šï¼Œå¦‚æœè¿™ä¸ªå­—æ®µå’Œä¸€ä¸ªintç±»å‹çš„å€¼æ¯”è¾ƒï¼Œç¬¦åˆç¬¬ g æ¡ã€‚å¦‚f_phoneå®šä¹‰çš„ç±»å‹æ˜¯varcharï¼Œä½†whereä½¿ç”¨f_phone in (098890)ï¼Œä¸¤ä¸ªå‚æ•°éƒ½ä¼šè¢«å½“æˆæˆæµ®ç‚¹å‹ã€‚å‘ç”Ÿè¿™ä¸ªéšå¼è½¬æ¢å¹¶ä¸æ˜¯æœ€ç³Ÿçš„ï¼Œæœ€ç³Ÿçš„æ˜¯stringè½¬æ¢åçš„floatï¼Œmysqlæ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œè¿™æ‰å¯¼è‡´äº†æ€§èƒ½é—®é¢˜ã€‚å¦‚æœæ˜¯ f_user_id = â€˜1234567â€™ çš„æƒ…å†µï¼Œç¬¦åˆç¬¬ b æ¡,ç›´æ¥æŠŠæ•°å­—å½“å­—ç¬¦ä¸²æ¯”è¾ƒã€‚</p>
</li>
</ul>
<h3 id="ç¦æ­¢åœ¨whereæ¡ä»¶åˆ—ä¸Šä½¿ç”¨å‡½æ•°"><a href="#ç¦æ­¢åœ¨whereæ¡ä»¶åˆ—ä¸Šä½¿ç”¨å‡½æ•°" class="headerlink" title="ç¦æ­¢åœ¨whereæ¡ä»¶åˆ—ä¸Šä½¿ç”¨å‡½æ•°"></a>ç¦æ­¢åœ¨whereæ¡ä»¶åˆ—ä¸Šä½¿ç”¨å‡½æ•°</h3><ul>
<li>ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œå¦‚lower(email)ï¼Œf_qq % 4ã€‚å¯æ”¾åˆ°å³è¾¹çš„å¸¸é‡ä¸Šè®¡ç®—</li>
<li>è¿”å›å°ç»“æœé›†ä¸æ˜¯å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å¯¹è¿”å›åˆ—ä½¿ç”¨å‡½æ•°ï¼Œç®€åŒ–ç¨‹åºå¼€å‘</li>
</ul>
<h3 id="ä½¿ç”¨likeæ¨¡ç³ŠåŒ¹é…ï¼Œ-ä¸è¦æ”¾é¦–ä½"><a href="#ä½¿ç”¨likeæ¨¡ç³ŠåŒ¹é…ï¼Œ-ä¸è¦æ”¾é¦–ä½" class="headerlink" title="ä½¿ç”¨likeæ¨¡ç³ŠåŒ¹é…ï¼Œ%ä¸è¦æ”¾é¦–ä½"></a>ä½¿ç”¨likeæ¨¡ç³ŠåŒ¹é…ï¼Œ%ä¸è¦æ”¾é¦–ä½</h3><p>ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œæœ‰è¿™ç§æœç´¢éœ€æ±‚æ˜¯ï¼Œè€ƒè™‘å…¶å®ƒæ–¹æ¡ˆï¼Œå¦‚sphinxå…¨æ–‡æœç´¢</p>
<h3 id="æ¶‰åŠåˆ°å¤æ‚sqlæ—¶ï¼ŒåŠ¡å¿…å…ˆå‚è€ƒå·²æœ‰ç´¢å¼•è®¾è®¡ï¼Œå…ˆexplain"><a href="#æ¶‰åŠåˆ°å¤æ‚sqlæ—¶ï¼ŒåŠ¡å¿…å…ˆå‚è€ƒå·²æœ‰ç´¢å¼•è®¾è®¡ï¼Œå…ˆexplain" class="headerlink" title="æ¶‰åŠåˆ°å¤æ‚sqlæ—¶ï¼ŒåŠ¡å¿…å…ˆå‚è€ƒå·²æœ‰ç´¢å¼•è®¾è®¡ï¼Œå…ˆexplain"></a>æ¶‰åŠåˆ°å¤æ‚sqlæ—¶ï¼ŒåŠ¡å¿…å…ˆå‚è€ƒå·²æœ‰ç´¢å¼•è®¾è®¡ï¼Œå…ˆexplain</h3><ul>
<li>ç®€å•SQLæ‹†åˆ†ï¼Œä¸ä»¥ä»£ç å¤„ç†å¤æ‚ä¸ºç”±ã€‚</li>
<li>æ¯”å¦‚ OR æ¡ä»¶ï¼š f_phone=â€™10000â€™ or f_mobile=â€™10000â€™ï¼Œä¸¤ä¸ªå­—æ®µå„è‡ªæœ‰ç´¢å¼•ï¼Œä½†åªèƒ½ç”¨åˆ°å…¶ä¸­ä¸€ä¸ªã€‚å¯ä»¥æ‹†åˆ†æˆ2ä¸ªsqlï¼Œæˆ–è€…union allã€‚</li>
<li>å…ˆexplainçš„å¥½å¤„æ˜¯å¯ä»¥ä¸ºäº†åˆ©ç”¨ç´¢å¼•ï¼Œå¢åŠ æ›´å¤šæŸ¥è¯¢é™åˆ¶æ¡ä»¶</li>
</ul>
<h3 id="ä½¿ç”¨joinæ—¶ï¼Œwhereæ¡ä»¶å°½é‡ä½¿ç”¨å……åˆ†åˆ©ç”¨åŒä¸€è¡¨ä¸Šçš„ç´¢å¼•"><a href="#ä½¿ç”¨joinæ—¶ï¼Œwhereæ¡ä»¶å°½é‡ä½¿ç”¨å……åˆ†åˆ©ç”¨åŒä¸€è¡¨ä¸Šçš„ç´¢å¼•" class="headerlink" title="ä½¿ç”¨joinæ—¶ï¼Œwhereæ¡ä»¶å°½é‡ä½¿ç”¨å……åˆ†åˆ©ç”¨åŒä¸€è¡¨ä¸Šçš„ç´¢å¼•"></a>ä½¿ç”¨joinæ—¶ï¼Œwhereæ¡ä»¶å°½é‡ä½¿ç”¨å……åˆ†åˆ©ç”¨åŒä¸€è¡¨ä¸Šçš„ç´¢å¼•</h3><ul>
<li>å¦‚ select t1.a,t2.b * from t1,t2 and t1.a=t2.a and t1.b=123 and t2.c= 4 ï¼Œå¦‚æœt1.cä¸t2.cå­—æ®µç›¸åŒï¼Œé‚£ä¹ˆt1ä¸Šçš„ç´¢å¼•(b,c)å°±åªç”¨åˆ°bäº†ã€‚æ­¤æ—¶å¦‚æœæŠŠwhereæ¡ä»¶ä¸­çš„t2.c=4æ”¹æˆt1.c=4ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨åˆ°å®Œæ•´çš„ç´¢å¼•</li>
<li>è¿™ç§æƒ…å†µå¯èƒ½ä¼šåœ¨å­—æ®µå†—ä½™è®¾è®¡ï¼ˆåèŒƒå¼ï¼‰æ—¶å‡ºç°</li>
<li>æ­£ç¡®é€‰å–inner joinå’Œleft join</li>
</ul>
<h3 id="å°‘ç”¨å­æŸ¥è¯¢ï¼Œæ”¹ç”¨join"><a href="#å°‘ç”¨å­æŸ¥è¯¢ï¼Œæ”¹ç”¨join" class="headerlink" title="å°‘ç”¨å­æŸ¥è¯¢ï¼Œæ”¹ç”¨join"></a>å°‘ç”¨å­æŸ¥è¯¢ï¼Œæ”¹ç”¨join</h3><p>å°äº5.6ç‰ˆæœ¬æ—¶ï¼Œå­æŸ¥è¯¢æ•ˆç‡å¾ˆä½ï¼Œä¸åƒOracleé‚£æ ·å…ˆè®¡ç®—å­æŸ¥è¯¢åå¤–å±‚æŸ¥è¯¢ã€‚5.6ç‰ˆæœ¬å¼€å§‹å¾—åˆ°ä¼˜åŒ–</p>
<h3 id="è€ƒè™‘ä½¿ç”¨union-allï¼Œå°‘ä½¿ç”¨unionï¼Œæ³¨æ„è€ƒè™‘å»é‡"><a href="#è€ƒè™‘ä½¿ç”¨union-allï¼Œå°‘ä½¿ç”¨unionï¼Œæ³¨æ„è€ƒè™‘å»é‡" class="headerlink" title="è€ƒè™‘ä½¿ç”¨union allï¼Œå°‘ä½¿ç”¨unionï¼Œæ³¨æ„è€ƒè™‘å»é‡"></a>è€ƒè™‘ä½¿ç”¨union allï¼Œå°‘ä½¿ç”¨unionï¼Œæ³¨æ„è€ƒè™‘å»é‡</h3><ul>
<li>union allä¸å»é‡ï¼Œè€Œå°‘äº†æ’åºæ“ä½œï¼Œé€Ÿåº¦ç›¸å¯¹æ¯”unionè¦å¿«ï¼Œå¦‚æœæ²¡æœ‰å»é‡çš„éœ€æ±‚ï¼Œä¼˜å…ˆä½¿ç”¨union all</li>
<li>å¦‚æœUNIONç»“æœä¸­æœ‰ä½¿ç”¨limitï¼Œåœ¨2ä¸ªå­SQLå¯èƒ½æœ‰è®¸å¤šè¿”å›å€¼çš„æƒ…å†µä¸‹ï¼Œå„è‡ªåŠ ä¸Šlimitã€‚å¦‚æœè¿˜æœ‰order byï¼Œè¯·æ‰¾DBAã€‚</li>
</ul>
<h3 id="INçš„å†…å®¹å°½é‡ä¸è¶…è¿‡200ä¸ª"><a href="#INçš„å†…å®¹å°½é‡ä¸è¶…è¿‡200ä¸ª" class="headerlink" title="INçš„å†…å®¹å°½é‡ä¸è¶…è¿‡200ä¸ª"></a>INçš„å†…å®¹å°½é‡ä¸è¶…è¿‡200ä¸ª</h3><p>è¶…è¿‡500ä¸ªå€¼ä½¿ç”¨æ‰¹é‡çš„æ–¹å¼ï¼Œå¦åˆ™ä¸€æ¬¡æ‰§è¡Œä¼šå½±å“æ•°æ®åº“çš„å¹¶å‘èƒ½åŠ›ï¼Œå› ä¸ºå•SQLåªèƒ½ä¸”ä¸€ç›´å ç”¨å•CPUï¼Œè€Œä¸”å¯èƒ½å¯¼è‡´ä¸»ä»å¤åˆ¶å»¶è¿Ÿ</p>
<h3 id="æ‹’ç»å¤§äº‹åŠ¡"><a href="#æ‹’ç»å¤§äº‹åŠ¡" class="headerlink" title="æ‹’ç»å¤§äº‹åŠ¡"></a>æ‹’ç»å¤§äº‹åŠ¡</h3><p>æ¯”å¦‚åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œè¿›è¡Œå¤šä¸ªselectï¼Œå¤šä¸ªupdateï¼Œå¦‚æœæ˜¯é«˜é¢‘äº‹åŠ¡ï¼Œä¼šä¸¥é‡å½±å“MySQLå¹¶å‘èƒ½åŠ›ï¼Œå› ä¸ºäº‹åŠ¡æŒæœ‰çš„é”ç­‰èµ„æºåªåœ¨äº‹åŠ¡rollback/commitæ—¶æ‰èƒ½é‡Šæ”¾ã€‚ä½†åŒæ—¶ä¹Ÿè¦æƒè¡¡æ•°æ®å†™å…¥çš„ä¸€è‡´æ€§ã€‚</p>
<h3 id="é¿å…ä½¿ç”¨is-null-is-not-nullè¿™æ ·çš„æ¯”è¾ƒ"><a href="#é¿å…ä½¿ç”¨is-null-is-not-nullè¿™æ ·çš„æ¯”è¾ƒ" class="headerlink" title="é¿å…ä½¿ç”¨is null, is not nullè¿™æ ·çš„æ¯”è¾ƒ"></a>é¿å…ä½¿ç”¨is null, is not nullè¿™æ ·çš„æ¯”è¾ƒ</h3><h3 id="order-by-limit"><a href="#order-by-limit" class="headerlink" title="order by .. limit"></a>order by .. limit</h3><p>è¿™ç§æŸ¥è¯¢æ›´å¤šçš„æ˜¯é€šè¿‡ç´¢å¼•å»ä¼˜åŒ–ï¼Œä½†order byçš„å­—æ®µæœ‰è®²ç©¶ï¼Œæ¯”å¦‚ä¸»é”®idä¸f_timeéƒ½æ˜¯é¡ºåºé€’å¢ï¼Œé‚£å°±å¯ä»¥è€ƒè™‘order by idè€Œé f_time ã€‚</p>
<h3 id="c1-lt-a-order-by-c2"><a href="#c1-lt-a-order-by-c2" class="headerlink" title="c1 &lt; a order by c2"></a>c1 &lt; a order by c2</h3><p>ä¸ä¸Šé¢ä¸åŒçš„æ˜¯ï¼Œorder byä¹‹å‰æœ‰ä¸ªèŒƒå›´æŸ¥è¯¢ï¼Œç”±å‰é¢çš„å†…å®¹å¯çŸ¥ï¼Œç”¨ä¸åˆ°ç±»ä¼¼(c1,c2)çš„ç´¢å¼•ï¼Œä½†æ˜¯å¯ä»¥åˆ©ç”¨(c2,c1)ç´¢å¼•ã€‚å¦å¤–è¿˜å¯ä»¥æ”¹å†™æˆjoinçš„æ–¹å¼å®ç°ã€‚</p>
<h3 id="åˆ†é¡µä¼˜åŒ–"><a href="#åˆ†é¡µä¼˜åŒ–" class="headerlink" title="åˆ†é¡µä¼˜åŒ–"></a>åˆ†é¡µä¼˜åŒ–</h3><p>å»ºè®®ä½¿ç”¨åˆç†çš„åˆ†é¡µæ–¹å¼ä»¥æé«˜åˆ†é¡µæ•ˆç‡ï¼Œå¤§é¡µæƒ…å†µä¸‹ä¸ä½¿ç”¨è·³è·ƒå¼åˆ†é¡µ<br>å‡å¦‚æœ‰ç±»ä¼¼ä¸‹é¢åˆ†é¡µè¯­å¥:<br>SELECT FROM table1 ORDER BY ftime DESC LIMIT 10000,10;<br>è¿™ç§åˆ†é¡µæ–¹å¼ä¼šå¯¼è‡´å¤§é‡çš„ioï¼Œå› ä¸ºMySQLä½¿ç”¨çš„æ˜¯æå‰è¯»å–ç­–ç•¥ã€‚<br>æ¨èåˆ†é¡µæ–¹å¼ï¼š<br><code>SELECT FROM table1 WHERE ftime &lt; last_time ORDER BY ftime DESC LIMIT 10</code><br>å³ä¼ å…¥ä¸Šä¸€æ¬¡åˆ†é¡µçš„ç•Œå€¼</p>
<p>SELECT * FROM table as t1 inner JOIN (SELECT id FROM table ORDER BY time LIMIT 10000ï¼Œ10) as t2 ON t1.id=t2.id</p>
<h3 id="countè®¡æ•°"><a href="#countè®¡æ•°" class="headerlink" title="countè®¡æ•°"></a>countè®¡æ•°</h3><ul>
<li>é¦–å…ˆcount()ã€count(1)ã€count(col1)æ˜¯æœ‰åŒºåˆ«çš„ï¼Œcount()è¡¨ç¤ºæ•´ä¸ªç»“æœé›†æœ‰å¤šå°‘æ¡è®°å½•ï¼Œcount(1)è¡¨ç¤ºç»“æœé›†é‡Œä»¥primary keyç»Ÿè®¡æ•°é‡ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹count()ä¸count(1)æ•ˆæœä¸€æ ·çš„ï¼Œä½†count(col1)è¡¨ç¤ºçš„æ˜¯ç»“æœé›†é‡Œ col1 åˆ— NOT null çš„è®°å½•æ•°ã€‚ä¼˜å…ˆé‡‡ç”¨count()</li>
<li>å¤§æ•°æ®é‡countæ˜¯æ¶ˆè€—èµ„æºçš„æ“ä½œï¼Œç”šè‡³ä¼šæ‹–æ…¢æ•´ä¸ªåº“ï¼ŒæŸ¥è¯¢æ€§èƒ½é—®é¢˜æ— æ³•è§£å†³çš„ï¼Œåº”ä»äº§å“è®¾è®¡ä¸Šè¿›è¡Œé‡æ„ã€‚ä¾‹å¦‚å½“é¢‘ç¹éœ€è¦countçš„æŸ¥è¯¢ï¼Œè€ƒè™‘ä½¿ç”¨æ±‡æ€»è¡¨</li>
<li>é‡åˆ°distinctçš„æƒ…å†µï¼Œgroup byæ–¹å¼å¯èƒ½æ•ˆç‡æ›´é«˜ã€‚</li>
</ul>
<h3 id="delete-updateè¯­å¥æ”¹æˆselectå†explain"><a href="#delete-updateè¯­å¥æ”¹æˆselectå†explain" class="headerlink" title="delete,updateè¯­å¥æ”¹æˆselectå†explain"></a>delete,updateè¯­å¥æ”¹æˆselectå†explain</h3><p>selectæœ€å¤šå¯¼è‡´æ•°æ®åº“æ…¢ï¼Œå†™æ“ä½œæ‰æ˜¯é”è¡¨çš„ç½ªé­ç¥¸é¦–</p>
<h3 id="å‡å°‘ä¸æ•°æ®åº“äº¤äº’çš„æ¬¡æ•°ï¼Œå°½é‡é‡‡ç”¨æ‰¹é‡SQLè¯­å¥"><a href="#å‡å°‘ä¸æ•°æ®åº“äº¤äº’çš„æ¬¡æ•°ï¼Œå°½é‡é‡‡ç”¨æ‰¹é‡SQLè¯­å¥" class="headerlink" title="å‡å°‘ä¸æ•°æ®åº“äº¤äº’çš„æ¬¡æ•°ï¼Œå°½é‡é‡‡ç”¨æ‰¹é‡SQLè¯­å¥"></a>å‡å°‘ä¸æ•°æ®åº“äº¤äº’çš„æ¬¡æ•°ï¼Œå°½é‡é‡‡ç”¨æ‰¹é‡SQLè¯­å¥</h3><ul>
<li><code>INSERT ... ON DUPLICATE KEY UPDATE ...</code>ï¼Œæ’å…¥è¡Œåä¼šå¯¼è‡´åœ¨ä¸€ä¸ªUNIQUEç´¢å¼•æˆ–PRIMARY KEYä¸­å‡ºç°é‡å¤å€¼ï¼Œåˆ™æ‰§è¡Œæ—§è¡ŒUPDATEï¼Œå¦‚æœä¸é‡å¤åˆ™ç›´æ¥æ’å…¥ï¼Œå½±å“1è¡Œã€‚</li>
<li><code>REPLACE INTO</code>ç±»ä¼¼ï¼Œä½†å®ƒæ˜¯å†²çªæ—¶åˆ é™¤æ—§è¡Œã€‚<code>INSERT IGNORE</code>ç›¸åï¼Œä¿ç•™æ—§è¡Œï¼Œä¸¢å¼ƒè¦æ’å…¥çš„æ–°è¡Œã€‚</li>
<li>INSERT INTO VALUES(),(),()ï¼Œåˆå¹¶æ’å…¥ã€‚</li>
</ul>
<h3 id="æœç»å±é™©SQL"><a href="#æœç»å±é™©SQL" class="headerlink" title="æœç»å±é™©SQL"></a>æœç»å±é™©SQL</h3><ul>
<li>å»æ‰where 1=1 è¿™æ ·æ— æ„ä¹‰æˆ–æ’çœŸçš„æ¡ä»¶ï¼Œå¦‚æœé‡åˆ°update/deleteæˆ–é­åˆ°sqlæ³¨å…¥å°±ææ€–äº†</li>
<li>SQLä¸­ä¸å…è®¸å‡ºç°DDLè¯­å¥ã€‚ä¸€èˆ¬ä¹Ÿä¸ç»™äºˆcreate/alterè¿™ç±»æƒé™ï¼Œä½†é˜¿é‡Œäº‘RDSåªåŒºåˆ†è¯»å†™ç”¨æˆ·</li>
</ul>
<h2 id="è¡Œä¸ºè§„èŒƒ"><a href="#è¡Œä¸ºè§„èŒƒ" class="headerlink" title="è¡Œä¸ºè§„èŒƒ"></a>è¡Œä¸ºè§„èŒƒ</h2><ul>
<li>ä¸å…è®¸åœ¨DBAä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å¯¼ç°ç½‘æ•°æ®</li>
<li>å¤§æ‰¹é‡æ›´æ–°ï¼Œå¦‚ä¿®å¤æ•°æ®ï¼Œé¿å¼€é«˜å³°æœŸï¼Œå¹¶é€šçŸ¥DBAã€‚ç›´æ¥æ‰§è¡Œsqlçš„ç”±è¿ç»´æˆ–DBAåŒäº‹æ“ä½œ</li>
<li>åŠæ—¶å¤„ç†å·²ä¸‹çº¿ä¸šåŠ¡çš„SQL</li>
<li>å¤æ‚sqlä¸Šçº¿å®¡æ ¸</li>
<li>é‡è¦é¡¹ç›®çš„æ•°æ®åº“æ–¹æ¡ˆé€‰å‹å’Œè®¾è®¡å¿…é¡»æå‰é€šçŸ¥DBAå‚ä¸</li>
</ul>
<hr>
<p>åŸæ–‡åœ°å€ï¼š<a href="http://seanlook.com/" target="_blank" rel="external">http://seanlook.com/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Advanced MySQL Query Tuning]]></title>
      <url>http://team.jiunile.com/blog/2016/07/mysql-mysql-query.html</url>
      <content type="html"><![CDATA[<iframe src="//www.slideshare.net/slideshow/embed_code/key/3HLJJcJmM9KLGT" width="100%" height="550" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" allowfullscreen> </iframe>

<p>Youtube: <a href="https://www.youtube.com/watch?v=TPFibi2G_oo" target="_blank" rel="external">https://www.youtube.com/watch?v=TPFibi2G_oo</a></p>
<p>Percona webinarsä¸Šæœ‰è®¸å¤šç±»ä¼¼çš„åˆ†äº«ï¼Œä¼ é€é—¨ï¼š <a href="https://www.percona.com/resources/webinars" target="_blank" rel="external">https://www.percona.com/resources/webinars</a> ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[nginxé…ç½®locationä¸rewriteè§„åˆ™æ•™ç¨‹]]></title>
      <url>http://team.jiunile.com/blog/2016/07/nginx-localtion-rewrite.html</url>
      <content type="html"><![CDATA[<h2 id="locationæ•™ç¨‹"><a href="#locationæ•™ç¨‹" class="headerlink" title="locationæ•™ç¨‹"></a>locationæ•™ç¨‹</h2><p><strong>ç¤ºä¾‹ï¼š</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">location  = / &#123;</span><br><span class="line">    # ç²¾ç¡®åŒ¹é… / ï¼Œä¸»æœºååé¢ä¸èƒ½å¸¦ä»»ä½•å­—ç¬¦ä¸²</span><br><span class="line">    [ configuration A ] </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location  / &#123;</span><br><span class="line">    # å› ä¸ºæ‰€æœ‰çš„åœ°å€éƒ½ä»¥ / å¼€å¤´ï¼Œæ‰€ä»¥è¿™æ¡è§„åˆ™å°†åŒ¹é…åˆ°æ‰€æœ‰è¯·æ±‚</span><br><span class="line">    # ä½†æ˜¯æ­£åˆ™å’Œæœ€é•¿å­—ç¬¦ä¸²ä¼šä¼˜å…ˆåŒ¹é…</span><br><span class="line">    [ configuration B ] </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /documents/ &#123;</span><br><span class="line">    # åŒ¹é…ä»»ä½•ä»¥ /documents/ å¼€å¤´çš„åœ°å€ï¼ŒåŒ¹é…ç¬¦åˆä»¥åï¼Œè¿˜è¦ç»§ç»­å¾€ä¸‹æœç´¢</span><br><span class="line">    # åªæœ‰åé¢çš„æ­£åˆ™è¡¨è¾¾å¼æ²¡æœ‰åŒ¹é…åˆ°æ—¶ï¼Œè¿™ä¸€æ¡æ‰ä¼šé‡‡ç”¨è¿™ä¸€æ¡</span><br><span class="line">    [ configuration C ] </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ /documents/Abc &#123;</span><br><span class="line">    # åŒ¹é…ä»»ä½•ä»¥ /documents/ å¼€å¤´çš„åœ°å€ï¼ŒåŒ¹é…ç¬¦åˆä»¥åï¼Œè¿˜è¦ç»§ç»­å¾€ä¸‹æœç´¢</span><br><span class="line">    # åªæœ‰åé¢çš„æ­£åˆ™è¡¨è¾¾å¼æ²¡æœ‰åŒ¹é…åˆ°æ—¶ï¼Œè¿™ä¸€æ¡æ‰ä¼šé‡‡ç”¨è¿™ä¸€æ¡</span><br><span class="line">    [ configuration CC ] </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ^~ /images/ &#123;</span><br><span class="line">    # åŒ¹é…ä»»ä½•ä»¥ /images/ å¼€å¤´çš„åœ°å€ï¼ŒåŒ¹é…ç¬¦åˆä»¥åï¼Œåœæ­¢å¾€ä¸‹æœç´¢æ­£åˆ™ï¼Œé‡‡ç”¨è¿™ä¸€æ¡ã€‚</span><br><span class="line">    [ configuration D ] </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~* \.(gif|jpg|jpeg)$ &#123;</span><br><span class="line">    # åŒ¹é…æ‰€æœ‰ä»¥ gif,jpgæˆ–jpeg ç»“å°¾çš„è¯·æ±‚</span><br><span class="line">    # ç„¶è€Œï¼Œæ‰€æœ‰è¯·æ±‚ /images/ ä¸‹çš„å›¾ç‰‡ä¼šè¢« config D å¤„ç†ï¼Œå› ä¸º ^~ åˆ°è¾¾ä¸äº†è¿™ä¸€æ¡æ­£åˆ™</span><br><span class="line">    [ configuration E ] </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /images/ &#123;</span><br><span class="line">    # å­—ç¬¦åŒ¹é…åˆ° /images/ï¼Œç»§ç»­å¾€ä¸‹ï¼Œä¼šå‘ç° ^~ å­˜åœ¨</span><br><span class="line">    [ configuration F ] </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /images/abc &#123;</span><br><span class="line">    # æœ€é•¿å­—ç¬¦åŒ¹é…åˆ° /images/abcï¼Œç»§ç»­å¾€ä¸‹ï¼Œä¼šå‘ç° ^~ å­˜åœ¨</span><br><span class="line">    # Fä¸Gçš„æ”¾ç½®é¡ºåºæ˜¯æ²¡æœ‰å…³ç³»çš„</span><br><span class="line">    [ configuration G ] </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ /images/abc/ &#123;</span><br><span class="line">    # åªæœ‰å»æ‰ config D æ‰æœ‰æ•ˆï¼šå…ˆæœ€é•¿åŒ¹é… config G å¼€å¤´çš„åœ°å€ï¼Œç»§ç»­å¾€ä¸‹æœç´¢ï¼ŒåŒ¹é…åˆ°è¿™ä¸€æ¡æ­£åˆ™ï¼Œé‡‡ç”¨</span><br><span class="line">    [ configuration H ] </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~* /js/.*/\.js</span><br></pre></td></tr></table></figure></p>
<ul>
<li>å·²=å¼€å¤´è¡¨ç¤ºç²¾ç¡®åŒ¹é…<br>å¦‚ A ä¸­åªåŒ¹é…æ ¹ç›®å½•ç»“å°¾çš„è¯·æ±‚ï¼Œåé¢ä¸èƒ½å¸¦ä»»ä½•å­—ç¬¦ä¸²ã€‚</li>
<li>^~ å¼€å¤´è¡¨ç¤ºuriä»¥æŸä¸ªå¸¸è§„å­—ç¬¦ä¸²å¼€å¤´ï¼Œä¸æ˜¯æ­£åˆ™åŒ¹é…</li>
<li>~ å¼€å¤´è¡¨ç¤ºåŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…</li>
<li>~* å¼€å¤´è¡¨ç¤ºä¸åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…</li>
<li>/ é€šç”¨åŒ¹é…, å¦‚æœæ²¡æœ‰å…¶å®ƒåŒ¹é…,ä»»ä½•è¯·æ±‚éƒ½ä¼šåŒ¹é…åˆ°</li>
</ul>
<a id="more"></a>
<p><strong><code>é¡ºåº&amp;&amp;ä¼˜å…ˆçº§</code></strong></p>
<blockquote>
<p>(location =) &gt; (location å®Œæ•´è·¯å¾„) &gt; (location ^~ è·¯å¾„) &gt; (location ~,~* æ­£åˆ™é¡ºåº) &gt; (location éƒ¨åˆ†èµ·å§‹è·¯å¾„) &gt; (/)</p>
</blockquote>
<p>æŒ‰ç…§ä¸Šé¢çš„locationå†™æ³•ï¼Œä»¥ä¸‹çš„åŒ¹é…ç¤ºä¾‹æˆç«‹ï¼š</p>
<ul>
<li><p>/ â€”&gt; config A</p>
<blockquote>
<p>ç²¾ç¡®å®Œå…¨åŒ¹é…ï¼Œå³ä½¿/index.htmlä¹ŸåŒ¹é…ä¸äº†</p>
</blockquote>
</li>
<li><p>/downloads/download.html â€”&gt; config B</p>
<blockquote>
<p>åŒ¹é…Bä»¥åï¼Œå¾€ä¸‹æ²¡æœ‰ä»»ä½•åŒ¹é…ï¼Œé‡‡ç”¨B</p>
</blockquote>
</li>
<li><p>/images/1.gif â€”&gt; configuration D</p>
<blockquote>
<p>åŒ¹é…åˆ°Fï¼Œå¾€ä¸‹åŒ¹é…åˆ°Dï¼Œåœæ­¢å¾€ä¸‹</p>
</blockquote>
</li>
<li><p>/images/abc/def â€”&gt; config D</p>
<blockquote>
<p>æœ€é•¿åŒ¹é…åˆ°Gï¼Œå¾€ä¸‹åŒ¹é…Dï¼Œåœæ­¢å¾€ä¸‹<br>ä½ å¯ä»¥çœ‹åˆ° ä»»ä½•ä»¥/images/å¼€å¤´çš„éƒ½ä¼šåŒ¹é…åˆ°Då¹¶åœæ­¢ï¼ŒFGå†™åœ¨è¿™é‡Œæ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„ï¼ŒHæ˜¯æ°¸è¿œè½®ä¸åˆ°çš„ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†è¯´æ˜åŒ¹é…é¡ºåº</p>
</blockquote>
</li>
<li><p>/documents/document.html â€”&gt; config C</p>
<blockquote>
<p>åŒ¹é…åˆ°Cï¼Œå¾€ä¸‹æ²¡æœ‰ä»»ä½•åŒ¹é…ï¼Œé‡‡ç”¨C</p>
</blockquote>
</li>
<li><p>/documents/1.jpg â€”&gt; configuration E</p>
<blockquote>
<p>åŒ¹é…åˆ°Cï¼Œå¾€ä¸‹æ­£åˆ™åŒ¹é…åˆ°E</p>
</blockquote>
</li>
<li><p>/documents/Abc.jpg â€”&gt; config CC</p>
<blockquote>
<p>æœ€é•¿åŒ¹é…åˆ°Cï¼Œå¾€ä¸‹æ­£åˆ™é¡ºåºåŒ¹é…åˆ°CCï¼Œä¸ä¼šå¾€ä¸‹åˆ°E</p>
</blockquote>
</li>
</ul>
<h3 id="å®é™…ä½¿ç”¨å»ºè®®"><a href="#å®é™…ä½¿ç”¨å»ºè®®" class="headerlink" title="å®é™…ä½¿ç”¨å»ºè®®"></a>å®é™…ä½¿ç”¨å»ºè®®</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">æ‰€ä»¥å®é™…ä½¿ç”¨ä¸­ï¼Œä¸ªäººè§‰å¾—è‡³å°‘æœ‰ä¸‰ä¸ªåŒ¹é…è§„åˆ™å®šä¹‰ï¼Œå¦‚ä¸‹ï¼š</span><br><span class="line">#ç›´æ¥åŒ¹é…ç½‘ç«™æ ¹ï¼Œé€šè¿‡åŸŸåè®¿é—®ç½‘ç«™é¦–é¡µæ¯”è¾ƒé¢‘ç¹ï¼Œä½¿ç”¨è¿™ä¸ªä¼šåŠ é€Ÿå¤„ç†ï¼Œå®˜ç½‘å¦‚æ˜¯è¯´ã€‚</span><br><span class="line">#è¿™é‡Œæ˜¯ç›´æ¥è½¬å‘ç»™åç«¯åº”ç”¨æœåŠ¡å™¨äº†ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªé™æ€é¦–é¡µ</span><br><span class="line"># ç¬¬ä¸€ä¸ªå¿…é€‰è§„åˆ™</span><br><span class="line">location = / &#123;</span><br><span class="line">    proxy_pass http://tomcat:8080/index</span><br><span class="line">&#125;</span><br><span class="line"># ç¬¬äºŒä¸ªå¿…é€‰è§„åˆ™æ˜¯å¤„ç†é™æ€æ–‡ä»¶è¯·æ±‚ï¼Œè¿™æ˜¯nginxä½œä¸ºhttpæœåŠ¡å™¨çš„å¼ºé¡¹</span><br><span class="line"># æœ‰ä¸¤ç§é…ç½®æ¨¡å¼ï¼Œç›®å½•åŒ¹é…æˆ–åç¼€åŒ¹é…,ä»»é€‰å…¶ä¸€æˆ–æ­é…ä½¿ç”¨</span><br><span class="line">location ^~ /static/ &#123;</span><br><span class="line">    root /webroot/static/;</span><br><span class="line">&#125;</span><br><span class="line">location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ &#123;</span><br><span class="line">    root /webroot/res/;</span><br><span class="line">&#125;</span><br><span class="line">#ç¬¬ä¸‰ä¸ªè§„åˆ™å°±æ˜¯é€šç”¨è§„åˆ™ï¼Œç”¨æ¥è½¬å‘åŠ¨æ€è¯·æ±‚åˆ°åç«¯åº”ç”¨æœåŠ¡å™¨</span><br><span class="line">#éé™æ€æ–‡ä»¶è¯·æ±‚å°±é»˜è®¤æ˜¯åŠ¨æ€è¯·æ±‚ï¼Œè‡ªå·±æ ¹æ®å®é™…æŠŠæ¡</span><br><span class="line">#æ¯•ç«Ÿç›®å‰çš„ä¸€äº›æ¡†æ¶çš„æµè¡Œï¼Œå¸¦.php,.jspåç¼€çš„æƒ…å†µå¾ˆå°‘äº†</span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://tomcat:8080/</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Rewriteæ•™ç¨‹"><a href="#Rewriteæ•™ç¨‹" class="headerlink" title="Rewriteæ•™ç¨‹"></a>Rewriteæ•™ç¨‹</h2><p>rewriteåŠŸèƒ½å°±æ˜¯ï¼Œä½¿ç”¨nginxæä¾›çš„å…¨å±€å˜é‡æˆ–è‡ªå·±è®¾ç½®çš„å˜é‡ï¼Œç»“åˆæ­£åˆ™è¡¨è¾¾å¼å’Œæ ‡å¿—ä½å®ç°urlé‡å†™ä»¥åŠé‡å®šå‘ã€‚rewriteåªèƒ½æ”¾åœ¨<code>server{},location{},if{}</code>ä¸­ï¼Œå¹¶ä¸”åªèƒ½å¯¹åŸŸååè¾¹çš„é™¤å»ä¼ é€’çš„å‚æ•°å¤–çš„å­—ç¬¦ä¸²èµ·ä½œç”¨ï¼Œä¾‹å¦‚ <code>http://seanlook.com/a/we/index.php?id=1&amp;u=str</code> åªå¯¹<code>/a/we/index.php</code>é‡å†™ã€‚è¯­æ³•<code>rewrite regex replacement [flag];</code></p>
<p>å¦‚æœç›¸å¯¹åŸŸåæˆ–å‚æ•°å­—ç¬¦ä¸²èµ·ä½œç”¨ï¼Œå¯ä»¥ä½¿ç”¨å…¨å±€å˜é‡åŒ¹é…ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨proxy_passåå‘ä»£ç†ã€‚</p>
<p>è¡¨æ˜çœ‹rewriteå’ŒlocationåŠŸèƒ½æœ‰ç‚¹åƒï¼Œéƒ½èƒ½å®ç°è·³è½¬ï¼Œä¸»è¦åŒºåˆ«åœ¨äºrewriteæ˜¯åœ¨åŒä¸€åŸŸåå†…æ›´æ”¹è·å–èµ„æºçš„è·¯å¾„ï¼Œè€Œlocationæ˜¯å¯¹ä¸€ç±»è·¯å¾„åšæ§åˆ¶è®¿é—®æˆ–åå‘ä»£ç†ï¼Œå¯ä»¥proxy_passåˆ°å…¶ä»–æœºå™¨ã€‚å¾ˆå¤šæƒ…å†µä¸‹rewriteä¹Ÿä¼šå†™åœ¨locationé‡Œï¼Œå®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼š</p>
<ol>
<li>æ‰§è¡Œserverå—çš„rewriteæŒ‡ä»¤</li>
<li>æ‰§è¡ŒlocationåŒ¹é…</li>
<li>æ‰§è¡Œé€‰å®šçš„locationä¸­çš„rewriteæŒ‡ä»¤</li>
</ol>
<p>å¦‚æœå…¶ä¸­æŸæ­¥URIè¢«é‡å†™ï¼Œåˆ™é‡æ–°å¾ªç¯æ‰§è¡Œ1-3ï¼Œç›´åˆ°æ‰¾åˆ°çœŸå®å­˜åœ¨çš„æ–‡ä»¶ï¼›å¾ªç¯è¶…è¿‡10æ¬¡ï¼Œåˆ™è¿”å›500 Internal Server Erroré”™è¯¯ã€‚</p>
<h3 id="flagæ ‡å¿—ä½"><a href="#flagæ ‡å¿—ä½" class="headerlink" title="flagæ ‡å¿—ä½"></a>flagæ ‡å¿—ä½</h3><ul>
<li><code>last</code> : ç›¸å½“äºApacheçš„[L]æ ‡è®°ï¼Œè¡¨ç¤ºå®Œæˆrewrite</li>
<li><code>break</code>: åœæ­¢æ‰§è¡Œå½“å‰è™šæ‹Ÿä¸»æœºçš„åç»­rewriteæŒ‡ä»¤é›†</li>
<li><code>redirect</code> : è¿”å›302ä¸´æ—¶é‡å®šå‘ï¼Œåœ°å€æ ä¼šæ˜¾ç¤ºè·³è½¬åçš„åœ°å€</li>
<li><code>permanent</code> : è¿”å›301æ°¸ä¹…é‡å®šå‘ï¼Œåœ°å€æ ä¼šæ˜¾ç¤ºè·³è½¬åçš„åœ°å€</li>
</ul>
<p>å› ä¸º301å’Œ302ä¸èƒ½ç®€å•çš„åªè¿”å›çŠ¶æ€ç ï¼Œè¿˜å¿…é¡»æœ‰é‡å®šå‘çš„URLï¼Œè¿™å°±æ˜¯returnæŒ‡ä»¤æ— æ³•è¿”å›301,302çš„åŸå› äº†ã€‚è¿™é‡Œ last å’Œ break åŒºåˆ«æœ‰ç‚¹éš¾ä»¥ç†è§£ï¼š</p>
<ol>
<li>lastä¸€èˆ¬å†™åœ¨serverå’Œifä¸­ï¼Œè€Œbreakä¸€èˆ¬ä½¿ç”¨åœ¨locationä¸­</li>
<li>lastä¸ç»ˆæ­¢é‡å†™åçš„urlåŒ¹é…ï¼Œå³æ–°çš„urlä¼šå†ä»serverèµ°ä¸€éåŒ¹é…æµç¨‹ï¼Œè€Œbreakç»ˆæ­¢é‡å†™åçš„åŒ¹é…</li>
<li>breakå’Œlastéƒ½èƒ½ç»„ç»‡ç»§ç»­æ‰§è¡Œåé¢çš„rewriteæŒ‡ä»¤</li>
</ol>
<h3 id="ifæŒ‡ä»¤ä¸å…¨å±€å˜é‡"><a href="#ifæŒ‡ä»¤ä¸å…¨å±€å˜é‡" class="headerlink" title="ifæŒ‡ä»¤ä¸å…¨å±€å˜é‡"></a>ifæŒ‡ä»¤ä¸å…¨å±€å˜é‡</h3><p><strong>ifåˆ¤æ–­æŒ‡ä»¤</strong><br>è¯­æ³•ä¸º<code>if(condition){...}</code>ï¼Œå¯¹ç»™å®šçš„æ¡ä»¶conditionè¿›è¡Œåˆ¤æ–­ã€‚å¦‚æœä¸ºçœŸï¼Œå¤§æ‹¬å·å†…çš„rewriteæŒ‡ä»¤å°†è¢«æ‰§è¡Œï¼Œifæ¡ä»¶(conditon)å¯ä»¥æ˜¯å¦‚ä¸‹ä»»ä½•å†…å®¹ï¼š</p>
<ul>
<li>å½“è¡¨è¾¾å¼åªæ˜¯ä¸€ä¸ªå˜é‡æ—¶ï¼Œå¦‚æœå€¼ä¸ºç©ºæˆ–ä»»ä½•ä»¥0å¼€å¤´çš„å­—ç¬¦ä¸²éƒ½ä¼šå½“åšfalse</li>
<li>ç›´æ¥æ¯”è¾ƒå˜é‡å’Œå†…å®¹æ—¶ï¼Œä½¿ç”¨<code>=</code>æˆ–<code>!=</code></li>
<li><code>~</code>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œ<code>~*</code>ä¸åŒºåˆ†å¤§å°å†™çš„åŒ¹é…ï¼Œ<code>!~</code>åŒºåˆ†å¤§å°å†™çš„ä¸åŒ¹é…</li>
<li><code>-f</code>å’Œ<code>!-f</code>ç”¨æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ–‡ä»¶</li>
<li><code>-d</code>å’Œ<code>!-d</code>ç”¨æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç›®å½•</li>
<li><code>-e</code>å’Œ<code>!-e</code>ç”¨æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ–‡ä»¶æˆ–ç›®å½•</li>
<li><code>-x</code>å’Œ<code>!-x</code>ç”¨æ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œ</li>
</ul>
<p><strong>ä¾‹å¦‚ï¼š</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">if ($http_user_agent ~ MSIE) &#123;</span><br><span class="line">    rewrite ^(.*)$ /msie/$1 break;</span><br><span class="line">&#125; #å¦‚æœUAåŒ…å«"MSIE"ï¼Œrewriteè¯·æ±‚åˆ°/msid/ç›®å½•ä¸‹</span><br><span class="line"></span><br><span class="line">if ($http_cookie ~* "id=([^;]+)(?:;|$)") &#123;</span><br><span class="line">    set $id $1;</span><br><span class="line"> &#125; #å¦‚æœcookieåŒ¹é…æ­£åˆ™ï¼Œè®¾ç½®å˜é‡$idç­‰äºæ­£åˆ™å¼•ç”¨éƒ¨åˆ†</span><br><span class="line"></span><br><span class="line">if ($request_method = POST) &#123;</span><br><span class="line">    return 405;</span><br><span class="line">&#125; #å¦‚æœæäº¤æ–¹æ³•ä¸ºPOSTï¼Œåˆ™è¿”å›çŠ¶æ€405ï¼ˆMethod not allowedï¼‰ã€‚returnä¸èƒ½è¿”å›301,302</span><br><span class="line"></span><br><span class="line">if ($slow) &#123;</span><br><span class="line">    limit_rate 10k;</span><br><span class="line">&#125; #é™é€Ÿï¼Œ$slowå¯ä»¥é€šè¿‡ set æŒ‡ä»¤è®¾ç½®</span><br><span class="line"></span><br><span class="line">if (!-f $request_filename)&#123;</span><br><span class="line">    break;</span><br><span class="line">    proxy_pass  http://127.0.0.1; </span><br><span class="line">&#125; #å¦‚æœè¯·æ±‚çš„æ–‡ä»¶åä¸å­˜åœ¨ï¼Œåˆ™åå‘ä»£ç†åˆ°localhost ã€‚è¿™é‡Œçš„breakä¹Ÿæ˜¯åœæ­¢rewriteæ£€æŸ¥</span><br><span class="line"></span><br><span class="line">if ($args ~ post=140)&#123;</span><br><span class="line">    rewrite ^ http://example.com/ permanent;</span><br><span class="line">&#125; #å¦‚æœquery stringä¸­åŒ…å«"post=140"ï¼Œæ°¸ä¹…é‡å®šå‘åˆ°example.com</span><br><span class="line"></span><br><span class="line">location ~* \.(gif|jpg|png|swf|flv)$ &#123;</span><br><span class="line">    valid_referers none blocked www.jefflei.com www.leizhenfang.com;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        return 404;</span><br><span class="line">    &#125; #é˜²ç›—é“¾</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>å…¨å±€å˜é‡</strong><br>ä¸‹é¢æ˜¯å¯ä»¥ç”¨ä½œifåˆ¤æ–­çš„å…¨å±€å˜é‡</p>
<ul>
<li><code>$args</code>ï¼š #è¿™ä¸ªå˜é‡ç­‰äºè¯·æ±‚è¡Œä¸­çš„å‚æ•°ï¼ŒåŒ<code>$query_string</code></li>
<li><code>$content_length</code> ï¼š è¯·æ±‚å¤´ä¸­çš„Content-lengthå­—æ®µã€‚</li>
<li><code>$content_type</code> ï¼š è¯·æ±‚å¤´ä¸­çš„Content-Typeå­—æ®µã€‚</li>
<li><code>$document_root</code> ï¼š å½“å‰è¯·æ±‚åœ¨rootæŒ‡ä»¤ä¸­æŒ‡å®šçš„å€¼ã€‚</li>
<li><code>$host</code> ï¼š è¯·æ±‚ä¸»æœºå¤´å­—æ®µï¼Œå¦åˆ™ä¸ºæœåŠ¡å™¨åç§°ã€‚</li>
<li><code>$http_user_agent</code> ï¼š å®¢æˆ·ç«¯agentä¿¡æ¯</li>
<li><code>$http_cookie</code> ï¼š å®¢æˆ·ç«¯cookieä¿¡æ¯</li>
<li><code>$limit_rate</code> ï¼š è¿™ä¸ªå˜é‡å¯ä»¥é™åˆ¶è¿æ¥é€Ÿç‡ã€‚</li>
<li><code>$request_method</code> ï¼š å®¢æˆ·ç«¯è¯·æ±‚çš„åŠ¨ä½œï¼Œé€šå¸¸ä¸ºGETæˆ–POSTã€‚</li>
<li><code>$remote_addr</code> ï¼š å®¢æˆ·ç«¯çš„IPåœ°å€ã€‚</li>
<li><code>$remote_port</code> ï¼š å®¢æˆ·ç«¯çš„ç«¯å£ã€‚</li>
<li><code>$remote_user</code> ï¼š å·²ç»ç»è¿‡Auth Basic ModuleéªŒè¯çš„ç”¨æˆ·åã€‚</li>
<li><code>$request_filename</code> ï¼š å½“å‰è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„ï¼Œç”±rootæˆ–aliasæŒ‡ä»¤ä¸URIè¯·æ±‚ç”Ÿæˆã€‚</li>
<li><code>$scheme</code> ï¼š HTTPæ–¹æ³•ï¼ˆå¦‚httpï¼Œhttpsï¼‰ã€‚</li>
<li><code>$server_protocol</code> ï¼š è¯·æ±‚ä½¿ç”¨çš„åè®®ï¼Œé€šå¸¸æ˜¯HTTP/1.0æˆ–HTTP/1.1ã€‚</li>
<li><code>$server_addr</code> ï¼š æœåŠ¡å™¨åœ°å€ï¼Œåœ¨å®Œæˆä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨åå¯ä»¥ç¡®å®šè¿™ä¸ªå€¼ã€‚</li>
<li><code>$server_name</code> ï¼š æœåŠ¡å™¨åç§°ã€‚</li>
<li><code>$server_port</code> ï¼š è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨çš„ç«¯å£å·ã€‚</li>
<li><code>$request_uri</code> ï¼š åŒ…å«è¯·æ±‚å‚æ•°çš„åŸå§‹URIï¼Œä¸åŒ…å«ä¸»æœºåï¼Œå¦‚ï¼šâ€/foo/bar.php?arg=bazâ€ã€‚</li>
<li><code>$uri</code> ï¼š ä¸å¸¦è¯·æ±‚å‚æ•°çš„å½“å‰URIï¼Œ$uriä¸åŒ…å«ä¸»æœºåï¼Œå¦‚â€/foo/bar.htmlâ€ã€‚</li>
<li><code>$document_uri</code> ï¼š ä¸$uriç›¸åŒã€‚</li>
</ul>
<p>ç¤ºä¾‹ï¼š<code>http://localhost:88/test1/test2/test.php</code></p>
<ul>
<li><code>$host</code>ï¼šlocalhost</li>
<li><code>$server_port</code>ï¼š88</li>
<li><code>$request_uri</code>ï¼š<a href="http://localhost:88/test1/test2/test.php" target="_blank" rel="external">http://localhost:88/test1/test2/test.php</a></li>
<li><code>$document_uri</code>ï¼š/test1/test2/test.php</li>
<li><code>$document_root</code>ï¼š/var/www/html</li>
<li><code>$request_filename</code>ï¼š/var/www/html/test1/test2/test.php</li>
</ul>
<h3 id="å¸¸ç”¨æ­£åˆ™"><a href="#å¸¸ç”¨æ­£åˆ™" class="headerlink" title="å¸¸ç”¨æ­£åˆ™"></a>å¸¸ç”¨æ­£åˆ™</h3><ul>
<li><code>.</code> ï¼š åŒ¹é…é™¤æ¢è¡Œç¬¦ä»¥å¤–çš„ä»»æ„å­—ç¬¦</li>
<li><code>?</code> ï¼š é‡å¤0æ¬¡æˆ–1æ¬¡</li>
<li><code>+</code> ï¼š é‡å¤1æ¬¡æˆ–æ›´å¤šæ¬¡</li>
<li><code>*</code> ï¼š é‡å¤0æ¬¡æˆ–æ›´å¤šæ¬¡</li>
<li><code>\d</code> ï¼šåŒ¹é…æ•°å­—</li>
<li><code>^</code> ï¼š åŒ¹é…å­—ç¬¦ä¸²çš„å¼€å§‹</li>
<li><code>$</code> ï¼š åŒ¹é…å­—ç¬¦ä¸²çš„ä»‹ç»</li>
<li><code>{n}</code> ï¼š é‡å¤næ¬¡</li>
<li><code>{n,}</code> ï¼š é‡å¤næ¬¡æˆ–æ›´å¤šæ¬¡</li>
<li><code>[c]</code> ï¼š åŒ¹é…å•ä¸ªå­—ç¬¦c</li>
<li><code>[a-z]</code> ï¼š åŒ¹é…a-zå°å†™å­—æ¯çš„ä»»æ„ä¸€ä¸ª</li>
</ul>
<p>å°æ‹¬å·<code>()</code>ä¹‹é—´åŒ¹é…çš„å†…å®¹ï¼Œå¯ä»¥åœ¨åé¢é€šè¿‡<code>$1</code>æ¥å¼•ç”¨ï¼Œ<code>$2</code>è¡¨ç¤ºçš„æ˜¯å‰é¢ç¬¬äºŒä¸ª<code>()</code>é‡Œçš„å†…å®¹ã€‚æ­£åˆ™é‡Œé¢å®¹æ˜“è®©äººå›°æƒ‘çš„æ˜¯<code>\</code>è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ã€‚</p>
<h3 id="rewriteå®ä¾‹"><a href="#rewriteå®ä¾‹" class="headerlink" title="rewriteå®ä¾‹"></a>rewriteå®ä¾‹</h3><p><strong>ä¾‹1ï¼š</strong><br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># å®šä¹‰imageæ—¥å¿—æ ¼å¼</span></span><br><span class="line">    <span class="attribute">log_format</span> imagelog <span class="string">'[<span class="variable">$time_local</span>] '</span> <span class="variable">$image_file</span> <span class="string">' '</span> <span class="variable">$image_type</span> <span class="string">' '</span> <span class="variable">$body_bytes_sent</span> <span class="string">' '</span> <span class="variable">$status</span>;</span><br><span class="line">    <span class="comment"># å¼€å¯é‡å†™æ—¥å¿—</span></span><br><span class="line">    <span class="attribute">rewrite_log</span> <span class="literal">on</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">root</span> /home/www;</span><br><span class="line"> </span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">                <span class="comment"># é‡å†™è§„åˆ™ä¿¡æ¯</span></span><br><span class="line">                <span class="attribute">error_log</span> logs/rewrite.log <span class="literal">notice</span>; </span><br><span class="line">                <span class="comment"># æ³¨æ„è¿™é‡Œè¦ç”¨â€˜â€™å•å¼•å·å¼•èµ·æ¥ï¼Œé¿å…&#123;&#125;</span></span><br><span class="line">                <span class="attribute">rewrite</span> <span class="string">'^/images/([a-z]&#123;2&#125;)/([a-z0-9]&#123;5&#125;)/(.*)\.(png|jpg|gif)$'</span> /data?file=<span class="variable">$3</span>.<span class="variable">$4</span>;</span><br><span class="line">                <span class="comment"># æ³¨æ„ä¸èƒ½åœ¨ä¸Šé¢è¿™æ¡è§„åˆ™åé¢åŠ ä¸Šâ€œlastâ€å‚æ•°ï¼Œå¦åˆ™ä¸‹é¢çš„setæŒ‡ä»¤ä¸ä¼šæ‰§è¡Œ</span></span><br><span class="line">                <span class="attribute">set</span> <span class="variable">$image_file</span> <span class="variable">$3</span>;</span><br><span class="line">                <span class="attribute">set</span> <span class="variable">$image_type</span> <span class="variable">$4</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="attribute">location</span> /data &#123;</span><br><span class="line">                <span class="comment"># æŒ‡å®šé’ˆå¯¹å›¾ç‰‡çš„æ—¥å¿—æ ¼å¼ï¼Œæ¥åˆ†æå›¾ç‰‡ç±»å‹å’Œå¤§å°</span></span><br><span class="line">                <span class="attribute">access_log</span> logs/images.log mian;</span><br><span class="line">                <span class="attribute">root</span> /data/images;</span><br><span class="line">                <span class="comment"># åº”ç”¨å‰é¢å®šä¹‰çš„å˜é‡ã€‚åˆ¤æ–­é¦–å…ˆæ–‡ä»¶åœ¨ä¸åœ¨ï¼Œä¸åœ¨å†åˆ¤æ–­ç›®å½•åœ¨ä¸åœ¨ï¼Œå¦‚æœè¿˜ä¸åœ¨å°±è·³è½¬åˆ°æœ€åä¸€ä¸ªurlé‡Œ</span></span><br><span class="line">                <span class="attribute">try_files</span> /<span class="variable">$arg_file</span> /image404.html;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attribute">location</span> = /image404.html &#123;</span><br><span class="line">                <span class="comment"># å›¾ç‰‡ä¸å­˜åœ¨è¿”å›ç‰¹å®šçš„ä¿¡æ¯</span></span><br><span class="line">                <span class="attribute">return</span> <span class="number">404</span> <span class="string">"image not found\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯¹å½¢å¦‚<code>/images/ef/uh7b3/test.png</code>çš„è¯·æ±‚ï¼Œé‡å†™åˆ°<code>/data?file=test.png</code>ï¼Œäºæ˜¯åŒ¹é…åˆ°<code>location /data</code>ï¼Œå…ˆçœ‹<code>/data/images/test.png</code>æ–‡ä»¶å­˜ä¸å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æ­£å¸¸å“åº”ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é‡å†™<code>tryfiles</code>åˆ°æ–°çš„<code>image404 location</code>ï¼Œç›´æ¥è¿”å›404çŠ¶æ€ç ã€‚</p>
<p><strong>ä¾‹2ï¼š</strong><br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^/images/(.*)_(\d+)x(\d+)\.(png|jpg|gif)$</span> /resizer/<span class="variable">$1</span>.<span class="variable">$4</span>?width=<span class="variable">$2</span>&amp;height=<span class="variable">$3</span>? <span class="literal">last</span>;</span><br></pre></td></tr></table></figure></p>
<p>å¯¹å½¢å¦‚<code>/images/bla_500x400.jpg</code>çš„æ–‡ä»¶è¯·æ±‚ï¼Œé‡å†™åˆ°<code>/resizer/bla.jpg?width=500&amp;height=400</code>åœ°å€ï¼Œå¹¶ä¼šç»§ç»­å°è¯•åŒ¹é…locationã€‚</p>
<hr>
<p>æ¥æºï¼š<a href="http://seanlook.com/" target="_blank" rel="external">http://seanlook.com/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQLäº‹åŠ¡éš”ç¦»çº§åˆ«]]></title>
      <url>http://team.jiunile.com/blog/2016/07/mysql-mysql-transaction-level.html</url>
      <content type="html"><![CDATA[<h2 id="å››ç±»éš”ç¦»çº§åˆ«"><a href="#å››ç±»éš”ç¦»çº§åˆ«" class="headerlink" title="å››ç±»éš”ç¦»çº§åˆ«"></a>å››ç±»éš”ç¦»çº§åˆ«</h2><p>SQLæ ‡å‡†å®šä¹‰äº†4ç±»éš”ç¦»çº§åˆ«ï¼ŒåŒ…æ‹¬äº†ä¸€äº›å…·ä½“è§„åˆ™ï¼Œç”¨æ¥é™å®šäº‹åŠ¡å†…å¤–çš„å“ªäº›æ”¹å˜æ˜¯å¯è§çš„ï¼Œå“ªäº›æ˜¯ä¸å¯è§çš„ã€‚ä½çº§åˆ«çš„éš”ç¦»çº§ä¸€èˆ¬æ”¯æŒæ›´é«˜çš„å¹¶å‘å¤„ç†ï¼Œå¹¶æ‹¥æœ‰æ›´ä½çš„ç³»ç»Ÿå¼€é”€ã€‚</p>
<ul>
<li>Read Uncommittedï¼ˆè¯»å–æœªæäº¤å†…å®¹ï¼‰</li>
</ul>
<p>åœ¨è¯¥éš”ç¦»çº§åˆ«ï¼Œæ‰€æœ‰äº‹åŠ¡éƒ½å¯ä»¥çœ‹åˆ°å…¶ä»–æœªæäº¤äº‹åŠ¡çš„æ‰§è¡Œç»“æœã€‚æœ¬éš”ç¦»çº§åˆ«å¾ˆå°‘ç”¨äºå®é™…åº”ç”¨ï¼Œå› ä¸ºå®ƒçš„æ€§èƒ½ä¹Ÿä¸æ¯”å…¶ä»–çº§åˆ«å¥½å¤šå°‘ã€‚è¯»å–æœªæäº¤çš„æ•°æ®ï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸ºè„è¯»ï¼ˆDirty Readï¼‰ã€‚ </p>
<ul>
<li>Read Committedï¼ˆè¯»å–æäº¤å†…å®¹ï¼‰</li>
</ul>
<p>è¿™æ˜¯å¤§å¤šæ•°æ•°æ®åº“ç³»ç»Ÿçš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼ˆä½†ä¸æ˜¯MySQLé»˜è®¤çš„ï¼‰ã€‚å®ƒæ»¡è¶³äº†éš”ç¦»çš„ç®€å•å®šä¹‰ï¼šä¸€ä¸ªäº‹åŠ¡åªèƒ½çœ‹è§å·²ç»æäº¤äº‹åŠ¡æ‰€åšçš„æ”¹å˜ã€‚è¿™ç§éš”ç¦»çº§åˆ« ä¹Ÿæ”¯æŒæ‰€è°“çš„ä¸å¯é‡å¤è¯»ï¼ˆNonrepeatable Readï¼‰ï¼Œå› ä¸ºåŒä¸€äº‹åŠ¡çš„å…¶ä»–å®ä¾‹åœ¨è¯¥å®ä¾‹å¤„ç†å…¶é—´å¯èƒ½ä¼šæœ‰æ–°çš„commitï¼Œæ‰€ä»¥åŒä¸€selectå¯èƒ½è¿”å›ä¸åŒç»“æœã€‚</p>
<ul>
<li>Repeatable Readï¼ˆå¯é‡è¯»ï¼‰</li>
</ul>
<p>è¿™æ˜¯MySQLçš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œå®ƒç¡®ä¿åŒä¸€äº‹åŠ¡çš„å¤šä¸ªå®ä¾‹åœ¨å¹¶å‘è¯»å–æ•°æ®æ—¶ï¼Œä¼šçœ‹åˆ°åŒæ ·çš„æ•°æ®è¡Œã€‚ä¸è¿‡ç†è®ºä¸Šï¼Œè¿™ä¼šå¯¼è‡´å¦ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼šå¹»è¯» ï¼ˆPhantom Readï¼‰ã€‚ç®€å•çš„è¯´ï¼Œå¹»è¯»æŒ‡å½“ç”¨æˆ·è¯»å–æŸä¸€èŒƒå›´çš„æ•°æ®è¡Œæ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡åˆåœ¨è¯¥èŒƒå›´å†…æ’å…¥äº†æ–°è¡Œï¼Œå½“ç”¨æˆ·å†è¯»å–è¯¥èŒƒå›´çš„æ•°æ®è¡Œæ—¶ï¼Œä¼šå‘ç°æœ‰æ–°çš„â€œå¹»å½±â€ è¡Œã€‚InnoDBå’ŒFalconå­˜å‚¨å¼•æ“é€šè¿‡å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼ŒMultiversion Concurrency Controlï¼‰æœºåˆ¶è§£å†³äº†è¯¥é—®é¢˜ã€‚</p>
<ul>
<li>Serializableï¼ˆå¯ä¸²è¡ŒåŒ–ï¼‰</li>
</ul>
<p>è¿™æ˜¯æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®ƒé€šè¿‡å¼ºåˆ¶äº‹åŠ¡æ’åºï¼Œä½¿ä¹‹ä¸å¯èƒ½ç›¸äº’å†²çªï¼Œä»è€Œè§£å†³å¹»è¯»é—®é¢˜ã€‚ç®€è¨€ä¹‹ï¼Œå®ƒæ˜¯åœ¨æ¯ä¸ªè¯»çš„æ•°æ®è¡Œä¸ŠåŠ ä¸Šå…±äº«é”ã€‚åœ¨è¿™ä¸ªçº§åˆ«ï¼Œå¯èƒ½å¯¼è‡´å¤§é‡çš„è¶…æ—¶ç°è±¡å’Œé”ç«äº‰ã€‚<br><a id="more"></a></p>
<h2 id="éš”ç¦»çº§åˆ«ä¸ä¸€è‡´æ€§"><a href="#éš”ç¦»çº§åˆ«ä¸ä¸€è‡´æ€§" class="headerlink" title="éš”ç¦»çº§åˆ«ä¸ä¸€è‡´æ€§"></a>éš”ç¦»çº§åˆ«ä¸ä¸€è‡´æ€§</h2><p>è¿™å››ç§éš”ç¦»çº§åˆ«é‡‡å–ä¸åŒçš„é”ç±»å‹æ¥å®ç°ï¼Œè‹¥è¯»å–çš„æ˜¯åŒä¸€ä¸ªæ•°æ®çš„è¯ï¼Œå°±å®¹æ˜“å‘ç”Ÿé—®é¢˜ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>è„è¯»(Drity Read)ï¼šæŸä¸ªäº‹åŠ¡å·²æ›´æ–°ä¸€ä»½æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡åœ¨æ­¤æ—¶è¯»å–äº†åŒä¸€ä»½æ•°æ®ï¼Œç”±äºæŸäº›åŸå› ï¼Œå‰ä¸€ä¸ªRollBackäº†æ“ä½œï¼Œåˆ™åä¸€ä¸ªäº‹åŠ¡æ‰€è¯»å–çš„æ•°æ®å°±ä¼šæ˜¯ä¸æ­£ç¡®çš„ã€‚</li>
<li>ä¸å¯é‡å¤è¯»(Non-repeatable read):åœ¨ä¸€ä¸ªäº‹åŠ¡çš„ä¸¤æ¬¡æŸ¥è¯¢ä¹‹ä¸­æ•°æ®ä¸ä¸€è‡´ï¼Œè¿™å¯èƒ½æ˜¯ä¸¤æ¬¡æŸ¥è¯¢è¿‡ç¨‹ä¸­é—´æ’å…¥äº†ä¸€ä¸ªäº‹åŠ¡æ›´æ–°çš„åŸæœ‰çš„æ•°æ®ã€‚</li>
<li>å¹»è¯»(Phantom Read):åœ¨ä¸€ä¸ªäº‹åŠ¡çš„ä¸¤æ¬¡æŸ¥è¯¢ä¸­æ•°æ®ç¬”æ•°ä¸ä¸€è‡´ï¼Œä¾‹å¦‚æœ‰ä¸€ä¸ªäº‹åŠ¡æŸ¥è¯¢äº†å‡ åˆ—(Row)æ•°æ®ï¼Œè€Œå¦ä¸€ä¸ªäº‹åŠ¡å´åœ¨æ­¤æ—¶æ’å…¥äº†æ–°çš„å‡ åˆ—æ•°æ®ï¼Œå…ˆå‰çš„äº‹åŠ¡åœ¨æ¥ä¸‹æ¥çš„æŸ¥è¯¢ä¸­ï¼Œå°±ä¼šå‘ç°æœ‰å‡ åˆ—æ•°æ®æ˜¯å®ƒå…ˆå‰æ‰€æ²¡æœ‰çš„ã€‚</li>
</ul>
<p>åœ¨MySQLä¸­ï¼Œå®ç°äº†è¿™å››ç§éš”ç¦»çº§åˆ«ï¼Œåˆ†åˆ«æœ‰å¯èƒ½äº§ç”Ÿé—®é¢˜å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">éš”ç¦»çº§åˆ«</th>
<th style="text-align:left">è„è¯»</th>
<th style="text-align:left">ä¸å¯é‡å¤è¯»</th>
<th style="text-align:left">å¹»è¯»</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">è¯»æœªæäº¤(Read Uncommitted)</td>
<td style="text-align:left">yes</td>
<td style="text-align:left">yes</td>
<td style="text-align:left">yes</td>
</tr>
<tr>
<td style="text-align:left">è¯»å·²æäº¤(Read Committed)</td>
<td style="text-align:left">no</td>
<td style="text-align:left">yes</td>
<td style="text-align:left">yes</td>
</tr>
<tr>
<td style="text-align:left">å¯é‡å¤è¯»(Repeatable Read)</td>
<td style="text-align:left">no</td>
<td style="text-align:left">no</td>
<td style="text-align:left">yes</td>
</tr>
<tr>
<td style="text-align:left">å¯ä¸²è¡ŒåŒ–(Serializable)</td>
<td style="text-align:left">no</td>
<td style="text-align:left">no</td>
<td style="text-align:left">no</td>
</tr>
</tbody>
</table>
<h2 id="è®¾ç½®å½“å‰éš”ç¦»çº§åˆ«"><a href="#è®¾ç½®å½“å‰éš”ç¦»çº§åˆ«" class="headerlink" title="è®¾ç½®å½“å‰éš”ç¦»çº§åˆ«"></a>è®¾ç½®å½“å‰éš”ç¦»çº§åˆ«</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å–æ¶ˆautocommit</span></span><br><span class="line"><span class="keyword">set</span> autocommit=<span class="number">0</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">"%autocommit%"</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">-- æŸ¥çœ‹éš”ç¦»çº§åˆ«</span></span><br><span class="line"><span class="keyword">SELECT</span> @@global.tx_isolation;</span><br><span class="line"><span class="keyword">SELECT</span> @@session.tx_isolation;</span><br><span class="line"><span class="keyword">SELECT</span> @@tx_isolation;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'%iso%'</span>;</span><br><span class="line">+<span class="comment">---------------+-----------------+</span></span><br><span class="line">| Variable_name | Value           |</span><br><span class="line">+<span class="comment">---------------+-----------------+</span></span><br><span class="line">| tx_isolation  | REPEATABLE-READ |</span><br><span class="line">+<span class="comment">---------------+-----------------+</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'%iso%'</span>;</span><br><span class="line">+<span class="comment">---------------+-----------------+</span></span><br><span class="line">| Variable_name | Value           |</span><br><span class="line">+<span class="comment">---------------+-----------------+</span></span><br><span class="line">| tx_isolation  | REPEATABLE-READ |</span><br><span class="line">+<span class="comment">---------------+-----------------+</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">-- è®¾ç½®éš”ç¦»çº§åˆ«</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">SESSION</span> <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> <span class="keyword">read</span> uncommitted;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">SESSION</span> <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> <span class="keyword">read</span> committed;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">SESSION</span> <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> repeatable <span class="keyword">read</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">SESSION</span> <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> <span class="keyword">serializable</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">-- äº‹åŠ¡æ“ä½œ</span></span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> text.tx;</span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> text.tx;</span><br><span class="line"><span class="keyword">update</span> text.tx <span class="keyword">set</span> <span class="keyword">num</span> =<span class="number">10</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> text.tx(<span class="keyword">id</span>,<span class="keyword">num</span>) <span class="keyword">values</span>(<span class="number">9</span>,<span class="number">9</span>);</span><br><span class="line"><span class="keyword">rollback</span>;</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>
<h2 id="my-cnfè®¾ç½®"><a href="#my-cnfè®¾ç½®" class="headerlink" title="my.cnfè®¾ç½®"></a>my.cnfè®¾ç½®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MySQLæ”¯æŒ4ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯ï¼š</span></span><br><span class="line"><span class="comment"># READ-UNCOMMITTED, READ-COMMITTED, REPEATABLE-READ, SERIALIZABLE.</span></span><br><span class="line"><span class="comment"># å¦‚æ²¡æœ‰æŒ‡å®šï¼ŒMySQLé»˜è®¤é‡‡ç”¨çš„æ˜¯REPEATABLE-READï¼ŒORACLEé»˜è®¤çš„æ˜¯READ-COMMITTED</span></span><br><span class="line">transaction_isolation = REPEATABLE-READ</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQLä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ªè‡ªå¢ä¸»é”®]]></title>
      <url>http://team.jiunile.com/blog/2016/07/mysql-mysql-auto-increment-primary-key.html</url>
      <content type="html"><![CDATA[<h2 id="ä¸»é”®"><a href="#ä¸»é”®" class="headerlink" title="ä¸»é”®"></a>ä¸»é”®</h2><p>è¡¨ä¸­æ¯ä¸€è¡Œéƒ½åº”è¯¥æœ‰å¯ä»¥å”¯ä¸€æ ‡è¯†è‡ªå·±çš„ä¸€åˆ—ï¼ˆæˆ–ä¸€ç»„åˆ—ï¼‰ã€‚</p>
<p>ä¸€ä¸ªé¡¾å®¢å¯ä»¥ä½¿ç”¨é¡¾å®¢ç¼–å·åˆ—ï¼Œè€Œè®¢å•å¯ä»¥ä½¿ç”¨è®¢å•IDï¼Œé›‡å‘˜å¯ä»¥ä½¿ç”¨é›‡å‘˜ID æˆ– é›‡å‘˜ç¤¾ä¼šä¿é™©å·ã€‚</p>
<p>ä¸»é”®ï¼ˆprimary keyï¼‰ ä¸€åˆ—ï¼ˆæˆ–ä¸€ç»„åˆ—ï¼‰ï¼Œå…¶å€¼èƒ½å¤Ÿå”¯ä¸€åŒºåˆ†è¡¨ä¸­çš„æ¯ä¸ªè¡Œã€‚<br>å”¯ä¸€æ ‡è¯†è¡¨ä¸­æ¯è¡Œçš„è¿™ä¸ªåˆ—ï¼ˆæˆ–è¿™ç»„åˆ—ï¼‰ç§°ä¸ºä¸»é”®ã€‚<strong><code>æ²¡æœ‰ä¸»é”®ï¼Œæ›´æ–°æˆ–åˆ é™¤è¡¨ä¸­ç‰¹å®šè¡Œå¾ˆå›°éš¾ï¼Œå› ä¸ºæ²¡æœ‰å®‰å…¨çš„æ–¹æ³•ä¿è¯åªæ¶‰åŠç›¸å…³çš„è¡Œã€‚</code></strong></p>
<p>è™½ç„¶å¹¶ä¸æ€»æ˜¯éƒ½éœ€è¦ä¸»é”®ï¼Œä½†å¤§å¤šæ•°æ•°æ®åº“è®¾è®¡äººå‘˜éƒ½åº”ä¿è¯ä»–ä»¬åˆ›å»ºçš„æ¯ä¸ªè¡¨æœ‰ä¸€ä¸ªä¸»é”®ï¼Œä»¥ä¾¿äºä»¥åæ•°æ®æ“çºµå’Œç®¡ç†</p>
<p>è¡¨ä¸­çš„ä»»ä½•åˆ—éƒ½å¯ä»¥ä½œä¸ºä¸»é”®ï¼Œåªè¦å®ƒæ»¡è¶³ä¸€ä¸‹æ¡ä»¶:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä»»ä½•ä¸¤è¡Œéƒ½ä¸å…·æœ‰ç›¸åŒçš„ä¸»é”®å€¼</span><br><span class="line">æ¯ä¸ªè¡Œéƒ½å¿…é¡»å…·æœ‰ä¸€ä¸ªä¸»é”®å€¼ï¼ˆä¸»é”®åˆ—ä¸å…è®¸NULLå€¼ï¼‰</span><br></pre></td></tr></table></figure></p>
<p>ä¸»é”®å€¼è§„èŒƒï¼šè¿™é‡Œåˆ—å‡ºçš„è§„åˆ™æ˜¯MySQLæœ¬èº«å¼ºåˆ¶å®æ–½çš„ã€‚</p>
<p>ä¸»é”®çš„æœ€å¥½ä¹ æƒ¯ï¼š<br>é™¤MySQLå¼ºåˆ¶å®æ–½çš„è§„åˆ™å¤–ï¼Œåº”è¯¥åšæŒçš„å‡ ä¸ªæ™®éè®¤ä¸ºçš„æœ€å¥½ä¹ æƒ¯ä¸º:</p>
<pre><code class="plain">1ã€ä¸æ›´æ–°ä¸»é”®åˆ—çš„å€¼
2ã€ä¸é‡ç”¨ä¸»é”®åˆ—çš„å€¼
3ã€ä¸åœ¨ä¸»é”®åˆ—ä¸­ä½¿ç”¨å¯èƒ½ä¼šæ›´æ”¹çš„å€¼ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœä½¿ç”¨ä¸€ä¸ªåå­—ä½œä¸ºä¸»é”®ä»¥æ ‡è¯†æŸä¸ªä¾›åº”å•†ï¼Œåº”è¯¥ä¾›åº”å•†åˆå¹¶å’Œæ›´æ”¹å…¶åå­—æ—¶ï¼Œå¿…é¡»æ›´æ”¹è¿™ä¸ªä¸»é”®ï¼‰
</code></pre>
<p>æ€»ä¹‹ï¼šä¸åº”è¯¥ä½¿ç”¨ä¸€ä¸ªå…·æœ‰æ„ä¹‰çš„columnï¼ˆid æœ¬èº«å¹¶ä¸ä¿å­˜è¡¨ æœ‰æ„ä¹‰ä¿¡æ¯ï¼‰ ä½œä¸ºä¸»é”®ï¼Œå¹¶ä¸”ä¸€ä¸ªè¡¨å¿…é¡»è¦æœ‰ä¸€ä¸ªä¸»é”®ï¼Œä¸ºæ–¹ä¾¿æ‰©å±•ã€æ¾è€¦åˆï¼Œé«˜å¯ç”¨çš„ç³»ç»Ÿåšé“ºå«ã€‚<br><a id="more"></a></p>
<h3 id="æ— ç‰¹æ®Šéœ€æ±‚ä¸‹Innodbå»ºè®®ä½¿ç”¨ä¸ä¸šåŠ¡æ— å…³çš„è‡ªå¢IDä½œä¸ºä¸»é”®"><a href="#æ— ç‰¹æ®Šéœ€æ±‚ä¸‹Innodbå»ºè®®ä½¿ç”¨ä¸ä¸šåŠ¡æ— å…³çš„è‡ªå¢IDä½œä¸ºä¸»é”®" class="headerlink" title="æ— ç‰¹æ®Šéœ€æ±‚ä¸‹Innodbå»ºè®®ä½¿ç”¨ä¸ä¸šåŠ¡æ— å…³çš„è‡ªå¢IDä½œä¸ºä¸»é”®"></a>æ— ç‰¹æ®Šéœ€æ±‚ä¸‹Innodbå»ºè®®ä½¿ç”¨ä¸ä¸šåŠ¡æ— å…³çš„è‡ªå¢IDä½œä¸ºä¸»é”®</h3><p>InnoDBå¼•æ“ä½¿ç”¨èšé›†ç´¢å¼•ï¼Œæ•°æ®è®°å½•æœ¬èº«è¢«å­˜äºä¸»ç´¢å¼•ï¼ˆä¸€é¢—B+Treeï¼‰çš„å¶å­èŠ‚ç‚¹ä¸Šã€‚è¿™å°±è¦æ±‚åŒä¸€ä¸ªå¶å­èŠ‚ç‚¹å†…ï¼ˆå¤§å°ä¸ºä¸€ä¸ªå†…å­˜é¡µæˆ–ç£ç›˜é¡µï¼‰çš„å„æ¡æ•°æ®è®°å½•æŒ‰ä¸»é”®é¡ºåºå­˜æ”¾ï¼Œå› æ­¤æ¯å½“æœ‰ä¸€æ¡æ–°çš„è®°å½•æ’å…¥æ—¶ï¼ŒMySQLä¼šæ ¹æ®å…¶ä¸»é”®å°†å…¶æ’å…¥é€‚å½“çš„èŠ‚ç‚¹å’Œä½ç½®ï¼Œå¦‚æœé¡µé¢è¾¾åˆ°è£…è½½å› å­ï¼ˆInnoDBé»˜è®¤ä¸º15/16ï¼‰ï¼Œåˆ™å¼€è¾Ÿä¸€ä¸ªæ–°çš„é¡µï¼ˆèŠ‚ç‚¹ï¼‰</p>
<p>1ã€å¦‚æœè¡¨ä½¿ç”¨è‡ªå¢ä¸»é”®ï¼Œé‚£ä¹ˆæ¯æ¬¡æ’å…¥æ–°çš„è®°å½•ï¼Œè®°å½•å°±ä¼šé¡ºåºæ·»åŠ åˆ°å½“å‰ç´¢å¼•èŠ‚ç‚¹çš„åç»­ä½ç½®ï¼Œå½“ä¸€é¡µå†™æ»¡ï¼Œå°±ä¼šè‡ªåŠ¨å¼€è¾Ÿä¸€ä¸ªæ–°çš„é¡µã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="/images/mysql_aipk_1.jpg" alt="mysql_primary_key"><br>è¿™æ ·å°±ä¼šå½¢æˆä¸€ä¸ªç´§å‡‘çš„ç´¢å¼•ç»“æ„ï¼Œè¿‘ä¼¼é¡ºåºå¡«æ»¡ã€‚<strong><code>ç”±äºæ¯æ¬¡æ’å…¥æ—¶ä¹Ÿä¸éœ€è¦ç§»åŠ¨å·²æœ‰æ•°æ®ï¼Œå› æ­¤æ•ˆç‡å¾ˆé«˜ï¼Œä¹Ÿä¸ä¼šå¢åŠ å¾ˆå¤šå¼€é”€åœ¨ç»´æŠ¤ç´¢å¼•ä¸Šã€‚</code></strong></p>
<p>2ã€ å¦‚æœä½¿ç”¨éè‡ªå¢ä¸»é”®ï¼ˆå¦‚æœèº«ä»½è¯å·æˆ–å­¦å·ç­‰ï¼‰ï¼Œç”±äºæ¯æ¬¡æ’å…¥ä¸»é”®çš„å€¼è¿‘ä¼¼äºéšæœºï¼Œå› æ­¤æ¯æ¬¡æ–°çºªå½•éƒ½è¦è¢«æ’åˆ°ç°æœ‰ç´¢å¼•é¡µå¾—ä¸­é—´æŸä¸ªä½ç½®ï¼š<br><img src="/images/mysql_aipk_2.jpg" alt="mysql_primary_key"><br><strong><code>æ­¤æ—¶MySQLä¸å¾—ä¸ä¸ºäº†å°†æ–°è®°å½•æ’åˆ°åˆé€‚ä½ç½®è€Œç§»åŠ¨æ•°æ®ï¼Œç”šè‡³ç›®æ ‡é¡µé¢å¯èƒ½å·²ç»è¢«å›å†™åˆ°ç£ç›˜ä¸Šè€Œä»ç¼“å­˜ä¸­æ¸…æ‰ï¼Œæ­¤æ—¶åˆè¦ä»ç£ç›˜ä¸Šè¯»å›æ¥ï¼Œè¿™å¢åŠ äº†å¾ˆå¤šå¼€é”€ï¼ŒåŒæ—¶é¢‘ç¹çš„ç§»åŠ¨ã€åˆ†é¡µæ“ä½œé€ æˆäº†å¤§é‡çš„ç¢ç‰‡ã€‚</code></strong>å¾—åˆ°äº†ä¸å¤Ÿç´§å‡‘çš„ç´¢å¼•ç»“æ„ï¼Œåç»­ä¸å¾—ä¸é€šè¿‡OPTIMIZE TABLEæ¥é‡å»ºè¡¨å¹¶ä¼˜åŒ–å¡«å……é¡µé¢ã€‚</p>
<p>åœ¨ä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“æ—¶ï¼Œå¦‚æœæ²¡æœ‰ç‰¹åˆ«çš„éœ€è¦ï¼Œè¯·æ°¸è¿œä½¿ç”¨ä¸€ä¸ªä¸ä¸šåŠ¡æ— å…³çš„è‡ªå¢å­—æ®µä½œä¸ºä¸»é”®ã€‚</p>
<p><strong><code>mysql åœ¨é¢‘ç¹çš„æ›´æ–°ã€åˆ é™¤æ“ä½œï¼Œä¼šäº§ç”Ÿç¢ç‰‡ã€‚è€Œå«ç¢ç‰‡æ¯”è¾ƒå¤§çš„è¡¨ï¼ŒæŸ¥è¯¢æ•ˆç‡ä¼šé™ä½ã€‚æ­¤æ—¶éœ€å¯¹è¡¨è¿›è¡Œä¼˜åŒ–ï¼Œè¿™æ ·æ‰ä¼šä½¿æŸ¥è¯¢å˜å¾—æ›´æœ‰æ•ˆç‡ã€‚</code></strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Zephirå®‰è£…å’Œåˆä½“éªŒ]]></title>
      <url>http://team.jiunile.com/blog/2016/06/zephir-zephir-02.html</url>
      <content type="html"><![CDATA[<h2 id="Zephirå®‰è£…"><a href="#Zephirå®‰è£…" class="headerlink" title="Zephirå®‰è£…"></a>Zephirå®‰è£…</h2><h3 id="ç¯å¢ƒä¾èµ–"><a href="#ç¯å¢ƒä¾èµ–" class="headerlink" title="ç¯å¢ƒä¾èµ–"></a>ç¯å¢ƒä¾èµ–</h3><p>Zephirä¸»è¦ä¾èµ–äºä¸‹é¢ç¯å¢ƒ</p>
<ul>
<li>gcc &gt;= 4.x/clang &gt;= 3.x</li>
<li>re2c 0.13æˆ–æ›´é«˜ç‰ˆæœ¬</li>
<li>gnu 3.81æˆ–æ›´é«˜ç‰ˆæœ¬</li>
<li>autoconf 2.31æˆ–æ›´é«˜ç‰ˆæœ¬</li>
<li>automake 1.14æˆ–æ›´é«˜ç‰ˆæœ¬</li>
<li>libpcre3</li>
<li>phpå¼€å‘å·¥å…·-phpize</li>
</ul>
<p>å¦‚æœä½ ä½¿ç”¨Ubuntuï¼Œä½ å¯ä»¥å®‰è£…æ‰€éœ€è¦çš„åŒ…<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install git gcc make re2c php5 php5-json php5-dev libpcre3-dev</span><br></pre></td></tr></table></figure></p>
<p>ç”±äºZephiræ˜¯ç”¨PHPç¼–å†™çš„ï¼Œæ‰€ä»¥ä½ éœ€è¦å®‰è£…php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ php -v</span><br><span class="line">PHP 5.6.5 (cli) (built: Jan 24 2015 20:04:31)</span><br><span class="line">Copyright (c) 1997-2014 The PHP Group</span><br><span class="line">Zend Engine v2.6.0, Copyright (c) 1998-2014 Zend Technologies</span><br><span class="line">with Zend OPcache v7.0.4-dev, Copyright (c) 1999-2014, by Zend Technologies</span><br></pre></td></tr></table></figure></p>
<p>åŒæ—¶ä¹Ÿå¿…é¡»ç¡®ä¿å®‰è£…äº†PHPå¼€å‘åº“<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ phpize -v</span><br><span class="line">Configuring <span class="keyword">for</span>:</span><br><span class="line">PHP Api Version:         20131106</span><br><span class="line">Zend Module Api No:      20131226</span><br><span class="line">Zend Extension Api No:   220131226</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<h3 id="å®‰è£…Zephir"><a href="#å®‰è£…Zephir" class="headerlink" title="å®‰è£…Zephir"></a>å®‰è£…Zephir</h3><ol>
<li><p>ä¸‹è½½æœ€æ–°ç¨³å®šç‰ˆ</p>
</li>
<li><p>è¿è¡ŒZephirå®‰è£…ç¨‹åº(ç¼–è¯‘/åˆ›å»ºè§£æå™¨)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> zephir</span><br><span class="line">$ ./install-json</span><br><span class="line">$ ./install -c</span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•å®‰è£…</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zephir <span class="built_in">help</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¼šå¾—åˆ°å¦‚ä¸‹è¿”å›</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> _____              __    _</span><br><span class="line">/__  /  ___  ____  / /_  (_)____</span><br><span class="line">  / /  / _ \/ __ \/ __ \/ / ___/</span><br><span class="line"> / /__/  __/ /_/ / / / / / /</span><br><span class="line">/____/\___/ .___/_/ /_/_/_/</span><br><span class="line">         /_/</span><br><span class="line"></span><br><span class="line">Zephir version 0.9.2a-dev</span><br><span class="line"></span><br><span class="line">Usage: </span><br><span class="line">    <span class="built_in">command</span> [options]</span><br><span class="line"></span><br><span class="line">Available commands:</span><br><span class="line">    install             Installs the extension (requires root password)</span><br><span class="line">    builddev            Generate/Compile/Install a Zephir extension <span class="keyword">in</span> development mode</span><br><span class="line">    <span class="built_in">help</span>                Displays this <span class="built_in">help</span></span><br><span class="line">    build               Generate/Compile/Install a Zephir extension</span><br><span class="line">    compile             Compile a Zephir extension</span><br><span class="line">    stubs               Generates extension PHP stubs</span><br><span class="line">    version             Shows the Zephir version</span><br><span class="line">    init [namespace]    Initializes a Zephir extension</span><br><span class="line">    fullclean           Cleans the generated object files <span class="keyword">in</span> compilation</span><br><span class="line">    api [--theme-path=/path][--output-directory=/path][--theme-options=&#123;json&#125;|/path]Generates a HTML API</span><br><span class="line">    generate            Generates C code from the Zephir code</span><br><span class="line">    clean               Cleans the generated object files <span class="keyword">in</span> compilation</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">    <span class="_">-f</span>([a-z0-9\-]+)     Enables compiler optimizations</span><br><span class="line">    -fno-([a-z0-9\-]+)  Disables compiler optimizations</span><br><span class="line">    -w([a-z0-9\-]+)     Turns a warning on</span><br><span class="line">    -W([a-z0-9\-]+)     Turns a warning off</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="Zephiråˆä½“éªŒ"><a href="#Zephiråˆä½“éªŒ" class="headerlink" title="Zephiråˆä½“éªŒ"></a>Zephiråˆä½“éªŒ</h2><p>è¿˜è®°å¾—åœ¨å¼€ç¯‡é‚£ä¸ªHellowordä¾‹å­å—ï¼Ÿæˆ‘ä»¬å…ˆæ¥ç®€å•ä»‹ç»ä¸€ä¸‹Zephirç¼–è¯‘æœºåˆ¶ï¼Œåœ¨ç”¨ä¾‹å­ä»‹ç»ä¸€ä¸‹Zephirçš„è¯­æ³•ã€‚</p>
<h3 id="ç¼–è¯‘-è§£é‡Š"><a href="#ç¼–è¯‘-è§£é‡Š" class="headerlink" title="ç¼–è¯‘/è§£é‡Š"></a>ç¼–è¯‘/è§£é‡Š</h3><p>æ¯ä¸€ç§è¯­è¨€éƒ½ä¼šæœ‰å®ƒä»¬çš„â€Hello World!â€ä¾‹å­ï¼Œå¯¹äºZehpiræ¥è¯´ä¹Ÿä¸ä¾‹å¤–ï¼Œä¸‹é¢çš„è¿™ä¸ªå¼•å¯¼ä¾‹å­åˆ—ä¸¾äº†è®¸å¤šå®ƒé‡è¦çš„ç‰¹æ€§ã€‚</p>
<p>Zephirçš„ä»£ç å¿…é¡»æ”¾ç½®åœ¨ç±»ä¸­ã€‚Zephiræ˜¯åŸºäºé¢å‘å¯¹è±¡ç±»/æ¡†æ¶æ‰“é€ çš„ã€‚æ‰€ä»¥ä»£ç æ”¾ç½®åœ¨ç±»çš„å¤–é¢æ˜¯ä¸å…è®¸çš„ã€‚å¦å¤–ï¼Œä¸€ä¸ªå‘½åç©ºé—´ä¹Ÿæ˜¯å¿…é¡»çš„ã€‚<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Test</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hello World!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸€ä½†è¿™ä¸ªç±»è¢«ç¼–è¯‘å®Œæˆï¼Œå®ƒä¼šäº§ç”Ÿä¸‹é¢çš„ä¸€æ®µCä»£ç ï¼ˆgcc/clang/vc++ç¼–è¯‘ï¼‰<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EPHIR_INIT_CLASS(Test_Hello) &#123;</span><br><span class="line">    ZEPHIR_REGISTER_CLASS(Test, Hello, hello, test_hello_method_entry, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PHP_METHOD(Test_Hello, say) &#123;</span><br><span class="line">    php_printf(<span class="string">"%s"</span>, <span class="string">"Hello World!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>äº‹å®ä¸Šï¼Œä½¿ç”¨Zephirçš„å¼€å‘è€…æ— éœ€æ‡‚å¾—Cè¯­è¨€ï¼Œå¦‚æœä½ æœ‰ä½¿ç”¨ç¼–è¯‘å™¨ï¼Œæˆ–è€…phpå†…éƒ¨çš„æ„é€ ï¼Œæˆ–è€…Cè¯­è¨€æœ¬èº«çš„ç»éªŒï¼Œ åœ¨ä½¿ç”¨Zephirçš„æ—¶å€™ä½ å°†ä¼šæ„Ÿåˆ°æ›´åŠ çš„æ¸…æ™°ã€‚</p>
<h3 id="Zephiråˆè¯•"><a href="#Zephiråˆè¯•" class="headerlink" title="Zephiråˆè¯•"></a>Zephiråˆè¯•</h3><p>åœ¨æ¥ä¸‹æ¥çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šå°½è¯¦ç»†çš„æè¿°ï¼Œä»¥ä¾¿ä½ çŸ¥é“æ˜¯æ€ä¹ˆå›äº‹ã€‚ æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©ä½ æ„Ÿè§‰ä¸€ä¸‹åˆ°åº•Zephiræ˜¯æ€ä¹ˆæ ·çš„ä¸€ä¸ªä¸œè¥¿ã€‚ éšä¾¿æˆ‘ä»¬å°†ä¼šè¯¦ç»†çš„æ¢ç´¢Zephirçš„æ–°ç‰¹æ€§ã€‚    </p>
<p>ä¸‹é¢çš„ä¾‹å­å¾ˆç®€å•ï¼Œå®ƒæä¾›ä¸€ä¸ªç±»å’Œä¸€ä¸ªå‡½æ•°ï¼Œæ£€æµ‹ä¸€ä¸ªæ•°ç»„çš„ç±»å‹</p>
<p>è®©æˆ‘ä»¬è®¤çœŸçš„æ£€æŸ¥ä¸‹é¢çš„ä»£ç ï¼Œå¼€å§‹è®¤çœŸçš„çš„å­¦ä¹ Zephir. è¿™å‡ è¡Œä»£ç åŒ…æ‹¬äº†å¾ˆå¤šè¯¦ç»†çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬å°†ä¼šæ…¢æ…¢çš„è§£é‡Šã€‚<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Test</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * MyTest (test/mytest.zep)</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123; </span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">someMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">/* å˜é‡å¿…é¡»å£°æ˜ */</span></span><br><span class="line">		 <span class="keyword">var</span> myArray;</span><br><span class="line">		 int i = <span class="number">0</span>, length;</span><br><span class="line">		</span><br><span class="line">		 <span class="comment">/*åˆ›å»ºä¸€ä¸ªæ•°ç»„ */</span></span><br><span class="line">		 let myArray = [<span class="string">"hello"</span>, <span class="number">0</span>, <span class="number">100.25</span>, <span class="keyword">false</span>, <span class="keyword">null</span>];</span><br><span class="line">		</span><br><span class="line">		 <span class="comment">/* æ•°ç»„æœ‰å¤šå°‘ä¸ªå…ƒç´ */</span></span><br><span class="line">		 let length = count(myArray);</span><br><span class="line">		</span><br><span class="line">		 <span class="comment">/* æ‰“å°å€¼ç±»å‹ */</span></span><br><span class="line">		 <span class="keyword">while</span> i &lt; length &#123;</span><br><span class="line">		     <span class="keyword">echo</span> typeof myArray[i], <span class="string">"\n"</span>;</span><br><span class="line">		     let i++;</span><br><span class="line">		 &#125;</span><br><span class="line">		 </span><br><span class="line">		 <span class="keyword">return</span> myArray;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨å‡½æ•°ä¸­ï¼Œç¬¬ä¸€è¡Œä½¿ç”¨äº†â€™varâ€™ å’Œ â€˜intâ€™ å…³é”®è¯æ¥å£°æ˜ä¸€ä¸ªå‡½æ•°å†…çš„ç§æœ‰å˜é‡ã€‚ åœ¨å‡½æ•°ä¸­çš„æ¯ä¸€ä¸ªå˜é‡å¿…é¡»äº‹å…ˆå£°æ˜å®ƒä»¬è‡ªå·±çš„ç±»å‹ã€‚è¿™äº›å£°æ˜å¹¶ä¸æ˜¯éšæ„çš„ï¼Œå®ƒå¸®åŠ©ç¼–è¯‘å™¨æ¥æŠ¥å‘Šç»™ä½ å…³äº é”™è¯¯çš„å˜é‡ï¼Œæˆ–è€…å˜é‡çš„ä½¿ç”¨æ˜¯å¦è¶…å‡ºçš„å®ƒçš„èŒƒå›´ï¼Œé€šå¸¸å®ƒä¼šåœ¨æœ€åæŠ›å‡ºé”™è¯¯ã€‚</p>
<p>åŠ¨æ€çš„å˜é‡å¿…é¡»ä»¥å…³é”®è¯â€™varâ€™æ¥å£°æ˜ã€‚è¿™äº›å˜é‡å¯ä»¥è¢«æŒ‡å®šæˆ–å†æŒ‡å®šæˆä¸åŒçš„å˜é‡ç±»å‹ã€‚å¦ä¸€æ–¹é¢ï¼Œâ€™iâ€™ and â€˜lengthâ€™ä½¿ç”¨äº†æ•´æ•°çš„é™æ€å˜é‡ï¼Œåœ¨æ‰§è¡Œç¨‹åºçš„è¿‡ç¨‹ä¸­ï¼Œå®ƒåªèƒ½æ”¹å˜å€¼ï¼Œè€Œä¸èƒ½æ”¹å˜å˜é‡çš„ç±»å‹ã€‚</p>
<p>ä¸PHPä¸åŒçš„æ˜¯ï¼Œä½ ä¸ç”¨åœ¨å˜é‡çš„å‰é¢åŠ ä¸Š($)ç¬¦å·ã€‚</p>
<p>Zephirçš„æ³¨é‡Šå’ŒJava, C#, C++ç­‰ç­‰ä¸€äº›è¯­è¨€çš„ä¸€æ ·ã€‚</p>
<p>é»˜è®¤çš„ï¼Œå˜é‡æ˜¯ä¸å˜çš„ï¼Œæ„æ€æ˜¯è¯´ZephiræœŸæœ›å¤§éƒ¨åˆ†çš„å˜é‡ä¿æŒä¸å˜ã€‚å˜é‡ä¿æŒå®ƒä»¬åŸå§‹çš„å€¼ä¸å˜å¯ä»¥ä¼˜åŒ–æˆé™æ€å¸¸é‡ã€‚ å¦‚æœéœ€è¦æ”¹å˜å˜é‡çš„å€¼ï¼Œè¯·ä½¿ç”¨å…³é”®è¯â€™letâ€™<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* åˆ›å»ºä¸€ä¸ªæ•°ç»„ */</span></span><br><span class="line">let myArray = [<span class="string">"hello"</span>, <span class="number">0</span>, <span class="number">100.25</span>, <span class="keyword">false</span>, <span class="keyword">null</span>];</span><br></pre></td></tr></table></figure></p>
<p>é»˜è®¤çš„ï¼Œæ•°ç»„æ˜¯ä¸€ç§è±¡PHPä¸€æ ·çš„åŠ¨æ€å˜é‡ï¼Œå®ƒåŒ…å«äº†è®¸å¤šä¸åŒç±»å‹çš„å€¼ã€‚ä»¤äººåƒæƒŠçš„æ˜¯ï¼ŒPHPå†…éƒ¨çš„å‡½æ•°å¯ä»¥åœ¨Zephirä¸­ä½¿ç”¨ï¼Œåœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œâ€™countâ€™ å‡½æ•°è¢«ä½¿ç”¨äº†ï¼Œç¼–è¾‘å™¨å¯ä»¥ä»¥æœ€ä½³çš„çŠ¶æ€æ¥æ‰§è¡Œï¼Œå› ä¸ºå®ƒå·²ç»çŸ¥é“äº†æ•°ç»„çš„é•¿åº¦äº†ã€‚<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*æ•°ç»„æœ‰å¤šå°‘ä¸ªå…ƒç´  */</span></span><br><span class="line">let length = count(myArray);</span><br></pre></td></tr></table></figure></p>
<p>åŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨èŠ±æ‹¬å·æ¥æ§åˆ¶ç¨‹åºçš„æµç¨‹.<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> i &lt; length &#123;</span><br><span class="line">    <span class="keyword">echo</span> typeof myArray[i], <span class="string">"\n"</span>;</span><br><span class="line">    let i++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PHPçš„å˜é‡æ€»æ˜¯åŠ¨æ€çš„ï¼Œå‡½æ•°æ€»æ˜¯è¿”å›çš„æ˜¯å¯å˜çš„åŠ¨æ€å˜é‡ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœä¸€ä¸ªé™æ€å˜é‡åœ¨Zphirä¸­è¢«è¿”å›äº†ï¼Œåœ¨PHPçš„è°ƒç”¨ä¸­ ä½ å¾—åˆ°çš„å´æ˜¯ä¸€ä¸ªåŠ¨æ€å˜é‡ã€‚</p>
<p><strong>è¯·æ³¨æ„ï¼å†…å­˜æ˜¯åœ¨ç¼–è¯‘å™¨ä¸­è‡ªåŠ¨ç®¡ç†çš„ï¼Œæ‰€ä»¥ä½ æ²¡æœ‰å¿…è¦åƒCè¯­è¨€ä¸€æ ·å»åˆ†é…å’Œé‡Šæ”¾å†…å­˜ã€‚</strong> è¿™å’ŒPHPæ˜¯å¾ˆç›¸ä¼¼çš„ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Zephirä»‹ç»]]></title>
      <url>http://team.jiunile.com/blog/2016/06/zephir-zephir-01.html</url>
      <content type="html"><![CDATA[<h2 id="zephirä»‹ç»"><a href="#zephirä»‹ç»" class="headerlink" title="zephirä»‹ç»"></a>zephirä»‹ç»</h2><p>Zephiræ˜¯ä¸€ç§å¯ä»¥è®©PHPå¼€å‘è€…å°è¯•ç¼–å†™å’Œç¼–è¯‘å¯ä»¥è¢«PHPæ‰§è¡Œä»£ç çš„ä¸€ç§è¯­è¨€ã€‚å®ƒæ˜¯åŠ¨æ€/é™æ€ç±»å‹ï¼Œå®ƒçš„ä¸€äº›ç‰¹æ€§å¯¹äºPHP å¼€å‘è€…æ¥è¯´æ˜¯éå¸¸çš„ç›¸ä¼¼çš„ã€‚</p>
<p>Zephirçš„åå­—æ˜¯å–è‡ªZend Engine/PHP/Intermediateçš„ç¼©å†™ã€‚å»ºè®®å‘éŸ³ä¸ºzephyrç›¸åŒã€‚äº‹å®ä¸ŠZephirçš„åˆ›é€ è€…å‘éŸ³ä¸ºzaefire_.</p>
<h3 id="ç®€å•æ˜“äºå¼€å‘"><a href="#ç®€å•æ˜“äºå¼€å‘" class="headerlink" title="ç®€å•æ˜“äºå¼€å‘"></a>ç®€å•æ˜“äºå¼€å‘</h3><p>ç›¸ä¿¡å¤§å®¶å’Œæˆ‘æœ‰ä¸€æ ·çš„ç»å†ï¼Œçœ‹åˆ°äº†yafå’Œphalconåœ¨æƒ³ä¸ºä»€ä¹ˆCè¯­è¨€çš„æ‹“å±•æ¡†æ¶å¯ä»¥è¿™ä¹ˆçš„å¿«ï¼Œæˆ‘è‡ªå·±èƒ½ä¸èƒ½å†™ä¸€ä¸ªå‡ºæ¥å‘¢ï¼Ÿç„¶åå±é¢ å±é¢ çš„è·‘å»æ‰¾èµ„æ–™æ‰¾å¤§ç¥äº†è§£ï¼Œå¤§ç¥è¯´ä½ å»çœ‹ä¸€ä¸‹ â€œPHPæ‰©å±•å¼€å‘åŠå†…æ ¸åº”ç”¨â€ï¼Œç»“æœå¤§å®¶éƒ½çŸ¥é“é†‰äº†ã€‚</p>
<p>ä¸»è¦åŸå› æ˜¯éœ€è¦å¯¹Cç›¸å¯¹çš„ç†Ÿæ‚‰å¹¶ä¸”å¯¹PHPå†…æ ¸APIä¹Ÿè¦å¾ˆç†Ÿæ‚‰ï¼Œæˆ‘è§‰å¾—è¿™å·²ç»ä¸æ˜¯é—¨æ§›çš„é—®é¢˜äº†æ˜¯å¤ªå¹³æ´‹çš„è·ç¦»ï¼Œå°±è‰è‰ç»“æŸäº†ç ”ç©¶ã€‚</p>
<p>å½“é‡åˆ°zephiré¦–å…ˆäº†è§£çš„å°±æ˜¯å¤æ‚ç¨‹åº¦ï¼Œç»“æœèŠ±äº†10åˆ†é’Ÿå°±è·Ÿç€æµç¨‹åšäº†ä¸€ä¸ªå°DEMOï¼Œå°±è¿™ç‚¹çœ‹æ¥å°±å¼€å‘æ•ˆç‡è¿™ç‚¹çœ‹æ¥æ— å¯åšéçš„çš„é«˜æ•ˆå¿«é€Ÿï¼Œå¤§å®¶æ„Ÿå—ä¸€ä¸‹ã€‚<br><a id="more"></a><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Icyboy</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">hi</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>  <span class="string">"hello world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç¼–è¯‘ä¹‹åå¼•å…¥åˆ°php.inié‡Œé¢ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Icyboy</span>\<span class="title">Hello</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> Hello::hi() . PHP_EOL;</span><br></pre></td></tr></table></figure></p>
<p>zephiræ˜¯ä¸€ä¸ªè§£é‡Šå™¨è¯­è¨€å’ŒPHPéå¸¸è¿‘ä¼¼ï¼Œé€šè¿‡zephirçš„æœºåˆ¶ç¼–è¯‘æˆCè¯­è¨€ï¼Œç„¶åé€šè¿‡Cç¼–è¯‘å‡ºPHPæ‹“å±•æä¾›ä½¿ç”¨ï¼ŒæŠŠä¸­é—´è¿‡ç¨‹é«˜åº¦å°è£…ï¼Œå¾ˆå¤§ç¨‹åº¦è®©PHPæ‹“å±•å¼€å‘ç®€å•äº†å¾ˆå¤šã€‚</p>
<p><strong>PHPæ‰©å±•å¼€å‘åŠå†…æ ¸åº”ç”¨</strong> <a href="http://www.walu.cc/phpbook" target="_blank" rel="external">http://www.walu.cc/phpbook</a></p>
<h3 id="zephirç‰¹æ€§"><a href="#zephirç‰¹æ€§" class="headerlink" title="zephirç‰¹æ€§"></a>zephirç‰¹æ€§</h3><ul>
<li>zephiræ˜¯é™æ€åŠ¨æ€ç»“åˆè¯­è¨€ï¼Œåœ¨zephirå†…å¯ä»¥ä½¿ç”¨ä¼ ç»Ÿé™æ€å˜é‡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŠ¨æ€å˜é‡ï¼Œçµæ´»åº¦é«˜ã€‚</li>
<li>å†…å­˜å®‰å…¨ï¼Œç†Ÿæ‚‰Cç¨‹åºçš„ç«¥é‹éƒ½çŸ¥é“Cå¯ä»¥æ§åˆ¶å†…å­˜æŒ‡é’ˆï¼Œå…¶å®ç”¨çš„ä¸å¥½æ˜¯ä¸€ä»¶å¾ˆå±é™©çš„äº‹æƒ…ï¼Œzephirå®ƒä¸å…è®¸ä½ ä½¿ç”¨æŒ‡é’ˆï¼Œå®ƒæä¾›äº†ä¸€ä¸ª<strong>task-localåƒåœ¾æ”¶é›†å™¨</strong>ï¼Œä»¥é¿å…å†…å­˜æ³„æ¼ã€‚</li>
<li>ç¼–è¯‘æ¨¡å¼ï¼Œzephirèƒ½å¤Ÿç¼–è¯‘ä¸»æµç³»ç»ŸLiunx/OSX/Windowsèƒ½å¤Ÿè¯†åˆ«çš„æ‹“å±•ç¨‹åºã€‚</li>
<li>å¼€å‘æºä»£ç çš„é«˜çº§è¯­è¨€ï¼Œä»¥é¢å‘å¯¹è±¡ä¸ºåŸºç¡€ï¼Œç¼–å†™æ‹“å±•éƒ½éœ€è¦åŸºäºé¢å‘å¯¹è±¡ã€‚</li>
</ul>
<h3 id="æ„Ÿå—ä¸€ä¸‹"><a href="#æ„Ÿå—ä¸€ä¸‹" class="headerlink" title="æ„Ÿå—ä¸€ä¸‹"></a>æ„Ÿå—ä¸€ä¸‹</h3><p>ä¸‹é¢æ˜¯å®˜æ–¹æä¾›çš„ä¸€ä¸ªè®©å¤§å®¶æ„Ÿå—ä¸€ä¸‹çš„å°ä¾‹å­ä½œç”¨æ˜¯è¿‡æ»¤å˜é‡è¿”å›å­—æ¯å­—ç¬¦<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">MyLibrary</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Filter</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">alpha</span><span class="params">(string str)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        char ch; string filtered = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> ch in str &#123;</span><br><span class="line">           <span class="keyword">if</span> (ch &gt;= <span class="string">'a'</span> &amp;&amp; ch &lt;= <span class="string">'z'</span>) || (ch &gt;= <span class="string">'A'</span> &amp;&amp; ch &lt;= <span class="string">'Z'</span>) &#123;</span><br><span class="line">              let filtered .= ch;</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> filtered;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»PHPç±»å¯ä»¥ä½¿ç”¨å¦‚ä¸‹<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$filter = <span class="keyword">new</span> MyLibrary\Filter();</span><br><span class="line"><span class="keyword">echo</span> $filter-&gt;alpha(<span class="string">"01he#l.lo?/1"</span>); <span class="comment">// ç»“æœè¾“å‡º hello</span></span><br></pre></td></tr></table></figure></p>
<h2 id="ä¸ºä»€ä¹ˆæ˜¯Zephir"><a href="#ä¸ºä»€ä¹ˆæ˜¯Zephir" class="headerlink" title="ä¸ºä»€ä¹ˆæ˜¯Zephir"></a>ä¸ºä»€ä¹ˆæ˜¯Zephir</h2><p>ä»Šå¤©çš„PHPåº”ç”¨ç¨‹åºå¿…é¡»å¹³è¡¡ä¸€ç³»åˆ—é—®é¢˜åŒ…æ‹¬ç¨³å®šæ€§ã€æ€§èƒ½å’ŒåŠŸèƒ½ã€‚</p>
<p>æ¯ä¸€ä¸ªPHPåº”ç”¨ç¨‹åºæ˜¯åŸºäºä¸€ç»„å¸¸è§çš„ç»„ä»¶æˆ–è€…è¯´æ¡†æ¶ï¼Œè¿™äº›å…¬å…±ç»„ä»¶æ˜¯åº“/æ¡†æ¶æˆ–å®ƒä»¬çš„ç»„åˆã€‚ä¸€æ—¦å®‰è£…åå¾ˆå°‘æ”¹å˜ï¼Œä½œä¸ºåº”ç”¨ç¨‹åºçš„åŸºç¡€ï¼Œä»–ä»¬å¿…é¡»æ˜¯æœ‰éå¸¸å¿«çš„,</p>
<p>å¿«é€Ÿå’Œå¼ºå¤§çš„åº“ä¼šå¾ˆå¤æ‚ï¼Œç”±äºé«˜æ°´å¹³çš„æŠ½è±¡ï¼Œä¸€èˆ¬çš„åšæ³•æ˜¯çº¦å®šåŸºç¡€åº“æˆ–æ¡†æ¶å¾ˆå°‘æ”¹å˜ï¼Œæ‰æœ‰æœºä¼šæ¥æ”¹å–„æ€§èƒ½å’Œèµ„æºæ¶ˆè€—ã€‚</p>
<p>Zephirï¼Œæ‚¨å¯ä»¥å®ç°é¢å‘å¯¹è±¡åº“/æ¡†æ¶/åº”ç”¨ç¨‹åºï¼Œä½¿æ‚¨çš„åº”ç”¨ç¨‹åºé€Ÿåº¦æé«˜ï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒã€‚</p>
<h3 id="å¦‚æœä½ æ˜¯ä¸€ä¸ªPHPç¨‹åºå‘˜â€¦â€¦"><a href="#å¦‚æœä½ æ˜¯ä¸€ä¸ªPHPç¨‹åºå‘˜â€¦â€¦" class="headerlink" title="å¦‚æœä½ æ˜¯ä¸€ä¸ªPHPç¨‹åºå‘˜â€¦â€¦"></a>å¦‚æœä½ æ˜¯ä¸€ä¸ªPHPç¨‹åºå‘˜â€¦â€¦</h3><p>PHPæ˜¯åœ¨ä½¿ç”¨çš„Webåº”ç”¨ç¨‹åºå¼€å‘ä¸­æœ€æµè¡Œçš„è¯­è¨€ä¹‹ä¸€ã€‚åƒPHPåŠ¨æ€ç±»å‹å’Œè§£é‡Šè¯­è¨€ï¼Œç”±äºå…¶çµæ´»æ€§ï¼Œæä¾›éå¸¸é«˜çš„æ•ˆç‡ã€‚</p>
<p>PHPæ˜¯åŸºäºZendå¼•æ“çš„å®ç°ã€‚è¿™æ˜¯æ‰§è¡Œä»å­—èŠ‚ç è¡¨ç¤ºçš„PHPä»£ç çš„è™šæ‹Ÿæœºã€‚Zendå¼•æ“æ˜¯ä¸–ç•Œä¸Šæ¯ä¸€ä¸ªPHPçš„å®‰è£…å‡ ä¹ç›®å‰ï¼Œéšç€Zephirï¼Œæ‚¨å¯ä»¥åˆ›å»ºåœ¨Zendå¼•æ“è¿è¡ŒPHPæ‰©å±•ã€‚</p>
<p>PHPæ‰˜ç®¡Zephirï¼Œæ‰€ä»¥ä»–ä»¬æ˜¾ç„¶æœ‰å¾ˆå¤šç›¸ä¼¼çš„åœ°æ–¹ï¼Œä½†æ˜¯ï¼Œä»–ä»¬æœ‰ç»™Zephirè‡ªå·±çš„ä¸ªæ€§çš„é‡è¦å·®å¼‚ã€‚ä¾‹å¦‚ï¼ŒZephiræ›´åŠ ä¸¥æ ¼ï¼Œå®ƒå¯ä»¥è®©ä½ å‡å°‘ç¼–è¯‘æ­¥éª¤ã€‚</p>
<h3 id="å¦‚æœä½ æ˜¯ä¸€ä¸ªCç¨‹åºå‘˜â€¦â€¦"><a href="#å¦‚æœä½ æ˜¯ä¸€ä¸ªCç¨‹åºå‘˜â€¦â€¦" class="headerlink" title="å¦‚æœä½ æ˜¯ä¸€ä¸ªCç¨‹åºå‘˜â€¦â€¦"></a>å¦‚æœä½ æ˜¯ä¸€ä¸ªCç¨‹åºå‘˜â€¦â€¦</h3><p>Cæ˜¯æœ‰å²ä»¥æ¥æœ€å¼ºå¤§çš„å’Œæµè¡Œçš„è¯­è¨€ä¹‹ä¸€ã€‚ äº‹å®ä¸Šï¼ŒPHPæ˜¯ç”¨Cç¼–å†™çš„ã€‚</p>
<p>ç„¶è€Œï¼Œç”¨Cå¼€å‘å¤§å‹åº”ç”¨ç¨‹åºå¯ä»¥æŠŠPHPæˆ–Zephirç›¸æ¯”æ¯”é¢„æœŸçš„è¦é•¿å¾ˆå¤šï¼Œä¸€äº›é”™è¯¯æ˜¯å¾ˆéš¾æ‰¾åˆ°ã€‚å¦‚æœä½ ä¸æ˜¯ä¸€ä¸ªæœ‰ç»éªŒçš„å¼€å‘äººå‘˜ã€‚</p>
<p>Zephirè®¾è®¡æ˜¯å®‰å…¨çš„ï¼Œæ‰€ä»¥å®ƒæ²¡æœ‰å®ç°æŒ‡é’ˆæˆ–æ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼Œå¦‚æœä½ æ˜¯ä¸€ä¸ªCç¨‹åºå‘˜ï¼Œä½ ä¼šè§‰å¾—Zephirå¼ºå¤§ï¼Œæ¯”Cæ›´åŠ çš„å‹å¥½ã€‚</p>
<h3 id="ç¼–è¯‘VSè§£è¯»"><a href="#ç¼–è¯‘VSè§£è¯»" class="headerlink" title="ç¼–è¯‘VSè§£è¯»"></a>ç¼–è¯‘VSè§£è¯»</h3><p>ç¼–è¯‘é€šå¸¸ä¼šå‡æ…¢ä¸‹æ¥çš„å‘å±•ï¼›ä½ éœ€è¦å¤šä¸€ç‚¹è€å¿ƒï¼Œä½¿ä½ çš„ä»£ç ç¼–è¯‘è¿è¡Œå®ƒä¹‹å‰ã€‚æ­¤å¤–ï¼Œè¯¥è§£é‡Šè¶‹äºé™ä½æœ‰åˆ©äºç”Ÿäº§ç‡çš„æ€§èƒ½ã€‚</p>
<p>ä¸ºäº†æ›´é«˜çš„æ•ˆç‡ï¼ŒZephiréœ€è¦ç¼–è¯‘ä½ çš„ä»£ç ï¼Œä½†æ˜¯ä»–ä¸ä¼šå½±å“é«˜ç”Ÿäº§æ•ˆç‡ï¼Œå¼€å‘äººå‘˜å¯ä»¥å†³å®šå“ªäº›åº”ç”¨ç¨‹åºéƒ¨åˆ†åº”å½“åœ¨Zephirï¼Œå“ªäº›ä¸æ˜¯ã€‚</p>
<h3 id="é™æ€ç±»å‹å’ŒåŠ¨æ€ç±»å‹è¯­è¨€"><a href="#é™æ€ç±»å‹å’ŒåŠ¨æ€ç±»å‹è¯­è¨€" class="headerlink" title="é™æ€ç±»å‹å’ŒåŠ¨æ€ç±»å‹è¯­è¨€"></a>é™æ€ç±»å‹å’ŒåŠ¨æ€ç±»å‹è¯­è¨€</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨é™æ€ç±»å‹è¯­è¨€ä¸­ï¼Œå˜é‡æ˜¯ç»‘å®šåˆ°ä¸€ä¸ªç‰¹å®šç±»å‹çš„ä¸€ç”Ÿã€‚ å…¶ç±»å‹ä¸èƒ½æ”¹å˜ï¼Œåªèƒ½å‚è€ƒå®ä¾‹å’Œå…¼å®¹æ“ä½œã€‚ åƒC / c++è¯­è¨€å®ç°çš„æ–¹æ¡ˆ<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int a = <span class="number">0</span>;</span><br><span class="line">a = <span class="string">"hello"</span>; <span class="comment">// not allowed</span></span><br></pre></td></tr></table></figure></p>
<p>åœ¨åŠ¨æ€ç±»å‹ï¼Œç»‘å®šåˆ°ç±»å‹çš„å€¼ï¼Œè€Œä¸æ˜¯å˜é‡ã€‚ æ‰€ä»¥ï¼Œä¸€ä¸ªå˜é‡å¯èƒ½å¼•ç”¨å€¼çš„ç±»å‹ï¼Œç„¶åé‡æ–°åˆ†é…åçš„å€¼ç±»å‹æ— å…³ã€‚ Javascript / PHPçš„ä¾‹å­ åŠ¨æ€ç±»å‹è¯­è¨€<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">0</span>;</span><br><span class="line">a = <span class="string">"hello"</span>; <span class="comment">// allowed</span></span><br></pre></td></tr></table></figure></p>
<p>å°½ç®¡åŠ¨æ€ç±»å‹æœ‰ç€ç”Ÿäº§åŠ›çš„ä¼˜åŠ¿ï¼Œä½†æ˜¯åŠ¨æ€è¯­è¨€å¹¶ä¸èƒ½æˆä¸ºæ‰€æœ‰åº”ç”¨çš„é€‰æ‹©ï¼Œç‰¹åˆ«æ˜¯å¯¹äºéå¸¸å¤§å‹ä»£ç åº“å’Œé«˜æ€§èƒ½çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>ä¼˜åŒ–æ€§èƒ½çš„åŠ¨æ€è¯­è¨€åƒPHPæ¯”é™æ€è¯­è¨€(å¦‚C)æ˜¯æ›´å…·æŒ‘æˆ˜æ€§çš„ã€‚ åœ¨é™æ€è¯­è¨€ä¸­ï¼Œä¼˜åŒ–å™¨å¯ä»¥åˆ©ç”¨ç±»å‹ä¿¡æ¯åšå‡ºå†³ç­–ã€‚ åœ¨åŠ¨æ€è¯­è¨€ä¸­ï¼Œåªæœ‰å¾ˆæœ‰é™çš„ä¿¡æ¯æ˜¯å¯ç”¨çš„ï¼Œè¿™ä½¿å¾—ä¼˜åŒ–å™¨çš„é€‰æ‹©æ›´åŠ å›°éš¾ã€‚</p>
<p>å¦‚æœä½ éœ€è¦éå¸¸é«˜çš„æ€§èƒ½,ï¼Œé™æ€è¯­è¨€å¯èƒ½æ˜¯ä¸€ä¸ªæ›´å®‰å…¨çš„é€‰æ‹©ã€‚</p>
<p>é™æ€è¯­è¨€çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ç¼–è¯‘å™¨æ‰§è¡Œé¢å¤–çš„æ£€æŸ¥ã€‚ ç¼–è¯‘å™¨æ— æ³•å‘ç°é€»è¾‘é”™è¯¯ï¼Œè¿™æ›´é‡è¦ä½†æ˜¯ç¼–è¯‘å™¨å¯ä»¥æå‰å‘ç°é”™è¯¯ï¼ŒåŠ¨æ€è¯­è¨€åªèƒ½åœ¨è¿è¡Œæç¤ºæŠ¥é”™ä¿¡æ¯ã€‚</p>
<p>Zephiræ˜¯é™æ€å’ŒåŠ¨æ€ç±»å‹éƒ½å…è®¸ä½¿ç”¨çš„ã€‚</p>
<h3 id="ä»£ç ä¿æŠ¤"><a href="#ä»£ç ä¿æŠ¤" class="headerlink" title="ä»£ç ä¿æŠ¤"></a>ä»£ç ä¿æŠ¤</h3><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¼–è¯‘ä¸æ˜¾è‘—æé«˜æ€§èƒ½ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºç“¶é¢ˆæ‰€åœ¨ã€‚ åœ¨åº”ç”¨ç¨‹åºçš„I / O(å¾ˆæœ‰å¯èƒ½)ï¼Œè€Œä¸æ˜¯è®¡ç®—/å†…å­˜é™åˆ¶ã€‚ ç„¶è€Œï¼Œç¼–è¯‘ä»£ç ä¹Ÿå¯èƒ½å¸¦æ¥æŸç§ç¨‹åº¦çš„intelectualä¿æŠ¤æ‚¨çš„åº”ç”¨ç¨‹åºã€‚ Zephiräº§ç”Ÿæœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½ ä¹Ÿæœ‰èƒ½åŠ›â€œéšè—â€ç”¨æˆ·æˆ–å®¢æˆ·çš„åŸå§‹ä»£ç ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Zephirä¸æ˜¯ç”¨æ¥å–ä»£PHPæˆ–Cï¼Œç›¸åæˆ‘ä»¬è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªè¡¥å……ï¼Œå…è®¸å¼€å‘è€…è¿›å…¥ä»£ç ç¼–è¯‘å’Œé™æ€ç±»å‹ã€‚Zephiræ­£æ˜¯è¯•å›¾åŠ å…¥ä»Cå’ŒPHPçš„ä¸–ç•Œï¼Œç¾å¥½çš„äº‹ç‰©å¯»æ‰¾æœºä¼šä½¿ä»–ä»¬çš„åº”ç”¨ç¨‹åºæ›´å¿«ï¼å¦‚æœä½ å–œæ¬¢PHPï¼Œå¦‚æœä½ æ¸´æœ›æ‰§è¡Œæ•ˆç‡ï¼Œé‚£å°±åˆ«çŠ¹è±«èµ¶å¿«å°è¯•ä¸€ä¸‹Zephirå§ï¼</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Cache åº”ç”¨ä¸­çš„æœåŠ¡è¿‡è½½æ¡ˆä¾‹ç ”ç©¶]]></title>
      <url>http://team.jiunile.com/blog/2016/06/cache-server.html</url>
      <content type="html"><![CDATA[<p>ç®€å•åœ°è¯´ï¼Œè¿‡è½½æ˜¯å¤–éƒ¨è¯·æ±‚å¯¹ç³»ç»Ÿçš„è®¿é—®é‡çªç„¶æ¿€å¢ï¼Œé€ æˆè¯·æ±‚å †ç§¯ï¼ŒæœåŠ¡ä¸å¯ç”¨ï¼Œæœ€ç»ˆå¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚æœ¬æ–‡ä¸»è¦åˆ†æå¼•å…¥Cacheå¯èƒ½é€ æˆçš„æœåŠ¡è¿‡è½½ï¼Œå¹¶è®¨è®ºç›¸å…³çš„é¢„é˜²ã€æ¢å¤ç­–ç•¥ã€‚</p>
<p>Cacheåœ¨ç°ä»£ç³»ç»Ÿä¸­ä½¿ç”¨å¹¿æ³›ï¼Œç”±æ­¤å¼•å…¥çš„æœåŠ¡è¿‡è½½éšæ‚£æ— å¤„ä¸åœ¨ï¼Œä½†å´éå¸¸éšè”½ï¼Œå®¹æ˜“è¢«å¿½è§†ã€‚æœ¬æ–‡å¸Œæœ›èƒ½ä¸ºå¼€å‘è€…åœ¨è®¾è®¡å’Œç¼–å†™ç›¸å…³ç±»å‹åº”ç”¨ï¼Œä»¥åŠæœåŠ¡è¿‡è½½å‘ç”Ÿå¤„ç†æ—¶èƒ½å¤Ÿæœ‰ç« å¯å¾ªã€‚</p>
<h2 id="ä¸€ä¸ªæœåŠ¡è¿‡è½½æ¡ˆä¾‹"><a href="#ä¸€ä¸ªæœåŠ¡è¿‡è½½æ¡ˆä¾‹" class="headerlink" title="ä¸€ä¸ªæœåŠ¡è¿‡è½½æ¡ˆä¾‹"></a>ä¸€ä¸ªæœåŠ¡è¿‡è½½æ¡ˆä¾‹</h2><p>æœ¬æ–‡è®¨è®ºçš„æ¡ˆä¾‹æ˜¯æŒ‡å­˜åœ¨æ­£å¸¸è°ƒç”¨å…³ç³»çš„ä¸¤ä¸ªç³»ç»Ÿï¼ˆå‡è®¾è°ƒç”¨æ–¹ä¸ºAç³»ç»Ÿï¼ŒæœåŠ¡æ–¹ä¸ºBç³»ç»Ÿï¼‰ï¼ŒAç³»ç»Ÿå¯¹Bç³»ç»Ÿçš„è®¿é—®çªç„¶è¶…å‡ºBç³»ç»Ÿçš„æ‰¿å—èƒ½åŠ›ï¼Œé€ æˆBç³»ç»Ÿå´©æºƒã€‚é€ æˆæœåŠ¡è¿‡è½½çš„åŸå› å¾ˆå¤šï¼Œè¿™é‡Œåˆ†æçš„æ˜¯ä¸¥é‡ä¾èµ–Cacheçš„ç³»ç»ŸæœåŠ¡è¿‡è½½ã€‚é¦–å…ˆæ¥çœ‹ä¸€ç§åŒ…å«Cacheçš„ä½“ç³»ç»“æ„ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ã€‚<br><img src="/images/2_cache.png" alt="Cacheåº”ç”¨ä½“ç³»ç»“æ„"></p>
<p>Aç³»ç»Ÿä¾èµ–Bç³»ç»Ÿçš„è¯»æœåŠ¡ï¼ŒAç³»ç»Ÿæ˜¯60å°æœºå™¨ç»„æˆçš„é›†ç¾¤ï¼ŒBç³»ç»Ÿæ˜¯6å°æœºå™¨ç»„æˆçš„é›†ç¾¤ï¼Œä¹‹æ‰€ä»¥6å°æœºå™¨èƒ½å¤Ÿæ‰›ä½60å°æœºå™¨çš„è®¿é—®ï¼Œæ˜¯å› ä¸ºAç³»ç»Ÿå¹¶ä¸æ˜¯æ¯æ¬¡éƒ½è®¿é—®Bï¼Œè€Œæ˜¯é¦–å…ˆè¯·æ±‚Cacheï¼Œåªæœ‰Cacheçš„ç›¸åº”æ•°æ®å¤±æ•ˆæ—¶æ‰ä¼šè¯·æ±‚Bã€‚<br><a id="more"></a><br>è¿™æ­£æ˜¯Cacheå­˜åœ¨çš„æ„ä¹‰ï¼Œå®ƒè®©Bç³»ç»ŸèŠ‚çœäº†å¤§é‡æœºå™¨ï¼›å¦‚æœæ²¡æœ‰Cacheï¼ŒBç³»ç»Ÿä¸å¾—ä¸ç»„æˆ60å°æœºå™¨çš„é›†ç¾¤ï¼Œå¦‚æœAä¹ŸåŒæ—¶ä¾èµ–é™¤Bç³»ç»Ÿå¤–çš„å¦ä¸€ä¸ªç³»ç»Ÿï¼ˆå‡è®¾ä¸ºCç³»ç»Ÿï¼‰å‘¢ï¼Ÿé‚£ä¹ˆCç³»ç»Ÿä¹Ÿè¦60å°æœºå™¨ï¼Œæ”¾å¤§çš„æµé‡å°†å¾ˆå¿«è€—å°½å…¬å¸çš„èµ„æºã€‚</p>
<p>ç„¶è€ŒCacheçš„å¼•å…¥ä¹Ÿä¸æ˜¯åå…¨åç¾çš„ï¼Œè¿™ä¸ªç»“æ„ä¸­å¦‚æœCacheå‘ç”Ÿé—®é¢˜ï¼Œå…¨éƒ¨çš„æµé‡å°†æµå‘ä¾èµ–æ–¹ï¼Œé€ æˆæµé‡æ¿€å¢ï¼Œä»è€Œå¼•å‘ä¾èµ–ç³»ç»Ÿçš„è¿‡è½½ã€‚</p>
<p>å›åˆ°Aå’ŒBçš„æ¶æ„ï¼Œé€ æˆæœåŠ¡è¿‡è½½çš„åŸå› è‡³å°‘æœ‰ä¸‹é¢ä¸‰ç§ï¼š</p>
<ul>
<li>Bç³»ç»Ÿçš„å‰ç½®ä»£ç†å‘ç”Ÿæ•…éšœæˆ–è€…å…¶ä»–åŸå› é€ æˆBç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨ï¼Œç­‰Bç³»ç»Ÿç³»ç»ŸæœåŠ¡æ¢å¤æ—¶ï¼Œå…¶æµé‡å°†è¿œè¿œè¶…è¿‡æ­£å¸¸å€¼ã€‚</li>
<li>Cacheç³»ç»Ÿæ•…éšœï¼ŒAç³»ç»Ÿçš„æµé‡å°†å…¨éƒ¨æµåˆ°Bç³»ç»Ÿï¼Œé€ æˆBç³»ç»Ÿè¿‡è½½ã€‚</li>
<li>Cacheæ•…éšœæ¢å¤ï¼Œä½†è¿™æ—¶Cacheä¸ºç©ºï¼ŒCacheç¬é—´å‘½ä¸­ç‡ä¸º0ï¼Œç›¸å½“äºCacheè¢«å‡»ç©¿ï¼Œé€ æˆBç³»ç»Ÿè¿‡è½½ã€‚</li>
</ul>
<p>ç¬¬ä¸€ä¸ªåŸå› ä¸å¤ªå¥½ç†è§£ï¼Œä¸ºä»€ä¹ˆBç³»ç»Ÿæ¢å¤åæµé‡ä¼šçŒ›å¢å‘¢ï¼Ÿä¸»è¦åŸå› å°±æ˜¯ç¼“å­˜çš„è¶…æ—¶æ—¶é—´ã€‚å½“æœ‰æ•°æ®è¶…æ—¶çš„æ—¶å€™ï¼ŒAç³»ç»Ÿä¼šè®¿é—®Bç³»ç»Ÿï¼Œä½†æ˜¯è¿™æ—¶å€™Bç³»ç»Ÿååæ•…éšœä¸å¯ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®åªå¥½è¶…æ—¶ï¼Œç­‰å‘ç°Bç³»ç»Ÿæ¢å¤æ—¶ï¼Œå‘ç°ç¼“å­˜é‡Œçš„Bç³»ç»Ÿæ•°æ®å·²ç»éƒ½è¶…æ—¶äº†ï¼Œéƒ½æˆäº†æ—§æ•°æ®ï¼Œè¿™æ—¶å½“ç„¶æ‰€æœ‰çš„è¯·æ±‚å°±æ‰“åˆ°äº†Bã€‚</p>
<p>ä¸‹æ–‡ä¸»è¦ä»‹ç»æœåŠ¡è¿‡è½½çš„é¢„é˜²å’Œå‘ç”Ÿåçš„ä¸€äº›è¡¥æ•‘æ–¹æ³•ï¼Œä»¥é¢„é˜²ä¸ºä¸»ï¼Œä»è°ƒç”¨æ–¹å’ŒæœåŠ¡æ–¹çš„è§†è§’é˜è¿°ä¸€äº›å¯è¡Œæ–¹æ¡ˆã€‚</p>
<h2 id="æœåŠ¡è¿‡è½½çš„é¢„é˜²"><a href="#æœåŠ¡è¿‡è½½çš„é¢„é˜²" class="headerlink" title="æœåŠ¡è¿‡è½½çš„é¢„é˜²"></a>æœåŠ¡è¿‡è½½çš„é¢„é˜²</h2><p>æ‰€è°“Clientç«¯æŒ‡çš„å°±æ˜¯ä¸Šæ–‡ç»“æ„ä¸­çš„Aç³»ç»Ÿï¼Œç›¸å¯¹äºBç³»ç»Ÿï¼ŒAç³»ç»Ÿå°±æ˜¯Bç³»ç»Ÿçš„Clientï¼ŒBç³»ç»Ÿç›¸å½“äºServerã€‚</p>
<h3 id="Clientç«¯çš„æ–¹æ¡ˆ"><a href="#Clientç«¯çš„æ–¹æ¡ˆ" class="headerlink" title="Clientç«¯çš„æ–¹æ¡ˆ"></a>Clientç«¯çš„æ–¹æ¡ˆ</h3><p>é’ˆå¯¹ä¸Šæ–‡é˜è¿°çš„é€ æˆæœåŠ¡è¿‡è½½çš„ä¸‰ä¸ªåŸå› ï¼šBç³»ç»Ÿæ•…éšœæ¢å¤ã€Cacheæ•…éšœã€Cacheæ•…éšœæ¢å¤ï¼Œæˆ‘ä»¬çœ‹çœ‹Aç³»ç»Ÿæœ‰å“ªäº›æ–¹æ¡ˆå¯ä»¥åº”å¯¹ã€‚</p>
<blockquote>
<p>åˆç†ä½¿ç”¨Cacheåº”å¯¹Bç³»ç»Ÿå®•æœº</p>
</blockquote>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒCacheçš„æ¯ä¸ªKeyé™¤äº†å¯¹åº”Valueï¼Œè¿˜å¯¹åº”ä¸€ä¸ªè¿‡æœŸæ—¶é—´Tï¼Œåœ¨Tå†…ï¼Œgetæ“ä½œç›´æ¥åœ¨Cacheä¸­æ‹¿åˆ°Keyå¯¹åº”Valueå¹¶è¿”å›ã€‚ä½†æ˜¯åœ¨Tåˆ°è¾¾æ—¶ï¼Œgetæ“ä½œä¸»è¦æœ‰äº”ç§æ¨¡å¼ï¼š</p>
<h4 id="åŸºäºè¶…æ—¶çš„ç®€å•ï¼ˆstupidï¼‰æ¨¡å¼"><a href="#åŸºäºè¶…æ—¶çš„ç®€å•ï¼ˆstupidï¼‰æ¨¡å¼" class="headerlink" title="åŸºäºè¶…æ—¶çš„ç®€å•ï¼ˆstupidï¼‰æ¨¡å¼"></a>åŸºäºè¶…æ—¶çš„ç®€å•ï¼ˆstupidï¼‰æ¨¡å¼</h4><p>åœ¨Tåˆ°è¾¾åï¼Œä»»ä½•çº¿ç¨‹getæ“ä½œå‘ç°Cacheä¸­çš„Keyå’Œå¯¹åº”Valueå°†è¢«æ¸…é™¤æˆ–æ ‡è®°ä¸ºä¸å¯ç”¨ï¼Œgetæ“ä½œå°†å‘èµ·è°ƒç”¨è¿œç¨‹æœåŠ¡è·å–Keyå¯¹åº”çš„Valueï¼Œå¹¶æ›´æ–°å†™å›Cacheï¼Œç„¶ågetæ“ä½œè¿”å›æ–°å€¼ï¼›å¦‚æœè¿œç¨‹è·å–Key-Valueå¤±è´¥ï¼Œåˆ™getæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>ä¸ºäº†ä¾¿äºç†è§£ï¼Œä¸¾ä¸€ä¸ªç å¤´å·¥äººå–è´§çš„ä¾‹å­ï¼š5ä¸ªå·¥äººï¼ˆçº¿ç¨‹ï¼‰å»æ¸¯å£å–åŒæ ·Keyçš„è´§ï¼ˆgetï¼‰ï¼Œå‘ç°è´§å·²ç»è¿‡æœŸè¢«æ‰”æ‰äº†ï¼Œè¿™æ—¶5ä¸ªå·¥äººå„è‡ªåˆ†åˆ«å»å¯¹å²¸å–æ–°è´§ï¼Œç„¶åè¿”å›ã€‚</p>
<h4 id="åŸºäºè¶…æ—¶çš„å¸¸è§„æ¨¡å¼"><a href="#åŸºäºè¶…æ—¶çš„å¸¸è§„æ¨¡å¼" class="headerlink" title="åŸºäºè¶…æ—¶çš„å¸¸è§„æ¨¡å¼"></a>åŸºäºè¶…æ—¶çš„å¸¸è§„æ¨¡å¼</h4><p>åœ¨Tåˆ°è¾¾åï¼ŒCacheä¸­çš„Keyå’Œå¯¹åº”Valueå°†è¢«æ¸…é™¤æˆ–æ ‡è®°ä¸ºä¸å¯ç”¨ï¼Œgetæ“ä½œå°†è°ƒç”¨è¿œç¨‹æœåŠ¡è·å–Keyå¯¹åº”çš„Valueï¼Œå¹¶æ›´æ–°å†™å›Cacheï¼›æ­¤æ—¶ï¼Œå¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹å‘ç°Keyå’ŒValueå·²ç»ä¸å¯ç”¨ï¼Œgetæ“ä½œè¿˜éœ€è¦åˆ¤æ–­æœ‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹å‘èµ·äº†è¿œç¨‹è°ƒç”¨ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆè‡ªå·±å°±ç­‰å¾…ï¼Œç›´åˆ°é‚£ä¸ªçº¿ç¨‹è¿œç¨‹è·å–æ“ä½œæˆåŠŸï¼ŒCacheä¸­å¾—Keyå˜å¾—å¯ç”¨ï¼Œgetæ“ä½œè¿”å›æ–°çš„Valueã€‚å¦‚æœè¿œç¨‹è·å–æ“ä½œå¤±è´¥ï¼Œåˆ™getæ“ä½œæŠ›å‡ºå¼‚å¸¸ï¼Œä¸ä¼šè¿”å›ä»»ä½•Valueã€‚</p>
<p>è¿˜æ˜¯ç å¤´å·¥äººçš„ä¾‹å­ï¼š5ä¸ªå·¥äººï¼ˆçº¿ç¨‹ï¼‰å»æ¸¯å£å–åŒæ ·Keyçš„è´§ï¼ˆgetï¼‰ï¼Œå‘ç°è´§å·²ç»è¿‡æœŸè¢«æ‰”æ‰äº†ï¼Œé‚£ä¹ˆåªéœ€æ´¾å‡ºä¸€ä¸ªäººå»å¯¹å²¸å–è´§ï¼Œå…¶ä»–å››ä¸ªäººåœ¨æ¸¯å£ç­‰å¾…å³å¯ï¼Œè€Œä¸ç”¨5ä¸ªäººå…¨å»ã€‚</p>
<p>åŸºäºè¶…æ—¶çš„ç®€å•æ¨¡å¼å’Œå¸¸è§„æ¨¡å¼åŒºåˆ«åœ¨äºå¯¹äºåŒä¸€ä¸ªè¶…æ—¶çš„Keyï¼Œå‰è€…æ¯ä¸ªgetçº¿ç¨‹ä¸€æ—¦å‘ç°Keyä¸å­˜åœ¨ï¼Œåˆ™å‘èµ·è¿œç¨‹è°ƒç”¨è·å–å€¼ï¼›è€Œåè€…æ¯ä¸ªgetçº¿ç¨‹å‘ç°Keyä¸å­˜åœ¨ï¼Œåˆ™è¿˜è¦åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹å·²ç»å‘èµ·äº†è¿œç¨‹è°ƒç”¨æ“ä½œè·å–æ–°å€¼ï¼Œå¦‚æœæœ‰ï¼Œè‡ªå·±å°±ç®€å•çš„ç­‰å¾…å³å¯ã€‚</p>
<p>æ˜¾ç„¶åŸºäºè¶…æ—¶çš„å¸¸è§„æ¨¡å¼æ¯”åŸºäºè¶…æ—¶çš„ç®€å•æ¨¡å¼æ›´åŠ ä¼˜åŒ–ï¼Œå‡å°‘äº†è¶…æ—¶æ—¶å¹¶å‘è®¿é—®åç«¯çš„è°ƒç”¨é‡ã€‚</p>
<p>å®ç°åŸºäºè¶…æ—¶çš„å¸¸è§„æ¨¡å¼å°±éœ€è¦ç”¨åˆ°ç»å…¸çš„Double-checked lockingæƒ¯ç”¨æ³•äº†ã€‚</p>
<h4 id="åŸºäºåˆ·æ–°çš„ç®€å•ï¼ˆstupidï¼‰æ¨¡å¼"><a href="#åŸºäºåˆ·æ–°çš„ç®€å•ï¼ˆstupidï¼‰æ¨¡å¼" class="headerlink" title="åŸºäºåˆ·æ–°çš„ç®€å•ï¼ˆstupidï¼‰æ¨¡å¼"></a>åŸºäºåˆ·æ–°çš„ç®€å•ï¼ˆstupidï¼‰æ¨¡å¼</h4><p>åœ¨Tåˆ°è¾¾åï¼ŒCacheä¸­çš„Keyå’Œç›¸åº”Valueä¸åŠ¨ï¼Œä½†æ˜¯å¦‚æœæœ‰çº¿ç¨‹è°ƒç”¨getæ“ä½œï¼Œå°†è§¦å‘refreshæ“ä½œï¼Œæ ¹æ®getå’Œrefreshçš„åŒæ­¥å…³ç³»ï¼Œåˆåˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼š</p>
<ul>
<li>åŒæ­¥æ¨¡å¼ï¼šä»»ä½•çº¿ç¨‹å‘ç°Keyè¿‡æœŸï¼Œéƒ½è§¦å‘ä¸€æ¬¡refreshæ“ä½œï¼Œgetæ“ä½œç­‰å¾…refreshæ“ä½œç»“æŸï¼Œrefreshç»“æŸåï¼Œgetæ“ä½œè¿”å›å½“å‰Cacheä¸­Keyå¯¹åº”çš„Valueã€‚æ³¨æ„refreshæ“ä½œç»“æŸå¹¶ä¸æ„å‘³ç€refreshæˆåŠŸï¼Œè¿˜å¯èƒ½æŠ›äº†å¼‚å¸¸ï¼Œæ²¡æœ‰æ›´æ–°Cacheï¼Œä½†æ˜¯getæ“ä½œä¸ç®¡ï¼Œgetæ“ä½œè¿”å›çš„å€¼å¯èƒ½æ˜¯æ—§å€¼ã€‚</li>
<li>å¼‚æ­¥æ¨¡å¼ï¼šä»»ä½•çº¿ç¨‹å‘ç°Keyè¿‡æœŸï¼Œéƒ½è§¦å‘ä¸€æ¬¡refreshæ“ä½œï¼Œgetæ“ä½œè§¦å‘refreshæ“ä½œï¼Œä¸ç­‰refreshå®Œæˆï¼Œç›´æ¥è¿”å›Cacheä¸­çš„æ—§å€¼ã€‚</li>
</ul>
<p>ä¸¾ä¸Šé¢ç å¤´å·¥äººçš„ä¾‹å­è¯´æ˜åŸºäºåˆ·æ–°çš„å¸¸è§„æ¨¡å¼ï¼šè¿™æ¬¡è¿˜æ˜¯5å·¥äººå»æ¸¯å£å–è´§ï¼Œè¿™æ—¶è´§éƒ½åœ¨ï¼Œä½†æ˜¯å·²ç»æ—§äº†ï¼Œè¿™æ—¶5ä¸ªå·¥äººæœ‰ä¸¤ç§é€‰æ‹©ï¼š</p>
<ul>
<li>5ä¸ªäººå„è‡ªå»è¿œç¨‹å–æ–°è´§ï¼Œå¦‚æœå–è´§å¤±è´¥ï¼Œåˆ™æ‹¿ç€æ—§è´§è¿”å›ï¼ˆåŒæ­¥æ¨¡å¼ï¼‰</li>
<li>5ä¸ªäººå„è‡ªé€šçŸ¥5ä¸ªé›‡ä½£å·¥å»å–æ–°è´§ï¼Œ5ä¸ªå·¥äººæ‹¿ç€æ—§è´§å…ˆå›ï¼ˆå¼‚æ­¥æ¨¡å¼ï¼‰</li>
</ul>
<h4 id="åŸºäºåˆ·æ–°çš„å¸¸è§„æ¨¡å¼"><a href="#åŸºäºåˆ·æ–°çš„å¸¸è§„æ¨¡å¼" class="headerlink" title="åŸºäºåˆ·æ–°çš„å¸¸è§„æ¨¡å¼"></a>åŸºäºåˆ·æ–°çš„å¸¸è§„æ¨¡å¼</h4><p>åœ¨Tåˆ°è¾¾åï¼ŒCacheä¸­çš„Keyå’Œç›¸åº”Valueéƒ½ä¸ä¼šè¢«æ¸…é™¤ï¼Œè€Œæ˜¯è¢«æ ‡è®°ä¸ºæ—§æ•°æ®ï¼Œå¦‚æœæœ‰çº¿ç¨‹è°ƒç”¨getæ“ä½œï¼Œå°†è§¦å‘refreshæ›´æ–°æ“ä½œï¼Œæ ¹æ®getå’Œrefreshçš„åŒæ­¥å…³ç³»ï¼Œåˆåˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼š</p>
<ul>
<li>åŒæ­¥æ¨¡å¼ï¼šgetæ“ä½œç­‰å¾…refreshæ“ä½œç»“æŸï¼Œrefreshç»“æŸåï¼Œgetæ“ä½œè¿”å›å½“å‰Cacheä¸­Keyå¯¹åº”çš„Valueï¼Œæ³¨æ„ï¼šrefreshæ“ä½œç»“æŸå¹¶ä¸æ„å‘³ç€refreshæˆåŠŸï¼Œè¿˜å¯èƒ½æŠ›äº†å¼‚å¸¸ï¼Œæ²¡æœ‰æ›´æ–°Cacheï¼Œä½†æ˜¯getæ“ä½œä¸ç®¡ï¼Œgetæ“ä½œè¿”å›çš„å€¼å¯èƒ½æ˜¯æ—§å€¼ã€‚å¦‚æœå…¶ä»–çº¿ç¨‹è¿›è¡Œgetæ“ä½œï¼ŒKeyå·²ç»è¿‡æœŸï¼Œå¹¶ä¸”å‘ç°æœ‰çº¿ç¨‹è§¦å‘äº†refreshæ“ä½œï¼Œåˆ™è‡ªå·±ä¸ç­‰refreshå®Œæˆç›´æ¥è¿”å›æ—§å€¼ã€‚</li>
<li>å¼‚æ­¥æ¨¡å¼ï¼šgetæ“ä½œè§¦å‘refreshæ“ä½œï¼Œä¸ç­‰refreshå®Œæˆï¼Œç›´æ¥è¿”å›Cacheä¸­çš„æ—§å€¼ã€‚å¦‚æœå…¶ä»–çº¿ç¨‹è¿›è¡Œgetæ“ä½œï¼Œå‘ç°Keyå·²ç»è¿‡æœŸï¼Œå¹¶ä¸”å‘ç°æœ‰çº¿ç¨‹è§¦å‘äº†refreshæ“ä½œï¼Œåˆ™è‡ªå·±ä¸ç­‰refreshå®Œæˆç›´æ¥è¿”å›æ—§å€¼ã€‚</li>
</ul>
<p>å†ä¸¾ä¸Šé¢ç å¤´å·¥äººçš„ä¾‹å­è¯´æ˜åŸºäºåˆ·æ–°çš„å¸¸è§„æ¨¡å¼ï¼šè¿™æ¬¡è¿˜æ˜¯5å·¥äººå»æ¸¯å£å–è´§ï¼Œè¿™æ—¶è´§éƒ½åœ¨ï¼Œä½†æ˜¯å·²ç»æ—§äº†ï¼Œè¿™æ—¶5ä¸ªå·¥äººæœ‰ä¸¤ç§é€‰æ‹©ï¼š</p>
<ul>
<li>æ´¾ä¸€ä¸ªäººå»è¿œæ–¹æ¸¯å£å–æ–°è´§ï¼Œå…¶ä½™4ä¸ªäººæ‹¿ç€æ—§è´§å…ˆå›ï¼ˆåŒæ­¥æ¨¡å¼ï¼‰ã€‚</li>
<li>5ä¸ªäººé€šçŸ¥ä¸€ä¸ªé›‡ä½£å·¥å»è¿œæ–¹å–æ–°è´§ï¼Œ5ä¸ªäººéƒ½æ‹¿ç€æ—§è´§å…ˆå›ï¼ˆå¼‚æ­¥æ¨¡å¼ï¼‰ã€‚</li>
</ul>
<p>åŸºäºåˆ·æ–°çš„ç®€å•æ¨¡å¼å’ŒåŸºäºåˆ·æ–°çš„å¸¸è§„æ¨¡å¼åŒºåˆ«å°±åœ¨äºå–æ•°çº¿ç¨‹ä¹‹é—´èƒ½å¦æ„ŸçŸ¥å½“å‰æ•°æ®æ˜¯å¦æ­£å¤„åœ¨åˆ·æ–°çŠ¶æ€ï¼Œå› ä¸ºåŸºäºåˆ·æ–°çš„ç®€å•æ¨¡å¼ä¸­å–æ•°çº¿ç¨‹æ— æ³•æ„ŸçŸ¥å½“å‰è¿‡æœŸæ•°æ®æ˜¯å¦æ­£å¤„åœ¨åˆ·æ–°çŠ¶æ€ï¼Œæ‰€ä»¥æ¯ä¸ªå–æ•°çº¿ç¨‹éƒ½ä¼šè§¦å‘ä¸€ä¸ªåˆ·æ–°æ“ä½œï¼Œé€ æˆä¸€å®šçš„çº¿ç¨‹èµ„æºæµªè´¹ã€‚</p>
<p>è€ŒåŸºäºè¶…æ—¶çš„å¸¸è§„æ¨¡å¼å’ŒåŸºäºåˆ·æ–°çš„å¸¸è§„æ¨¡å¼åŒºåˆ«åœ¨äºå‰è€…è¿‡æœŸæ•°æ®å°†ä¸èƒ½å¯¹å¤–è®¿é—®ï¼Œæ‰€ä»¥ä¸€æ—¦æ•°æ®è¿‡æœŸï¼Œå„çº¿ç¨‹è¦ä¹ˆæ‹¿åˆ°æ•°æ®ï¼Œè¦ä¹ˆæŠ›å‡ºå¼‚å¸¸ï¼›åè€…è¿‡æœŸæ•°æ®å¯ä»¥å¯¹å¤–è®¿é—®ï¼Œæ‰€ä»¥ä¸€æ—¦æ•°æ®è¿‡æœŸï¼Œå„çº¿ç¨‹è¦ä¹ˆæ‹¿åˆ°æ–°æ•°æ®ï¼Œè¦ä¹ˆæ‹¿åˆ°æ—§æ•°æ®ã€‚</p>
<h4 id="åŸºäºåˆ·æ–°çš„ç»­è´¹æ¨¡å¼"><a href="#åŸºäºåˆ·æ–°çš„ç»­è´¹æ¨¡å¼" class="headerlink" title="åŸºäºåˆ·æ–°çš„ç»­è´¹æ¨¡å¼"></a>åŸºäºåˆ·æ–°çš„ç»­è´¹æ¨¡å¼</h4><p>è¯¥æ¨¡å¼å’ŒåŸºäºåˆ·æ–°çš„å¸¸è§„æ¨¡å¼å”¯ä¸€çš„åŒºåˆ«åœ¨äºrefreshæ“ä½œè¶…æ—¶æˆ–å¤±è´¥çš„å¤„ç†ä¸Šã€‚åœ¨åŸºäºåˆ·æ–°çš„å¸¸è§„æ¨¡å¼ä¸­ï¼Œrefreshæ“ä½œè¶…æ—¶æˆ–å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸ï¼ŒCacheä¸­çš„ç›¸åº”Key-Valueè¿˜æ˜¯æ—§å€¼ï¼Œè¿™æ ·ä¸‹ä¸€ä¸ªgetæ“ä½œåˆ°æ¥æ—¶åˆä¼šè§¦å‘ä¸€æ¬¡refreshæ“ä½œã€‚</p>
<p>åœ¨åŸºäºåˆ·æ–°çš„ç»­è´¹æ¨¡å¼ä¸­ï¼Œå¦‚æœrefreshæ“ä½œå¤±è´¥ï¼Œé‚£ä¹ˆrefreshå°†æŠŠæ—§å€¼å½“æˆæ–°å€¼è¿”å›ï¼Œè¿™æ ·å°±ç›¸å½“äºæ—§å€¼åˆè¢«ç»­è´¹äº†Tæ—¶é—´ï¼Œåç»­Tæ—¶é—´å†…getæ“ä½œå°†å–åˆ°è¿™ä¸ªç»­è´¹çš„æ—§å€¼è€Œä¸ä¼šè§¦å‘refreshæ“ä½œã€‚</p>
<p>åŸºäºåˆ·æ–°çš„ç»­è´¹æ¨¡å¼ä¹Ÿåƒå¸¸è§„æ¨¡å¼é‚£æ ·åˆ†ä¸ºåŒæ­¥æ¨¡å¼å’Œå¼‚æ­¥æ¨¡å¼ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<p>ä¸‹é¢è®¨è®ºè¿™5ç§Cache getæ¨¡å¼åœ¨æœåŠ¡è¿‡è½½å‘ç”Ÿæ—¶çš„è¡¨ç°ï¼Œé¦–å…ˆå‡è®¾å¦‚ä¸‹ï¼š</p>
<ul>
<li>å‡è®¾Aç³»ç»Ÿçš„è®¿é—®é‡ä¸ºæ¯åˆ†é’ŸMæ¬¡ã€‚</li>
<li>å‡è®¾Cacheèƒ½å­˜Keyä¸ºCä¸ªï¼Œå¹¶ä¸”Keyç©ºé—´æœ‰Nä¸ªã€‚</li>
<li>å‡è®¾æ­£å¸¸çŠ¶æ€ä¸‹ï¼ŒBç³»ç»Ÿè®¿é—®é‡ä¸ºæ¯åˆ†é’ŸWæ¬¡ï¼Œæ˜¾ç„¶W&lt;N&lt;Mã€‚</li>
</ul>
<p>è¿™æ—¶å› ä¸ºæŸç§åŸå› ï¼Œæ¯”å¦‚Bé•¿æ—¶é—´æ•…éšœï¼Œé€ æˆCacheä¸­å¾—Keyå…¨éƒ¨è¿‡æœŸï¼ŒBç³»ç»Ÿè¿™æ—¶ä»æ•…éšœä¸­æ¢å¤ï¼Œäº”ç§getæ¨¡å¼åˆ†æè¡¨ç°åˆ†æå¦‚ä¸‹ï¼š</p>
<ul>
<li>åœ¨åŸºäºè¶…æ—¶å’Œåˆ·æ–°çš„ç®€å•æ¨¡å¼ä¸­ï¼ŒBç³»ç»Ÿçš„ç¬é—´æµé‡å°†è¾¾åˆ°å’ŒAçš„ç¬æ—¶æµé‡Må¤§ä½“ç­‰åŒï¼Œç›¸å½“äºCacheè¢«å‡»ç©¿ã€‚è¿™å°±å‘ç”Ÿäº†æœåŠ¡è¿‡è½½ï¼Œè¿™æ—¶åˆšåˆšæ¢å¤çš„Bç³»ç»Ÿå°†è‚¯å®šä¼šè¢«å¤§æµé‡å‹å®ã€‚</li>
<li>åœ¨åŸºäºè¶…æ—¶å’Œåˆ·æ–°çš„å¸¸è§„æ¨¡å¼ä¸­ï¼ŒBç³»ç»Ÿçš„ç¬é—´æµé‡å°†å’ŒCacheä¸­Keyç©ºé—´Nå¤§ä½“ç­‰åŒã€‚è¿™æ—¶æ˜¯å¦å‘ç”ŸæœåŠ¡è¿‡è½½ï¼Œå°±è¦çœ‹Keyç©ºé—´Næ˜¯å¦è¶…è¿‡Bç³»ç»Ÿçš„æµé‡ä¸Šé™äº†ã€‚</li>
<li>åœ¨åŸºäºåˆ·æ–°çš„ç»­è´¹æ¨¡å¼ä¸­ï¼ŒBç³»ç»Ÿçš„ç¬é—´æµé‡ä¸ºWï¼Œå’Œæ­£å¸¸æƒ…å†µç›¸åŒè€Œä¸ä¼šå‘ç”ŸæœåŠ¡è¿‡è½½ã€‚å®é™…ä¸Šï¼Œåœ¨åŸºäºåˆ·æ–°çš„ç»­è´¹æ¨¡å¼ä¸­ï¼Œä¸å­˜åœ¨Cache Keyå…¨éƒ¨è¿‡æœŸçš„æƒ…å†µï¼Œå°±ç®—æŠŠBç³»ç»Ÿæ°¸ä¹…æ€§åœ°å¹²æ‰ï¼ŒAç³»ç»Ÿçš„Cacheä¹Ÿä¼šåŸºäºæ—§å€¼é•¿ä¹…çš„å¹³ç¨³è¿è¡Œã€‚</li>
</ul>
<p>ç¬¬3ç‚¹ï¼ŒBç³»ç»Ÿä¸ä¼šå‘ç”ŸæœåŠ¡è¿‡è½½çš„ä¸»è¦åŸå› æ˜¯åŸºäºåˆ·æ–°çš„ç»­è´¹æ¨¡å¼ä¸‹ä¸ä¼šå‡ºç°chacheä¸­çš„Keyå…¨éƒ¨é•¿æ—¶é—´è¿‡æœŸçš„æƒ…å†µï¼Œå³ä½¿Bç³»ç»Ÿé•¿æ—¶é—´ä¸å¯ç”¨ï¼ŒåŸºäºåˆ·æ–°çš„ç»­è´¹æ¨¡å¼ä¹Ÿä¼šåœ¨ä¸€ä¸ªè¿‡æœŸå‘¨æœŸå†…æŠŠæ—§å€¼å½“æˆæ–°å€¼ç»§ç»­ä½¿ç”¨ã€‚æ‰€ä»¥å½“Bç³»ç»Ÿæ¢å¤æ—¶ï¼ŒAç³»ç»Ÿçš„Cacheéƒ½å¤„åœ¨æ­£å¸¸å·¥ä½œçŠ¶æ€ã€‚</p>
<p>ä»Bç³»ç»Ÿçš„è§’åº¦çœ‹ï¼Œèƒ½å¤ŸæŠµæŠ—æœåŠ¡è¿‡è½½çš„åŸºäºåˆ·æ–°çš„ç»­è´¹æ¨¡å¼æœ€ä¼˜ã€‚</p>
<p>ä»Aç³»ç»Ÿçš„è§’åº¦çœ‹ï¼Œç”±äºä¸€èˆ¬æƒ…å†µä¸‹Aç³»ç»Ÿæ˜¯ä¸€ä¸ªé«˜è®¿é—®é‡çš„åœ¨çº¿webåº”ç”¨ï¼Œè¿™ç§åº”ç”¨æœ€è®¨åŒçš„ä¸€ä¸ªè¯å°±æ˜¯â€œçº¿ç¨‹ç­‰å¾…â€ï¼Œå› æ­¤åŸºäºåˆ·æ–°çš„å„ç§å¼‚æ­¥æ¨¡å¼è¾ƒä¼˜ã€‚</p>
<p>ç»¼åˆè€ƒè™‘ï¼ŒåŸºäºåˆ·æ–°çš„å¼‚æ­¥ç»­è´¹æ¨¡å¼æ˜¯é¦–é€‰ã€‚ç„¶è€Œå‡¡äº‹æœ‰åˆ©å°±æœ‰å¼Šï¼Œæœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š</p>
<ul>
<li>åŸºäºåˆ·æ–°æ¨¡å¼æœ€å¤§çš„ç¼ºç‚¹æ˜¯Key-Valueä¸€æ—¦æ”¾å…¥Cacheå°±ä¸ä¼šè¢«æ¸…é™¤ï¼Œæ¯æ¬¡æ›´æ–°ä¹Ÿæ˜¯æ–°å€¼è¦†ç›–æ—§å€¼ï¼ŒJVM GCæ°¸è¿œæ— æ³•å¯¹å…¶è¿›è¡Œåƒåœ¾æ”¶é›†ï¼Œè€ŒåŸºäºè¶…æ—¶çš„æ¨¡å¼ä¸­ï¼ŒKey-Valueè¶…æ—¶åå¦‚æœæ–°çš„è®¿é—®æ²¡æœ‰åˆ°æ¥ï¼Œå†…å­˜æ˜¯å¯ä»¥è¢«GCåƒåœ¾å›æ”¶çš„ã€‚æ‰€ä»¥å¦‚æœä½ ä½¿ç”¨çš„æ˜¯å¯¸åœŸå¯¸é‡‘çš„æœ¬åœ°å†…å­˜åšCacheå°±è¦å°å¿ƒäº†ã€‚</li>
<li>åŸºäºåˆ·æ–°çš„ç»­è´¹æ¨¡å¼éœ€è¦åšå¥½ç›‘æ§ï¼Œä¸ç„¶æœ‰å¯èƒ½Cacheä¸­çš„å€¼å·²ç»å’ŒçœŸå®çš„å€¼ç›¸å·®å¾ˆè¿œäº†ï¼Œåº”ç”¨è¿˜ä»¥ä¸ºæ˜¯æ–°å€¼è€Œä½¿ç”¨ã€‚</li>
</ul>
<p>å…³äºå…·ä½“çš„Cacheï¼Œæ¥è‡ªGoogleçš„Guavaæœ¬åœ°ç¼“å­˜åº“æ”¯æŒä¸Šæ–‡çš„ç¬¬äºŒç§ã€ç¬¬å››ç§å’Œç¬¬äº”ç§getæ“ä½œæ¨¡å¼ã€‚</p>
<p>ä½†æ˜¯å¯¹äºRedisç­‰åˆ†å¸ƒå¼ç¼“å­˜ï¼Œåªæä¾›åŸå§‹çš„getã€setæ–¹æ³•ï¼Œè€Œæä¾›çš„getä»…ä»…æ˜¯è·å–ï¼Œä¸ä¸Šæ–‡æåˆ°çš„äº”ç§getæ“ä½œæ¨¡å¼ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µã€‚å¼€å‘è€…æƒ³ç”¨è¿™äº”ç§getæ“ä½œæ¨¡å¼çš„è¯ä¸å¾—ä¸è‡ªå·±å°è£…å’Œå®ç°ã€‚</p>
<p>äº”ç§getæ“ä½œæ¨¡å¼ä¸­ï¼ŒåŸºäºè¶…æ—¶å’Œåˆ·æ–°çš„ç®€å•æ¨¡å¼æ˜¯å®ç°èµ·æ¥æœ€ç®€å•çš„æ¨¡å¼ï¼Œä½†é—æ†¾çš„æ˜¯è¿™ä¸¤ç§æ¨¡å¼å¯¹æœåŠ¡è¿‡è½½å®Œå…¨æ— å…ç–«åŠ›ï¼Œè¿™å¯èƒ½ä¹Ÿæ˜¯æœåŠ¡è¿‡è½½åœ¨å¤§é‡ä¾èµ–ç¼“å­˜çš„ç³»ç»Ÿä¸­é¢‘ç¹å‘ç”Ÿçš„ä¸€ä¸ªé‡è¦åŸå› å§ã€‚</p>
<p>æœ¬æ–‡ä¹‹æ‰€ä»¥æŠŠç¬¬1ã€3ç§æ¨¡å¼ç§°ä¸ºstupidæ¨¡å¼ï¼Œæ˜¯æƒ³å¼ºè°ƒè¿™ç§æ¨¡å¼åº”è¯¥å°½é‡é¿å…ï¼ŒGuavaé‡Œé¢æ ¹æœ¬æ²¡æœ‰è¿™ç§æ¨¡å¼ï¼Œè€ŒRedisåªæä¾›ç®€å•çš„è¯»å†™æ“ä½œï¼Œå¾ˆå®¹æ˜“å°±æŠŠç³»ç»Ÿå®ç°æˆäº†è¿™ç§æ–¹å¼ã€‚</p>
<blockquote>
<p>åº”å¯¹åˆ†å¸ƒå¼Cacheå®•æœº</p>
</blockquote>
<p>å¦‚æœæ˜¯Cacheç›´æ¥æŒ‚äº†ï¼Œé‚£ä¹ˆå°±ç®—æ˜¯åŸºäºåˆ·æ–°çš„å¼‚æ­¥ç»­è´¹æ¨¡å¼ä¹Ÿæ— èƒ½ä¸ºåŠ›äº†ã€‚è¿™æ—¶Aç³»ç»Ÿé“å®šæ— æ³•å¯¹Cacheè¿›è¡Œå­˜å–æ“ä½œï¼Œåªèƒ½å°†æµé‡å®Œå…¨æ‰“åˆ°Bç³»ç»Ÿï¼ŒBç³»ç»Ÿé¢å¯¹æœåŠ¡è¿‡è½½åœ¨åŠ«éš¾é€ƒâ€¦â€¦</p>
<p>æœ¬èŠ‚è®¨è®ºçš„é¢„é˜²Cacheå®•æœºä»…é™äºåˆ†å¸ƒå¼Cacheï¼Œå› ä¸ºæœ¬åœ°Cacheä¸€èˆ¬å’ŒAç³»ç»Ÿåº”ç”¨å…±äº«å†…å­˜å’Œè¿›ç¨‹ï¼Œæœ¬åœ°CacheæŒ‚äº†Aç³»ç»Ÿä¹ŸæŒ‚äº†ï¼Œä¸ä¼šå‡ºç°æœ¬åœ°CacheæŒ‚äº†è€ŒAç³»ç»Ÿåº”ç”¨æ­£å¸¸çš„æƒ…å†µã€‚</p>
<p>é¦–å…ˆï¼ŒAç³»ç»Ÿè¯·æ±‚çº¿ç¨‹æ£€æŸ¥åˆ†å¸ƒå¼CacheçŠ¶æ€ï¼Œå¦‚æœæ— åº”ç­”åˆ™è¯´æ˜åˆ†å¸ƒå¼CacheæŒ‚äº†ï¼Œåˆ™è½¬å‘è¯·æ±‚Bç³»ç»Ÿï¼Œè¿™æ ·ä¸€æ¥å¤§æµé‡å°†å‹å®Bç³»ç»Ÿã€‚è¿™æ—¶å¯é€‰çš„æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>
<ul>
<li>Aç³»ç»Ÿçš„å½“å‰çº¿ç¨‹ä¸è¯·æ±‚Bç³»ç»Ÿï¼Œè€Œæ˜¯æ‰“ä¸ªæ—¥å¿—å¹¶è®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼ã€‚</li>
<li>Aç³»ç»Ÿçš„å½“å‰çº¿ç¨‹æŒ‰ç…§ä¸€å®šæ¦‚ç‡å†³å®šæ˜¯å¦è¯·æ±‚Bç³»ç»Ÿã€‚</li>
<li>Aç³»ç»Ÿçš„å½“å‰çº¿ç¨‹æ£€æŸ¥Bç³»ç»Ÿè¿è¡Œæƒ…å†µï¼Œå¦‚æœè‰¯å¥½åˆ™è¯·æ±‚Bç³»ç»Ÿã€‚</li>
</ul>
<p><strong>æ–¹æ¡ˆ1</strong> æœ€ç®€å•ï¼ŒAç³»ç»ŸçŸ¥é“å¦‚æœæ²¡æœ‰Cacheï¼ŒBç³»ç»Ÿå¯èƒ½æ‰›ä¸ä½è‡ªå·±çš„å…¨éƒ¨æµé‡ï¼Œç´¢æ€§ä¸è¯·æ±‚Bç³»ç»Ÿï¼Œç­‰å¾…Cacheæ¢å¤ã€‚ä½†è¿™æ—¶Bç³»ç»Ÿåˆ©ç”¨ç‡ä¸º0ï¼Œæ˜¾ç„¶ä¸æ˜¯æœ€ä¼˜æ–¹æ¡ˆï¼Œè€Œä¸”å½“è¯·æ±‚çš„Valueä¸å®¹æ˜“è®¾ç½®é»˜è®¤å€¼æ—¶ï¼Œè¿™ä¸ªæ–¹æ¡ˆå°±ä¸è¡Œäº†ã€‚</p>
<p><strong>æ–¹æ¡ˆ2</strong> å¯ä»¥è®©ä¸€éƒ¨åˆ†çº¿ç¨‹è¯·æ±‚Bç³»ç»Ÿï¼Œè¿™éƒ¨åˆ†è¯·æ±‚è‚¯å®šèƒ½è¢«Bç³»ç»Ÿholdä½ã€‚å¯ä»¥ä¿å®ˆçš„è®¾ç½®è¿™ä¸ªæ¦‚ç‡ u =ï¼ˆBç³»ç»Ÿçš„å¹³å‡æµé‡ï¼‰/ï¼ˆAç³»ç»Ÿçš„å³°å€¼æµé‡ï¼‰ã€‚</p>
<p><strong>æ–¹æ¡ˆ3</strong> æ˜¯ä¸€ç§æ›´ä¸ºæ™ºèƒ½çš„æ–¹æ¡ˆï¼Œå¦‚æœBç³»ç»Ÿè¿è¡Œè‰¯å¥½ï¼Œå½“å‰çº¿ç¨‹è¯·æ±‚ï¼›å¦‚æœBç³»ç»Ÿè¿‡è½½ï¼Œåˆ™ä¸è¯·æ±‚ï¼Œè¿™æ ·Aç³»ç»Ÿå°†è®©Bç³»ç»Ÿå¤„äºä¸€ç§å®•æœºä¸ä¸å®•æœºçš„ä¸´ç•ŒçŠ¶æ€ï¼Œæœ€å¤§é™åº¦æŒ–æ˜Bç³»ç»Ÿæ€§èƒ½ã€‚è¿™ç§æ–¹æ¡ˆè¦æ±‚Bç³»ç»Ÿæä¾›ä¸€ä¸ªæ€§èƒ½è¯„ä¼°æ¥å£è¿”å›Yeså’ŒNoï¼ŒYesè¡¨ç¤ºBç³»ç»Ÿè‰¯å¥½ï¼Œå¯ä»¥è¯·æ±‚ï¼›Noè¡¨ç¤ºBç³»ç»Ÿæƒ…å†µä¸å¦™ï¼Œä¸è¦è¯·æ±‚ã€‚è¿™ä¸ªæ¥å£å°†è¢«é¢‘ç¹è°ƒç”¨ï¼Œå¿…é¡»é«˜æ•ˆã€‚</p>
<p>æ–¹æ¡ˆ3çš„å…³é”®åœ¨äºå¦‚ä½•è¯„ä¼°ä¸€ä¸ªç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µã€‚ä¸€ä¸ªç³»ç»Ÿä¸­å½“å‰ä¸»æœºçš„æ€§èƒ½å‚æ•°æœ‰CPUè´Ÿè½½ã€å†…å­˜ä½¿ç”¨ç‡ã€Swapä½¿ç”¨ç‡ã€GCé¢‘ç‡å’ŒGCæ—¶é—´ã€å„ä¸ªæ¥å£å¹³å‡å“åº”æ—¶é—´ç­‰ï¼Œæ€§èƒ½è¯„ä¼°æ¥å£éœ€è¦æ ¹æ®è¿™äº›å‚æ•°è¿”å›Yesæˆ–è€…Noï¼Œæ˜¯ä¸æ˜¯æœºå™¨å­¦ä¹ é‡Œçš„äºŒåˆ†ç±»é—®é¢˜ï¼Ÿ??å…³äºè¿™ä¸ªé—®é¢˜å·²ç»å¯ä»¥å•ç‹¬å†™ç¯‡æ–‡ç« è®¨è®ºäº†ï¼Œåœ¨è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œä½ å¯ä»¥æƒ³ä¸€ä¸ªæ¯”è¾ƒç®€å•å‚»ç“œçš„ä¿å®ˆç­–ç•¥ï¼Œç¼ºç‚¹æ˜¯Aç³»ç»Ÿçš„è¯·æ±‚æ— æ³•å¾ˆå¥½çš„é€¼è¿‘Bç³»ç»Ÿçš„æ€§èƒ½æé™ã€‚</p>
<p>ç»¼åˆä»¥ä¸Šåˆ†æï¼Œæ–¹æ¡ˆ2æ¯”è¾ƒé è°±ã€‚å¦‚æœé€‰æ‹©æ–¹æ¡ˆ3ï¼Œå»ºè®®ç”±ä¸“é—¨å›¢é˜Ÿè´Ÿè´£ç ”ç©¶å¹¶æä¾›ç»Ÿä¸€çš„ç³»ç»Ÿæ€§èƒ½å®æ—¶è¯„ä¼°æ–¹æ¡ˆå’Œå·¥å…·ã€‚</p>
<blockquote>
<p>åº”å¯¹åˆ†å¸ƒå¼Cacheå®•æœºåçš„æ¢å¤</p>
</blockquote>
<p>ä¸è¦ä»¥ä¸ºæˆåŠŸholdä½åˆ†å¸ƒå¼Cacheå®•æœºå°±ä¸‡äº‹å¤§å‰äº†ï¼ŒçœŸæ­£çš„è€ƒéªŒæ˜¯åˆ†å¸ƒå¼Cacheä»å®•æœºè¿‡ç¨‹æ¢å¤ä¹‹åï¼Œè¿™æ—¶åˆ†å¸ƒå¼Cacheä¸­ä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚</p>
<p>å³ä½¿æ˜¯ä¸Šæ–‡ä¸­æåˆ°äº†åŸºäºåˆ·æ–°çš„å¼‚æ­¥ç»­è´¹ç­–ç•¥è¿™æ—¶ä¹Ÿæ²¡ç”¨ï¼Œå› ä¸ºåˆ†å¸ƒå¼Cacheä¸ºç©ºï¼Œæ— è®ºå¦‚ä½•éƒ½è¦è¯·æ±‚Bç³»ç»Ÿã€‚è¿™æ—¶Bç³»ç»Ÿçš„æœ€å¤§æµé‡æ˜¯Keyçš„ç©ºé—´å–å€¼æ•°é‡ã€‚</p>
<p>å¦‚æœKeyçš„å–å€¼ç©ºé—´æ•°é‡å¾ˆå°‘ï¼Œåˆ™ç›¸å®‰æ— äº‹ï¼›å¦‚æœKeyçš„å–å€¼ç©ºé—´æ•°é‡å¤§äºBç³»ç»Ÿçš„æµé‡ä¸Šé™ï¼ŒæœåŠ¡è¿‡è½½ä¾ç„¶åœ¨æ‰€éš¾å…ã€‚</p>
<p>è¿™ç§æƒ…å†µAç³»ç»Ÿå¾ˆéš¾å¤„ç†ï¼Œå…³é”®åŸå› æ˜¯Aç³»ç»Ÿè¯·æ±‚Cacheè¿”å›Keyå¯¹åº”Valueä¸ºç©ºï¼ŒAç³»ç»Ÿæ— æ³•çŸ¥é“æ˜¯å› ä¸ºå½“å‰Cacheæ˜¯åˆšåˆšåˆå§‹åŒ–ï¼Œæ‰€æœ‰å†…å®¹éƒ½ä¸ºç©ºï¼›è¿˜æ˜¯å› ä¸ºä»…ä»…æ˜¯è‡ªå·±è¯·æ±‚çš„é‚£ä¸ªKeyæ²¡åœ¨Cacheé‡Œã€‚</p>
<p>å¦‚æœæ˜¯å‰è€…ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±è¦åƒå¤„ç†Cacheå®•æœºé‚£æ ·è¿›è¡ŒæŸç§ç­–ç•¥çš„å›é¿ï¼›å¦‚æœæ˜¯åè€…ï¼Œç›´æ¥è¯·æ±‚Bç³»ç»Ÿå³å¯ï¼Œå› ä¸ºè¿™æ˜¯æ­£å¸¸çš„Cacheä½¿ç”¨æµç¨‹ã€‚</p>
<p>å¯¹äºCacheå®•æœºçš„æ¢å¤ï¼ŒAç³»ç»ŸçœŸçš„æ— èƒ½ä¸ºåŠ›ï¼Œåªèƒ½å¯„å¸Œæœ›äºBç³»ç»Ÿçš„æ–¹æ¡ˆäº†ã€‚</p>
<h3 id="Serverç«¯çš„æ–¹æ¡ˆ"><a href="#Serverç«¯çš„æ–¹æ¡ˆ" class="headerlink" title="Serverç«¯çš„æ–¹æ¡ˆ"></a>Serverç«¯çš„æ–¹æ¡ˆ</h3><p>ç›¸å¯¹äºClientç«¯éœ€è¦åº”å¯¹å„ç§å¤æ‚é—®é¢˜ï¼ŒServerç«¯éœ€è¦åº”å¯¹çš„é—®é¢˜éå¸¸ç®€å•ï¼Œå°±æ˜¯å¦‚ä½•ä»å®¹åº”å¯¹è¿‡è½½çš„é—®é¢˜ã€‚æ— è®ºæ˜¯ç¼“å­˜å‡»ç©¿ä¹Ÿå¥½ï¼Œè¿˜æ˜¯æ‹’ç»æœåŠ¡æ”»å‡»ä¹Ÿç½¢ï¼Œå¯¹äºServerç«¯æ¥è¯´éƒ½æ˜¯è¿‡è½½ä¿æŠ¤çš„é—®é¢˜ã€‚å¯¹äºè¿‡è½½ä¿æŠ¤ï¼Œä¸»è¦ç»™å‡ºä¸¤ç§å¯è¡Œæ–¹æ¡ˆï¼Œä»¥åŠä¸€ç§æ¯”è¾ƒå¤æ‚çš„æ–¹æ¡ˆæ€è·¯ã€‚</p>
<blockquote>
<p>æµé‡æ§åˆ¶</p>
</blockquote>
<p>æµé‡æ§åˆ¶å°±æ˜¯Bç³»ç»Ÿå®æ—¶ç›‘æ§å½“å‰æµé‡ï¼Œå¦‚æœè¶…è¿‡é¢„è®¾çš„å€¼æˆ–è€…ç³»ç»Ÿæ‰¿å—èƒ½åŠ›ï¼Œåˆ™ç›´æ¥æ‹’ç»æ‰ä¸€éƒ¨åˆ†è¯·æ±‚ï¼Œä»¥å®ç°å¯¹ç³»ç»Ÿçš„ä¿æŠ¤ã€‚</p>
<p>æµé‡æ§åˆ¶æ ¹æ®åŸºäºçš„æ•°æ®ä¸åŒï¼Œå¯åˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>åŸºäºæµé‡é˜ˆå€¼çš„æµæ§ï¼šæµé‡é˜ˆå€¼æ˜¯æ¯ä¸ªä¸»æœºçš„æµé‡ä¸Šé™ï¼Œæµé‡è¶…è¿‡è¯¥é˜ˆå€¼ä¸»æœºå°†è¿›å…¥ä¸ç¨³å®šçŠ¶æ€ã€‚é˜ˆå€¼æå‰è¿›è¡Œè®¾å®šï¼Œå¦‚æœä¸»æœºå½“å‰æµé‡è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™æ‹’ç»æ‰ä¸€éƒ¨åˆ†æµé‡ï¼Œä½¿å¾—å®é™…è¢«å¤„ç†æµé‡å§‹ç»ˆä½äºé˜ˆå€¼ã€‚</li>
<li>åŸºäºä¸»æœºçŠ¶æ€çš„æµæ§ï¼šæ¯ä¸ªæ¥å—æ¯ä¸ªè¯·æ±‚ä¹‹å‰å…ˆåˆ¤æ–­å½“å‰ä¸»æœºçŠ¶æ€ï¼Œå¦‚æœä¸»æœºçŠ¶å†µä¸ä½³ï¼Œåˆ™æ‹’ç»å½“å‰è¯·æ±‚ã€‚</li>
</ul>
<p>åŸºäºé˜ˆå€¼çš„æµæ§å®ç°ç®€å•ï¼Œä½†æ˜¯æœ€å¤§çš„é—®é¢˜æ˜¯éœ€è¦æå‰è®¾ç½®é˜ˆå€¼ï¼Œè€Œä¸”éšç€ä¸šåŠ¡é€»è¾‘è¶Šæ¥è¶Šå¤æ‚ï¼Œæ¥å£è¶Šæ¥è¶Šå¤šï¼Œä¸»æœºçš„æœåŠ¡èƒ½åŠ›å®é™…åº”è¯¥æ˜¯ä¸‹é™çš„ï¼Œè¿™æ ·å°±éœ€è¦ä¸æ–­ä¸‹è°ƒé˜ˆå€¼ï¼Œå¢åŠ äº†ç»´æŠ¤æˆæœ¬ï¼Œè€Œä¸”ä¸‡ä¸€å¿˜è®°è°ƒæ•´çš„è¯ï¼Œå‘µå‘µâ€¦â€¦</p>
<p>ä¸»æœºçš„é˜ˆå€¼å¯ä»¥é€šè¿‡å‹åŠ›æµ‹è¯•ç¡®å®šï¼Œé€‰æ‹©çš„æ—¶å€™å¯ä»¥ä¿å®ˆäº›ã€‚</p>
<p>åŸºäºä¸»æœºçŠ¶æ€çš„æµæ§å…å»äº†äººä¸ºæ§åˆ¶ï¼Œä½†æ˜¯å…¶æœ€å¤§çš„ç¡®å®šä¸Šæ–‡å·²ç»æåˆ°ï¼šå¦‚ä½•æ ¹æ®å½“å‰ä¸»æœºå„ä¸ªå‚æ•°åˆ¤æ–­ä¸»æœºçŠ¶æ€å‘¢ï¼Ÿæƒ³è¦å®Œç¾çš„å›ç­”è¿™ä¸ªé—®é¢˜ç›®æµ‹å¹¶ä¸å®¹æ˜“ï¼Œå› æ­¤åœ¨æ²¡æœ‰å¤ªå¥½ç­”æ¡ˆä¹‹å‰ï¼Œæˆ‘æ¨èåŸºäºé˜ˆå€¼çš„æµæ§ã€‚</p>
<p>æµé‡æ§åˆ¶åŸºäºå®ç°ä½ç½®çš„ä¸åŒï¼Œåˆå¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>åå‘ä»£ç†å®ç°æµæ§ï¼šåœ¨åå‘ä»£ç†å¦‚Nginxä¸ŠåŸºäºå„ç§ç­–ç•¥è¿›è¡Œæµé‡æ§åˆ¶ã€‚è¿™ç§ä¸€èˆ¬é’ˆå¯¹HTTPæœåŠ¡ã€‚</li>
<li>å€ŸåŠ©æœåŠ¡æ²»ç†ç³»ç»Ÿï¼šå¦‚æœServerç«¯æ˜¯RMIã€RPCç­‰æœåŠ¡ï¼Œå¯ä»¥æ„å»ºä¸“é—¨çš„æœåŠ¡æ²»ç†ç³»ç»Ÿè¿›è¡Œè´Ÿè½½å‡è¡¡ã€æµæ§ç­‰æœåŠ¡ã€‚</li>
<li>æœåŠ¡å®¹å™¨å®ç°æµæ§ï¼šåœ¨åº”ç”¨ä»£ç é‡Œï¼Œä¸šåŠ¡é€»è¾‘ä¹‹å‰å®ç°æµé‡æ§åˆ¶ã€‚</li>
</ul>
<p>ç¬¬3ç§åœ¨æœåŠ¡å™¨çš„å®¹å™¨ï¼ˆå¦‚Javaå®¹å™¨ï¼‰ä¸­å®ç°æµæ§å¹¶ä¸æ¨èï¼Œå› ä¸ºæµæ§å’Œä¸šåŠ¡ä»£ç æ··åœ¨ä¸€èµ·å®¹æ˜“æ··ä¹±ï¼›å…¶æ¬¡å®é™…ä¸Šæµé‡å·²ç»å…¨é‡è¿›å…¥åˆ°äº†ä¸šåŠ¡ä»£ç é‡Œï¼Œè¿™æ—¶çš„æµæ§åªæ˜¯é˜»æ­¢å…¶è¿›å…¥çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ‰€ä»¥æµæ§æ•ˆæœå°†æ‰“æŠ˜ï¼›è¿˜æœ‰ï¼Œå¦‚æœæµé‡ç­–ç•¥ç»å¸¸å˜åŠ¨ï¼Œç³»ç»Ÿå°†ä¸å¾—ä¸ä¸ºæ­¤ç»å¸¸æ›´æ”¹ã€‚</p>
<p>å› æ­¤ï¼Œæ¨èå‰ä¸¤ç§æ–¹å¼ã€‚</p>
<p>æœ€åæä¸€ä¸ªæ³¨æ„ç‚¹ï¼šå½“å› ä¸ºæµæ§è€Œæ‹’ç»è¯·æ±‚æ—¶ï¼ŒåŠ¡å¿…åœ¨è¿”å›çš„æ•°æ®ä¸­å¸¦ä¸Šç›¸å…³ä¿¡æ¯ï¼ˆæ¯”å¦‚â€œå½“å‰è¯·æ±‚å› ä¸ºè¶…å‡ºæµé‡è€Œè¢«ç¦æ­¢è®¿é—®â€ï¼‰ï¼Œå¦‚æœè¿”å›å€¼ä»€ä¹ˆéƒ½æ²¡æœ‰å°†æ˜¯ä¸€ä¸ªå¤§å‘ã€‚å› ä¸ºé€ æˆè°ƒç”¨æ–¹è¯·æ±‚æ²¡æœ‰è¢«å“åº”çš„åŸå› å¾ˆå¤šï¼Œå¯èƒ½æ˜¯è°ƒç”¨æ–¹Bugï¼Œä¹Ÿå¯èƒ½æ˜¯æœåŠ¡æ–¹Bugï¼Œè¿˜å¯èƒ½æ˜¯ç½‘ç»œä¸ç¨³å®šï¼Œè¿™æ ·ä¸€æ¥å¾ˆå¯èƒ½åœ¨æ’æŸ¥ä¸€æ•´å¤©åå‘ç°æ˜¯æµæ§æçš„é¬¼â€¦â€¦</p>
<blockquote>
<p>æœåŠ¡é™çº§</p>
</blockquote>
<p>æœåŠ¡é™çº§ä¸€èˆ¬ç”±äººä¸ºè§¦å‘ï¼Œå±äºæœåŠ¡è¿‡è½½é€ æˆå´©æºƒæ¢å¤æ—¶çš„ç­–ç•¥ï¼Œä½†ä¸ºäº†å’Œæµæ§å¯¹æ¯”ï¼Œå°†å…¶æ”¾åˆ°è¿™é‡Œã€‚</p>
<p>æµé‡æ§åˆ¶æœ¬è´¨ä¸Šæ˜¯å‡å°è®¿é—®é‡ï¼Œè€ŒæœåŠ¡å¤„ç†èƒ½åŠ›ä¸å˜ï¼›è€ŒæœåŠ¡é™çº§æœ¬è´¨ä¸Šæ˜¯é™ä½äº†éƒ¨åˆ†æœåŠ¡çš„å¤„ç†èƒ½åŠ›ï¼Œå¢å¼ºå¦ä¸€éƒ¨åˆ†æœåŠ¡å¤„ç†èƒ½åŠ›ï¼Œè€Œè®¿é—®é‡ä¸å˜ã€‚</p>
<p>æœåŠ¡é™çº§æ˜¯æŒ‡åœ¨æœåŠ¡è¿‡è½½æ—¶å…³é—­ä¸é‡è¦çš„æ¥å£ï¼ˆç›´æ¥æ‹’ç»å¤„ç†è¯·æ±‚ï¼‰ï¼Œè€Œä¿ç•™é‡è¦çš„æ¥å£ã€‚æ¯”å¦‚æœåŠ¡ç”±10ä¸ªæ¥å£ï¼ŒæœåŠ¡é™çº§æ—¶å…³é—­äº†å…¶ä¸­äº”ä¸ªï¼Œä¿ç•™äº”ä¸ªï¼Œè¿™æ—¶è¿™ä¸ªä¸»æœºçš„æœåŠ¡å¤„ç†èƒ½åŠ›å°†å¢å¼ºåˆ°äºŒå€å·¦å³ã€‚</p>
<p>ç„¶è€Œï¼ŒæœåŠ¡è¿‡è½½å‘ç”Ÿæ—¶åŠ¨è¾„å°±è¶…å‡ºç³»ç»Ÿå¤„ç†èƒ½åŠ›10å€ï¼Œè€ŒæœåŠ¡é™çº§èƒ½ä½¿ä¸»æœºæœåŠ¡å¤„ç†èƒ½åŠ›æé«˜10å€ä¹ˆï¼Ÿæ˜¾ç„¶å¾ˆå›°éš¾ï¼Œå› æ­¤æœåŠ¡è¿‡è½½çš„åº”å¯¹ä¸èƒ½åªä¾é æœåŠ¡é™çº§ç­–ç•¥ã€‚</p>
<blockquote>
<p>åŠ¨æ€æ‰©å±•</p>
</blockquote>
<p>åŠ¨æ€æ‰©å±•æŒ‡çš„æ˜¯åœ¨æµé‡è¶…è¿‡ç³»ç»ŸæœåŠ¡èƒ½åŠ›æ—¶ï¼Œè‡ªåŠ¨è§¦å‘é›†ç¾¤æ‰©å®¹ï¼Œè‡ªåŠ¨éƒ¨ç½²å¹¶ä¸Šçº¿è¿è¡Œï¼›å½“æµé‡è¿‡å»ååˆè‡ªåŠ¨å›æ”¶å¤šä½™æœºå™¨ï¼Œå®Œå…¨å¼¹æ€§ã€‚</p>
<p>è¿™ä¸ªæ–¹æ¡ˆæ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆä¸é”™ã€‚ä½†æ˜¯ç›®å‰äº’è”ç½‘å…¬å¸çš„åœ¨çº¿åº”ç”¨è·‘åœ¨äº‘ä¸Šçš„æœ¬èº«å°±ä¸å¤šï¼Œè¦å®Œå…¨å®ç°åœ¨çº¿åº”ç”¨çš„è‡ªåŠ¨åŒ–å¼¹æ€§è¿ç»´ï¼Œè¦èµ°çš„è·¯å°±æ›´å¤šäº†ã€‚</p>
<h2 id="å´©æºƒæ¢å¤"><a href="#å´©æºƒæ¢å¤" class="headerlink" title="å´©æºƒæ¢å¤"></a>å´©æºƒæ¢å¤</h2><p>å¦‚æœæœåŠ¡è¿‡è½½é€ æˆç³»ç»Ÿå´©æºƒè¿˜æ˜¯ä¸å¹¸å‘ç”Ÿäº†ï¼Œè¿™æ—¶éœ€è¦è¿ç»´æ§åˆ¶æµé‡ï¼Œç­‰åå°ç³»ç»Ÿå¯åŠ¨å®Œæ¯•åå¾ªåºæ¸è¿›çš„æ”¾å¼€æµé‡ï¼Œä¸»è¦ç›®çš„æ˜¯è®©Cacheæ…¢æ…¢é¢„çƒ­ã€‚æµé‡æ§åˆ¶åˆšå¼€å§‹å¯ä»¥ä¸º10%ï¼Œç„¶å20%ï¼Œç„¶å50%ï¼Œç„¶å80%ï¼Œæœ€åå…¨é‡ï¼Œå½“ç„¶å…·ä½“çš„æ¯”ä¾‹ï¼Œå°¤å…¶æ˜¯åˆå§‹æ¯”ä¾‹ï¼Œè¿˜è¦çœ‹åç«¯æ‰¿å—èƒ½åŠ›å’Œå‰ç«¯æµé‡çš„æ¯”ä¾‹ï¼Œå„ä¸ªç³»ç»Ÿå¹¶ä¸ç›¸åŒã€‚</p>
<p>å¦‚æœåç«¯ç³»ç»Ÿæœ‰ä¸“é—¨çš„å·¥å…·è¿›è¡ŒCacheé¢„çƒ­ï¼Œåˆ™çœå»äº†è¿ç»´çš„å·¥ä½œï¼Œç­‰Cacheçƒ­èµ·æ¥å†å‘å¸ƒåå°ç³»ç»Ÿå³å¯ã€‚ä½†æ˜¯å¦‚æœCacheä¸­çš„Keyç©ºé—´å¾ˆå¤§ï¼Œå¼€å‘é¢„çƒ­å·¥å…·å°†æ¯”è¾ƒå›°éš¾ã€‚</p>
<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>â€œé˜²æ‚£äºæœªç„¶â€æ”¾åœ¨æœåŠ¡è¿‡è½½çš„åº”å¯¹ä¸Šä¹Ÿæ˜¯é€‚åˆçš„ï¼Œé¢„é˜²ä¸ºä¸»ï¼Œè¡¥æ•‘ä¸ºè¾…ã€‚ç»¼åˆä¸Šæ–‡åˆ†æï¼Œå…·ä½“çš„é¢„é˜²è¦ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>è°ƒç”¨æ–¹ï¼ˆAç³»ç»Ÿï¼‰é‡‡ç”¨åŸºäºåˆ·æ–°çš„å¼‚æ­¥ç»­è´¹æ¨¡å¼ä½¿ç”¨Cacheï¼Œæˆ–è€…è‡³å°‘ä¸èƒ½ä½¿ç”¨åŸºäºè¶…æ—¶æˆ–åˆ·æ–°çš„ç®€å•ï¼ˆstupidï¼‰æ¨¡å¼ã€‚</li>
<li>è°ƒç”¨æ–¹ï¼ˆAç³»ç»Ÿï¼‰æ¯æ¬¡è¯·æ±‚Cacheæ—¶æ£€æŸ¥Cacheæ˜¯å¦å¯ç”¨ï¼ˆavailableï¼‰ï¼Œå¦‚æœä¸å¯ç”¨åˆ™æŒ‰ç…§ä¸€ä¸ªä¿å®ˆçš„æ¦‚ç‡è®¿é—®åç«¯ï¼Œè€Œä¸æ˜¯æ— æ‰€é¡¾å¿Œçš„ç›´æ¥è®¿é—®åç«¯ã€‚</li>
<li>æœåŠ¡æ–¹ï¼ˆBç³»ç»Ÿï¼‰åœ¨åå‘ä»£ç†å¤„è®¾ç½®æµé‡æ§åˆ¶è¿›è¡Œè¿‡è½½ä¿æŠ¤ï¼Œé˜ˆå€¼éœ€è¦é€šè¿‡å‹æµ‹è·å¾—ã€‚</li>
</ul>
<p>å´©æºƒçš„è¡¥æ•‘ä¸»è¦è¿˜æ˜¯é è¿ç»´å’Œç ”å‘åœ¨å‘ç”Ÿæ—¶çš„é€šåŠ›åˆä½œï¼šè§‚å¯Ÿæµé‡å˜åŒ–å‡†ç¡®å®šä½å´©æºƒåŸå› ï¼Œè¿ç»´æ§æµé‡ç ”å‘æŒç»­å…³æ³¨æ€§èƒ½å˜åŒ–ã€‚</p>
<p>æœªæ¥å¦‚æœæœ‰æ¡ä»¶çš„è¯å¯ä»¥ç ”ç©¶ä¸‹ä¸»æœºåº”ç”¨å¥åº·åˆ¤æ–­é—®é¢˜å’ŒåŠ¨æ€å¼¹æ€§è¿ç»´é—®é¢˜ï¼Œæ¯•ç«Ÿè‡ªåŠ¨åŒ–æ¯”äººä¸ºæ“ä½œè¦é è°±ã€‚</p>
<hr>
<p>æ¥æºï¼šç¾å›¢ç‚¹è¯„æŠ€æœ¯å›¢é˜Ÿ-å¼ æ¨<br>é“¾æ¥ï¼š<a href="http://tech.meituan.com/avalanche-study.html" target="_blank" rel="external">http://tech.meituan.com/avalanche-study.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[é€šè¿‡iptableså®ç°ç«¯å£è½¬å‘ä¸å†…ç½‘å…±äº«ä¸Šç½‘]]></title>
      <url>http://team.jiunile.com/blog/2016/06/iptables-forward-internet-share.html</url>
      <content type="html"><![CDATA[<p>iptablesæ˜¯ä¸€ä¸ªLinuxä¸‹ä¼˜ç§€çš„nat+é˜²ç«å¢™å·¥å…·ï¼Œæˆ‘ä½¿ç”¨è¯¥å·¥å…·ä»¥è¾ƒä½é…ç½®çš„ä¼ ç»Ÿpcé…ç½®äº†ä¸€ä¸ªçµæ´»å¼ºåŠ²çš„é˜²ç«å¢™+natç³»ç»Ÿ,å°æœ‰å¿ƒå¾—ï¼Œçœ‹äº†ç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šè¿™æ–¹é¢çš„æ–‡ç« ï¼Œä½†æ˜¯ä¼¼ä¹è¦ä¹ˆè¯´çš„æ¯”è¾ƒå°‘ï¼Œè¦ä¹ˆå°±æ˜¯æ¯”è¾ƒåï¼Œå†…å®¹ä¸å…¨ï¼Œå®¹æ˜“è¯¯å¯¼ï¼Œæˆ‘ç ”ç©¶äº†ä¸€æ®µæ—¶é—´çš„iptablesåŒæ—¶ä¹Ÿç”¨äº†å¾ˆä¹…ï¼Œæœ‰ç‚¹æ»´ç»éªŒï¼Œå†™æ¥ä¾›å¤§å®¶å‚è€ƒï¼ŒåŒæ—¶ä¹Ÿå¤‡æ—¥åè‡ªå·±ç¿»é˜…ã€‚</p>
<p>é¦–å…ˆè¦è¯´æ˜çš„æ˜¯ï¼Œiptablesæ“ä½œçš„æ˜¯2.4ä»¥ä¸Šå†…æ ¸çš„netfilterã€‚æ‰€ä»¥éœ€è¦linuxçš„å†…æ ¸åœ¨2.4ä»¥ä¸Šã€‚å…¶åŠŸèƒ½ä¸å®‰å…¨æ€§è¿œè¿œæ¯”å…¶å‰è¾ˆipfwadm,ipchainså¼ºå¤§ï¼Œiptableså¤§è‡´æ˜¯å·¥ä½œåœ¨OSIä¸ƒå±‚çš„äºŒã€ä¸‰ã€å››å±‚ï¼Œå…¶å‰è¾ˆipchainsä¸èƒ½å•ç‹¬å®ç°å¯¹tcp/udp portä»¥åŠå¯¹macåœ°å€çš„çš„å®šä¹‰ä¸æ“ä½œï¼Œæ‰€ä»¥æˆ‘æƒ³ipchainsåº”è¯¥æ˜¯ä»…ä»…å·¥ä½œåœ¨ä¸‰å±‚ä¸Šçš„ã€‚</p>
<h2 id="netfilterå·¥ä½œæµç¨‹"><a href="#netfilterå·¥ä½œæµç¨‹" class="headerlink" title="netfilterå·¥ä½œæµç¨‹"></a>netfilterå·¥ä½œæµç¨‹</h2><p>æˆ‘ä»¬å…ˆç®€å•ä»‹ç»ä¸€ä¸‹netfilterçš„å¤§è‡´å·¥ä½œæµç¨‹ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ•°æ®åŒ…ï¼ˆæˆ–è€…å«åˆ†ç»„ã€packet,æˆ‘ä¸ªäººä¹ æƒ¯å«åŒ…ï¼‰åœ¨åˆ°è¾¾linuxçš„ç½‘ç»œæ¥å£çš„æ—¶å€™ ï¼ˆç½‘å¡ï¼‰å¦‚ä½•å¤„ç†è¿™ä¸ªåŒ…ï¼Œç„¶åå†ä»‹ç»ä¸€ä¸‹å¦‚ä½•ç”¨iptablesæ”¹å˜æˆ–è€…è¯´æ§åˆ¶å¯¹è¿™ä¸ªæ•°æ®åŒ…è¿›è¡Œæ“ä½œã€‚</p>
<ul>
<li>netfilterå†…éƒ¨åˆ†ä¸ºä¸‰ä¸ªè¡¨ï¼Œåˆ†åˆ«æ˜¯ filter,nat,mangleï¼Œæ¯ä¸ªè¡¨åˆæœ‰ä¸åŒçš„æ“ä½œé“¾ï¼ˆChainsï¼‰ã€‚</li>
<li>åœ¨filterï¼ˆè¿‡æ»¤ï¼‰è¡¨ä¸­ï¼Œä¹Ÿå°±æ˜¯ä»–çš„ é˜²ç«å¢™åŠŸèƒ½ çš„è¿™ä¸ªè¡¨ï¼Œå®šä¹‰äº†ä¸‰ä¸ª Chainã€‚åˆ†åˆ«æ˜¯INPUT,FORWARD,OUTPUTã€‚ä¹Ÿå°±æ˜¯å¯¹åŒ…çš„å…¥ã€è½¬å‘ã€å‡ºè¿›è¡Œå®šä¹‰çš„ä¸‰ä¸ªè¿‡æ»¤é“¾ã€‚å¯¹äºè¿™ä¸ªfilterè¡¨çš„æ“ä½œå’Œæ§åˆ¶ä¹Ÿæ˜¯æˆ‘ä»¬å®ç°é˜²ç«å¢™åŠŸèƒ½çš„ä¸€ä¸ªé‡è¦æ‰‹æ®µ</li>
<li>åœ¨nat(Network Address Translationã€ç½‘ç»œåœ°å€ç¿»è¯‘)è¡¨ä¸­ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç”¨ä»¥å®ç°åœ°å€è½¬æ¢å’Œç«¯å£è½¬å‘åŠŸèƒ½çš„è¿™ä¸ªè¡¨ï¼Œå®šä¹‰äº†PREROUTING, POSTROUTING,OUTPUTä¸‰ä¸ªé“¾,ä¸‹é¢æˆ‘ä»¬ä¼šå¯¹è¿™ä¸‰ä¸ªé“¾ä½œè¯¦ç»†çš„è¯´æ˜</li>
<li>è€Œnetfilterçš„mangleè¡¨åˆ™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰è¡¨ï¼Œé‡Œé¢åŒ…æ‹¬ä¸Šé¢ çš„filterä»¥åŠnatè¡¨ä¸­çš„å„ç§chainsï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬è¿›è¡Œä¸€äº›è‡ªå®šä¹‰çš„æ“ä½œï¼ŒåŒæ—¶è¿™ä¸ªmangleè¡¨ä¸­çš„chainsåœ¨netfilterå¯¹åŒ… çš„å¤„ç†æµç¨‹ä¸­å¤„åœ¨ä¸€ä¸ªæ¯”è¾ƒä¼˜å…ˆçš„ä½ç½®ã€‚<a id="more"></a>
ä¸‹é¢æœ‰ä¸€å¼ å›¾æ¸…æ™°çš„æç»˜äº†netfilterå¯¹åŒ…çš„å¤„ç†æµç¨‹ï¼ˆè¯¥å›¾æ‘˜è‡ªç½‘ä¸Šï¼Œä¸çŸ¥ä½œè€…æ˜¯è°ï¼Œåœ¨æ­¤æ·±è¡¨æ•¬æ„ï¼ï¼‰ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨ä¸åˆ°è¿™ä¸ªmangleè¡¨ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°±ä¸åšä»‹ç»äº†ã€‚<br><img src="/images/iptables_netfilter_chains.png" alt="iptablesåŒ…å¤„ç†æµç¨‹"></li>
<li>ebtablesåŸºæœ¬ä½¿ç”¨: <a href="http://www.cnblogs.com/peteryj/archive/2011/07/24/2115602.html" target="_blank" rel="external">http://www.cnblogs.com/peteryj/archive/2011/07/24/2115602.html</a><br><img src="/images/iptables_entables.png" alt="iptables_entableså¤„ç†æµç¨‹å›¾"></li>
</ul>
<h3 id="PREROUTING-DNAT"><a href="#PREROUTING-DNAT" class="headerlink" title="PREROUTING(DNAT)"></a>PREROUTING(DNAT)</h3><p>PREROUTINGè¿™ä¸ªchainåœ¨æœ€å‰é¢ï¼Œå½“ä¸€ä¸ªåŒ…æ¥åˆ°linuxçš„ç½‘ç»œæ¥å£çš„æ—¶å€™å…ˆè¿‡mangleçš„PREROUTINGï¼›ç„¶åæ˜¯natçš„PREROUTING,ä»è¿™ä¸ªchainçš„åå­—æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªchainæ˜¯åœ¨è·¯ç”±ä¹‹å‰(pre-routing)è¦è¿‡çš„ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦åœ¨è·¯ç”±ä¹‹å‰è¿‡å‘¢ï¼Ÿå¤§å®¶å¯ä»¥çœ‹åˆ°è¿™ä¸ªå›¾ä¸Šï¼Œä¸Šé¢æœ‰ä¸€ä¸ªè±å½¢çš„éƒ¨åˆ†å«ROUTING,è¿™ä¸ªROUTINGéƒ¨åˆ†å°±æ˜¯Linuxçš„route box,ä¹Ÿå°±æ˜¯è·¯ç”±ç³»ç»Ÿï¼Œå®ƒåŒæ ·æœ‰å¾ˆé«˜æ·±çš„åŠŸèƒ½ï¼Œå¯ä»¥å®ç°ç­–ç•¥è·¯ç”±ç­‰ç­‰ä¸€äº›é«˜çº§ç‰¹æ€§ï¼Œæ­¤å¤„æˆ‘ä»¬ä¸åšè¯¦ç»†è§£é‡Šã€‚å•è¯´è¿™ä¸ªPREROUTINGé“¾ï¼Œå› ä¸ºåœ¨è¿™ä¸ªé“¾é‡Œé¢æˆ‘ä»¬å¯¹åŒ…çš„æ“ä½œæ˜¯DNAT,ä¹Ÿå°±æ˜¯æ”¹å˜ç›®çš„åœ°å€å’Œï¼ˆæˆ–ç«¯å£ï¼‰ï¼Œé€šå¸¸ç”¨åœ¨ç«¯å£è½¬å‘ï¼Œæˆ–è€…natåˆ°å†…ç½‘çš„DMZåŒºï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä¸€ä¸ªåŒ…è¿‡æ¥çš„æ—¶å€™æˆ‘ä»¬è¦æ”¹å˜å®ƒçš„ç›®çš„åœ°å€ï¼Œå¤§å®¶å¯ä»¥æƒ³æƒ³,å¦‚æœä¸€ä¸ªåŒ…åœ¨æ”¹å˜ç›®çš„åœ°å€ä¹‹å‰å°±è¢«æ‰”è¿›äº†route box,è®©ç³»ç»Ÿé€‰å¥½è·¯ä¹‹åå†æ”¹å˜ç›®çš„åœ°å€ï¼Œé‚£ä¹ˆé€‰è·¯å°±å¯èƒ½æ˜¯é”™çš„ï¼Œæˆ–è€…è¯´æ¯«æ— æ„ä¹‰äº†ï¼Œæ‰€ä»¥ï¼ŒPREROUTINGè¿™ä¸ªChainä¸€å®šè¦åœ¨è¿›Routing ä¹‹å‰åšã€‚</p>
<p>æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬çš„å…¬ç½‘ipæ˜¯60.1.1.1/24ï¼Œä½äºlinuxä¸­çš„eth0å†…ç½‘ipæ˜¯10.1.1.1/24ï¼Œä½äºlinuxä¸­çš„eth1, æˆ‘ä»¬çš„å†…ç½‘æœ‰ä¸€å°webæœåŠ¡å™¨ï¼Œåœ°å€æ˜¯10.1.1.2/24,æˆ‘ä»¬æ€ä¹ˆæ ·èƒ½è®©internetç”¨æˆ·é€šè¿‡è¿™ä¸ªå…¬ç½‘ipè®¿é—®æˆ‘ä»¬å†…éƒ¨çš„è¿™ä¸ªwebæœåŠ¡å™¨å‘¢ï¼Ÿ æˆ‘ä»¬å°±å¯ä»¥åœ¨è¿™ä¸ªPREROUTINGé“¾ä¸Šé¢å®šä¹‰ä¸€ä¸ªè§„åˆ™ï¼ŒæŠŠè®¿é—®60.1.1.1:80çš„ç”¨æˆ·çš„ç›®çš„åœ°å€æ”¹å˜ä¸€ä¸‹ï¼Œæ”¹å˜ä¸º10.1.1.2:80,è¿™æ · å°±å®ç°äº†internetç”¨æˆ·å¯¹å†…ç½‘æœåŠ¡å™¨çš„è®¿é—®äº†ï¼Œå½“ç„¶äº†ï¼Œè¿™ä¸ªç«¯å£æ˜¯æ¯”è¾ƒçµæ´»çš„ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä»»ä½•ä¸€ä¸ªç«¯å£çš„è½¬å‘ï¼Œä¸ä¸€å®šæ˜¯80â€“&gt;80ï¼Œå…·ä½“çš„å‘½ä»¤æˆ‘ä»¬åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ä»‹ç»ï¼Œè¿™é‡Œæˆ‘ä»¬åªè°ˆæµç¨‹ä¸æ¦‚å¿µä¸Šçš„å®ç°æ–¹æ³•ã€‚</p>
<h3 id="FORWARD"><a href="#FORWARD" class="headerlink" title="FORWARD"></a>FORWARD</h3><p>å¥½äº†ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹èµ°ï¼Œè¿™ä¸ªåŒ…å·²ç»è¿‡äº†ä¸¤ä¸ªPREROUTINGé“¾äº†ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå‡ºç°äº†ä¸€ä¸ªåˆ†æ”¯è½¬æŠ˜çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­ä¸‹æ–¹çš„é‚£ä¸ªè±å½¢ï¼ˆFORWARDï¼‰,è½¬å‘ï¼è¿™é‡Œæœ‰ä¸€ä¸ªå¯¹ç›®çš„åœ°å€çš„åˆ¤æ–­ï¼ˆè¿™é‡ŒåŒæ ·è¯´æ˜äº†PREROUTINGä¸€å®šè¦åœ¨æœ€å…ˆï¼Œä¸ä»…è¦åœ¨route boxä¹‹å‰ï¼Œç”šè‡³æ˜¯è¿™ä¸ªå¯¹ç›®çš„åœ°å€çš„åˆ¤æ–­ä¹‹å‰ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½åšä¸€ä¸ªå»æŸæŸæŸipçš„åœ°æ–¹è½¬åˆ°è‡ªå·±çš„ipçš„è§„åˆ™ï¼Œæ‰€ä»¥PREROUTINGæ˜¯æœ€å…ˆå¤„ç†è¿™ä¸ªåŒ…çš„Chainï¼‰ï¼</p>
<p>å¦‚æœåŒ…çš„ç›®çš„åœ°æ˜¯æœ¬æœºip,é‚£ä¹ˆåŒ…å‘ä¸Šèµ°ï¼Œèµ°å…¥INPUTé“¾å¤„ç†ï¼Œç„¶åè¿›å…¥LOCAL PROCESS,å¦‚æœéæœ¬åœ°ï¼Œé‚£ä¹ˆå°±è¿›å…¥FORWARDé“¾è¿›è¡Œè¿‡æ»¤ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå°±ä¸ä»‹ç»INPUT,OUTPUTçš„å¤„ç†äº†ï¼Œå› ä¸ºé‚£ä¸»è¦æ˜¯å¯¹äºæœ¬æœºå®‰å…¨çš„ä¸€ç§å¤„ç†ï¼Œæˆ‘ä»¬è¿™é‡Œä¸»è¦è¯´å¯¹è½¬å‘çš„è¿‡æ»¤å’Œnatçš„å®ç°ã€‚</p>
<p>è¿™é‡Œçš„FORWARDæˆ‘ç®€å•è¯´ä¸€ä¸‹ï¼Œå½“linuxæ”¶åˆ°äº†ä¸€ä¸ª ç›®çš„ipåœ°å€ä¸æ˜¯æœ¬åœ°çš„åŒ… ï¼ŒLinuxä¼šæŠŠè¿™ä¸ªåŒ…ä¸¢å¼ƒï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼ŒLinuxçš„ä¸‰å±‚åŒ…è½¬å‘åŠŸèƒ½æ˜¯å…³é—­çš„ï¼Œå¦‚æœè¦è®©æˆ‘ä»¬çš„linuxå®ç°è½¬å‘ï¼Œåˆ™éœ€è¦æ‰“å¼€è¿™ä¸ªè½¬å‘åŠŸèƒ½ï¼Œå¯ä»¥ æ”¹å˜å®ƒçš„ä¸€ä¸ªç³»ç»Ÿå‚æ•°ï¼Œä½¿ç”¨sysctl net.ipv4.ip_forward=1æˆ–è€…echo â€œ1â€ &gt; /proc/sys/net/ipv4/ip_forwardå‘½ä»¤æ‰“å¼€è½¬å‘åŠŸèƒ½ã€‚</p>
<p>å¥½äº†ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è®©linuxå…è®¸è½¬å‘ï¼Œè¿™ä¸ªåŒ…çš„ç›®çš„åœ°å€ä¹Ÿä¸æ˜¯æœ¬æœºï¼Œé‚£ä¹ˆå®ƒå°†æ¥ç€èµ°å…¥FORWARDé“¾ï¼Œåœ¨FORWARDé“¾é‡Œé¢ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰è¯¦ç»†çš„è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯æ˜¯å¦å…è®¸ä»–é€šè¿‡ï¼Œæˆ–è€…å¯¹è¿™ä¸ªåŒ…çš„æ–¹å‘æµç¨‹è¿›è¡Œä¸€äº›æ”¹å˜ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬å®ç°è®¿é—®æ§åˆ¶çš„åœ°æ–¹ï¼Œè¿™é‡ŒåŒæ ·ä¹Ÿæ˜¯Mangle_FORWARDç„¶åfilter_FORWARD,æˆ‘ä»¬æ“ä½œä»»ä½•ä¸€ä¸ªé“¾éƒ½ä¼šå½±å“åˆ°è¿™ä¸ªåŒ…çš„å‘½è¿ï¼Œåœ¨ä¸‹é¢çš„ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬å°±å¿½ç•¥æ‰mangleè¡¨ï¼Œæˆ‘ä»¬åŸºæœ¬ç”¨ä¸åˆ°æ“ä½œå®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬å‡è®¾å®ƒæ˜¯é€æ˜çš„ã€‚</p>
<h3 id="POSTROUTING-SNAT"><a href="#POSTROUTING-SNAT" class="headerlink" title="POSTROUTING(SNAT)"></a>POSTROUTING(SNAT)</h3><p>å‡è®¾è¿™ä¸ªåŒ…è¢«æˆ‘ä»¬çš„è§„åˆ™æ”¾è¿‡å»äº†ï¼Œä¹Ÿå°±æ˜¯ACCEPTäº†ï¼Œå®ƒå°†è¿›å…¥POSTROUTINGéƒ¨åˆ†ï¼Œ æ³¨æ„ï¼è¿™é‡Œæˆ‘æ³¨æ„åˆ°ä¸€ä¸ªç»†èŠ‚é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„å›¾ä¸­æ•°æ®åŒ…è¿‡äº†FORWARDé“¾ä¹‹åç›´æ¥è¿›å…¥äº†POSTROUITNGé“¾ï¼Œæˆ‘è§‰å¾—è¿™ä¸­é—´ç¼ºå°‘ä¸€ä¸ªç¯èŠ‚ï¼Œä¹Ÿå°±æ˜¯route box,å¯¹äºè½¬å‘çš„åŒ…æ¥è¯´ï¼ŒlinuxåŒæ ·éœ€è¦åœ¨é€‰è·¯ï¼ˆè·¯ç”±ï¼‰ä¹‹åæ‰èƒ½å°†å®ƒé€å‡ºï¼Œè¿™ä¸ªå›¾å´æ²¡æœ‰æ ‡æ˜è¿™ä¸€ç‚¹ï¼Œæˆ‘è®¤ä¸ºå®ƒæ˜¯åœ¨è¿‡äº†route boxä¹‹åæ‰è¿›å…¥çš„POSTROUITNGï¼Œå½“ç„¶äº†ï¼Œè¿™å¯¹äºæˆ‘ä»¬è®¨è®ºiptablesçš„è¿‡æ»¤è½¬å‘æ¥è¯´ä¸æ˜¯å¾ˆé‡è¦ï¼Œåªæ˜¯æˆ‘è§‰å¾—æµç¨‹ä¸Šæœ‰è¿™ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯è¦è¯´æ˜ ä¸€ä¸‹ã€‚</p>
<p>åŒæ ·çš„ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä»åå­—å°±å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªPOSTROUTINGé“¾åº”è¯¥æ˜¯è·¯ç”±ä¹‹åçš„ä¸€ä¸ªé“¾ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªåŒ…è¦é€å‡ºè¿™å°Linuxçš„ æœ€åä¸€ä¸ªç¯èŠ‚äº†ï¼Œè¿™ä¹Ÿæ˜¯æå…¶é‡è¦çš„ä¸€ä¸ªç¯èŠ‚ï¼ï¼è¿™ä¸ªæ—¶å€™linuxå·²ç»å®Œæˆ(has done.._)äº†å¯¹è¿™ä¸ªåŒ…çš„è·¯ç”±ï¼ˆé€‰è·¯å·¥ä½œï¼‰ï¼Œå·²ç»æ‰¾åˆ°äº†åˆé€‚çš„æ¥å£é€å‡ºè¿™ä¸ªåŒ…äº†ï¼Œåœ¨è¿™ä¸ªé“¾é‡Œé¢æˆ‘ä»¬è¦è¿›è¡Œé‡è¦çš„æ“ä½œï¼Œå°±æ˜¯è¢«Linuxç§°ä¸º SNAT çš„ä¸€ä¸ªåŠ¨ä½œï¼Œä¿®æ”¹æºipåœ°å€ï¼ä¸ºä»€ä¹ˆä¿®æ”¹æºipåœ°å€ï¼Ÿå¾ˆå¤šæƒ…å†µéœ€è¦ä¿®æ”¹æºåœ°å€é˜¿ï¼Œæœ€å¸¸è§çš„å°±æ˜¯æˆ‘ä»¬å†…ç½‘å¤šå°æœºå™¨éœ€è¦å…±äº«ä¸€ä¸ªæˆ–å‡ ä¸ªå…¬ç½‘ipè®¿é—®internet,å› ä¸ºæˆ‘ä»¬çš„å†…ç½‘åœ°å€æ˜¯ç§æœ‰çš„ï¼Œå‡å¦‚å°±è®©linuxç»™è·¯ç”±å‡ºå»ï¼Œæºåœ°å€ä¹Ÿä¸å˜ï¼Œè¿™ä¸ªåŒ…åº”è¯¥èƒ½è®¿é—®åˆ°ç›®çš„åœ°ï¼Œä½†æ˜¯å´å›ä¸æ¥ï¼Œå› ä¸º internetä¸Šçš„Nå¤šä¸ªè·¯ç”±èŠ‚ç‚¹ä¸ä¼šè½¬å‘ç§æœ‰åœ°å€çš„æ•°æ®åŒ…ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç”¨åˆæ³•ip,æˆ‘ä»¬çš„æ•°æ®åŒ…æœ‰å»æ— å›ã€‚æœ‰äººä¼šè¯´ï¼šâ€œæ—¢ç„¶æ˜¯è¿™æ ·ï¼Œæˆ‘å°±ä¸ç”¨ç§æœ‰ ipäº†ï¼Œæˆ‘è‡ªå·±åˆ†é…è‡ªå·±åˆæ³•çš„åœ°å€ä¸è¡Œå—ï¼Ÿé‚£æ ·åŒ…å°±ä¼šå›æ¥äº†å§ï¼Ÿâ€ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œipåœ°å€æ˜¯ICANNæ¥åˆ†é…çš„ï¼Œä½ çš„æ•°æ®åŒ…æˆ–è®¸èƒ½å‘åˆ°ç›®çš„åœ°ï¼Œä½†æ˜¯å›æ¥çš„ æ—¶å€™äººå®¶å¯ä¸ä¼šè½¬åˆ°ä½ é‚£é‡Œï¼Œinternetä¸Šçš„è·¯ç”±å™¨ä¸­çš„è·¯ç”±ä¿¡æ¯ä¼šæŠŠè¿™ä¸ªè¿”å›åŒ…é€åˆ°é‚£ä¸ªåˆæ³•çš„è·å¾—ipçš„åœ°æ–¹å»ï¼Œä½ åŒæ ·æ”¶ä¸åˆ°,è€Œä½ è¿™ç§è¡Œä¸ºæœ‰å¯èƒ½è¢«å®šä¹‰ä¸ºä¸€ç§ipæ¬ºéª—ï¼Œå¾ˆå¤šè®¾å¤‡ä¼šæŠŠè¿™æ ·çš„åŒ…åœ¨æ¥å…¥ç«¯å°±ç»™æ»¤æ‰äº†ï¼Œå¯èƒ½éƒ½åˆ°ä¸äº†ä½ è¦è®¿é—®çš„é‚£ä¸ªæœåŠ¡å™¨ï¼Œå‘µå‘µã€‚</p>
<p>é‚£ä¹ˆLinuxå¦‚ä½•åšSNATå‘¢ï¼Ÿæ¯”å¦‚ä¸€ä¸ªå†…ç½‘çš„10.1.1.11çš„pcè®¿é—®202.2.2.2çš„ä¸€ä¸ªwebæœåŠ¡å™¨ï¼Œlinuxçš„å†…ç½‘æ¥å£10.1.1.1åœ¨æ”¶åˆ°è¿™ä¸ªåŒ…ä¹‹åæŠŠåŸæ¥çš„ PCçš„ ip10.1.1.11æ”¹å˜ä¸º60.1.1.1çš„åˆæ³•åœ°å€ç„¶åé€å‡ºï¼ŒåŒæ—¶åœ¨è‡ªå·±çš„ip_conntrackè¡¨é‡Œé¢åšä¸€ä¸ªè®°å½•,è®°ä½æ˜¯å†…ç½‘çš„å“ªä¸€ä¸ªipçš„å“ª ä¸ªç«¯å£è®¿é—®çš„è¿™ä¸ªwebæœåŠ¡å™¨ï¼Œè‡ªå·±æŠŠå®ƒçš„æºåœ°å€æ”¹æˆå¤šå°‘äº†ï¼Œç«¯å£æ”¹æˆå¤šå°‘äº†ï¼Œä»¥ä¾¿è¿™ä¸ªwebæœåŠ¡å™¨è¿”å›æ•°æ®åŒ…çš„æ—¶å€™linuxå°†å®ƒå‡†ç¡®çš„é€å›ç»™å‘é€è¯·æ±‚ çš„è¿™ä¸ªpc.</p>
<p>å¤§ä½“çš„æ•°æ®è½¬å‘æµç¨‹æˆ‘ä»¬è¯´å®Œäº†,æˆ‘ä»¬çœ‹çœ‹iptablesä½¿ç”¨ä»€ä¹ˆæ ·çš„å‚æ•°æ¥å®Œæˆè¿™äº›æ“ä½œã€‚</p>
<h2 id="æ¦‚å¿µç†è§£"><a href="#æ¦‚å¿µç†è§£" class="headerlink" title="æ¦‚å¿µç†è§£"></a>æ¦‚å¿µç†è§£</h2><p>åœ¨æè¿°è¿™äº›å…·ä½“çš„æ“ä½œä¹‹å‰ï¼Œæˆ‘è¿˜è¦è¯´å‡ ä¸ªæˆ‘å¯¹iptablesçš„æ¦‚å¿µçš„ç†è§£ï¼ˆæœªå¿…å®Œå…¨æ­£ç¡®ï¼‰ï¼Œè¿™å°†æœ‰åŠ©äºå¤§å®¶ç†è§£è¿™äº›è§„åˆ™ï¼Œä»¥å®ç°æ›´ç²¾ç¡®çš„æ§åˆ¶ã€‚</p>
<p>ä¸Šæ–‡ä¸­æˆ‘ä»¬æåˆ°è¿‡ï¼Œå¯¹åŒ…çš„æ§åˆ¶æ˜¯ç”±æˆ‘ä»¬åœ¨ä¸åŒçš„Chain(é“¾)ä¸Šé¢æ·»åŠ ä¸åŒçš„è§„åˆ™æ¥å®ç°çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯¹è¿‡æ»¤è¡¨ï¼ˆfilter tableï¼‰æ·»åŠ è§„åˆ™æ¥æ‰§è¡Œå¯¹åŒ…çš„æ“æ§ã€‚é‚£ä¹ˆæ—¢ç„¶å«é“¾ï¼Œä¸€å®šå°±æ˜¯ä¸€æ¡æˆ–è€…å¤šæ¡è§„åˆ™ç»„æˆçš„äº†ï¼Œè¿™æ—¶å°±æœ‰ä¸€ä¸ªé—®é¢˜äº†ï¼Œå¦‚æœå¤šä¸ªè§„åˆ™å¯¹åŒä¸€ç§åŒ…è¿›è¡Œäº†å®šä¹‰ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿ åœ¨Chainä¸­ï¼Œæ‰€æœ‰çš„è§„åˆ™éƒ½æ˜¯ä»ä¸Šå‘ä¸‹æ¥æ‰§è¡Œçš„ ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœåŒ¹é…äº†ç¬¬ä¸€è¡Œï¼Œé‚£ä¹ˆå°±æŒ‰ç…§ç¬¬ä¸€è¡Œçš„è§„åˆ™æ‰§è¡Œï¼Œä¸€è¡Œä¸€è¡Œçš„å¾€ä¸‹æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ° ç¬¦åˆè¿™ä¸ªç±»å‹çš„åŒ…çš„è§„åˆ™ä¸ºæ­¢ã€‚å¦‚æœæ‰¾äº†ä¸€éæ²¡æœ‰æ‰¾åˆ°ç¬¦åˆè¿™ä¸ªåŒ…çš„è§„åˆ™æ€ä¹ˆåŠå‘¢ï¼Ÿitpablesé‡Œé¢æœ‰ä¸€ä¸ªæ¦‚å¿µï¼Œå°±æ˜¯ Policy ï¼Œä¹Ÿå°±æ˜¯ç­–ç•¥ã€‚ä¸€è¯´è¿™ä¸ªä¸œè¥¿å¤§å®¶å¯èƒ½å°±ä¼šè§‰å¾—æ¯”è¾ƒéº»çƒ¦ï¼Œä»€ä¹ˆç­–ç•¥é˜¿ï¼Œæˆ‘å¯¹äºå®ƒçš„ç†è§£å°±æ˜¯æ‰€è°“è¿™ä¸ªç­–ç•¥å°±æ˜¯chainä¸­çš„æœ€åä¸€æ¡è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæ‰¾äº†ä¸€éæ‰¾ä¸åˆ°ç¬¦åˆå¤„ç†è¿™ä¸ªåŒ…çš„è§„åˆ™ï¼Œå°±æŒ‰ç…§policyæ¥åŠã€‚è¿™æ ·ç†è§£èµ·æ¥å°±å®¹æ˜“å¤šäº†ã€‚iptables ä½¿ç”¨-Pæ¥è®¾ç½®Chainçš„ç­–ç•¥ã€‚</p>
<p>å¥½äº†ï¼Œæˆ‘ä»¬è¨€å½’æ­£ä¼ ï¼Œæ¥è¯´è¯´iptablesåˆ°åº•æ€æ ·å®ç°å¯¹åŒ…çš„æ§åˆ¶ã€‚</p>
<h4 id="é“¾æ“ä½œ"><a href="#é“¾æ“ä½œ" class="headerlink" title="é“¾æ“ä½œ"></a>é“¾æ“ä½œ</h4><p>å…ˆä»‹ç»ä¸€ä¸‹iptableså¦‚ä½•æ“ä½œé“¾</p>
<p>å¯¹é“¾çš„æ“ä½œå°±é‚£ä¹ˆå‡ ç§ï¼š</p>
<ul>
<li>-I(æ’å…¥)</li>
<li>-A(è¿½åŠ )</li>
<li>-R(æ›¿æ¢)</li>
<li>-Dï¼ˆåˆ é™¤ï¼‰</li>
<li>-Lï¼ˆåˆ—è¡¨æ˜¾ç¤ºï¼‰</li>
</ul>
<p>è¿™é‡Œè¦è¯´æ˜çš„å°±æ˜¯-Iå°†ä¼šæŠŠè§„åˆ™æ”¾åœ¨ç¬¬ä¸€è¡Œï¼Œ-Aå°†ä¼šæ”¾åœ¨æœ€åä¸€è¡Œã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬è¦æ·»åŠ ä¸€ä¸ªè§„åˆ™åˆ°filterè¡¨çš„FORWARDé“¾ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ„æ€ä¸ºï¼šè¿½åŠ ä¸€ä¸ªè§„åˆ™è‡³filterè¡¨ä¸­çš„FORWARDé“¾å°¾ï¼Œå…è®¸ï¼ˆ-j ACCEPTï¼‰æºåœ°å€ä¸º10.1.1.11ç›®çš„åœ°å€ä¸º202.1.1.1çš„æ•°æ®åŒ…é€šè¿‡ã€‚å…¶ä¸­-tåé¢è·Ÿçš„æ˜¯è¡¨åï¼Œåœ¨-Aåé¢è·ŸChainåï¼Œåé¢çš„å°å†™çš„ -sä¸ºæºåœ°å€ï¼Œ-dä¸ºç›®çš„åœ°å€ï¼Œ-jä¸ºå¤„ç†æ–¹å‘ã€‚</span></span><br><span class="line">iptables -t filter -A FORWARD <span class="_">-s</span> 10.1.1.11 <span class="_">-d</span> 202.1.1.1 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#åœ¨iptablesä¸­ï¼Œé»˜è®¤çš„è¡¨åå°±æ˜¯filterï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥çœç•¥-t filterç›´æ¥å†™æˆ: </span></span><br><span class="line">iptables -A FORWARD <span class="_">-s</span> 10.1.1.11 <span class="_">-d</span> 202.1.1.1 -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<h4 id="åŒ¹é…å‚æ•°"><a href="#åŒ¹é…å‚æ•°" class="headerlink" title="åŒ¹é…å‚æ•°"></a>åŒ¹é…å‚æ•°</h4><p>iptablesä¸­çš„åŒ¹é…å‚æ•°ï¼š æˆ‘ä»¬åœ¨è¿™é‡Œå°±ä»‹ç»å‡ ç§å¸¸ç”¨çš„å‚æ•°ï¼Œè¯¦ç»†åœ°ç”¨æ³•å¯ä»¥man iptablesçœ‹å®ƒçš„è”æœºæ–‡æ¡£ï¼Œä½ ä¼šæœ‰æ„å¤–çš„æ”¶è·ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">å‚æ•°</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">-s</td>
<td style="text-align:left">åŒ¹é…æºåœ°å€</td>
</tr>
<tr>
<td style="text-align:left">-d</td>
<td style="text-align:left">åŒ¹é…ç›®çš„åœ°å€</td>
</tr>
<tr>
<td style="text-align:left">-p</td>
<td style="text-align:left">åè®®åŒ¹é…</td>
</tr>
<tr>
<td style="text-align:left">-i</td>
<td style="text-align:left">å…¥æ¥å£åŒ¹é…</td>
</tr>
<tr>
<td style="text-align:left">-o</td>
<td style="text-align:left">å‡ºæ¥å£åŒ¹é…</td>
</tr>
<tr>
<td style="text-align:left">â€“sportï¼Œâ€“dport</td>
<td style="text-align:left">æºå’Œç›®çš„ç«¯å£åŒ¹é…</td>
</tr>
<tr>
<td style="text-align:left">-j</td>
<td style="text-align:left">è·³è½¬,ä¹Ÿå°±æ˜¯åŒ…çš„æ–¹å‘</td>
</tr>
<tr>
<td style="text-align:left">!</td>
<td style="text-align:left">å–å</td>
</tr>
</tbody>
</table>
<p>å…¶ä¸­è¿˜æœ‰ä¸€ä¸ª!å‚æ•°ï¼Œä½¿ç”¨!å°±æ˜¯å–åçš„æ„æ€ã€‚ä¸‹é¢æˆ‘ä»¬ç®€å•ä¸¾å‡ ä¸ªä¾‹å­ä»‹ç»ä¸€ä¸‹ã€‚</p>
<ul>
<li>-s è¿™ä¸ªå‚æ•°å‘¢å°±æ˜¯æŒ‡å®šæºåœ°å€çš„ï¼Œå¦‚æœä½¿ç”¨è¿™ä¸ªå‚æ•°ä¹Ÿå°±æ˜¯å‘Šè¯‰netfilterï¼Œå¯¹äºç¬¦åˆè¿™æ ·ä¸€ä¸ªæºåœ°å€çš„åŒ…æ€ä¹ˆå»å¤„ç†ï¼Œå¯ä»¥æŒ‡å®šæŸä¸€ä¸ªå•æ’­ipåœ°å€ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªç½‘ç»œï¼Œå¦‚æœå•ä¸ªçš„ipåœ°å€å…¶å®éšå«äº†ä¸€ä¸ª32ä½çš„å­ç½‘æ©ç ï¼Œæ¯”å¦‚-s 10.1.1.11 å…¶å®å°±æ˜¯-s 10.1.1.11/32ï¼ŒåŒæ ·æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸åŒçš„æ©ç ç”¨ä»¥å®ç°æºç½‘ç»œåœ°å€çš„è§„åˆ™ï¼Œæ¯”å¦‚ä¸€ä¸ªCç±»åœ°å€æˆ‘ä»¬å¯ä»¥ç”¨-s 10.1.1.0/24æ¥æŒ‡å®šã€‚</li>
<li>-då‚æ•°ä¸-sæ ¼å¼ä¸€æ ·ã€‚</li>
<li>-iå‚æ•°æ˜¯æŒ‡å®šå…¥æ¥å£çš„ç½‘ç»œæ¥å£ï¼Œæ¯”å¦‚æˆ‘ä»…ä»…å…è®¸ä»eth3æ¥å£è¿‡æ¥çš„åŒ…é€šè¿‡FORWARDé“¾ï¼Œå°±å¯ä»¥è¿™æ ·æŒ‡å®šiptables -A FORWARD -i eth3 -j ACCEPT</li>
<li>-oæ˜¯å‡ºæ¥å£,ä¸ä¸ŠåŒã€‚</li>
</ul>
<p>æˆ‘ä»¬ä¸‹é¢ç”¨ä¸€äº›ç®€å•çš„å®ä¾‹æ¥step by stepçœ‹çœ‹iptablesçš„å…·ä½“é…ç½®æ–¹æ³•ã€‚</p>
<h4 id="å®ä¾‹ä¸€ï¼šç®€å•çš„natè·¯ç”±å™¨"><a href="#å®ä¾‹ä¸€ï¼šç®€å•çš„natè·¯ç”±å™¨" class="headerlink" title="å®ä¾‹ä¸€ï¼šç®€å•çš„natè·¯ç”±å™¨"></a>å®ä¾‹ä¸€ï¼šç®€å•çš„natè·¯ç”±å™¨</h4><blockquote>
<p><strong>ç¯å¢ƒä»‹ç»</strong></p>
<ul>
<li>linux 2.4 +</li>
<li>2ä¸ªç½‘ç»œæ¥å£</li>
<li>Lanå£:10.1.1.254/24 eth0</li>
<li>Lanå£:10.1.1.254/24 eth0</li>
<li>ç›®çš„ï¼šå®ç°å†…ç½‘ä¸­çš„èŠ‚ç‚¹ï¼ˆ10.1.1.0/24ï¼‰å¯æ§çš„è®¿é—®internetã€‚</li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#é¦–å…ˆå°†Lançš„èŠ‚ç‚¹pcçš„ç½‘å…³æŒ‡å‘10.1.1.254ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¡®å®šä½ çš„linuxçš„ipé…ç½®æ— è¯¯ï¼Œå¯ä»¥æ­£ç¡®çš„pingé€šå†…å¤–çš„åœ°å€ã€‚åŒæ—¶ç”¨routeå‘½ä»¤æŸ¥çœ‹linuxçš„æœ¬åœ°è·¯ç”±è¡¨ï¼Œç¡®è®¤æŒ‡å®šäº†å¯ç”¨çš„ISPæä¾›çš„é»˜è®¤ç½‘å…³ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰“å¼€linuxçš„è½¬å‘åŠŸèƒ½ï¼š</span></span><br><span class="line">sysctl net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line"><span class="comment">#å°†FORWARDé“¾çš„ç­–ç•¥è®¾ç½®ä¸ºDROPï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯åšåˆ°å¯¹å†…ç½‘ipçš„æ§åˆ¶ï¼Œä½ å…è®¸å“ªä¸€ä¸ªè®¿é—®internetå°±å¯ä»¥å¢åŠ ä¸€ä¸ªè§„åˆ™ï¼Œä¸åœ¨è§„åˆ™ä¸­çš„ipå°†æ— æ³•è®¿é—®internet.</span></span><br><span class="line">iptables -P FORWARD DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™æ¡è§„åˆ™è§„å®šå…è®¸ä»»ä½•åœ°å€åˆ°ä»»ä½•åœ°å€çš„ç¡®è®¤åŒ…å’Œå…³è”åŒ…é€šè¿‡ã€‚ä¸€å®šè¦åŠ è¿™ä¸€æ¡ï¼Œå¦åˆ™ä½ åªå…è®¸lan IPè®¿é—®æ²¡æœ‰ç”¨ï¼Œè‡³äºä¸ºä»€ä¹ˆï¼Œä¸‹é¢æˆ‘ä»¬å†è¯¦ç»†è¯´ã€‚</span></span><br><span class="line">iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™æ¡è§„åˆ™åšäº†ä¸€ä¸ªSNATï¼Œä¹Ÿå°±æ˜¯æºåœ°å€è½¬æ¢ï¼Œå°†æ¥è‡ª10.1.1.0/24çš„åœ°å€è½¬æ¢ä¸º60.1.1.1</span></span><br><span class="line"><span class="comment">#(Devenï¼šå› ä¸ºæ˜¯è®©å†…ç½‘ä¸Šç½‘ï¼Œå› æ­¤å¯¹äºä»£ç†æœåŠ¡å™¨è€Œè¨€POSTROUTINGï¼ˆç»è¿‡è·¯ç”±ä¹‹åçš„åŒ…åº”è¯¥è¦æŠŠæºåœ°å€æ”¹å˜ä¸º60.1.1.1ï¼Œå¦åˆ™åŒ…æ— æ³•è¿”å›ï¼‰)</span></span><br><span class="line">iptables -t nat -A POSTROUTING <span class="_">-s</span> 10.1.1.0/24 -j SNAT --to 60.1.1.1</span><br><span class="line"><span class="comment">#æœ‰è¿™å‡ æ¡è§„åˆ™ï¼Œä¸€ä¸ªç®€å•çš„natè·¯ç”±å™¨å°±å®ç°äº†ã€‚è¿™æ—¶ä½ å¯ä»¥å°†å…è®¸è®¿é—®çš„ipæ·»åŠ è‡³FORWARDé“¾ï¼Œä»–ä»¬å°±èƒ½è®¿é—®internetäº†ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¯”å¦‚æˆ‘æƒ³è®©10.1.1.9è¿™ä¸ªåœ°å€è®¿é—®internet,é‚£ä¹ˆä½ å°±åŠ å¦‚ä¸‹çš„å‘½ä»¤å°±å¯ä»¥äº†ã€‚</span></span><br><span class="line">iptables -A FORWARD <span class="_">-s</span> 10.1.1.9 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¹Ÿå¯ä»¥ç²¾ç¡®æ§åˆ¶ä»–çš„è®¿é—®åœ°å€,æ¯”å¦‚æˆ‘å°±å…è®¸10.1.1.99è®¿é—®3.3.3.3è¿™ä¸ªip</span></span><br><span class="line">iptables -A FORWARD <span class="_">-s</span> 10.1.1.99 <span class="_">-d</span> 3.3.3.3 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#æˆ–è€…åªå…è®¸ä»–ä»¬è®¿é—®80ç«¯å£ã€‚</span></span><br><span class="line">iptables -A FORWARD <span class="_">-s</span> 10.1.1.0/24 -p tcp --dport http -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ›´å¤šçš„æ§åˆ¶å¯ä»¥è‡ªå·±çµæ´»å»åš,æˆ–è€…æŸ¥é˜…iptablesçš„è”æœºæ–‡æ¡£ã€‚</span></span><br></pre></td></tr></table></figure>
<h4 id="å®ä¾‹äºŒï¼šç«¯å£è½¬å‘"><a href="#å®ä¾‹äºŒï¼šç«¯å£è½¬å‘" class="headerlink" title="å®ä¾‹äºŒï¼šç«¯å£è½¬å‘"></a>å®ä¾‹äºŒï¼šç«¯å£è½¬å‘</h4><blockquote>
<p><strong>ç¯å¢ƒä»‹ç»</strong></p>
<ul>
<li>linux 2.4 +</li>
<li>2ä¸ªç½‘ç»œæ¥å£</li>
<li>Lanå£:10.1.1.254/24 eth0</li>
<li>Lanå†…web server: 10.1.1.1:80</li>
<li>Lanå†…ftp server: 10.1.1.2:21</li>
<li>Wanå£:60.1.1.1/24 eth1</li>
<li>ç›®çš„ï¼šå¯¹å†…éƒ¨serverè¿›è¡Œç«¯å£è½¬å‘å®ç°internetç”¨æˆ·è®¿é—®å†…ç½‘æœåŠ¡å™¨ã€‚</li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åŒæ ·ç¡®è®¤ä½ çš„linuxçš„å„é¡¹é…ç½®æ­£å¸¸ï¼Œèƒ½å¤Ÿè®¿é—®å†…å¤–ç½‘ã€‚</span></span><br><span class="line">iptables -P FORWARD DROP</span><br><span class="line">iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¹Ÿéœ€è¦åŠ å…¥ç¡®è®¤åŒ…å’Œå…³è”åŒ…çš„å…è®¸é€šè¿‡</span></span><br><span class="line"><span class="comment">#å¦‚æœä½ è¦æŠŠè®¿é—®60.1.1.1:80çš„æ•°æ®åŒ…è½¬å‘åˆ°Lanå†…web server,ç”¨ä¸‹é¢çš„å‘½ä»¤</span></span><br><span class="line">iptables -t nat -A PREROUTING <span class="_">-d</span> 60.1.1.1 -p tcp --dport 80 -j DNAT --to 10.1.1.1:80</span><br><span class="line"></span><br><span class="line"><span class="comment">#ftpæœåŠ¡ä¹ŸåŒæ ·ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</span></span><br><span class="line">iptables -t nat -A PREROUTING <span class="_">-d</span> 60.1.1.1 -p tcp --dport 21 -j DNAT --to 10.1.1.2:21</span><br></pre></td></tr></table></figure>
<p>å¥½äº†ï¼Œå‘½ä»¤å®Œæˆäº†ï¼Œç«¯å£è½¬å‘ä¹Ÿåšå®Œäº†ï¼Œæœ¬ä¾‹èƒ½ä¸èƒ½è½¬å‘å‘¢ï¼Ÿä¸èƒ½ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä¸‹é¢è¯¦ç»†åˆ†æä¸€ä¸‹ã€‚</p>
<p>å¯¹äºiptableså¥½åƒå¾€å¤–è®¿é—®çš„é…ç½®æ¯”è¾ƒå®¹æ˜“ï¼Œè€Œå¯¹å†…çš„è½¬å‘ä¼¼ä¹å°±æœ‰ä¸€äº›é—®é¢˜äº†ï¼Œåœ¨ä¸€å¼€å§‹çš„æ—¶å€™æˆ‘å°±å…ˆè¯´äº†ä¸€äº›å…³äºnetfilterçš„æµç¨‹é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘å°±ç®€å•è¯´è¯´åšäº†è¿™äº›é…ç½®ä¹‹åä¸ºä»€ä¹ˆæœ‰å¯èƒ½è¿˜ä¸è¡Œå‘¢ï¼Ÿ</p>
<p>èƒ½å¼•èµ·è¿™ä¸ªé…ç½®å¤±è´¥çš„åŸå› æœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªçš„æ¥è¯´ï¼š</p>
<p><strong>ç¬¬ä¸€</strong> æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„FORWARDç­–ç•¥æ˜¯DROP,é‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæ²¡æœ‰ç¬¦åˆè§„åˆ™çš„åŒ…å°†è¢«ä¸¢å¼ƒï¼Œä¸ç®¡å†…åˆ°å¤–è¿˜æ˜¯å¤–åˆ°å†…ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¾ç„¶ä¸è®¨è®ºé‚£ä¸ªç¡®è®¤åŒ…å’Œå…³è”åŒ…çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¸ç”¨è€ƒè™‘ä»–çš„é—®é¢˜ï¼Œä¸‹é¢æˆ‘ä¼šè¯¦ç»†è¯´ä¸€ä¸‹è¿™ä¸ªä¸œè¥¿ï¼Œé‚£ä¹ˆå¦‚ä½•è®©æœ¬ä¾‹å¯ä»¥æˆåŠŸå‘¢ï¼ŸåŠ å…¥ä¸‹é¢çš„è§„åˆ™ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD <span class="_">-d</span> 10.1.1.1 -p tcp --dport 80 -j ACCEPT</span><br><span class="line">iptables -A FORWARD <span class="_">-d</span> 10.1.1.2 -p tcp --dport 21 -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>æœ‰æ²¡æœ‰è§‰å¾—æœ‰ä¸€äº›æ™•ï¼Ÿä¸ºä»€ä¹ˆç›®çš„åœ°å€æ˜¯10.xxxè€Œä¸æ˜¯60.xxxäººå®¶internetç”¨æˆ·ä¸æ˜¯è®¿é—®çš„60.xxxå—ï¼Ÿå‘µå‘µï¼Œå›åˆ°ä¸Šé¢çœ‹çœ‹é‚£ä¸ªå›¾å§ï¼ŒFORWARDé“¾åœ¨ä»€ä¹ˆä½ç½®ä¸Šï¼Œå®ƒæ˜¯åœ¨PREROUTINGä¹‹åï¼Œä¹Ÿå°±æ˜¯è¯´å½“è¿™ä¸ªåŒ…åˆ°è¾¾FORWARDé“¾çš„æ—¶å€™ï¼Œç›®çš„åœ°å€å·²ç»å˜æˆ10.xxxäº†ï¼Œå‡å¦‚internetç”¨æˆ·çš„è¯·æ±‚æ˜¯è¿™æ ·202.1.1.1:1333â€“&gt;60.1.1.1:80ï¼Œåœ¨ç»è¿‡äº†æˆ‘ä»¬çš„PREROUTINGé“¾ä¹‹åå°†å˜æˆ 202.1.1.1:1333â€“&gt;10.1.1.1:80,è¿™ä¸ªæ—¶å€™å¦‚æœä½ è®¾ç½®ä¸€ä¸ªç›®çš„åœ°å€ä¸º60.xxxçš„è§„åˆ™æœ‰ç”¨å—ï¼Ÿå‘µå‘µï¼Œè¿™æ˜¯é—®é¢˜ä¸€ã€‚è¿™ä¸ªæ—¶å€™åº”è¯¥å¯ä»¥å®Œæˆç«¯å£è½¬å‘çš„è®¿é—®äº†ï¼Œä½†æ˜¯æœ‰ä¸€äº›æ—¶å€™è¿˜æ˜¯ä¸è¡Œï¼Ÿä¸ºä»€ä¹ˆï¼Ÿçœ‹é—®é¢˜äºŒã€‚</p>
<p><strong>ç¬¬äºŒ</strong> å†…ç½‘serverçš„ipé…ç½®é—®é¢˜ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥web serverä¸ºä¾‹è¯´æ˜ä¸€ä¸‹ï¼ˆftpæƒ…å†µæœ‰ä¸€äº›ç‰¹æ®Šï¼Œä¸‹é¢æˆ‘ä»¬å†è¯¦ç»†è®¨è®ºï¼Œè¯´ç¡®è®¤åŒ…å’Œå…³è”åŒ…çš„æ—¶å€™è®¨è®ºè¿™ä¸ªé—®é¢˜ï¼‰ï¼Œä¸Šé¢è¯´åˆ°ï¼Œæœ‰çš„æ—¶å€™å¯ä»¥è®¿é—®äº†ï¼Œæœ‰çš„æ—¶å€™å´ä¸è¡Œï¼Œå°±æ˜¯è¿™ä¸ªweb serverçš„ipè®¾ç½®é—®é¢˜äº†ï¼Œå¦‚æœweb serveræ²¡æœ‰æŒ‡å®šé»˜è®¤çš„ç½‘å…³ï¼Œé‚£ä¹ˆåœ¨ä½œäº†ä¸Šé¢çš„é…ç½®ä¹‹åï¼Œweb serverä¼šæ”¶åˆ°internetçš„è¯·æ±‚ï¼Œä½†æ˜¯ï¼Œä»–ä¸çŸ¥é“å¾€å“ªé‡Œå›å•Šï¼Œäººå®¶çš„æœ¬åœ°è·¯ç”±è¡¨ä¸çŸ¥é“ä½ é‚£ä¸ªinternetçš„ip,202.1.1.1è¯¥æ€ä¹ˆèµ°ã€‚å¦‚æœä½ ä½¿ç”¨æˆªåŒ…å·¥å…·åœ¨web serverä¸Šé¢å¯Ÿçœ‹ï¼Œä½ ä¼šå‘ç°serveræ”¶åˆ°äº†æ¥è‡ª202.1.1.1:1333â€“&gt;10.1.1.1:80çš„è¯·æ±‚ï¼Œç”±äºä½ æ²¡æœ‰ç»™web serveré…ç½®é»˜è®¤ç½‘å…³ï¼Œå®ƒä¸çŸ¥é“æ€ä¹ˆå›å»ï¼Œæ‰€ä»¥å°±å‡ºç°äº†ä¸é€šçš„æƒ…å†µã€‚æ€ä¹ˆåŠå‘¢ï¼Ÿä¸¤ä¸ªè§£å†³æ–¹æ³•ï¼š</p>
<p>ä¸€å°±æ˜¯ç»™è¿™ä¸ªserveré…ç½®ä¸€ä¸ªé»˜è®¤ç½‘å…³ï¼Œå½“ç„¶è¦æŒ‡å‘è¿™ä¸ªé…ç½®ç«¯å£è½¬å‘çš„linux,æœ¬ä¾‹æ˜¯10.1.1.254,é…ç½®å¥½äº†ï¼Œå°±ä¸€å®šèƒ½è®¿é—®äº†ã€‚æœ‰ä¸€ä¸ªç–‘é—®ï¼Ÿéš¾é“ä¸éœ€è¦åœ¨FORWARDé“¾ä¸Šé¢è®¾ç½®ä¸€ä¸ªå…è®¸web serverçš„ipåœ°å€è®¿é—®å¤–ç½‘çš„è§„åˆ™å—ï¼Ÿå®ƒçš„åŒ…èƒ½å‡ºå»ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œèƒ½å‡ºå»ã€‚å› ä¸ºæˆ‘ä»¬é‚£ä¸€æ¡å…è®¸ç¡®è®¤åŒ…ä¸å…³è”åŒ…çš„è§„åˆ™ï¼Œå¦åˆ™å®ƒæ˜¯å‡ºä¸å»çš„ã€‚</p>
<p><strong>ç¬¬äºŒç§æ–¹æ³•</strong>ï¼Œæ¯”è¾ƒéº»çƒ¦ä¸€äº›ï¼Œä½†æ˜¯å¯¹æœåŠ¡å™¨æ¥è¯´è¿™æ ·ä¼¼ä¹æ›´å®‰å…¨ä¸€äº›ã€‚æ–¹æ³•å°±æ˜¯å¯¹è¿™ä¸ªåŒ…å†ä½œä¸€æ¬¡SNATï¼Œä¹Ÿå°±æ˜¯åœ¨POSTROUTINGé“¾ä¸Šæ·»åŠ è§„åˆ™ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING <span class="_">-d</span> 10.1.1.1 -p tcp --dport 80 -j SNAT --to 10.1.1.254</span><br></pre></td></tr></table></figure></p>
<p>ftp çš„æ–¹æ³•ç›¸åŒã€‚è¿™æ¡å‘½ä»¤ä¸å¤ªå¥½æ‡‚ï¼Ÿï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œå¦‚æœä½¿ç”¨è¿™æ¡å‘½ä»¤ï¼Œé‚£ä¹ˆä½ çš„web serverä¸éœ€è¦å†è®¾ç½®é»˜è®¤ç½‘å…³ï¼Œå°±èƒ½æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ï¼Œåªè¦ä»–å’Œlinuxçš„lan ipåœ°å€æ˜¯èƒ½äº’è®¿çš„ï¼ˆä¹Ÿå°±æ˜¯è¯´web serverå’ŒLinuxçš„Lan ipåœ¨ä¸€ä¸ªå¹¿æ’­åŸŸï¼‰ï¼Œæˆ‘ä»¬åœ¨æ ¹æ®ä¸Šé¢çš„netfilteræµç¨‹å›¾æ¥åˆ†æè¿™ä¸ªåŒ…åˆ°åº•è¢«æˆ‘ä»¬æ€ä¹ˆæ ·äº†ï¼š</p>
<ul>
<li>é¦–å…ˆä¸€ä¸ªè¯·æ±‚202.1.1.1:1333â€“&gt; 60.1.1.1:80è¢«linuxæ”¶åˆ°äº†ï¼Œè¿›å…¥PREROUTINGï¼›</li>
<li>å‘ç°ä¸€ä¸ªè§„åˆ™iptables -t nat -A PREROUTING -d 60.1.1.1 -p tcp â€“dport 80 -j DNAT â€“to 10.1.1.1:80ç¬¦åˆï¼Œå¥½äº†ï¼Œæ”¹ä½ çš„ç›®çš„åœ°å€ï¼Œäºæ˜¯è¿™ä¸ªåŒ…å˜æˆäº†202.1.1.1:1333â€“&gt;10.1.1.1:80ï¼Œç»§ç»­å¾€å‰èµ°ï¼›</li>
<li>è¿›å…¥FORWARDé“¾ï¼Œokay,ä¹Ÿæœ‰ä¸€æ¡è§„åˆ™å…è®¸é€šè¿‡iptables -A FORWARD -d 10.1.1.1 -p tcp â€“dport 80 -j ACCEPTï¼›</li>
<li>è¿›å…¥route boxé€‰è·¯ï¼Œæ‰¾åˆ°åˆé€‚çš„è·¯å¾„äº†ï¼Œç»§ç»­è¿›å…¥POSTROUTINGé“¾ï¼›</li>
<li>è€¶ï¼Ÿåˆå‘ç°ä¸€ä¸ªç¬¦åˆçš„è§„åˆ™iptables -t nat -A POSTROUTING -d 10.1.1.1 -p tcp â€“dport 80 -j SNAT â€“to 10.1.1.254,åŸæ¥æ˜¯ä¸€ä¸ªSNAT,æ”¹ä½ çš„æºåœ°å€ï¼Œäºæ˜¯è¿™ä¸ªåŒ…å˜æˆäº†10.1.1.254:xxxxâ€“&gt;10.1.1.1:80ã€‚ä¸ºä»€ä¹ˆç”¨xxxxäº†ï¼Œè¿™é‡Œçš„ç«¯å£æ˜¯éšæœºçš„ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä¼šæ˜¯ä»€ä¹ˆã€‚</li>
<li>è€Œæ•´ä¸ªçš„ä¸¤æ¬¡å˜åŒ–çš„è¿‡ç¨‹éƒ½ä¼šè®°å½•åœ¨linuxçš„ip_conntrackä¸­ï¼›</li>
<li>å½“web serveræ”¶åˆ°è¿™ä¸ªåŒ…çš„æ—¶å€™ï¼Œå‘ç°ï¼ŒåŸæ¥æ˜¯ä¸€ä¸ªå†…ç½‘è‡ªå·±å…„å¼Ÿæ¥çš„è¯·æ±‚é˜¿ï¼Œåˆåœ¨ä¸€ä¸ªå¹¿æ’­åŸŸï¼Œä¸ç”¨æ‰¾ç½‘å…³ï¼ŒæŠŠè¿”å›åŒ…ç›´æ¥æ‰”ç»™äº¤æ¢æœºäº†ï¼›</li>
<li>linuxåœ¨æ”¶åˆ°è¿”å›åŒ…ä¹‹åï¼Œä¼šæ ¹æ®ä»–çš„ip_conntrackä¸­çš„æ¡ç›®è¿›è¡Œä¸¤æ¬¡å˜æ¢ï¼Œè¿”å›çœŸæ­£çš„internetç”¨æˆ·ï¼Œäºæ˜¯å®Œæˆè¿™ä¸€æ¬¡çš„è®¿é—®ã€‚</li>
</ul>
<p>çœ‹äº†ä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­ï¼Œä¸çŸ¥é“å¤§å®¶æ˜¯å¦æ¸…æ¥šäº†iptablesçš„è½¬å‘æµç¨‹ï¼Œå¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚</p>
<h4 id="çŠ¶æ€æœºåˆ¶"><a href="#çŠ¶æ€æœºåˆ¶" class="headerlink" title="çŠ¶æ€æœºåˆ¶"></a>çŠ¶æ€æœºåˆ¶</h4><p>ä¸‹é¢æˆ‘ä»¬å°±è¯´è¯´æˆ‘ä¸€ç›´åœ¨ä¸Šé¢æåˆ°çš„å…³äºé‚£ä¸ªESTABLISHED,RELATEDçš„è§„åˆ™æ˜¯æ€ä¹ˆå›äº‹ï¼Œåˆ°åº•æœ‰ä»€ä¹ˆç”¨å¤„ã€‚</p>
<p>è¯´è¿™ä¸ªä¸œè¥¿å°±è¦ç®€å•è¯´ä¸€ä¸‹ç½‘ç»œçš„æ•°æ®é€šè®¯çš„æ–¹å¼ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œç½‘ç»œçš„è®¿é—®æ˜¯åŒå‘çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªClientä¸Serverä¹‹é—´å®Œæˆæ•°æ®äº¤æ¢éœ€è¦åŒæ–¹çš„å‘åŒ…ä¸æ”¶åŒ…ã€‚åœ¨netfilterä¸­ï¼Œæœ‰å‡ ç§çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯new, established,related,invalidã€‚</p>
<p>å½“ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œåœ¨æœ¬æ–‡ä¾‹ä¸€ä¸­ï¼Œå†…ç½‘çš„ä¸€å°æœºå™¨è®¿é—®å¤–ç½‘ï¼Œæˆ‘ä»¬è®¾ç½®äº†è§„åˆ™å…è®¸ä»–å‡ºå»ï¼Œä½†æ˜¯æ²¡æœ‰è®¾ç½®å…è®¸å›æ¥çš„è§„åˆ™é˜¿ï¼Œæ€ä¹ˆå®Œæˆè®¿é—®å‘¢ï¼Ÿè¿™å°±æ˜¯netfilterçš„ çŠ¶æ€æœºåˆ¶ ï¼Œå½“ä¸€ä¸ªlanç”¨æˆ·é€šè¿‡è¿™ä¸ªlinuxè®¿é—®å¤–ç½‘çš„æ—¶å€™ï¼Œå®ƒå‘é€äº†ä¸€ä¸ªè¯·æ±‚åŒ…ï¼Œè¿™ä¸ªåŒ…çš„çŠ¶æ€æ˜¯new,å½“å¤–ç½‘å›åŒ…çš„æ—¶å€™ä»–çš„çŠ¶æ€å°±æ˜¯established,æ‰€ä»¥ï¼ŒlinuxçŸ¥é“ï¼Œå“¦ï¼Œè¿™ä¸ªåŒ…æ˜¯æˆ‘çš„å†…ç½‘çš„ä¸€å°æœºå™¨å‘å‡ºå»çš„åº”ç­”åŒ…ï¼Œä»–å°±æ”¾è¡Œäº†ã€‚</p>
<p>è€Œå¤–ç½‘è¯•å›¾å¯¹å†…å‘èµ·ä¸€ä¸ªæ–°çš„è¿æ¥çš„æ—¶å€™ï¼Œä»–çš„çŠ¶æ€æ˜¯new,æ‰€ä»¥linuxå‹æ ¹ä¸å»ç†ä¼šå®ƒã€‚è¿™å°±æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦åŠ è¿™ä¸€å¥çš„åŸå› ã€‚</p>
<p>è¿˜æœ‰é‚£ä¸ªrelated,ä»–æ˜¯ä¸€ä¸ªå…³è”çŠ¶æ€ï¼Œä»€ä¹ˆä¼šç”¨åˆ°å‘¢ï¼Ÿtftp,ftpéƒ½ä¼šç”¨åˆ°ï¼Œå› ä¸ºä»–ä»¬çš„ä¼ è¾“æœºåˆ¶å†³å®šäº†ï¼Œå®ƒä¸åƒhttpè®¿é—®é‚£æ ·ï¼ŒClient_IP: portâ€“&gt;server:80ç„¶åserver:80â€“&gt;Client_IP:portï¼Œftpä½¿ç”¨tcp21å»ºç«‹è¿æ¥ï¼Œä½¿ç”¨20ç«¯å£å‘é€æ•°æ®ï¼Œå…¶ä¸­åˆæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§ä¸»åŠ¨active modeï¼Œä¸€ç§è¢«åŠ¨passive modeã€‚ä¸»åŠ¨æ¨¡å¼ä¸‹ï¼Œclientä½¿ç”¨portå‘½ä»¤å‘Šè¯‰serveræˆ‘ç”¨å“ªä¸€ä¸ªç«¯å£æ¥å—æ•°æ®ï¼Œç„¶åserverä¸»åŠ¨å‘èµ·å¯¹è¿™ä¸ªç«¯å£çš„è¯·æ±‚ã€‚è¢«åŠ¨æ¨¡å¼ä¸‹ï¼Œserverä½¿ç”¨portå‘½ä»¤å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œå®ƒç”¨é‚£ä¸ªç«¯å£ç›‘å¬ï¼Œç„¶åå®¢æˆ·ç«¯å‘èµ·å¯¹ä»–çš„æ•°æ®ä¼ è¾“ï¼Œæ‰€ä»¥è¿™å¯¹äºä¸€ä¸ªé˜²ç«å¢™æ¥è¯´å°±æ˜¯æ¯”è¾ƒéº»çƒ¦çš„äº‹æƒ…ï¼Œå› ä¸ºæœ‰å¯èƒ½ä¼šæœ‰newçŠ¶æ€çš„æ•°æ®åŒ…ï¼Œä½†æ˜¯å®ƒåˆæ˜¯åˆç†çš„è¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™å°±ç”¨åˆ°è¿™ä¸ªrelatedçŠ¶æ€äº†ï¼Œä»–å°±æ˜¯ä¸€ç§å…³è”ï¼Œåœ¨linuxä¸­ï¼Œæœ‰ä¸ªå« ftp_conntrackçš„æ¨¡å—ï¼Œå®ƒèƒ½è¯†åˆ«portå‘½ä»¤ï¼Œç„¶åå¯¹ç›¸åº”çš„ç«¯å£è¿›è¡Œæ”¾è¡Œã€‚</p>
<p>ä¸€å£æ°”å†™äº†è¿™ä¹ˆå¤šä¸œè¥¿ï¼Œä¸çŸ¥é“è´¨é‡å¦‚ä½•ï¼Œå¤§å®¶å‡‘å’Œç€çœ‹å§ï¼Œå¸Œæœ›å¤šå¤šäº¤æµå…±åŒè¿›æ­¥ï¼Œæˆ‘è¿˜æ˜¯ä¸€ä¸ªlinuxçš„åˆå­¦è€…ï¼Œéš¾å…å¾ˆå¤šè°¬è¯¯ï¼Œå¸Œæœ›é«˜æ‰‹èµæ•™æŒ‡æ­£ï¼Œä»¥æœŸä¸æ–­è¿›æ­¥ã€‚</p>
<h4 id="å®ç”¨å‘½ä»¤"><a href="#å®ç”¨å‘½ä»¤" class="headerlink" title="å®ç”¨å‘½ä»¤"></a>å®ç”¨å‘½ä»¤</h4><p>å¯¹äº†ï¼Œè¿˜æœ‰å‡ ä¸ªåœ¨å®é™…ä¸­æ¯”è¾ƒå®ç”¨ï¼ˆä¹Ÿæ¯”è¾ƒå—ç”¨:-)ï¼‰çš„å‘½ä»¤å‚æ•°ï¼Œå†™å‡ºæ¥ä¾›å¤§å®¶å‚è€ƒ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">iptables -L -n</span><br><span class="line"><span class="comment">#è¿™æ ·çš„åˆ—è¡¨ä¼šè·³è¿‡linuxçš„domain lookup,æœ‰çš„æ—¶å€™ä½¿ç”¨iptables -Lä¼šæ¯”è¾ƒæ…¢ï¼Œå› ä¸ºlinuxä¼šå°è¯•è§£æipçš„åŸŸåï¼ŒçœŸæ˜¯ç½—å—¦ï¼Œå¦‚æœä½ çš„dns serveræ¯”è¾ƒä¸çˆ½çš„è¯ï¼Œiptables -Lå°±ä¼šè®©ä½ å¾ˆä¸çˆ½ï¼ŒåŠ ä¸€ä¸ª-nå‚æ•°å°±å¥½äº†ã€‚åˆ—è¡¨åˆ·çš„å°±å‡ºæ¥ã€‚å½“ç„¶äº†ï¼Œå¦‚æœä½ çš„linuxå°±æ˜¯åšé˜²ç«å¢™ï¼Œå»ºè®®æŠŠnameserverå»æ‰ï¼Œåœ¨ /etc/resolve.confé‡Œé¢ï¼Œå› ä¸ºæœ‰æ—¶å€™ä½¿ç”¨routeå‘½ä»¤ä¹Ÿä¼šæ¯”è¾ƒæ…¢åˆ—å‡ºæ¥ï¼Œå¾ˆæ˜¯ä¸çˆ½ã€‚</span></span><br><span class="line"></span><br><span class="line">iptables -L -v</span><br><span class="line"><span class="comment">#è¿™ä¸ªå‘½ä»¤ä¼šæ˜¾ç¤ºé“¾ä¸­è§„åˆ™çš„åŒ…å’Œæµé‡è®¡æ•°ï¼Œå˜¿å˜¿ï¼Œçœ‹çœ‹å“ªäº›å°å­ç”¨çš„æµé‡é‚£ä¹ˆå¤šï¼Œç”¨tcé™äº†ä»–ã€‚</span></span><br><span class="line"></span><br><span class="line">iptables -t nat -L -vn</span><br><span class="line"><span class="comment">#æŸ¥çœ‹natè¡¨ä¸­çš„è§„åˆ™ã€‚</span></span><br><span class="line"></span><br><span class="line">cat /proc/net/ip_conntrack</span><br><span class="line"><span class="comment">#æŸ¥çœ‹ç›®å‰çš„conntrackï¼Œå¯èƒ½ä¼šæ¯”è¾ƒå¤šå“¦ï¼Œæœ€å¥½åŠ ä¸€ä¸ª|grep "å…³é”®å­—"ï¼Œçœ‹çœ‹ä½ æ„Ÿå…´è¶£çš„é“¾æ¥è·Ÿè¸ª</span></span><br><span class="line"></span><br><span class="line">wc <span class="_">-l</span> /proc/net/ip_conntrack</span><br><span class="line"><span class="comment">#çœ‹çœ‹æ€»é“¾æ¥æœ‰å¤šå°‘æ¡ã€‚</span></span><br><span class="line"></span><br><span class="line">iptables-save &gt;/etc/iptables</span><br><span class="line"><span class="comment">#æŠŠå½“å‰çš„æ‰€æœ‰é“¾å¤‡ä»½ä¸€ä¸‹ï¼Œä¹‹æ‰€ä»¥æ”¾åˆ°/etcä¸‹é¢å«iptablesï¼Œå› ä¸ºè¿™æ ·é‡èµ·æœºå™¨çš„æ—¶å€™ä¼šè‡ªåŠ¨åŠ è½½æ‰€æœ‰çš„é“¾ï¼Œç»å¸¸åœ°å¤‡ä»½ä¸€ä¸‹å§ï¼Œå¦åˆ™å¦‚æœé“¾å¤šï¼Œä¸‡ä¸€æ‰ç”µé‡å¯ï¼Œä½ è¿˜æ˜¯ä¼šæ¯”è¾ƒç—›è‹¦ã€‚</span></span><br></pre></td></tr></table></figure></p>
<p><strong>è½¬å‘</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¹‹å‰å› ä¸ºä¸€ä¸ªç½‘æ®µè¢«å°äº†ï¼Œå› æ­¤é€šè¿‡iptablesåšè½¬å‘ï¼š</span></span><br><span class="line"><span class="comment">#ä»£ç†æœåŠ¡å™¨WAN IPï¼š111.**.**.219ï¼ŒLAN IPï¼š192.168.0.219</span></span><br><span class="line"><span class="comment">#å†…ç½‘æœåŠ¡å™¨IPï¼š192.168.0.41</span></span><br><span class="line"><span class="comment">#1.åœ¨ä»£ç†æœåŠ¡å™¨æ‰“å¼€è½¬å‘åŠŸèƒ½ï¼ˆsysctl.confï¼‰</span></span><br><span class="line"><span class="comment">#2.æ·»åŠ ä»¥ä¸‹è§„åˆ™</span></span><br><span class="line">iptables -t nat -A PREROUTING <span class="_">-d</span> 111.**.**.219 -p tcp --dport 9999 -j DNAT --to-destination 192.168.0.41:9999</span><br><span class="line">iptables -t nat -A POSTROUTING <span class="_">-d</span> 192.168.0.41 -p tcp --dport 9999 -j SNAT --to-source 192.168.0.219</span><br></pre></td></tr></table></figure></p>
<p> åŸæ–‡ï¼š<a href="http://wwdhks.blog.51cto.com/839773/1154032" target="_blank" rel="external">http://wwdhks.blog.51cto.com/839773/1154032</a></p>
]]></content>
    </entry>
    
  
  
</search>
